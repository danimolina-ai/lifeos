// Life OS v5.2 - Relationships & Personal v2
import React, { useState, useEffect, useMemo, useRef } from 'react';
import { Utensils, Dumbbell, Target, CheckSquare, Calendar, CalendarDays, BarChart3, Plus, ChevronLeft, ChevronRight, ChevronDown, Moon, Zap, Check, X, Flame, TrendingUp, Award, Coffee, Sun, Sunset, Edit3, Trash2, Play, Pause, RotateCcw, Settings, Sparkles, ArrowRight, RefreshCw, Timer, Trophy, Scale, BookOpen, Droplets, Brain, Clock, AlertCircle, Wallet, Grid, LayoutGrid, Briefcase, Activity, Camera, Search, MoreHorizontal, GripVertical, Star, Heart, Lightbulb, Copy, Users, Footprints, Smartphone, Watch } from 'lucide-react';
import { FOOD_DATABASE, FOOD_CATEGORIES } from '../data/foodDatabase';
import { EXERCISE_DATABASE, EQUIPMENT_TYPES, SET_TYPES, getExerciseById, getExercisesByMuscle, getAllExercises } from '../data/exerciseDatabase';
import { useAuth } from '../contexts/AuthContext';
import { supabase } from '../lib/supabase';
import { LogOut, User } from 'lucide-react';
import OnboardingWizard from '../components/OnboardingWizard';


// ============================================================================
// FOOD DATABASE - Comprehensive nutrition data
// ============================================================================


// Food categories for filtering


// ============================================================================
// DATA STRUCTURES
// ============================================================================

// Empty data template for new users (clean slate)
const EMPTY_DATA = {
  user: {
    name: '',
    onboardingComplete: false,
    goals: { calories: 2200, protein: 180, carbs: 220, fats: 70, water: 8, sleep: 8, steps: 10000 },
    mantra: '',
    activeAreas: ['nutrition', 'workout', 'habits', 'work', 'personal', 'body', 'finances', 'consciousness', 'relationships'],
    demoDataEnabled: false
  },
  days: {},
  meals: [],
  savedMeals: [],
  plannedMeals: [],
  customFoods: [],
  recipes: [],
  workouts: [],
  habits: [],
  habitLogs: [],
  projects: [],
  tasks: [],
  workoutTemplates: [],
  bodyMetrics: [],
  personalRecords: [],
  journals: [],
  personalTasks: [],
  personalCategories: [],
  relationships: [],
  finances: { transactions: [], monthlyBudget: 0 },
  // TIER 1 fixes - previously missing fields
  workTasks: [],
  workProjects: [],
  scheduledWorkouts: {},
  recurringWorkouts: {},
  goals: { annual: [], quarterly: [], monthly: [] }
};

// Demo data for demonstration purposes (used when toggle is ON)
const DEFAULT_DATA = {
  user: {
    name: 'Demo',
    onboardingComplete: true,
    goals: { calories: 2200, protein: 180, carbs: 220, fats: 70, water: 8, sleep: 8, steps: 10000 },
    mantra: 'Cada d√≠a cuenta',
    activeAreas: ['nutrition', 'workout', 'habits', 'work', 'personal', 'body', 'finances', 'consciousness', 'relationships'],
    demoDataEnabled: true
  },
  days: {},
  meals: [],
  savedMeals: [],
  plannedMeals: [],
  customFoods: [],
  recipes: [],
  workouts: [],
  habits: [],
  habitLogs: [],
  projects: [],
  tasks: [],
  workoutTemplates: [],
  bodyMetrics: [],
  personalRecords: [],
  journals: [],
  personalTasks: [],
  personalCategories: [],
  relationships: [],
  finances: { transactions: [], monthlyBudget: 0 }
};

// Demo data generator - called on first load
const generateDemoData = () => {
  const today = getToday();
  return {
    user: {
      name: 'Demo',
      onboardingComplete: true,
      goals: { calories: 2200, protein: 180, carbs: 220, fats: 70, water: 8, sleep: 8, steps: 10000 },
      mantra: 'Cada d√≠a cuenta',
      activeAreas: ['nutrition', 'workout', 'habits', 'work', 'personal', 'body', 'finances', 'consciousness', 'relationships']
    },
    days: {
      [today]: {
        id: today,
        energy_level: 3,
        sleep_hours: 7.5,
        sleep_quality: 4,
        water_glasses: 4,
        steps: 6543,
        focus_note: ''
      }
    },
    meals: [
      { id: 'demo-meal-1', day_id: today, name: 'Desayuno', meal_type: 'desayuno', calories: 450, protein: 35, carbs: 40, fats: 15, time: '08:30' },
      { id: 'demo-meal-2', day_id: today, name: 'Almuerzo', meal_type: 'almuerzo', calories: 650, protein: 45, carbs: 55, fats: 22, time: '13:00' }
    ],
    savedMeals: [],
    plannedMeals: [],
    customFoods: [],
    recipes: [],
    workouts: [
      {
        id: 'demo-workout-1',
        day_id: today,
        name: 'Push Day A',
        is_completed: false,
        exercises: [
          { id: 'ex1', name: 'Press banca', sets: [{ reps: 8, weight: 60, completed: false }, { reps: 8, weight: 60, completed: false }, { reps: 8, weight: 60, completed: false }] },
          { id: 'ex2', name: 'Press inclinado', sets: [{ reps: 8, weight: 50, completed: false }, { reps: 8, weight: 50, completed: false }, { reps: 8, weight: 50, completed: false }] },
          { id: 'ex3', name: 'Aperturas', sets: [{ reps: 8, weight: 14, completed: false }, { reps: 8, weight: 14, completed: false }, { reps: 8, weight: 14, completed: false }] },
          { id: 'ex4', name: 'Press militar', sets: [{ reps: 8, weight: 40, completed: false }, { reps: 8, weight: 40, completed: false }, { reps: 8, weight: 40, completed: false }] }
        ]
      }
    ],
    habits: [
      { id: 'demo-h1', name: 'Meditar 10min', icon: 'üßò', frequency: 'daily', identity: 'Soy una persona que cultiva la calma mental', created_at: today },
      { id: 'demo-h2', name: 'Leer 30min', icon: 'üìö', frequency: 'daily', created_at: today },
      { id: 'demo-h3', name: '10k pasos', icon: 'üö∂', frequency: 'daily', created_at: today },
      { id: 'demo-h4', name: 'Journaling', icon: '‚úçÔ∏è', frequency: 'daily', created_at: today }
    ],
    habitLogs: [
      { id: 'log1', habit_id: 'demo-h1', date: today, completed: true, completedAt: new Date().toISOString() },
      { id: 'log2', habit_id: 'demo-h2', date: today, completed: true, completedAt: new Date().toISOString() }
    ],
    projects: [
      { id: 'proj1', name: 'Trabajo', color: '#8B5CF6', active: true },
      { id: 'proj2', name: 'Personal', color: '#10B981', active: true }
    ],
    tasks: [
      { id: 'task1', title: 'Revisar presentaci√≥n Q1', project_id: 'proj1', date: today, priority: 'high', completed: false },
      { id: 'task2', title: 'Llamar al banco', project_id: 'proj2', date: today, priority: 'medium', completed: true },
      { id: 'task3', title: 'Preparar reuni√≥n equipo', project_id: 'proj1', date: today, priority: 'high', completed: false },
      { id: 'task4', title: 'Comprar regalo cumple', project_id: 'proj2', date: today, priority: 'low', completed: false }
    ],
    workoutTemplates: [],
    // Elite Work System Data
    workProjects: [
      {
        id: 'wp1',
        name: 'Lanzamiento Q1',
        color: '#8B5CF6',
        description: 'Nuevo producto para Q1',
        objective: 'Lanzar MVP antes de marzo',
        keyResults: [
          { id: 'kr1', title: 'Completar desarrollo core', progress: 75 },
          { id: 'kr2', title: '100 usuarios beta', progress: 40 },
          { id: 'kr3', title: 'NPS > 50', progress: 0 }
        ],
        deadline: getDateOffset(today, 60),
        status: 'active',
        createdAt: getDateOffset(today, -30)
      },
      {
        id: 'wp2',
        name: 'Marketing',
        color: '#EC4899',
        description: 'Campa√±as de adquisici√≥n',
        objective: 'Aumentar visibilidad de marca',
        keyResults: [
          { id: 'kr4', title: '10K seguidores nuevos', progress: 30 },
          { id: 'kr5', title: '5 colaboraciones cerradas', progress: 60 }
        ],
        deadline: getDateOffset(today, 45),
        status: 'active',
        createdAt: getDateOffset(today, -15)
      },
      {
        id: 'wp3',
        name: 'Operaciones',
        color: '#10B981',
        description: 'Mejora de procesos internos',
        objective: 'Optimizar eficiencia operativa',
        keyResults: [],
        deadline: '',
        status: 'active',
        createdAt: getDateOffset(today, -20)
      }
    ],
    workTasks: [
      // Q1 - Urgente + Importante (Hacer ahora)
      {
        id: 'wt1',
        title: 'Revisar propuesta cliente VIP',
        description: 'Propuesta de 50K pendiente de revisi√≥n',
        project_id: 'wp1',
        priority: 'high',
        eisenhower: 'q1',
        energy: 'high',
        timeEstimate: 60,
        dueDate: today,
        scheduledDate: today,
        context: '@office',
        isDeepWork: true,
        completed: false,
        createdAt: getDateOffset(today, -2),
        status: 'todo'
      },
      {
        id: 'wt2',
        title: 'Preparar presentaci√≥n board',
        description: 'Reuni√≥n ma√±ana a las 10:00',
        project_id: 'wp1',
        priority: 'high',
        eisenhower: 'q1',
        energy: 'high',
        timeEstimate: 90,
        dueDate: today,
        scheduledDate: today,
        context: '@office',
        isDeepWork: true,
        completed: false,
        createdAt: getDateOffset(today, -1),
        status: 'in_progress'
      },
      // Q2 - Importante (Planificar)
      {
        id: 'wt3',
        title: 'Escribir documentaci√≥n API',
        description: 'Endpoints v2 sin documentar',
        project_id: 'wp1',
        priority: 'medium',
        eisenhower: 'q2',
        energy: 'high',
        timeEstimate: 120,
        dueDate: getDateOffset(today, 3),
        scheduledDate: today,
        context: '@computer',
        isDeepWork: true,
        completed: false,
        createdAt: getDateOffset(today, -5),
        status: 'todo'
      },
      {
        id: 'wt4',
        title: 'Dise√±ar landing page',
        description: 'Nueva campa√±a de captaci√≥n',
        project_id: 'wp2',
        priority: 'medium',
        eisenhower: 'q2',
        energy: 'medium',
        timeEstimate: 90,
        dueDate: getDateOffset(today, 5),
        scheduledDate: today,
        context: '@computer',
        isDeepWork: true,
        completed: false,
        createdAt: getDateOffset(today, -3),
        status: 'todo'
      },
      {
        id: 'wt5',
        title: 'Planificar estrategia Q2',
        description: 'Roadmap y objetivos',
        project_id: 'wp3',
        priority: 'medium',
        eisenhower: 'q2',
        energy: 'high',
        timeEstimate: 60,
        dueDate: getDateOffset(today, 7),
        scheduledDate: '',
        context: '@office',
        isDeepWork: true,
        completed: false,
        createdAt: getDateOffset(today, -2),
        status: 'backlog'
      },
      // Q3 - Urgente (Delegar)
      {
        id: 'wt6',
        title: 'Responder emails pendientes',
        description: '15 emails sin responder',
        project_id: '',
        priority: 'low',
        eisenhower: 'q3',
        energy: 'low',
        timeEstimate: 30,
        dueDate: today,
        scheduledDate: today,
        context: '@computer',
        isDeepWork: false,
        completed: false,
        createdAt: today,
        status: 'todo'
      },
      // Completadas
      {
        id: 'wt7',
        title: 'Configurar analytics',
        description: 'Google Analytics 4',
        project_id: 'wp2',
        priority: 'medium',
        eisenhower: 'q2',
        energy: 'medium',
        timeEstimate: 45,
        dueDate: today,
        scheduledDate: today,
        context: '@computer',
        isDeepWork: false,
        completed: true,
        completedAt: new Date().toISOString(),
        createdAt: getDateOffset(today, -1),
        status: 'done'
      },
      {
        id: 'wt8',
        title: 'Revisi√≥n c√≥digo PR #234',
        description: 'Feature de pagos',
        project_id: 'wp1',
        priority: 'high',
        eisenhower: 'q1',
        energy: 'high',
        timeEstimate: 30,
        dueDate: today,
        scheduledDate: today,
        context: '@computer',
        isDeepWork: true,
        completed: true,
        completedAt: new Date().toISOString(),
        actualTime: 25,
        createdAt: getDateOffset(today, -1),
        status: 'done'
      },
      // Inbox (sin procesar)
      {
        id: 'wt9',
        title: 'Llamar a proveedor hosting',
        description: '',
        project_id: '',
        priority: 'medium',
        eisenhower: 'q2',
        energy: 'low',
        timeEstimate: 15,
        dueDate: '',
        scheduledDate: '',
        context: '',
        isDeepWork: false,
        completed: false,
        inInbox: true,
        createdAt: today,
        status: 'backlog'
      },
      {
        id: 'wt10',
        title: 'Investigar competencia',
        description: '',
        project_id: '',
        priority: 'medium',
        eisenhower: 'q2',
        energy: 'medium',
        timeEstimate: 60,
        dueDate: '',
        scheduledDate: '',
        context: '',
        isDeepWork: false,
        completed: false,
        inInbox: true,
        createdAt: getDateOffset(today, -1),
        status: 'backlog'
      }
    ],
    bodyMetrics: [
      { id: 'bm1', date: getDateOffset(today, -7), weight: 78.5 },
      { id: 'bm2', date: getDateOffset(today, -3), weight: 78.2 },
      { id: 'bm3', date: today, weight: 77.8 }
    ],
    personalRecords: [],
    journals: [],
    finances: {
      transactions: [
        { id: 'fin1', date: today, type: 'expense', amount: 45, category: 'Comida', description: 'Supermercado' },
        { id: 'fin2', date: today, type: 'expense', amount: 12, category: 'Transporte', description: 'Gasolina' },
        { id: 'fin3', date: getDateOffset(today, -2), type: 'expense', amount: 85, category: 'Compras', description: 'Amazon' },
        { id: 'fin4', date: getDateOffset(today, -5), type: 'income', amount: 2500, category: 'Salario', description: 'N√≥mina' }
      ],
      monthlyBudget: 1500,
      currency: '‚Ç¨'
    },
    // Relationships - CRM Personal (unified with RelationshipsScreen)
    relationships: [
      {
        id: 'rel1',
        name: 'Mar√≠a',
        category: 'partner',
        loveLanguage: 'time',
        contactFrequency: 'daily',
        birthday: '1992-06-15',
        anniversary: '2020-03-21',
        notes: 'Le encanta el sushi y las pel√≠culas de terror',
        interests: 'Yoga, cocina asi√°tica, true crime',
        pendingTopics: '',
        healthRating: 5,
        interactions: [
          { id: 'int1', date: today, type: 'inperson', notes: 'Cena juntos', quality: 5, timestamp: new Date().toISOString() }
        ],
        createdAt: getDateOffset(today, -365)
      },
      {
        id: 'rel2',
        name: 'Pap√°',
        category: 'family',
        loveLanguage: 'service',
        contactFrequency: 'weekly',
        birthday: '1958-11-22',
        anniversary: '',
        notes: 'Preguntarle por el huerto',
        interests: 'F√∫tbol, jardiner√≠a, bricolaje',
        pendingTopics: 'Ver c√≥mo va el huerto',
        healthRating: 4,
        interactions: [
          { id: 'int2', date: getDateOffset(today, -3), type: 'call', notes: 'Hablamos del partido', quality: 4, timestamp: new Date().toISOString() }
        ],
        createdAt: getDateOffset(today, -300)
      },
      {
        id: 'rel3',
        name: 'Carlos',
        category: 'friends',
        loveLanguage: 'words',
        contactFrequency: 'weekly',
        birthday: '1990-02-08',
        anniversary: '',
        notes: 'Amigo del cole',
        interests: 'Startups, tecnolog√≠a, p√°del',
        pendingTopics: 'Preguntarle c√≥mo va su empresa',
        healthRating: 3,
        interactions: [
          { id: 'int3', date: getDateOffset(today, -10), type: 'message', notes: '', quality: 3, timestamp: new Date().toISOString() }
        ],
        createdAt: getDateOffset(today, -200)
      },
      {
        id: 'rel4',
        name: 'Ana Garc√≠a',
        category: 'professional',
        loveLanguage: 'words',
        contactFrequency: 'monthly',
        birthday: '',
        anniversary: '',
        notes: 'Ex-jefa, ahora mentora. Muy buena para consejos de carrera.',
        interests: 'Liderazgo, desarrollo profesional',
        pendingTopics: 'Pedirle consejo sobre la promoci√≥n',
        healthRating: 4,
        interactions: [
          { id: 'int4', date: getDateOffset(today, -25), type: 'video', notes: 'Mentor√≠a mensual', quality: 5, timestamp: new Date().toISOString() }
        ],
        createdAt: getDateOffset(today, -180)
      },
      {
        id: 'rel5',
        name: 'Mam√°',
        category: 'family',
        loveLanguage: 'time',
        contactFrequency: 'weekly',
        birthday: '1960-04-03',
        anniversary: '',
        notes: 'Llamarla los domingos por la ma√±ana',
        interests: 'Novelas, cocina, los nietos',
        pendingTopics: '',
        healthRating: 5,
        interactions: [
          { id: 'int5', date: getDateOffset(today, -2), type: 'call', notes: 'Llamada dominical', quality: 5, timestamp: new Date().toISOString() }
        ],
        createdAt: getDateOffset(today, -300)
      },
      {
        id: 'rel6',
        name: 'Luis',
        category: 'friends',
        loveLanguage: 'touch',
        contactFrequency: 'biweekly',
        birthday: '1988-09-12',
        anniversary: '',
        notes: 'Compa√±ero de p√°del',
        interests: 'P√°del, cerveza artesanal, viajes',
        pendingTopics: 'Organizar siguiente partido',
        healthRating: 4,
        interactions: [
          { id: 'int6', date: getDateOffset(today, -8), type: 'activity', notes: 'Partido de p√°del', quality: 5, timestamp: new Date().toISOString() }
        ],
        createdAt: getDateOffset(today, -150)
      },
      {
        id: 'rel7',
        name: 'Vecino Pedro',
        category: 'community',
        loveLanguage: '',
        contactFrequency: 'monthly',
        birthday: '',
        anniversary: '',
        notes: 'Tiene las llaves de repuesto',
        interests: '',
        pendingTopics: 'Devolverle el taladro',
        healthRating: 3,
        interactions: [],
        createdAt: getDateOffset(today, -60)
      }
    ],
    // Personal Tasks with categories and subtasks
    personalTasks: [
      {
        id: 'pt1',
        title: 'Renovar pasaporte',
        category: 'admin',
        dueDate: getDateOffset(today, 14),
        priority: 'high',
        completed: false,
        subtasks: [
          { id: 'st1', title: 'Sacar fotos', completed: true },
          { id: 'st2', title: 'Rellenar formulario online', completed: false },
          { id: 'st3', title: 'Pedir cita previa', completed: false }
        ],
        notes: '',
        createdAt: getDateOffset(today, -5)
      },
      {
        id: 'pt2',
        title: 'Limpiar armario',
        category: 'home',
        dueDate: getDateOffset(today, 7),
        priority: 'low',
        completed: false,
        subtasks: [],
        notes: 'Donar ropa que no uso',
        createdAt: getDateOffset(today, -3)
      },
      {
        id: 'pt3',
        title: 'Reservar vuelos vacaciones',
        category: 'travel',
        dueDate: getDateOffset(today, 3),
        priority: 'medium',
        completed: false,
        subtasks: [
          { id: 'st4', title: 'Comparar precios', completed: true },
          { id: 'st5', title: 'Confirmar fechas con Mar√≠a', completed: false }
        ],
        notes: '',
        createdAt: today
      },
      {
        id: 'pt4',
        title: 'Comprar regalo cumple Carlos',
        category: 'social',
        dueDate: '2025-02-08',
        priority: 'medium',
        completed: false,
        subtasks: [],
        notes: 'Le gustan los libros de ciencia ficci√≥n',
        createdAt: today
      }
    ],
    personalCategories: [
      { id: 'home', name: 'Hogar', icon: 'üè†', color: '#10B981' },
      { id: 'admin', name: 'Admin', icon: 'üìã', color: '#6366F1' },
      { id: 'health', name: 'Salud', icon: '‚ù§Ô∏è', color: '#EF4444' },
      { id: 'social', name: 'Social', icon: 'üë•', color: '#F59E0B' },
      { id: 'travel', name: 'Viajes', icon: '‚úàÔ∏è', color: '#3B82F6' },
      { id: 'learning', name: 'Aprendizaje', icon: 'üìö', color: '#8B5CF6' },
      { id: 'projects', name: 'Proyectos', icon: 'üöÄ', color: '#EC4899' }
    ]
  };
};

const SAMPLE_HABITS = [
  { name: 'Meditar 10min', category: 'mental', icon: 'üßò', frequency: 'daily' },
  { name: 'Leer 30min', category: 'learning', icon: 'üìö', frequency: 'daily' },
  { name: '10k pasos', category: 'health', icon: 'üö∂', frequency: 'daily' },
  { name: 'No m√≥vil 1h ma√±ana', category: 'discipline', icon: 'üìµ', frequency: 'daily' },
  { name: '3L agua', category: 'health', icon: 'üíß', frequency: 'daily' },
  { name: 'Estiramientos', category: 'health', icon: 'ü§∏', frequency: 'daily' },
];

const SAMPLE_PROJECTS = [
  { name: 'Trabajo', color: '#8B5CF6' },
  { name: 'Personal', color: '#10B981' },
  { name: 'Side Project', color: '#F59E0B' }
];

const SAMPLE_EXERCISES = [
  { name: 'Bench Press', category: 'chest', muscle: 'Pecho' },
  { name: 'Squat', category: 'legs', muscle: 'Piernas' },
  { name: 'Deadlift', category: 'back', muscle: 'Espalda' },
  { name: 'Overhead Press', category: 'shoulders', muscle: 'Hombros' },
  { name: 'Barbell Row', category: 'back', muscle: 'Espalda' },
  { name: 'Pull Ups', category: 'back', muscle: 'Espalda' },
  { name: 'Incline DB Press', category: 'chest', muscle: 'Pecho' },
  { name: 'Lateral Raises', category: 'shoulders', muscle: 'Hombros' },
  { name: 'Tricep Pushdown', category: 'arms', muscle: 'Brazos' },
  { name: 'Bicep Curls', category: 'arms', muscle: 'Brazos' },
  { name: 'Leg Press', category: 'legs', muscle: 'Piernas' },
  { name: 'Romanian Deadlift', category: 'legs', muscle: 'Piernas' },
];

const WORKOUT_TEMPLATES = [
  {
    name: 'Push Day', category: 'push', exercises: [
      { name: 'Bench Press', targetSets: 3, targetReps: '8' },
      { name: 'Overhead Press', targetSets: 3, targetReps: '8' },
      { name: 'Incline DB Press', targetSets: 3, targetReps: '8' },
      { name: 'Lateral Raises', targetSets: 3, targetReps: '8' },
      { name: 'Tricep Pushdown', targetSets: 3, targetReps: '8' }
    ]
  },
  {
    name: 'Pull Day', category: 'pull', exercises: [
      { name: 'Deadlift', targetSets: 3, targetReps: '8' },
      { name: 'Barbell Row', targetSets: 3, targetReps: '8' },
      { name: 'Pull Ups', targetSets: 3, targetReps: '8' },
      { name: 'Bicep Curls', targetSets: 3, targetReps: '8' }
    ]
  },
  {
    name: 'Leg Day', category: 'legs', exercises: [
      { name: 'Squat', targetSets: 3, targetReps: '8' },
      { name: 'Romanian Deadlift', targetSets: 3, targetReps: '8' },
      { name: 'Leg Press', targetSets: 3, targetReps: '8' }
    ]
  },
];


// ============================================================================
// EXERCISE DATABASE - COMPLETE LIBRARY
// ============================================================================






// Default routine templates
const DEFAULT_ROUTINES = [
  {
    id: 'ppl_push',
    name: 'Push Day',
    folder: 'Push Pull Legs',
    exercises: [
      { exerciseId: 'bench_press', targetSets: 4, targetReps: '6-8', restSeconds: 180 },
      { exerciseId: 'ohp', targetSets: 3, targetReps: '8-10', restSeconds: 120 },
      { exerciseId: 'db_incline', targetSets: 3, targetReps: '10-12', restSeconds: 90 },
      { exerciseId: 'lateral_raise', targetSets: 4, targetReps: '12-15', restSeconds: 60 },
      { exerciseId: 'tricep_pushdown', targetSets: 3, targetReps: '12-15', restSeconds: 60 },
      { exerciseId: 'overhead_tricep', targetSets: 3, targetReps: '12-15', restSeconds: 60 },
    ]
  },
  {
    id: 'ppl_pull',
    name: 'Pull Day',
    folder: 'Push Pull Legs',
    exercises: [
      { exerciseId: 'deadlift', targetSets: 4, targetReps: '5-6', restSeconds: 240 },
      { exerciseId: 'barbell_row', targetSets: 4, targetReps: '8-10', restSeconds: 120 },
      { exerciseId: 'lat_pulldown', targetSets: 3, targetReps: '10-12', restSeconds: 90 },
      { exerciseId: 'face_pull', targetSets: 3, targetReps: '15-20', restSeconds: 60 },
      { exerciseId: 'barbell_curl', targetSets: 3, targetReps: '10-12', restSeconds: 60 },
      { exerciseId: 'hammer_curl', targetSets: 3, targetReps: '12-15', restSeconds: 60 },
    ]
  },
  {
    id: 'ppl_legs',
    name: 'Leg Day',
    folder: 'Push Pull Legs',
    exercises: [
      { exerciseId: 'squat', targetSets: 4, targetReps: '6-8', restSeconds: 180 },
      { exerciseId: 'rdl', targetSets: 3, targetReps: '10-12', restSeconds: 120 },
      { exerciseId: 'leg_press', targetSets: 3, targetReps: '12-15', restSeconds: 90 },
      { exerciseId: 'leg_curl', targetSets: 3, targetReps: '12-15', restSeconds: 60 },
      { exerciseId: 'leg_extension', targetSets: 3, targetReps: '12-15', restSeconds: 60 },
      { exerciseId: 'calf_raise', targetSets: 4, targetReps: '15-20', restSeconds: 45 },
    ]
  },
  {
    id: 'upper',
    name: 'Upper Body',
    folder: 'Upper Lower',
    exercises: [
      { exerciseId: 'bench_press', targetSets: 4, targetReps: '6-8', restSeconds: 180 },
      { exerciseId: 'barbell_row', targetSets: 4, targetReps: '6-8', restSeconds: 180 },
      { exerciseId: 'ohp', targetSets: 3, targetReps: '8-10', restSeconds: 120 },
      { exerciseId: 'lat_pulldown', targetSets: 3, targetReps: '10-12', restSeconds: 90 },
      { exerciseId: 'db_curl', targetSets: 3, targetReps: '12-15', restSeconds: 60 },
      { exerciseId: 'tricep_pushdown', targetSets: 3, targetReps: '12-15', restSeconds: 60 },
    ]
  },
  {
    id: 'lower',
    name: 'Lower Body',
    folder: 'Upper Lower',
    exercises: [
      { exerciseId: 'squat', targetSets: 4, targetReps: '6-8', restSeconds: 180 },
      { exerciseId: 'rdl', targetSets: 4, targetReps: '8-10', restSeconds: 120 },
      { exerciseId: 'leg_press', targetSets: 3, targetReps: '12-15', restSeconds: 90 },
      { exerciseId: 'leg_curl', targetSets: 3, targetReps: '12-15', restSeconds: 60 },
      { exerciseId: 'calf_raise', targetSets: 4, targetReps: '15-20', restSeconds: 45 },
    ]
  },
  {
    id: 'full_body',
    name: 'Full Body',
    folder: 'Full Body',
    exercises: [
      { exerciseId: 'squat', targetSets: 3, targetReps: '8-10', restSeconds: 150 },
      { exerciseId: 'bench_press', targetSets: 3, targetReps: '8-10', restSeconds: 150 },
      { exerciseId: 'barbell_row', targetSets: 3, targetReps: '8-10', restSeconds: 120 },
      { exerciseId: 'ohp', targetSets: 3, targetReps: '10-12', restSeconds: 90 },
      { exerciseId: 'rdl', targetSets: 3, targetReps: '10-12', restSeconds: 90 },
      { exerciseId: 'db_curl', targetSets: 2, targetReps: '12-15', restSeconds: 60 },
    ]
  }
];

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================








const calculatePlates = (targetWeight, barWeight = 20) => {
  const plates = [25, 20, 15, 10, 5, 2.5, 1.25];
  const perSide = (targetWeight - barWeight) / 2;
  const result = [];
  let remaining = perSide;

  for (const plate of plates) {
    while (remaining >= plate) {
      result.push(plate);
      remaining -= plate;
    }
  }

  return result;
};

const calculateWarmupSets = (workingWeight, workingReps) => {
  if (!workingWeight || workingWeight < 40) return [];

  const warmups = [];
  const barWeight = 20;

  // Empty bar
  warmups.push({ weight: barWeight, reps: 10, label: 'Barra vac√≠a' });

  // Progressive warmups
  const percentages = [0.4, 0.6, 0.8];
  const reps = [8, 5, 3];

  percentages.forEach((pct, i) => {
    const weight = Math.round(workingWeight * pct / 2.5) * 2.5;
    if (weight > barWeight) {
      warmups.push({ weight, reps: reps[i], label: `${Math.round(pct * 100)}%` });
    }
  });

  return warmups;
};

// ============================================================================
// UTILITIES
// ============================================================================
const getToday = () => new Date().toISOString().split('T')[0];
const getDateOffset = (date, offset) => {
  const d = new Date(date);
  d.setDate(d.getDate() + offset);
  return d.toISOString().split('T')[0];
};
const formatDate = (d) => new Date(d).toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
const formatDateShort = (d) => new Date(d).toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' });
const formatShortDate = (d) => new Date(d).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
const generateId = () => `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
const isToday = (d) => d === getToday();
const isPast = (d) => d < getToday();

const getWeekDates = (baseDate = getToday()) => {
  const d = new Date(baseDate);
  const day = d.getDay();
  const diff = d.getDate() - day + (day === 0 ? -6 : 1);
  const monday = new Date(d.setDate(diff));
  return Array.from({ length: 7 }, (_, i) => {
    const x = new Date(monday);
    x.setDate(monday.getDate() + i);
    return x.toISOString().split('T')[0];
  });
};

const getGreeting = () => {
  const h = new Date().getHours();
  if (h < 6) return { text: 'Buenas noches', icon: 'üåô' };
  if (h < 12) return { text: 'Buenos d√≠as', icon: '‚òÄÔ∏è' };
  if (h < 18) return { text: 'Buenas tardes', icon: 'üå§Ô∏è' };
  return { text: 'Buenas noches', icon: 'üåô' };
};

const calculateDayScore = (dayData, habitLogs, meals, tasks, workout, goals) => {
  let score = 0, max = 0;

  // Sleep (25 points)
  if (dayData?.sleep_hours !== undefined) {
    max += 25;
    const sleepScore = dayData.sleep_hours >= 7 ? 25 : dayData.sleep_hours >= 6 ? 18 : dayData.sleep_hours >= 5 ? 10 : 5;
    score += sleepScore;
  }

  // Habits (25 points)
  if (habitLogs.length > 0) {
    max += 25;
    const completed = habitLogs.filter(h => h.completed).length;
    score += Math.round((completed / habitLogs.length) * 25);
  }

  // Nutrition (25 points) - based on hitting macros
  if (meals.length > 0 && goals) {
    max += 25;
    const totalProt = meals.reduce((s, m) => s + (m.protein || 0), 0);
    const totalCals = meals.reduce((s, m) => s + (m.calories || 0), 0);
    const protScore = Math.min(totalProt / goals.protein, 1) * 15;
    const calScore = totalCals >= goals.calories * 0.8 && totalCals <= goals.calories * 1.1 ? 10 : 5;
    score += Math.round(protScore + calScore);
  }

  // Tasks (15 points)
  if (tasks.length > 0) {
    max += 15;
    const completed = tasks.filter(t => t.completed).length;
    score += Math.round((completed / tasks.length) * 15);
  }

  // Workout (10 points)
  if (workout) {
    max += 10;
    if (workout.is_completed) score += 10;
    else {
      const done = workout.exercises?.reduce((s, e) => s + e.sets.filter(x => x.completed).length, 0) || 0;
      const total = workout.exercises?.reduce((s, e) => s + e.sets.length, 0) || 1;
      score += Math.round((done / total) * 5);
    }
  }

  // Consciousness / Mindfulness (10 points) - TIER 1 fix
  // Gratitude (5 points) + Journaling/Meditation (5 points)
  if (dayData) {
    max += 10;
    if (dayData.gratitude && dayData.gratitude.length > 0) score += 5;
    if (dayData.journalEntry || dayData.meditation_done || dayData.breathing_done) score += 5;
  }

  return max > 0 ? Math.round((score / max) * 100) : 0;
};

const getHabitStreak = (habitId, habitLogs, currentDate) => {
  let streak = 0;
  let checkDate = currentDate;

  while (true) {
    const log = habitLogs.find(l => l.habit_id === habitId && l.date === checkDate);
    if (log?.completed) {
      streak++;
      checkDate = getDateOffset(checkDate, -1);
    } else {
      break;
    }
  }
  return streak;
};

const useLocalStorage = (key, init) => {
  const [val, setVal] = useState(() => {
    try {
      const item = localStorage.getItem(key);
      return item ? JSON.parse(item) : init;
    } catch {
      return init;
    }
  });

  const setValue = (v) => {
    const toStore = typeof v === 'function' ? v(val) : v;
    setVal(toStore);
    localStorage.setItem(key, JSON.stringify(toStore));
  };

  return [val, setValue];
};

// ============================================================================
// UI COMPONENTS
// ============================================================================
const AnimatedMount = ({ children, delay = 0, className = '' }) => {
  const [mounted, setMounted] = useState(false);
  useEffect(() => {
    const t = setTimeout(() => setMounted(true), delay);
    return () => clearTimeout(t);
  }, [delay]);
  return (
    <div className={`transition-all duration-500 ${mounted ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4'} ${className}`}>
      {children}
    </div>
  );
};

const ProgressRing = ({ progress, size = 60, stroke = 6, color = '#8B5CF6' }) => {
  const radius = (size - stroke) / 2;
  const circumference = radius * 2 * Math.PI;
  const offset = circumference - (progress / 100) * circumference;

  return (
    <svg width={size} height={size} className="transform -rotate-90">
      <circle cx={size / 2} cy={size / 2} r={radius} fill="none" stroke="rgba(255,255,255,0.1)" strokeWidth={stroke} />
      <circle cx={size / 2} cy={size / 2} r={radius} fill="none" stroke={color} strokeWidth={stroke} strokeDasharray={circumference} strokeDashoffset={offset} strokeLinecap="round" className="transition-all duration-1000 ease-out" />
    </svg>
  );
};

const Card = ({ children, className = '', onClick, gradient }) => (
  <div
    onClick={onClick}
    className={`
      bg-white/5 backdrop-blur-sm border border-white/10 rounded-2xl p-4 
      transition-all duration-300
      ${onClick ? 'cursor-pointer hover:bg-white/10 active:scale-[0.98]' : ''} 
      ${gradient || ''}
      ${className}
    `}
  >
    {children}
  </div>
);

const Section = ({ title, icon: Icon, iconColor = 'text-violet-400', action, actionLabel, children, className = '' }) => (
  <div className={className}>
    <div className="flex items-center justify-between mb-3">
      <div className="flex items-center gap-2">
        {Icon && <Icon className={`w-4 h-4 ${iconColor}`} />}
        <span className="font-semibold text-sm">{title}</span>
      </div>
      {action && (
        <button onClick={action} className="text-xs text-violet-400 hover:text-violet-300 flex items-center gap-1">
          {actionLabel} <ChevronRight className="w-3 h-3" />
        </button>
      )}
    </div>
    {children}
  </div>
);

// Accordion Section for collapsible areas in Hoy
const AccordionSection = ({
  title,
  icon: Icon,
  iconColor = 'text-violet-400',
  action,
  actionLabel,
  summary,
  summaryRight,
  progress = null, // 0-100 for mini progress bar
  progressColor = 'bg-violet-500',
  urgent = false, // Show attention indicator
  children,
  defaultOpen = false,
  storageKey = null, // For persisting state
  className = ''
}) => {
  // Persist state in localStorage if storageKey provided
  const [isOpen, setIsOpen] = useState(() => {
    if (storageKey) {
      try {
        const saved = localStorage.getItem(`accordion_${storageKey}`);
        if (saved !== null) return JSON.parse(saved);
      } catch { }
    }
    return defaultOpen;
  });

  // Save state when changed
  useEffect(() => {
    if (storageKey) {
      localStorage.setItem(`accordion_${storageKey}`, JSON.stringify(isOpen));
    }
  }, [isOpen, storageKey]);

  // Get progress color based on value
  const getProgressColorClass = (val) => {
    if (val >= 80) return 'bg-emerald-500';
    if (val >= 60) return 'bg-lime-500';
    if (val >= 40) return 'bg-amber-500';
    if (val >= 20) return 'bg-orange-500';
    return 'bg-red-500';
  };

  return (
    <div className={`rounded-xl border overflow-hidden transition-all duration-200 ${urgent ? 'border-amber-500/50 shadow-lg shadow-amber-500/10' : 'border-white/10'
      } ${className}`}>
      {/* Header - always visible */}
      <button
        onClick={() => setIsOpen(!isOpen)}
        className={`w-full flex items-center gap-3 p-3 transition-all active:scale-[0.99] ${isOpen ? 'bg-white/5' : 'bg-white/[0.02] hover:bg-white/5'
          }`}
      >
        {/* Icon with optional urgent pulse */}
        <div className={`relative w-9 h-9 rounded-lg flex items-center justify-center flex-shrink-0 ${urgent ? 'bg-amber-500/20' : 'bg-white/10'
          }`}>
          {Icon && <Icon className={`w-4 h-4 ${urgent ? 'text-amber-400' : iconColor}`} />}
          {urgent && (
            <div className="absolute -top-0.5 -right-0.5 w-2 h-2 bg-amber-500 rounded-full animate-pulse" />
          )}
        </div>

        <div className="flex-1 min-w-0 text-left">
          <div className="flex items-center gap-2">
            <span className="font-semibold text-sm">{title}</span>
            {summaryRight && (
              <span className={`text-xs font-medium ${progress !== null
                ? (progress >= 80 ? 'text-emerald-400' : progress >= 50 ? 'text-amber-400' : 'text-white/50')
                : 'text-white/50'
                }`}>
                {summaryRight}
              </span>
            )}
          </div>

          {/* Collapsed: show summary + mini progress */}
          {!isOpen && (
            <div className="flex items-center gap-2 mt-1">
              {progress !== null && (
                <div className="w-16 h-1 bg-white/10 rounded-full overflow-hidden flex-shrink-0">
                  <div
                    className={`h-full rounded-full transition-all ${progressColor || getProgressColorClass(progress)}`}
                    style={{ width: `${Math.min(progress, 100)}%` }}
                  />
                </div>
              )}
              {summary && (
                <span className="text-[11px] text-white/40 truncate">{summary}</span>
              )}
            </div>
          )}
        </div>

        <div className="flex items-center gap-1.5 flex-shrink-0">
          {action && isOpen && (
            <button
              onClick={(e) => { e.stopPropagation(); action(); }}
              className="text-[10px] text-violet-400 hover:text-violet-300 px-2 py-1 bg-violet-500/20 rounded hover:bg-violet-500/30 transition-colors"
            >
              {actionLabel}
            </button>
          )}
          <div className={`w-6 h-6 rounded-full flex items-center justify-center transition-all ${isOpen ? 'bg-white/10 rotate-180' : 'bg-transparent'
            }`}>
            <ChevronDown className="w-4 h-4 text-white/40" />
          </div>
        </div>
      </button>

      {/* Expandable content - simple show/hide */}
      {isOpen && (
        <div className="px-3 pb-3">
          {children}
        </div>
      )}
    </div>
  );
};

const ProgressBar = ({ value, max, color = 'bg-violet-500', height = 'h-2', showLabel = false, label = '' }) => {
  const pct = Math.min((value / max) * 100, 100);
  const isOver = value > max;
  return (
    <div className="space-y-1">
      {showLabel && (
        <div className="flex justify-between text-xs">
          <span className="text-white/60">{label}</span>
          <span className={isOver ? 'text-red-400' : 'text-white/80'}>{value}/{max}</span>
        </div>
      )}
      <div className={`${height} bg-white/10 rounded-full overflow-hidden`}>
        <div
          className={`h-full rounded-full transition-all duration-700 ${isOver ? 'bg-red-500' : color}`}
          style={{ width: `${pct}%` }}
        />
      </div>
    </div>
  );
};

const DayScore = ({ score, size = 'md' }) => {
  const sizes = { sm: 50, md: 70, lg: 90 };
  const strokes = { sm: 4, md: 5, lg: 6 };
  const s = sizes[size];
  const stroke = strokes[size];
  const r = (s - stroke) / 2;
  const c = r * 2 * Math.PI;
  const offset = c - (score / 100) * c;
  const color = score >= 80 ? '#10B981' : score >= 60 ? '#84CC16' : score >= 40 ? '#F59E0B' : '#EF4444';

  return (
    <div className="relative inline-flex items-center justify-center">
      <svg width={s} height={s} className="transform -rotate-90">
        <circle cx={s / 2} cy={s / 2} r={r} fill="none" stroke="rgba(255,255,255,0.1)" strokeWidth={stroke} />
        <circle
          cx={s / 2} cy={s / 2} r={r} fill="none" stroke={color} strokeWidth={stroke}
          strokeDasharray={c} strokeDashoffset={offset} strokeLinecap="round"
          className="transition-all duration-1000"
        />
      </svg>
      <div className="absolute flex flex-col items-center">
        <span className={`font-bold ${size === 'sm' ? 'text-sm' : size === 'md' ? 'text-lg' : 'text-2xl'}`}>{score}</span>
      </div>
    </div>
  );
};

const MiniChart = ({ data, color = '#8B5CF6', height = 40 }) => {
  if (!data || data.length < 2) return null;
  const min = Math.min(...data);
  const max = Math.max(...data);
  const range = max - min || 1;
  const points = data.map((v, i) => `${(i / (data.length - 1)) * 100},${100 - ((v - min) / range) * 100}`).join(' ');

  return (
    <svg viewBox="0 0 100 100" className="w-full" style={{ height }} preserveAspectRatio="none">
      <polyline fill="none" stroke={color} strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" points={points} />
    </svg>
  );
};

const EnergyIndicator = ({ level, onChange, compact = false }) => {
  const colors = {
    1: 'bg-red-500/30 text-red-400 border-red-500/50',
    2: 'bg-orange-500/30 text-orange-400 border-orange-500/50',
    3: 'bg-yellow-500/30 text-yellow-400 border-yellow-500/50',
    4: 'bg-lime-500/30 text-lime-400 border-lime-500/50',
    5: 'bg-emerald-500/30 text-emerald-400 border-emerald-500/50'
  };

  if (compact) {
    return (
      <div className="flex gap-0.5">
        {[1, 2, 3, 4, 5].map(i => (
          <button
            key={i}
            onClick={() => onChange?.(i)}
            className={`w-5 h-5 rounded-full transition-all ${i <= level ? colors[level].split(' ')[0] : 'bg-white/10'}`}
          />
        ))}
      </div>
    );
  }

  return (
    <div className="flex gap-1.5">
      {[1, 2, 3, 4, 5].map(i => (
        <button
          key={i}
          onClick={() => onChange?.(i)}
          className={`w-8 h-8 rounded-full flex items-center justify-center transition-all border
            ${i <= level ? colors[level] : 'bg-white/5 border-white/10 text-white/20'}
            ${onChange ? 'hover:scale-110 cursor-pointer' : ''}
          `}
        >
          <Zap className="w-4 h-4" />
        </button>
      ))}
    </div>
  );
};

const WaterTracker = ({ current, target, onChange }) => {
  return (
    <div className="flex items-center gap-2">
      <div className="flex gap-1">
        {Array.from({ length: target }, (_, i) => (
          <button
            key={i}
            onClick={() => onChange?.(i < current ? i : i + 1)}
            className={`w-4 h-6 rounded-sm transition-all ${i < current ? 'bg-blue-500' : 'bg-white/10'}`}
          />
        ))}
      </div>
      <span className="text-xs text-white/60">{current}/{target}</span>
    </div>
  );
};

const MoodSelector = ({ value, onChange }) => {
  const moods = [
    { emoji: 'üò´', label: 'Muy mal', color: 'bg-red-500' },
    { emoji: 'üòî', label: 'Mal', color: 'bg-orange-500' },
    { emoji: 'üòê', label: 'Normal', color: 'bg-yellow-500' },
    { emoji: 'üôÇ', label: 'Bien', color: 'bg-lime-500' },
    { emoji: 'üòÑ', label: 'Genial', color: 'bg-emerald-500' }
  ];

  return (
    <div className="flex gap-2">
      {moods.map((m, i) => (
        <button
          key={i}
          onClick={() => onChange?.(i + 1)}
          className={`flex-1 py-3 rounded-xl text-2xl transition-all ${value === i + 1 ? `${m.color} scale-110` : 'bg-white/5 hover:bg-white/10'}`}
        >
          {m.emoji}
        </button>
      ))}
    </div>
  );
};

const SleepInput = ({ hours, quality, onSave }) => {
  const [h, setH] = useState(hours || 7);
  const [q, setQ] = useState(quality || 3);

  return (
    <div className="space-y-4">
      <div>
        <div className="flex justify-between text-sm mb-2">
          <span className="text-white/60">Horas de sue√±o</span>
          <span className="font-bold">{h}h</span>
        </div>
        <input
          type="range" min="0" max="12" step="0.5" value={h}
          onChange={(e) => setH(parseFloat(e.target.value))}
          className="w-full accent-blue-500"
        />
      </div>
      <div>
        <div className="flex justify-between text-sm mb-2">
          <span className="text-white/60">Calidad</span>
          <span className="text-white/40 text-xs">{['', 'Muy mal', 'Mal', 'Normal', 'Bien', 'Excelente'][q]}</span>
        </div>
        <div className="flex gap-1">
          {[1, 2, 3, 4, 5].map(i => (
            <button
              key={i}
              onClick={() => setQ(i)}
              className={`flex-1 h-10 rounded-lg transition-all ${i <= q ? 'bg-blue-500' : 'bg-white/10'}`}
            />
          ))}
        </div>
      </div>
      <button
        onClick={() => onSave?.({ hours: h, quality: q })}
        className="w-full bg-blue-500 py-3 rounded-xl font-medium"
      >
        Guardar
      </button>
    </div>
  );
};

const NavItem = ({ icon: Icon, label, active, onClick, badge }) => (
  <button
    onClick={onClick}
    className={`flex flex-col items-center gap-1 p-2 rounded-xl transition-all relative
      ${active ? 'text-violet-400' : 'text-white/40 hover:text-white/60'}
    `}
  >
    <Icon className={`w-6 h-6 ${active ? 'scale-110' : ''} transition-transform`} />
    <span className="text-[10px]">{label}</span>
    {badge && (
      <div className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center text-[10px] font-bold">
        {badge}
      </div>
    )}
  </button>
);

const EmptyState = ({ icon: Icon, title, description, action, onAction }) => (
  <div className="flex flex-col items-center justify-center py-12 px-6 text-center">
    <div className="w-16 h-16 rounded-full bg-white/5 flex items-center justify-center mb-4">
      <Icon className="w-8 h-8 text-white/30" />
    </div>
    <h3 className="text-lg font-medium text-white/70 mb-2">{title}</h3>
    <p className="text-sm text-white/40 mb-6">{description}</p>
    {action && (
      <button onClick={onAction} className="flex items-center gap-2 px-6 py-3 bg-violet-500 rounded-xl font-medium">
        <Plus className="w-5 h-5" />{action}
      </button>
    )}
  </div>
);

const Modal = ({ isOpen, onClose, title, children, footer }) => {
  // Prevent body scroll when modal is open
  useEffect(() => {
    if (isOpen) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = '';
    }
    return () => { document.body.style.overflow = ''; };
  }, [isOpen]);

  if (!isOpen) return null;

  return (
    <div
      className="fixed z-[9999] flex items-center justify-center"
      style={{ top: '-100px', left: '-100px', right: '-100px', bottom: '-100px' }}
      onClick={onClose}
    >
      <div
        className="absolute backdrop-blur-sm bg-black/20"
        style={{ top: 0, left: 0, right: 0, bottom: 0 }}
      />
      <div
        className="relative bg-zinc-900 rounded-2xl flex flex-col shadow-2xl border border-white/10 mx-4"
        style={{ maxHeight: 'calc(100vh - 120px)', width: '100%', maxWidth: '380px', marginBottom: '60px' }}
        onClick={(e) => e.stopPropagation()}
      >
        {/* Header fijo */}
        <div className="flex items-center justify-between p-4 border-b border-white/10">
          <h2 className="text-xl font-bold">{title}</h2>
          <button onClick={onClose} className="p-2 hover:bg-white/10 rounded-lg">
            <X className="w-5 h-5" />
          </button>
        </div>
        {/* Contenido scrolleable */}
        <div className="flex-1 overflow-y-auto p-4" style={{ minHeight: 0 }}>
          {children}
        </div>
        {/* Footer fijo (opcional) */}
        {footer && (
          <div className="p-4 border-t border-white/10">
            {footer}
          </div>
        )}
      </div>
    </div>
  );
};

const Toast = ({ message, type = 'success', onClose }) => {
  useEffect(() => {
    const t = setTimeout(onClose, type === 'celebration' ? 4000 : 3000);
    return () => clearTimeout(t);
  }, [onClose, type]);

  const colors = {
    success: 'bg-emerald-500',
    info: 'bg-blue-500',
    warning: 'bg-amber-500',
    error: 'bg-red-500',
    celebration: 'bg-gradient-to-r from-violet-500 via-fuchsia-500 to-pink-500'
  };

  const icons = {
    success: <Check className="w-5 h-5" />,
    info: <Sparkles className="w-5 h-5" />,
    warning: <AlertCircle className="w-5 h-5" />,
    error: <X className="w-5 h-5" />,
    celebration: <span className="text-xl">üéâ</span>
  };

  return (
    <div className={`fixed top-6 left-1/2 -translate-x-1/2 ${colors[type]} px-6 py-3 rounded-xl shadow-2xl z-50 animate-slide-down flex items-center gap-2 ${type === 'celebration' ? 'scale-110' : ''}`}>
      {icons[type] || icons.success}
      <span className="font-medium">{message}</span>
      {type === 'celebration' && <span className="text-xl">‚ú®</span>}
    </div>
  );
};

const SwipeableItem = ({ children, onDelete }) => {
  const [offset, setOffset] = useState(0);

  return (
    <div className="relative overflow-hidden rounded-xl">
      <div className="absolute right-0 top-0 bottom-0 flex items-center pr-2">
        {onDelete && (
          <button onClick={onDelete} className="w-12 h-12 rounded-xl bg-red-500 flex items-center justify-center">
            <Trash2 className="w-5 h-5" />
          </button>
        )}
      </div>
      <div
        className="relative bg-zinc-900 transition-transform duration-200"
        style={{ transform: `translateX(-${offset}px)` }}
        onTouchStart={(e) => { e.currentTarget.startX = e.touches[0].clientX; }}
        onTouchMove={(e) => {
          const diff = e.currentTarget.startX - e.touches[0].clientX;
          if (diff > 0) setOffset(Math.min(diff, 70));
        }}
        onTouchEnd={() => setOffset(offset > 40 ? 70 : 0)}
        onClick={() => offset > 0 && setOffset(0)}
      >
        {children}
      </div>
    </div>
  );
};

const RestTimer = ({ initialSeconds = 90, onComplete, onCancel }) => {
  const [seconds, setSeconds] = useState(initialSeconds);
  const [paused, setPaused] = useState(false);

  useEffect(() => {
    if (paused || seconds <= 0) {
      if (seconds <= 0) onComplete?.();
      return;
    }
    const i = setInterval(() => setSeconds(s => s - 1), 1000);
    return () => clearInterval(i);
  }, [seconds, paused, onComplete]);

  const progress = (seconds / initialSeconds) * 100;

  return (
    <Card className="bg-gradient-to-r from-blue-500/20 to-cyan-500/20 border-blue-500/30">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="relative w-12 h-12">
            <svg className="w-12 h-12 transform -rotate-90">
              <circle cx="24" cy="24" r="20" fill="none" stroke="rgba(255,255,255,0.1)" strokeWidth="4" />
              <circle
                cx="24" cy="24" r="20" fill="none" stroke="#3B82F6" strokeWidth="4"
                strokeDasharray={125.6} strokeDashoffset={125.6 * (1 - progress / 100)}
                strokeLinecap="round" className="transition-all duration-1000"
              />
            </svg>
            <Timer className="w-5 h-5 text-blue-400 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2" />
          </div>
          <div>
            <p className="text-xs text-white/60">Descanso</p>
            <p className="text-2xl font-mono font-bold">{Math.floor(seconds / 60)}:{(seconds % 60).toString().padStart(2, '0')}</p>
          </div>
        </div>
        <div className="flex gap-2">
          <button onClick={() => setPaused(!paused)} className="p-2 bg-white/10 rounded-lg hover:bg-white/20">
            {paused ? <Play className="w-5 h-5" /> : <Pause className="w-5 h-5" />}
          </button>
          <button onClick={() => setSeconds(initialSeconds)} className="p-2 bg-white/10 rounded-lg hover:bg-white/20">
            <RotateCcw className="w-5 h-5" />
          </button>
          <button onClick={onCancel} className="p-2 bg-white/10 rounded-lg hover:bg-white/20">
            <X className="w-5 h-5" />
          </button>
        </div>
      </div>
    </Card>
  );
};

// ============================================================================
// ONBOARDING SCREEN
// ============================================================================
const OnboardingScreen = ({ data, setData, onComplete }) => {
  const [step, setStep] = useState(0);
  const [name, setName] = useState('');
  const [goals, setGoals] = useState({ calories: 2200, protein: 180, water: 8 });
  const [selectedHabits, setSelectedHabits] = useState([]);
  const [selectedProjects, setSelectedProjects] = useState([]);
  const [mantra, setMantra] = useState('');

  const steps = ['¬øC√≥mo te llamas?', 'Tus objetivos', 'Elige h√°bitos', 'Tus proyectos', 'Tu mantra'];

  const handleComplete = () => {
    const today = getToday();
    setData(prev => ({
      ...prev,
      user: {
        ...prev.user,
        name,
        onboardingComplete: true,
        goals: { ...prev.user.goals, ...goals },
        mantra
      },
      days: {
        [today]: {
          id: today,
          energy_level: 3,
          sleep_hours: 0,
          sleep_quality: 0,
          water_glasses: 0,
          focus_note: ''
        }
      },
      habits: selectedHabits.map(h => ({
        id: generateId(),
        ...h,
        created_at: today
      })),
      habitLogs: [],
      projects: selectedProjects.map(p => ({ id: generateId(), ...p, active: true })),
      workoutTemplates: WORKOUT_TEMPLATES.map(t => ({ ...t, id: generateId() })),
    }));
    onComplete();
  };

  const handleNext = () => {
    if (step < 4) setStep(step + 1);
    else handleComplete();
  };

  const canProceed = () => {
    if (step === 0) return name.trim().length >= 2;
    if (step === 1) return goals.calories > 0;
    if (step === 2) return selectedHabits.length >= 1;
    return true;
  };

  return (
    <div className="min-h-screen bg-zinc-950 text-white flex flex-col">
      <div className="fixed inset-0 bg-gradient-to-br from-violet-950/50 via-zinc-950 to-fuchsia-950/30 pointer-events-none" />
      <div className="relative flex-1 flex flex-col max-w-md mx-auto w-full px-6 py-8">
        {/* Progress */}
        <div className="flex gap-2 mb-8">
          {steps.map((_, i) => (
            <div key={i} className={`flex-1 h-1 rounded-full transition-all ${i <= step ? 'bg-violet-500' : 'bg-white/10'}`} />
          ))}
        </div>

        {/* Title */}
        <AnimatedMount key={step}>
          <h1 className="text-3xl font-bold mb-2">{steps[step]}</h1>
          <p className="text-white/50 mb-8">
            {step === 0 && 'Personalicemos tu experiencia'}
            {step === 1 && 'Define tus metas diarias'}
            {step === 2 && 'Construye tu identidad'}
            {step === 3 && 'Organiza tu trabajo'}
            {step === 4 && 'Una frase que te impulse'}
          </p>
        </AnimatedMount>

        {/* Content */}
        <AnimatedMount key={`content-${step}`} delay={100} className="flex-1">
          {step === 0 && (
            <input
              type="text"
              value={name}
              onChange={(e) => setName(e.target.value)}
              placeholder="Tu nombre"
              autoFocus
              className="w-full bg-white/5 border border-white/10 rounded-2xl p-4 text-xl outline-none focus:border-violet-500 transition-colors"
            />
          )}

          {step === 1 && (
            <div className="space-y-6">
              <div>
                <label className="text-sm text-white/60 mb-2 block">Calor√≠as diarias</label>
                <div className="flex items-center gap-4">
                  <input
                    type="range" min="1200" max="4000" step="50"
                    value={goals.calories}
                    onChange={(e) => setGoals(g => ({ ...g, calories: parseInt(e.target.value) }))}
                    className="flex-1 accent-violet-500"
                  />
                  <span className="text-2xl font-bold w-24 text-right">{goals.calories}</span>
                </div>
              </div>
              <div>
                <label className="text-sm text-white/60 mb-2 block">Prote√≠na (g)</label>
                <div className="flex items-center gap-4">
                  <input
                    type="range" min="50" max="300" step="5"
                    value={goals.protein}
                    onChange={(e) => setGoals(g => ({ ...g, protein: parseInt(e.target.value) }))}
                    className="flex-1 accent-violet-500"
                  />
                  <span className="text-2xl font-bold w-24 text-right">{goals.protein}g</span>
                </div>
              </div>
              <div>
                <label className="text-sm text-white/60 mb-2 block">Vasos de agua</label>
                <div className="flex items-center gap-4">
                  <input
                    type="range" min="4" max="12" step="1"
                    value={goals.water}
                    onChange={(e) => setGoals(g => ({ ...g, water: parseInt(e.target.value) }))}
                    className="flex-1 accent-blue-500"
                  />
                  <span className="text-2xl font-bold w-24 text-right">{goals.water} üíß</span>
                </div>
              </div>
            </div>
          )}

          {step === 2 && (
            <div className="space-y-3 max-h-[50vh] overflow-y-auto">
              {SAMPLE_HABITS.map(h => (
                <button
                  key={h.name}
                  onClick={() => setSelectedHabits(prev =>
                    prev.find(x => x.name === h.name)
                      ? prev.filter(x => x.name !== h.name)
                      : [...prev, h]
                  )}
                  className={`w-full flex items-center gap-3 p-4 rounded-xl transition-all
                    ${selectedHabits.find(x => x.name === h.name)
                      ? 'bg-violet-500/20 border-2 border-violet-500'
                      : 'bg-white/5 border-2 border-transparent hover:bg-white/10'}
                  `}
                >
                  <span className="text-2xl">{h.icon}</span>
                  <span className="flex-1 text-left">{h.name}</span>
                  {selectedHabits.find(x => x.name === h.name) && (
                    <Check className="w-5 h-5 text-violet-400" />
                  )}
                </button>
              ))}
            </div>
          )}

          {step === 3 && (
            <div className="space-y-3">
              {SAMPLE_PROJECTS.map(p => (
                <button
                  key={p.name}
                  onClick={() => setSelectedProjects(prev =>
                    prev.find(x => x.name === p.name)
                      ? prev.filter(x => x.name !== p.name)
                      : [...prev, p]
                  )}
                  className={`w-full flex items-center gap-3 p-4 rounded-xl transition-all
                    ${selectedProjects.find(x => x.name === p.name)
                      ? 'bg-white/10 border-2 border-white/30'
                      : 'bg-white/5 border-2 border-transparent hover:bg-white/10'}
                  `}
                >
                  <div className="w-4 h-4 rounded-full" style={{ backgroundColor: p.color }} />
                  <span className="flex-1 text-left">{p.name}</span>
                  {selectedProjects.find(x => x.name === p.name) && <Check className="w-5 h-5" />}
                </button>
              ))}
            </div>
          )}

          {step === 4 && (
            <div className="space-y-4">
              <textarea
                value={mantra}
                onChange={(e) => setMantra(e.target.value)}
                placeholder="Ej: Disciplina es libertad..."
                rows={3}
                className="w-full bg-white/5 border border-white/10 rounded-2xl p-4 text-lg outline-none focus:border-violet-500 resize-none"
              />
              <p className="text-sm text-white/40">
                Este mantra aparecer√° cada d√≠a para recordarte tu prop√≥sito.
              </p>
            </div>
          )}
        </AnimatedMount>

        {/* Navigation */}
        <div className="flex gap-3 pt-6">
          {step > 0 && (
            <button
              onClick={() => setStep(step - 1)}
              className="px-6 py-4 bg-white/10 rounded-xl hover:bg-white/20 transition-colors"
            >
              Atr√°s
            </button>
          )}
          <button
            onClick={handleNext}
            disabled={!canProceed()}
            className={`flex-1 py-4 rounded-xl font-medium flex items-center justify-center gap-2 transition-all
              ${canProceed()
                ? 'bg-violet-500 hover:bg-violet-600'
                : 'bg-white/10 text-white/30 cursor-not-allowed'}
            `}
          >
            {step === 4 ? (
              <><Sparkles className="w-5 h-5" />Empezar</>
            ) : (
              <>Siguiente<ArrowRight className="w-5 h-5" /></>
            )}
          </button>
        </div>
      </div>
    </div>
  );
};

// ============================================================================
// TODAY SCREEN - COMMAND CENTER
// ============================================================================
const TodayScreen = ({ data, setData, setScreen, showToast }) => {
  // Date navigation
  const [viewDate, setViewDate] = useState(getToday());
  const [viewMode, setViewMode] = useState('day'); // 'day', 'week'
  const [editingSet, setEditingSet] = useState(null); // For inline set editing
  const [showWorkoutOptions, setShowWorkoutOptions] = useState(false); // Workout menu
  const [calendarYear, setCalendarYear] = useState(new Date().getFullYear()); // Year for calendar view

  // Work section states
  const [quickTaskInput, setQuickTaskInput] = useState('');
  const [showDetailedAdd, setShowDetailedAdd] = useState(false);
  const [editingWorkTask, setEditingWorkTask] = useState(null);
  const [focusTimer, setFocusTimer] = useState(null);
  const [focusTimeLeft, setFocusTimeLeft] = useState(0);
  const [newDetailedTask, setNewDetailedTask] = useState({
    title: '', description: '', project_id: '', priority: 'medium',
    eisenhower: 'q2', status: 'todo', timeEstimate: 30, dueDate: '', isDeepWork: false
  });

  // Consciousness inline states
  const [consGratitudeInputs, setConsGratitudeInputs] = useState(['', '', '']);
  const [consJournalText, setConsJournalText] = useState('');
  const [consJournalMood, setConsJournalMood] = useState(null);
  const [consBreathingActive, setConsBreathingActive] = useState(false);
  const [consBreathPhase, setConsBreathPhase] = useState('idle');
  const [consBreathTimer, setConsBreathTimer] = useState(0);
  const [consBreathRound, setConsBreathRound] = useState(0);
  const [consBreathTechnique, setConsBreathTechnique] = useState('478');
  const [consExpandedCard, setConsExpandedCard] = useState(null); // 'gratitude', 'journal', 'breathing', 'practice'
  const [consPracticeNotes, setConsPracticeNotes] = useState('');

  // Relationships states
  const [relExpandedCard, setRelExpandedCard] = useState(null);
  const [relShowAddContact, setRelShowAddContact] = useState(false);
  const [relNewContact, setRelNewContact] = useState({ name: '', category: 'close_friend', contactFrequency: 'weekly' });
  const [relInteractionNote, setRelInteractionNote] = useState('');

  // Personal tasks states  
  const [personalExpandedTask, setPersonalExpandedTask] = useState(null);
  const [personalNewSubtask, setPersonalNewSubtask] = useState('');
  const [personalShowAddTask, setPersonalShowAddTask] = useState(false);
  const [personalNewTask, setPersonalNewTask] = useState({ title: '', category: 'home', dueDate: '', priority: 'medium' });

  const today = getToday();
  const isViewingToday = viewDate === today;

  // Focus timer effect
  useEffect(() => {
    if (focusTimer && focusTimeLeft > 0) {
      const interval = setInterval(() => {
        setFocusTimeLeft(t => {
          if (t <= 1) {
            clearInterval(interval);
            setFocusTimer(null);
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
            showToast('üçÖ Pomodoro completado!');
            return 0;
          }
          return t - 1;
        });
      }, 1000);
      return () => clearInterval(interval);
    }
  }, [focusTimer, focusTimeLeft]);

  // Breathing timer effect for consciousness section
  useEffect(() => {
    if (!consBreathingActive || consBreathPhase === 'idle') return;

    const breathTechniques = {
      '478': { inhale: 4, hold: 7, exhale: 8, holdOut: 0, rounds: 4 },
      'box': { inhale: 4, hold: 4, exhale: 4, holdOut: 4, rounds: 4 }
    };
    const technique = breathTechniques[consBreathTechnique];

    const targetTime = consBreathPhase === 'inhale' ? technique.inhale :
      consBreathPhase === 'hold' ? technique.hold :
        consBreathPhase === 'exhale' ? technique.exhale : technique.holdOut;

    const interval = setInterval(() => {
      setConsBreathTimer(t => {
        if (t >= targetTime - 0.1) {
          // Move to next phase
          let nextPhase;
          if (consBreathPhase === 'inhale') nextPhase = technique.hold > 0 ? 'hold' : 'exhale';
          else if (consBreathPhase === 'hold') nextPhase = 'exhale';
          else if (consBreathPhase === 'exhale') nextPhase = technique.holdOut > 0 ? 'holdOut' : 'inhale';
          else nextPhase = 'inhale';

          // Check if round complete
          if (nextPhase === 'inhale' && consBreathPhase !== 'inhale') {
            if (consBreathRound >= technique.rounds - 1) {
              // Session complete
              setConsBreathingActive(false);
              setConsBreathPhase('idle');
              setConsBreathRound(0);
              return 0;
            }
            setConsBreathRound(r => r + 1);
          }

          setConsBreathPhase(nextPhase);
          return 0;
        }
        return t + 0.1;
      });
    }, 100);

    return () => clearInterval(interval);
  }, [consBreathingActive, consBreathPhase, consBreathTechnique, consBreathRound]);

  // Navigation handlers
  const goToPrevDay = () => setViewDate(getDateOffset(viewDate, -1));
  const goToNextDay = () => setViewDate(getDateOffset(viewDate, 1));
  const goToToday = () => setViewDate(today);

  // Get relative day name
  const getRelativeDayName = () => {
    const diffDays = Math.round((new Date(viewDate) - new Date(today)) / (1000 * 60 * 60 * 24));
    switch (diffDays) {
      case -2: return 'Antes de ayer';
      case -1: return 'Ayer';
      case 0: return 'Hoy';
      case 1: return 'Ma√±ana';
      case 2: return 'Pasado ma√±ana';
      default: return null;
    }
  };

  // Format date for display
  const formatViewDate = () => {
    const relativeName = getRelativeDayName();
    const date = new Date(viewDate);
    const dayMonth = date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });

    if (relativeName) {
      return `${relativeName}, ${dayMonth}`;
    }

    const dayName = date.toLocaleDateString('es-ES', { weekday: 'long' });
    return `${dayName.charAt(0).toUpperCase() + dayName.slice(1)}, ${dayMonth}`;
  };

  // Check if viewing future
  const isViewingFuture = viewDate > today;

  // Get planned meals for future dates
  const plannedMealsForDate = (data.plannedMeals || []).filter(m => m.day_id === viewDate && !m.confirmed);

  // Get or create day data
  const dayData = data.days[viewDate] || {
    energy_level: 3,
    sleep_hours: 0,
    sleep_quality: 0,
    water_glasses: 0,
    focus_note: ''
  };

  // Filter data for current view date
  const dayMeals = data.meals.filter(m => m.day_id === viewDate);
  const dayWorkout = data.workouts.find(w => w.day_id === viewDate);
  const dayTasks = data.tasks.filter(t => t.day_id === viewDate);
  const dayJournal = data.journals?.find(j => j.date === viewDate);

  // Get habit logs for this day (initialize if needed)
  const dayHabitLogs = useMemo(() => {
    return data.habits.map(habit => {
      const existingLog = data.habitLogs?.find(l => l.habit_id === habit.id && l.date === viewDate);
      return existingLog || { habit_id: habit.id, date: viewDate, completed: false };
    });
  }, [data.habits, data.habitLogs, viewDate]);

  // Elite habit helpers
  const shouldDoHabitOnDay = (habit, date) => {
    const dayOfWeek = new Date(date).getDay();
    if (!habit.frequency || habit.frequency === 'daily') return true;
    if (habit.frequency === 'weekdays') return dayOfWeek >= 1 && dayOfWeek <= 5;
    if (habit.frequency === 'weekend') return dayOfWeek === 0 || dayOfWeek === 6;
    if (habit.frequency === 'custom') return (habit.customDays || [1, 2, 3, 4, 5, 6, 0]).includes(dayOfWeek);
    return true;
  };

  const getStreakWithFreeze = (habitId, freezeDays = 2) => {
    const logs = data.habitLogs?.filter(l => l.habit_id === habitId && l.completed) || [];
    if (logs.length === 0) return { current: 0, best: 0 };
    const sortedDates = [...new Set(logs.map(l => l.date))].sort().reverse();
    let streak = 0;
    let freezeUsed = 0;
    let currentDate = new Date(today);
    const habit = data.habits.find(h => h.id === habitId);
    const todayLog = logs.find(l => l.date === today);
    if (!todayLog && shouldDoHabitOnDay(habit, today)) {
      currentDate.setDate(currentDate.getDate() - 1);
    }
    for (let i = 0; i < 365; i++) {
      const dateStr = currentDate.toISOString().split('T')[0];
      const wasCompleted = sortedDates.includes(dateStr);
      const shouldDo = shouldDoHabitOnDay(habit, dateStr);
      if (shouldDo) {
        if (wasCompleted) streak++;
        else if (freezeUsed < freezeDays) freezeUsed++;
        else break;
      }
      currentDate.setDate(currentDate.getDate() - 1);
    }
    return { current: streak, freezeUsed };
  };

  const getMissedYesterday = (habitId) => {
    const yesterday = getDateOffset(today, -1);
    const habit = data.habits.find(h => h.id === habitId);
    if (!shouldDoHabitOnDay(habit, yesterday)) return false;
    const log = data.habitLogs?.find(l => l.habit_id === habitId && l.date === yesterday && l.completed);
    return !log;
  };

  const getMasteryLevel = (habitId) => {
    const totalCompletions = data.habitLogs?.filter(l => l.habit_id === habitId && l.completed).length || 0;
    const streak = getStreakWithFreeze(habitId);
    const score = (totalCompletions * 0.3) + (streak.current * 2);
    if (score >= 100) return 5;
    if (score >= 60) return 4;
    if (score >= 30) return 3;
    if (score >= 15) return 2;
    return 1;
  };

  // Habits that should be done on viewDate
  const todayHabits = data.habits.filter(h => shouldDoHabitOnDay(h, viewDate));
  const todayHabitsCompleted = dayHabitLogs.filter(l => {
    const habit = data.habits.find(h => h.id === l.habit_id);
    return l.completed && shouldDoHabitOnDay(habit, viewDate);
  }).length;

  // Check for "never miss twice" alerts
  const habitsWithAlert = data.habits.filter(h => getMissedYesterday(h.id) && !dayHabitLogs.find(l => l.habit_id === h.id)?.completed);

  // Calculations
  const totalCals = dayMeals.reduce((s, m) => s + (m.calories || 0), 0);
  const totalProt = dayMeals.reduce((s, m) => s + (m.protein || 0), 0);
  const totalCarbs = dayMeals.reduce((s, m) => s + (m.carbs || 0), 0);
  const totalFats = dayMeals.reduce((s, m) => s + (m.fats || 0), 0);
  const habitsCompleted = todayHabitsCompleted;
  const tasksCompleted = dayTasks.filter(t => t.completed).length;
  const dayScore = calculateDayScore(dayData, dayHabitLogs, dayMeals, dayTasks, dayWorkout, data.user.goals);

  const latestWeight = data.bodyMetrics?.sort((a, b) => b.date.localeCompare(a.date))[0];
  const prevWeight = data.bodyMetrics?.sort((a, b) => b.date.localeCompare(a.date))[1];
  const weightChange = latestWeight && prevWeight ? (latestWeight.weight - prevWeight.weight).toFixed(1) : null;

  // Week overview
  const weekDates = getWeekDates(viewDate);
  const weekDayNames = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];

  // Modals
  const [showSleep, setShowSleep] = useState(false);
  const [showFocus, setShowFocus] = useState(false);
  const [showJournal, setShowJournal] = useState(false);
  const [showQuickAdd, setShowQuickAdd] = useState(false);
  const [showAddMeal, setShowAddMeal] = useState(false);
  const [selectedMealType, setSelectedMealType] = useState('lunch');

  // Meal search states
  const [mealSearchQuery, setMealSearchQuery] = useState('');
  const [mealCategory, setMealCategory] = useState('all');
  const [selectedFood, setSelectedFood] = useState(null);
  const [mealServings, setMealServings] = useState(1);
  const [mealAddMode, setMealAddMode] = useState('search'); // 'search', 'scan', 'new'
  const [newFood, setNewFood] = useState({ name: '', serving: '100g', calories: '', protein: '', carbs: '', fats: '', barcode: '', category: 'other' });
  const [scannedBarcode, setScannedBarcode] = useState('');
  const [showCreateFromScan, setShowCreateFromScan] = useState(false);

  // Combined food database (built-in + user custom)
  const customFoods = data.customFoods || [];
  const allFoods = [...FOOD_DATABASE, ...customFoods];

  // Get active meal types from user settings
  const mealMode = data.user.goals?.mealMode || 'separate';
  const activeMealSlots = data.user.goals?.mealSlots || ['breakfast', 'lunch', 'snack', 'dinner'];
  const allMealTypes = [
    { type: 'breakfast', emoji: 'üåÖ', label: 'Desayuno' },
    { type: 'lunch', emoji: '‚òÄÔ∏è', label: 'Comida' },
    { type: 'snack', emoji: 'üçé', label: 'Snack' },
    { type: 'dinner', emoji: 'üåô', label: 'Cena' }
  ];
  const visibleMealTypes = mealMode === 'single'
    ? [{ type: 'all', emoji: 'üçΩÔ∏è', label: 'Comidas' }]
    : allMealTypes.filter(m => activeMealSlots.includes(m.type));

  // Get active areas from settings
  const activeAreas = data.user.activeAreas || ['nutrition', 'workout', 'habits', 'work', 'personal', 'body', 'finances', 'consciousness', 'relationships'];

  const [focusNote, setFocusNote] = useState(dayData.focus_note || '');
  const [journalData, setJournalData] = useState(dayJournal || {
    mood: 3,
    energy: 3,
    wins: ['', '', ''],
    gratitude: '',
    learning: '',
    tomorrow: ['', '', ''],
    reflection: ''
  });

  // Greeting
  const greeting = getGreeting();

  // Handlers
  const updateDay = (updates) => {
    setData(prev => ({
      ...prev,
      days: {
        ...prev.days,
        [viewDate]: { ...dayData, ...updates }
      }
    }));
  };

  // Confirm planned meal
  const confirmPlannedMeal = (plannedMeal) => {
    const meal = {
      id: generateId(),
      day_id: viewDate,
      meal_type: plannedMeal.meal_type,
      name: plannedMeal.name,
      serving: plannedMeal.serving,
      servings: plannedMeal.servings,
      time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
      calories: plannedMeal.calories,
      protein: plannedMeal.protein,
      carbs: plannedMeal.carbs,
      fats: plannedMeal.fats,
      fromPlanned: true
    };

    setData(prev => ({
      ...prev,
      meals: [...prev.meals, meal],
      plannedMeals: prev.plannedMeals.map(m =>
        m.id === plannedMeal.id ? { ...m, confirmed: true } : m
      )
    }));

    showToast('Comida confirmada');
  };

  // Delete planned meal
  const deletePlannedMeal = (id) => {
    setData(prev => ({
      ...prev,
      plannedMeals: prev.plannedMeals.filter(m => m.id !== id)
    }));
    showToast('Planificaci√≥n eliminada');
  };

  const toggleHabit = (habitId, useMinVersion = false) => {
    const existingLog = data.habitLogs?.find(l => l.habit_id === habitId && l.date === viewDate);
    const habit = data.habits.find(h => h.id === habitId);

    if (existingLog) {
      const wasCompleted = existingLog.completed;
      setData(prev => ({
        ...prev,
        habitLogs: prev.habitLogs.map(l =>
          l.habit_id === habitId && l.date === viewDate
            ? { ...l, completed: !l.completed, completedAt: !l.completed ? new Date().toISOString() : null, usedMinVersion: useMinVersion }
            : l
        )
      }));
      // Celebration when completing (not uncompleting)
      if (!wasCompleted) {
        showToast(`${habit?.icon || '‚úÖ'} ¬°${habit?.name || 'H√°bito'} completado!`, 'celebration');
      }
    } else {
      setData(prev => ({
        ...prev,
        habitLogs: [...(prev.habitLogs || []), {
          id: generateId(),
          habit_id: habitId,
          date: viewDate,
          completed: true,
          completedAt: new Date().toISOString(),
          usedMinVersion: useMinVersion
        }]
      }));
      // Celebration for new completion
      showToast(`${habit?.icon || '‚úÖ'} ¬°${habit?.name || 'H√°bito'} completado!`, 'celebration');
    }
  };

  const toggleTask = (taskId) => {
    setData(prev => ({
      ...prev,
      tasks: prev.tasks.map(t => t.id === taskId ? { ...t, completed: !t.completed } : t)
    }));
  };

  const updateWater = (glasses) => {
    updateDay({ water_glasses: glasses });
  };

  const saveJournal = () => {
    const entry = {
      id: dayJournal?.id || generateId(),
      date: viewDate,
      ...journalData
    };
    setData(prev => ({
      ...prev,
      journals: dayJournal
        ? prev.journals.map(j => j.id === entry.id ? entry : j)
        : [...(prev.journals || []), entry]
    }));
    setShowJournal(false);
    showToast('Diario guardado');
  };

  // Workout info
  const workoutProgress = dayWorkout?.exercises?.reduce((acc, ex) => {
    const completed = ex.sets.filter(s => s.completed).length;
    const total = ex.sets.length;
    return { completed: acc.completed + completed, total: acc.total + total };
  }, { completed: 0, total: 0 }) || { completed: 0, total: 0 };

  const nextExercise = dayWorkout?.exercises?.find(ex =>
    ex.sets.some(s => !s.completed)
  );

  // ========================================================================
  // TIER 3: CORRELATION ENGINE - Cross-Area Insights
  // ========================================================================
  const getCorrelations = useMemo(() => {
    const correlations = [];
    const last14Days = Array.from({ length: 14 }, (_, i) => getDateOffset(getToday(), -i));

    // Helper: Get average for a metric over days
    const getAverageForDays = (days, getter) => {
      const values = days.map(d => getter(d)).filter(v => v !== null && v !== undefined && !isNaN(v));
      return values.length > 0 ? values.reduce((a, b) => a + b, 0) / values.length : null;
    };

    // 3.1 SLEEP ‚Üí ENERGY correlation
    const todaySleep = dayData?.sleep_hours;
    const todayEnergy = dayData?.energy_level;
    if (todaySleep && todayEnergy !== undefined) {
      const avgEnergy = getAverageForDays(last14Days, d => data.days[d]?.energy_level);
      const avgSleep = getAverageForDays(last14Days, d => data.days[d]?.sleep_hours);

      if (avgEnergy && avgSleep) {
        if (todaySleep >= 7 && todayEnergy > avgEnergy) {
          correlations.push({
            id: 'sleep-energy-good',
            icon: 'üò¥‚Üí‚ö°',
            text: `Dormiste ${todaySleep}h ‚Üí Tu energ√≠a es ${Math.round((todayEnergy / avgEnergy - 1) * 100)}% mayor que tu media`,
            type: 'success',
            area: 'sleep'
          });
        } else if (todaySleep < 6 && avgSleep >= 7) {
          correlations.push({
            id: 'sleep-energy-bad',
            icon: '‚ö†Ô∏èüí§',
            text: `Solo ${todaySleep}h de sue√±o (tu media es ${avgSleep.toFixed(1)}h). Espera menos energ√≠a hoy`,
            type: 'warning',
            area: 'sleep'
          });
        }
      }
    }

    // 3.2 HABITS ‚Üí Score/Momentum
    if (dayHabitLogs.length > 0 && data.habits.length > 0) {
      const last7Completion = last14Days.slice(0, 7).map(d => {
        const dayLogs = data.habitLogs?.filter(l => l.date === d && l.completed) || [];
        return data.habits.length > 0 ? dayLogs.length / data.habits.length : 0;
      });
      const weeklyAvg = last7Completion.reduce((a, b) => a + b, 0) / 7;
      const todayRate = dayHabitLogs.filter(h => h.completed).length / data.habits.length;

      if (weeklyAvg >= 0.8) {
        correlations.push({
          id: 'habits-streak',
          icon: 'üî•',
          text: `¬°${Math.round(weeklyAvg * 100)}% esta semana! Tu consistencia impulsa resultados`,
          type: 'success',
          area: 'habits'
        });
      } else if (todayRate > weeklyAvg + 0.2 && todayRate >= 0.5) {
        correlations.push({
          id: 'habits-improving',
          icon: 'üìà',
          text: `Hoy llevas ${Math.round(todayRate * 100)}% vs ${Math.round(weeklyAvg * 100)}% de media. ¬°Sigue as√≠!`,
          type: 'success',
          area: 'habits'
        });
      }
    }

    // 3.3 CALORIES ‚Üí Weight trend
    const bodyMetrics = data.bodyMetrics || [];
    if (dayMeals.length > 0 && bodyMetrics.length >= 2 && data.user.goals?.calories) {
      const totalCals = dayMeals.reduce((s, m) => s + (m.calories || 0), 0);
      const calGoal = data.user.goals.calories;
      const sortedMetrics = [...bodyMetrics].sort((a, b) => a.date.localeCompare(b.date));
      const recentWeight = sortedMetrics[sortedMetrics.length - 1];
      const olderWeight = sortedMetrics[sortedMetrics.length - 2];

      if (recentWeight && olderWeight) {
        const weightChange = recentWeight.weight - olderWeight.weight;
        const daysBetween = Math.max(1, Math.abs((new Date(recentWeight.date) - new Date(olderWeight.date)) / (1000 * 60 * 60 * 24)));

        if (totalCals < calGoal * 0.85 && weightChange < 0) {
          correlations.push({
            id: 'cal-weight-deficit',
            icon: 'üìâ',
            text: `D√©ficit cal√≥rico (${totalCals}/${calGoal}) ‚Üí ${Math.abs(weightChange).toFixed(1)}kg perdidos en ${Math.round(daysBetween)} d√≠as`,
            type: 'info',
            area: 'nutrition'
          });
        } else if (totalCals > calGoal * 1.15 && weightChange > 0) {
          correlations.push({
            id: 'cal-weight-surplus',
            icon: 'üìä',
            text: `Super√°vit cal√≥rico ‚Üí +${weightChange.toFixed(1)}kg en ${Math.round(daysBetween)} d√≠as`,
            type: 'warning',
            area: 'nutrition'
          });
        }
      }
    }

    // 3.4 MEDITATION/CONSCIOUSNESS ‚Üí Sleep quality
    const yesterdayDate = getDateOffset(viewDate, -1);
    const yesterdayData = data.days[yesterdayDate];
    if (yesterdayData?.meditation_done && todaySleep) {
      const avgSleep = getAverageForDays(last14Days, d => data.days[d]?.sleep_hours);
      if (avgSleep && todaySleep > avgSleep) {
        correlations.push({
          id: 'meditation-sleep',
          icon: 'üßò‚Üíüò¥',
          text: `Meditaste ayer ‚Üí ${todaySleep}h de sue√±o (+${(todaySleep - avgSleep).toFixed(1)}h vs tu media)`,
          type: 'success',
          area: 'consciousness'
        });
      }
    }

    // 3.5 WORKOUT ‚Üí Next day energy
    const yesterdayWorkout = data.workouts?.find(w => w.day_id === yesterdayDate && w.is_completed);
    if (yesterdayWorkout && todayEnergy) {
      const avgEnergy = getAverageForDays(last14Days, d => data.days[d]?.energy_level);
      if (avgEnergy && todayEnergy >= avgEnergy) {
        correlations.push({
          id: 'workout-energy',
          icon: 'üí™‚Üí‚ö°',
          text: `Entrenaste ayer ‚Üí Energ√≠a ${todayEnergy > avgEnergy ? 'por encima de' : 'igual a'} tu media`,
          type: 'success',
          area: 'workout'
        });
      }
    }

    // 3.6 RELATIONSHIPS ‚Üí Mood (social health)
    const relationships = data.relationships || [];
    const recentInteractions = relationships.reduce((count, rel) => {
      const recent = (rel.interactions || []).filter(i => {
        const daysDiff = (new Date(getToday()) - new Date(i.date)) / (1000 * 60 * 60 * 24);
        return daysDiff <= 7;
      });
      return count + recent.length;
    }, 0);

    if (recentInteractions >= 5 && todayEnergy && todayEnergy >= 3) {
      correlations.push({
        id: 'relationships-mood',
        icon: 'üë•‚Üíüòä',
        text: `${recentInteractions} interacciones esta semana ‚Üí Bienestar social alto`,
        type: 'success',
        area: 'relationships'
      });
    } else if (recentInteractions === 0 && relationships.length > 0) {
      const needsAttention = relationships.filter(r => r.contactFrequency && r.interactions?.length === 0).length;
      if (needsAttention > 0) {
        correlations.push({
          id: 'relationships-neglected',
          icon: 'üë•‚ö†Ô∏è',
          text: `${needsAttention} relaciones sin contacto reciente. ¬øTiempo para conectar?`,
          type: 'warning',
          area: 'relationships'
        });
      }
    }

    return correlations;
  }, [data, dayData, dayMeals, dayHabitLogs, viewDate]);

  // Legacy getInsight for compatibility (now uses correlations)
  const getInsight = () => {
    if (getCorrelations.length > 0) {
      return getCorrelations[0]; // Return first correlation as primary insight
    }
    // Fallback to old logic
    if (dayData.sleep_hours >= 7 && habitsCompleted >= data.habits.length * 0.8) {
      return { text: "Gran d√≠a! Buen descanso + h√°bitos = √©xito asegurado üöÄ", type: "success" };
    }
    if (dayData.sleep_hours < 6 && dayData.sleep_hours > 0) {
      return { text: `Solo ${dayData.sleep_hours}h de sue√±o. Prioriza descansar hoy üò¥`, type: "warning" };
    }
    if (tasksCompleted === dayTasks.length && dayTasks.length > 0) {
      return { text: "¬°Todas las tareas completadas! Eres imparable üî•", type: "success" };
    }
    return null;
  };

  const insight = getInsight();

  return (
    <div className="space-y-4 pb-24">
      {/* Header with date navigation */}
      <AnimatedMount>
        <div className="flex items-center justify-between mb-2">
          <button
            onClick={goToPrevDay}
            className="p-2 hover:bg-white/10 rounded-lg transition-colors"
          >
            <ChevronLeft className="w-5 h-5" />
          </button>

          <div className="flex flex-col items-center">
            {/* Toggle D√≠a/Semana/Mes/Trimestre */}
            <div className="flex bg-white/10 rounded-lg p-0.5 mb-1">
              <button
                onClick={() => setViewMode('day')}
                className={`px-2.5 py-1 rounded-md text-xs font-medium transition-all ${viewMode === 'day' ? 'bg-violet-500 text-white' : 'text-white/60'}`}
              >
                D√≠a
              </button>
              <button
                onClick={() => setViewMode('week')}
                className={`px-2.5 py-1 rounded-md text-xs font-medium transition-all ${viewMode === 'week' ? 'bg-violet-500 text-white' : 'text-white/60'}`}
              >
                Sem
              </button>
            </div>
            <button
              onClick={goToToday}
              className="flex flex-col items-center"
            >
              <span className={`text-sm font-medium ${isViewingToday ? 'text-violet-400' : 'text-white/60'}`}>
                {formatViewDate()}
              </span>
              {!isViewingToday && (
                <span className="text-[10px] text-violet-400 mt-0.5">Volver a hoy</span>
              )}
            </button>
          </div>

          <button
            onClick={goToNextDay}
            className="p-2 hover:bg-white/10 rounded-lg transition-colors"
          >
            <ChevronRight className="w-5 h-5" />
          </button>
        </div>

        {/* Future date indicator */}
        {isViewingFuture && (
          <div className="bg-amber-500/20 border border-amber-500/30 rounded-xl p-3 mb-3 flex items-center gap-2">
            <Calendar className="w-4 h-4 text-amber-400" />
            <p className="text-sm text-amber-200">Est√°s viendo un d√≠a futuro - planificaci√≥n</p>
          </div>
        )}

        {/* Planned meals for this date */}
        {plannedMealsForDate.length > 0 && (
          <div className="bg-orange-500/10 border border-orange-500/30 rounded-xl p-3 mb-3">
            <p className="text-sm font-medium text-orange-400 mb-2">üçΩÔ∏è Comidas planificadas</p>
            <div className="space-y-1">
              {plannedMealsForDate.map(meal => (
                <div key={meal.id} className="flex justify-between text-sm">
                  <span className="text-white/70">{meal.name}</span>
                  <span className="text-orange-400">{meal.calories} kcal</span>
                </div>
              ))}
            </div>
          </div>
        )}

        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-bold">
              {isViewingToday ? `${greeting.icon} ${greeting.text}` : 'üìÖ'}, {data.user.name.split(' ')[0]}
            </h1>
            {data.user.mantra && isViewingToday && (
              <p className="text-white/40 text-sm italic mt-1">"{data.user.mantra}"</p>
            )}
          </div>
          <div className="flex items-center gap-3">
            <DayScore score={dayScore} size="md" />
          </div>
        </div>
      </AnimatedMount>

      {/* Conditional: Week View */}
      {viewMode === 'week' ? (
        <>
          {/* Week Days Row - Interactive Calendar */}
          <AnimatedMount delay={50}>
            <div className="flex gap-1.5">
              {weekDates.map((date, i) => {
                const isCurrentDay = date === getToday();
                const isPastDay = date < getToday();
                const isSelected = date === viewDate;
                const dayInfo = data.days[date];
                const dayHabitsData = data.habitLogs?.filter(l => l.date === date) || [];
                const dayMealsData = data.meals.filter(m => m.day_id === date);
                const dayTasksData = data.tasks.filter(t => t.day_id === date);
                const dayWorkoutData = data.workouts.find(w => w.day_id === date);
                const score = calculateDayScore(dayInfo, dayHabitsData, dayMealsData, dayTasksData, dayWorkoutData, data.user.goals);

                const hasWorkout = !!dayWorkoutData;
                const workoutDone = dayWorkoutData?.is_completed;
                const habitsCount = dayHabitsData.filter(l => l.completed).length;
                const totalHabits = data.habits.filter(h => {
                  if (h.frequency === 'weekly') return i === 0;
                  if (h.frequency === 'weekdays') return i < 5;
                  return true;
                }).length;

                return (
                  <button
                    key={date}
                    onClick={() => { setViewDate(date); setViewMode('day'); }}
                    className={`flex-1 py-2 px-1 rounded-xl text-center transition-all relative overflow-hidden ${isCurrentDay ? 'bg-violet-500 ring-2 ring-violet-400 ring-offset-1 ring-offset-zinc-900' :
                      isSelected ? 'bg-white/20' :
                        'bg-white/5 hover:bg-white/10'
                      }`}
                  >
                    <p className={`text-[10px] font-medium mb-0.5 ${isCurrentDay ? 'text-white' : 'text-white/50'}`}>
                      {weekDayNames[i]}
                    </p>
                    <p className={`text-lg font-bold ${isCurrentDay ? 'text-white' : ''}`}>
                      {new Date(date).getDate()}
                    </p>

                    {/* Score indicator */}
                    {(isPastDay || isCurrentDay) && score > 0 && (
                      <div className="flex justify-center gap-0.5 mt-1">
                        <div className={`w-1.5 h-1.5 rounded-full ${score >= 70 ? 'bg-emerald-400' : score >= 40 ? 'bg-amber-400' : 'bg-red-400'}`} />
                      </div>
                    )}

                    {/* Mini indicators */}
                    <div className="flex justify-center gap-1 mt-1">
                      {hasWorkout && (
                        <div className={`w-1 h-1 rounded-full ${workoutDone ? 'bg-violet-400' : 'bg-white/30'}`} />
                      )}
                      {totalHabits > 0 && (
                        <div className={`w-1 h-1 rounded-full ${habitsCount >= totalHabits ? 'bg-emerald-400' : habitsCount > 0 ? 'bg-amber-400' : 'bg-white/20'}`} />
                      )}
                    </div>
                  </button>
                );
              })}
            </div>
          </AnimatedMount>

          {/* Week Score Card */}
          <AnimatedMount delay={75}>
            {(() => {
              const weekStats = weekDates.map(date => {
                const isPastOrToday = date <= getToday();
                const dayInfo = data.days[date];
                const dayHabitsData = data.habitLogs?.filter(l => l.date === date) || [];
                const dayMealsData = data.meals.filter(m => m.day_id === date);
                const dayTasksData = data.tasks.filter(t => t.day_id === date);
                const dayWorkoutData = data.workouts.find(w => w.day_id === date);
                return {
                  date,
                  isPastOrToday,
                  score: isPastOrToday ? calculateDayScore(dayInfo, dayHabitsData, dayMealsData, dayTasksData, dayWorkoutData, data.user.goals) : 0,
                  workout: dayWorkoutData,
                  workoutCompleted: dayWorkoutData?.is_completed,
                  habits: dayHabitsData.filter(l => l.completed).length,
                  habitsTotal: data.habits.length,
                  tasks: dayTasksData.filter(t => t.completed).length,
                  tasksTotal: dayTasksData.length,
                  calories: dayMealsData.reduce((s, m) => s + (m.calories || 0), 0),
                  protein: dayMealsData.reduce((s, m) => s + (m.protein || 0), 0),
                  water: dayInfo?.water_glasses || 0,
                  sleep: dayInfo?.sleep_hours || 0
                };
              });

              const pastDays = weekStats.filter(d => d.isPastOrToday);
              const avgScore = pastDays.length > 0 ? Math.round(pastDays.reduce((s, d) => s + d.score, 0) / pastDays.length) : 0;
              const weekWorkouts = weekStats.filter(d => d.workoutCompleted).length;
              const plannedWorkouts = weekStats.filter(d => d.workout).length;
              const weekHabitsCompleted = weekStats.reduce((s, d) => s + d.habits, 0);
              const weekHabitsTotal = data.habits.length * pastDays.length;
              const weekTasksCompleted = weekStats.reduce((s, d) => s + d.tasks, 0);
              const weekTasksTotal = weekStats.reduce((s, d) => s + d.tasksTotal, 0);
              const avgCalories = pastDays.length > 0 ? Math.round(pastDays.reduce((s, d) => s + d.calories, 0) / pastDays.length) : 0;
              const avgProtein = pastDays.length > 0 ? Math.round(pastDays.reduce((s, d) => s + d.protein, 0) / pastDays.length) : 0;
              const avgSleep = pastDays.length > 0 ? (pastDays.reduce((s, d) => s + d.sleep, 0) / pastDays.length).toFixed(1) : 0;
              const avgWater = pastDays.length > 0 ? Math.round(pastDays.reduce((s, d) => s + d.water, 0) / pastDays.length) : 0;

              const habitsPercent = weekHabitsTotal > 0 ? Math.round((weekHabitsCompleted / weekHabitsTotal) * 100) : 0;
              const calorieGoal = data.user.goals?.calories || 2000;
              const proteinGoal = data.user.goals?.protein || 150;
              const waterGoal = data.user.goals?.water || 8;

              // Week info
              const weekStart = new Date(weekDates[0]);
              const weekEnd = new Date(weekDates[6]);
              const weekNumber = Math.ceil((((weekStart - new Date(weekStart.getFullYear(), 0, 1)) / 86400000) + new Date(weekStart.getFullYear(), 0, 1).getDay() + 1) / 7);
              const totalWeeksInYear = 52;

              // Previous week calculation for comparison
              const prevWeekStart = new Date(weekStart);
              prevWeekStart.setDate(prevWeekStart.getDate() - 7);
              const prevWeekDates = Array.from({ length: 7 }, (_, i) => {
                const d = new Date(prevWeekStart);
                d.setDate(d.getDate() + i);
                return d.toISOString().split('T')[0];
              });

              const prevWeekStats = prevWeekDates.map(date => {
                const dayInfo = data.days[date];
                const dayHabitsData = data.habitLogs?.filter(l => l.date === date) || [];
                const dayMealsData = data.meals.filter(m => m.day_id === date);
                const dayTasksData = data.tasks.filter(t => t.day_id === date);
                const dayWorkoutData = data.workouts.find(w => w.day_id === date);
                return calculateDayScore(dayInfo, dayHabitsData, dayMealsData, dayTasksData, dayWorkoutData, data.user.goals);
              });
              const prevWeekAvg = prevWeekStats.length > 0 ? Math.round(prevWeekStats.reduce((s, d) => s + d, 0) / 7) : 0;
              const weekDiff = avgScore - prevWeekAvg;

              // Year overview - calculate score for each week of the year
              const yearStart = new Date(new Date().getFullYear(), 0, 1);
              const currentWeekNum = weekNumber;
              const weekScores = [];

              for (let w = 1; w <= currentWeekNum; w++) {
                const wStart = new Date(yearStart);
                wStart.setDate(wStart.getDate() + (w - 1) * 7);
                let weekTotal = 0;
                let daysWithData = 0;

                for (let d = 0; d < 7; d++) {
                  const date = new Date(wStart);
                  date.setDate(date.getDate() + d);
                  const dateStr = date.toISOString().split('T')[0];

                  if (date <= new Date()) {
                    const dayInfo = data.days[dateStr];
                    const dayHabitsData = data.habitLogs?.filter(l => l.date === dateStr) || [];
                    const dayMealsData = data.meals.filter(m => m.day_id === dateStr);
                    const dayTasksData = data.tasks.filter(t => t.day_id === dateStr);
                    const dayWorkoutData = data.workouts.find(wk => wk.day_id === dateStr);
                    const score = calculateDayScore(dayInfo, dayHabitsData, dayMealsData, dayTasksData, dayWorkoutData, data.user.goals);
                    if (score > 0) {
                      weekTotal += score;
                      daysWithData++;
                    }
                  }
                }

                weekScores.push({
                  week: w,
                  score: daysWithData > 0 ? Math.round(weekTotal / daysWithData) : 0,
                  hasData: daysWithData > 0
                });
              }

              // Best and worst days
              const bestDay = pastDays.length > 0 ? pastDays.reduce((best, d) => d.score > best.score ? d : best, pastDays[0]) : null;
              const worstDay = pastDays.length > 0 ? pastDays.filter(d => d.score > 0).reduce((worst, d) => d.score < worst.score ? d : worst, pastDays[0]) : null;

              // Streak calculation
              let currentStreak = 0;
              for (let i = pastDays.length - 1; i >= 0; i--) {
                if (pastDays[i].score >= 50) currentStreak++;
                else break;
              }

              // Get color for score
              const getScoreColor = (score) => {
                if (score >= 80) return 'bg-emerald-500';
                if (score >= 60) return 'bg-lime-500';
                if (score >= 40) return 'bg-amber-500';
                if (score >= 20) return 'bg-orange-500';
                return 'bg-red-500';
              };

              return (
                <div className="space-y-3">
                  {/* Main Score Card with week range */}
                  <Card className="bg-gradient-to-br from-violet-500/20 via-purple-500/20 to-fuchsia-500/20 border-violet-500/30">
                    <div className="flex items-center gap-4">
                      <DayScore score={avgScore} size="lg" />
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-1">
                          <p className="text-lg font-bold">Semana {weekNumber}</p>
                          <span className="text-xs text-white/40">de {totalWeeksInYear} ¬∑ {new Date().getFullYear()}</span>
                        </div>
                        <p className="text-sm text-white/50">
                          {weekStart.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' })} - {weekEnd.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' })}
                        </p>
                        <div className="flex items-center gap-2 mt-1">
                          {weekDiff !== 0 && prevWeekAvg > 0 && (
                            <span className={`text-xs px-1.5 py-0.5 rounded ${weekDiff > 0 ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400'}`}>
                              {weekDiff > 0 ? '‚Üë' : '‚Üì'} {Math.abs(weekDiff)} vs anterior
                            </span>
                          )}
                          {currentStreak > 1 && (
                            <span className="text-xs text-violet-400">üî• {currentStreak} d√≠as buenos</span>
                          )}
                        </div>
                      </div>
                    </div>
                  </Card>

                  {/* Year Overview - Week dots with month labels, 4 months per row */}
                  <Card className="py-2 px-3">
                    <div className="flex items-center justify-between mb-1.5">
                      <span className="text-[11px] font-medium text-white/70">üìÖ {new Date().getFullYear()}</span>
                      <span className="text-[9px] text-white/30">Sem {currentWeekNum}/{totalWeeksInYear}</span>
                    </div>

                    {(() => {
                      const year = new Date().getFullYear();
                      const months = ['E', 'F', 'M', 'A', 'M', 'J', 'J', 'A', 'S', 'O', 'N', 'D'];
                      const today = new Date(getToday());
                      const currentMonthIndex = today.getMonth();

                      const getWeekColor = (score) => {
                        if (score >= 90) return 'bg-emerald-400';
                        if (score >= 80) return 'bg-emerald-500';
                        if (score >= 70) return 'bg-lime-400';
                        if (score >= 60) return 'bg-lime-500';
                        if (score >= 50) return 'bg-yellow-400';
                        if (score >= 40) return 'bg-amber-400';
                        if (score >= 30) return 'bg-amber-500';
                        if (score >= 20) return 'bg-orange-400';
                        if (score >= 10) return 'bg-orange-500';
                        return 'bg-red-500';
                      };

                      const weeksByMonth = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'].map((name, monthIndex) => {
                        const weeksInMonth = [];
                        for (let w = 1; w <= 52; w++) {
                          const jan1 = new Date(year, 0, 1);
                          const daysToFirstThursday = (4 - jan1.getDay() + 7) % 7;
                          const firstThursday = new Date(year, 0, 1 + daysToFirstThursday);
                          const thursday = new Date(firstThursday);
                          thursday.setDate(firstThursday.getDate() + (w - 1) * 7);
                          if (thursday.getMonth() === monthIndex) {
                            const ws = weekScores.find(s => s.week === w) || { week: w, score: 0, hasData: false };
                            weeksInMonth.push({ ...ws, isFuture: w > currentWeekNum });
                          }
                        }
                        return { name: months[monthIndex], monthIndex, weeks: weeksInMonth };
                      });

                      const rows = [weeksByMonth.slice(0, 4), weeksByMonth.slice(4, 8), weeksByMonth.slice(8, 12)];

                      return (
                        <div className="space-y-1.5">
                          {rows.map((row, ri) => (
                            <div key={ri} className="flex">
                              {row.map((month, mi) => (
                                <div key={mi} className="flex-1 flex items-center gap-1">
                                  <span className={`text-[9px] w-3 ${month.monthIndex === currentMonthIndex ? 'text-violet-400 font-bold' : 'text-white/40'}`}>{month.name}</span>
                                  <div className="flex" style={{ gap: '2px' }}>
                                    {month.weeks.map((ws, wi) => (
                                      <div
                                        key={wi}
                                        style={{
                                          width: '8px', height: '8px', borderRadius: '50%',
                                          backgroundColor: ws.isFuture ? '#6b7280' : !ws.hasData ? '#9ca3af' : undefined,
                                          boxShadow: ws.week === weekNumber ? '0 0 0 2px white' : undefined
                                        }}
                                        className={`${!ws.isFuture && ws.hasData ? getWeekColor(ws.score) : ''}`}
                                        title={`S${ws.week}: ${ws.score}pts`}
                                      />
                                    ))}
                                  </div>
                                </div>
                              ))}
                            </div>
                          ))}
                        </div>
                      );
                    })()}

                    <div className="flex items-center justify-between mt-1.5 pt-1.5 border-t border-white/10">
                      <div className="flex items-center gap-0.5 text-[8px] text-white/30">
                        <span>0</span>
                        <div className="w-2 h-2 rounded-full bg-red-500" />
                        <div className="w-2 h-2 rounded-full bg-orange-500" />
                        <div className="w-2 h-2 rounded-full bg-amber-500" />
                        <div className="w-2 h-2 rounded-full bg-lime-500" />
                        <div className="w-2 h-2 rounded-full bg-emerald-500" />
                        <span>100</span>
                      </div>
                      <div className="text-[9px] text-white/50">
                        {(() => {
                          const wd = weekScores.filter(w => w.hasData);
                          const perfect = wd.filter(w => w.score >= 80).length;
                          const good = wd.filter(w => w.score >= 60).length;
                          const avg = wd.length > 0 ? Math.round(wd.reduce((a, b) => a + b.score, 0) / wd.length) : 0;
                          return <><span className="text-emerald-400">{perfect}</span> üíé ¬∑ <span className="text-lime-400">{good}</span> ‚úì ¬∑ xÃÑ {avg}</>;
                        })()}
                      </div>
                    </div>
                  </Card>

                  {/* Weekly Progress Bars */}
                  <Card>
                    <div className="space-y-3">
                      {/* Habits */}
                      <div>
                        <div className="flex justify-between text-sm mb-1">
                          <span className="text-white/60 flex items-center gap-1">
                            <CheckSquare className="w-3.5 h-3.5 text-emerald-400" /> H√°bitos
                          </span>
                          <span className={habitsPercent >= 80 ? 'text-emerald-400' : habitsPercent >= 50 ? 'text-amber-400' : 'text-white/60'}>
                            {weekHabitsCompleted}/{weekHabitsTotal} ({habitsPercent}%)
                          </span>
                        </div>
                        <div className="h-2 bg-white/10 rounded-full overflow-hidden">
                          <div
                            className={`h-full rounded-full transition-all ${habitsPercent >= 80 ? 'bg-emerald-500' : habitsPercent >= 50 ? 'bg-amber-500' : 'bg-red-500'}`}
                            style={{ width: `${habitsPercent}%` }}
                          />
                        </div>
                      </div>

                      {/* Workouts */}
                      <div>
                        <div className="flex justify-between text-sm mb-1">
                          <span className="text-white/60 flex items-center gap-1">
                            <Dumbbell className="w-3.5 h-3.5 text-violet-400" /> Entrenos
                          </span>
                          <span className={weekWorkouts >= plannedWorkouts ? 'text-emerald-400' : 'text-white/60'}>
                            {weekWorkouts}/{plannedWorkouts || '-'} completados
                          </span>
                        </div>
                        <div className="h-2 bg-white/10 rounded-full overflow-hidden">
                          <div
                            className="h-full bg-violet-500 rounded-full transition-all"
                            style={{ width: plannedWorkouts > 0 ? `${(weekWorkouts / plannedWorkouts) * 100}%` : '0%' }}
                          />
                        </div>
                      </div>

                      {/* Nutrition */}
                      <div>
                        <div className="flex justify-between text-sm mb-1">
                          <span className="text-white/60 flex items-center gap-1">
                            <Utensils className="w-3.5 h-3.5 text-orange-400" /> Nutrici√≥n
                          </span>
                          <span className="text-white/60">
                            {avgCalories} kcal ¬∑ {avgProtein}g prot /d√≠a
                          </span>
                        </div>
                        <div className="flex gap-1">
                          <div className="flex-1 h-2 bg-white/10 rounded-full overflow-hidden">
                            <div
                              className={`h-full rounded-full transition-all ${avgCalories >= calorieGoal * 0.8 ? 'bg-orange-500' : 'bg-orange-500/50'}`}
                              style={{ width: `${Math.min((avgCalories / calorieGoal) * 100, 100)}%` }}
                            />
                          </div>
                          <div className="flex-1 h-2 bg-white/10 rounded-full overflow-hidden">
                            <div
                              className={`h-full rounded-full transition-all ${avgProtein >= proteinGoal * 0.8 ? 'bg-red-500' : 'bg-red-500/50'}`}
                              style={{ width: `${Math.min((avgProtein / proteinGoal) * 100, 100)}%` }}
                            />
                          </div>
                        </div>
                      </div>
                    </div>
                  </Card>

                  {/* Stats Grid - MEDIA SEMANAL */}
                  <Card>
                    <p className="text-xs text-white/40 mb-2 text-center">üìä MEDIA DIARIA DE LA SEMANA</p>
                    <div className="grid grid-cols-4 gap-2">
                      <div className="text-center py-2 bg-white/5 rounded-lg">
                        <Moon className="w-4 h-4 text-blue-400 mx-auto mb-1" />
                        <p className="text-lg font-bold">{avgSleep}</p>
                        <p className="text-[10px] text-white/40">h sue√±o</p>
                      </div>
                      <div className="text-center py-2 bg-white/5 rounded-lg">
                        <Droplets className="w-4 h-4 text-cyan-400 mx-auto mb-1" />
                        <p className="text-lg font-bold">{avgWater}</p>
                        <p className="text-[10px] text-white/40">vasos/d√≠a</p>
                      </div>
                      <div className="text-center py-2 bg-white/5 rounded-lg">
                        <Target className="w-4 h-4 text-blue-400 mx-auto mb-1" />
                        <p className="text-lg font-bold">{weekTasksCompleted}</p>
                        <p className="text-[10px] text-white/40">tareas</p>
                      </div>
                      <div className="text-center py-2 bg-white/5 rounded-lg">
                        <Flame className="w-4 h-4 text-orange-400 mx-auto mb-1" />
                        <p className="text-lg font-bold">{avgCalories}</p>
                        <p className="text-[10px] text-white/40">kcal/d√≠a</p>
                      </div>
                    </div>
                    {/* Comparison with previous week */}
                    {prevWeekAvg > 0 && (
                      <div className="mt-2 pt-2 border-t border-white/10 text-center">
                        <p className="text-xs text-white/40">
                          vs semana anterior: {' '}
                          <span className={weekDiff >= 0 ? 'text-emerald-400' : 'text-red-400'}>
                            {weekDiff >= 0 ? '+' : ''}{weekDiff} puntos
                          </span>
                          {weekDiff > 5 && ' üöÄ'}
                          {weekDiff < -5 && ' üìâ'}
                        </p>
                      </div>
                    )}
                  </Card>

                  {/* Day-by-Day Breakdown */}
                  <Card>
                    <p className="text-sm font-medium text-white/60 mb-3">üìä Detalle por d√≠a</p>
                    <div className="space-y-2">
                      {weekStats.map((day, i) => {
                        if (!day.isPastOrToday) return null;
                        const isCurrentDay = day.date === getToday();
                        return (
                          <button
                            key={day.date}
                            onClick={() => { setViewDate(day.date); setViewMode('day'); }}
                            className="w-full flex items-center gap-3 p-2 rounded-lg hover:bg-white/5 transition-colors"
                          >
                            <div className={`w-8 h-8 rounded-lg flex items-center justify-center text-xs font-bold ${isCurrentDay ? 'bg-violet-500' : 'bg-white/10'
                              }`}>
                              {weekDayNames[i]}
                            </div>

                            <div className="flex-1">
                              <div className="flex gap-1.5">
                                {/* Workout indicator */}
                                <div className={`px-1.5 py-0.5 rounded text-[10px] ${day.workoutCompleted ? 'bg-violet-500/30 text-violet-300' :
                                  day.workout ? 'bg-white/10 text-white/40' : 'hidden'
                                  }`}>
                                  {day.workoutCompleted ? 'üí™' : 'üèãÔ∏è'}
                                </div>

                                {/* Habits indicator */}
                                <div className={`px-1.5 py-0.5 rounded text-[10px] ${day.habits >= day.habitsTotal ? 'bg-emerald-500/30 text-emerald-300' :
                                  day.habits > 0 ? 'bg-amber-500/30 text-amber-300' : 'bg-white/10 text-white/40'
                                  }`}>
                                  {day.habits}/{day.habitsTotal}
                                </div>

                                {/* Nutrition indicator */}
                                {day.calories > 0 && (
                                  <div className="px-1.5 py-0.5 rounded text-[10px] bg-orange-500/30 text-orange-300">
                                    {day.calories} kcal
                                  </div>
                                )}
                              </div>
                            </div>

                            {/* Score */}
                            <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold ${day.score >= 70 ? 'bg-emerald-500/20 text-emerald-400' :
                              day.score >= 40 ? 'bg-amber-500/20 text-amber-400' :
                                day.score > 0 ? 'bg-red-500/20 text-red-400' : 'bg-white/10 text-white/40'
                              }`}>
                              {day.score}
                            </div>

                            <ChevronRight className="w-4 h-4 text-white/20" />
                          </button>
                        );
                      })}
                    </div>
                  </Card>

                  {/* Insights */}
                  {bestDay && worstDay && bestDay.date !== worstDay.date && (
                    <Card className="bg-gradient-to-r from-emerald-500/10 to-amber-500/10 border-white/10">
                      <p className="text-sm font-medium text-white/60 mb-2">üí° Insights</p>
                      <div className="space-y-2 text-sm">
                        <p className="text-emerald-400">
                          üèÜ Mejor d√≠a: {new Date(bestDay.date).toLocaleDateString('es-ES', { weekday: 'long' })} ({bestDay.score} pts)
                        </p>
                        {worstDay.score < bestDay.score && (
                          <p className="text-amber-400">
                            üìâ D√≠a m√°s flojo: {new Date(worstDay.date).toLocaleDateString('es-ES', { weekday: 'long' })} ({worstDay.score} pts)
                          </p>
                        )}
                        {avgSleep < 7 && (
                          <p className="text-blue-400">
                            üò¥ Promedio de sue√±o bajo ({avgSleep}h) - intenta llegar a 7-8h
                          </p>
                        )}
                        {habitsPercent < 70 && (
                          <p className="text-white/50">
                            üìã Consistencia de h√°bitos mejorable - enf√≥cate en los esenciales
                          </p>
                        )}
                      </div>
                    </Card>
                  )}
                </div>
              );
            })()}
          </AnimatedMount>
        </>
      ) : (
        <>
          {/* Focus of the day */}
          <AnimatedMount delay={50}>
            <Card
              onClick={() => isViewingToday && setShowFocus(true)}
              className="bg-gradient-to-r from-violet-500/10 to-fuchsia-500/10 border-violet-500/20"
            >
              <div className="flex items-start gap-3">
                <Target className="w-5 h-5 text-violet-400 mt-0.5" />
                <div className="flex-1">
                  <p className="text-xs text-violet-400 font-medium mb-1">FOCO DEL D√çA</p>
                  {dayData.focus_note ? (
                    <p className="text-white">{dayData.focus_note}</p>
                  ) : (
                    <p className="text-white/40 italic">
                      {isViewingToday ? 'Toca para definir tu prioridad...' : 'Sin foco definido'}
                    </p>
                  )}
                </div>
                {isViewingToday && <Edit3 className="w-4 h-4 text-white/30" />}
              </div>
            </Card>
          </AnimatedMount>

          {/* Status Grid: Sleep, Energy, Water, Weight */}
          <AnimatedMount delay={75}>
            <div className="grid grid-cols-4 gap-2">
              {/* Sleep */}
              <Card onClick={() => isViewingToday && setShowSleep(true)} className="text-center py-3">
                <Moon className="w-4 h-4 text-blue-400 mx-auto mb-1" />
                <p className="text-lg font-bold">{dayData.sleep_hours || '-'}</p>
                <p className="text-[10px] text-white/40">horas</p>
              </Card>

              {/* Energy */}
              <Card className="text-center py-3">
                <Zap className="w-4 h-4 text-yellow-400 mx-auto mb-1" />
                <div className="flex justify-center gap-0.5 mb-1">
                  {[1, 2, 3, 4, 5].map(i => (
                    <button
                      key={i}
                      onClick={() => isViewingToday && updateDay({ energy_level: i })}
                      className={`w-2 h-2 rounded-full transition-all ${i <= dayData.energy_level ? 'bg-yellow-400' : 'bg-white/20'}`}
                    />
                  ))}
                </div>
                <p className="text-[10px] text-white/40">energ√≠a</p>
              </Card>

              {/* Water */}
              <Card className="text-center py-3">
                <Droplets className="w-4 h-4 text-blue-400 mx-auto mb-1" />
                <p className="text-lg font-bold">{dayData.water_glasses || 0}</p>
                <p className="text-[10px] text-white/40">/{data.user.goals?.water || 8} üíß</p>
              </Card>

              {/* Steps */}
              <Card className="text-center py-3">
                <Footprints className="w-4 h-4 text-green-400 mx-auto mb-1" />
                <p className="text-lg font-bold">{((dayData.steps || 0) / 1000).toFixed(1)}k</p>
                <p className="text-[10px] text-white/40">/{(data.user.goals?.steps || 10000) / 1000}k üëü</p>
              </Card>
            </div>
          </AnimatedMount>

          {/* Water tracker inline */}
          {isViewingToday && (
            <AnimatedMount delay={85}>
              <Card className="py-3">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <Droplets className="w-4 h-4 text-blue-400" />
                    <span className="text-sm font-medium">Agua</span>
                  </div>
                  <div className="flex gap-1">
                    {Array.from({ length: data.user.goals?.water || 8 }, (_, i) => (
                      <button
                        key={i}
                        onClick={() => updateWater(i < (dayData.water_glasses || 0) ? i : i + 1)}
                        className={`w-5 h-7 rounded-sm transition-all ${i < (dayData.water_glasses || 0) ? 'bg-blue-500' : 'bg-white/10 hover:bg-white/20'}`}
                      />
                    ))}
                  </div>
                </div>
              </Card>
            </AnimatedMount>
          )}

          {/* Steps tracker inline */}
          {isViewingToday && (
            <AnimatedMount delay={87}>
              <Card className="py-3">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <Footprints className="w-4 h-4 text-green-400" />
                    <span className="text-sm font-medium">Pasos</span>
                    <span className="text-xs text-white/30 flex items-center gap-1">
                      <Watch className="w-3 h-3" />
                      <span>Auto</span>
                    </span>
                  </div>
                  <div className="flex items-center gap-2">
                    <button
                      onClick={() => updateDay({ steps: Math.max(0, (dayData.steps || 0) - 1000) })}
                      className="w-7 h-7 rounded-lg bg-white/10 flex items-center justify-center text-white/60 hover:bg-white/20"
                    >
                      -
                    </button>
                    <div className="text-center min-w-[60px]">
                      <p className="text-sm font-bold">{(dayData.steps || 0).toLocaleString()}</p>
                    </div>
                    <button
                      onClick={() => updateDay({ steps: (dayData.steps || 0) + 1000 })}
                      className="w-7 h-7 rounded-lg bg-white/10 flex items-center justify-center text-white/60 hover:bg-white/20"
                    >
                      +
                    </button>
                  </div>
                </div>
                <div className="mt-2">
                  <div className="h-1.5 bg-white/10 rounded-full overflow-hidden">
                    <div
                      className="h-full bg-green-500 rounded-full transition-all"
                      style={{ width: `${Math.min(100, ((dayData.steps || 0) / (data.user.goals?.steps || 10000)) * 100)}%` }}
                    />
                  </div>
                  <p className="text-[10px] text-white/30 mt-1 text-right">
                    {Math.round(((dayData.steps || 0) / (data.user.goals?.steps || 10000)) * 100)}% de {(data.user.goals?.steps || 10000).toLocaleString()}
                  </p>
                </div>
              </Card>
            </AnimatedMount>
          )}

          {/* Workout Section */}
          {activeAreas.includes('workout') && (
            <AnimatedMount delay={90}>
              <AccordionSection
                title="ENTRENO"
                icon={Dumbbell}
                iconColor="text-violet-400"
                action={() => setScreen('workout')}
                actionLabel="Ver todo"
                storageKey="workout"
                progress={(() => {
                  if (!dayWorkout) return null;
                  if (dayWorkout.is_completed) return 100;
                  return workoutProgress.total > 0 ? Math.round((workoutProgress.completed / workoutProgress.total) * 100) : 0;
                })()}
                progressColor="bg-violet-500"
                summaryRight={(() => {
                  if (!dayWorkout) return null;
                  if (dayWorkout.is_completed) return '‚úì';
                  return `${workoutProgress.completed}/${workoutProgress.total}`;
                })()}
                summary={(() => {
                  if (!dayWorkout) return 'Sin entreno programado';
                  if (dayWorkout.is_completed) return `‚úì ${dayWorkout.name} completado`;
                  if (workoutProgress.completed > 0) return `${dayWorkout.name} ¬∑ en progreso`;
                  return dayWorkout.name;
                })()}
              >
                <Card className="mt-2">
                  {dayWorkout?.is_completed ? (
                    <div>
                      <div className="flex items-center gap-3">
                        <div className="w-12 h-12 rounded-xl bg-emerald-500/20 flex items-center justify-center">
                          <Check className="w-6 h-6 text-emerald-400" />
                        </div>
                        <div className="flex-1">
                          <p className="font-medium text-emerald-400">¬°Entreno completado!</p>
                          <p className="text-sm text-white/50">{dayWorkout.name}</p>
                        </div>
                        <button
                          onClick={() => setShowWorkoutOptions(!showWorkoutOptions)}
                          className="p-1.5 hover:bg-white/10 rounded-lg"
                        >
                          <MoreHorizontal className="w-4 h-4 text-white/40" />
                        </button>
                      </div>

                      {/* Options dropdown */}
                      {showWorkoutOptions && (
                        <div className="mt-3 p-2 bg-white/5 rounded-xl space-y-1">
                          <button
                            onClick={() => {
                              setData(prev => ({
                                ...prev,
                                workouts: prev.workouts.map(w =>
                                  w.id === dayWorkout.id ? {
                                    ...w,
                                    is_completed: false,
                                    exercises: w.exercises.map(ex => ({
                                      ...ex,
                                      sets: ex.sets.map(s => ({ ...s, completed: false }))
                                    }))
                                  } : w
                                )
                              }));
                              setShowWorkoutOptions(false);
                              showToast('Entreno reiniciado');
                            }}
                            className="w-full flex items-center gap-2 px-3 py-2 text-sm text-white/60 hover:bg-white/10 rounded-lg"
                          >
                            <RotateCcw className="w-4 h-4" /> Reiniciar entreno
                          </button>
                          <button
                            onClick={() => {
                              setData(prev => ({
                                ...prev,
                                workouts: prev.workouts.filter(w => w.id !== dayWorkout.id)
                              }));
                              setShowWorkoutOptions(false);
                              showToast('Entreno eliminado');
                            }}
                            className="w-full flex items-center gap-2 px-3 py-2 text-sm text-red-400 hover:bg-red-500/10 rounded-lg"
                          >
                            <Trash2 className="w-4 h-4" /> Eliminar entreno
                          </button>
                          <button
                            onClick={() => {
                              setScreen('workout');
                              setShowWorkoutOptions(false);
                            }}
                            className="w-full flex items-center gap-2 px-3 py-2 text-sm text-white/60 hover:bg-white/10 rounded-lg"
                          >
                            <RefreshCw className="w-4 h-4" /> Cambiar por otro
                          </button>
                        </div>
                      )}
                    </div>
                  ) : dayWorkout ? (
                    <div>
                      {/* Header with options */}
                      <div className="flex items-center justify-between mb-3">
                        <span className="font-medium">{dayWorkout.name}</span>
                        <div className="flex items-center gap-2">
                          <span className="text-sm text-violet-400">{workoutProgress.completed}/{workoutProgress.total} sets</span>
                          <button
                            onClick={() => setShowWorkoutOptions(!showWorkoutOptions)}
                            className="p-1 hover:bg-white/10 rounded"
                          >
                            <MoreHorizontal className="w-4 h-4 text-white/40" />
                          </button>
                        </div>
                      </div>

                      {/* Workout options dropdown */}
                      {showWorkoutOptions && (
                        <div className="mb-3 p-2 bg-white/5 rounded-xl space-y-1">
                          <button
                            onClick={() => {
                              setData(prev => ({
                                ...prev,
                                workouts: prev.workouts.filter(w => w.id !== dayWorkout.id)
                              }));
                              setShowWorkoutOptions(false);
                              showToast('Entreno eliminado');
                            }}
                            className="w-full flex items-center gap-2 px-3 py-2 text-sm text-red-400 hover:bg-red-500/10 rounded-lg"
                          >
                            <Trash2 className="w-4 h-4" /> Eliminar entreno
                          </button>
                          <button
                            onClick={() => {
                              setScreen('workout');
                              setShowWorkoutOptions(false);
                            }}
                            className="w-full flex items-center gap-2 px-3 py-2 text-sm text-white/60 hover:bg-white/10 rounded-lg"
                          >
                            <RefreshCw className="w-4 h-4" /> Cambiar por otro
                          </button>
                        </div>
                      )}

                      <ProgressBar
                        value={workoutProgress.completed}
                        max={workoutProgress.total}
                        color="bg-violet-500"
                        height="h-2"
                      />

                      {/* Exercise List */}
                      <div className="mt-4 space-y-3">
                        {dayWorkout.exercises?.map((exercise, exIdx) => {
                          const completedSets = exercise.sets.filter(s => s.completed).length;
                          const allDone = completedSets === exercise.sets.length;
                          const nextSetIdx = exercise.sets.findIndex(s => !s.completed);

                          return (
                            <div
                              key={exercise.id || exIdx}
                              className={`p-3 rounded-xl ${allDone ? 'bg-emerald-500/10' : 'bg-white/5'}`}
                            >
                              <div className="flex items-center justify-between mb-2">
                                <div className="flex items-center gap-2">
                                  {allDone ? (
                                    <Check className="w-4 h-4 text-emerald-400" />
                                  ) : (
                                    <Dumbbell className="w-4 h-4 text-violet-400" />
                                  )}
                                  <span className={`font-medium text-sm ${allDone ? 'text-emerald-400' : ''}`}>
                                    {exercise.name}
                                  </span>
                                </div>
                                <span className="text-xs text-white/40">
                                  {completedSets}/{exercise.sets.length} sets
                                </span>
                              </div>

                              {/* Sets */}
                              <div className="flex flex-wrap gap-2">
                                {exercise.sets.map((set, setIdx) => {
                                  const isNext = setIdx === nextSetIdx && !allDone;
                                  const setKey = `${dayWorkout.id}-${exIdx}-${setIdx}`;
                                  const isEditing = editingSet === setKey;

                                  if (isEditing) {
                                    return (
                                      <div key={setIdx} className="flex items-center gap-1 bg-violet-500/20 rounded-lg p-1">
                                        <input
                                          type="number"
                                          defaultValue={set.weight}
                                          className="w-12 px-1.5 py-1 bg-white/10 rounded text-xs text-center"
                                          placeholder="kg"
                                          onKeyDown={(e) => {
                                            if (e.key === 'Enter') {
                                              const weight = parseFloat(e.target.value) || set.weight;
                                              const repsInput = e.target.nextElementSibling;
                                              const reps = parseInt(repsInput?.value) || set.reps;
                                              setData(prev => ({
                                                ...prev,
                                                workouts: prev.workouts.map(w =>
                                                  w.id === dayWorkout.id ? {
                                                    ...w,
                                                    exercises: w.exercises.map((ex, ei) =>
                                                      ei === exIdx ? {
                                                        ...ex,
                                                        sets: ex.sets.map((s, si) =>
                                                          si === setIdx ? { ...s, weight, reps, completed: true } : s
                                                        )
                                                      } : ex
                                                    )
                                                  } : w
                                                )
                                              }));
                                              setEditingSet(null);
                                            }
                                          }}
                                        />
                                        <span className="text-white/40 text-xs">√ó</span>
                                        <input
                                          type="number"
                                          defaultValue={set.reps}
                                          className="w-10 px-1.5 py-1 bg-white/10 rounded text-xs text-center"
                                          placeholder="reps"
                                          onKeyDown={(e) => {
                                            if (e.key === 'Enter') {
                                              const reps = parseInt(e.target.value) || set.reps;
                                              const weightInput = e.target.previousElementSibling?.previousElementSibling;
                                              const weight = parseFloat(weightInput?.value) || set.weight;
                                              setData(prev => ({
                                                ...prev,
                                                workouts: prev.workouts.map(w =>
                                                  w.id === dayWorkout.id ? {
                                                    ...w,
                                                    exercises: w.exercises.map((ex, ei) =>
                                                      ei === exIdx ? {
                                                        ...ex,
                                                        sets: ex.sets.map((s, si) =>
                                                          si === setIdx ? { ...s, weight, reps, completed: true } : s
                                                        )
                                                      } : ex
                                                    )
                                                  } : w
                                                )
                                              }));
                                              setEditingSet(null);
                                            }
                                          }}
                                        />
                                        <button
                                          onClick={() => {
                                            const inputs = document.querySelectorAll(`input`);
                                            let weight = set.weight, reps = set.reps;
                                            inputs.forEach((input, i) => {
                                              if (i % 2 === 0) weight = parseFloat(input.value) || weight;
                                              else reps = parseInt(input.value) || reps;
                                            });
                                            setData(prev => ({
                                              ...prev,
                                              workouts: prev.workouts.map(w =>
                                                w.id === dayWorkout.id ? {
                                                  ...w,
                                                  exercises: w.exercises.map((ex, ei) =>
                                                    ei === exIdx ? {
                                                      ...ex,
                                                      sets: ex.sets.map((s, si) =>
                                                        si === setIdx ? { ...s, weight, reps, completed: true } : s
                                                      )
                                                    } : ex
                                                  )
                                                } : w
                                              )
                                            }));
                                            setEditingSet(null);
                                          }}
                                          className="p-1 bg-emerald-500 rounded text-xs"
                                        >
                                          <Check className="w-3 h-3" />
                                        </button>
                                        <button
                                          onClick={() => setEditingSet(null)}
                                          className="p-1 bg-white/10 rounded text-xs"
                                        >
                                          <X className="w-3 h-3" />
                                        </button>
                                      </div>
                                    );
                                  }

                                  return (
                                    <button
                                      key={setIdx}
                                      onClick={() => {
                                        if (set.completed) {
                                          // If completed, toggle off
                                          setData(prev => ({
                                            ...prev,
                                            workouts: prev.workouts.map(w =>
                                              w.id === dayWorkout.id ? {
                                                ...w,
                                                exercises: w.exercises.map((ex, ei) =>
                                                  ei === exIdx ? {
                                                    ...ex,
                                                    sets: ex.sets.map((s, si) =>
                                                      si === setIdx ? { ...s, completed: false } : s
                                                    )
                                                  } : ex
                                                )
                                              } : w
                                            )
                                          }));
                                        } else {
                                          // If not completed, open editor
                                          setEditingSet(setKey);
                                        }
                                      }}
                                      className={`
                                    px-2.5 py-1.5 rounded-lg text-xs font-medium transition-all active:scale-95
                                    ${set.completed
                                          ? 'bg-emerald-500 text-white'
                                          : isNext
                                            ? 'bg-violet-500 text-white ring-2 ring-violet-400 ring-offset-1 ring-offset-zinc-900'
                                            : 'bg-white/10 text-white/60 hover:bg-white/20'
                                        }
                                  `}
                                    >
                                      {set.completed ? `‚úì ${set.weight}√ó${set.reps}` : `${set.weight}kg√ó${set.reps}`}
                                    </button>
                                  );
                                })}
                              </div>
                            </div>
                          );
                        })}
                      </div>

                      {/* Complete Workout Button */}
                      {workoutProgress.completed > 0 && workoutProgress.completed >= workoutProgress.total * 0.5 && (
                        <button
                          onClick={() => {
                            setData(prev => ({
                              ...prev,
                              workouts: prev.workouts.map(w =>
                                w.id === dayWorkout.id ? { ...w, is_completed: true } : w
                              )
                            }));
                            showToast('¬°Entreno completado! üí™');
                          }}
                          className="mt-4 w-full py-3 bg-gradient-to-r from-emerald-500 to-green-500 rounded-xl font-medium flex items-center justify-center gap-2"
                        >
                          <Trophy className="w-5 h-5" /> Completar entreno
                        </button>
                      )}

                      {/* Link to full workout screen */}
                      <button
                        onClick={() => setScreen('workout')}
                        className="mt-2 w-full py-2 text-violet-400 text-sm flex items-center justify-center gap-1 hover:bg-white/5 rounded-lg"
                      >
                        Ver detalles completos <ArrowRight className="w-4 h-4" />
                      </button>
                    </div>
                  ) : (
                    <div className="text-center py-4">
                      <p className="text-white/50 mb-4">Sin entreno programado para hoy</p>
                      <div className="flex gap-2 justify-center">
                        <button
                          onClick={() => {
                            // Create a quick demo workout
                            const demoWorkout = {
                              id: `workout-${Date.now()}`,
                              day_id: viewDate,
                              name: 'Push Day',
                              is_completed: false,
                              exercises: [
                                { id: 'ex1', name: 'Press banca', sets: [{ reps: 8, weight: 60, completed: false }, { reps: 8, weight: 60, completed: false }, { reps: 8, weight: 60, completed: false }] },
                                { id: 'ex2', name: 'Press inclinado', sets: [{ reps: 8, weight: 50, completed: false }, { reps: 8, weight: 50, completed: false }, { reps: 8, weight: 50, completed: false }] },
                                { id: 'ex3', name: 'Aperturas', sets: [{ reps: 8, weight: 14, completed: false }, { reps: 8, weight: 14, completed: false }, { reps: 8, weight: 14, completed: false }] },
                                { id: 'ex4', name: 'Press militar', sets: [{ reps: 8, weight: 40, completed: false }, { reps: 8, weight: 40, completed: false }, { reps: 8, weight: 40, completed: false }] }
                              ]
                            };
                            setData(prev => ({
                              ...prev,
                              workouts: [...prev.workouts, demoWorkout]
                            }));
                            showToast('Entreno a√±adido');
                          }}
                          className="px-4 py-2.5 bg-violet-500 rounded-xl font-medium inline-flex items-center gap-2"
                        >
                          <Plus className="w-4 h-4" />
                          A√±adir Push Day
                        </button>
                        <button
                          onClick={() => setScreen('workout')}
                          className="px-4 py-2.5 bg-white/10 rounded-xl font-medium inline-flex items-center gap-2 hover:bg-white/20"
                        >
                          <Dumbbell className="w-4 h-4" />
                          Ver plantillas
                        </button>
                      </div>
                    </div>
                  )}
                </Card>
              </AccordionSection>
            </AnimatedMount>
          )}

          {/* Consciousness Section */}
          {/* Nutrition Section */}
          {activeAreas.includes('nutrition') && (
            <AnimatedMount delay={100}>
              <AccordionSection
                title="NUTRICI√ìN"
                icon={Utensils}
                iconColor="text-orange-400"
                action={() => setScreen('meals')}
                actionLabel="Ver todo"
                storageKey="nutrition"
                progress={Math.round((totalCals / (data.user.goals?.calories || 2000)) * 100)}
                progressColor="bg-orange-500"
                summaryRight={`${totalCals}/${data.user.goals?.calories || 2000}`}
                summary={(() => {
                  const protPct = Math.round((totalProt / (data.user.goals?.protein || 120)) * 100);
                  return `${protPct}% prote√≠na ¬∑ ${dayMeals.length} comida${dayMeals.length !== 1 ? 's' : ''}`;
                })()}
              >
                <Card className="mt-3">
                  {/* Planned meals pending confirmation */}
                  {plannedMealsForDate.length > 0 && (
                    <div className="mb-4 pb-4 border-b border-white/10">
                      <p className="text-xs text-amber-400 mb-2 flex items-center gap-1">
                        <Calendar className="w-3 h-3" /> PLANIFICADAS PARA HOY
                      </p>
                      <div className="space-y-2">
                        {plannedMealsForDate.map(meal => (
                          <div key={meal.id} className="flex items-center gap-2 p-2 bg-amber-500/10 rounded-lg">
                            <div className="flex-1">
                              <p className="text-sm font-medium">{meal.name}</p>
                              <p className="text-xs text-white/40">{meal.calories} kcal</p>
                            </div>
                            <button
                              onClick={() => deletePlannedMeal(meal.id)}
                              className="p-1.5 hover:bg-white/10 rounded-lg"
                            >
                              <X className="w-3 h-3 text-white/40" />
                            </button>
                            <button
                              onClick={() => confirmPlannedMeal(meal)}
                              className="px-3 py-1.5 bg-emerald-500 rounded-lg text-xs font-medium"
                            >
                              ‚úì
                            </button>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {dayMeals.length > 0 ? (
                    <div className="space-y-3">
                      {/* Calories */}
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                          <Flame className="w-4 h-4 text-orange-400" />
                          <span className="text-2xl font-bold">{totalCals}</span>
                          <span className="text-white/40 text-sm">/ {data.user.goals.calories} kcal</span>
                        </div>
                        <span className="text-sm text-white/60">{Math.round((totalCals / data.user.goals.calories) * 100)}%</span>
                      </div>
                      <ProgressBar value={totalCals} max={data.user.goals.calories} color="bg-orange-500" />

                      {/* Macros */}
                      <div className="grid grid-cols-3 gap-3 pt-2">
                        <div>
                          <div className="flex justify-between text-xs mb-1">
                            <span className="text-emerald-400">Prot</span>
                            <span>{totalProt}/{data.user.goals.protein}g</span>
                          </div>
                          <ProgressBar value={totalProt} max={data.user.goals.protein} color="bg-emerald-500" height="h-1.5" />
                        </div>
                        <div>
                          <div className="flex justify-between text-xs mb-1">
                            <span className="text-blue-400">Carbs</span>
                            <span>{totalCarbs}/{data.user.goals.carbs}g</span>
                          </div>
                          <ProgressBar value={totalCarbs} max={data.user.goals.carbs} color="bg-blue-500" height="h-1.5" />
                        </div>
                        <div>
                          <div className="flex justify-between text-xs mb-1">
                            <span className="text-amber-400">Grasas</span>
                            <span>{totalFats}/{data.user.goals.fats}g</span>
                          </div>
                          <ProgressBar value={totalFats} max={data.user.goals.fats} color="bg-amber-500" height="h-1.5" />
                        </div>
                      </div>

                      {/* Meal status with add buttons */}
                      <div className="flex gap-2 pt-2">
                        {visibleMealTypes.map(meal => {
                          const hasMeal = dayMeals.some(m => m.meal_type === meal.type || (meal.type === 'all'));
                          const mealCals = meal.type === 'all'
                            ? totalCals
                            : dayMeals.filter(m => m.meal_type === meal.type).reduce((s, m) => s + (m.calories || 0), 0);
                          return (
                            <button
                              key={meal.type}
                              onClick={() => { setSelectedMealType(meal.type); setShowAddMeal(true); }}
                              className={`flex-1 text-center py-2 rounded-lg transition-all ${hasMeal && mealCals > 0 ? 'bg-emerald-500/20' : 'bg-white/5 hover:bg-white/10'}`}
                            >
                              <span className="text-lg">{meal.emoji}</span>
                              <p className={`text-[10px] ${hasMeal && mealCals > 0 ? 'text-emerald-400' : 'text-white/40'}`}>
                                {mealCals > 0 ? `${mealCals}` : '+'}
                              </p>
                            </button>
                          );
                        })}
                      </div>
                    </div>
                  ) : (
                    <div className="text-center py-4">
                      <p className="text-white/40 mb-3">Sin comidas registradas</p>
                      <button
                        onClick={() => setShowAddMeal(true)}
                        className="px-4 py-2 bg-orange-500/20 text-orange-400 rounded-xl flex items-center gap-2 mx-auto hover:bg-orange-500/30"
                      >
                        <Plus className="w-4 h-4" /> A√±adir comida
                      </button>
                    </div>
                  )}
                </Card>
              </AccordionSection>
            </AnimatedMount>
          )}

          {/* Habits Section - Elite Design */}
          {activeAreas.includes('habits') && (
            <AnimatedMount delay={125}>
              <AccordionSection
                title="H√ÅBITOS"
                icon={CheckSquare}
                iconColor="text-emerald-400"
                action={() => setScreen('habits')}
                actionLabel="Ver todo"
                storageKey="habits"
                progress={todayHabits.length > 0 ? Math.round((habitsCompleted / todayHabits.length) * 100) : 0}
                progressColor="bg-emerald-500"
                urgent={(() => {
                  // Urgent if any habit missed yesterday and not done today
                  return data.habits.some(h => getMissedYesterday(h.id) && !dayHabitLogs.find(l => l.habit_id === h.id)?.completed);
                })()}
                summaryRight={`${habitsCompleted}/${todayHabits.length}`}
                summary={(() => {
                  const bestStreak = Math.max(...data.habits.map(h => getStreakWithFreeze(h.id).current), 0);
                  const missedCount = data.habits.filter(h => getMissedYesterday(h.id) && !dayHabitLogs.find(l => l.habit_id === h.id)?.completed).length;
                  if (missedCount > 0) return `‚ö†Ô∏è ${missedCount} sin hacer ayer`;
                  return `${bestStreak}üî• mejor racha`;
                })()}
              >
                {/* Global Summary Card */}
                {data.habits.length > 0 && (
                  <Card className="bg-gradient-to-r from-emerald-500/10 to-violet-500/10 border-emerald-500/20 mb-3">
                    <div className="flex items-center gap-4">
                      {/* Progress Ring */}
                      <div className="relative w-16 h-16 flex-shrink-0">
                        <svg className="w-16 h-16 -rotate-90">
                          <circle cx="32" cy="32" r="28" fill="none" stroke="rgba(255,255,255,0.1)" strokeWidth="6" />
                          <circle
                            cx="32" cy="32" r="28" fill="none"
                            stroke="url(#habitGradient)"
                            strokeWidth="6"
                            strokeLinecap="round"
                            strokeDasharray={`${todayHabits.length > 0 ? (habitsCompleted / todayHabits.length) * 176 : 0} 176`}
                          />
                          <defs>
                            <linearGradient id="habitGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                              <stop offset="0%" stopColor="#10b981" />
                              <stop offset="100%" stopColor="#8b5cf6" />
                            </linearGradient>
                          </defs>
                        </svg>
                        <div className="absolute inset-0 flex items-center justify-center">
                          <span className="text-lg font-bold">{todayHabits.length > 0 ? Math.round((habitsCompleted / todayHabits.length) * 100) : 0}%</span>
                        </div>
                      </div>

                      {/* Stats */}
                      <div className="flex-1 grid grid-cols-2 gap-2">
                        <div>
                          <p className="text-[10px] text-white/40">Hoy</p>
                          <p className="text-lg font-bold">{habitsCompleted}<span className="text-white/40 text-sm">/{todayHabits.length}</span></p>
                        </div>
                        <div>
                          <p className="text-[10px] text-white/40">Mejor racha</p>
                          <p className="text-lg font-bold text-orange-400">
                            {Math.max(...data.habits.map(h => getStreakWithFreeze(h.id).current), 0)}üî•
                          </p>
                        </div>
                        <div>
                          <p className="text-[10px] text-white/40">Consistencia 30d</p>
                          <p className="text-sm font-medium text-emerald-400">
                            {(() => {
                              const last30 = Array.from({ length: 30 }, (_, i) => getDateOffset(today, -i));
                              let total = 0, completed = 0;
                              last30.forEach(date => {
                                data.habits.forEach(h => {
                                  if (shouldDoHabitOnDay(h, date)) {
                                    total++;
                                    if (data.habitLogs?.find(l => l.habit_id === h.id && l.date === date && l.completed)) completed++;
                                  }
                                });
                              });
                              return total > 0 ? Math.round((completed / total) * 100) : 0;
                            })()}%
                          </p>
                        </div>
                        <div>
                          <p className="text-[10px] text-white/40">Completados</p>
                          <p className="text-sm font-medium text-violet-400">
                            {data.habitLogs?.filter(l => l.completed).length || 0} total
                          </p>
                        </div>
                      </div>
                    </div>

                    {/* Week mini calendar */}
                    <div className="flex gap-1 mt-3 pt-3 border-t border-white/10">
                      {['L', 'M', 'X', 'J', 'V', 'S', 'D'].map((day, idx) => {
                        const weekDates = getWeekDates(viewDate);
                        const date = weekDates[idx];
                        const isToday = date === today;
                        const dayLogs = data.habitLogs?.filter(l => l.date === date && l.completed) || [];
                        const dayHabitsCount = data.habits.filter(h => shouldDoHabitOnDay(h, date)).length;
                        const completedCount = dayLogs.length;
                        const percentage = dayHabitsCount > 0 ? completedCount / dayHabitsCount : 0;

                        return (
                          <div key={idx} className={`flex-1 text-center py-1.5 rounded-lg ${isToday ? 'bg-white/10' : ''}`}>
                            <p className="text-[9px] text-white/40">{day}</p>
                            <div className={`w-5 h-5 mx-auto mt-1 rounded-full flex items-center justify-center text-[10px] font-medium
                        ${percentage === 1 ? 'bg-emerald-500 text-white' :
                                percentage > 0 ? 'bg-emerald-500/30 text-emerald-300' :
                                  'bg-white/5 text-white/30'}
                      `}>
                              {percentage === 1 ? '‚úì' : completedCount}
                            </div>
                          </div>
                        );
                      })}
                    </div>

                    {/* Motivational nudge when no habits completed yet */}
                    {isViewingToday && habitsCompleted === 0 && todayHabits.length > 0 && (
                      <div className="mt-3 pt-3 border-t border-white/10 text-center">
                        <p className="text-sm text-white/60">
                          üí™ <span className="text-emerald-400">¬°Peque√±os pasos!</span> Empieza con uno
                        </p>
                      </div>
                    )}
                  </Card>
                )}

                {/* Never Miss Twice Alert */}
                {isViewingToday && habitsWithAlert.length > 0 && (
                  <Card className="bg-red-500/10 border-red-500/30 mb-3">
                    <div className="flex items-center gap-2">
                      <AlertCircle className="w-4 h-4 text-red-400 flex-shrink-0" />
                      <div>
                        <p className="text-sm text-red-300 font-medium">¬°No falles dos veces!</p>
                        <p className="text-xs text-red-400/70">
                          {habitsWithAlert.map(h => h.icon + ' ' + h.name).join(', ')}
                        </p>
                      </div>
                    </div>
                  </Card>
                )}

                {/* Habits List */}
                <Card>
                  {/* Meta-habits (auto from other areas) */}
                  {(() => {
                    // Helper for gradual colors
                    const getMetaColor = (progress) => {
                      if (progress >= 80) return { bg: 'bg-emerald-500', text: 'text-emerald-400', bgLight: 'bg-emerald-500/20' };
                      if (progress >= 60) return { bg: 'bg-lime-500', text: 'text-lime-400', bgLight: 'bg-lime-500/20' };
                      if (progress >= 40) return { bg: 'bg-amber-500', text: 'text-amber-400', bgLight: 'bg-amber-500/20' };
                      if (progress >= 20) return { bg: 'bg-orange-500', text: 'text-orange-400', bgLight: 'bg-orange-500/20' };
                      return { bg: 'bg-red-500', text: 'text-red-400', bgLight: 'bg-red-500/20' };
                    };

                    const metaHabits = [
                      {
                        id: 'meta_nutrition',
                        name: 'Nutrici√≥n',
                        icon: 'ü•ó',
                        area: 'nutrition',
                        target: 80,
                        progress: () => {
                          const todayMealsData = data.meals.filter(m => m.day_id === viewDate);
                          const totalCals = todayMealsData.reduce((s, m) => s + (m.calories || 0), 0);
                          const targetCals = data.user.goals?.calories || 2000;
                          return Math.min(120, Math.round((totalCals / targetCals) * 100));
                        }
                      },
                      {
                        id: 'meta_protein',
                        name: 'Prote√≠na',
                        icon: 'üí™',
                        area: 'nutrition',
                        target: 80,
                        progress: () => {
                          const todayMealsData = data.meals.filter(m => m.day_id === viewDate);
                          const totalProt = todayMealsData.reduce((s, m) => s + (m.protein || 0), 0);
                          const targetProt = data.user.goals?.protein || 120;
                          return Math.min(120, Math.round((totalProt / targetProt) * 100));
                        }
                      },
                      {
                        id: 'meta_workout',
                        name: 'Entreno',
                        icon: 'üèãÔ∏è',
                        area: 'workout',
                        target: 70,
                        progress: () => {
                          const todayWorkout = data.workouts.find(w => w.day_id === viewDate);
                          if (!todayWorkout) return 0;
                          if (todayWorkout.is_completed) return 100;
                          const completedSets = todayWorkout.exercises?.reduce((sum, ex) =>
                            sum + ex.sets.filter(s => s.completed).length, 0) || 0;
                          const totalSets = todayWorkout.exercises?.reduce((sum, ex) => sum + ex.sets.length, 0) || 1;
                          // Even starting counts
                          if (completedSets > 0) return Math.max(30, Math.round((completedSets / totalSets) * 100));
                          return 0;
                        }
                      },
                      {
                        id: 'meta_water',
                        name: 'Agua',
                        icon: 'üíß',
                        area: 'nutrition',
                        target: 75,
                        progress: () => {
                          const dayDataWater = data.days[viewDate];
                          const waterGoal = data.user.goals?.water || 8;
                          return Math.min(120, Math.round(((dayDataWater?.water_glasses || 0) / waterGoal) * 100));
                        }
                      },
                      {
                        id: 'meta_steps',
                        name: '10k pasos',
                        icon: 'üö∂',
                        area: 'body',
                        target: 80,
                        progress: () => {
                          const dayDataSteps = data.days[viewDate];
                          const stepsGoal = data.user.goals?.steps || 10000;
                          return Math.min(120, Math.round(((dayDataSteps?.steps || 0) / stepsGoal) * 100));
                        }
                      }
                    ];

                    const visibleMetas = metaHabits.filter(m => activeAreas.includes(m.area));
                    if (visibleMetas.length === 0) return null;

                    return (
                      <div className="mb-3 pb-3 border-b border-white/10">
                        <p className="text-[10px] text-white/40 mb-2 flex items-center gap-1">
                          <Zap className="w-3 h-3" /> OBJETIVOS AUTO <span className="text-[8px] ml-1">(80% = ‚úì)</span>
                        </p>
                        <div className="grid grid-cols-2 gap-2">
                          {visibleMetas.map(meta => {
                            const progress = meta.progress();
                            const colors = getMetaColor(progress);
                            const hitTarget = progress >= meta.target;

                            return (
                              <div
                                key={meta.id}
                                className={`flex items-center gap-2 p-2 rounded-lg transition-all ${colors.bgLight}`}
                              >
                                <span className="text-lg">{meta.icon}</span>
                                <div className="flex-1 min-w-0">
                                  <div className="flex items-center justify-between">
                                    <span className={`text-xs font-medium ${colors.text}`}>{meta.name}</span>
                                    <span className={`text-[10px] font-bold ${colors.text}`}>{progress}%</span>
                                  </div>
                                  <div className="relative w-full h-1.5 bg-white/10 rounded-full mt-1 overflow-hidden">
                                    <div
                                      className="absolute top-0 bottom-0 w-px bg-white/40"
                                      style={{ left: `${meta.target}%` }}
                                    />
                                    <div
                                      className={`h-full rounded-full transition-all ${colors.bg}`}
                                      style={{ width: `${Math.min(progress, 100)}%` }}
                                    />
                                  </div>
                                </div>
                                {hitTarget && <Check className="w-3 h-3 text-emerald-400 flex-shrink-0" />}
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    );
                  })()}

                  {/* Regular habits */}
                  {todayHabits.length > 0 ? (
                    <div className="space-y-2">
                      {todayHabits.map(habit => {
                        const log = dayHabitLogs.find(l => l.habit_id === habit.id);
                        const isCompleted = log?.completed || false;
                        const usedMinVersion = log?.usedMinVersion || false;
                        const streak = getStreakWithFreeze(habit.id);
                        const missedYesterday = getMissedYesterday(habit.id);
                        const masteryLevel = getMasteryLevel(habit.id);
                        const stackedHabit = habit.stackedTo ? data.habits.find(h => h.id === habit.stackedTo) : null;

                        return (
                          <div
                            key={habit.id}
                            className={`relative flex items-center gap-3 p-2.5 rounded-xl transition-all
                        ${isCompleted ? (usedMinVersion ? 'bg-emerald-500/10' : 'bg-emerald-500/20') : 'bg-white/5'}
                        ${missedYesterday && !isCompleted ? 'ring-1 ring-red-500/50' : ''}
                      `}
                          >
                            {/* Missed yesterday indicator */}
                            {missedYesterday && !isCompleted && (
                              <div className="absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full animate-pulse" />
                            )}

                            {/* Checkbox */}
                            <button
                              onClick={() => isViewingToday && toggleHabit(habit.id)}
                              disabled={!isViewingToday}
                              className={`w-9 h-9 rounded-xl border-2 flex items-center justify-center flex-shrink-0 transition-all
                          ${isCompleted ? 'bg-emerald-500 border-emerald-500' : 'border-white/30 hover:border-emerald-400'}
                        `}
                            >
                              {isCompleted ? <Check className="w-4 h-4" /> : <span className="text-lg">{habit.icon}</span>}
                            </button>

                            {/* Content */}
                            <div className="flex-1 min-w-0">
                              <div className="flex items-center gap-2">
                                <span className={`text-sm truncate ${isCompleted ? 'line-through text-white/50' : ''}`}>
                                  {habit.name}
                                </span>
                                {/* Mastery dots */}
                                <div className="flex gap-0.5 flex-shrink-0">
                                  {[1, 2, 3, 4, 5].map(l => (
                                    <div key={l} className={`w-1 h-1 rounded-full ${l <= masteryLevel ? 'bg-violet-400' : 'bg-white/10'}`} />
                                  ))}
                                </div>
                              </div>

                              <div className="flex items-center gap-2 mt-0.5">
                                {streak.current > 0 && (
                                  <span className="text-[10px] text-orange-400">{streak.current}üî•</span>
                                )}
                                {stackedHabit && (
                                  <span className="text-[10px] text-white/30">‚Üí {stackedHabit.icon}</span>
                                )}
                                {habit.time && (
                                  <span className="text-[10px] text-white/20">{habit.time}</span>
                                )}
                                {usedMinVersion && isCompleted && (
                                  <span className="text-[10px] text-emerald-400/60">‚ö° m√≠nimo</span>
                                )}
                              </div>
                            </div>

                            {/* Min version button */}
                            {!isCompleted && habit.minVersion && isViewingToday && (
                              <button
                                onClick={() => toggleHabit(habit.id, true)}
                                className="px-2 py-1 bg-emerald-500/20 rounded-lg text-[10px] text-emerald-400 flex-shrink-0 hover:bg-emerald-500/30"
                                title={habit.minVersion}
                              >
                                ‚ö° 2min
                              </button>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  ) : data.habits.length > 0 ? (
                    <div className="text-center py-4">
                      <p className="text-white/40 text-sm">Sin h√°bitos para hoy</p>
                      <p className="text-[10px] text-white/30 mt-1">
                        {data.habits.length} h√°bito{data.habits.length > 1 ? 's' : ''} configurado{data.habits.length > 1 ? 's' : ''} para otros d√≠as
                      </p>
                    </div>
                  ) : (
                    <div className="text-center py-4">
                      <p className="text-white/40 mb-2">Construye tu identidad</p>
                      <button
                        onClick={() => setScreen('habits')}
                        className="text-sm text-violet-400 flex items-center gap-1 mx-auto"
                      >
                        <Plus className="w-4 h-4" /> Crear primer h√°bito
                      </button>
                    </div>
                  )}
                </Card>
              </AccordionSection>
            </AnimatedMount>
          )}

          {/* Work Section - EPIC VERSION */}
          {activeAreas.includes('work') && (
            <AnimatedMount delay={150}>
              {(() => {
                // Work data
                const workTasks = data.workTasks || [];
                const workProjects = data.workProjects || [];
                const todayTasks = workTasks.filter(t => t.dueDate === viewDate || t.scheduledDate === viewDate);
                const todayPending = todayTasks.filter(t => !t.completed);
                const todayCompleted = todayTasks.filter(t => t.completed);
                const q1Tasks = workTasks.filter(t => t.eisenhower === 'q1' && !t.completed);
                const overdueTasks = workTasks.filter(t => t.dueDate && t.dueDate < viewDate && !t.completed);
                const inboxTasks = workTasks.filter(t => !t.project_id && !t.dueDate && !t.completed);
                const doingTasks = workTasks.filter(t => t.status === 'doing' && !t.completed);

                // Deep work stats
                const deepWorkToday = workTasks
                  .filter(t => t.isDeepWork && t.completed && t.completedAt?.startsWith(viewDate))
                  .reduce((sum, t) => sum + (t.timeEstimate || 0), 0);
                const deepWorkGoal = data.user?.workSettings?.dailyDeepWorkGoal || 4;

                // Eat the Frog - most important task
                const frogTask = todayPending.find(t => t.eisenhower === 'q1') ||
                  todayPending.find(t => t.priority === 'high') ||
                  todayPending[0];

                const getProject = (id) => workProjects.find(p => p.id === id);

                const toggleWorkTask = (taskId) => {
                  setData(prev => ({
                    ...prev,
                    workTasks: prev.workTasks.map(t =>
                      t.id === taskId ? {
                        ...t,
                        completed: !t.completed,
                        completedAt: !t.completed ? new Date().toISOString() : null,
                        status: !t.completed ? 'done' : 'todo'
                      } : t
                    )
                  }));
                  showToast('‚úì Tarea actualizada');
                };

                const addQuickTask = () => {
                  if (!quickTaskInput.trim()) return;
                  const newTask = {
                    id: crypto.randomUUID(),
                    title: quickTaskInput.trim(),
                    description: '',
                    project_id: '',
                    priority: 'medium',
                    eisenhower: '',
                    status: 'backlog',
                    timeEstimate: 30,
                    dueDate: '',
                    scheduledDate: '',
                    isDeepWork: false,
                    completed: false,
                    completedAt: null,
                    createdAt: new Date().toISOString()
                  };
                  setData(prev => ({
                    ...prev,
                    workTasks: [...(prev.workTasks || []), newTask]
                  }));
                  setQuickTaskInput('');
                  showToast('üì• A√±adido a Inbox');
                };

                const addDetailedTask = () => {
                  if (!newDetailedTask.title.trim()) return;
                  const newTask = {
                    id: crypto.randomUUID(),
                    ...newDetailedTask,
                    scheduledDate: newDetailedTask.dueDate,
                    completed: false,
                    completedAt: null,
                    createdAt: new Date().toISOString()
                  };
                  setData(prev => ({
                    ...prev,
                    workTasks: [...(prev.workTasks || []), newTask]
                  }));
                  setShowDetailedAdd(false);
                  setNewDetailedTask({
                    title: '', description: '', project_id: '', priority: 'medium',
                    eisenhower: 'q2', status: 'todo', timeEstimate: 30, dueDate: viewDate, isDeepWork: false
                  });
                  showToast('‚úì Tarea creada');
                };

                const updateTask = (taskId, updates) => {
                  setData(prev => ({
                    ...prev,
                    workTasks: prev.workTasks.map(t => t.id === taskId ? { ...t, ...updates } : t)
                  }));
                };

                const deleteTask = (taskId) => {
                  setData(prev => ({
                    ...prev,
                    workTasks: prev.workTasks.filter(t => t.id !== taskId)
                  }));
                  setEditingWorkTask(null);
                  showToast('Tarea eliminada');
                };

                const changeTaskStatus = (taskId, newStatus) => {
                  const updates = { status: newStatus };
                  if (newStatus === 'done') {
                    updates.completed = true;
                    updates.completedAt = new Date().toISOString();
                  }
                  updateTask(taskId, updates);
                  showToast('‚Üí ' + (newStatus === 'backlog' ? 'Backlog' : newStatus === 'todo' ? 'Por hacer' : newStatus === 'doing' ? 'En progreso' : 'Hecho'));
                };

                const rescheduleTask = (taskId, newDate) => {
                  updateTask(taskId, { dueDate: newDate, scheduledDate: newDate });
                  showToast('üìÖ Reprogramada');
                };

                const startFocusTimer = (task, minutes = 25) => {
                  setFocusTimer(task);
                  setFocusTimeLeft(minutes * 60);
                  showToast(`üçÖ Focus: ${minutes}min en "${task.title}"`);
                };

                const formatTimer = (seconds) => {
                  const m = Math.floor(seconds / 60);
                  const s = seconds % 60;
                  return `${m}:${s.toString().padStart(2, '0')}`;
                };

                // Task Item Component
                const TaskItem = ({ task, showActions = true, highlight = false }) => {
                  const project = getProject(task.project_id);
                  const isOverdue = task.dueDate && task.dueDate < today && !task.completed;
                  const isEditing = editingWorkTask?.id === task.id;
                  const isFocusing = focusTimer?.id === task.id;

                  return (
                    <div className={`rounded-xl transition-all ${highlight ? 'bg-gradient-to-r from-amber-500/20 to-orange-500/20 border border-amber-500/30' :
                      isFocusing ? 'bg-violet-500/20 border border-violet-500/50' :
                        isOverdue ? 'bg-red-500/10' : 'bg-white/5'
                      } ${task.completed ? 'opacity-60' : ''}`}>
                      <div className="flex items-start gap-3 p-3">
                        {/* Checkbox */}
                        <button
                          onClick={() => toggleWorkTask(task.id)}
                          disabled={!isViewingToday}
                          className={`w-5 h-5 rounded-md border-2 flex items-center justify-center mt-0.5 transition-all flex-shrink-0
                      ${task.completed ? 'bg-violet-500 border-violet-500' :
                              task.priority === 'high' ? 'border-red-400' :
                                task.priority === 'medium' ? 'border-yellow-400' : 'border-white/30'}
                    `}
                        >
                          {task.completed && <Check className="w-3 h-3" />}
                        </button>

                        {/* Content */}
                        <div className="flex-1 min-w-0">
                          <div className="flex items-start justify-between gap-2">
                            <p className={`text-sm font-medium ${task.completed ? 'line-through text-white/50' : ''}`}>
                              {highlight && !task.completed && <span className="text-amber-400">üê∏ </span>}
                              {task.title}
                            </p>
                            {showActions && isViewingToday && !task.completed && (
                              <button
                                onClick={() => setEditingWorkTask(isEditing ? null : task)}
                                className="p-1 hover:bg-white/10 rounded flex-shrink-0"
                              >
                                <MoreHorizontal className="w-4 h-4 text-white/40" />
                              </button>
                            )}
                          </div>

                          {/* Meta */}
                          <div className="flex items-center gap-2 mt-1.5 flex-wrap">
                            {project && (
                              <span className="text-[10px] px-1.5 py-0.5 rounded"
                                style={{ backgroundColor: project.color + '30', color: project.color }}>
                                {project.name}
                              </span>
                            )}
                            {task.eisenhower === 'q1' && <span className="text-[10px] text-red-400">üî•</span>}
                            {task.isDeepWork && <Brain className="w-3 h-3 text-violet-400" />}
                            {task.timeEstimate && (
                              <span className="text-[10px] text-white/30">{task.timeEstimate}min</span>
                            )}
                            {isOverdue && <span className="text-[10px] text-red-400">‚ö†Ô∏è {task.dueDate}</span>}
                            {isFocusing && (
                              <span className="text-[10px] text-violet-400 font-mono bg-violet-500/20 px-1.5 rounded">
                                üçÖ {formatTimer(focusTimeLeft)}
                              </span>
                            )}
                          </div>

                          {/* Status pills */}
                          {showActions && !task.completed && isViewingToday && (
                            <div className="flex items-center gap-1.5 mt-2">
                              {['backlog', 'todo', 'doing', 'done'].map(status => (
                                <button
                                  key={status}
                                  onClick={() => changeTaskStatus(task.id, status)}
                                  className={`px-2 py-0.5 rounded text-[9px] transition-all ${task.status === status ? 'bg-violet-500 text-white' : 'bg-white/10 text-white/50 hover:bg-white/20'
                                    }`}
                                >
                                  {status === 'backlog' ? 'üìã' : status === 'todo' ? 'üìå' : status === 'doing' ? 'üîÑ' : '‚úÖ'}
                                </button>
                              ))}
                              {!isFocusing && (
                                <button
                                  onClick={() => startFocusTimer(task)}
                                  className="px-2 py-0.5 rounded text-[9px] bg-orange-500/20 text-orange-400 hover:bg-orange-500/30"
                                >
                                  üçÖ Focus
                                </button>
                              )}
                            </div>
                          )}
                        </div>
                      </div>

                      {/* Expanded actions */}
                      {isEditing && (
                        <div className="px-3 pb-3 pt-0 space-y-2 border-t border-white/10 mt-1">
                          {/* Reschedule */}
                          <div className="flex items-center gap-2">
                            <span className="text-[10px] text-white/40 w-16">Fecha:</span>
                            <div className="flex gap-1 flex-wrap flex-1">
                              <button onClick={() => rescheduleTask(task.id, today)}
                                className={`px-2 py-1 rounded text-[10px] ${task.dueDate === today ? 'bg-violet-500' : 'bg-white/10'}`}>
                                Hoy
                              </button>
                              <button onClick={() => rescheduleTask(task.id, getDateOffset(today, 1))}
                                className={`px-2 py-1 rounded text-[10px] ${task.dueDate === getDateOffset(today, 1) ? 'bg-violet-500' : 'bg-white/10'}`}>
                                Ma√±ana
                              </button>
                              <button onClick={() => rescheduleTask(task.id, getDateOffset(today, 7))}
                                className="px-2 py-1 rounded text-[10px] bg-white/10">
                                +1 sem
                              </button>
                              <button onClick={() => rescheduleTask(task.id, '')}
                                className="px-2 py-1 rounded text-[10px] bg-white/10">
                                Sin fecha
                              </button>
                            </div>
                          </div>

                          {/* Priority */}
                          <div className="flex items-center gap-2">
                            <span className="text-[10px] text-white/40 w-16">Prioridad:</span>
                            <div className="flex gap-1">
                              {['high', 'medium', 'low'].map(p => (
                                <button key={p} onClick={() => updateTask(task.id, { priority: p })}
                                  className={`px-2 py-1 rounded text-[10px] ${task.priority === p ?
                                    (p === 'high' ? 'bg-red-500' : p === 'medium' ? 'bg-yellow-500' : 'bg-blue-500') : 'bg-white/10'}`}>
                                  {p === 'high' ? 'üî¥ Alta' : p === 'medium' ? 'üü° Media' : 'üîµ Baja'}
                                </button>
                              ))}
                            </div>
                          </div>

                          {/* Eisenhower */}
                          <div className="flex items-center gap-2">
                            <span className="text-[10px] text-white/40 w-16">Matriz:</span>
                            <div className="flex gap-1 flex-wrap">
                              {[
                                { id: 'q1', label: 'üî• Hacer', color: 'bg-red-500' },
                                { id: 'q2', label: 'üìÖ Planificar', color: 'bg-blue-500' },
                                { id: 'q3', label: 'üë§ Delegar', color: 'bg-amber-500' },
                                { id: 'q4', label: 'üóëÔ∏è Eliminar', color: 'bg-zinc-600' }
                              ].map(q => (
                                <button key={q.id} onClick={() => updateTask(task.id, { eisenhower: q.id })}
                                  className={`px-2 py-1 rounded text-[10px] ${task.eisenhower === q.id ? q.color : 'bg-white/10'}`}>
                                  {q.label}
                                </button>
                              ))}
                            </div>
                          </div>

                          {/* Project */}
                          <div className="flex items-center gap-2">
                            <span className="text-[10px] text-white/40 w-16">Proyecto:</span>
                            <div className="flex gap-1 flex-wrap flex-1">
                              <button onClick={() => updateTask(task.id, { project_id: '' })}
                                className={`px-2 py-1 rounded text-[10px] ${!task.project_id ? 'bg-violet-500' : 'bg-white/10'}`}>
                                Ninguno
                              </button>
                              {workProjects.slice(0, 4).map(p => (
                                <button key={p.id} onClick={() => updateTask(task.id, { project_id: p.id })}
                                  className={`px-2 py-1 rounded text-[10px] flex items-center gap-1 ${task.project_id === p.id ? 'bg-violet-500' : 'bg-white/10'}`}>
                                  <div className="w-2 h-2 rounded-full" style={{ backgroundColor: p.color }} />
                                  {p.name}
                                </button>
                              ))}
                            </div>
                          </div>

                          {/* Deep Work toggle */}
                          <div className="flex items-center justify-between">
                            <button onClick={() => updateTask(task.id, { isDeepWork: !task.isDeepWork })}
                              className={`px-3 py-1.5 rounded-lg text-xs flex items-center gap-2 ${task.isDeepWork ? 'bg-violet-500' : 'bg-white/10'}`}>
                              <Brain className="w-3 h-3" /> Deep Work
                            </button>
                            <button onClick={() => deleteTask(task.id)}
                              className="px-3 py-1.5 rounded-lg text-xs text-red-400 bg-red-500/10 hover:bg-red-500/20">
                              <Trash2 className="w-3 h-3" />
                            </button>
                          </div>
                        </div>
                      )}
                    </div>
                  );
                };

                return (
                  <AccordionSection
                    title="TRABAJO"
                    icon={Briefcase}
                    iconColor="text-violet-400"
                    action={() => setScreen('work')}
                    actionLabel="Kanban"
                    storageKey="work"
                    progress={todayTasks.length > 0 ? Math.round((todayCompleted.length / todayTasks.length) * 100) : null}
                    progressColor="bg-violet-500"
                    urgent={overdueTasks.length > 0 || q1Tasks.length > 0}
                    summaryRight={todayTasks.length > 0 ? `${todayCompleted.length}/${todayTasks.length}` : null}
                    summary={(() => {
                      if (overdueTasks.length > 0) return `‚ö†Ô∏è ${overdueTasks.length} vencida${overdueTasks.length > 1 ? 's' : ''}`;
                      if (q1Tasks.length > 0) return `üî• ${q1Tasks.length} urgente${q1Tasks.length > 1 ? 's' : ''}`;
                      if (doingTasks.length > 0) return `üîÑ ${doingTasks.length} en progreso`;
                      if (todayPending.length > 0) return `${todayPending.length} pendiente${todayPending.length > 1 ? 's' : ''}`;
                      if (todayCompleted.length > 0) return '‚úì Todo completado';
                      if (inboxTasks.length > 0) return `üì• ${inboxTasks.length} en inbox`;
                      return 'Sin tareas';
                    })()}
                  >
                    {/* Stats Card */}
                    <Card className="bg-gradient-to-r from-violet-500/10 to-blue-500/10 border-violet-500/20 mb-3">
                      <div className="flex items-center gap-4">
                        {/* Progress Ring */}
                        <div className="relative w-14 h-14 flex-shrink-0">
                          <svg className="w-14 h-14 -rotate-90">
                            <circle cx="28" cy="28" r="24" fill="none" stroke="rgba(255,255,255,0.1)" strokeWidth="5" />
                            <circle
                              cx="28" cy="28" r="24" fill="none"
                              stroke="#8b5cf6"
                              strokeWidth="5"
                              strokeLinecap="round"
                              strokeDasharray={`${todayTasks.length > 0 ? (todayCompleted.length / todayTasks.length) * 151 : 0} 151`}
                            />
                          </svg>
                          <div className="absolute inset-0 flex items-center justify-center">
                            <span className="text-sm font-bold">
                              {todayTasks.length > 0 ? Math.round((todayCompleted.length / todayTasks.length) * 100) : 0}%
                            </span>
                          </div>
                        </div>

                        {/* Stats */}
                        <div className="flex-1 grid grid-cols-3 gap-2">
                          <div>
                            <p className="text-[10px] text-white/40">Hoy</p>
                            <p className="text-lg font-bold">{todayCompleted.length}<span className="text-white/40 text-xs">/{todayTasks.length}</span></p>
                          </div>
                          <div>
                            <p className="text-[10px] text-white/40">En progreso</p>
                            <p className="text-lg font-bold text-amber-400">{doingTasks.length}</p>
                          </div>
                          <div>
                            <p className="text-[10px] text-white/40">Deep Work</p>
                            <p className="text-sm font-bold text-violet-400">
                              {Math.floor(deepWorkToday / 60)}h{deepWorkToday % 60 > 0 ? ` ${deepWorkToday % 60}m` : ''}
                            </p>
                          </div>
                        </div>
                      </div>

                      {/* Focus Timer Active */}
                      {focusTimer && (
                        <div className="mt-3 pt-3 border-t border-white/10">
                          <div className="flex items-center justify-between">
                            <div className="flex items-center gap-2">
                              <span className="text-2xl">üçÖ</span>
                              <div>
                                <p className="text-xs text-white/60">Enfocado en:</p>
                                <p className="text-sm font-medium">{focusTimer.title}</p>
                              </div>
                            </div>
                            <div className="flex items-center gap-2">
                              <span className="text-2xl font-mono font-bold text-violet-400">
                                {formatTimer(focusTimeLeft)}
                              </span>
                              <button
                                onClick={() => { setFocusTimer(null); setFocusTimeLeft(0); }}
                                className="p-1.5 bg-white/10 rounded-lg hover:bg-white/20"
                              >
                                <X className="w-4 h-4" />
                              </button>
                            </div>
                          </div>
                        </div>
                      )}
                    </Card>

                    {/* Quick Add */}
                    {isViewingToday && (
                      <Card className="mb-3">
                        <div className="flex gap-2">
                          <input
                            type="text"
                            value={quickTaskInput}
                            onChange={(e) => setQuickTaskInput(e.target.value)}
                            onKeyDown={(e) => e.key === 'Enter' && addQuickTask()}
                            placeholder="A√±adir r√°pido a inbox..."
                            className="flex-1 bg-white/5 rounded-xl px-3 py-2.5 text-sm outline-none focus:bg-white/10 transition-all"
                          />
                          <button
                            onClick={addQuickTask}
                            disabled={!quickTaskInput.trim()}
                            className="px-3 py-2 bg-white/10 rounded-xl hover:bg-white/20 disabled:opacity-50 transition-all"
                          >
                            <Plus className="w-5 h-5" />
                          </button>
                          <button
                            onClick={() => setShowDetailedAdd(true)}
                            className="px-3 py-2 bg-violet-500 rounded-xl hover:bg-violet-600 transition-all"
                          >
                            <Edit3 className="w-5 h-5" />
                          </button>
                        </div>
                      </Card>
                    )}

                    {/* Tasks */}
                    <Card>
                      <div className="space-y-3">
                        {/* Eat the Frog */}
                        {frogTask && !frogTask.completed && (
                          <div>
                            <p className="text-[10px] text-amber-400 font-medium mb-1.5 flex items-center gap-1">
                              üê∏ EAT THE FROG
                            </p>
                            <TaskItem task={frogTask} highlight />
                          </div>
                        )}

                        {/* Overdue */}
                        {overdueTasks.length > 0 && (
                          <div>
                            <p className="text-[10px] text-red-400 font-medium mb-1.5 flex items-center gap-1">
                              <AlertCircle className="w-3 h-3" /> VENCIDAS ({overdueTasks.length})
                            </p>
                            <div className="space-y-2">
                              {overdueTasks.slice(0, 3).map(task => (
                                <TaskItem key={task.id} task={task} />
                              ))}
                              {overdueTasks.length > 3 && (
                                <button onClick={() => setScreen('work')} className="text-xs text-red-400 pl-2">
                                  +{overdueTasks.length - 3} m√°s
                                </button>
                              )}
                            </div>
                          </div>
                        )}

                        {/* In Progress */}
                        {doingTasks.length > 0 && (
                          <div>
                            <p className="text-[10px] text-amber-400 font-medium mb-1.5">üîÑ EN PROGRESO ({doingTasks.length})</p>
                            <div className="space-y-2">
                              {doingTasks.slice(0, 3).map(task => (
                                <TaskItem key={task.id} task={task} />
                              ))}
                            </div>
                          </div>
                        )}

                        {/* Today's remaining */}
                        {todayPending.filter(t => t.id !== frogTask?.id && t.status !== 'doing').length > 0 && (
                          <div>
                            <p className="text-[10px] text-white/40 font-medium mb-1.5">
                              HOY ({todayPending.filter(t => t.id !== frogTask?.id && t.status !== 'doing').length})
                            </p>
                            <div className="space-y-2">
                              {todayPending
                                .filter(t => t.id !== frogTask?.id && t.status !== 'doing')
                                .slice(0, 4)
                                .map(task => (
                                  <TaskItem key={task.id} task={task} />
                                ))}
                              {todayPending.filter(t => t.id !== frogTask?.id && t.status !== 'doing').length > 4 && (
                                <button onClick={() => setScreen('work')} className="text-xs text-violet-400 pl-2">
                                  +{todayPending.filter(t => t.id !== frogTask?.id && t.status !== 'doing').length - 4} m√°s
                                </button>
                              )}
                            </div>
                          </div>
                        )}

                        {/* Completed today */}
                        {todayCompleted.length > 0 && (
                          <div>
                            <p className="text-[10px] text-emerald-400 font-medium mb-1.5">‚úì COMPLETADAS ({todayCompleted.length})</p>
                            <div className="space-y-1">
                              {todayCompleted.slice(0, 2).map(task => (
                                <TaskItem key={task.id} task={task} showActions={false} />
                              ))}
                              {todayCompleted.length > 2 && (
                                <p className="text-[10px] text-white/30 pl-2">+{todayCompleted.length - 2} m√°s</p>
                              )}
                            </div>
                          </div>
                        )}

                        {/* Inbox preview */}
                        {inboxTasks.length > 0 && todayPending.length === 0 && overdueTasks.length === 0 && (
                          <div>
                            <p className="text-[10px] text-white/40 font-medium mb-1.5">üì• INBOX ({inboxTasks.length})</p>
                            <div className="space-y-2">
                              {inboxTasks.slice(0, 3).map(task => (
                                <TaskItem key={task.id} task={task} />
                              ))}
                              {inboxTasks.length > 3 && (
                                <button onClick={() => setScreen('work')} className="text-xs text-violet-400 pl-2">
                                  +{inboxTasks.length - 3} por procesar
                                </button>
                              )}
                            </div>
                          </div>
                        )}

                        {/* Empty state */}
                        {todayTasks.length === 0 && overdueTasks.length === 0 && inboxTasks.length === 0 && (
                          <div className="text-center py-4">
                            <p className="text-2xl mb-2">üéØ</p>
                            <p className="text-white/40">Sin tareas pendientes</p>
                            <p className="text-[10px] text-white/30 mt-1">¬°Buen trabajo!</p>
                          </div>
                        )}
                      </div>
                    </Card>

                    {/* Detailed Add Modal */}
                    {showDetailedAdd && (
                      <div className="fixed inset-0 bg-black/80 z-50 flex items-end justify-center p-4" onClick={() => setShowDetailedAdd(false)}>
                        <div className="bg-zinc-900 rounded-3xl w-full max-w-lg max-h-[85vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                          <div className="p-4 border-b border-white/10 flex items-center justify-between">
                            <h3 className="text-lg font-semibold">Nueva tarea</h3>
                            <button onClick={() => setShowDetailedAdd(false)} className="p-2 hover:bg-white/10 rounded-xl">
                              <X className="w-5 h-5" />
                            </button>
                          </div>

                          <div className="p-4 space-y-4">
                            {/* Title */}
                            <input
                              type="text"
                              value={newDetailedTask.title}
                              onChange={(e) => setNewDetailedTask(p => ({ ...p, title: e.target.value }))}
                              placeholder="¬øQu√© necesitas hacer?"
                              className="w-full bg-white/10 rounded-xl px-4 py-3 text-lg outline-none"
                              autoFocus
                            />

                            {/* Description */}
                            <textarea
                              value={newDetailedTask.description}
                              onChange={(e) => setNewDetailedTask(p => ({ ...p, description: e.target.value }))}
                              placeholder="Notas o descripci√≥n..."
                              className="w-full bg-white/10 rounded-xl px-4 py-3 text-sm outline-none h-20 resize-none"
                            />

                            {/* Date */}
                            <div>
                              <p className="text-xs text-white/40 mb-2">Fecha</p>
                              <div className="flex gap-2 flex-wrap">
                                {[
                                  { label: 'Hoy', value: today },
                                  { label: 'Ma√±ana', value: getDateOffset(today, 1) },
                                  { label: 'Esta semana', value: getDateOffset(today, 7) },
                                  { label: 'Sin fecha', value: '' }
                                ].map(d => (
                                  <button key={d.label}
                                    onClick={() => setNewDetailedTask(p => ({ ...p, dueDate: d.value }))}
                                    className={`px-3 py-2 rounded-xl text-sm ${newDetailedTask.dueDate === d.value ? 'bg-violet-500' : 'bg-white/10'}`}>
                                    {d.label}
                                  </button>
                                ))}
                              </div>
                            </div>

                            {/* Project */}
                            <div>
                              <p className="text-xs text-white/40 mb-2">Proyecto</p>
                              <div className="flex gap-2 flex-wrap">
                                <button
                                  onClick={() => setNewDetailedTask(p => ({ ...p, project_id: '' }))}
                                  className={`px-3 py-2 rounded-xl text-sm ${!newDetailedTask.project_id ? 'bg-violet-500' : 'bg-white/10'}`}>
                                  Sin proyecto
                                </button>
                                {workProjects.map(p => (
                                  <button key={p.id}
                                    onClick={() => setNewDetailedTask(prev => ({ ...prev, project_id: p.id }))}
                                    className={`px-3 py-2 rounded-xl text-sm flex items-center gap-2 ${newDetailedTask.project_id === p.id ? 'bg-violet-500' : 'bg-white/10'}`}>
                                    <div className="w-2 h-2 rounded-full" style={{ backgroundColor: p.color }} />
                                    {p.name}
                                  </button>
                                ))}
                              </div>
                            </div>

                            {/* Priority */}
                            <div>
                              <p className="text-xs text-white/40 mb-2">Prioridad</p>
                              <div className="flex gap-2">
                                {[
                                  { id: 'high', label: 'üî¥ Alta', color: 'bg-red-500' },
                                  { id: 'medium', label: 'üü° Media', color: 'bg-yellow-500' },
                                  { id: 'low', label: 'üîµ Baja', color: 'bg-blue-500' }
                                ].map(p => (
                                  <button key={p.id}
                                    onClick={() => setNewDetailedTask(prev => ({ ...prev, priority: p.id }))}
                                    className={`flex-1 py-2.5 rounded-xl text-sm ${newDetailedTask.priority === p.id ? p.color : 'bg-white/10'}`}>
                                    {p.label}
                                  </button>
                                ))}
                              </div>
                            </div>

                            {/* Eisenhower */}
                            <div>
                              <p className="text-xs text-white/40 mb-2">Matriz Eisenhower</p>
                              <div className="grid grid-cols-2 gap-2">
                                {[
                                  { id: 'q1', label: 'üî• Hacer ya', desc: 'Urgente + Importante' },
                                  { id: 'q2', label: 'üìÖ Planificar', desc: 'Importante' },
                                  { id: 'q3', label: 'üë§ Delegar', desc: 'Urgente' },
                                  { id: 'q4', label: 'üóëÔ∏è Eliminar', desc: 'Ninguno' }
                                ].map(q => (
                                  <button key={q.id}
                                    onClick={() => setNewDetailedTask(prev => ({ ...prev, eisenhower: q.id }))}
                                    className={`p-2 rounded-xl text-left ${newDetailedTask.eisenhower === q.id ? 'bg-violet-500' : 'bg-white/10'}`}>
                                    <p className="text-sm font-medium">{q.label}</p>
                                    <p className="text-[10px] text-white/50">{q.desc}</p>
                                  </button>
                                ))}
                              </div>
                            </div>

                            {/* Time estimate + Deep work */}
                            <div className="flex gap-3">
                              <div className="flex-1">
                                <p className="text-xs text-white/40 mb-2">Duraci√≥n</p>
                                <div className="flex gap-1">
                                  {[15, 30, 60, 120].map(t => (
                                    <button key={t}
                                      onClick={() => setNewDetailedTask(prev => ({ ...prev, timeEstimate: t }))}
                                      className={`flex-1 py-2 rounded-xl text-xs ${newDetailedTask.timeEstimate === t ? 'bg-violet-500' : 'bg-white/10'}`}>
                                      {t < 60 ? `${t}m` : `${t / 60}h`}
                                    </button>
                                  ))}
                                </div>
                              </div>
                              <div>
                                <p className="text-xs text-white/40 mb-2">Tipo</p>
                                <button
                                  onClick={() => setNewDetailedTask(prev => ({ ...prev, isDeepWork: !prev.isDeepWork }))}
                                  className={`px-4 py-2 rounded-xl text-sm flex items-center gap-2 ${newDetailedTask.isDeepWork ? 'bg-violet-500' : 'bg-white/10'}`}>
                                  <Brain className="w-4 h-4" /> Deep
                                </button>
                              </div>
                            </div>

                            {/* Submit */}
                            <button
                              onClick={addDetailedTask}
                              disabled={!newDetailedTask.title.trim()}
                              className="w-full py-3 bg-violet-500 rounded-xl font-semibold hover:bg-violet-600 disabled:opacity-50 transition-all">
                              Crear tarea
                            </button>
                          </div>
                        </div>
                      </div>
                    )}
                  </AccordionSection>
                );
              })()}
            </AnimatedMount>
          )}

          {/* Finances Section */}
          {activeAreas.includes('finances') && (
            <AnimatedMount delay={175}>
              <AccordionSection
                title="FINANZAS"
                icon={Wallet}
                iconColor="text-green-400"
                action={() => setScreen('finances')}
                actionLabel="Ver todo"
                storageKey="finances"
                progress={(() => {
                  const monthlyBudget = data.finances?.monthlyBudget || 0;
                  if (monthlyBudget === 0) return null;
                  const transactions = data.finances?.transactions || [];
                  const thisMonth = viewDate.substring(0, 7);
                  const monthExpenses = transactions.filter(t => t.date?.startsWith(thisMonth) && t.type === 'expense').reduce((s, t) => s + t.amount, 0);
                  return Math.min(100, Math.round((monthExpenses / monthlyBudget) * 100));
                })()}
                progressColor={(() => {
                  const monthlyBudget = data.finances?.monthlyBudget || 0;
                  if (monthlyBudget === 0) return 'bg-green-500';
                  const transactions = data.finances?.transactions || [];
                  const thisMonth = viewDate.substring(0, 7);
                  const monthExpenses = transactions.filter(t => t.date?.startsWith(thisMonth) && t.type === 'expense').reduce((s, t) => s + t.amount, 0);
                  const pct = (monthExpenses / monthlyBudget) * 100;
                  return pct > 100 ? 'bg-red-500' : pct > 80 ? 'bg-amber-500' : 'bg-green-500';
                })()}
                urgent={(() => {
                  const monthlyBudget = data.finances?.monthlyBudget || 0;
                  if (monthlyBudget === 0) return false;
                  const transactions = data.finances?.transactions || [];
                  const thisMonth = viewDate.substring(0, 7);
                  const monthExpenses = transactions.filter(t => t.date?.startsWith(thisMonth) && t.type === 'expense').reduce((s, t) => s + t.amount, 0);
                  return monthExpenses > monthlyBudget;
                })()}
                summaryRight={(() => {
                  const transactions = data.finances?.transactions || [];
                  const thisMonth = viewDate.substring(0, 7);
                  const monthExpenses = transactions.filter(t => t.date?.startsWith(thisMonth) && t.type === 'expense').reduce((s, t) => s + t.amount, 0);
                  const currency = data.finances?.currency || '‚Ç¨';
                  return `-${monthExpenses.toFixed(0)}${currency}`;
                })()}
                summary={(() => {
                  const monthlyBudget = data.finances?.monthlyBudget || 0;
                  const transactions = data.finances?.transactions || [];
                  const thisMonth = viewDate.substring(0, 7);
                  const monthExpenses = transactions.filter(t => t.date?.startsWith(thisMonth) && t.type === 'expense').reduce((s, t) => s + t.amount, 0);
                  const currency = data.finances?.currency || '‚Ç¨';
                  if (monthlyBudget > 0) {
                    const pct = Math.round((monthExpenses / monthlyBudget) * 100);
                    const left = monthlyBudget - monthExpenses;
                    if (left < 0) return `‚ö†Ô∏è Excedido ${Math.abs(left).toFixed(0)}${currency}`;
                    return `${pct}% usado ¬∑ ${left.toFixed(0)}${currency} libre`;
                  }
                  return 'Sin presupuesto definido';
                })()}
              >
                <Card className="mt-2">
                  {(() => {
                    const transactions = data.finances?.transactions || [];
                    const thisMonth = viewDate.substring(0, 7);
                    const monthTransactions = transactions.filter(t => t.date?.startsWith(thisMonth));
                    const monthExpenses = monthTransactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
                    const monthIncome = monthTransactions.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
                    const todayTransactions = transactions.filter(t => t.date === viewDate);
                    const todayExpenses = todayTransactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
                    const monthlyBudget = data.finances?.monthlyBudget || 0;
                    const budgetUsed = monthlyBudget > 0 ? Math.round((monthExpenses / monthlyBudget) * 100) : 0;
                    const currency = data.finances?.currency || '‚Ç¨';

                    return (
                      <div className="space-y-3">
                        {/* Monthly overview */}
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-xs text-white/40">Este mes</p>
                            <p className="text-xl font-bold text-red-400">-{monthExpenses.toFixed(0)}{currency}</p>
                          </div>
                          {monthIncome > 0 && (
                            <div className="text-right">
                              <p className="text-xs text-white/40">Ingresos</p>
                              <p className="text-lg font-bold text-green-400">+{monthIncome.toFixed(0)}{currency}</p>
                            </div>
                          )}
                        </div>

                        {/* Budget progress */}
                        {monthlyBudget > 0 && (
                          <div>
                            <div className="flex justify-between text-xs mb-1">
                              <span className="text-white/40">Presupuesto</span>
                              <span className={budgetUsed > 100 ? 'text-red-400' : budgetUsed > 80 ? 'text-amber-400' : 'text-emerald-400'}>
                                {budgetUsed}% usado
                              </span>
                            </div>
                            <ProgressBar
                              value={monthExpenses}
                              max={monthlyBudget}
                              color={budgetUsed > 100 ? 'bg-red-500' : budgetUsed > 80 ? 'bg-amber-500' : 'bg-emerald-500'}
                            />
                            <p className="text-[10px] text-white/30 mt-1">
                              {monthlyBudget - monthExpenses > 0
                                ? `Quedan ${(monthlyBudget - monthExpenses).toFixed(0)}${currency}`
                                : `Excedido en ${Math.abs(monthlyBudget - monthExpenses).toFixed(0)}${currency}`}
                            </p>
                          </div>
                        )}

                        {/* Today's transactions */}
                        {todayTransactions.length > 0 ? (
                          <div className="pt-2 border-t border-white/10">
                            <p className="text-xs text-white/40 mb-2">Hoy: {todayExpenses > 0 ? `-${todayExpenses.toFixed(0)}${currency}` : 'Sin gastos'}</p>
                            <div className="space-y-1">
                              {todayTransactions.slice(0, 3).map(t => (
                                <div key={t.id} className="flex items-center justify-between text-sm">
                                  <span className="text-white/70">{t.description || t.category}</span>
                                  <span className={t.type === 'expense' ? 'text-red-400' : 'text-green-400'}>
                                    {t.type === 'expense' ? '-' : '+'}{t.amount}{currency}
                                  </span>
                                </div>
                              ))}
                            </div>
                          </div>
                        ) : (
                          <div className="pt-2 border-t border-white/10 text-center">
                            <p className="text-xs text-white/40 mb-2">Sin movimientos hoy</p>
                            <button
                              onClick={() => setScreen('finances')}
                              className="text-sm text-green-400 flex items-center gap-1 mx-auto"
                            >
                              <Plus className="w-4 h-4" /> A√±adir gasto
                            </button>
                          </div>
                        )}
                      </div>
                    );
                  })()}
                </Card>
              </AccordionSection>
            </AnimatedMount>
          )}

          {/* TIER 3: Correlations / Cross-Area Insights */}
          {getCorrelations.length > 0 && (
            <AnimatedMount delay={175}>
              <Card className="bg-gradient-to-br from-violet-500/5 to-fuchsia-500/5 border-violet-500/20">
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-2">
                    <Sparkles className="w-4 h-4 text-violet-400" />
                    <span className="text-xs font-medium text-violet-300">Conexiones detectadas</span>
                  </div>
                  <span className="text-xs text-white/30">{getCorrelations.length} insight{getCorrelations.length > 1 ? 's' : ''}</span>
                </div>
                <div className="space-y-2">
                  {getCorrelations.slice(0, 3).map((corr, idx) => (
                    <div
                      key={corr.id}
                      className={`flex items-start gap-3 p-2 rounded-lg ${corr.type === 'success' ? 'bg-emerald-500/10' :
                        corr.type === 'warning' ? 'bg-amber-500/10' :
                          'bg-blue-500/10'
                        }`}
                    >
                      <span className="text-lg flex-shrink-0">{corr.icon}</span>
                      <div className="flex-1 min-w-0">
                        <p className="text-sm text-white/80">{corr.text}</p>
                      </div>
                    </div>
                  ))}
                  {getCorrelations.length > 3 && (
                    <p className="text-xs text-white/30 text-center pt-1">
                      +{getCorrelations.length - 3} m√°s...
                    </p>
                  )}
                </div>
              </Card>
            </AnimatedMount>
          )}

          {/* Fallback: Single insight if no correlations */}
          {getCorrelations.length === 0 && insight && (
            <AnimatedMount delay={175}>
              <Card className={`
            ${insight.type === 'success' ? 'bg-emerald-500/10 border-emerald-500/20' : ''}
            ${insight.type === 'warning' ? 'bg-amber-500/10 border-amber-500/20' : ''}
            ${insight.type === 'info' ? 'bg-blue-500/10 border-blue-500/20' : ''}
          `}>
                <div className="flex items-center gap-3">
                  <Brain className={`w-5 h-5 ${insight.type === 'success' ? 'text-emerald-400' :
                    insight.type === 'warning' ? 'text-amber-400' : 'text-blue-400'
                    }`} />
                  <p className="text-sm">{insight.text}</p>
                </div>
              </Card>
            </AnimatedMount>
          )}

          {/* ==================== PERSONAL TASKS ==================== */}
          {activeAreas.includes('personal') && (() => {
            const personalTasks = data.personalTasks || [];
            const personalCategories = data.personalCategories || [
              { id: 'home', name: 'Hogar', icon: 'üè†', color: '#10B981' },
              { id: 'admin', name: 'Admin', icon: 'üìã', color: '#6366F1' },
              { id: 'health', name: 'Salud', icon: '‚ù§Ô∏è', color: '#EF4444' },
              { id: 'social', name: 'Social', icon: 'üë•', color: '#F59E0B' },
              { id: 'travel', name: 'Viajes', icon: '‚úàÔ∏è', color: '#3B82F6' },
              { id: 'learning', name: 'Aprendizaje', icon: 'üìö', color: '#8B5CF6' },
              { id: 'projects', name: 'Proyectos', icon: 'üöÄ', color: '#EC4899' }
            ];

            const todayTasks = personalTasks.filter(t => !t.completed && t.dueDate === viewDate);
            const overdueTasks = personalTasks.filter(t => !t.completed && t.dueDate && t.dueDate < viewDate);
            const upcomingTasks = personalTasks.filter(t => !t.completed && t.dueDate && t.dueDate > viewDate).slice(0, 2);
            const noDueTasks = personalTasks.filter(t => !t.completed && !t.dueDate).slice(0, 2);
            const allPending = [...overdueTasks, ...todayTasks, ...upcomingTasks.slice(0, 2), ...noDueTasks.slice(0, 1)];
            const completedToday = personalTasks.filter(t => t.completed && t.completedAt?.startsWith(viewDate)).length;

            const getCat = (id) => personalCategories.find(c => c.id === id) || personalCategories[0];

            const togglePersonalTask = (id) => {
              setData(prev => ({
                ...prev,
                personalTasks: prev.personalTasks.map(t =>
                  t.id === id ? { ...t, completed: !t.completed, completedAt: !t.completed ? new Date().toISOString() : null } : t
                )
              }));
              showToast('‚úì Tarea completada');
            };

            const toggleSubtask = (taskId, subtaskId) => {
              setData(prev => ({
                ...prev,
                personalTasks: prev.personalTasks.map(t =>
                  t.id === taskId ? {
                    ...t,
                    subtasks: (t.subtasks || []).map(st =>
                      st.id === subtaskId ? { ...st, completed: !st.completed } : st
                    )
                  } : t
                )
              }));
            };

            const addSubtask = (taskId) => {
              if (!personalNewSubtask.trim()) return;
              setData(prev => ({
                ...prev,
                personalTasks: prev.personalTasks.map(t =>
                  t.id === taskId ? {
                    ...t,
                    subtasks: [...(t.subtasks || []), { id: `st-${Date.now()}`, title: personalNewSubtask, completed: false }]
                  } : t
                )
              }));
              setPersonalNewSubtask('');
            };

            const addPersonalTask = () => {
              if (!personalNewTask.title.trim()) return;
              const newTask = {
                id: `pt-${Date.now()}`,
                ...personalNewTask,
                completed: false,
                subtasks: [],
                notes: '',
                createdAt: viewDate
              };
              setData(prev => ({ ...prev, personalTasks: [...prev.personalTasks, newTask] }));
              setPersonalNewTask({ title: '', category: 'home', dueDate: '', priority: 'medium' });
              setPersonalShowAddTask(false);
              showToast('‚úì Tarea a√±adida');
            };

            return (
              <AnimatedMount delay={180}>
                <AccordionSection
                  title="PERSONAL"
                  icon={Calendar}
                  iconColor="text-cyan-400"
                  storageKey="personal"
                  progress={allPending.length > 0 ? Math.round((completedToday / (completedToday + allPending.length)) * 100) : null}
                  progressColor="bg-cyan-500"
                  urgent={overdueTasks.length > 0}
                  summary={
                    overdueTasks.length > 0
                      ? `‚ö†Ô∏è ${overdueTasks.length} vencida${overdueTasks.length > 1 ? 's' : ''}`
                      : todayTasks.length > 0
                        ? `${todayTasks.length} para hoy`
                        : allPending.length > 0
                          ? `${allPending.length} pendiente${allPending.length > 1 ? 's' : ''}`
                          : '‚ú® Todo al d√≠a'
                  }
                >
                  <div className="mt-2 space-y-2">
                    {allPending.length === 0 && !personalShowAddTask ? (
                      <Card className="text-center py-4">
                        <p className="text-white/40 text-sm">Sin tareas pendientes</p>
                        <button
                          onClick={() => setPersonalShowAddTask(true)}
                          className="text-cyan-400 text-sm mt-1 flex items-center gap-1 mx-auto"
                        >
                          <Plus className="w-4 h-4" /> A√±adir
                        </button>
                      </Card>
                    ) : (
                      <>
                        {allPending.slice(0, 5).map(task => {
                          const cat = getCat(task.category);
                          const isOverdue = task.dueDate && task.dueDate < viewDate;
                          const isExpanded = personalExpandedTask === task.id;
                          const subtasks = task.subtasks || [];
                          const completedSubtasks = subtasks.filter(st => st.completed).length;

                          return (
                            <Card
                              key={task.id}
                              className={`py-2 transition-all ${isOverdue ? 'border-red-500/30' : ''} ${isExpanded ? 'border-cyan-500/50' : ''}`}
                              style={{ borderLeftWidth: '3px', borderLeftColor: cat.color }}
                            >
                              <div className="flex items-center gap-3">
                                <button
                                  onClick={() => togglePersonalTask(task.id)}
                                  className="w-5 h-5 rounded-full border-2 border-white/30 flex items-center justify-center hover:border-cyan-400 transition-all flex-shrink-0"
                                >
                                </button>
                                <div
                                  className="flex-1 min-w-0 cursor-pointer"
                                  onClick={() => setPersonalExpandedTask(isExpanded ? null : task.id)}
                                >
                                  <div className="flex items-center gap-2">
                                    <p className="text-sm font-medium truncate">{task.title}</p>
                                    {subtasks.length > 0 && (
                                      <span className="text-[10px] text-white/40 bg-white/10 px-1.5 py-0.5 rounded">
                                        {completedSubtasks}/{subtasks.length}
                                      </span>
                                    )}
                                  </div>
                                  <div className="flex items-center gap-2 mt-0.5">
                                    <span className="text-[10px]" style={{ color: cat.color }}>{cat.icon} {cat.name}</span>
                                    {task.dueDate && (
                                      <span className={`text-[10px] ${isOverdue ? 'text-red-400' : 'text-white/40'}`}>
                                        {task.dueDate === viewDate ? 'Hoy' : isOverdue ? '‚ö†Ô∏è Vencida' : new Date(task.dueDate).toLocaleDateString('es', { day: 'numeric', month: 'short' })}
                                      </span>
                                    )}
                                  </div>
                                </div>
                                <ChevronDown className={`w-4 h-4 text-white/30 transition-transform flex-shrink-0 ${isExpanded ? 'rotate-180' : ''}`} />
                              </div>

                              {/* Expanded: Subtasks */}
                              {isExpanded && (
                                <div className="mt-3 pt-3 border-t border-white/10 space-y-2">
                                  {/* Existing subtasks */}
                                  {subtasks.map(st => (
                                    <div key={st.id} className="flex items-center gap-2 ml-7">
                                      <button
                                        onClick={() => toggleSubtask(task.id, st.id)}
                                        className={`w-4 h-4 rounded border flex items-center justify-center transition-all ${st.completed ? 'bg-cyan-500 border-cyan-500' : 'border-white/30'}`}
                                      >
                                        {st.completed && <Check className="w-3 h-3" />}
                                      </button>
                                      <span className={`text-sm ${st.completed ? 'text-white/40 line-through' : ''}`}>{st.title}</span>
                                    </div>
                                  ))}

                                  {/* Add subtask */}
                                  <div className="flex items-center gap-2 ml-7">
                                    <input
                                      type="text"
                                      value={personalNewSubtask}
                                      onChange={(e) => setPersonalNewSubtask(e.target.value)}
                                      onKeyPress={(e) => e.key === 'Enter' && addSubtask(task.id)}
                                      placeholder="+ A√±adir subtarea..."
                                      className="flex-1 bg-white/5 rounded px-2 py-1 text-sm"
                                    />
                                    {personalNewSubtask && (
                                      <button
                                        onClick={() => addSubtask(task.id)}
                                        className="text-cyan-400 text-sm"
                                      >
                                        A√±adir
                                      </button>
                                    )}
                                  </div>

                                  {/* Notes */}
                                  {task.notes && (
                                    <p className="text-xs text-white/40 ml-7 italic">üìù {task.notes}</p>
                                  )}
                                </div>
                              )}
                            </Card>
                          );
                        })}

                        {allPending.length > 5 && (
                          <p className="text-center text-xs text-cyan-400">
                            +{allPending.length - 5} m√°s
                          </p>
                        )}
                      </>
                    )}

                    {/* Add task form */}
                    {personalShowAddTask ? (
                      <Card className="py-3 space-y-2">
                        <input
                          type="text"
                          value={personalNewTask.title}
                          onChange={(e) => setPersonalNewTask(prev => ({ ...prev, title: e.target.value }))}
                          placeholder="¬øQu√© necesitas hacer?"
                          className="w-full bg-white/5 rounded-lg px-3 py-2 text-sm"
                          autoFocus
                        />
                        <div className="flex gap-2">
                          <select
                            value={personalNewTask.category}
                            onChange={(e) => setPersonalNewTask(prev => ({ ...prev, category: e.target.value }))}
                            className="flex-1 bg-white/5 rounded-lg px-2 py-2 text-sm"
                          >
                            {personalCategories.map(cat => (
                              <option key={cat.id} value={cat.id}>{cat.icon} {cat.name}</option>
                            ))}
                          </select>
                          <input
                            type="date"
                            value={personalNewTask.dueDate}
                            onChange={(e) => setPersonalNewTask(prev => ({ ...prev, dueDate: e.target.value }))}
                            className="flex-1 bg-white/5 rounded-lg px-2 py-2 text-sm"
                          />
                        </div>
                        <div className="flex gap-2">
                          <button
                            onClick={() => setPersonalShowAddTask(false)}
                            className="flex-1 py-2 bg-white/10 rounded-lg text-sm"
                          >
                            Cancelar
                          </button>
                          <button
                            onClick={addPersonalTask}
                            disabled={!personalNewTask.title.trim()}
                            className="flex-1 py-2 bg-cyan-500 rounded-lg text-sm font-medium disabled:opacity-30"
                          >
                            A√±adir
                          </button>
                        </div>
                      </Card>
                    ) : allPending.length > 0 && (
                      <button
                        onClick={() => setPersonalShowAddTask(true)}
                        className="w-full py-2 bg-cyan-500/20 border border-cyan-500/30 rounded-lg text-sm text-cyan-400 flex items-center justify-center gap-2"
                      >
                        <Plus className="w-4 h-4" /> A√±adir tarea
                      </button>
                    )}
                  </div>
                </AccordionSection>
              </AnimatedMount>
            );
          })()}

          {/* ==================== RELATIONSHIPS ==================== */}
          {activeAreas.includes('relationships') && (() => {
            const relationships = data.relationships || [];

            // Same categories as RelationshipsScreen
            const categories = {
              partner: { name: 'Pareja', icon: 'üíë', color: '#EC4899' },
              family: { name: 'Familia', icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', color: '#F59E0B' },
              friends: { name: 'Amigos', icon: 'üë•', color: '#3B82F6' },
              professional: { name: 'Profesional', icon: 'ü§ù', color: '#8B5CF6' },
              community: { name: 'Comunidad', icon: 'üå±', color: '#10B981' }
            };

            // Same love languages as RelationshipsScreen
            const loveLanguages = {
              words: { name: 'Palabras', icon: 'üí¨' },
              time: { name: 'Tiempo', icon: '‚è∞' },
              gifts: { name: 'Regalos', icon: 'üéÅ' },
              service: { name: 'Servicio', icon: 'üõ†Ô∏è' },
              touch: { name: 'Contacto', icon: 'ü§ó' }
            };

            const frequencyDays = { daily: 1, weekly: 7, biweekly: 14, monthly: 30, quarterly: 90 };

            // Calculate days since last contact (using interactions array like RelationshipsScreen)
            const getDaysSinceContact = (rel) => {
              // Check interactions first
              if (rel.interactions?.length > 0) {
                const sorted = [...rel.interactions].sort((a, b) => b.date.localeCompare(a.date));
                const lastDate = sorted[0].date;
                return Math.floor((new Date(viewDate) - new Date(lastDate)) / (1000 * 60 * 60 * 24));
              }
              // Fallback to lastContact field
              if (rel.lastContact) {
                return Math.floor((new Date(viewDate) - new Date(rel.lastContact)) / (1000 * 60 * 60 * 24));
              }
              return null;
            };

            // Check if needs attention
            const needsAttentionCheck = (rel) => {
              const days = getDaysSinceContact(rel);
              if (days === null) return true;
              const targetDays = frequencyDays[rel.contactFrequency] || 7;
              return days >= targetDays;
            };

            // Get health score (1-5)
            const getHealthScore = (rel) => {
              const days = getDaysSinceContact(rel);
              if (days === null) return 1;
              const targetDays = frequencyDays[rel.contactFrequency] || 7;
              const ratio = days / targetDays;
              if (ratio <= 0.5) return 5;
              if (ratio <= 1) return 4;
              if (ratio <= 1.5) return 3;
              if (ratio <= 2) return 2;
              return 1;
            };

            // Calculate who needs attention
            const needsAttention = relationships.filter(needsAttentionCheck).sort((a, b) => {
              const daysA = getDaysSinceContact(a) ?? 999;
              const daysB = getDaysSinceContact(b) ?? 999;
              return daysB - daysA;
            });

            // Upcoming birthdays (next 30 days)
            const upcomingBirthdays = relationships.filter(r => {
              if (!r.birthday) return false;
              const bday = new Date(r.birthday);
              const thisYear = new Date(viewDate);
              thisYear.setMonth(bday.getMonth());
              thisYear.setDate(bday.getDate());
              if (thisYear < new Date(viewDate)) thisYear.setFullYear(thisYear.getFullYear() + 1);
              const daysUntil = Math.floor((thisYear - new Date(viewDate)) / (1000 * 60 * 60 * 24));
              return daysUntil >= 0 && daysUntil <= 30;
            }).map(r => {
              const bday = new Date(r.birthday);
              const thisYear = new Date(viewDate);
              thisYear.setMonth(bday.getMonth());
              thisYear.setDate(bday.getDate());
              if (thisYear < new Date(viewDate)) thisYear.setFullYear(thisYear.getFullYear() + 1);
              const daysUntil = Math.floor((thisYear - new Date(viewDate)) / (1000 * 60 * 60 * 24));
              return { ...r, daysUntil };
            }).sort((a, b) => a.daysUntil - b.daysUntil);

            // Log interaction (compatible with RelationshipsScreen)
            const logInteraction = (relId) => {
              const interaction = {
                id: `int-${Date.now()}`,
                date: viewDate,
                type: 'inperson',
                notes: relInteractionNote,
                quality: 3,
                timestamp: new Date().toISOString()
              };
              setData(prev => ({
                ...prev,
                relationships: prev.relationships.map(r =>
                  r.id === relId ? {
                    ...r,
                    lastContact: viewDate,
                    interactions: [...(r.interactions || []), interaction]
                  } : r
                )
              }));
              setRelInteractionNote('');
              setRelExpandedCard(null);
              showToast('‚úì Contacto registrado');
            };

            // Add new contact (compatible with RelationshipsScreen)
            const addContact = () => {
              if (!relNewContact.name.trim()) return;
              const newRel = {
                id: `rel-${Date.now()}`,
                name: relNewContact.name,
                category: relNewContact.category,
                contactFrequency: relNewContact.contactFrequency,
                loveLanguage: relNewContact.loveLanguage || '',
                birthday: relNewContact.birthday || '',
                anniversary: '',
                notes: '',
                interests: '',
                pendingTopics: '',
                healthRating: 3,
                interactions: [],
                createdAt: new Date().toISOString()
              };
              setData(prev => ({ ...prev, relationships: [...(prev.relationships || []), newRel] }));
              setRelNewContact({ name: '', category: 'friends', contactFrequency: 'weekly', birthday: '', loveLanguage: '' });
              setRelShowAddContact(false);
              showToast('‚úì Contacto a√±adido');
            };

            return (
              <AnimatedMount delay={182}>
                <AccordionSection
                  title="RELACIONES"
                  icon={Users}
                  iconColor="text-pink-400"
                  storageKey="relationships"
                  action={() => setScreen('relationships')}
                  actionLabel="Ver todo"
                  progress={relationships.length > 0 ? Math.round(((relationships.length - needsAttention.length) / relationships.length) * 100) : null}
                  progressColor="bg-pink-500"
                  urgent={needsAttention.length > 2}
                  summary={
                    needsAttention.length > 0
                      ? `${needsAttention.length} necesita${needsAttention.length > 1 ? 'n' : ''} atenci√≥n`
                      : upcomingBirthdays.length > 0
                        ? `üéÇ ${upcomingBirthdays[0].name} en ${upcomingBirthdays[0].daysUntil}d`
                        : '‚ú® Conexiones al d√≠a'
                  }
                  summaryRight={relationships.length > 0 ? `${relationships.length} üë•` : null}
                >
                  <div className="mt-2 space-y-2">

                    {/* Upcoming birthdays alert */}
                    {upcomingBirthdays.length > 0 && upcomingBirthdays[0].daysUntil <= 7 && (
                      <Card className="py-2 border-amber-500/30 bg-amber-500/10">
                        <div className="flex items-center gap-3">
                          <span className="text-2xl">üéÇ</span>
                          <div className="flex-1">
                            <p className="text-sm font-medium">{upcomingBirthdays[0].name}</p>
                            <p className="text-xs text-amber-400">
                              {upcomingBirthdays[0].daysUntil === 0 ? '¬°Hoy!' : `En ${upcomingBirthdays[0].daysUntil} d√≠a${upcomingBirthdays[0].daysUntil > 1 ? 's' : ''}`}
                            </p>
                          </div>
                          {upcomingBirthdays.length > 1 && (
                            <span className="text-xs text-white/40">+{upcomingBirthdays.length - 1} m√°s</span>
                          )}
                        </div>
                      </Card>
                    )}

                    {/* Needs attention list */}
                    {needsAttention.length > 0 ? (
                      needsAttention.slice(0, 4).map(rel => {
                        const cat = categories[rel.category] || categories.friends;
                        const daysSince = getDaysSinceContact(rel);
                        const health = getHealthScore(rel);
                        const isExpanded = relExpandedCard === rel.id;

                        return (
                          <Card
                            key={rel.id}
                            className={`py-2 transition-all ${isExpanded ? 'border-pink-500/50' : ''}`}
                            style={{ borderLeftWidth: '3px', borderLeftColor: cat.color }}
                          >
                            <div
                              className="flex items-center justify-between cursor-pointer"
                              onClick={() => setRelExpandedCard(isExpanded ? null : rel.id)}
                            >
                              <div className="flex items-center gap-3">
                                <div
                                  className="w-10 h-10 rounded-full flex items-center justify-center text-lg"
                                  style={{ backgroundColor: cat.color + '30' }}
                                >
                                  {cat.icon}
                                </div>
                                <div>
                                  <div className="flex items-center gap-2">
                                    <p className="text-sm font-medium">{rel.name}</p>
                                    {rel.loveLanguage && <span className="text-xs">{loveLanguages[rel.loveLanguage]?.icon}</span>}
                                  </div>
                                  <p className="text-[10px] text-white/40">
                                    {daysSince !== null ? (
                                      daysSince === 0 ? 'Hoy' : `Hace ${daysSince} d√≠a${daysSince > 1 ? 's' : ''}`
                                    ) : 'Sin contacto'}
                                    <span className="mx-1">‚Ä¢</span>
                                    <span style={{ color: cat.color }}>{cat.name}</span>
                                  </p>
                                </div>
                              </div>
                              <div className="flex items-center gap-2">
                                {/* Health bars */}
                                <div className="flex gap-0.5">
                                  {[1, 2, 3, 4, 5].map(i => (
                                    <div
                                      key={i}
                                      className={`w-1 h-3 rounded-full ${i <= health ? 'bg-pink-500' : 'bg-white/10'}`}
                                    />
                                  ))}
                                </div>
                                <ChevronDown className={`w-4 h-4 text-white/30 transition-transform ${isExpanded ? 'rotate-180' : ''}`} />
                              </div>
                            </div>

                            {/* Expanded: Quick actions */}
                            {isExpanded && (
                              <div className="mt-3 pt-3 border-t border-white/10 space-y-3">
                                {/* Info row */}
                                <div className="flex gap-2 text-xs">
                                  {rel.birthday && (
                                    <span className="px-2 py-1 bg-white/5 rounded-lg">
                                      üéÇ {new Date(rel.birthday).toLocaleDateString('es', { day: 'numeric', month: 'short' })}
                                    </span>
                                  )}
                                  {rel.contactFrequency && (
                                    <span className="px-2 py-1 bg-white/5 rounded-lg">
                                      üîÑ {frequencyDays[rel.contactFrequency] === 1 ? 'Diario' :
                                        frequencyDays[rel.contactFrequency] === 7 ? 'Semanal' :
                                          frequencyDays[rel.contactFrequency] === 14 ? 'Quincenal' :
                                            frequencyDays[rel.contactFrequency] === 30 ? 'Mensual' : 'Trimestral'}
                                    </span>
                                  )}
                                </div>

                                {/* Notes/Interests */}
                                {(rel.notes || rel.interests || rel.pendingTopics) && (
                                  <div className="bg-white/5 rounded-lg p-2 space-y-1">
                                    {rel.interests && (
                                      <p className="text-xs text-white/60">
                                        <span className="text-white/40">Intereses:</span> {rel.interests}
                                      </p>
                                    )}
                                    {rel.pendingTopics && (
                                      <p className="text-xs text-amber-400/80">
                                        <span className="text-white/40">Pendiente:</span> {rel.pendingTopics}
                                      </p>
                                    )}
                                    {rel.notes && (
                                      <p className="text-xs text-white/50 italic">üìù {rel.notes}</p>
                                    )}
                                  </div>
                                )}

                                {/* Love language tip */}
                                {rel.loveLanguage && (
                                  <p className="text-[10px] text-pink-400/70 flex items-center gap-1">
                                    üí° Tip: {loveLanguages[rel.loveLanguage]?.icon} {loveLanguages[rel.loveLanguage]?.name}
                                  </p>
                                )}

                                {/* Interaction input */}
                                <input
                                  type="text"
                                  value={relInteractionNote}
                                  onChange={(e) => setRelInteractionNote(e.target.value)}
                                  placeholder="Nota del contacto (opcional)..."
                                  className="w-full bg-white/5 rounded-lg px-3 py-2 text-sm"
                                />

                                <div className="flex gap-2">
                                  <button
                                    onClick={() => logInteraction(rel.id)}
                                    className="flex-1 py-2 bg-pink-500 rounded-lg text-sm font-medium"
                                  >
                                    ‚úì Registrar contacto
                                  </button>
                                  <button
                                    onClick={() => setScreen('relationships')}
                                    className="py-2 px-3 bg-white/10 rounded-lg text-sm"
                                  >
                                    Ver m√°s
                                  </button>
                                </div>
                              </div>
                            )}
                          </Card>
                        );
                      })
                    ) : (
                      <Card className="py-4 text-center">
                        <p className="text-white/40 text-sm">‚ú® Todas las relaciones al d√≠a</p>
                      </Card>
                    )}

                    {needsAttention.length > 4 && (
                      <p className="text-center text-xs text-pink-400">
                        +{needsAttention.length - 4} m√°s necesitan atenci√≥n
                      </p>
                    )}

                    {/* Add contact button or form */}
                    {relShowAddContact ? (
                      <Card className="py-3 space-y-2">
                        <input
                          type="text"
                          value={relNewContact.name}
                          onChange={(e) => setRelNewContact(prev => ({ ...prev, name: e.target.value }))}
                          placeholder="Nombre"
                          className="w-full bg-white/5 rounded-lg px-3 py-2 text-sm"
                          autoFocus
                        />
                        <div className="flex gap-2">
                          <select
                            value={relNewContact.category}
                            onChange={(e) => setRelNewContact(prev => ({ ...prev, category: e.target.value }))}
                            className="flex-1"
                          >
                            {Object.entries(categories).map(([id, cat]) => (
                              <option key={id} value={id}>{cat.icon} {cat.name}</option>
                            ))}
                          </select>
                          <select
                            value={relNewContact.contactFrequency}
                            onChange={(e) => setRelNewContact(prev => ({ ...prev, contactFrequency: e.target.value }))}
                            className="flex-1"
                          >
                            <option value="daily">Diario</option>
                            <option value="weekly">Semanal</option>
                            <option value="biweekly">Quincenal</option>
                            <option value="monthly">Mensual</option>
                            <option value="quarterly">Trimestral</option>
                          </select>
                        </div>
                        <div className="flex gap-2">
                          <div className="flex-1">
                            <label className="text-[10px] text-white/40 mb-1 block">Cumplea√±os</label>
                            <input
                              type="date"
                              value={relNewContact.birthday || ''}
                              onChange={(e) => setRelNewContact(prev => ({ ...prev, birthday: e.target.value }))}
                              className="w-full"
                            />
                          </div>
                          <div className="flex-1">
                            <label className="text-[10px] text-white/40 mb-1 block">Lenguaje de amor</label>
                            <select
                              value={relNewContact.loveLanguage || ''}
                              onChange={(e) => setRelNewContact(prev => ({ ...prev, loveLanguage: e.target.value }))}
                              className="w-full"
                            >
                              <option value="">-- Opcional --</option>
                              {Object.entries(loveLanguages).map(([id, lang]) => (
                                <option key={id} value={id}>{lang.icon} {lang.name}</option>
                              ))}
                            </select>
                          </div>
                        </div>
                        <div className="flex gap-2">
                          <button
                            onClick={() => setRelShowAddContact(false)}
                            className="flex-1 py-2 bg-white/10 rounded-lg text-sm"
                          >
                            Cancelar
                          </button>
                          <button
                            onClick={addContact}
                            disabled={!relNewContact.name.trim()}
                            className="flex-1 py-2 bg-pink-500 rounded-lg text-sm font-medium disabled:opacity-30"
                          >
                            A√±adir
                          </button>
                        </div>
                      </Card>
                    ) : (
                      <button
                        onClick={() => setRelShowAddContact(true)}
                        className="w-full py-2 bg-pink-500/20 border border-pink-500/30 rounded-lg text-sm text-pink-400 flex items-center justify-center gap-2"
                      >
                        <Plus className="w-4 h-4" /> A√±adir contacto
                      </button>
                    )}
                  </div>
                </AccordionSection>
              </AnimatedMount>
            );
          })()}

          {/* ==================== SPIRIT ==================== */}
          {activeAreas.includes('consciousness') && (() => {
            const cons = data.consciousness || {};
            const gratitudeToday = cons.gratitude?.[viewDate] || [];
            const journalToday = cons.journal?.[viewDate];
            const breathingToday = cons.breathingSessions?.filter(s => s.date === viewDate).length || 0;
            const practiceToday = cons.practices?.find(p => p.date === viewDate);

            // Path info
            const pathId = cons.activePath;
            const pathPaused = cons.pathPaused;
            const startingLevel = cons.startingLevel || 0;
            const currentLevel = cons.currentLevel || 0;
            const effectiveLevel = startingLevel + currentLevel;

            // Get path details
            const pathsData = {
              hawkins: { name: 'Escala de Conciencia', icon: '‚ö°', color: '#8B5CF6' },
              maslow: { name: 'Pir√°mide de Maslow', icon: 'üèîÔ∏è', color: '#10B981' },
              wilber: { name: 'Espiral Din√°mica', icon: 'üåÄ', color: '#F59E0B' }
            };
            const activePath = pathId ? pathsData[pathId] : null;

            // Calculate gratitude streak
            const getGratitudeStreak = () => {
              let streak = 0;
              let checkDate = viewDate;
              while (cons.gratitude?.[checkDate]?.some(g => g)) {
                streak++;
                const d = new Date(checkDate);
                d.setDate(d.getDate() - 1);
                checkDate = d.toISOString().split('T')[0];
              }
              return streak;
            };
            const streak = getGratitudeStreak();

            const completedItems = [
              gratitudeToday?.filter(g => g).length >= 3,
              !!journalToday?.text,
              breathingToday > 0,
              !!practiceToday
            ].filter(Boolean).length;

            // Breathing techniques
            const breathTechniques = {
              '478': { name: '4-7-8', inhale: 4, hold: 7, exhale: 8, holdOut: 0, rounds: 4 },
              'box': { name: 'Box', inhale: 4, hold: 4, exhale: 4, holdOut: 4, rounds: 4 }
            };

            // Save gratitude
            const saveConsGratitude = () => {
              const items = consGratitudeInputs.filter(g => g.trim());
              if (items.length === 0) return;
              setData(prev => ({
                ...prev,
                consciousness: {
                  ...prev.consciousness,
                  gratitude: { ...(prev.consciousness?.gratitude || {}), [viewDate]: items }
                }
              }));
              setConsGratitudeInputs(['', '', '']);
              setConsExpandedCard(null);
              showToast('üôè Gratitud guardada');
            };

            // Save journal
            const saveConsJournal = () => {
              if (!consJournalText.trim()) return;
              setData(prev => ({
                ...prev,
                consciousness: {
                  ...prev.consciousness,
                  journal: { ...(prev.consciousness?.journal || {}), [viewDate]: { text: consJournalText, mood: consJournalMood, timestamp: new Date().toISOString() } }
                }
              }));
              setConsJournalText('');
              setConsJournalMood(null);
              setConsExpandedCard(null);
              showToast('üìî Reflexi√≥n guardada');
            };

            // Complete breathing session
            const completeBreathing = () => {
              setData(prev => ({
                ...prev,
                consciousness: {
                  ...prev.consciousness,
                  breathingSessions: [...(prev.consciousness?.breathingSessions || []), { date: viewDate, technique: consBreathTechnique, timestamp: new Date().toISOString() }]
                }
              }));
              setConsBreathingActive(false);
              setConsBreathPhase('idle');
              setConsBreathTimer(0);
              setConsBreathRound(0);
              setConsExpandedCard(null);
              showToast('üßò Sesi√≥n completada');
            };

            const moods = [
              { id: 'amazing', emoji: 'ü§©' },
              { id: 'happy', emoji: 'üòä' },
              { id: 'calm', emoji: 'üòå' },
              { id: 'meh', emoji: 'üòê' },
              { id: 'anxious', emoji: 'üò∞' },
              { id: 'sad', emoji: 'üò¢' }
            ];

            const journalPrompts = [
              "¬øQu√© te hizo sentir vivo hoy?",
              "¬øQu√© aprendiste de ti mismo?",
              "¬øPor qu√© est√°s agradecido ahora?"
            ];

            // Hawkins levels for summary display
            const hawkinsLevelNames = [
              { name: 'Verg√ºenza', calibration: 20 },
              { name: 'Culpa', calibration: 30 },
              { name: 'Apat√≠a', calibration: 50 },
              { name: 'Pena', calibration: 75 },
              { name: 'Miedo', calibration: 100 },
              { name: 'Deseo', calibration: 125 },
              { name: 'Ira', calibration: 150 },
              { name: 'Orgullo', calibration: 175 },
              { name: 'Coraje', calibration: 200 },
              { name: 'Neutralidad', calibration: 250 },
              { name: 'Voluntad', calibration: 310 },
              { name: 'Aceptaci√≥n', calibration: 350 },
              { name: 'Raz√≥n', calibration: 400 },
              { name: 'Amor', calibration: 500 },
              { name: 'Alegr√≠a', calibration: 540 },
              { name: 'Paz', calibration: 600 },
              { name: 'Iluminaci√≥n', calibration: '700+' }
            ];
            const currentLevelData = pathId === 'hawkins' ? hawkinsLevelNames[effectiveLevel] : null;

            return (
              <AnimatedMount delay={185}>
                <AccordionSection
                  title="CONSCIENCIA"
                  icon={Sparkles}
                  iconColor="text-violet-400"
                  storageKey="consciousness"
                  progress={Math.round((completedItems / 4) * 100)}
                  progressColor="bg-gradient-to-r from-violet-500 to-fuchsia-500"
                  summary={
                    activePath && !pathPaused
                      ? `${currentLevelData?.name || 'Nivel ' + (effectiveLevel + 1)} ‚Ä¢ Cal. ${currentLevelData?.calibration || ''}`
                      : completedItems > 0
                        ? `${completedItems}/4 pr√°cticas`
                        : 'Empieza tu pr√°ctica'
                  }
                  summaryRight={streak > 0 ? `üî• ${streak}` : null}
                >
                  <div className="mt-2 space-y-2">

                    {/* GRATITUDE - Expandable */}
                    <Card
                      className={`py-2 transition-all ${gratitudeToday?.length >= 3 ? 'border-emerald-500/30' : ''} ${consExpandedCard === 'gratitude' ? 'border-violet-500/50' : ''}`}
                    >
                      <div
                        className="flex items-center justify-between cursor-pointer"
                        onClick={() => setConsExpandedCard(consExpandedCard === 'gratitude' ? null : 'gratitude')}
                      >
                        <div className="flex items-center gap-3">
                          <div className={`w-8 h-8 rounded-lg ${gratitudeToday?.length >= 3 ? 'bg-emerald-500/20' : 'bg-violet-500/20'} flex items-center justify-center`}>
                            <span className="text-lg">üôè</span>
                          </div>
                          <div>
                            <p className="text-sm font-medium">Gratitud</p>
                            <p className="text-[10px] text-white/40">
                              {gratitudeToday?.length || 0}/3 escritas
                              {streak > 1 && <span className="text-amber-400 ml-2">üî• {streak}</span>}
                            </p>
                          </div>
                        </div>
                        {gratitudeToday?.length >= 3 ? (
                          <Check className="w-5 h-5 text-emerald-400" />
                        ) : (
                          <ChevronDown className={`w-5 h-5 text-white/30 transition-transform ${consExpandedCard === 'gratitude' ? 'rotate-180' : ''}`} />
                        )}
                      </div>

                      {/* Expanded: Gratitude inputs */}
                      {consExpandedCard === 'gratitude' && (
                        <div className="mt-3 pt-3 border-t border-white/10 space-y-2">
                          {gratitudeToday?.length >= 3 ? (
                            <div className="space-y-1">
                              {gratitudeToday.map((g, i) => (
                                <div key={i} className="flex items-center gap-2 text-sm text-white/70">
                                  <span className="text-emerald-400">‚úì</span>
                                  <span>{g}</span>
                                </div>
                              ))}
                            </div>
                          ) : (
                            <>
                              {consGratitudeInputs.map((input, i) => (
                                <input
                                  key={i}
                                  type="text"
                                  value={input}
                                  onChange={(e) => {
                                    const newInputs = [...consGratitudeInputs];
                                    newInputs[i] = e.target.value;
                                    setConsGratitudeInputs(newInputs);
                                  }}
                                  placeholder={`${i + 1}. Agradezco...`}
                                  className="w-full bg-white/5 rounded-lg px-3 py-2 text-sm"
                                />
                              ))}
                              <button
                                onClick={saveConsGratitude}
                                disabled={!consGratitudeInputs.some(g => g.trim())}
                                className="w-full py-2 bg-violet-500 rounded-lg text-sm font-medium disabled:opacity-30"
                              >
                                Guardar
                              </button>
                            </>
                          )}
                        </div>
                      )}
                    </Card>

                    {/* JOURNAL - Expandable */}
                    <Card
                      className={`py-2 transition-all ${journalToday?.text ? 'border-amber-500/30' : ''} ${consExpandedCard === 'journal' ? 'border-violet-500/50' : ''}`}
                    >
                      <div
                        className="flex items-center justify-between cursor-pointer"
                        onClick={() => setConsExpandedCard(consExpandedCard === 'journal' ? null : 'journal')}
                      >
                        <div className="flex items-center gap-3">
                          <div className={`w-8 h-8 rounded-lg ${journalToday?.text ? 'bg-amber-500/20' : 'bg-violet-500/20'} flex items-center justify-center`}>
                            <span className="text-lg">üìî</span>
                          </div>
                          <div>
                            <p className="text-sm font-medium">Reflexi√≥n</p>
                            <p className="text-[10px] text-white/40">
                              {journalToday?.text ? `${journalToday.mood ? moods.find(m => m.id === journalToday.mood)?.emoji : ''} Escrito` : 'Reflexiona tu d√≠a'}
                            </p>
                          </div>
                        </div>
                        {journalToday?.text ? (
                          <Check className="w-5 h-5 text-amber-400" />
                        ) : (
                          <ChevronDown className={`w-5 h-5 text-white/30 transition-transform ${consExpandedCard === 'journal' ? 'rotate-180' : ''}`} />
                        )}
                      </div>

                      {/* Expanded: Journal input */}
                      {consExpandedCard === 'journal' && (
                        <div className="mt-3 pt-3 border-t border-white/10 space-y-3">
                          {journalToday?.text ? (
                            <div className="bg-white/5 rounded-lg p-3">
                              <div className="flex items-center gap-2 mb-2">
                                <span className="text-lg">{moods.find(m => m.id === journalToday.mood)?.emoji}</span>
                              </div>
                              <p className="text-sm text-white/70">{journalToday.text}</p>
                            </div>
                          ) : (
                            <>
                              <div className="bg-violet-500/10 rounded-lg p-2">
                                <p className="text-xs text-violet-400 italic">
                                  "{journalPrompts[new Date().getDay() % journalPrompts.length]}"
                                </p>
                              </div>
                              <div className="flex gap-1 justify-center">
                                {moods.map(mood => (
                                  <button
                                    key={mood.id}
                                    onClick={() => setConsJournalMood(mood.id)}
                                    className={`p-1.5 rounded-lg text-lg transition-all ${consJournalMood === mood.id ? 'bg-violet-500 scale-110' : 'bg-white/5'}`}
                                  >
                                    {mood.emoji}
                                  </button>
                                ))}
                              </div>
                              <textarea
                                value={consJournalText}
                                onChange={(e) => setConsJournalText(e.target.value)}
                                placeholder="Escribe tu reflexi√≥n..."
                                rows={3}
                                className="w-full bg-white/5 rounded-lg p-3 text-sm resize-none"
                              />
                              <button
                                onClick={saveConsJournal}
                                disabled={!consJournalText.trim()}
                                className="w-full py-2 bg-violet-500 rounded-lg text-sm font-medium disabled:opacity-30"
                              >
                                Guardar
                              </button>
                            </>
                          )}
                        </div>
                      )}
                    </Card>

                    {/* BREATHING - Expandable */}
                    <Card
                      className={`py-2 transition-all ${breathingToday > 0 ? 'border-blue-500/30' : ''} ${consExpandedCard === 'breathing' ? 'border-violet-500/50' : ''}`}
                    >
                      <div
                        className="flex items-center justify-between cursor-pointer"
                        onClick={() => !consBreathingActive && setConsExpandedCard(consExpandedCard === 'breathing' ? null : 'breathing')}
                      >
                        <div className="flex items-center gap-3">
                          <div className={`w-8 h-8 rounded-lg ${breathingToday > 0 ? 'bg-blue-500/20' : 'bg-violet-500/20'} flex items-center justify-center`}>
                            <span className="text-lg">üßò</span>
                          </div>
                          <div>
                            <p className="text-sm font-medium">Respiraci√≥n</p>
                            <p className="text-[10px] text-white/40">
                              {consBreathingActive
                                ? `${breathTechniques[consBreathTechnique].name} - ${consBreathPhase}`
                                : breathingToday > 0
                                  ? `${breathingToday} sesi√≥n${breathingToday > 1 ? 'es' : ''} hoy`
                                  : 'Calma tu mente'}
                            </p>
                          </div>
                        </div>
                        {breathingToday > 0 && !consBreathingActive ? (
                          <Check className="w-5 h-5 text-blue-400" />
                        ) : (
                          <ChevronDown className={`w-5 h-5 text-white/30 transition-transform ${consExpandedCard === 'breathing' ? 'rotate-180' : ''}`} />
                        )}
                      </div>

                      {/* Expanded: Breathing */}
                      {(consExpandedCard === 'breathing' || consBreathingActive) && (
                        <div className="mt-3 pt-3 border-t border-white/10">
                          {!consBreathingActive ? (
                            <div className="space-y-3">
                              <div className="flex gap-2">
                                {Object.entries(breathTechniques).map(([id, tech]) => (
                                  <button
                                    key={id}
                                    onClick={() => setConsBreathTechnique(id)}
                                    className={`flex-1 py-2 rounded-lg text-xs font-medium transition-all ${consBreathTechnique === id ? 'bg-violet-500' : 'bg-white/10'}`}
                                  >
                                    {tech.name}
                                  </button>
                                ))}
                              </div>
                              <button
                                onClick={() => {
                                  setConsBreathingActive(true);
                                  setConsBreathPhase('inhale');
                                  setConsBreathTimer(0);
                                  setConsBreathRound(0);
                                }}
                                className="w-full py-3 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-lg font-medium"
                              >
                                Comenzar
                              </button>
                            </div>
                          ) : (
                            <div className="text-center py-4">
                              <div className={`w-24 h-24 mx-auto rounded-full flex items-center justify-center mb-3 transition-all duration-1000 ${consBreathPhase === 'inhale' ? 'scale-110 bg-blue-500/40' :
                                consBreathPhase === 'hold' ? 'scale-110 bg-violet-500/40' :
                                  consBreathPhase === 'exhale' ? 'scale-90 bg-cyan-500/40' :
                                    'scale-90 bg-white/10'
                                }`}>
                                <div className="text-center">
                                  <p className="text-xs text-white/50 capitalize">{consBreathPhase}</p>
                                  <p className="text-2xl font-bold">{Math.ceil(consBreathTimer)}</p>
                                </div>
                              </div>
                              <p className="text-xs text-white/40 mb-3">
                                Ronda {consBreathRound + 1} / {breathTechniques[consBreathTechnique].rounds}
                              </p>
                              <div className="flex gap-2">
                                <button
                                  onClick={() => {
                                    setConsBreathingActive(false);
                                    setConsBreathPhase('idle');
                                    setConsBreathTimer(0);
                                    setConsBreathRound(0);
                                  }}
                                  className="flex-1 py-2 bg-white/10 rounded-lg text-sm"
                                >
                                  Cancelar
                                </button>
                                <button
                                  onClick={completeBreathing}
                                  className="flex-1 py-2 bg-emerald-500 rounded-lg text-sm font-medium"
                                >
                                  Completar
                                </button>
                              </div>
                            </div>
                          )}
                        </div>
                      )}
                    </Card>

                    {/* Active Path - Expandable with practice */}
                    {activePath && !pathPaused && (() => {
                      // Hawkins levels data with full content for TodayScreen
                      const hawkinsLevels = [
                        {
                          name: 'Verg√ºenza', calibration: 20, minimumDays: 14,
                          teaching: 'La verg√ºenza es el nivel m√°s bajo de consciencia. Aqu√≠ sientes que eres fundamentalmente defectuoso, que hay algo mal en tu existencia misma.',
                          signs: ['Evitas mirarte al espejo o en fotos', 'Sientes que no mereces cosas buenas', 'Te escondes de situaciones sociales'],
                          trap: 'Creer que si te escondes lo suficiente, el dolor desaparecer√°.',
                          exit: 'Reconocer que la verg√ºenza es una emoci√≥n, no una verdad sobre qui√©n eres.',
                          practice: 'Hoy, cuando notes verg√ºenza, no huyas. Respira y di: "Esto tambi√©n es parte de ser humano."',
                          affirmation: 'Tengo derecho a existir, incluso con mis imperfecciones.',
                          journalQuestion: '¬øQu√© parte de m√≠ he estado escondiendo por verg√ºenza?'
                        },
                        {
                          name: 'Culpa', calibration: 30, minimumDays: 14,
                          teaching: 'En culpa, ya no te escondes pero te castigas. Crees que mereces sufrir por lo que hiciste o dejaste de hacer.',
                          signs: ['Te disculpas excesivamente', 'Revives errores pasados constantemente', 'Sientes que debes compensar algo'],
                          trap: 'Pensar que sufrir lo suficiente eventualmente te redimir√°.',
                          exit: 'Entender que el perd√≥n (especialmente el auto-perd√≥n) es posible.',
                          practice: 'Escribe una carta de perd√≥n a ti mismo por algo que a√∫n te pesa. No tienes que enviarla.',
                          affirmation: 'Merezco perd√≥n, empezando por el m√≠o propio.',
                          journalQuestion: '¬øQu√© error pasado sigo cargando que ya es hora de soltar?'
                        },
                        {
                          name: 'Apat√≠a', calibration: 50, minimumDays: 14,
                          teaching: 'La apat√≠a es desesperanza cristalizada. Ya no sientes verg√ºenza ni culpa porque dejaste de intentar.',
                          signs: ['Nada parece importar', 'Dices "¬øpara qu√©?" frecuentemente', 'Descuidas tu cuidado personal'],
                          trap: 'La comodidad de no intentar nada para no fallar en nada.',
                          exit: 'Una chispa de deseo, aunque sea peque√±a: querer algo.',
                          practice: 'Haz UNA cosa peque√±a hoy, aunque no "sientas" hacerla. Lava un plato. Da una vuelta a la manzana.',
                          affirmation: 'Cada peque√±o paso cuenta, aunque no lo sienta.',
                          journalQuestion: '¬øQu√© peque√±a cosa me gustar√≠a que fuera diferente?'
                        },
                        {
                          name: 'Pena', calibration: 75, minimumDays: 10,
                          teaching: 'En pena hay energ√≠a de nuevo, pero es energ√≠a de p√©rdida. Sientes, y lo que sientes es tristeza.',
                          signs: ['Lloras con facilidad o desear√≠as poder llorar', 'Vives en el pasado', 'Sientes un vac√≠o persistente'],
                          trap: 'Identificarte con tus p√©rdidas, hacer de la tristeza tu identidad.',
                          exit: 'Permitir la tristeza sin aferrarte a ella. Dejarla fluir.',
                          practice: 'Permite 5 minutos de tristeza consciente. Pon un timer si quieres. Despu√©s, nota que sigues aqu√≠.',
                          affirmation: 'Mis p√©rdidas me han formado, pero no me definen.',
                          journalQuestion: '¬øQu√© p√©rdida necesito honrar y comenzar a soltar?'
                        },
                        {
                          name: 'Miedo', calibration: 100, minimumDays: 10,
                          teaching: 'El miedo indica que hay algo que valoras lo suficiente como para temer perderlo. Es energ√≠a de supervivencia.',
                          signs: ['Anticipas lo peor constantemente', 'Evitas situaciones por "si acaso"', 'Tu cuerpo est√° frecuentemente tenso'],
                          trap: 'Organizar tu vida alrededor de evitar lo que temes.',
                          exit: 'Descubrir que puedes sentir miedo y actuar de todos modos.',
                          practice: 'Identifica UN miedo concreto hoy. Preg√∫ntate: "¬øQu√© har√≠a si no tuviera este miedo?"',
                          affirmation: 'El miedo es informaci√≥n, no una orden.',
                          journalQuestion: '¬øQu√© har√≠a diferente si no tuviera miedo?'
                        },
                        {
                          name: 'Deseo', calibration: 125, minimumDays: 10,
                          teaching: 'El deseo es la primera energ√≠a realmente hacia afuera. Quieres algo. El problema es que crees que eso te completar√°.',
                          signs: ['Siempre quieres m√°s de algo', 'La satisfacci√≥n dura poco', 'Comparas lo que tienes con lo que otros tienen'],
                          trap: 'Creer que el pr√≥ximo logro/compra/relaci√≥n finalmente te har√° feliz.',
                          exit: 'Distinguir entre deseos del ego y necesidades genuinas.',
                          practice: 'Nota tres deseos que surjan hoy. Por cada uno pregunta: "¬øQu√© necesidad m√°s profunda hay debajo?"',
                          affirmation: 'Mis deseos me se√±alan algo, pero no me controlan.',
                          journalQuestion: '¬øQu√© creo que me falta para estar completo?'
                        },
                        {
                          name: 'Ira', calibration: 150, minimumDays: 10,
                          teaching: 'La ira es poder. Por primera vez tienes energ√≠a para cambiar las cosas. El riesgo es destruir en vez de construir.',
                          signs: ['Te frustras f√°cilmente', 'Culpas a otros de tus problemas', 'Sientes que el mundo es injusto contigo'],
                          trap: 'Quedarte en la queja y el resentimiento sin pasar a la acci√≥n constructiva.',
                          exit: 'Canalizar la energ√≠a de la ira hacia cambio real, no hacia destrucci√≥n.',
                          practice: 'Canaliza la energ√≠a de cualquier frustraci√≥n en algo f√≠sico: limpia, ordena, camina r√°pido.',
                          affirmation: 'Mi ira tiene un mensaje; puedo escucharlo sin ser consumido.',
                          journalQuestion: '¬øQu√© me est√° diciendo mi ira que necesita cambiar?'
                        },
                        {
                          name: 'Orgullo', calibration: 175, minimumDays: 10,
                          teaching: 'El orgullo se siente bien comparado con los niveles anteriores. Pero depende de circunstancias externas y de compararte con otros.',
                          signs: ['Necesitas tener raz√≥n', 'Te cuesta admitir errores', 'Tu autoestima sube y baja seg√∫n logros'],
                          trap: 'Basar tu valor en ser "mejor que" otros.',
                          exit: 'Desarrollar autoestima basada en qui√©n eres, no en c√≥mo te comparas.',
                          practice: 'Practica decir "no s√©" o "me equivoqu√©" al menos una vez hoy, genuinamente.',
                          affirmation: 'No necesito tener raz√≥n para tener valor.',
                          journalQuestion: '¬øEn qu√© √°rea necesito soltar la necesidad de tener raz√≥n?'
                        },
                        {
                          name: 'Coraje', calibration: 200, minimumDays: 7,
                          teaching: '¬°Felicidades! Cruzaste la l√≠nea del 200. Aqu√≠ la vida deja de ser algo que te pasa y empieza a ser algo que creas.',
                          signs: ['Tomas responsabilidad de tu vida', 'Ves problemas como desaf√≠os', 'Act√∫as a pesar del miedo'],
                          trap: 'Forzar resultados, creer que todo depende solo de tu esfuerzo.',
                          exit: 'Combinar acci√≥n con aceptaci√≥n de lo que no controlas.',
                          practice: 'Haz algo que te d√© un poco de miedo pero que sabes que es correcto. Empieza peque√±o.',
                          affirmation: 'Tengo el poder de cambiar mi vida, un paso a la vez.',
                          journalQuestion: '¬øQu√© acci√≥n he estado postergando por miedo?'
                        },
                        {
                          name: 'Neutralidad', calibration: 250, minimumDays: 7,
                          teaching: 'En neutralidad descubres que puedes estar bien independientemente de las circunstancias. Dejas de necesitar que las cosas sean de cierta manera.',
                          signs: ['Los problemas te afectan menos', 'Eres flexible ante cambios', 'No necesitas controlar todo'],
                          trap: 'Confundir desapego con indiferencia.',
                          exit: 'Mantener preferencias sin convertirlas en exigencias.',
                          practice: 'Ante cada situaci√≥n hoy, pausa y pregunta: "¬øPuedo estar bien sin importar c√≥mo resulte esto?"',
                          affirmation: 'Estoy bien independientemente de las circunstancias.',
                          journalQuestion: '¬øA qu√© resultado estoy demasiado apegado?'
                        },
                        {
                          name: 'Voluntad', calibration: 310, minimumDays: 7,
                          teaching: 'La voluntad es decir S√ç a la vida. No es fuerza de voluntad (eso es coraje), es disponibilidad genuina.',
                          signs: ['Est√°s abierto a aprender', 'Dices s√≠ m√°s que no', 'La vida fluye m√°s f√°cilmente'],
                          trap: 'Decir s√≠ a todo sin discernimiento.',
                          exit: 'Desarrollar criterio sobre d√≥nde poner tu energ√≠a.',
                          practice: 'Di "s√≠" genuinamente a algo que normalmente resistir√≠as. Observa qu√© cambia.',
                          affirmation: 'La vida me apoya cuando yo apoyo a la vida.',
                          journalQuestion: '¬øA qu√© he estado diciendo "no" que podr√≠a intentar?'
                        },
                        {
                          name: 'Aceptaci√≥n', calibration: 350, minimumDays: 7,
                          teaching: 'Aceptaci√≥n no es resignaci√≥n. Es trabajar con la realidad tal como es, no como desear√≠as que fuera.',
                          signs: ['No luchas contra lo que es', 'Ves la perfecci√≥n en la imperfecci√≥n', 'Perdonas con m√°s facilidad'],
                          trap: 'Usar aceptaci√≥n como excusa para no actuar.',
                          exit: 'Aceptar Y actuar: trabajar desde donde est√°s hacia donde quieres ir.',
                          practice: 'Elige una situaci√≥n dif√≠cil y di internamente: "Esto es lo que es. ¬øQu√© puedo hacer desde aqu√≠?"',
                          affirmation: 'Acepto la realidad tal como es y trabajo desde ah√≠.',
                          journalQuestion: '¬øQu√© situaci√≥n estoy resistiendo que necesito aceptar primero?'
                        },
                        {
                          name: 'Raz√≥n', calibration: 400, minimumDays: 7,
                          teaching: 'La raz√≥n es el pico del intelecto. Aqu√≠ puedes entender sistemas complejos y ver patrones que otros no ven.',
                          signs: ['Analizas las cosas profundamente', 'Valoras datos y l√≥gica', 'Puedes ver m√∫ltiples perspectivas'],
                          trap: 'Creer que todo puede entenderse con la mente. Par√°lisis por an√°lisis.',
                          exit: 'Reconocer los l√≠mites del intelecto. Abrirse a otras formas de conocer.',
                          practice: 'Ante un problema, separa hechos de interpretaciones. Lista ambos en columnas separadas.',
                          affirmation: 'Mi mente es una herramienta poderosa al servicio de algo mayor.',
                          journalQuestion: '¬øD√≥nde estoy sobre-analizando en vez de actuar o sentir?'
                        },
                        {
                          name: 'Amor', calibration: 500, minimumDays: 7,
                          teaching: 'Amor incondicional. No es una emoci√≥n, es una forma de ver. Ves la esencia detr√°s de las formas.',
                          signs: ['Sientes conexi√≥n con extra√±os', 'Ves lo mejor en las personas', 'El perd√≥n es natural'],
                          trap: 'Negar el mal o el sufrimiento por querer ver solo amor.',
                          exit: 'Integrar amor con discernimiento. Amar no significa permitir todo.',
                          practice: 'Env√≠a genuinamente buenos deseos a alguien dif√≠cil. No por ellos, sino por lo que hace en ti.',
                          affirmation: 'El amor no es algo que busco; es lo que soy cuando dejo de buscar.',
                          journalQuestion: '¬øA qui√©n me cuesta amar y qu√© me ense√±a eso de m√≠?'
                        },
                        {
                          name: 'Alegr√≠a', calibration: 540, minimumDays: 7,
                          teaching: 'La alegr√≠a no depende de nada externo. Es el estado natural cuando dejas de interferir.',
                          signs: ['Sonr√≠es sin raz√≥n aparente', 'Todo parece m√°s vivo y brillante', 'La gratitud es constante'],
                          trap: 'Apegarte a la alegr√≠a y temerle a perderla.',
                          exit: 'Dejar que la alegr√≠a venga y vaya sin aferrarte.',
                          practice: 'Busca la perfecci√≥n oculta en algo "ordinario" hoy: una taza de caf√©, la luz en una ventana.',
                          affirmation: 'La alegr√≠a est√° disponible ahora, sin condiciones.',
                          journalQuestion: '¬øD√≥nde estoy buscando alegr√≠a fuera cuando ya est√° aqu√≠?'
                        },
                        {
                          name: 'Paz', calibration: 600, minimumDays: 7,
                          teaching: 'La paz trasciende la alegr√≠a. No hay nada que lograr, nada que probar. Todo simplemente es.',
                          signs: ['Silencio mental profundo', 'Sensaci√≥n de completitud', 'El tiempo parece diferente'],
                          trap: 'Quedarse en la paz sin compartirla.',
                          exit: 'Permitir que la paz se exprese a trav√©s de ti hacia el mundo.',
                          practice: 'Dedica 10 minutos a no hacer nada. No meditar, no respirar conscientemente. Solo ser.',
                          affirmation: 'La paz no es algo que logro; es lo que queda cuando dejo de luchar.',
                          journalQuestion: '¬øQu√© pasar√≠a si dejara de esforzarme por un momento?'
                        },
                        {
                          name: 'Iluminaci√≥n', calibration: '700+', minimumDays: 7,
                          teaching: 'La consciencia pura. No hay separaci√≥n entre t√∫ y el todo. Extremadamente raro de forma permanente.',
                          signs: ['No hay "yo" separado', 'Todo es percibido como uno', 'Presencia radiante natural'],
                          trap: 'No hay trampa aqu√≠. Pero tampoco hay nadie para quedar atrapado.',
                          exit: 'No hay salida porque no hay lugar adonde ir.',
                          practice: 'Vive este d√≠a como si cada momento fuera exactamente como debe ser. Porque lo es.',
                          affirmation: 'Todo es uno. No hay nada que buscar.',
                          journalQuestion: '¬øQui√©n soy cuando dejo de definirme?'
                        }
                      ];

                      const currentLevelData = hawkinsLevels[effectiveLevel] || hawkinsLevels[0];

                      // Calculate days in level
                      const practicesInLevel = (cons.practices || []).filter(p =>
                        p.pathId === pathId && p.levelName === currentLevelData.name
                      );
                      const daysWithPractice = new Set(practicesInLevel.map(p => p.date)).size;
                      const minDays = currentLevelData.minimumDays || 7;

                      // XP calculation
                      const currentXP = cons.currentXP || 0;
                      const xpForNextLevel = 100 * (currentLevel + 1);

                      // Log practice function
                      const logConsPractice = () => {
                        setData(prev => ({
                          ...prev,
                          consciousness: {
                            ...prev.consciousness,
                            practices: [
                              ...(prev.consciousness?.practices || []),
                              {
                                id: Date.now(),
                                date: viewDate,
                                pathId: pathId,
                                levelName: currentLevelData.name,
                                practice: currentLevelData.practice,
                                notes: consPracticeNotes,
                                xp: 25,
                                timestamp: new Date().toISOString()
                              }
                            ],
                            totalXP: (prev.consciousness?.totalXP || 0) + 25,
                            currentXP: (prev.consciousness?.currentXP || 0) + 25
                          }
                        }));
                        setConsPracticeNotes('');
                        setConsExpandedCard(null);
                        showToast('‚ö° +25 XP - Pr√°ctica completada');
                      };

                      return (
                        <Card
                          className={`py-2 border-violet-500/30 bg-gradient-to-r from-violet-500/10 to-fuchsia-500/10 transition-all ${consExpandedCard === 'practice' ? 'border-violet-500/50' : ''}`}
                        >
                          <div
                            className="flex items-center justify-between cursor-pointer"
                            onClick={() => setConsExpandedCard(consExpandedCard === 'practice' ? null : 'practice')}
                          >
                            <div className="flex items-center gap-3">
                              <div className="w-8 h-8 rounded-lg bg-violet-500/20 flex items-center justify-center">
                                <span className="text-lg">{activePath.icon}</span>
                              </div>
                              <div>
                                <p className="text-sm font-medium">{currentLevelData.name}</p>
                                <p className="text-[10px] text-white/40">
                                  Nivel {effectiveLevel + 1} ‚Ä¢ Cal. {currentLevelData.calibration}
                                  {practiceToday && <span className="text-emerald-400 ml-2">‚úì Hecho</span>}
                                </p>
                              </div>
                            </div>
                            {practiceToday ? (
                              <Check className="w-5 h-5 text-violet-400" />
                            ) : (
                              <ChevronDown className={`w-5 h-5 text-white/30 transition-transform ${consExpandedCard === 'practice' ? 'rotate-180' : ''}`} />
                            )}
                          </div>

                          {/* Expanded: Full level content */}
                          {consExpandedCard === 'practice' && (
                            <div className="mt-3 pt-3 border-t border-white/10 space-y-3">

                              {/* Progress stats */}
                              <div className="flex items-center gap-3">
                                <div className="flex-1 bg-white/5 rounded-lg p-2 text-center">
                                  <p className="text-lg font-bold">{daysWithPractice}</p>
                                  <p className="text-[10px] text-white/40">d√≠as practicando</p>
                                </div>
                                <div className="flex-1 bg-white/5 rounded-lg p-2 text-center">
                                  <p className="text-lg font-bold">{minDays}</p>
                                  <p className="text-[10px] text-white/40">m√≠nimo</p>
                                </div>
                                <div className="flex-1 bg-white/5 rounded-lg p-2 text-center">
                                  <p className="text-lg font-bold">{currentXP}</p>
                                  <p className="text-[10px] text-white/40">XP</p>
                                </div>
                              </div>

                              {/* XP Progress bar */}
                              <div>
                                <div className="flex justify-between text-[10px] text-white/40 mb-1">
                                  <span>Progreso XP</span>
                                  <span>{currentXP}/{xpForNextLevel}</span>
                                </div>
                                <div className="h-1.5 bg-white/10 rounded-full overflow-hidden">
                                  <div
                                    className="h-full bg-gradient-to-r from-violet-500 to-fuchsia-500 transition-all"
                                    style={{ width: `${Math.min(100, (currentXP / xpForNextLevel) * 100)}%` }}
                                  />
                                </div>
                              </div>

                              {/* Teaching */}
                              <div className="bg-white/5 rounded-lg p-3">
                                <p className="text-xs text-violet-400 mb-1">üìñ Ense√±anza</p>
                                <p className="text-xs text-white/70 leading-relaxed">{currentLevelData.teaching}</p>
                              </div>

                              {/* Signs */}
                              <div className="bg-amber-500/10 rounded-lg p-3">
                                <p className="text-xs text-amber-400 mb-2">‚ö° Se√±ales de este nivel</p>
                                <div className="space-y-1">
                                  {currentLevelData.signs.map((sign, i) => (
                                    <p key={i} className="text-xs text-white/60 flex items-start gap-2">
                                      <span className="text-amber-400">‚Ä¢</span> {sign}
                                    </p>
                                  ))}
                                </div>
                              </div>

                              {/* Trap & Exit */}
                              <div className="grid grid-cols-2 gap-2">
                                <div className="bg-red-500/10 rounded-lg p-2">
                                  <p className="text-[10px] text-red-400 mb-1">üö´ Trampa</p>
                                  <p className="text-[10px] text-white/60">{currentLevelData.trap}</p>
                                </div>
                                <div className="bg-emerald-500/10 rounded-lg p-2">
                                  <p className="text-[10px] text-emerald-400 mb-1">üö™ Salida</p>
                                  <p className="text-[10px] text-white/60">{currentLevelData.exit}</p>
                                </div>
                              </div>

                              {/* Journal Question */}
                              <div className="bg-cyan-500/10 rounded-lg p-3">
                                <p className="text-xs text-cyan-400 mb-1">üí≠ Pregunta de reflexi√≥n</p>
                                <p className="text-sm italic text-white/70">"{currentLevelData.journalQuestion}"</p>
                              </div>

                              {/* Practice section */}
                              {practiceToday ? (
                                <div className="bg-emerald-500/10 rounded-lg p-3">
                                  <p className="text-xs text-emerald-400 mb-1">‚úì Pr√°ctica completada hoy</p>
                                  <p className="text-xs text-white/60">{practiceToday.practice}</p>
                                  {practiceToday.notes && (
                                    <p className="text-xs text-white/40 mt-2 italic">"{practiceToday.notes}"</p>
                                  )}
                                </div>
                              ) : (
                                <>
                                  <div className="bg-violet-500/10 rounded-lg p-3">
                                    <p className="text-xs text-violet-400 mb-1">üéØ Pr√°ctica del d√≠a</p>
                                    <p className="text-sm text-white/80">{currentLevelData.practice}</p>
                                  </div>

                                  <div className="bg-white/5 rounded-lg p-2">
                                    <p className="text-xs italic text-white/50">"{currentLevelData.affirmation}"</p>
                                  </div>

                                  <textarea
                                    value={consPracticeNotes}
                                    onChange={(e) => setConsPracticeNotes(e.target.value)}
                                    placeholder="Notas sobre tu pr√°ctica (opcional)..."
                                    rows={2}
                                    className="w-full bg-white/5 rounded-lg p-2 text-sm resize-none"
                                  />

                                  <button
                                    onClick={logConsPractice}
                                    className="w-full py-2.5 bg-gradient-to-r from-violet-500 to-fuchsia-500 rounded-lg text-sm font-medium"
                                  >
                                    Completar pr√°ctica (+25 XP)
                                  </button>
                                </>
                              )}

                              {/* Link to full screen */}
                              <button
                                onClick={() => setScreen('consciousness')}
                                className="w-full py-1.5 text-xs text-violet-400 hover:text-violet-300"
                              >
                                Ver camino completo ‚Üí
                              </button>
                            </div>
                          )}
                        </Card>
                      );
                    })()}

                    {/* Quick link to start path if none active */}
                    {!activePath && (
                      <button
                        onClick={() => setScreen('consciousness')}
                        className="w-full py-2 bg-violet-500/20 border border-violet-500/30 rounded-lg text-sm text-violet-400"
                      >
                        + Comenzar un camino de consciencia
                      </button>
                    )}
                  </div>
                </AccordionSection>
              </AnimatedMount>
            );
          })()}

          {/* Year Overview - 365 days calendar - at the end for reflection */}
          <AnimatedMount delay={195}>
            {(() => {
              const yearStart = new Date(calendarYear, 0, 1);
              const todayDate = new Date(getToday());
              const viewingDate = new Date(viewDate);
              const thisYear = new Date().getFullYear();

              const dayOfYear = calendarYear === viewingDate.getFullYear()
                ? Math.floor((viewingDate - yearStart) / (1000 * 60 * 60 * 24)) + 1
                : null;
              const totalDays = ((calendarYear % 4 === 0 && calendarYear % 100 !== 0) || calendarYear % 400 === 0) ? 366 : 365;

              const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
              const monthData = months.map((name, monthIndex) => {
                const daysInMonth = new Date(calendarYear, monthIndex + 1, 0).getDate();
                const days = [];

                for (let d = 1; d <= daysInMonth; d++) {
                  const date = new Date(calendarYear, monthIndex, d);
                  const dateStr = date.toISOString().split('T')[0];

                  if (date <= todayDate) {
                    const dayInfo = data.days[dateStr];
                    const dayHabitsData = data.habitLogs?.filter(l => l.date === dateStr) || [];
                    const dayMealsData = data.meals.filter(m => m.day_id === dateStr);
                    const dayTasksData = data.tasks.filter(t => t.day_id === dateStr);
                    const dayWorkoutData = data.workouts.find(w => w.day_id === dateStr);
                    const score = calculateDayScore(dayInfo, dayHabitsData, dayMealsData, dayTasksData, dayWorkoutData, data.user.goals);
                    days.push({ day: d, date: dateStr, score, hasData: score > 0 });
                  } else {
                    days.push({ day: d, date: dateStr, score: 0, hasData: false, isFuture: true });
                  }
                }

                const daysWithData = days.filter(d => d.hasData);
                const avgScore = daysWithData.length > 0 ? Math.round(daysWithData.reduce((s, d) => s + d.score, 0) / daysWithData.length) : 0;

                return { name, monthIndex, days, daysInMonth, avgScore, daysWithData: daysWithData.length };
              });

              const allDaysWithData = monthData.flatMap(m => m.days.filter(d => d.hasData));
              const avgScore = allDaysWithData.length > 0 ? Math.round(allDaysWithData.reduce((s, d) => s + d.score, 0) / allDaysWithData.length) : 0;
              const goodDays = allDaysWithData.filter(d => d.score >= 60).length;
              const perfectDays = allDaysWithData.filter(d => d.score >= 80).length;

              const getScoreColor = (score) => {
                if (score >= 90) return 'bg-emerald-400';
                if (score >= 80) return 'bg-emerald-500';
                if (score >= 70) return 'bg-lime-400';
                if (score >= 60) return 'bg-lime-500';
                if (score >= 50) return 'bg-yellow-400';
                if (score >= 40) return 'bg-amber-400';
                if (score >= 30) return 'bg-amber-500';
                if (score >= 20) return 'bg-orange-400';
                if (score >= 10) return 'bg-orange-500';
                return 'bg-red-500';
              };

              const currentMonth = calendarYear === thisYear ? new Date().getMonth() : -1;
              const viewingMonth = calendarYear === viewingDate.getFullYear() ? viewingDate.getMonth() : -1;

              return (
                <Card className="py-3">
                  <div className="flex items-center justify-between mb-2">
                    <button
                      onClick={() => setCalendarYear(calendarYear - 1)}
                      className="p-1 hover:bg-white/10 rounded transition-colors"
                    >
                      <ChevronLeft className="w-3.5 h-3.5 text-white/40" />
                    </button>
                    <div className="text-center flex items-center gap-2">
                      <span className="text-xs font-medium text-white/70">üìÖ Tu a√±o {calendarYear}</span>
                      {dayOfYear && (
                        <span className="text-[9px] text-white/30">d√≠a {dayOfYear}/{totalDays}</span>
                      )}
                    </div>
                    <button
                      onClick={() => setCalendarYear(calendarYear + 1)}
                      className="p-1 hover:bg-white/10 rounded transition-colors"
                    >
                      <ChevronRight className="w-3.5 h-3.5 text-white/40" />
                    </button>
                  </div>

                  <div className="space-y-1.5 overflow-x-auto">
                    {monthData.map((month, i) => {
                      const isCurrentMonth = i === currentMonth;
                      const isViewingMonth = i === viewingMonth;

                      return (
                        <div key={i} className="flex items-center gap-2">
                          <span className={`text-[11px] w-8 flex-shrink-0 ${isCurrentMonth ? 'text-violet-400 font-bold' : isViewingMonth ? 'text-white font-medium' : 'text-white/50'}`}>
                            {month.name}
                          </span>
                          <div className="flex items-center gap-[2px] flex-shrink-0">
                            {month.days.map((day, di) => {
                              const isViewing = day.date === viewDate;
                              const isToday = day.date === getToday();

                              return (
                                <div
                                  key={di}
                                  onClick={() => setViewDate(day.date)}
                                  style={{
                                    width: '6px',
                                    height: '6px',
                                    borderRadius: '50%',
                                    backgroundColor: day.isFuture ? '#6b7280' : !day.hasData ? '#9ca3af' : undefined,
                                    boxShadow: isViewing ? '0 0 0 1.5px white' : isToday ? '0 0 0 1.5px #a78bfa' : undefined
                                  }}
                                  className={`cursor-pointer flex-shrink-0 ${!day.isFuture && day.hasData ? getScoreColor(day.score) : ''
                                    }`}
                                  title={`${day.day} ${month.name}: ${day.score} pts`}
                                />
                              );
                            })}
                          </div>
                          <span className={`text-[11px] ml-auto flex-shrink-0 font-medium ${month.avgScore >= 70 ? 'text-emerald-400' :
                            month.avgScore >= 50 ? 'text-amber-400' :
                              month.avgScore > 0 ? 'text-red-400' : 'text-white/30'
                            }`}>
                            {month.avgScore > 0 ? month.avgScore : '-'}
                          </span>
                        </div>
                      );
                    })}
                  </div>

                  <div className="flex items-center justify-between mt-2 pt-2 border-t border-white/10">
                    <div className="flex items-center gap-1 text-[8px] text-white/40">
                      <span>0</span>
                      <div className="w-2 h-2 rounded-full bg-red-500" />
                      <div className="w-2 h-2 rounded-full bg-orange-500" />
                      <div className="w-2 h-2 rounded-full bg-amber-500" />
                      <div className="w-2 h-2 rounded-full bg-yellow-400" />
                      <div className="w-2 h-2 rounded-full bg-lime-500" />
                      <div className="w-2 h-2 rounded-full bg-emerald-500" />
                      <span>100</span>
                    </div>
                    <div className="text-[9px] text-white/50">
                      {allDaysWithData.length > 0 ? (
                        <>
                          <span className="text-emerald-400">{perfectDays}</span> üíé ¬∑ <span className="text-lime-400">{goodDays}</span> ‚úì ¬∑ xÃÑ {avgScore}
                        </>
                      ) : (
                        <span>Sin datos</span>
                      )}
                    </div>
                  </div>

                  <p className="text-[8px] text-white/30 text-right mt-1">üíé perfectos (80+) ¬∑ ‚úì buenos (60+) ¬∑ xÃÑ media</p>
                </Card>
              );
            })()}
          </AnimatedMount>

          {/* Cierre del d√≠a - Evening Review */}
          <AnimatedMount delay={200}>
            <Card
              onClick={() => setShowJournal(true)}
              className={`bg-gradient-to-r ${dayJournal ? 'from-amber-500/20 to-orange-500/20 border-amber-500/30' : 'from-indigo-500/10 to-purple-500/10 border-indigo-500/20'}`}
            >
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className={`w-10 h-10 rounded-xl ${dayJournal ? 'bg-amber-500/20' : 'bg-indigo-500/20'} flex items-center justify-center`}>
                    <Moon className={`w-5 h-5 ${dayJournal ? 'text-amber-400' : 'text-indigo-400'}`} />
                  </div>
                  <div>
                    <p className="font-medium">Cierre del d√≠a</p>
                    <p className="text-sm text-white/50">
                      {dayJournal
                        ? `${['', 'üò´', 'üòî', 'üòê', 'üôÇ', 'üòÑ'][dayJournal.mood || 3]} Completado`
                        : 'Reflexiona y prepara ma√±ana'}
                    </p>
                  </div>
                </div>
                {dayJournal ? (
                  <Check className="w-5 h-5 text-amber-400" />
                ) : (
                  <ChevronRight className="w-5 h-5 text-white/30" />
                )}
              </div>
              {dayJournal && dayJournal.wins && (
                <div className="mt-3 pt-3 border-t border-white/10">
                  <p className="text-xs text-white/40 mb-1">Wins de hoy:</p>
                  <p className="text-sm text-white/70 line-clamp-1">
                    {Array.isArray(dayJournal.wins)
                      ? dayJournal.wins.filter(w => w).join(' ‚Ä¢ ')
                      : dayJournal.wins}
                  </p>
                </div>
              )}
            </Card>
          </AnimatedMount>

          {/* Quick Add FAB */}
        </>
      )}

      {/* Quick Add FAB */}
      {isViewingToday && viewMode === 'day' && (
        <button
          onClick={() => setShowQuickAdd(true)}
          className="fixed bottom-28 right-6 w-14 h-14 bg-violet-500 rounded-full flex items-center justify-center shadow-lg shadow-violet-500/30 hover:bg-violet-600 transition-colors z-40"
        >
          <Plus className="w-6 h-6" />
        </button>
      )}

      {/* Modals */}
      <Modal isOpen={showSleep} onClose={() => setShowSleep(false)} title="Registrar sue√±o">
        <SleepInput
          hours={dayData.sleep_hours}
          quality={dayData.sleep_quality}
          onSave={(data) => {
            updateDay({ sleep_hours: data.hours, sleep_quality: data.quality });
            setShowSleep(false);
            showToast('Sue√±o registrado');
          }}
        />
      </Modal>

      <Modal isOpen={showFocus} onClose={() => setShowFocus(false)} title="Foco del d√≠a">
        <textarea
          value={focusNote}
          onChange={(e) => setFocusNote(e.target.value)}
          placeholder="¬øCu√°l es tu prioridad principal hoy?"
          rows={3}
          className="w-full bg-white/10 rounded-xl p-4 outline-none resize-none"
          autoFocus
        />
        <button
          onClick={() => {
            updateDay({ focus_note: focusNote });
            setShowFocus(false);
            showToast('Foco guardado');
          }}
          className="w-full bg-violet-500 py-4 rounded-xl font-medium"
        >
          Guardar
        </button>
      </Modal>

      <Modal
        isOpen={showJournal}
        onClose={() => setShowJournal(false)}
        title="Cierre del d√≠a"
        footer={
          <button onClick={saveJournal} className="w-full bg-gradient-to-r from-violet-500 to-fuchsia-500 py-4 rounded-xl font-medium">
            Guardar cierre del d√≠a
          </button>
        }
      >
        <div className="space-y-5">
          {/* Mood & Energy */}
          <div className="grid grid-cols-2 gap-4">
            <div>
              <p className="text-sm text-white/60 mb-2">¬øC√≥mo te sientes?</p>
              <MoodSelector value={journalData.mood} onChange={(m) => setJournalData(j => ({ ...j, mood: m }))} />
            </div>
            <div>
              <p className="text-sm text-white/60 mb-2">Nivel de energ√≠a</p>
              <div className="flex gap-1">
                {[1, 2, 3, 4, 5].map(level => (
                  <button
                    key={level}
                    onClick={() => setJournalData(j => ({ ...j, energy: level }))}
                    className={`flex-1 py-2 rounded-lg text-sm transition-all ${journalData.energy >= level
                      ? 'bg-yellow-500 text-black'
                      : 'bg-white/10 text-white/40'
                      }`}
                  >
                    ‚ö°
                  </button>
                ))}
              </div>
            </div>
          </div>

          {/* 3 Wins */}
          <div>
            <p className="text-sm text-white/60 mb-2">üèÜ 3 Victorias de hoy</p>
            <p className="text-xs text-white/40 mb-2">¬øQu√© sali√≥ bien? Celebra tus logros.</p>
            <div className="space-y-2">
              {[0, 1, 2].map(i => (
                <input
                  key={i}
                  type="text"
                  value={Array.isArray(journalData.wins) ? journalData.wins[i] || '' : ''}
                  onChange={(e) => {
                    const newWins = Array.isArray(journalData.wins) ? [...journalData.wins] : ['', '', ''];
                    newWins[i] = e.target.value;
                    setJournalData(j => ({ ...j, wins: newWins }));
                  }}
                  placeholder={`Victoria ${i + 1}`}
                  className="w-full bg-white/10 rounded-xl p-3 outline-none text-sm"
                />
              ))}
            </div>
          </div>

          {/* Gratitud */}
          <div>
            <p className="text-sm text-white/60 mb-2">üôè Gratitud</p>
            <textarea
              value={journalData.gratitude}
              onChange={(e) => setJournalData(j => ({ ...j, gratitude: e.target.value }))}
              placeholder="¬øPor qu√© est√°s agradecido hoy?"
              rows={2}
              className="w-full bg-white/10 rounded-xl p-3 outline-none resize-none text-sm"
            />
          </div>

          {/* Aprendizaje */}
          <div>
            <p className="text-sm text-white/60 mb-2">üí° Aprendizaje del d√≠a</p>
            <textarea
              value={journalData.learning}
              onChange={(e) => setJournalData(j => ({ ...j, learning: e.target.value }))}
              placeholder="¬øQu√© has aprendido? ¬øQu√© har√≠as diferente?"
              rows={2}
              className="w-full bg-white/10 rounded-xl p-3 outline-none resize-none text-sm"
            />
          </div>

          {/* Top 3 para ma√±ana */}
          <div>
            <p className="text-sm text-white/60 mb-2">üéØ Top 3 para ma√±ana</p>
            <p className="text-xs text-white/40 mb-2">Las 3 cosas m√°s importantes que har√°s.</p>
            <div className="space-y-2">
              {[0, 1, 2].map(i => (
                <input
                  key={i}
                  type="text"
                  value={Array.isArray(journalData.tomorrow) ? journalData.tomorrow[i] || '' : ''}
                  onChange={(e) => {
                    const newTomorrow = Array.isArray(journalData.tomorrow) ? [...journalData.tomorrow] : ['', '', ''];
                    newTomorrow[i] = e.target.value;
                    setJournalData(j => ({ ...j, tomorrow: newTomorrow }));
                  }}
                  placeholder={`Prioridad ${i + 1}`}
                  className="w-full bg-white/10 rounded-xl p-3 outline-none text-sm"
                />
              ))}
            </div>
          </div>

          {/* Reflexi√≥n libre */}
          <div>
            <p className="text-sm text-white/60 mb-2">üìù Reflexi√≥n libre</p>
            <textarea
              value={journalData.reflection}
              onChange={(e) => setJournalData(j => ({ ...j, reflection: e.target.value }))}
              placeholder="Pensamientos, ideas, notas..."
              rows={3}
              className="w-full bg-white/10 rounded-xl p-3 outline-none resize-none text-sm"
            />
          </div>
        </div>
      </Modal>

      <Modal isOpen={showQuickAdd} onClose={() => setShowQuickAdd(false)} title="A√±adir r√°pido">
        <div className="grid grid-cols-2 gap-3">
          <button
            onClick={() => { setShowQuickAdd(false); setScreen('meals'); }}
            className="flex flex-col items-center gap-2 p-4 bg-white/5 rounded-xl hover:bg-white/10"
          >
            <Utensils className="w-8 h-8 text-orange-400" />
            <span>Comida</span>
          </button>
          <button
            onClick={() => { setShowQuickAdd(false); setScreen('workout'); }}
            className="flex flex-col items-center gap-2 p-4 bg-white/5 rounded-xl hover:bg-white/10"
          >
            <Dumbbell className="w-8 h-8 text-violet-400" />
            <span>Entreno</span>
          </button>
          <button
            onClick={() => { setShowQuickAdd(false); setScreen('habits'); }}
            className="flex flex-col items-center gap-2 p-4 bg-white/5 rounded-xl hover:bg-white/10"
          >
            <CheckSquare className="w-8 h-8 text-emerald-400" />
            <span>H√°bito</span>
          </button>
          <button
            onClick={() => { setShowQuickAdd(false); setScreen('work'); }}
            className="flex flex-col items-center gap-2 p-4 bg-white/5 rounded-xl hover:bg-white/10"
          >
            <Target className="w-8 h-8 text-blue-400" />
            <span>Tarea</span>
          </button>
        </div>
      </Modal>

      {/* Add Meal Modal - Full functionality with tabs */}
      <Modal isOpen={showAddMeal} onClose={() => { setShowAddMeal(false); setSelectedFood(null); setMealSearchQuery(''); setMealAddMode('search'); setNewFood({ name: '', serving: '100g', calories: '', protein: '', carbs: '', fats: '', barcode: '', category: 'other' }); setShowCreateFromScan(false); setScannedBarcode(''); }} title={selectedFood ? "Configurar porci√≥n" : "A√±adir comida"}>
        {selectedFood ? (
          /* Food configuration view */
          <div className="space-y-4">
            <div className="bg-gradient-to-r from-orange-500/20 to-red-500/20 rounded-xl p-4">
              <p className="font-bold text-lg">{selectedFood.name}</p>
              <p className="text-sm text-white/50">{selectedFood.serving}</p>
            </div>

            {/* Meal type selector */}
            <div className="flex gap-2">
              {visibleMealTypes.map(m => (
                <button
                  key={m.type}
                  onClick={() => setSelectedMealType(m.type)}
                  className={`flex-1 py-2 rounded-lg text-xl ${selectedMealType === m.type ? 'bg-orange-500' : 'bg-white/10'}`}
                >
                  {m.emoji}
                </button>
              ))}
            </div>

            {/* Quantity selector */}
            <div className="flex items-center justify-center gap-4">
              <button
                onClick={() => setMealServings(Math.max(0.25, mealServings - 0.25))}
                className="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-xl font-bold"
              >-</button>
              <div className="text-center">
                <input
                  type="number"
                  value={mealServings}
                  onChange={(e) => setMealServings(Math.max(0.1, parseFloat(e.target.value) || 0.1))}
                  className="w-16 text-3xl font-bold bg-transparent text-center outline-none"
                  step="0.25"
                />
                <p className="text-xs text-white/40">{selectedFood.serving}</p>
              </div>
              <button
                onClick={() => setMealServings(mealServings + 0.25)}
                className="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-xl font-bold"
              >+</button>
            </div>

            {/* Calculated nutrition */}
            <div className="bg-white/5 rounded-xl p-4 text-center">
              <p className="text-2xl font-bold text-orange-400">{Math.round(selectedFood.calories * mealServings)} kcal</p>
              <div className="flex justify-center gap-4 mt-2 text-sm">
                <span className="text-emerald-400">P: {Math.round(selectedFood.protein * mealServings)}g</span>
                <span className="text-blue-400">C: {Math.round(selectedFood.carbs * mealServings)}g</span>
                <span className="text-amber-400">G: {Math.round(selectedFood.fats * mealServings)}g</span>
              </div>
            </div>

            <div className="flex gap-3">
              <button
                onClick={() => setSelectedFood(null)}
                className="flex-1 py-3 bg-white/10 rounded-xl"
              >Cambiar</button>
              <button
                onClick={() => {
                  const meal = {
                    id: generateId(),
                    day_id: viewDate,
                    meal_type: selectedMealType,
                    name: selectedFood.name,
                    time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
                    calories: Math.round(selectedFood.calories * mealServings),
                    protein: Math.round(selectedFood.protein * mealServings),
                    carbs: Math.round(selectedFood.carbs * mealServings),
                    fats: Math.round(selectedFood.fats * mealServings)
                  };
                  setData(prev => ({ ...prev, meals: [...prev.meals, meal] }));
                  setSelectedFood(null);
                  setShowAddMeal(false);
                  setMealServings(1);
                  showToast('Comida a√±adida');
                }}
                className="flex-1 py-3 bg-orange-500 rounded-xl font-medium"
              >A√±adir</button>
            </div>
          </div>
        ) : (
          /* Search/Scan/Manual view */
          <div className="space-y-4">
            {/* Mode tabs */}
            <div className="flex gap-2">
              <button
                onClick={() => setMealAddMode('search')}
                className={`flex-1 py-2 rounded-lg text-sm flex items-center justify-center gap-2 ${mealAddMode === 'search' ? 'bg-orange-500' : 'bg-white/10'}`}
              >
                <Search className="w-4 h-4" />
                Buscar
              </button>
              <button
                onClick={() => setMealAddMode('scan')}
                className={`flex-1 py-2 rounded-lg text-sm flex items-center justify-center gap-2 ${mealAddMode === 'scan' ? 'bg-orange-500' : 'bg-white/10'}`}
              >
                <Camera className="w-4 h-4" />
                Escanear
              </button>
              <button
                onClick={() => setMealAddMode('new')}
                className={`flex-1 py-2 rounded-lg text-sm flex items-center justify-center gap-2 ${mealAddMode === 'new' ? 'bg-orange-500' : 'bg-white/10'}`}
              >
                <Plus className="w-4 h-4" />
                Nuevo
              </button>
            </div>

            {/* Meal type selector */}
            <div className="flex gap-2">
              {visibleMealTypes.map(m => (
                <button
                  key={m.type}
                  onClick={() => setSelectedMealType(m.type)}
                  className={`flex-1 py-2 rounded-lg text-xl ${selectedMealType === m.type ? 'bg-orange-500' : 'bg-white/10'}`}
                >
                  {m.emoji}
                </button>
              ))}
            </div>

            {mealAddMode === 'search' && (
              <>
                {/* Search input */}
                <div className="relative">
                  <input
                    type="text"
                    placeholder="Buscar alimento..."
                    value={mealSearchQuery}
                    onChange={(e) => setMealSearchQuery(e.target.value)}
                    className="w-full bg-white/10 rounded-xl p-4 pl-12 outline-none"
                    autoFocus
                  />
                  <Search className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-white/40" />
                </div>

                {/* Category filters */}
                <div className="flex gap-2 overflow-x-auto pb-1">
                  {FOOD_CATEGORIES.slice(0, 6).map(cat => (
                    <button
                      key={cat.id}
                      onClick={() => setMealCategory(mealCategory === cat.id ? 'all' : cat.id)}
                      className={`px-3 py-1.5 rounded-lg text-sm whitespace-nowrap ${mealCategory === cat.id ? 'bg-orange-500' : 'bg-white/10'}`}
                    >
                      {cat.emoji}
                    </button>
                  ))}
                </div>

                {/* Search results */}
                <div className="max-h-52 overflow-y-auto space-y-2">
                  {allFoods
                    .filter(food => {
                      const matchesQuery = !mealSearchQuery || food.name.toLowerCase().includes(mealSearchQuery.toLowerCase());
                      const matchesCategory = mealCategory === 'all' || food.category === mealCategory;
                      return matchesQuery && matchesCategory;
                    })
                    .slice(0, 15)
                    .map(food => (
                      <button
                        key={food.id}
                        onClick={() => { setSelectedFood(food); setMealServings(1); }}
                        className="w-full flex items-center justify-between p-3 bg-white/5 rounded-xl hover:bg-white/10 text-left"
                      >
                        <div>
                          <p className="font-medium text-sm">{food.name}</p>
                          <p className="text-xs text-white/40">{food.serving} {food.isCustom && <span className="text-violet-400">‚Ä¢ Tuyo</span>}</p>
                        </div>
                        <div className="text-right">
                          <p className="font-bold text-orange-400">{food.calories}</p>
                          <p className="text-[10px] text-white/40">kcal</p>
                        </div>
                      </button>
                    ))
                  }
                </div>
              </>
            )}

            {mealAddMode === 'scan' && (
              <div className="space-y-4">
                <div className="aspect-video bg-black/50 rounded-xl flex items-center justify-center relative overflow-hidden">
                  <div className="w-48 h-32 border-2 border-orange-500/50 rounded-lg relative">
                    <div className="absolute top-0 left-0 w-4 h-4 border-t-2 border-l-2 border-orange-500" />
                    <div className="absolute top-0 right-0 w-4 h-4 border-t-2 border-r-2 border-orange-500" />
                    <div className="absolute bottom-0 left-0 w-4 h-4 border-b-2 border-l-2 border-orange-500" />
                    <div className="absolute bottom-0 right-0 w-4 h-4 border-b-2 border-r-2 border-orange-500" />
                  </div>
                  <p className="absolute bottom-2 text-xs text-white/40">C√°mara no disponible en preview</p>
                </div>

                <div className="flex gap-2">
                  <input
                    type="text"
                    placeholder="Introduce c√≥digo de barras..."
                    value={scannedBarcode}
                    onChange={(e) => setScannedBarcode(e.target.value)}
                    className="flex-1 bg-white/10 rounded-xl p-3 outline-none"
                  />
                  <button
                    onClick={() => {
                      const found = allFoods.find(f => f.barcode === scannedBarcode);
                      if (found) {
                        setSelectedFood(found);
                        setMealServings(1);
                        showToast(`Encontrado: ${found.name}`);
                        setScannedBarcode('');
                      } else {
                        // Not found - offer to create new
                        setNewFood(prev => ({ ...prev, barcode: scannedBarcode }));
                        setShowCreateFromScan(true);
                      }
                    }}
                    disabled={!scannedBarcode}
                    className="px-4 bg-orange-500 rounded-xl font-medium disabled:opacity-50"
                  >
                    Buscar
                  </button>
                </div>

                {/* Create new from scan prompt */}
                {showCreateFromScan && (
                  <div className="bg-amber-500/10 border border-amber-500/30 rounded-xl p-3">
                    <p className="text-sm text-amber-200 mb-2">C√≥digo no encontrado: {newFood.barcode}</p>
                    <button
                      onClick={() => {
                        setMealAddMode('new');
                        setShowCreateFromScan(false);
                      }}
                      className="w-full py-2 bg-amber-500 rounded-lg text-sm font-medium"
                    >
                      Crear alimento nuevo con este c√≥digo
                    </button>
                  </div>
                )}

                <div>
                  <p className="text-xs text-white/40 mb-2">C√≥digos de ejemplo:</p>
                  <div className="flex flex-wrap gap-2">
                    {[
                      { code: '8410000000001', name: 'Pollo' },
                      { code: '8410000000023', name: 'Yogur' },
                      { code: '8410000000045', name: 'Avena' }
                    ].map(item => (
                      <button
                        key={item.code}
                        onClick={() => {
                          const found = allFoods.find(f => f.barcode === item.code);
                          if (found) {
                            setSelectedFood(found);
                            setMealServings(1);
                          }
                        }}
                        className="px-3 py-1.5 bg-white/5 rounded-lg text-xs hover:bg-white/10"
                      >
                        {item.name}
                      </button>
                    ))}
                  </div>
                </div>
              </div>
            )}

            {mealAddMode === 'new' && (
              <div className="space-y-3">
                <p className="text-xs text-white/50">Crear nuevo alimento en tu base de datos</p>

                <input
                  type="text"
                  placeholder="Nombre del alimento *"
                  value={newFood.name}
                  onChange={(e) => setNewFood(p => ({ ...p, name: e.target.value }))}
                  className="w-full bg-white/10 rounded-xl p-4 outline-none"
                />

                <div className="grid grid-cols-2 gap-3">
                  <input
                    type="text"
                    placeholder="Porci√≥n (ej: 100g)"
                    value={newFood.serving}
                    onChange={(e) => setNewFood(p => ({ ...p, serving: e.target.value }))}
                    className="bg-white/10 rounded-xl p-3 outline-none text-sm"
                  />
                  <input
                    type="text"
                    placeholder="C√≥digo barras (opc)"
                    value={newFood.barcode}
                    onChange={(e) => setNewFood(p => ({ ...p, barcode: e.target.value }))}
                    className="bg-white/10 rounded-xl p-3 outline-none text-sm"
                  />
                </div>

                <div className="grid grid-cols-2 gap-3">
                  <div className="bg-white/10 rounded-xl p-3">
                    <p className="text-[10px] text-white/40 mb-1">Calor√≠as *</p>
                    <input
                      type="number"
                      placeholder="0"
                      value={newFood.calories}
                      onChange={(e) => setNewFood(p => ({ ...p, calories: e.target.value }))}
                      className="w-full bg-transparent outline-none text-xl font-bold"
                    />
                  </div>
                  <div className="bg-white/10 rounded-xl p-3">
                    <p className="text-[10px] text-emerald-400 mb-1">Prote√≠na (g)</p>
                    <input
                      type="number"
                      placeholder="0"
                      value={newFood.protein}
                      onChange={(e) => setNewFood(p => ({ ...p, protein: e.target.value }))}
                      className="w-full bg-transparent outline-none text-xl font-bold"
                    />
                  </div>
                  <div className="bg-white/10 rounded-xl p-3">
                    <p className="text-[10px] text-blue-400 mb-1">Carbs (g)</p>
                    <input
                      type="number"
                      placeholder="0"
                      value={newFood.carbs}
                      onChange={(e) => setNewFood(p => ({ ...p, carbs: e.target.value }))}
                      className="w-full bg-transparent outline-none text-xl font-bold"
                    />
                  </div>
                  <div className="bg-white/10 rounded-xl p-3">
                    <p className="text-[10px] text-amber-400 mb-1">Grasas (g)</p>
                    <input
                      type="number"
                      placeholder="0"
                      value={newFood.fats}
                      onChange={(e) => setNewFood(p => ({ ...p, fats: e.target.value }))}
                      className="w-full bg-transparent outline-none text-xl font-bold"
                    />
                  </div>
                </div>

                {/* Category selector */}
                <div className="flex gap-2 overflow-x-auto pb-1">
                  {FOOD_CATEGORIES.slice(0, 6).map(cat => (
                    <button
                      key={cat.id}
                      onClick={() => setNewFood(p => ({ ...p, category: cat.id }))}
                      className={`px-3 py-1.5 rounded-lg text-sm whitespace-nowrap ${newFood.category === cat.id ? 'bg-orange-500' : 'bg-white/10'}`}
                    >
                      {cat.emoji} {cat.name}
                    </button>
                  ))}
                </div>

                <button
                  onClick={() => {
                    if (!newFood.name || !newFood.calories) return;

                    // Create new food in database
                    const foodItem = {
                      id: `custom_${generateId()}`,
                      name: newFood.name,
                      serving: newFood.serving || '100g',
                      calories: parseInt(newFood.calories) || 0,
                      protein: parseInt(newFood.protein) || 0,
                      carbs: parseInt(newFood.carbs) || 0,
                      fats: parseInt(newFood.fats) || 0,
                      category: newFood.category || 'other',
                      barcode: newFood.barcode || null,
                      isCustom: true
                    };

                    // Also create meal entry
                    const meal = {
                      id: generateId(),
                      day_id: viewDate,
                      meal_type: selectedMealType,
                      name: foodItem.name,
                      time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
                      calories: foodItem.calories,
                      protein: foodItem.protein,
                      carbs: foodItem.carbs,
                      fats: foodItem.fats
                    };

                    setData(prev => ({
                      ...prev,
                      customFoods: [...(prev.customFoods || []), foodItem],
                      meals: [...prev.meals, meal]
                    }));

                    setNewFood({ name: '', serving: '100g', calories: '', protein: '', carbs: '', fats: '', barcode: '', category: 'other' });
                    setShowAddMeal(false);
                    setShowCreateFromScan(false);
                    showToast('Alimento creado y registrado');
                  }}
                  disabled={!newFood.name || !newFood.calories}
                  className={`w-full py-4 rounded-xl font-medium ${newFood.name && newFood.calories ? 'bg-orange-500' : 'bg-white/10 text-white/30'}`}
                >
                  Crear y registrar
                </button>
              </div>
            )}
          </div>
        )}
      </Modal>
    </div>
  );
};


// ============================================================================
// MEALS SCREEN
// ============================================================================
const MealsScreen = ({ data, setData, showToast }) => {
  const today = getToday();

  // Views: diary, search, saved, history, insights, planner
  const [view, setView] = useState('diary');
  const [showAdd, setShowAdd] = useState(false);
  const [showQuickAdd, setShowQuickAdd] = useState(false);
  const [showSettings, setShowSettings] = useState(false);
  const [showHelp, setShowHelp] = useState(false);
  const [showFoodDetail, setShowFoodDetail] = useState(null);
  const [showScanner, setShowScanner] = useState(false);
  const [activeMealType, setActiveMealType] = useState('lunch');
  const [searchQuery, setSearchQuery] = useState('');
  const [expandedMeal, setExpandedMeal] = useState(null);
  const [selectedCategory, setSelectedCategory] = useState('all');
  const [scannedBarcode, setScannedBarcode] = useState('');

  // New: Food selection flow states
  const [selectedFood, setSelectedFood] = useState(null); // Food being configured before adding
  const [servingQuantity, setServingQuantity] = useState(1);
  const [addMode, setAddMode] = useState('search'); // 'search', 'manual', 'scan'

  // New: Multi-day planning states
  const [showPlanner, setShowPlanner] = useState(false);
  const [plannedDays, setPlannedDays] = useState([]);

  // Camera/Scanner state
  const [cameraStream, setCameraStream] = useState(null);
  const [isScanning, setIsScanning] = useState(false);
  // New meal state
  const [newMeal, setNewMeal] = useState({
    meal_type: 'lunch',
    name: '',
    calories: '',
    protein: '',
    carbs: '',
    fats: '',
    fiber: '',
    sodium: '',
    sugar: ''
  });

  // Quick add state
  const [quickAdd, setQuickAdd] = useState({ calories: '', protein: '', carbs: '', fats: '' });

  // Settings
  const [localGoals, setLocalGoals] = useState({
    calories: data.user.goals?.calories || 2200,
    protein: data.user.goals?.protein || 180,
    carbs: data.user.goals?.carbs || 250,
    fats: data.user.goals?.fats || 70,
    fiber: data.user.goals?.fiber || 30,
    water: data.user.goals?.water || 8,
    mealMode: data.user.goals?.mealMode || 'separate', // 'separate' or 'single'
    mealSlots: data.user.goals?.mealSlots || ['breakfast', 'lunch', 'snack', 'dinner'],
    caloriesPerMeal: data.user.goals?.caloriesPerMeal || {
      breakfast: 500,
      lunch: 700,
      snack: 300,
      dinner: 700
    }
  });

  // All possible meal types
  const allMealTypes = [
    { type: 'breakfast', label: 'Desayuno', emoji: 'üåÖ', icon: Coffee, time: '07:00 - 10:00' },
    { type: 'lunch', label: 'Comida', emoji: '‚òÄÔ∏è', icon: Sun, time: '12:00 - 15:00' },
    { type: 'snack', label: 'Snack', emoji: 'üçé', icon: Coffee, time: 'Entre comidas' },
    { type: 'dinner', label: 'Cena', emoji: 'üåô', icon: Moon, time: '19:00 - 22:00' }
  ];

  // Active meal types based on settings
  const mealTypes = localGoals.mealMode === 'single'
    ? [{ type: 'all', label: 'Todas las comidas', emoji: 'üçΩÔ∏è', icon: Utensils, time: 'Todo el d√≠a' }]
    : allMealTypes.filter(m => localGoals.mealSlots.includes(m.type));

  // Get today's meals
  const meals = data.meals.filter(m => m.day_id === today);

  // Calculations
  const totalCals = meals.reduce((s, m) => s + (m.calories || 0), 0);
  const totalProt = meals.reduce((s, m) => s + (m.protein || 0), 0);
  const totalCarbs = meals.reduce((s, m) => s + (m.carbs || 0), 0);
  const totalFats = meals.reduce((s, m) => s + (m.fats || 0), 0);
  const totalFiber = meals.reduce((s, m) => s + (m.fiber || 0), 0);

  const remainingCals = localGoals.calories - totalCals;
  const remainingProt = localGoals.protein - totalProt;
  const remainingCarbs = localGoals.carbs - totalCarbs;
  const remainingFats = localGoals.fats - totalFats;

  // Macro percentages for pie chart
  const totalMacrosCals = (totalProt * 4) + (totalCarbs * 4) + (totalFats * 9);
  const protPercent = totalMacrosCals > 0 ? Math.round((totalProt * 4 / totalMacrosCals) * 100) : 0;
  const carbsPercent = totalMacrosCals > 0 ? Math.round((totalCarbs * 4 / totalMacrosCals) * 100) : 0;
  const fatsPercent = totalMacrosCals > 0 ? Math.round((totalFats * 9 / totalMacrosCals) * 100) : 0;

  // Logging streak
  const getLoggingStreak = () => {
    let streak = 0;
    let checkDate = today;
    while (true) {
      const dayMeals = data.meals.filter(m => m.day_id === checkDate);
      if (dayMeals.length === 0) break;
      streak++;
      checkDate = getDateOffset(checkDate, -1);
    }
    return streak;
  };
  const loggingStreak = getLoggingStreak();

  // Saved meals (meals marked as favorite or frequently used)
  const savedMeals = data.savedMeals || [];

  // Recent foods (last 10 unique foods)
  const recentFoods = useMemo(() => {
    const seen = new Set();
    return data.meals
      .filter(m => m.name)
      .reverse()
      .filter(m => {
        if (seen.has(m.name.toLowerCase())) return false;
        seen.add(m.name.toLowerCase());
        return true;
      })
      .slice(0, 10);
  }, [data.meals]);

  // Frequent foods (most logged)
  const frequentFoods = useMemo(() => {
    const counts = {};
    data.meals.forEach(m => {
      if (m.name) {
        const key = m.name.toLowerCase();
        counts[key] = counts[key] || { ...m, count: 0 };
        counts[key].count++;
      }
    });
    return Object.values(counts).sort((a, b) => b.count - a.count).slice(0, 10);
  }, [data.meals]);

  // Water tracking
  const dayData = data.days[today] || {};
  const waterGlasses = dayData.water_glasses || 0;

  const addWater = () => {
    setData(prev => ({
      ...prev,
      days: {
        ...prev.days,
        [today]: { ...prev.days[today], water_glasses: (prev.days[today]?.water_glasses || 0) + 1 }
      }
    }));
  };

  const removeWater = () => {
    if (waterGlasses <= 0) return;
    setData(prev => ({
      ...prev,
      days: {
        ...prev.days,
        [today]: { ...prev.days[today], water_glasses: Math.max(0, (prev.days[today]?.water_glasses || 0) - 1) }
      }
    }));
  };

  // Handlers
  const saveSettings = () => {
    setData(prev => ({
      ...prev,
      user: { ...prev.user, goals: { ...prev.user.goals, ...localGoals } }
    }));
    setShowSettings(false);
    showToast('Objetivos actualizados');
  };

  const saveMeal = () => {
    if (!newMeal.name) return;
    const meal = {
      id: generateId(),
      day_id: today,
      ...newMeal,
      time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
      calories: parseInt(newMeal.calories) || 0,
      protein: parseInt(newMeal.protein) || 0,
      carbs: parseInt(newMeal.carbs) || 0,
      fats: parseInt(newMeal.fats) || 0,
      fiber: parseInt(newMeal.fiber) || 0,
      sodium: parseInt(newMeal.sodium) || 0,
      sugar: parseInt(newMeal.sugar) || 0
    };
    setData(prev => ({ ...prev, meals: [...prev.meals, meal] }));
    setShowAdd(false);
    setNewMeal({ meal_type: 'lunch', name: '', calories: '', protein: '', carbs: '', fats: '', fiber: '', sodium: '', sugar: '' });
    showToast('Comida a√±adida');
  };

  const saveQuickAdd = () => {
    if (!quickAdd.calories && !quickAdd.protein && !quickAdd.carbs && !quickAdd.fats) return;

    // Auto-calculate calories if only macros provided
    let cals = parseInt(quickAdd.calories) || 0;
    const prot = parseInt(quickAdd.protein) || 0;
    const carb = parseInt(quickAdd.carbs) || 0;
    const fat = parseInt(quickAdd.fats) || 0;

    if (cals === 0 && (prot || carb || fat)) {
      cals = (prot * 4) + (carb * 4) + (fat * 9);
    }

    const meal = {
      id: generateId(),
      day_id: today,
      meal_type: activeMealType,
      name: 'Quick Add',
      time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
      calories: cals,
      protein: prot,
      carbs: carb,
      fats: fat,
      isQuickAdd: true
    };
    setData(prev => ({ ...prev, meals: [...prev.meals, meal] }));
    setShowQuickAdd(false);
    setQuickAdd({ calories: '', protein: '', carbs: '', fats: '' });
    showToast('A√±adido');
  };

  const logRecentFood = (food) => {
    const meal = {
      id: generateId(),
      day_id: today,
      meal_type: activeMealType,
      name: food.name,
      time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
      calories: food.calories || 0,
      protein: food.protein || 0,
      carbs: food.carbs || 0,
      fats: food.fats || 0
    };
    setData(prev => ({ ...prev, meals: [...prev.meals, meal] }));
    setView('diary');
    showToast('A√±adido');
  };

  const deleteMeal = (id) => {
    setData(prev => ({ ...prev, meals: prev.meals.filter(m => m.id !== id) }));
    showToast('Eliminado');
  };

  const saveMealToFavorites = (meal) => {
    const savedMeal = {
      id: generateId(),
      name: meal.name,
      calories: meal.calories,
      protein: meal.protein,
      carbs: meal.carbs,
      fats: meal.fats
    };
    setData(prev => ({
      ...prev,
      savedMeals: [...(prev.savedMeals || []), savedMeal]
    }));
    showToast('Guardado en favoritos');
  };

  // ========== NEW: Select food from database and configure ==========
  const selectFoodFromDatabase = (food) => {
    setSelectedFood(food);
    setServingQuantity(1);
    setSearchQuery('');
  };

  const confirmAddSelectedFood = () => {
    if (!selectedFood) return;

    const meal = {
      id: generateId(),
      day_id: today,
      meal_type: activeMealType,
      name: selectedFood.name,
      serving: selectedFood.serving,
      servings: servingQuantity,
      time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
      calories: Math.round(selectedFood.calories * servingQuantity),
      protein: Math.round(selectedFood.protein * servingQuantity),
      carbs: Math.round(selectedFood.carbs * servingQuantity),
      fats: Math.round(selectedFood.fats * servingQuantity),
      fiber: Math.round((selectedFood.fiber || 0) * servingQuantity),
      sugar: Math.round((selectedFood.sugar || 0) * servingQuantity),
      sodium: Math.round((selectedFood.sodium || 0) * servingQuantity),
      foodId: selectedFood.id
    };

    setData(prev => ({ ...prev, meals: [...prev.meals, meal] }));
    setSelectedFood(null);
    setServingQuantity(1);
    setShowAdd(false);
    showToast('A√±adido');
  };

  // ========== NEW: Real barcode scanner with camera ==========
  const videoRef = React.useRef(null);

  const startCamera = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment' } // Prefer back camera on mobile
      });
      setCameraStream(stream);
      setIsScanning(true);
      if (videoRef.current) {
        videoRef.current.srcObject = stream;
      }
    } catch (err) {
      console.error('Camera error:', err);
      showToast('No se pudo acceder a la c√°mara');
    }
  };

  const stopCamera = () => {
    if (cameraStream) {
      cameraStream.getTracks().forEach(track => track.stop());
      setCameraStream(null);
    }
    setIsScanning(false);
    setShowScanner(false);
  };

  const searchByBarcode = (barcode) => {
    const found = FOOD_DATABASE.find(f => f.barcode === barcode);
    if (found) {
      selectFoodFromDatabase(found);
      stopCamera();
      showToast(`Encontrado: ${found.name}`);
    } else {
      showToast('C√≥digo no encontrado en la base de datos');
    }
    setScannedBarcode('');
  };

  // ========== NEW: Multi-day meal planning ==========
  const plannedMeals = data.plannedMeals || [];
  const todayPlannedMeals = plannedMeals.filter(m => m.day_id === today && !m.confirmed);

  const planMealForDays = (food, days) => {
    const newPlannedMeals = days.map(day => ({
      id: generateId(),
      day_id: day,
      meal_type: activeMealType,
      name: food.name,
      serving: food.serving,
      servings: servingQuantity,
      calories: Math.round(food.calories * servingQuantity),
      protein: Math.round(food.protein * servingQuantity),
      carbs: Math.round(food.carbs * servingQuantity),
      fats: Math.round(food.fats * servingQuantity),
      confirmed: false,
      plannedAt: new Date().toISOString()
    }));

    setData(prev => ({
      ...prev,
      plannedMeals: [...(prev.plannedMeals || []), ...newPlannedMeals]
    }));

    setShowPlanner(false);
    setPlannedDays([]);
    setSelectedFood(null);
    showToast(`Planificado para ${days.length} d√≠as`);
  };

  const confirmPlannedMeal = (plannedMeal) => {
    // Move from planned to actual meals
    const meal = {
      id: generateId(),
      day_id: today,
      meal_type: plannedMeal.meal_type,
      name: plannedMeal.name,
      serving: plannedMeal.serving,
      servings: plannedMeal.servings,
      time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
      calories: plannedMeal.calories,
      protein: plannedMeal.protein,
      carbs: plannedMeal.carbs,
      fats: plannedMeal.fats,
      fromPlanned: true
    };

    setData(prev => ({
      ...prev,
      meals: [...prev.meals, meal],
      plannedMeals: prev.plannedMeals.map(m =>
        m.id === plannedMeal.id ? { ...m, confirmed: true } : m
      )
    }));

    showToast('Comida confirmada');
  };

  const deletePlannedMeal = (id) => {
    setData(prev => ({
      ...prev,
      plannedMeals: prev.plannedMeals.filter(m => m.id !== id)
    }));
    showToast('Eliminado');
  };

  // Get next 7 days for planning
  const next7Days = Array.from({ length: 7 }, (_, i) => getDateOffset(today, i));

  // Toggle day selection for planning
  const togglePlannedDay = (day) => {
    setPlannedDays(prev =>
      prev.includes(day)
        ? prev.filter(d => d !== day)
        : [...prev, day]
    );
  };

  // Circular progress component for macros
  const MacroRing = ({ value, max, color, label, unit = 'g', size = 70 }) => {
    const percentage = Math.min((value / max) * 100, 100);
    const remaining = max - value;
    const strokeWidth = 6;
    const radius = (size - strokeWidth) / 2;
    const circumference = radius * 2 * Math.PI;
    const strokeDashoffset = circumference - (percentage / 100) * circumference;

    return (
      <div className="flex flex-col items-center">
        <div className="relative" style={{ width: size, height: size }}>
          <svg className="transform -rotate-90" width={size} height={size}>
            <circle
              cx={size / 2}
              cy={size / 2}
              r={radius}
              stroke="rgba(255,255,255,0.1)"
              strokeWidth={strokeWidth}
              fill="none"
            />
            <circle
              cx={size / 2}
              cy={size / 2}
              r={radius}
              stroke={color}
              strokeWidth={strokeWidth}
              fill="none"
              strokeDasharray={circumference}
              strokeDashoffset={strokeDashoffset}
              strokeLinecap="round"
              className="transition-all duration-500"
            />
          </svg>
          <div className="absolute inset-0 flex flex-col items-center justify-center">
            <span className="text-sm font-bold">{Math.round(remaining)}</span>
            <span className="text-[8px] text-white/40">{unit}</span>
          </div>
        </div>
        <p className="text-xs text-white/60 mt-1">{label}</p>
        <p className="text-[10px] text-white/40">{value}/{max}</p>
      </div>
    );
  };

  // DIARY VIEW
  if (view === 'diary') {
    return (
      <div className="space-y-4 pb-24">
        {/* Header */}
        <AnimatedMount>
          <div className="flex items-center justify-between">
            <div>
              <div className="flex items-center gap-2">
                <h1 className="text-2xl font-bold">Nutrici√≥n</h1>
                {loggingStreak > 0 && (
                  <div className="flex items-center gap-1 px-2 py-0.5 bg-orange-500/20 rounded-full">
                    <Flame className="w-3 h-3 text-orange-400" />
                    <span className="text-xs font-medium text-orange-400">{loggingStreak}</span>
                  </div>
                )}
              </div>
              <p className="text-white/50 text-sm">{formatDate(today)}</p>
            </div>
            <div className="flex items-center gap-2">
              {/* User Icon - only shown when logged in */}
              {(() => {
                const { user, loading } = useAuth();
                if (loading || !user) return null;
                const initial = user.email.charAt(0).toUpperCase();
                return (
                  <button
                    onClick={async () => { await supabase.auth.signOut(); window.location.href = '/login'; }}
                    className="relative group"
                    title={`${user.email} - Click para cerrar sesi√≥n`}
                  >
                    <div className="w-8 h-8 rounded-full bg-gradient-to-br from-emerald-400 to-cyan-500 flex items-center justify-center text-white text-sm font-bold shadow-lg shadow-emerald-500/30 ring-2 ring-white/20 group-hover:ring-white/40 transition-all">
                      {initial}
                    </div>
                    <div className="absolute -bottom-1 -right-1 w-3 h-3 bg-emerald-400 rounded-full border-2 border-slate-900 animate-pulse" />
                  </button>
                );
              })()}
              <button onClick={() => setShowHelp(true)} className="p-2 hover:bg-white/10 rounded-full">
                <BookOpen className="w-5 h-5 text-white/50" />
              </button>
              <button onClick={() => setShowSettings(true)} className="p-2 hover:bg-white/10 rounded-full">
                <Settings className="w-5 h-5 text-white/50" />
              </button>
            </div>
          </div>
        </AnimatedMount>

        {/* Main Calories Card with Macro Rings */}
        <AnimatedMount delay={50}>
          <Card className="bg-gradient-to-br from-orange-500/20 via-red-500/10 to-violet-500/20 border-orange-500/30">
            {/* Top: Calories remaining */}
            <div className="text-center mb-4">
              <p className="text-5xl font-bold">{remainingCals}</p>
              <p className="text-sm text-white/60">Calor√≠as restantes</p>
            </div>

            {/* Calories breakdown */}
            <div className="flex items-center justify-center gap-8 text-sm mb-4">
              <div className="text-center">
                <p className="text-white/40">Base</p>
                <p className="font-medium">{localGoals.calories}</p>
              </div>
              <div className="text-white/20">-</div>
              <div className="text-center">
                <p className="text-white/40">Comida</p>
                <p className="font-medium text-orange-400">{totalCals}</p>
              </div>
              <div className="text-white/20">=</div>
              <div className="text-center">
                <p className="text-white/40">Restante</p>
                <p className={`font-medium ${remainingCals >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{remainingCals}</p>
              </div>
            </div>

            {/* Macro rings */}
            <div className="flex justify-around">
              <MacroRing value={totalProt} max={localGoals.protein} color="#10B981" label="Prote√≠na" />
              <MacroRing value={totalCarbs} max={localGoals.carbs} color="#3B82F6" label="Carbs" />
              <MacroRing value={totalFats} max={localGoals.fats} color="#F59E0B" label="Grasas" />
            </div>
          </Card>
        </AnimatedMount>

        {/* Quick Actions */}
        <AnimatedMount delay={75}>
          <div className="flex gap-2">
            <button
              onClick={() => { setShowQuickAdd(true); }}
              className="flex-1 flex items-center justify-center gap-2 py-3 bg-white/5 rounded-xl hover:bg-white/10 transition-colors"
            >
              <Zap className="w-4 h-4 text-violet-400" />
              <span className="text-sm">Quick Add</span>
            </button>
            <button
              onClick={() => setView('search')}
              className="flex-1 flex items-center justify-center gap-2 py-3 bg-white/5 rounded-xl hover:bg-white/10 transition-colors"
            >
              <BookOpen className="w-4 h-4 text-blue-400" />
              <span className="text-sm">Buscar</span>
            </button>
            <button
              onClick={() => setView('saved')}
              className="flex-1 flex items-center justify-center gap-2 py-3 bg-white/5 rounded-xl hover:bg-white/10 transition-colors"
            >
              <Award className="w-4 h-4 text-amber-400" />
              <span className="text-sm">Guardados</span>
            </button>
          </div>
        </AnimatedMount>

        {/* Water Tracker */}
        <AnimatedMount delay={100}>
          <Card className="py-3">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <Droplets className="w-5 h-5 text-cyan-400" />
                <div>
                  <p className="font-medium">Agua</p>
                  <p className="text-xs text-white/40">{waterGlasses} de {localGoals.water} vasos</p>
                </div>
              </div>
              <div className="flex items-center gap-2">
                <button
                  onClick={removeWater}
                  disabled={waterGlasses <= 0}
                  className="p-2 bg-cyan-500/20 rounded-lg hover:bg-cyan-500/30 disabled:opacity-30 disabled:cursor-not-allowed"
                >
                  <span className="w-4 h-4 flex items-center justify-center text-cyan-400 font-bold text-lg leading-none">‚àí</span>
                </button>
                <div className="flex gap-1">
                  {Array.from({ length: localGoals.water }).map((_, i) => (
                    <div
                      key={i}
                      className={`w-2 h-4 rounded-sm transition-colors ${i < waterGlasses ? 'bg-cyan-400' : 'bg-white/10'}`}
                    />
                  ))}
                </div>
                <button
                  onClick={addWater}
                  className="p-2 bg-cyan-500/20 rounded-lg hover:bg-cyan-500/30"
                >
                  <span className="w-4 h-4 flex items-center justify-center text-cyan-400 font-bold text-lg leading-none">+</span>
                </button>
              </div>
            </div>
          </Card>
        </AnimatedMount>

        {/* Planned meals pending confirmation */}
        {todayPlannedMeals.length > 0 && (
          <AnimatedMount delay={110}>
            <Card className="border-amber-500/30 bg-amber-500/5">
              <div className="flex items-center gap-2 mb-3">
                <Calendar className="w-5 h-5 text-amber-400" />
                <p className="font-medium">Comidas planificadas</p>
                <span className="text-xs bg-amber-500/20 text-amber-400 px-2 py-0.5 rounded-full">{todayPlannedMeals.length}</span>
              </div>
              <div className="space-y-2">
                {todayPlannedMeals.map(meal => (
                  <div key={meal.id} className="flex items-center gap-3 p-3 bg-white/5 rounded-xl">
                    <div className="flex-1">
                      <p className="font-medium text-sm">{meal.name}</p>
                      <p className="text-xs text-white/40">
                        {meal.servings}x {meal.serving} ¬∑ {meal.calories} kcal
                      </p>
                    </div>
                    <button
                      onClick={() => deletePlannedMeal(meal.id)}
                      className="p-2 hover:bg-white/10 rounded-lg"
                    >
                      <X className="w-4 h-4 text-white/40" />
                    </button>
                    <button
                      onClick={() => confirmPlannedMeal(meal)}
                      className="px-4 py-2 bg-emerald-500 rounded-lg text-sm font-medium flex items-center gap-1"
                    >
                      <Check className="w-4 h-4" />
                      Confirmar
                    </button>
                  </div>
                ))}
              </div>
            </Card>
          </AnimatedMount>
        )}

        {/* Meal Sections */}
        {mealTypes.map(({ type, label, emoji, time }, index) => {
          const typeMeals = meals.filter(m => m.meal_type === type);
          const typePlanned = todayPlannedMeals.filter(m => m.meal_type === type);
          const mealCals = typeMeals.reduce((s, m) => s + (m.calories || 0), 0);
          const mealGoal = localGoals.caloriesPerMeal?.[type] || 500;
          const isExpanded = expandedMeal === type;

          return (
            <AnimatedMount key={type} delay={125 + index * 25}>
              <Card className="overflow-hidden">
                {/* Header - clickable to expand */}
                <button
                  onClick={() => setExpandedMeal(isExpanded ? null : type)}
                  className="w-full flex items-center gap-3"
                >
                  <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-orange-500/20 to-red-500/20 flex items-center justify-center text-xl relative">
                    {emoji}
                    {typePlanned.length > 0 && (
                      <div className="absolute -top-1 -right-1 w-4 h-4 bg-amber-500 rounded-full flex items-center justify-center text-[10px] font-bold">
                        {typePlanned.length}
                      </div>
                    )}
                  </div>
                  <div className="flex-1 text-left">
                    <div className="flex items-center gap-2">
                      <p className="font-medium">{label}</p>
                      {typeMeals.length > 0 && (
                        <span className="text-xs text-white/40">({typeMeals.length})</span>
                      )}
                    </div>
                    <p className="text-xs text-white/40">{time}</p>
                  </div>
                  <div className="text-right mr-2">
                    <p className="font-bold">{mealCals}</p>
                    <p className="text-xs text-white/40">/{mealGoal} kcal</p>
                  </div>
                  <ChevronRight className={`w-5 h-5 text-white/30 transition-transform ${isExpanded ? 'rotate-90' : ''}`} />
                </button>

                {/* Expanded content */}
                {isExpanded && (
                  <div className="mt-4 pt-4 border-t border-white/10">
                    {/* Planned meals for this type */}
                    {typePlanned.length > 0 && (
                      <div className="mb-3">
                        <p className="text-xs text-amber-400 mb-2">üìÖ PLANIFICADO</p>
                        <div className="space-y-2">
                          {typePlanned.map(meal => (
                            <div key={meal.id} className="flex items-center gap-2 p-2 bg-amber-500/10 rounded-lg border border-amber-500/20">
                              <div className="flex-1">
                                <p className="text-sm">{meal.name}</p>
                                <p className="text-xs text-white/40">{meal.calories} kcal</p>
                              </div>
                              <button
                                onClick={() => confirmPlannedMeal(meal)}
                                className="px-3 py-1.5 bg-emerald-500 rounded-lg text-xs font-medium"
                              >
                                ‚úì Hecho
                              </button>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* Meal items */}
                    {typeMeals.length > 0 ? (
                      <div className="space-y-2 mb-3">
                        {typeMeals.map(meal => (
                          <SwipeableItem
                            key={meal.id}
                            onDelete={() => deleteMeal(meal.id)}
                            rightAction={() => saveMealToFavorites(meal)}
                            rightActionIcon={<Award className="w-4 h-4" />}
                            rightActionColor="bg-amber-500"
                          >
                            <div
                              onClick={() => setShowFoodDetail(meal)}
                              className="flex items-center justify-between p-3 bg-white/5 rounded-xl cursor-pointer hover:bg-white/10"
                            >
                              <div className="flex-1">
                                <p className="text-sm font-medium">{meal.name}</p>
                                <div className="flex items-center gap-2 mt-0.5">
                                  <span className="text-xs text-white/40">{meal.time}</span>
                                  {meal.isQuickAdd && (
                                    <span className="text-[10px] px-1.5 py-0.5 bg-violet-500/20 text-violet-400 rounded">Quick</span>
                                  )}
                                </div>
                              </div>
                              <div className="text-right">
                                <p className="text-sm font-bold">{meal.calories} kcal</p>
                                <p className="text-[10px] text-white/40">
                                  P:{meal.protein || 0} ¬∑ C:{meal.carbs || 0} ¬∑ G:{meal.fats || 0}
                                </p>
                              </div>
                            </div>
                          </SwipeableItem>
                        ))}
                      </div>
                    ) : null}

                    {/* Add food button */}
                    <button
                      onClick={() => {
                        setActiveMealType(type);
                        setNewMeal(p => ({ ...p, meal_type: type }));
                        setShowAdd(true);
                      }}
                      className="w-full py-3 border border-dashed border-white/20 rounded-xl text-white/50 text-sm hover:border-white/40 hover:text-white/70 transition-colors flex items-center justify-center gap-2"
                    >
                      <Plus className="w-4 h-4" />
                      A√±adir alimento
                    </button>
                  </div>
                )}
              </Card>
            </AnimatedMount>
          );
        })}

        {/* Macro Distribution */}
        {totalCals > 0 && (
          <AnimatedMount delay={250}>
            <Card>
              <p className="text-sm text-white/60 mb-3">Distribuci√≥n de macros</p>
              <div className="flex items-center gap-4">
                <div className="flex-1 h-3 bg-white/10 rounded-full overflow-hidden flex">
                  <div
                    className="h-full bg-emerald-500 transition-all"
                    style={{ width: `${protPercent}%` }}
                  />
                  <div
                    className="h-full bg-blue-500 transition-all"
                    style={{ width: `${carbsPercent}%` }}
                  />
                  <div
                    className="h-full bg-amber-500 transition-all"
                    style={{ width: `${fatsPercent}%` }}
                  />
                </div>
              </div>
              <div className="flex justify-between mt-2 text-xs">
                <span className="text-emerald-400">Prot {protPercent}%</span>
                <span className="text-blue-400">Carbs {carbsPercent}%</span>
                <span className="text-amber-400">Grasas {fatsPercent}%</span>
              </div>
            </Card>
          </AnimatedMount>
        )}

        {/* Bottom navigation for views */}
        <AnimatedMount delay={275}>
          <div className="flex gap-2">
            <button
              onClick={() => setView('history')}
              className="flex-1 py-3 bg-white/5 rounded-xl text-sm text-white/60 hover:bg-white/10"
            >
              üìÖ Historial
            </button>
            <button
              onClick={() => setView('insights')}
              className="flex-1 py-3 bg-white/5 rounded-xl text-sm text-white/60 hover:bg-white/10"
            >
              üìä Insights
            </button>
          </div>
        </AnimatedMount>

        {/* Modals */}
        {/* Add Food Modal - NEW INTEGRATED FLOW */}
        <Modal
          isOpen={showAdd}
          onClose={() => { setShowAdd(false); setSelectedFood(null); setSearchQuery(''); setAddMode('search'); }}
          title={selectedFood ? "Configurar porci√≥n" : "A√±adir alimento"}
        >
          {/* If food is selected, show configuration */}
          {selectedFood ? (
            <div className="space-y-4">
              {/* Selected food info */}
              <div className="bg-gradient-to-r from-orange-500/20 to-red-500/20 rounded-xl p-4">
                <p className="font-bold text-lg">{selectedFood.name}</p>
                <p className="text-sm text-white/50">{selectedFood.serving}</p>
              </div>

              {/* Meal type selector */}
              <div>
                <p className="text-xs text-white/40 mb-2">A√±adir a:</p>
                <div className="flex gap-2">
                  {mealTypes.map(({ type, emoji, label }) => (
                    <button
                      key={type}
                      onClick={() => setActiveMealType(type)}
                      className={`flex-1 py-2 rounded-lg flex flex-col items-center gap-1 transition-colors ${activeMealType === type ? 'bg-orange-500' : 'bg-white/10'}`}
                    >
                      <span>{emoji}</span>
                      <span className="text-[10px]">{label}</span>
                    </button>
                  ))}
                </div>
              </div>

              {/* Quantity selector */}
              <div>
                <p className="text-xs text-white/40 mb-2">Cantidad de porciones:</p>
                <div className="flex items-center justify-center gap-4">
                  <button
                    onClick={() => setServingQuantity(Math.max(0.1, servingQuantity - 0.25))}
                    className="w-12 h-12 rounded-full bg-white/10 flex items-center justify-center text-xl font-bold hover:bg-white/20"
                  >
                    -
                  </button>
                  <div className="text-center">
                    <input
                      type="number"
                      value={servingQuantity}
                      onChange={(e) => setServingQuantity(Math.max(0.1, parseFloat(e.target.value) || 0.1))}
                      className="w-20 text-4xl font-bold bg-transparent text-center outline-none"
                      step="0.1"
                      min="0.1"
                    />
                    <p className="text-xs text-white/40">{selectedFood.serving}</p>
                  </div>
                  <button
                    onClick={() => setServingQuantity(servingQuantity + 0.25)}
                    className="w-12 h-12 rounded-full bg-white/10 flex items-center justify-center text-xl font-bold hover:bg-white/20"
                  >
                    +
                  </button>
                </div>
              </div>

              {/* Quick quantity buttons */}
              <div className="flex gap-2">
                {[0.5, 1, 1.5, 2, 3].map(q => (
                  <button
                    key={q}
                    onClick={() => setServingQuantity(q)}
                    className={`flex-1 py-2 rounded-lg text-sm ${servingQuantity === q ? 'bg-orange-500' : 'bg-white/10'}`}
                  >
                    {q}x
                  </button>
                ))}
              </div>

              {/* Calculated nutrition */}
              <div className="bg-white/5 rounded-xl p-4">
                <div className="text-center mb-3">
                  <p className="text-3xl font-bold text-orange-400">{Math.round(selectedFood.calories * servingQuantity)}</p>
                  <p className="text-xs text-white/40">calor√≠as</p>
                </div>
                <div className="grid grid-cols-3 gap-3 text-center">
                  <div>
                    <p className="font-bold text-emerald-400">{Math.round(selectedFood.protein * servingQuantity)}g</p>
                    <p className="text-[10px] text-white/40">Prote√≠na</p>
                  </div>
                  <div>
                    <p className="font-bold text-blue-400">{Math.round(selectedFood.carbs * servingQuantity)}g</p>
                    <p className="text-[10px] text-white/40">Carbs</p>
                  </div>
                  <div>
                    <p className="font-bold text-amber-400">{Math.round(selectedFood.fats * servingQuantity)}g</p>
                    <p className="text-[10px] text-white/40">Grasas</p>
                  </div>
                </div>
              </div>

              {/* Multi-day planning option */}
              <button
                onClick={() => setShowPlanner(true)}
                className="w-full py-3 bg-white/5 rounded-xl text-sm text-white/60 flex items-center justify-center gap-2 hover:bg-white/10"
              >
                <Calendar className="w-4 h-4" />
                Planificar para varios d√≠as
              </button>

              {/* Action buttons */}
              <div className="flex gap-3">
                <button
                  onClick={() => { setSelectedFood(null); setSearchQuery(''); }}
                  className="flex-1 py-4 bg-white/10 rounded-xl font-medium"
                >
                  Cambiar
                </button>
                <button
                  onClick={confirmAddSelectedFood}
                  className="flex-1 py-4 bg-orange-500 rounded-xl font-medium"
                >
                  A√±adir
                </button>
              </div>
            </div>
          ) : (
            /* Food search/selection view */
            <div className="space-y-4">
              {/* Mode tabs */}
              <div className="flex gap-2">
                <button
                  onClick={() => setAddMode('search')}
                  className={`flex-1 py-2 rounded-lg text-sm flex items-center justify-center gap-2 ${addMode === 'search' ? 'bg-orange-500' : 'bg-white/10'}`}
                >
                  <Search className="w-4 h-4" />
                  Buscar
                </button>
                <button
                  onClick={() => { setAddMode('scan'); startCamera(); }}
                  className={`flex-1 py-2 rounded-lg text-sm flex items-center justify-center gap-2 ${addMode === 'scan' ? 'bg-orange-500' : 'bg-white/10'}`}
                >
                  <Camera className="w-4 h-4" />
                  Escanear
                </button>
                <button
                  onClick={() => setAddMode('manual')}
                  className={`flex-1 py-2 rounded-lg text-sm flex items-center justify-center gap-2 ${addMode === 'manual' ? 'bg-orange-500' : 'bg-white/10'}`}
                >
                  <Edit3 className="w-4 h-4" />
                  Manual
                </button>
              </div>

              {/* Meal type selector */}
              <div className="flex gap-2">
                {mealTypes.map(({ type, emoji }) => (
                  <button
                    key={type}
                    onClick={() => setActiveMealType(type)}
                    className={`flex-1 py-2 rounded-lg ${activeMealType === type ? 'bg-orange-500' : 'bg-white/10'}`}
                  >
                    {emoji}
                  </button>
                ))}
              </div>

              {addMode === 'search' && (
                <>
                  {/* Search input */}
                  <div className="relative">
                    <input
                      type="text"
                      placeholder="Buscar alimento..."
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                      className="w-full bg-white/10 rounded-xl p-4 pl-12 outline-none"
                      autoFocus
                    />
                    <Search className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-white/40" />
                  </div>

                  {/* Category filter */}
                  <div className="flex gap-2 overflow-x-auto pb-2 -mx-4 px-4">
                    {FOOD_CATEGORIES.slice(0, 6).map(cat => (
                      <button
                        key={cat.id}
                        onClick={() => setSelectedCategory(cat.id)}
                        className={`flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs whitespace-nowrap ${selectedCategory === cat.id ? 'bg-orange-500' : 'bg-white/10'
                          }`}
                      >
                        {cat.emoji}
                      </button>
                    ))}
                  </div>

                  {/* Search results */}
                  <div className="max-h-64 overflow-y-auto space-y-2">
                    {FOOD_DATABASE
                      .filter(food => {
                        const matchesQuery = !searchQuery || food.name.toLowerCase().includes(searchQuery.toLowerCase());
                        const matchesCategory = selectedCategory === 'all' || food.category === selectedCategory;
                        return matchesQuery && matchesCategory;
                      })
                      .slice(0, 15)
                      .map(food => (
                        <button
                          key={food.id}
                          onClick={() => selectFoodFromDatabase(food)}
                          className="w-full flex items-center justify-between p-3 bg-white/5 rounded-xl hover:bg-white/10 text-left"
                        >
                          <div>
                            <p className="font-medium text-sm">{food.name}</p>
                            <p className="text-xs text-white/40">{food.serving}</p>
                          </div>
                          <div className="text-right">
                            <p className="font-bold text-orange-400">{food.calories}</p>
                            <p className="text-[10px] text-white/40">kcal</p>
                          </div>
                        </button>
                      ))
                    }
                  </div>

                  {/* Recent foods */}
                  {!searchQuery && recentFoods.length > 0 && (
                    <div>
                      <p className="text-xs text-white/40 mb-2">RECIENTES</p>
                      <div className="space-y-2">
                        {recentFoods.slice(0, 5).map(food => (
                          <button
                            key={food.id}
                            onClick={() => selectFoodFromDatabase(food)}
                            className="w-full flex items-center justify-between p-3 bg-white/5 rounded-xl hover:bg-white/10 text-left"
                          >
                            <div>
                              <p className="font-medium text-sm">{food.name}</p>
                              <p className="text-xs text-white/40">P:{food.protein}g ¬∑ C:{food.carbs}g ¬∑ G:{food.fats}g</p>
                            </div>
                            <p className="font-bold text-orange-400">{food.calories}</p>
                          </button>
                        ))}
                      </div>
                    </div>
                  )}
                </>
              )}

              {addMode === 'scan' && (
                <div className="space-y-4">
                  {/* Camera preview */}
                  <div className="aspect-[4/3] bg-black rounded-xl overflow-hidden relative">
                    <video
                      ref={videoRef}
                      autoPlay
                      playsInline
                      className="w-full h-full object-cover"
                    />
                    {/* Scan overlay */}
                    <div className="absolute inset-0 flex items-center justify-center">
                      <div className="w-48 h-32 border-2 border-orange-500 rounded-lg relative">
                        <div className="absolute top-0 left-0 w-4 h-4 border-t-2 border-l-2 border-orange-500" />
                        <div className="absolute top-0 right-0 w-4 h-4 border-t-2 border-r-2 border-orange-500" />
                        <div className="absolute bottom-0 left-0 w-4 h-4 border-b-2 border-l-2 border-orange-500" />
                        <div className="absolute bottom-0 right-0 w-4 h-4 border-b-2 border-r-2 border-orange-500" />
                        <div className="absolute left-0 right-0 top-1/2 h-0.5 bg-orange-500/50 animate-pulse" />
                      </div>
                    </div>
                    {!cameraStream && (
                      <div className="absolute inset-0 flex items-center justify-center bg-black/80">
                        <button
                          onClick={startCamera}
                          className="px-6 py-3 bg-orange-500 rounded-xl font-medium flex items-center gap-2"
                        >
                          <Camera className="w-5 h-5" />
                          Activar c√°mara
                        </button>
                      </div>
                    )}
                  </div>

                  <p className="text-center text-sm text-white/50">
                    Apunta al c√≥digo de barras del producto
                  </p>

                  {/* Manual barcode entry */}
                  <div className="flex gap-2">
                    <input
                      type="text"
                      placeholder="O introduce el c√≥digo..."
                      value={scannedBarcode}
                      onChange={(e) => setScannedBarcode(e.target.value)}
                      className="flex-1 bg-white/10 rounded-xl p-3 outline-none"
                    />
                    <button
                      onClick={() => searchByBarcode(scannedBarcode)}
                      disabled={!scannedBarcode}
                      className="px-4 bg-orange-500 rounded-xl font-medium disabled:opacity-50"
                    >
                      Buscar
                    </button>
                  </div>

                  {/* Sample codes */}
                  <div>
                    <p className="text-xs text-white/40 mb-2">C√≥digos de ejemplo:</p>
                    <div className="flex flex-wrap gap-2">
                      {[
                        { code: '8410000000001', name: 'Pollo' },
                        { code: '8410000000023', name: 'Yogur' },
                        { code: '8410000000045', name: 'Avena' },
                        { code: '8410000000088', name: 'Aguacate' }
                      ].map(item => (
                        <button
                          key={item.code}
                          onClick={() => searchByBarcode(item.code)}
                          className="px-3 py-1.5 bg-white/5 rounded-lg text-xs hover:bg-white/10"
                        >
                          {item.name}
                        </button>
                      ))}
                    </div>
                  </div>
                </div>
              )}

              {addMode === 'manual' && (
                <div className="space-y-4">
                  <input
                    type="text"
                    placeholder="Nombre del alimento"
                    value={newMeal.name}
                    onChange={(e) => setNewMeal(p => ({ ...p, name: e.target.value }))}
                    className="w-full bg-white/10 rounded-xl p-4 outline-none"
                  />

                  <div className="grid grid-cols-2 gap-3">
                    <div className="bg-white/10 rounded-xl p-3">
                      <p className="text-[10px] text-white/40 mb-1">Calor√≠as</p>
                      <input
                        type="number"
                        placeholder="0"
                        value={newMeal.calories}
                        onChange={(e) => setNewMeal(p => ({ ...p, calories: e.target.value }))}
                        className="w-full bg-transparent outline-none text-xl font-bold"
                      />
                    </div>
                    <div className="bg-white/10 rounded-xl p-3">
                      <p className="text-[10px] text-emerald-400 mb-1">Prote√≠na (g)</p>
                      <input
                        type="number"
                        placeholder="0"
                        value={newMeal.protein}
                        onChange={(e) => setNewMeal(p => ({ ...p, protein: e.target.value }))}
                        className="w-full bg-transparent outline-none text-xl font-bold"
                      />
                    </div>
                    <div className="bg-white/10 rounded-xl p-3">
                      <p className="text-[10px] text-blue-400 mb-1">Carbs (g)</p>
                      <input
                        type="number"
                        placeholder="0"
                        value={newMeal.carbs}
                        onChange={(e) => setNewMeal(p => ({ ...p, carbs: e.target.value }))}
                        className="w-full bg-transparent outline-none text-xl font-bold"
                      />
                    </div>
                    <div className="bg-white/10 rounded-xl p-3">
                      <p className="text-[10px] text-amber-400 mb-1">Grasas (g)</p>
                      <input
                        type="number"
                        placeholder="0"
                        value={newMeal.fats}
                        onChange={(e) => setNewMeal(p => ({ ...p, fats: e.target.value }))}
                        className="w-full bg-transparent outline-none text-xl font-bold"
                      />
                    </div>
                  </div>

                  <button
                    onClick={saveMeal}
                    disabled={!newMeal.name}
                    className={`w-full py-4 rounded-xl font-medium ${newMeal.name ? 'bg-orange-500' : 'bg-white/10 text-white/30'}`}
                  >
                    A√±adir
                  </button>
                </div>
              )}
            </div>
          )}
        </Modal>

        {/* Multi-day Planner Modal */}
        <Modal
          isOpen={showPlanner}
          onClose={() => { setShowPlanner(false); setPlannedDays([]); }}
          title="Planificar comida"
        >
          {selectedFood && (
            <div className="space-y-4">
              <div className="bg-white/5 rounded-xl p-3">
                <p className="font-medium">{selectedFood.name}</p>
                <p className="text-sm text-white/40">{servingQuantity}x {selectedFood.serving} ¬∑ {Math.round(selectedFood.calories * servingQuantity)} kcal</p>
              </div>

              <div>
                <p className="text-sm text-white/60 mb-3">Selecciona los d√≠as:</p>
                <div className="grid grid-cols-7 gap-2">
                  {next7Days.map((day, i) => {
                    const isSelected = plannedDays.includes(day);
                    const dayName = ['D', 'L', 'M', 'X', 'J', 'V', 'S'][new Date(day).getDay()];
                    const dayNum = new Date(day).getDate();
                    const isToday = day === today;

                    return (
                      <button
                        key={day}
                        onClick={() => togglePlannedDay(day)}
                        className={`p-2 rounded-lg flex flex-col items-center ${isSelected
                          ? 'bg-orange-500'
                          : isToday
                            ? 'bg-white/20'
                            : 'bg-white/5'
                          }`}
                      >
                        <span className="text-[10px] text-white/60">{dayName}</span>
                        <span className="font-bold">{dayNum}</span>
                      </button>
                    );
                  })}
                </div>
              </div>

              {plannedDays.length > 0 && (
                <div className="bg-orange-500/10 rounded-xl p-3 text-center">
                  <p className="text-sm">
                    Se planificar√° para <span className="font-bold text-orange-400">{plannedDays.length} d√≠as</span>
                  </p>
                  <p className="text-xs text-white/40">Deber√°s confirmar cada d√≠a cuando comas</p>
                </div>
              )}

              <button
                onClick={() => planMealForDays(selectedFood, plannedDays)}
                disabled={plannedDays.length === 0}
                className={`w-full py-4 rounded-xl font-medium ${plannedDays.length > 0 ? 'bg-orange-500' : 'bg-white/10 text-white/30'
                  }`}
              >
                Planificar
              </button>
            </div>
          )}
        </Modal>

        {/* Quick Add Modal */}
        <Modal isOpen={showQuickAdd} onClose={() => setShowQuickAdd(false)} title="Quick Add">
          <p className="text-sm text-white/50 mb-4">A√±ade calor√≠as o macros r√°pidamente. Si solo introduces macros, las calor√≠as se calcular√°n autom√°ticamente.</p>

          {/* Meal type selector */}
          <div className="flex gap-2 mb-4">
            {mealTypes.map(({ type, emoji }) => (
              <button
                key={type}
                onClick={() => setActiveMealType(type)}
                className={`flex-1 py-2 rounded-lg ${activeMealType === type ? 'bg-violet-500' : 'bg-white/10'}`}
              >
                {emoji}
              </button>
            ))}
          </div>

          <div className="space-y-3">
            <div className="bg-white/10 rounded-xl p-4">
              <p className="text-xs text-white/40 mb-1">Calor√≠as</p>
              <input
                type="number"
                placeholder="0"
                value={quickAdd.calories}
                onChange={(e) => setQuickAdd(p => ({ ...p, calories: e.target.value }))}
                className="w-full bg-transparent outline-none text-3xl font-bold text-center"
              />
            </div>
            <div className="grid grid-cols-3 gap-2">
              <div className="bg-white/10 rounded-xl p-3">
                <p className="text-[10px] text-emerald-400 mb-1">Prot (g)</p>
                <input
                  type="number"
                  placeholder="0"
                  value={quickAdd.protein}
                  onChange={(e) => setQuickAdd(p => ({ ...p, protein: e.target.value }))}
                  className="w-full bg-transparent outline-none text-lg font-bold text-center"
                />
              </div>
              <div className="bg-white/10 rounded-xl p-3">
                <p className="text-[10px] text-blue-400 mb-1">Carbs (g)</p>
                <input
                  type="number"
                  placeholder="0"
                  value={quickAdd.carbs}
                  onChange={(e) => setQuickAdd(p => ({ ...p, carbs: e.target.value }))}
                  className="w-full bg-transparent outline-none text-lg font-bold text-center"
                />
              </div>
              <div className="bg-white/10 rounded-xl p-3">
                <p className="text-[10px] text-amber-400 mb-1">Grasas (g)</p>
                <input
                  type="number"
                  placeholder="0"
                  value={quickAdd.fats}
                  onChange={(e) => setQuickAdd(p => ({ ...p, fats: e.target.value }))}
                  className="w-full bg-transparent outline-none text-lg font-bold text-center"
                />
              </div>
            </div>
          </div>

          <button
            onClick={saveQuickAdd}
            className="w-full py-4 bg-violet-500 rounded-xl font-medium mt-4"
          >
            A√±adir
          </button>
        </Modal>

        {/* Food Detail Modal */}
        <Modal isOpen={!!showFoodDetail} onClose={() => setShowFoodDetail(null)} title="Detalle">
          {showFoodDetail && (
            <div className="space-y-4">
              <div className="text-center">
                <p className="text-2xl font-bold">{showFoodDetail.name}</p>
                <p className="text-sm text-white/40">{showFoodDetail.time} ¬∑ {mealTypes.find(m => m.type === showFoodDetail.meal_type)?.label}</p>
              </div>

              <div className="bg-white/5 rounded-xl p-4 text-center">
                <p className="text-4xl font-bold text-orange-400">{showFoodDetail.calories}</p>
                <p className="text-sm text-white/40">calor√≠as</p>
              </div>

              <div className="grid grid-cols-3 gap-3">
                <div className="bg-white/5 rounded-xl p-3 text-center">
                  <p className="text-2xl font-bold text-emerald-400">{showFoodDetail.protein || 0}g</p>
                  <p className="text-xs text-white/40">Prote√≠na</p>
                </div>
                <div className="bg-white/5 rounded-xl p-3 text-center">
                  <p className="text-2xl font-bold text-blue-400">{showFoodDetail.carbs || 0}g</p>
                  <p className="text-xs text-white/40">Carbs</p>
                </div>
                <div className="bg-white/5 rounded-xl p-3 text-center">
                  <p className="text-2xl font-bold text-amber-400">{showFoodDetail.fats || 0}g</p>
                  <p className="text-xs text-white/40">Grasas</p>
                </div>
              </div>

              {(showFoodDetail.fiber || showFoodDetail.sugar || showFoodDetail.sodium) && (
                <div className="grid grid-cols-3 gap-3">
                  {showFoodDetail.fiber > 0 && (
                    <div className="bg-white/5 rounded-xl p-2 text-center">
                      <p className="font-bold">{showFoodDetail.fiber}g</p>
                      <p className="text-[10px] text-white/40">Fibra</p>
                    </div>
                  )}
                  {showFoodDetail.sugar > 0 && (
                    <div className="bg-white/5 rounded-xl p-2 text-center">
                      <p className="font-bold">{showFoodDetail.sugar}g</p>
                      <p className="text-[10px] text-white/40">Az√∫car</p>
                    </div>
                  )}
                  {showFoodDetail.sodium > 0 && (
                    <div className="bg-white/5 rounded-xl p-2 text-center">
                      <p className="font-bold">{showFoodDetail.sodium}mg</p>
                      <p className="text-[10px] text-white/40">Sodio</p>
                    </div>
                  )}
                </div>
              )}

              <button
                onClick={() => { saveMealToFavorites(showFoodDetail); setShowFoodDetail(null); }}
                className="w-full py-3 bg-amber-500/20 text-amber-400 rounded-xl font-medium flex items-center justify-center gap-2"
              >
                <Award className="w-4 h-4" />
                Guardar en favoritos
              </button>
            </div>
          )}
        </Modal>

        {/* Settings Modal */}
        <Modal
          isOpen={showSettings}
          onClose={() => setShowSettings(false)}
          title="Configuraci√≥n Nutrici√≥n"
          footer={
            <button onClick={saveSettings} className="w-full py-4 bg-orange-500 rounded-xl font-medium">
              Guardar cambios
            </button>
          }
        >
          <div className="space-y-4">
            {/* Meal Mode Toggle */}
            <div>
              <label className="text-sm text-white/60 mb-2 block">Modo de registro</label>
              <div className="grid grid-cols-2 gap-2">
                <button
                  onClick={() => setLocalGoals(p => ({ ...p, mealMode: 'separate' }))}
                  className={`p-3 rounded-xl text-sm ${localGoals.mealMode === 'separate' ? 'bg-orange-500' : 'bg-white/10'}`}
                >
                  <p className="font-medium">Por comidas</p>
                  <p className="text-[10px] text-white/60">Desayuno, Comida, etc.</p>
                </button>
                <button
                  onClick={() => setLocalGoals(p => ({ ...p, mealMode: 'single' }))}
                  className={`p-3 rounded-xl text-sm ${localGoals.mealMode === 'single' ? 'bg-orange-500' : 'bg-white/10'}`}
                >
                  <p className="font-medium">Banco √∫nico</p>
                  <p className="text-[10px] text-white/60">Todo junto</p>
                </button>
              </div>
            </div>

            {/* Meal slots selector (only if separate mode) */}
            {localGoals.mealMode === 'separate' && (
              <div>
                <label className="text-sm text-white/60 mb-2 block">Comidas del d√≠a</label>
                <div className="grid grid-cols-2 gap-2">
                  {allMealTypes.map(meal => {
                    const isActive = localGoals.mealSlots.includes(meal.type);
                    return (
                      <button
                        key={meal.type}
                        onClick={() => {
                          setLocalGoals(p => ({
                            ...p,
                            mealSlots: isActive
                              ? p.mealSlots.filter(s => s !== meal.type)
                              : [...p.mealSlots, meal.type]
                          }));
                        }}
                        className={`p-2 rounded-xl flex items-center gap-2 ${isActive ? 'bg-orange-500/20 border border-orange-500' : 'bg-white/5'}`}
                      >
                        <span>{meal.emoji}</span>
                        <span className="text-sm">{meal.label}</span>
                        {isActive && <Check className="w-4 h-4 ml-auto text-orange-400" />}
                      </button>
                    );
                  })}
                </div>
              </div>
            )}

            <div className="border-t border-white/10 pt-4">
              <label className="text-sm text-white/60 mb-2 block">Objetivo calor√≠as diarias</label>
              <input
                type="number"
                value={localGoals.calories}
                onChange={(e) => setLocalGoals(p => ({ ...p, calories: parseInt(e.target.value) || 0 }))}
                className="w-full bg-white/10 rounded-xl p-4 outline-none text-2xl font-bold text-center"
              />
            </div>
            <div className="grid grid-cols-3 gap-3">
              <div>
                <label className="text-[10px] text-emerald-400 mb-1 block">Prote√≠na (g)</label>
                <input
                  type="number"
                  value={localGoals.protein}
                  onChange={(e) => setLocalGoals(p => ({ ...p, protein: parseInt(e.target.value) || 0 }))}
                  className="w-full bg-white/10 rounded-xl p-3 outline-none text-center font-bold"
                />
              </div>
              <div>
                <label className="text-[10px] text-blue-400 mb-1 block">Carbs (g)</label>
                <input
                  type="number"
                  value={localGoals.carbs}
                  onChange={(e) => setLocalGoals(p => ({ ...p, carbs: parseInt(e.target.value) || 0 }))}
                  className="w-full bg-white/10 rounded-xl p-3 outline-none text-center font-bold"
                />
              </div>
              <div>
                <label className="text-[10px] text-amber-400 mb-1 block">Grasas (g)</label>
                <input
                  type="number"
                  value={localGoals.fats}
                  onChange={(e) => setLocalGoals(p => ({ ...p, fats: parseInt(e.target.value) || 0 }))}
                  className="w-full bg-white/10 rounded-xl p-3 outline-none text-center font-bold"
                />
              </div>
            </div>
            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="text-[10px] text-white/40 mb-1 block">Fibra (g)</label>
                <input
                  type="number"
                  value={localGoals.fiber}
                  onChange={(e) => setLocalGoals(p => ({ ...p, fiber: parseInt(e.target.value) || 0 }))}
                  className="w-full bg-white/10 rounded-xl p-3 outline-none text-center"
                />
              </div>
              <div>
                <label className="text-[10px] text-cyan-400 mb-1 block">Vasos agua</label>
                <input
                  type="number"
                  value={localGoals.water}
                  onChange={(e) => setLocalGoals(p => ({ ...p, water: parseInt(e.target.value) || 0 }))}
                  className="w-full bg-white/10 rounded-xl p-3 outline-none text-center"
                />
              </div>
            </div>
          </div>
        </Modal>

        {/* Help Modal */}
        <Modal isOpen={showHelp} onClose={() => setShowHelp(false)} title="Gu√≠a de Nutrici√≥n">
          <div className="space-y-4 text-sm">
            <div className="p-3 bg-orange-500/10 rounded-xl">
              <p className="font-bold text-orange-400 mb-1">üçΩÔ∏è Diario</p>
              <p className="text-white/60">Vista principal con tus calor√≠as y macros del d√≠a.</p>
            </div>
            <div className="p-3 bg-white/5 rounded-xl">
              <p className="font-bold text-emerald-400 mb-1">üìä Macronutrientes</p>
              <p className="text-white/60">
                <strong>Prote√≠na</strong>: M√∫sculos (1.6-2.2g/kg)<br />
                <strong>Carbos</strong>: Energ√≠a<br />
                <strong>Grasas</strong>: Hormonas
              </p>
            </div>
            <div className="p-3 bg-white/5 rounded-xl">
              <p className="font-bold text-blue-400 mb-1">‚ö° Quick Add</p>
              <p className="text-white/60">A√±ade calor√≠as r√°pido sin buscar alimentos.</p>
            </div>
            <div className="p-3 bg-white/5 rounded-xl">
              <p className="font-bold text-cyan-400 mb-1">üíß Agua</p>
              <p className="text-white/60">Meta: 8 vasos (2L) al d√≠a.</p>
            </div>
            <div className="p-3 bg-violet-500/20 rounded-xl">
              <p className="font-bold mb-1">üí° Consejos</p>
              <p className="text-white/60">
                ‚Ä¢ Registra ANTES de comer<br />
                ‚Ä¢ Pesa alimentos al inicio<br />
                ‚Ä¢ Prioriza prote√≠na<br />
                ‚Ä¢ Consistencia &gt; perfecci√≥n
              </p>
            </div>
          </div>
        </Modal>
      </div>
    );
  }

  // SEARCH VIEW
  if (view === 'search') {
    // Search in database
    const databaseResults = FOOD_DATABASE.filter(food => {
      const matchesQuery = !searchQuery ||
        food.name.toLowerCase().includes(searchQuery.toLowerCase());
      const matchesCategory = selectedCategory === 'all' ||
        food.category === selectedCategory;
      return matchesQuery && matchesCategory;
    }).slice(0, 30);

    // Search in recent/frequent
    const filteredRecent = searchQuery
      ? recentFoods.filter(f => f.name.toLowerCase().includes(searchQuery.toLowerCase()))
      : recentFoods;
    const filteredFrequent = searchQuery
      ? frequentFoods.filter(f => f.name.toLowerCase().includes(searchQuery.toLowerCase()))
      : frequentFoods;

    // Log food from database
    const logDatabaseFood = (food, servings = 1) => {
      const meal = {
        id: generateId(),
        day_id: today,
        meal_type: activeMealType,
        name: food.name,
        serving: food.serving,
        servings: servings,
        time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
        calories: Math.round(food.calories * servings),
        protein: Math.round(food.protein * servings),
        carbs: Math.round(food.carbs * servings),
        fats: Math.round(food.fats * servings),
        fiber: Math.round((food.fiber || 0) * servings),
        sugar: Math.round((food.sugar || 0) * servings),
        sodium: Math.round((food.sodium || 0) * servings),
        foodId: food.id
      };
      setData(prev => ({ ...prev, meals: [...prev.meals, meal] }));
      setView('diary');
      showToast('A√±adido');
    };

    // Barcode search
    const searchByBarcode = (barcode) => {
      const found = FOOD_DATABASE.find(f => f.barcode === barcode);
      if (found) {
        logDatabaseFood(found);
      } else {
        showToast('C√≥digo no encontrado');
      }
      setShowScanner(false);
      setScannedBarcode('');
    };

    return (
      <div className="space-y-4 pb-24">
        <AnimatedMount>
          <div className="flex items-center gap-3">
            <button onClick={() => setView('diary')} className="p-2 hover:bg-white/10 rounded-lg">
              <ChevronLeft className="w-5 h-5" />
            </button>
            <h1 className="text-xl font-bold">Buscar alimento</h1>
          </div>
        </AnimatedMount>

        {/* Search bar with scanner button */}
        <AnimatedMount delay={50}>
          <div className="flex gap-2">
            <div className="relative flex-1">
              <input
                type="text"
                placeholder="Buscar alimento..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="w-full bg-white/10 rounded-xl p-4 pl-12 outline-none"
              />
              <Search className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-white/40" />
            </div>
            <button
              onClick={() => setShowScanner(true)}
              className="p-4 bg-orange-500 rounded-xl"
            >
              <Camera className="w-5 h-5" />
            </button>
          </div>
        </AnimatedMount>

        {/* Category filter */}
        <AnimatedMount delay={75}>
          <div className="flex gap-2 overflow-x-auto pb-2 -mx-4 px-4 scrollbar-hide">
            {FOOD_CATEGORIES.map(cat => (
              <button
                key={cat.id}
                onClick={() => setSelectedCategory(cat.id)}
                className={`flex items-center gap-1 px-3 py-2 rounded-lg text-sm whitespace-nowrap transition-colors ${selectedCategory === cat.id
                  ? 'bg-orange-500 text-white'
                  : 'bg-white/10 text-white/70'
                  }`}
              >
                <span>{cat.emoji}</span>
                <span>{cat.name}</span>
              </button>
            ))}
          </div>
        </AnimatedMount>

        {/* Meal type selector */}
        <AnimatedMount delay={100}>
          <div className="flex gap-2">
            {mealTypes.map(({ type, emoji, label }) => (
              <button
                key={type}
                onClick={() => setActiveMealType(type)}
                className={`flex-1 py-2 rounded-lg text-sm ${activeMealType === type ? 'bg-orange-500' : 'bg-white/10'}`}
              >
                {emoji}
              </button>
            ))}
          </div>
        </AnimatedMount>

        {/* Database results */}
        {databaseResults.length > 0 && (
          <AnimatedMount delay={125}>
            <Section title="BASE DE DATOS" icon={BookOpen} iconColor="text-blue-400">
              <div className="space-y-2">
                {databaseResults.map(food => (
                  <Card
                    key={food.id}
                    onClick={() => logDatabaseFood(food)}
                    className="py-3 cursor-pointer hover:bg-white/10"
                  >
                    <div className="flex items-center justify-between">
                      <div className="flex-1">
                        <p className="font-medium">{food.name}</p>
                        <p className="text-xs text-white/40">{food.serving}</p>
                        <p className="text-[10px] text-white/30 mt-0.5">
                          P:{food.protein}g ¬∑ C:{food.carbs}g ¬∑ G:{food.fats}g
                        </p>
                      </div>
                      <div className="text-right">
                        <p className="font-bold text-orange-400">{food.calories}</p>
                        <p className="text-[10px] text-white/40">kcal</p>
                      </div>
                    </div>
                  </Card>
                ))}
              </div>
            </Section>
          </AnimatedMount>
        )}

        {/* Recent */}
        {filteredRecent.length > 0 && (
          <AnimatedMount delay={150}>
            <Section title="RECIENTES" icon={Clock} iconColor="text-violet-400">
              <div className="space-y-2">
                {filteredRecent.map(food => (
                  <Card key={food.id} onClick={() => logRecentFood(food)} className="py-3 cursor-pointer hover:bg-white/10">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="font-medium">{food.name}</p>
                        <p className="text-xs text-white/40">P:{food.protein || 0} ¬∑ C:{food.carbs || 0} ¬∑ G:{food.fats || 0}</p>
                      </div>
                      <div className="text-right">
                        <p className="font-bold text-orange-400">{food.calories}</p>
                        <p className="text-xs text-white/40">kcal</p>
                      </div>
                    </div>
                  </Card>
                ))}
              </div>
            </Section>
          </AnimatedMount>
        )}

        {/* Frequent */}
        {filteredFrequent.length > 0 && (
          <AnimatedMount delay={175}>
            <Section title="FRECUENTES" icon={Flame} iconColor="text-orange-400">
              <div className="space-y-2">
                {filteredFrequent.map(food => (
                  <Card key={food.name} onClick={() => logRecentFood(food)} className="py-3 cursor-pointer hover:bg-white/10">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="font-medium">{food.name}</p>
                        <p className="text-xs text-white/40">Registrado {food.count} veces</p>
                      </div>
                      <div className="text-right">
                        <p className="font-bold text-orange-400">{food.calories}</p>
                        <p className="text-xs text-white/40">kcal</p>
                      </div>
                    </div>
                  </Card>
                ))}
              </div>
            </Section>
          </AnimatedMount>
        )}

        {/* Create new */}
        <AnimatedMount delay={200}>
          <button
            onClick={() => { setView('diary'); setShowAdd(true); }}
            className="w-full py-4 bg-white/10 rounded-xl font-medium flex items-center justify-center gap-2 hover:bg-white/20"
          >
            <Plus className="w-5 h-5" />
            Crear alimento personalizado
          </button>
        </AnimatedMount>

        {/* Barcode Scanner Modal */}
        <Modal isOpen={showScanner} onClose={() => setShowScanner(false)} title="Escanear c√≥digo">
          <div className="space-y-4">
            <div className="aspect-square bg-black/50 rounded-xl flex items-center justify-center relative overflow-hidden">
              <div className="absolute inset-4 border-2 border-orange-500 rounded-lg opacity-50" />
              <div className="absolute left-4 right-4 top-1/2 h-0.5 bg-orange-500 animate-pulse" />
              <Camera className="w-16 h-16 text-white/20" />
            </div>
            <p className="text-center text-sm text-white/50">
              Apunta al c√≥digo de barras del producto
            </p>

            {/* Manual barcode entry */}
            <div className="pt-4 border-t border-white/10">
              <p className="text-xs text-white/40 mb-2">O introduce el c√≥digo manualmente:</p>
              <div className="flex gap-2">
                <input
                  type="text"
                  placeholder="C√≥digo de barras..."
                  value={scannedBarcode}
                  onChange={(e) => setScannedBarcode(e.target.value)}
                  className="flex-1 bg-white/10 rounded-xl p-3 outline-none"
                />
                <button
                  onClick={() => searchByBarcode(scannedBarcode)}
                  className="px-4 bg-orange-500 rounded-xl font-medium"
                >
                  Buscar
                </button>
              </div>
            </div>

            {/* Sample barcodes for demo */}
            <div className="pt-4 border-t border-white/10">
              <p className="text-xs text-white/40 mb-2">Prueba estos c√≥digos de ejemplo:</p>
              <div className="flex flex-wrap gap-2">
                {['8410000000001', '8410000000023', '8410000000045', '8410000000088'].map(code => (
                  <button
                    key={code}
                    onClick={() => searchByBarcode(code)}
                    className="px-3 py-1 bg-white/5 rounded-lg text-xs text-white/60 hover:bg-white/10"
                  >
                    {code}
                  </button>
                ))}
              </div>
            </div>
          </div>
        </Modal>
      </div>
    );
  }

  // SAVED VIEW
  if (view === 'saved') {
    return (
      <div className="space-y-4 pb-24">
        <AnimatedMount>
          <div className="flex items-center gap-3">
            <button onClick={() => setView('diary')} className="p-2 hover:bg-white/10 rounded-lg">
              <ChevronLeft className="w-5 h-5" />
            </button>
            <h1 className="text-xl font-bold">Alimentos guardados</h1>
          </div>
        </AnimatedMount>

        {savedMeals.length > 0 ? (
          <AnimatedMount delay={50}>
            <div className="space-y-2">
              {savedMeals.map(meal => (
                <Card key={meal.id} onClick={() => logRecentFood(meal)} className="py-3 cursor-pointer hover:bg-white/10">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <Award className="w-5 h-5 text-amber-400" />
                      <div>
                        <p className="font-medium">{meal.name}</p>
                        <p className="text-xs text-white/40">P:{meal.protein || 0} ¬∑ C:{meal.carbs || 0} ¬∑ G:{meal.fats || 0}</p>
                      </div>
                    </div>
                    <div className="text-right">
                      <p className="font-bold text-orange-400">{meal.calories}</p>
                      <p className="text-xs text-white/40">kcal</p>
                    </div>
                  </div>
                </Card>
              ))}
            </div>
          </AnimatedMount>
        ) : (
          <AnimatedMount delay={50}>
            <EmptyState
              icon={Award}
              title="Sin favoritos"
              description="Guarda tus alimentos favoritos para acceso r√°pido"
            />
          </AnimatedMount>
        )}
      </div>
    );
  }

  // HISTORY VIEW
  if (view === 'history') {
    const last7Days = Array.from({ length: 7 }, (_, i) => getDateOffset(today, -i));

    return (
      <div className="space-y-4 pb-24">
        <AnimatedMount>
          <div className="flex items-center gap-3">
            <button onClick={() => setView('diary')} className="p-2 hover:bg-white/10 rounded-lg">
              <ChevronLeft className="w-5 h-5" />
            </button>
            <h1 className="text-xl font-bold">Historial</h1>
          </div>
        </AnimatedMount>

        {last7Days.map((date, i) => {
          const dayMeals = data.meals.filter(m => m.day_id === date);
          const dayCals = dayMeals.reduce((s, m) => s + (m.calories || 0), 0);
          const dayProt = dayMeals.reduce((s, m) => s + (m.protein || 0), 0);
          const isToday = date === today;

          return (
            <AnimatedMount key={date} delay={50 + i * 25}>
              <Card className={isToday ? 'border-orange-500/30' : ''}>
                <div className="flex items-center justify-between mb-2">
                  <div>
                    <p className="font-medium">{isToday ? 'Hoy' : formatShortDate(date)}</p>
                    <p className="text-xs text-white/40">{dayMeals.length} registros</p>
                  </div>
                  <div className="text-right">
                    <p className="font-bold text-orange-400">{dayCals} kcal</p>
                    <p className="text-xs text-white/40">{dayProt}g prote√≠na</p>
                  </div>
                </div>
                <ProgressBar value={dayCals} max={localGoals.calories} color="bg-orange-500" />
              </Card>
            </AnimatedMount>
          );
        })}
      </div>
    );
  }

  // INSIGHTS VIEW
  if (view === 'insights') {
    const last7Days = Array.from({ length: 7 }, (_, i) => getDateOffset(today, -i)).reverse();
    const weekCals = last7Days.map(d => data.meals.filter(m => m.day_id === d).reduce((s, m) => s + (m.calories || 0), 0));
    const weekProt = last7Days.map(d => data.meals.filter(m => m.day_id === d).reduce((s, m) => s + (m.protein || 0), 0));
    const avgCals = Math.round(weekCals.reduce((a, b) => a + b, 0) / 7);
    const avgProt = Math.round(weekProt.reduce((a, b) => a + b, 0) / 7);

    return (
      <div className="space-y-4 pb-24">
        <AnimatedMount>
          <div className="flex items-center gap-3">
            <button onClick={() => setView('diary')} className="p-2 hover:bg-white/10 rounded-lg">
              <ChevronLeft className="w-5 h-5" />
            </button>
            <h1 className="text-xl font-bold">Insights</h1>
          </div>
        </AnimatedMount>

        <AnimatedMount delay={50}>
          <Card className="bg-gradient-to-r from-orange-500/20 to-red-500/20">
            <p className="text-sm text-white/60 mb-2">Promedio semanal</p>
            <div className="grid grid-cols-2 gap-4">
              <div className="text-center">
                <p className="text-3xl font-bold text-orange-400">{avgCals}</p>
                <p className="text-xs text-white/40">kcal/d√≠a</p>
              </div>
              <div className="text-center">
                <p className="text-3xl font-bold text-emerald-400">{avgProt}g</p>
                <p className="text-xs text-white/40">prote√≠na/d√≠a</p>
              </div>
            </div>
          </Card>
        </AnimatedMount>

        <AnimatedMount delay={100}>
          <Card>
            <p className="text-sm text-white/60 mb-3">Calor√≠as √∫ltimos 7 d√≠as</p>
            <MiniChart data={weekCals} color="#F97316" height={80} showDots />
            <div className="flex justify-between mt-2 text-[10px] text-white/40">
              {last7Days.map(d => (
                <span key={d}>{new Date(d).getDate()}</span>
              ))}
            </div>
          </Card>
        </AnimatedMount>

        <AnimatedMount delay={150}>
          <Card>
            <p className="text-sm text-white/60 mb-3">Prote√≠na √∫ltimos 7 d√≠as</p>
            <MiniChart data={weekProt} color="#10B981" height={80} showDots />
            <div className="flex justify-between mt-2 text-[10px] text-white/40">
              {last7Days.map(d => (
                <span key={d}>{new Date(d).getDate()}</span>
              ))}
            </div>
          </Card>
        </AnimatedMount>

        <AnimatedMount delay={200}>
          <Card>
            <p className="text-sm text-white/60 mb-2">Racha de registro</p>
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 rounded-full bg-orange-500/20 flex items-center justify-center">
                <Flame className="w-6 h-6 text-orange-400" />
              </div>
              <div>
                <p className="text-2xl font-bold">{loggingStreak} d√≠as</p>
                <p className="text-xs text-white/40">seguidos registrando</p>
              </div>
            </div>
          </Card>
        </AnimatedMount>
      </div>
    );
  }

  return null;
};

// MEALS HELP MODAL - rendered conditionally in all views
const MealsHelpModal = ({ isOpen, onClose }) => (
  <Modal isOpen={isOpen} onClose={onClose} title="Gu√≠a de Nutrici√≥n">
    <div className="space-y-4 text-sm">
      <div className="p-3 bg-orange-500/10 rounded-xl">
        <p className="font-bold text-orange-400 mb-1">üçΩÔ∏è Diario</p>
        <p className="text-white/60">Vista principal con tus calor√≠as y macros del d√≠a. Registra cada comida.</p>
      </div>

      <div className="p-3 bg-white/5 rounded-xl">
        <p className="font-bold text-emerald-400 mb-1">üìä Macronutrientes</p>
        <p className="text-white/60">
          <strong>Prote√≠na</strong>: Construcci√≥n muscular (1.6-2.2g/kg peso)<br />
          <strong>Carbohidratos</strong>: Energ√≠a principal<br />
          <strong>Grasas</strong>: Hormonas y absorci√≥n vitaminas
        </p>
      </div>

      <div className="p-3 bg-white/5 rounded-xl">
        <p className="font-bold text-blue-400 mb-1">‚ö° Quick Add</p>
        <p className="text-white/60">A√±ade calor√≠as/macros r√°pido sin buscar alimentos espec√≠ficos.</p>
      </div>

      <div className="p-3 bg-white/5 rounded-xl">
        <p className="font-bold text-violet-400 mb-1">üîç Buscar</p>
        <p className="text-white/60">Base de datos de alimentos. Busca por nombre y selecciona porciones.</p>
      </div>

      <div className="p-3 bg-white/5 rounded-xl">
        <p className="font-bold text-amber-400 mb-1">‚≠ê Guardados</p>
        <p className="text-white/60">Tus comidas favoritas para a√±adir r√°pidamente.</p>
      </div>

      <div className="p-3 bg-white/5 rounded-xl">
        <p className="font-bold text-cyan-400 mb-1">üíß Agua</p>
        <p className="text-white/60">Registra vasos de agua. Meta: 8 vasos (2L) al d√≠a.</p>
      </div>

      <div className="p-3 bg-violet-500/20 rounded-xl">
        <p className="font-bold mb-1">üí° Consejos</p>
        <p className="text-white/60">
          ‚Ä¢ Registra ANTES de comer para mejor control<br />
          ‚Ä¢ Pesa alimentos al inicio para aprender porciones<br />
          ‚Ä¢ Prioriza prote√≠na en cada comida<br />
          ‚Ä¢ La consistencia importa m√°s que la perfecci√≥n
        </p>
      </div>
    </div>
  </Modal>
);

// ============================================================================
// WORKOUT SCREEN
// ============================================================================

// ============================================================================
// WORKOUT SCREEN - COMPLETE VERSION
// ============================================================================
// ============================================================================
// PLATE CALCULATOR COMPONENT
// ============================================================================
const PlateCalculator = () => {
  const [targetWeight, setTargetWeight] = useState(60);
  const [barWeight, setBarWeight] = useState(20);

  const plates = useMemo(() => {
    const available = [25, 20, 15, 10, 5, 2.5, 1.25];
    const perSide = (targetWeight - barWeight) / 2;
    if (perSide <= 0) return [];

    const result = [];
    let remaining = perSide;

    for (const plate of available) {
      while (remaining >= plate) {
        result.push(plate);
        remaining -= plate;
      }
    }

    return result;
  }, [targetWeight, barWeight]);

  const actualWeight = barWeight + (plates.reduce((s, p) => s + p, 0) * 2);

  return (
    <div className="space-y-4">
      <div>
        <label className="text-sm text-white/60 mb-2 block">Peso objetivo (kg)</label>
        <input
          type="number"
          value={targetWeight}
          onChange={(e) => setTargetWeight(parseFloat(e.target.value) || 0)}
          className="w-full bg-white/10 rounded-xl p-3 outline-none text-xl font-bold text-center"
          step="2.5"
        />
      </div>

      <div>
        <label className="text-sm text-white/60 mb-2 block">Peso de la barra</label>
        <div className="flex gap-2">
          {[15, 20].map(w => (
            <button
              key={w}
              onClick={() => setBarWeight(w)}
              className={`flex-1 py-2 rounded-lg ${barWeight === w ? 'bg-violet-500' : 'bg-white/10'}`}
            >
              {w}kg
            </button>
          ))}
        </div>
      </div>

      {plates.length > 0 ? (
        <div className="bg-white/5 rounded-xl p-4">
          <p className="text-sm text-white/60 mb-3">Discos por lado:</p>
          <div className="flex flex-wrap gap-2 justify-center">
            {plates.map((plate, i) => (
              <div
                key={i}
                className={`w-12 h-12 rounded-full flex items-center justify-center font-bold text-sm
                  ${plate >= 20 ? 'bg-red-500' : plate >= 15 ? 'bg-yellow-500' : plate >= 10 ? 'bg-green-500' : plate >= 5 ? 'bg-blue-500' : 'bg-white/30'}`}
              >
                {plate}
              </div>
            ))}
          </div>
          <p className="text-center text-sm text-white/40 mt-3">
            Peso real: {actualWeight}kg
            {actualWeight !== targetWeight && ` (${targetWeight - actualWeight > 0 ? '-' : '+'}${Math.abs(targetWeight - actualWeight).toFixed(2)}kg)`}
          </p>
        </div>
      ) : (
        <p className="text-center text-white/40 py-4">Solo la barra</p>
      )}
    </div>
  );
};

// ============================================================================
// HABITS SCREEN - Elite Atomic Habits System
// ============================================================================
const HabitsScreen = ({ data, setData, showToast }) => {
  const today = getToday();
  const [view, setView] = useState('today'); // today, history, detail
  const [showAdd, setShowAdd] = useState(false);
  const [showSettings, setShowSettings] = useState(false);
  const [selectedHabit, setSelectedHabit] = useState(null);
  const [historyDate, setHistoryDate] = useState(today);

  // Elite habit form
  const [newHabit, setNewHabit] = useState({
    name: '',
    icon: '‚ú®',
    identity: '',
    why: '',
    cue: '',
    location: '',
    time: '',
    stackedTo: null,
    minVersion: '',
    fullVersion: '',
    frequency: 'daily',
    customDays: [1, 2, 3, 4, 5, 6, 0],
    category: 'growth',
  });

  const [localSettings, setLocalSettings] = useState({
    showStreaks: data.user?.habitsSettings?.showStreaks ?? true,
    reminderTime: data.user?.habitsSettings?.reminderTime || '09:00',
    freezeDaysPerMonth: data.user?.habitsSettings?.freezeDaysPerMonth || 2,
    showIdentity: data.user?.habitsSettings?.showIdentity ?? true,
  });

  const saveSettings = () => {
    setData(prev => ({
      ...prev,
      user: { ...prev.user, habitsSettings: localSettings }
    }));
    setShowSettings(false);
    showToast('Configuraci√≥n guardada');
  };

  const icons = ['‚ú®', 'üßò', 'üìö', 'üö∂', 'üíß', 'üìµ', '‚úçÔ∏è', 'ü§∏', 'üôè', 'üí™', 'üéØ', '‚è∞', 'üèÉ', 'üíä', 'ü•ó', 'üò¥', 'üé®', 'üé∏', 'üí∞', 'üßπ', 'üì±', '‚òÄÔ∏è', 'üåô', '‚ù§Ô∏è'];

  const categories = [
    { id: 'health', name: 'Salud', color: 'emerald', icon: 'üí™' },
    { id: 'mindfulness', name: 'Mente', color: 'violet', icon: 'üßò' },
    { id: 'productivity', name: 'Productividad', color: 'blue', icon: '‚ö°' },
    { id: 'growth', name: 'Crecimiento', color: 'amber', icon: 'üìà' },
    { id: 'social', name: 'Social', color: 'pink', icon: '‚ù§Ô∏è' }
  ];

  // ===================== CALCULATIONS =====================

  const getDayLogs = (date) => {
    return data.habits.map(habit => {
      const log = data.habitLogs?.find(l => l.habit_id === habit.id && l.date === date);
      return { habit, log, completed: log?.completed || false, completedAt: log?.completedAt };
    });
  };

  const dayHabitLogs = getDayLogs(today);
  const completedCount = dayHabitLogs.filter(h => h.completed).length;

  const shouldDoHabitOnDay = (habit, date) => {
    const dayOfWeek = new Date(date).getDay();
    if (habit.frequency === 'daily') return true;
    if (habit.frequency === 'weekdays') return dayOfWeek >= 1 && dayOfWeek <= 5;
    if (habit.frequency === 'weekend') return dayOfWeek === 0 || dayOfWeek === 6;
    if (habit.frequency === 'custom') return (habit.customDays || []).includes(dayOfWeek);
    return true;
  };

  const todayHabits = data.habits.filter(h => shouldDoHabitOnDay(h, today));
  const todayCompletedCount = dayHabitLogs.filter(h => h.completed && shouldDoHabitOnDay(h.habit, today)).length;

  const getStreakWithFreeze = (habitId, freezeDays = 2) => {
    const logs = data.habitLogs?.filter(l => l.habit_id === habitId && l.completed) || [];
    if (logs.length === 0) return { current: 0, best: 0, freezeUsed: 0 };

    const sortedDates = [...new Set(logs.map(l => l.date))].sort().reverse();
    let streak = 0;
    let freezeUsed = 0;
    let currentDate = new Date(today);

    const habit = data.habits.find(h => h.id === habitId);
    const todayLog = logs.find(l => l.date === today);
    if (!todayLog && shouldDoHabitOnDay(habit, today)) {
      currentDate.setDate(currentDate.getDate() - 1);
    }

    for (let i = 0; i < 365; i++) {
      const dateStr = currentDate.toISOString().split('T')[0];
      const wasCompleted = sortedDates.includes(dateStr);
      const shouldDo = shouldDoHabitOnDay(habit, dateStr);

      if (shouldDo) {
        if (wasCompleted) {
          streak++;
        } else if (freezeUsed < freezeDays) {
          freezeUsed++;
        } else {
          break;
        }
      }
      currentDate.setDate(currentDate.getDate() - 1);
    }

    let bestStreak = 0;
    let tempStreak = 0;
    const allDates = sortedDates.sort();
    for (let i = 0; i < allDates.length; i++) {
      if (i === 0) {
        tempStreak = 1;
      } else {
        const prevDate = new Date(allDates[i - 1]);
        const currDate = new Date(allDates[i]);
        const diffDays = Math.round((currDate - prevDate) / (1000 * 60 * 60 * 24));
        if (diffDays === 1) {
          tempStreak++;
        } else {
          tempStreak = 1;
        }
      }
      bestStreak = Math.max(bestStreak, tempStreak);
    }

    return { current: streak, best: bestStreak, freezeUsed };
  };

  const getCompletionRate = (habitId, days = 30) => {
    const habit = data.habits.find(h => h.id === habitId);
    if (!habit) return 0;

    let shouldDo = 0;
    let completed = 0;

    for (let i = 0; i < days; i++) {
      const date = getDateOffset(today, -i);
      if (shouldDoHabitOnDay(habit, date)) {
        shouldDo++;
        const log = data.habitLogs?.find(l => l.habit_id === habitId && l.date === date && l.completed);
        if (log) completed++;
      }
    }

    return shouldDo > 0 ? Math.round((completed / shouldDo) * 100) : 0;
  };

  const getFailPatterns = (habitId) => {
    const habit = data.habits.find(h => h.id === habitId);
    if (!habit) return { days: [] };

    const dayFailCount = [0, 0, 0, 0, 0, 0, 0];
    const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];

    for (let i = 0; i < 90; i++) {
      const date = getDateOffset(today, -i);
      const dayOfWeek = new Date(date).getDay();
      if (shouldDoHabitOnDay(habit, date)) {
        const log = data.habitLogs?.find(l => l.habit_id === habitId && l.date === date && l.completed);
        if (!log) dayFailCount[dayOfWeek]++;
      }
    }

    const maxFails = Math.max(...dayFailCount);
    const failDays = dayFailCount
      .map((count, idx) => ({ day: dayNames[idx], count, idx }))
      .filter(d => d.count > maxFails * 0.5 && d.count > 2)
      .sort((a, b) => b.count - a.count);

    return { days: failDays };
  };

  const getMissedYesterday = (habitId) => {
    const yesterday = getDateOffset(today, -1);
    const habit = data.habits.find(h => h.id === habitId);
    if (!shouldDoHabitOnDay(habit, yesterday)) return false;
    const log = data.habitLogs?.find(l => l.habit_id === habitId && l.date === yesterday && l.completed);
    return !log;
  };

  const getMasteryLevel = (habitId) => {
    const totalCompletions = data.habitLogs?.filter(l => l.habit_id === habitId && l.completed).length || 0;
    const completionRate = getCompletionRate(habitId, 30);
    const streak = getStreakWithFreeze(habitId);

    const score = (totalCompletions * 0.3) + (completionRate * 0.4) + (streak.current * 2);

    if (score >= 100) return 5;
    if (score >= 60) return 4;
    if (score >= 30) return 3;
    if (score >= 15) return 2;
    return 1;
  };

  const isPerfectWeek = () => {
    const weekStart = getDateOffset(today, -6);
    for (let i = 0; i < 7; i++) {
      const date = getDateOffset(weekStart, i);
      for (const habit of data.habits) {
        if (shouldDoHabitOnDay(habit, date)) {
          const log = data.habitLogs?.find(l => l.habit_id === habit.id && l.date === date && l.completed);
          if (!log) return false;
        }
      }
    }
    return data.habits.length > 0;
  };

  // ===================== HANDLERS =====================

  const toggleHabit = (habitId, useMinVersion = false) => {
    const existingLog = data.habitLogs?.find(l => l.habit_id === habitId && l.date === today);

    if (existingLog) {
      setData(prev => ({
        ...prev,
        habitLogs: prev.habitLogs.map(l =>
          l.habit_id === habitId && l.date === today
            ? { ...l, completed: !l.completed, completedAt: !l.completed ? new Date().toISOString() : null, usedMinVersion: useMinVersion }
            : l
        )
      }));
    } else {
      setData(prev => ({
        ...prev,
        habitLogs: [...(prev.habitLogs || []), {
          id: generateId(),
          habit_id: habitId,
          date: today,
          completed: true,
          completedAt: new Date().toISOString(),
          usedMinVersion: useMinVersion
        }]
      }));
    }
  };

  const addHabit = () => {
    if (!newHabit.name) return;

    const habit = {
      id: generateId(),
      ...newHabit,
      created_at: today,
      totalCompletions: 0,
      currentStreak: 0,
      bestStreak: 0,
      freezeDaysUsed: 0
    };

    setData(prev => ({
      ...prev,
      habits: [...prev.habits, habit]
    }));

    setShowAdd(false);
    setNewHabit({
      name: '', icon: '‚ú®', identity: '', why: '', cue: '', location: '', time: '',
      stackedTo: null, minVersion: '', fullVersion: '', frequency: 'daily',
      customDays: [1, 2, 3, 4, 5, 6, 0], category: 'growth'
    });
    showToast('H√°bito creado');
  };

  const updateHabit = (habitId, updates) => {
    setData(prev => ({
      ...prev,
      habits: prev.habits.map(h => h.id === habitId ? { ...h, ...updates } : h)
    }));
    showToast('H√°bito actualizado');
  };

  const deleteHabit = (id) => {
    setData(prev => ({
      ...prev,
      habits: prev.habits.filter(h => h.id !== id),
      habitLogs: prev.habitLogs?.filter(l => l.habit_id !== id) || []
    }));
    setSelectedHabit(null);
    setView('today');
    showToast('H√°bito eliminado');
  };

  // Stats calculations
  const totalCompletions = data.habitLogs?.filter(l => l.completed).length || 0;
  const overallRate = data.habits.length > 0
    ? Math.round(data.habits.reduce((sum, h) => sum + getCompletionRate(h.id, 30), 0) / data.habits.length)
    : 0;
  const bestStreak = Math.max(...data.habits.map(h => getStreakWithFreeze(h.id).best), 0);
  const perfectWeek = isPerfectWeek();

  // ===================== META-HABITS (Auto objectives) =====================

  const metaHabits = [
    {
      id: 'meta_nutrition',
      name: 'Nutrici√≥n',
      icon: 'ü•ó',
      type: 'nutrition',
      check: () => {
        const todayMeals = data.meals?.filter(m => m.day_id === today) || [];
        const totalCals = todayMeals.reduce((s, m) => s + (m.calories || 0), 0);
        const targetCals = data.user?.goals?.calories || 2000;
        return totalCals >= targetCals * 0.8;
      },
      progress: () => {
        const todayMeals = data.meals?.filter(m => m.day_id === today) || [];
        const totalCals = todayMeals.reduce((s, m) => s + (m.calories || 0), 0);
        const targetCals = data.user?.goals?.calories || 2000;
        return Math.min(100, Math.round((totalCals / targetCals) * 100));
      }
    },
    {
      id: 'meta_protein',
      name: 'Prote√≠na',
      icon: 'üí™',
      type: 'nutrition',
      check: () => {
        const todayMeals = data.meals?.filter(m => m.day_id === today) || [];
        const totalProt = todayMeals.reduce((s, m) => s + (m.protein || 0), 0);
        const targetProt = data.user?.goals?.protein || 120;
        return totalProt >= targetProt;
      },
      progress: () => {
        const todayMeals = data.meals?.filter(m => m.day_id === today) || [];
        const totalProt = todayMeals.reduce((s, m) => s + (m.protein || 0), 0);
        const targetProt = data.user?.goals?.protein || 120;
        return Math.min(100, Math.round((totalProt / targetProt) * 100));
      }
    },
    {
      id: 'meta_workout',
      name: 'Entreno',
      icon: 'üèãÔ∏è',
      type: 'workout',
      check: () => {
        const todayWorkout = data.workouts?.find(w => w.day_id === today);
        return todayWorkout?.is_completed || false;
      },
      progress: () => {
        const todayWorkout = data.workouts?.find(w => w.day_id === today);
        if (!todayWorkout) return 0;
        if (todayWorkout.is_completed) return 100;
        const completedSets = todayWorkout.exercises?.reduce((sum, ex) =>
          sum + ex.sets.filter(s => s.completed).length, 0) || 0;
        const totalSets = todayWorkout.exercises?.reduce((sum, ex) => sum + ex.sets.length, 0) || 1;
        return Math.round((completedSets / totalSets) * 100);
      }
    },
    {
      id: 'meta_water',
      name: 'Agua',
      icon: 'üíß',
      type: 'nutrition',
      check: () => {
        const dayData = data.days?.[today];
        const waterGoal = data.user?.goals?.water || 8;
        return (dayData?.water_glasses || 0) >= waterGoal;
      },
      progress: () => {
        const dayData = data.days?.[today];
        const waterGoal = data.user?.goals?.water || 8;
        return Math.min(100, Math.round(((dayData?.water_glasses || 0) / waterGoal) * 100));
      }
    },
    {
      id: 'meta_steps',
      name: '10k pasos',
      icon: 'üö∂',
      type: 'body',
      check: () => {
        const dayData = data.days?.[today];
        const stepsGoal = data.user?.goals?.steps || 10000;
        return (dayData?.steps || 0) >= stepsGoal;
      },
      progress: () => {
        const dayData = data.days?.[today];
        const stepsGoal = data.user?.goals?.steps || 10000;
        return Math.min(100, Math.round(((dayData?.steps || 0) / stepsGoal) * 100));
      }
    }
  ];

  const activeAreas = data.user?.activeAreas || ['nutrition', 'workout', 'habits', 'work', 'personal', 'body', 'finances', 'consciousness', 'relationships'];
  const visibleMetaHabits = metaHabits.filter(m =>
    (m.type === 'nutrition' && activeAreas.includes('nutrition')) ||
    (m.type === 'workout' && activeAreas.includes('workout')) ||
    (m.type === 'body' && activeAreas.includes('body'))
  );

  // ===================== RENDER ADD MODAL =====================

  const renderAddModal = () => (
    <Modal isOpen={showAdd} onClose={() => setShowAdd(false)} title="Nuevo h√°bito elite">
      {/* Icon selector */}
      <div className="mb-4">
        <p className="text-xs text-white/40 mb-2">Icono</p>
        <div className="flex flex-wrap gap-2">
          {icons.map(i => (
            <button key={i} onClick={() => setNewHabit(p => ({ ...p, icon: i }))} className={`w-10 h-10 rounded-lg text-xl flex items-center justify-center ${newHabit.icon === i ? 'bg-violet-500' : 'bg-white/10'}`}>{i}</button>
          ))}
        </div>
      </div>

      {/* Name */}
      <input
        type="text"
        placeholder="Nombre del h√°bito *"
        value={newHabit.name}
        onChange={(e) => setNewHabit(p => ({ ...p, name: e.target.value }))}
        className="w-full bg-white/10 rounded-xl p-4 outline-none mb-3"
      />

      {/* Identity */}
      <div className="mb-3">
        <p className="text-xs text-white/40 mb-1">ü™™ Identidad (James Clear)</p>
        <input
          type="text"
          placeholder="Soy una persona que..."
          value={newHabit.identity}
          onChange={(e) => setNewHabit(p => ({ ...p, identity: e.target.value }))}
          className="w-full bg-white/10 rounded-xl p-3 outline-none text-sm"
        />
      </div>

      {/* Why */}
      <div className="mb-3">
        <p className="text-xs text-white/40 mb-1">¬øPor qu√© es importante?</p>
        <input
          type="text"
          placeholder="Porque me ayuda a..."
          value={newHabit.why}
          onChange={(e) => setNewHabit(p => ({ ...p, why: e.target.value }))}
          className="w-full bg-white/10 rounded-xl p-3 outline-none text-sm"
        />
      </div>

      {/* Implementation Intention */}
      <div className="mb-3 p-3 bg-white/5 rounded-xl">
        <p className="text-xs text-white/40 mb-2">üìç Implementation Intention</p>
        <div className="grid grid-cols-2 gap-2">
          <input
            type="text"
            placeholder="Despu√©s de..."
            value={newHabit.cue}
            onChange={(e) => setNewHabit(p => ({ ...p, cue: e.target.value }))}
            className="bg-white/10 rounded-lg p-2 outline-none text-sm"
          />
          <input
            type="text"
            placeholder="Lugar"
            value={newHabit.location}
            onChange={(e) => setNewHabit(p => ({ ...p, location: e.target.value }))}
            className="bg-white/10 rounded-lg p-2 outline-none text-sm"
          />
        </div>
        <input
          type="time"
          value={newHabit.time}
          onChange={(e) => setNewHabit(p => ({ ...p, time: e.target.value }))}
          className="w-full bg-white/10 rounded-lg p-2 outline-none text-sm mt-2"
        />
      </div>

      {/* Habit Stacking */}
      {data.habits.length > 0 && (
        <div className="mb-3">
          <p className="text-xs text-white/40 mb-1">üîó Encadenar despu√©s de:</p>
          <select
            value={newHabit.stackedTo || ''}
            onChange={(e) => setNewHabit(p => ({ ...p, stackedTo: e.target.value || null }))}
            className="w-full bg-white/10 rounded-xl p-3 outline-none text-sm"
          >
            <option value="">Ninguno</option>
            {data.habits.map(h => (
              <option key={h.id} value={h.id}>{h.icon} {h.name}</option>
            ))}
          </select>
        </div>
      )}

      {/* 2 Minute Rule */}
      <div className="mb-3 p-3 bg-emerald-500/10 rounded-xl">
        <p className="text-xs text-emerald-400 mb-2">‚ö° Regla de 2 minutos</p>
        <input
          type="text"
          placeholder="Versi√≥n m√≠nima (2 min)"
          value={newHabit.minVersion}
          onChange={(e) => setNewHabit(p => ({ ...p, minVersion: e.target.value }))}
          className="w-full bg-white/10 rounded-lg p-2 outline-none text-sm mb-2"
        />
        <input
          type="text"
          placeholder="Versi√≥n completa"
          value={newHabit.fullVersion}
          onChange={(e) => setNewHabit(p => ({ ...p, fullVersion: e.target.value }))}
          className="w-full bg-white/10 rounded-lg p-2 outline-none text-sm"
        />
      </div>

      {/* Frequency */}
      <div className="mb-3">
        <p className="text-xs text-white/40 mb-2">üìÖ Frecuencia</p>
        <div className="flex gap-2 flex-wrap">
          {[
            { id: 'daily', label: 'Diario' },
            { id: 'weekdays', label: 'L-V' },
            { id: 'weekend', label: 'Fines' },
            { id: 'custom', label: 'Custom' }
          ].map(f => (
            <button
              key={f.id}
              onClick={() => setNewHabit(p => ({ ...p, frequency: f.id }))}
              className={`px-3 py-1.5 rounded-lg text-sm ${newHabit.frequency === f.id ? 'bg-violet-500' : 'bg-white/10'}`}
            >
              {f.label}
            </button>
          ))}
        </div>
        {newHabit.frequency === 'custom' && (
          <div className="flex gap-1 mt-2">
            {['D', 'L', 'M', 'X', 'J', 'V', 'S'].map((day, idx) => (
              <button
                key={idx}
                onClick={() => {
                  const dayNum = idx === 0 ? 0 : idx;
                  setNewHabit(p => ({
                    ...p,
                    customDays: p.customDays.includes(dayNum)
                      ? p.customDays.filter(d => d !== dayNum)
                      : [...p.customDays, dayNum]
                  }));
                }}
                className={`w-8 h-8 rounded-lg text-xs ${newHabit.customDays.includes(idx === 0 ? 0 : idx) ? 'bg-violet-500' : 'bg-white/10'}`}
              >
                {day}
              </button>
            ))}
          </div>
        )}
      </div>

      {/* Category */}
      <div className="mb-4">
        <p className="text-xs text-white/40 mb-2">Categor√≠a</p>
        <div className="flex gap-2 flex-wrap">
          {categories.map(c => (
            <button
              key={c.id}
              onClick={() => setNewHabit(p => ({ ...p, category: c.id }))}
              className={`px-3 py-1.5 rounded-lg text-sm flex items-center gap-1 ${newHabit.category === c.id ? `bg-${c.color}-500` : 'bg-white/10'}`}
            >
              <span>{c.icon}</span> {c.name}
            </button>
          ))}
        </div>
      </div>

      <button
        onClick={addHabit}
        disabled={!newHabit.name}
        className={`w-full py-4 rounded-xl font-medium ${newHabit.name ? 'bg-violet-500' : 'bg-white/10 text-white/30'}`}
      >
        Crear h√°bito
      </button>
    </Modal>
  );

  // ===================== RENDER DETAIL VIEW =====================

  const renderDetailView = () => {
    const habit = selectedHabit;
    if (!habit) return null;

    const streak = getStreakWithFreeze(habit.id, localSettings.freezeDaysPerMonth);
    const completionRate = getCompletionRate(habit.id, 30);
    const masteryLevel = getMasteryLevel(habit.id);
    const failPatterns = getFailPatterns(habit.id);
    const missedYesterday = getMissedYesterday(habit.id);
    const habitTotalCompletions = data.habitLogs?.filter(l => l.habit_id === habit.id && l.completed).length || 0;

    const last30Days = Array.from({ length: 30 }, (_, i) => {
      const date = getDateOffset(today, -i);
      const log = data.habitLogs?.find(l => l.habit_id === habit.id && l.date === date);
      const shouldDo = shouldDoHabitOnDay(habit, date);
      return { date, completed: log?.completed, shouldDo, usedMinVersion: log?.usedMinVersion };
    }).reverse();

    const masteryLabels = ['Principiante', 'Aprendiz', 'Intermedio', 'Avanzado', 'Maestro'];
    const masteryColors = ['bg-gray-500', 'bg-blue-500', 'bg-emerald-500', 'bg-violet-500', 'bg-amber-500'];

    return (
      <div className="space-y-4 pb-24">
        <AnimatedMount>
          <button onClick={() => { setView('today'); setSelectedHabit(null); }} className="flex items-center gap-2 text-white/50 mb-2">
            <ChevronLeft className="w-4 h-4" /> Volver
          </button>
          <div className="flex items-center gap-3">
            <span className="text-4xl">{habit.icon}</span>
            <div>
              <h1 className="text-2xl font-bold">{habit.name}</h1>
              {habit.identity && <p className="text-sm text-violet-400 italic">"{habit.identity}"</p>}
            </div>
          </div>
        </AnimatedMount>

        {/* Never Miss Twice Alert */}
        {missedYesterday && (
          <AnimatedMount delay={25}>
            <Card className="bg-red-500/20 border-red-500/30">
              <div className="flex items-center gap-3">
                <AlertCircle className="w-5 h-5 text-red-400" />
                <div>
                  <p className="font-medium text-red-300">¬°No falles dos veces!</p>
                  <p className="text-sm text-red-400/70">Ayer no completaste este h√°bito. Hoy es crucial.</p>
                </div>
              </div>
            </Card>
          </AnimatedMount>
        )}

        {/* Stats Grid */}
        <AnimatedMount delay={50}>
          <div className="grid grid-cols-3 gap-3">
            <Card className="text-center">
              <p className="text-2xl font-bold text-orange-400">{streak.current}</p>
              <p className="text-[10px] text-white/40">Racha actual üî•</p>
              {streak.freezeUsed > 0 && <p className="text-[9px] text-blue-400">‚ùÑÔ∏è {streak.freezeUsed} freeze</p>}
            </Card>
            <Card className="text-center">
              <p className="text-2xl font-bold text-emerald-400">{completionRate}%</p>
              <p className="text-[10px] text-white/40">√öltimo mes</p>
            </Card>
            <Card className="text-center">
              <p className="text-2xl font-bold text-violet-400">{habitTotalCompletions}</p>
              <p className="text-[10px] text-white/40">Total</p>
            </Card>
          </div>
        </AnimatedMount>

        {/* Mastery Level */}
        <AnimatedMount delay={75}>
          <Card>
            <div className="flex items-center justify-between mb-2">
              <p className="text-sm font-medium">Nivel de maestr√≠a</p>
              <span className={`px-2 py-0.5 rounded text-xs font-medium ${masteryColors[masteryLevel - 1]}`}>
                {masteryLabels[masteryLevel - 1]}
              </span>
            </div>
            <div className="flex gap-1">
              {[1, 2, 3, 4, 5].map(level => (
                <div
                  key={level}
                  className={`flex-1 h-2 rounded ${level <= masteryLevel ? masteryColors[masteryLevel - 1] : 'bg-white/10'}`}
                />
              ))}
            </div>
          </Card>
        </AnimatedMount>

        {/* 30 Day History */}
        <AnimatedMount delay={100}>
          <Card>
            <p className="text-sm font-medium mb-3">√öltimos 30 d√≠as</p>
            <div className="grid grid-cols-10 gap-1">
              {last30Days.map((day, i) => (
                <div
                  key={i}
                  title={day.date}
                  className={`aspect-square rounded-sm ${!day.shouldDo ? 'bg-white/5' :
                    day.completed ? (day.usedMinVersion ? 'bg-emerald-500/50' : 'bg-emerald-500') :
                      'bg-red-500/30'
                    }`}
                />
              ))}
            </div>
            <div className="flex gap-4 mt-2 text-[9px] text-white/40">
              <span className="flex items-center gap-1"><div className="w-2 h-2 bg-emerald-500 rounded-sm" /> Completo</span>
              <span className="flex items-center gap-1"><div className="w-2 h-2 bg-emerald-500/50 rounded-sm" /> M√≠nimo</span>
              <span className="flex items-center gap-1"><div className="w-2 h-2 bg-red-500/30 rounded-sm" /> Fallado</span>
            </div>
          </Card>
        </AnimatedMount>

        {/* Fail Patterns */}
        {failPatterns.days.length > 0 && (
          <AnimatedMount delay={125}>
            <Card className="bg-amber-500/10 border-amber-500/20">
              <p className="text-sm font-medium text-amber-300 mb-2">‚ö†Ô∏è Patr√≥n de fallos</p>
              <p className="text-xs text-amber-400/70">
                Sueles fallar m√°s los: {failPatterns.days.map(d => d.day).join(', ')}
              </p>
            </Card>
          </AnimatedMount>
        )}

        {/* Implementation Details */}
        {(habit.cue || habit.location || habit.time) && (
          <AnimatedMount delay={150}>
            <Card>
              <p className="text-sm font-medium mb-2">üìç Plan de implementaci√≥n</p>
              {habit.cue && <p className="text-xs text-white/60">Despu√©s de: {habit.cue}</p>}
              {habit.location && <p className="text-xs text-white/60">Lugar: {habit.location}</p>}
              {habit.time && <p className="text-xs text-white/60">Hora: {habit.time}</p>}
            </Card>
          </AnimatedMount>
        )}

        {/* Why */}
        {habit.why && (
          <AnimatedMount delay={175}>
            <Card>
              <p className="text-sm font-medium mb-2">üí° Por qu√©</p>
              <p className="text-xs text-white/60">{habit.why}</p>
            </Card>
          </AnimatedMount>
        )}

        {/* Delete Button */}
        <AnimatedMount delay={200}>
          <button
            onClick={() => deleteHabit(habit.id)}
            className="w-full py-3 bg-red-500/20 text-red-400 rounded-xl flex items-center justify-center gap-2"
          >
            <Trash2 className="w-4 h-4" /> Eliminar h√°bito
          </button>
        </AnimatedMount>
      </div>
    );
  };

  // ===================== RENDER HISTORY VIEW =====================

  const renderHistoryView = () => {
    const weekDates = getWeekDates(historyDate);

    return (
      <div className="space-y-4 pb-24">
        <AnimatedMount>
          <button onClick={() => setView('today')} className="flex items-center gap-2 text-white/50 mb-2">
            <ChevronLeft className="w-4 h-4" /> Volver
          </button>
          <h1 className="text-2xl font-bold">Historial</h1>
        </AnimatedMount>

        {/* Week Navigation */}
        <AnimatedMount delay={50}>
          <Card>
            <div className="flex items-center justify-between mb-4">
              <button onClick={() => setHistoryDate(getDateOffset(historyDate, -7))} className="p-2 hover:bg-white/10 rounded-lg">
                <ChevronLeft className="w-5 h-5" />
              </button>
              <p className="text-sm font-medium">
                {new Date(weekDates[0]).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' })} - {new Date(weekDates[6]).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' })}
              </p>
              <button onClick={() => setHistoryDate(getDateOffset(historyDate, 7))} className="p-2 hover:bg-white/10 rounded-lg">
                <ChevronRight className="w-5 h-5" />
              </button>
            </div>

            {/* Week Grid */}
            <div className="grid grid-cols-8 gap-1">
              <div />
              {['L', 'M', 'X', 'J', 'V', 'S', 'D'].map((day, i) => (
                <div key={i} className="text-center text-xs text-white/40">{day}</div>
              ))}

              {data.habits.map(habit => (
                <React.Fragment key={habit.id}>
                  <div className="text-sm truncate flex items-center">{habit.icon}</div>
                  {weekDates.map((date, i) => {
                    const log = data.habitLogs?.find(l => l.habit_id === habit.id && l.date === date);
                    const shouldDo = shouldDoHabitOnDay(habit, date);
                    return (
                      <div
                        key={i}
                        className={`aspect-square rounded flex items-center justify-center text-xs ${!shouldDo ? 'bg-white/5 text-white/20' :
                          log?.completed ? 'bg-emerald-500 text-white' :
                            'bg-red-500/30 text-red-300'
                          }`}
                      >
                        {shouldDo && (log?.completed ? '‚úì' : '‚úó')}
                      </div>
                    );
                  })}
                </React.Fragment>
              ))}
            </div>
          </Card>
        </AnimatedMount>

        {/* Week Summary */}
        <AnimatedMount delay={100}>
          <Card>
            <p className="text-sm font-medium mb-3">Resumen semanal</p>
            {data.habits.map(habit => {
              let weekCompletions = 0;
              let weekShouldDo = 0;
              weekDates.forEach(date => {
                if (shouldDoHabitOnDay(habit, date)) {
                  weekShouldDo++;
                  if (data.habitLogs?.find(l => l.habit_id === habit.id && l.date === date && l.completed)) weekCompletions++;
                }
              });
              const rate = weekShouldDo > 0 ? Math.round((weekCompletions / weekShouldDo) * 100) : 0;

              return (
                <div key={habit.id} className="flex items-center gap-3 py-2">
                  <span>{habit.icon}</span>
                  <span className="flex-1 text-sm">{habit.name}</span>
                  <span className="text-sm text-white/60">{weekCompletions}/{weekShouldDo}</span>
                  <span className={`text-sm font-medium ${rate >= 80 ? 'text-emerald-400' : rate >= 50 ? 'text-amber-400' : 'text-red-400'}`}>
                    {rate}%
                  </span>
                </div>
              );
            })}
          </Card>
        </AnimatedMount>
      </div>
    );
  };

  // ===================== EMPTY STATE =====================

  if (!data.habits.length) {
    return (
      <div className="pb-24">
        <AnimatedMount><h1 className="text-2xl font-bold mb-6">H√°bitos</h1></AnimatedMount>
        <EmptyState
          icon={CheckSquare}
          title="Construye tu identidad"
          description="Los h√°bitos son los ladrillos de quien quieres ser"
          action="Crear primer h√°bito"
          onAction={() => setShowAdd(true)}
        />
        {renderAddModal()}
      </div>
    );
  }

  // ===================== MAIN TODAY VIEW =====================

  if (view === 'detail') return renderDetailView();
  if (view === 'history') return renderHistoryView();

  const habitStats = data.habits.map(habit => {
    const streak = getStreakWithFreeze(habit.id, localSettings.freezeDaysPerMonth);
    const completionRate = getCompletionRate(habit.id, 30);
    const masteryLevel = getMasteryLevel(habit.id);
    const totalDone = data.habitLogs?.filter(l => l.habit_id === habit.id && l.completed).length || 0;
    return { habit, streak, completionRate, masteryLevel, totalDone };
  }).sort((a, b) => b.streak.current - a.streak.current);

  const avgStreak = data.habits.length > 0
    ? Math.round(habitStats.reduce((sum, h) => sum + h.streak.current, 0) / data.habits.length)
    : 0;

  const needsAttention = habitStats.filter(h => h.completionRate < 50).sort((a, b) => a.completionRate - b.completionRate);

  return (
    <div className="space-y-4 pb-24">
      <AnimatedMount>
        <div className="flex items-center justify-between">
          <h1 className="text-2xl font-bold">H√°bitos</h1>
          <div className="flex items-center gap-2">
            <button onClick={() => setView('history')} className="p-3 hover:bg-white/10 rounded-full">
              <Calendar className="w-5 h-5 text-white/50" />
            </button>
            <button onClick={() => setShowSettings(true)} className="p-3 hover:bg-white/10 rounded-full">
              <Settings className="w-5 h-5 text-white/50" />
            </button>
            <button onClick={() => setShowAdd(true)} className="bg-violet-500 rounded-full p-3">
              <Plus className="w-5 h-5" />
            </button>
          </div>
        </div>
      </AnimatedMount>

      {/* Main Summary Card */}
      <AnimatedMount delay={50}>
        <Card className="bg-gradient-to-br from-emerald-500/20 via-violet-500/10 to-fuchsia-500/20 border-emerald-500/30">
          <div className="flex items-center gap-4 mb-4">
            <div className="relative w-20 h-20">
              <svg className="w-20 h-20 -rotate-90">
                <circle cx="40" cy="40" r="34" fill="none" stroke="rgba(255,255,255,0.1)" strokeWidth="8" />
                <circle
                  cx="40" cy="40" r="34" fill="none"
                  stroke="url(#mainGradient)"
                  strokeWidth="8"
                  strokeLinecap="round"
                  strokeDasharray={`${todayHabits.length > 0 ? (todayCompletedCount / todayHabits.length) * 214 : 0} 214`}
                />
                <defs>
                  <linearGradient id="mainGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stopColor="#10b981" />
                    <stop offset="100%" stopColor="#8b5cf6" />
                  </linearGradient>
                </defs>
              </svg>
              <div className="absolute inset-0 flex flex-col items-center justify-center">
                <span className="text-2xl font-bold">{todayHabits.length > 0 ? Math.round((todayCompletedCount / todayHabits.length) * 100) : 0}%</span>
                <span className="text-[9px] text-white/40">hoy</span>
              </div>
            </div>

            <div className="flex-1">
              <div className="flex items-center gap-2 mb-1">
                <p className="font-medium text-lg">{todayCompletedCount}/{todayHabits.length} completados</p>
                {perfectWeek && <span className="text-amber-400 text-sm">üèÜ</span>}
              </div>
              <p className="text-sm text-white/50">
                {todayCompletedCount === todayHabits.length && todayHabits.length > 0
                  ? '¬°D√≠a perfecto! Sigue as√≠ üí™'
                  : `${todayHabits.length - todayCompletedCount} pendiente${todayHabits.length - todayCompletedCount !== 1 ? 's' : ''}`}
              </p>
            </div>
          </div>

          {/* Quick Stats Row */}
          <div className="grid grid-cols-4 gap-2 pt-3 border-t border-white/10">
            <div className="text-center">
              <p className="text-lg font-bold text-orange-400">{bestStreak}</p>
              <p className="text-[9px] text-white/40">Mejor üî•</p>
            </div>
            <div className="text-center">
              <p className="text-lg font-bold text-emerald-400">{avgStreak}</p>
              <p className="text-[9px] text-white/40">Media üî•</p>
            </div>
            <div className="text-center">
              <p className="text-lg font-bold text-blue-400">{overallRate}%</p>
              <p className="text-[9px] text-white/40">30 d√≠as</p>
            </div>
            <div className="text-center">
              <p className="text-lg font-bold text-violet-400">{totalCompletions}</p>
              <p className="text-[9px] text-white/40">Total ‚úì</p>
            </div>
          </div>
        </Card>
      </AnimatedMount>

      {/* Meta-Habits (Auto from other areas) */}
      {visibleMetaHabits.length > 0 && (
        <AnimatedMount delay={75}>
          <div>
            <p className="text-xs text-white/40 mb-2 flex items-center gap-1">
              <Zap className="w-3 h-3" /> OBJETIVOS AUTO <span className="text-white/20">(80% = ‚úì)</span>
            </p>
            <Card>
              <div className="grid grid-cols-2 gap-2">
                {visibleMetaHabits.map(meta => {
                  const isCompleted = meta.check();
                  const progress = meta.progress();
                  return (
                    <div
                      key={meta.id}
                      className={`flex items-center gap-2 p-2 rounded-lg ${isCompleted ? 'bg-emerald-500/20' : 'bg-white/5'}`}
                    >
                      <span className="text-lg">{meta.icon}</span>
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center justify-between">
                          <span className={`text-xs ${isCompleted ? 'text-emerald-400' : 'text-white/70'}`}>{meta.name}</span>
                          <span className="text-[10px] text-white/40">{progress}%</span>
                        </div>
                        <div className="w-full h-1.5 bg-white/10 rounded-full mt-1">
                          <div
                            className={`h-full rounded-full transition-all ${isCompleted ? 'bg-emerald-500' : 'bg-orange-500'}`}
                            style={{ width: `${progress}%` }}
                          />
                        </div>
                      </div>
                      {isCompleted && <Check className="w-3 h-3 text-emerald-400 flex-shrink-0" />}
                    </div>
                  );
                })}
              </div>
            </Card>
          </div>
        </AnimatedMount>
      )}

      {/* Ranking Rachas */}
      {habitStats.length >= 2 && (
        <AnimatedMount delay={100}>
          <div>
            <p className="text-xs text-white/40 mb-2 flex items-center gap-1">
              <Trophy className="w-3 h-3" /> RANKING RACHAS
            </p>
            <div className="flex gap-2 overflow-x-auto pb-1">
              {habitStats.slice(0, 4).map((item, idx) => (
                <Card
                  key={item.habit.id}
                  className={`flex-shrink-0 w-24 text-center cursor-pointer ${idx === 0 ? 'bg-amber-500/10 border-amber-500/30' : ''}`}
                  onClick={() => { setSelectedHabit(item.habit); setView('detail'); }}
                >
                  <span className="text-2xl">{item.habit.icon}</span>
                  <p className="text-lg font-bold text-orange-400 mt-1">{item.streak.current}üî•</p>
                  <p className="text-[9px] text-white/40 truncate">{item.habit.name}</p>
                  {idx === 0 && <p className="text-[8px] text-amber-400 mt-1">üëë L√≠der</p>}
                </Card>
              ))}
            </div>
          </div>
        </AnimatedMount>
      )}

      {/* Needs Attention */}
      {needsAttention.length > 0 && (
        <AnimatedMount delay={125}>
          <Card className="bg-amber-500/10 border-amber-500/20">
            <div className="flex items-center gap-2 mb-2">
              <AlertCircle className="w-4 h-4 text-amber-400" />
              <p className="text-sm font-medium text-amber-300">Necesitan atenci√≥n</p>
            </div>
            <div className="flex flex-wrap gap-2">
              {needsAttention.slice(0, 3).map(item => (
                <button
                  key={item.habit.id}
                  onClick={() => { setSelectedHabit(item.habit); setView('detail'); }}
                  className="flex items-center gap-2 px-2 py-1 bg-white/5 rounded-lg"
                >
                  <span>{item.habit.icon}</span>
                  <span className="text-xs">{item.habit.name}</span>
                  <span className="text-[10px] text-red-400">{item.completionRate}%</span>
                </button>
              ))}
            </div>
          </Card>
        </AnimatedMount>
      )}

      {/* Today's Habits */}
      <AnimatedMount delay={150}>
        <div>
          <p className="text-xs text-white/40 mb-2">HOY</p>
          <div className="space-y-2">
            {data.habits.map(habit => {
              const log = dayHabitLogs.find(h => h.habit.id === habit.id);
              const isCompleted = log?.completed || false;
              const usedMinVersion = log?.usedMinVersion || false;
              const shouldDoToday = shouldDoHabitOnDay(habit, today);
              const streak = getStreakWithFreeze(habit.id, localSettings.freezeDaysPerMonth);
              const missedYesterday = getMissedYesterday(habit.id);
              const masteryLevel = getMasteryLevel(habit.id);
              const stackedHabit = habit.stackedTo ? data.habits.find(h => h.id === habit.stackedTo) : null;
              const completionRate = getCompletionRate(habit.id, 30);

              if (!shouldDoToday) return null;

              return (
                <div key={habit.id} className="relative">
                  {missedYesterday && !isCompleted && (
                    <div className="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full animate-pulse z-10" />
                  )}

                  <SwipeableItem onDelete={() => deleteHabit(habit.id)}>
                    <div className={`flex items-center gap-3 p-3 rounded-xl transition-all ${isCompleted ? 'bg-emerald-500/20' : 'bg-white/5'} ${missedYesterday && !isCompleted ? 'ring-1 ring-red-500/50' : ''}`}>
                      <button
                        onClick={() => toggleHabit(habit.id)}
                        className={`w-11 h-11 rounded-xl border-2 flex items-center justify-center flex-shrink-0 ${isCompleted ? 'bg-emerald-500 border-emerald-500' : 'border-white/30 hover:border-white/50'
                          }`}
                      >
                        {isCompleted ? <Check className="w-5 h-5" /> : <span className="text-xl">{habit.icon}</span>}
                      </button>

                      <button
                        className="flex-1 text-left"
                        onClick={() => { setSelectedHabit(habit); setView('detail'); }}
                      >
                        <div className="flex items-center gap-2">
                          <p className={isCompleted ? 'line-through text-white/50' : 'font-medium'}>{habit.name}</p>
                          <div className="flex gap-0.5">
                            {[1, 2, 3, 4, 5].map(l => (
                              <div key={l} className={`w-1.5 h-1.5 rounded-full ${l <= masteryLevel ? 'bg-violet-400' : 'bg-white/10'}`} />
                            ))}
                          </div>
                        </div>

                        <div className="flex items-center gap-3 mt-0.5">
                          {streak.current > 0 && (
                            <span className="text-xs text-orange-400">{streak.current}üî•</span>
                          )}
                          <span className="text-[10px] text-white/30">{completionRate}% mes</span>
                          {stackedHabit && (
                            <span className="text-[10px] text-white/40">‚Üí {stackedHabit.icon}</span>
                          )}
                          {habit.time && (
                            <span className="text-[10px] text-white/30">{habit.time}</span>
                          )}
                          {usedMinVersion && isCompleted && (
                            <span className="text-[10px] text-emerald-400/60">‚ö° m√≠nimo</span>
                          )}
                        </div>
                      </button>

                      {!isCompleted && habit.minVersion && (
                        <button
                          onClick={() => toggleHabit(habit.id, true)}
                          className="px-2 py-1 bg-emerald-500/20 rounded-lg text-[10px] text-emerald-400"
                          title="Versi√≥n m√≠nima"
                        >
                          ‚ö° 2min
                        </button>
                      )}

                      <ChevronRight className="w-4 h-4 text-white/20" />
                    </div>
                  </SwipeableItem>
                </div>
              );
            })}

            {/* Habits not for today */}
            {data.habits.filter(h => !shouldDoHabitOnDay(h, today)).length > 0 && (
              <div className="pt-2 mt-2 border-t border-white/10">
                <p className="text-[10px] text-white/30 mb-2">No programados hoy:</p>
                <div className="flex flex-wrap gap-2">
                  {data.habits.filter(h => !shouldDoHabitOnDay(h, today)).map(habit => (
                    <button
                      key={habit.id}
                      onClick={() => { setSelectedHabit(habit); setView('detail'); }}
                      className="flex items-center gap-1 px-2 py-1 bg-white/5 rounded-lg text-white/40"
                    >
                      <span>{habit.icon}</span>
                      <span className="text-xs">{habit.name}</span>
                    </button>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>
      </AnimatedMount>

      {/* Weekly Insights */}
      <AnimatedMount delay={175}>
        <Card>
          <p className="text-sm font-medium mb-3">üìä Esta semana</p>
          <div className="flex gap-1 mb-3">
            {['L', 'M', 'X', 'J', 'V', 'S', 'D'].map((day, idx) => {
              const weekDates = getWeekDates(today);
              const date = weekDates[idx];
              const isToday = date === today;
              const dayLogs = data.habitLogs?.filter(l => l.date === date && l.completed) || [];
              const dayHabitsCount = data.habits.filter(h => shouldDoHabitOnDay(h, date)).length;
              const percentage = dayHabitsCount > 0 ? dayLogs.length / dayHabitsCount : 0;

              return (
                <div key={idx} className={`flex-1 text-center py-2 rounded-lg ${isToday ? 'bg-violet-500/20 ring-1 ring-violet-500/50' : ''}`}>
                  <p className="text-[9px] text-white/40">{day}</p>
                  <div className={`w-6 h-6 mx-auto mt-1 rounded-full flex items-center justify-center text-[10px] font-medium
                    ${percentage === 1 ? 'bg-emerald-500 text-white' :
                      percentage >= 0.5 ? 'bg-emerald-500/30 text-emerald-300' :
                        percentage > 0 ? 'bg-amber-500/30 text-amber-300' :
                          'bg-white/5 text-white/30'}
                  `}>
                    {percentage === 1 ? '‚úì' : Math.round(percentage * 100) || '-'}
                  </div>
                </div>
              );
            })}
          </div>

          {/* Week completion rate */}
          {(() => {
            const weekDates = getWeekDates(today);
            let weekTotal = 0, weekCompleted = 0;
            weekDates.forEach(date => {
              data.habits.forEach(h => {
                if (shouldDoHabitOnDay(h, date)) {
                  weekTotal++;
                  if (data.habitLogs?.find(l => l.habit_id === h.id && l.date === date && l.completed)) weekCompleted++;
                }
              });
            });
            const weekRate = weekTotal > 0 ? Math.round((weekCompleted / weekTotal) * 100) : 0;

            return (
              <div className="flex items-center justify-between pt-2 border-t border-white/10">
                <span className="text-sm text-white/60">Completado esta semana</span>
                <span className={`text-sm font-bold ${weekRate >= 80 ? 'text-emerald-400' : weekRate >= 50 ? 'text-amber-400' : 'text-red-400'}`}>
                  {weekRate}%
                </span>
              </div>
            );
          })()}
        </Card>
      </AnimatedMount>

      {/* Tip Card for Never Miss Twice */}
      {dayHabitLogs.some(h => getMissedYesterday(h.habit.id) && !h.completed) && (
        <AnimatedMount delay={200}>
          <Card className="bg-amber-500/10 border-amber-500/20">
            <div className="flex items-start gap-3">
              <Brain className="w-5 h-5 text-amber-400 flex-shrink-0 mt-0.5" />
              <div>
                <p className="text-sm font-medium text-amber-300">Regla de oro</p>
                <p className="text-xs text-amber-400/70">"Nunca falles dos veces seguidas" - La recuperaci√≥n es m√°s importante que la perfecci√≥n.</p>
              </div>
            </div>
          </Card>
        </AnimatedMount>
      )}

      {renderAddModal()}

      {/* Settings Modal */}
      <Modal
        isOpen={showSettings}
        onClose={() => setShowSettings(false)}
        title="Configuraci√≥n H√°bitos"
      >
        <div className="space-y-4">
          <div className="flex items-center justify-between py-3">
            <div>
              <p className="font-medium">Mostrar rachas</p>
              <p className="text-sm text-white/50">Ver d√≠as consecutivos</p>
            </div>
            <button
              onClick={() => setLocalSettings(p => ({ ...p, showStreaks: !p.showStreaks }))}
              className={`w-12 h-7 rounded-full transition-colors ${localSettings.showStreaks ? 'bg-violet-500' : 'bg-white/20'}`}
            >
              <div className={`w-5 h-5 bg-white rounded-full transition-transform ${localSettings.showStreaks ? 'translate-x-6' : 'translate-x-1'}`} />
            </button>
          </div>

          <div className="flex items-center justify-between py-3">
            <div>
              <p className="font-medium">Mostrar identidad</p>
              <p className="text-sm text-white/50">Ver "Soy una persona que..."</p>
            </div>
            <button
              onClick={() => setLocalSettings(p => ({ ...p, showIdentity: !p.showIdentity }))}
              className={`w-12 h-7 rounded-full transition-colors ${localSettings.showIdentity ? 'bg-violet-500' : 'bg-white/20'}`}
            >
              <div className={`w-5 h-5 bg-white rounded-full transition-transform ${localSettings.showIdentity ? 'translate-x-6' : 'translate-x-1'}`} />
            </button>
          </div>

          <div>
            <label className="text-sm text-white/60 mb-2 block">D√≠as de gracia por mes (freeze)</label>
            <div className="flex items-center gap-4">
              <input
                type="range"
                min="0"
                max="5"
                value={localSettings.freezeDaysPerMonth}
                onChange={(e) => setLocalSettings(p => ({ ...p, freezeDaysPerMonth: parseInt(e.target.value) }))}
                className="flex-1 accent-violet-500"
              />
              <span className="text-xl font-bold w-8">{localSettings.freezeDaysPerMonth}</span>
            </div>
            <p className="text-xs text-white/40 mt-1">D√≠as que puedes fallar sin romper la racha</p>
          </div>

          <div>
            <label className="text-sm text-white/60 mb-2 block">Hora recordatorio</label>
            <input
              type="time"
              value={localSettings.reminderTime}
              onChange={(e) => setLocalSettings(p => ({ ...p, reminderTime: e.target.value }))}
              className="w-full bg-white/10 rounded-xl p-4 outline-none"
            />
          </div>

          <button onClick={saveSettings} className="w-full py-4 bg-violet-500 rounded-xl font-medium">
            Guardar cambios
          </button>
        </div>
      </Modal>
    </div>
  );
};

// ============================================================================
// WORK SCREEN - Elite GTD + Eisenhower System
// ============================================================================
const WorkScreen = ({ data, setData, showToast }) => {
  const today = getToday();


  // ============================================================================
  // STATE
  // ============================================================================
  const [view, setView] = useState('agenda'); // agenda, inbox, matrix, kanban, projects
  const [viewDate, setViewDate] = useState(today);
  const [showAdd, setShowAdd] = useState(false);
  const [showTaskDetail, setShowTaskDetail] = useState(null);
  const [showProjectModal, setShowProjectModal] = useState(false);
  const [showSettings, setShowSettings] = useState(false);
  const [showHelp, setShowHelp] = useState(false);
  const [expandedProjects, setExpandedProjects] = useState({});
  const [filterProject, setFilterProject] = useState('all');


  // Drag & Drop state
  const [draggedTask, setDraggedTask] = useState(null);
  const [dragOverTarget, setDragOverTarget] = useState(null);


  // Kanban view settings
  const [kanbanColumns, setKanbanColumns] = useState(2);


  // New task
  const [newTask, setNewTask] = useState({
    title: '',
    description: '',
    project_id: '',
    priority: 'medium',
    eisenhower: 'q2',
    status: 'todo',
    timeEstimate: 30,
    dueDate: today,
    isDeepWork: false
  });


  // New project
  const [newProject, setNewProject] = useState({
    name: '',
    color: '#8B5CF6',
    description: '',
    objective: '',
    deadline: ''
  });


  // Settings
  const [localSettings, setLocalSettings] = useState({
    showCompleted: data.user.workSettings?.showCompleted ?? true,
    dailyDeepWorkGoal: data.user.workSettings?.dailyDeepWorkGoal || 4
  });


  // ============================================================================
  // DATA
  // ============================================================================
  const workTasks = data.workTasks || [];
  const workProjects = data.workProjects || [];


  // Navigation helpers
  const goToPrevDay = () => setViewDate(getDateOffset(viewDate, -1));
  const goToNextDay = () => setViewDate(getDateOffset(viewDate, 1));
  const goToToday = () => setViewDate(today);
  const isToday = viewDate === today;


  // Filtered tasks
  const getTasksForDate = (date) => workTasks.filter(t => t.dueDate === date || t.scheduledDate === date);
  const dateTasks = getTasksForDate(viewDate);
  const dateTasksPending = dateTasks.filter(t => !t.completed);
  const dateTasksCompleted = dateTasks.filter(t => t.completed);


  // Inbox = sin procesar (no tienen proyecto NI fecha asignada)
  const inboxTasks = workTasks.filter(t => !t.project_id && !t.dueDate && !t.completed);


  // Overdue
  const overdueTasks = workTasks.filter(t => t.dueDate && t.dueDate < today && !t.completed);


  // By Eisenhower quadrant (all pending tasks)
  const allPending = workTasks.filter(t => !t.completed);
  const q1Tasks = allPending.filter(t => t.eisenhower === 'q1'); // Urgente + Importante = HACER YA
  const q2Tasks = allPending.filter(t => t.eisenhower === 'q2'); // Importante = PLANIFICAR
  const q3Tasks = allPending.filter(t => t.eisenhower === 'q3'); // Urgente = DELEGAR
  const q4Tasks = allPending.filter(t => t.eisenhower === 'q4'); // Ninguno = ELIMINAR


  // By Kanban status
  const backlogTasks = allPending.filter(t => !t.status || t.status === 'backlog');
  const todoTasks = allPending.filter(t => t.status === 'todo');
  const doingTasks = allPending.filter(t => t.status === 'doing');
  const doneTasks = workTasks.filter(t => t.completed);


  // Stats
  const completedToday = workTasks.filter(t => t.completedAt?.startsWith(today)).length;
  const deepWorkToday = workTasks
    .filter(t => t.isDeepWork && t.completed && t.completedAt?.startsWith(today))
    .reduce((sum, t) => sum + (t.timeEstimate || 0), 0);


  // ============================================================================
  // ACTIONS
  // ============================================================================
  const addTask = () => {
    if (!newTask.title.trim()) return;


    const task = {
      id: generateId(),
      ...newTask,
      scheduledDate: newTask.dueDate || null,
      createdAt: new Date().toISOString(),
      completed: false,
      completedAt: null
    };

    setData(prev => ({
      ...prev,
      workTasks: [...(prev.workTasks || []), task]
    }));

    setShowAdd(false);
    setNewTask({
      title: '', description: '', project_id: '', priority: 'medium',
      eisenhower: 'q2', status: 'todo', timeEstimate: 30, dueDate: viewDate, isDeepWork: false
    });
    showToast('‚úì Tarea creada');

  };


  const toggleTask = (id) => {
    setData(prev => ({
      ...prev,
      workTasks: prev.workTasks.map(t =>
        t.id === id ? {
          ...t,
          completed: !t.completed,
          completedAt: !t.completed ? new Date().toISOString() : null,
          status: !t.completed ? 'done' : 'todo'
        } : t
      )
    }));
  };


  const deleteTask = (id) => {
    setData(prev => ({ ...prev, workTasks: prev.workTasks.filter(t => t.id !== id) }));
    showToast('Tarea eliminada');
  };


  const updateTask = (id, updates) => {
    setData(prev => ({
      ...prev,
      workTasks: prev.workTasks.map(t => t.id === id ? { ...t, ...updates } : t)
    }));
  };


  // DRAG & DROP HANDLERS
  const handleDragStart = (e, task) => {
    setDraggedTask(task);
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', task.id);
  };


  const handleDragEnd = () => {
    setDraggedTask(null);
    setDragOverTarget(null);
  };


  const handleDragOver = (e, target) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    setDragOverTarget(target);
  };


  const handleDragLeave = () => {
    setDragOverTarget(null);
  };


  // Drop on Eisenhower quadrant
  const handleDropOnQuadrant = (e, quadrant) => {
    e.preventDefault();
    if (draggedTask) {
      updateTask(draggedTask.id, { eisenhower: quadrant });
      showToast(`Movido a ${quadrant === 'q1' ? 'Hacer' : quadrant === 'q2' ? 'Planificar' : quadrant === 'q3' ? 'Delegar' : 'Eliminar'}`);
    }
    setDraggedTask(null);
    setDragOverTarget(null);
  };


  // Drop on Kanban column
  const handleDropOnKanban = (e, status) => {
    e.preventDefault();
    if (draggedTask) {
      const updates = { status };
      if (status === 'done') {
        updates.completed = true;
        updates.completedAt = new Date().toISOString();
      } else if (draggedTask.completed) {
        updates.completed = false;
        updates.completedAt = null;
      }
      updateTask(draggedTask.id, updates);
      showToast(`Movido a ${status === 'backlog' ? 'Backlog' : status === 'todo' ? 'Por hacer' : status === 'doing' ? 'En progreso' : 'Hecho'}`);
    }
    setDraggedTask(null);
    setDragOverTarget(null);
  };


  // Drop on Project
  const handleDropOnProject = (e, projectId) => {
    e.preventDefault();
    if (draggedTask) {
      updateTask(draggedTask.id, { project_id: projectId });
      const project = workProjects.find(p => p.id === projectId);
      showToast(`Asignado a ${project?.name || 'Sin proyecto'}`);
    }
    setDraggedTask(null);
    setDragOverTarget(null);
  };


  // Drop on Date (in agenda)
  const handleDropOnDate = (e, date) => {
    e.preventDefault();
    if (draggedTask) {
      updateTask(draggedTask.id, { dueDate: date, scheduledDate: date });
      showToast(`Programado para ${formatDate(date)}`);
    }
    setDraggedTask(null);
    setDragOverTarget(null);
  };


  // Process inbox item (assign project + date + quadrant)
  const processInboxItem = (task) => {
    setShowTaskDetail(task);
  };


  const addProject = () => {
    if (!newProject.name.trim()) return;
    setData(prev => ({
      ...prev,
      workProjects: [...(prev.workProjects || []), {
        id: generateId(),
        ...newProject,
        status: 'active',
        createdAt: new Date().toISOString()
      }]
    }));
    setShowProjectModal(false);
    setNewProject({ name: '', color: '#8B5CF6', description: '', objective: '', deadline: '' });
    showToast('Proyecto creado');
  };


  const deleteProject = (id) => {
    setData(prev => ({
      ...prev,
      workProjects: prev.workProjects.filter(p => p.id !== id),
      workTasks: prev.workTasks.map(t => t.project_id === id ? { ...t, project_id: '' } : t)
    }));
    showToast('Proyecto eliminado');
  };


  const saveSettings = () => {
    setData(prev => ({ ...prev, user: { ...prev.user, workSettings: localSettings } }));
    setShowSettings(false);
    showToast('Guardado');
  };


  // ============================================================================
  // HELPERS
  // ============================================================================
  const formatTime = (min) => min < 60 ? `${min}m` : `${Math.floor(min / 60)}h${min % 60 ? ` ${min % 60}m` : ''}`;
  const getProject = (id) => workProjects.find(p => p.id === id);


  const priorityStyles = {
    high: { border: 'border-red-500', bg: 'bg-red-500', text: 'text-red-400', label: 'üî¥ Alta' },
    medium: { border: 'border-amber-500', bg: 'bg-amber-500', text: 'text-amber-400', label: 'üü° Media' },
    low: { border: 'border-blue-500', bg: 'bg-blue-500', text: 'text-blue-400', label: 'üîµ Baja' }
  };


  const quadrantInfo = {
    q1: { label: 'üî• HACER', desc: 'Urgente + Importante', color: 'red', bg: 'bg-red-500/10', border: 'border-red-500/30' },
    q2: { label: 'üìÖ PLANIFICAR', desc: 'Importante (no urgente)', color: 'blue', bg: 'bg-blue-500/10', border: 'border-blue-500/30' },
    q3: { label: 'üë§ DELEGAR', desc: 'Urgente (no importante)', color: 'amber', bg: 'bg-amber-500/10', border: 'border-amber-500/30' },
    q4: { label: 'üóëÔ∏è ELIMINAR', desc: 'Ni urgente ni importante', color: 'gray', bg: 'bg-zinc-800', border: 'border-white/10' }
  };


  const statusInfo = {
    backlog: { label: 'üìã Backlog', desc: 'Ideas pendientes' },
    todo: { label: 'üìå Por hacer', desc: 'Listo para empezar' },
    doing: { label: 'üîÑ En progreso', desc: 'Trabajando ahora' },
    done: { label: '‚úÖ Hecho', desc: 'Completado' }
  };


  // ============================================================================
  // DRAGGABLE TASK CARD
  // ============================================================================
  const DraggableTask = ({ task, compact = false, showProject = true, showDate = false }) => {
    const project = getProject(task.project_id);
    const priority = priorityStyles[task.priority] || priorityStyles.medium;
    const isOverdue = task.dueDate && task.dueDate < today && !task.completed;
    const isDragging = draggedTask?.id === task.id;


    return (
      <div
        draggable
        onDragStart={(e) => handleDragStart(e, task)}
        onDragEnd={handleDragEnd}
        className={`cursor-grab active:cursor-grabbing transition-all ${isDragging ? 'opacity-50 scale-95' : ''}`}
      >
        <Card
          className={`${task.completed ? 'opacity-50' : ''} ${isOverdue ? 'border-red-500/50' : ''} ${compact ? 'py-2 px-3' : ''} hover:bg-white/10`}
          onClick={() => setShowTaskDetail(task)}
        >
          <div className="flex gap-3">
            {/* Checkbox */}
            <button
              onClick={(e) => { e.stopPropagation(); toggleTask(task.id); }}
              className={`w-5 h-5 rounded-md border-2 flex items-center justify-center flex-shrink-0 mt-0.5 transition-all ${task.completed ? 'bg-emerald-500 border-emerald-500' : priority.border
                }`}
            >
              {task.completed && <Check className="w-3 h-3" />}
            </button>

            {/* Content */}
            <div className="flex-1 min-w-0">
              <p className={`${compact ? 'text-sm' : 'font-medium'} ${task.completed ? 'line-through text-white/40' : ''}`}>
                {task.title}
              </p>

              {!compact && task.description && (
                <p className="text-xs text-white/40 mt-0.5 line-clamp-1">{task.description}</p>
              )}

              <div className="flex items-center gap-2 mt-1.5 flex-wrap">
                {showProject && project && (
                  <span className="text-[10px] px-1.5 py-0.5 rounded-full" style={{ backgroundColor: project.color + '30', color: project.color }}>
                    {project.name}
                  </span>
                )}
                {task.timeEstimate && (
                  <span className="text-[10px] text-white/40 flex items-center gap-0.5">
                    <Clock className="w-3 h-3" />{formatTime(task.timeEstimate)}
                  </span>
                )}
                {task.isDeepWork && <Brain className="w-3 h-3 text-violet-400" />}
                {showDate && task.dueDate && (
                  <span className={`text-[10px] ${isOverdue ? 'text-red-400' : 'text-white/40'}`}>
                    üìÖ {formatDate(task.dueDate)}
                  </span>
                )}
                {isOverdue && <span className="text-[10px] text-red-400">‚ö†Ô∏è Vencida</span>}
              </div>
            </div>

            {/* Drag handle indicator */}
            <div className="text-white/20 self-center">
              <MoreHorizontal className="w-4 h-4" />
            </div>
          </div>
        </Card>
      </div>
    );

  };


  // ============================================================================
  // VIEW: AGENDA (Navigate by day)
  // ============================================================================
  const AgendaView = () => {
    const weekDays = [];
    for (let i = -3; i <= 3; i++) weekDays.push(getDateOffset(viewDate, i));


    return (
      <div className="space-y-4">
        {/* Date Navigator */}
        <Card className="py-3">
          <div className="flex items-center justify-between mb-3">
            <button onClick={goToPrevDay} className="p-2 hover:bg-white/10 rounded-lg"><ChevronLeft className="w-5 h-5" /></button>
            <div className="text-center">
              <p className="text-lg font-bold">{isToday ? 'Hoy' : formatDate(viewDate)}</p>
              <p className="text-xs text-white/50">{new Date(viewDate).toLocaleDateString('es', { weekday: 'long' })}</p>
            </div>
            <button onClick={goToNextDay} className="p-2 hover:bg-white/10 rounded-lg"><ChevronRight className="w-5 h-5" /></button>
          </div>

          {/* Week strip - droppable */}
          <div className="flex justify-between">
            {weekDays.map(date => {
              const isSelected = date === viewDate;
              const isCurrent = date === today;
              const dayTasks = getTasksForDate(date).filter(t => !t.completed);
              const isDropTarget = dragOverTarget === `date-${date}`;

              return (
                <div
                  key={date}
                  onClick={() => setViewDate(date)}
                  onDragOver={(e) => handleDragOver(e, `date-${date}`)}
                  onDragLeave={handleDragLeave}
                  onDrop={(e) => handleDropOnDate(e, date)}
                  className={`w-10 h-14 rounded-lg flex flex-col items-center justify-center cursor-pointer transition-all ${isSelected ? 'bg-violet-500' :
                    isDropTarget ? 'bg-violet-500/30 ring-2 ring-violet-500' :
                      isCurrent ? 'bg-white/10 ring-1 ring-violet-500' : 'hover:bg-white/5'
                    }`}
                >
                  <span className="text-[10px] text-white/50">{new Date(date).toLocaleDateString('es', { weekday: 'short' }).charAt(0).toUpperCase()}</span>
                  <span className="text-sm font-bold">{new Date(date).getDate()}</span>
                  {dayTasks.length > 0 && <div className="w-1.5 h-1.5 rounded-full bg-amber-400 mt-0.5" />}
                </div>
              );
            })}
          </div>

          {!isToday && (
            <button onClick={goToToday} className="w-full mt-2 py-1.5 text-xs text-violet-400 hover:bg-violet-500/10 rounded-lg">
              Ir a hoy
            </button>
          )}
        </Card>

        {/* Day stats */}
        {dateTasks.length > 0 && (
          <div className="flex gap-3">
            <Card className="flex-1 py-2 text-center">
              <p className="text-2xl font-bold">{dateTasksCompleted.length}/{dateTasks.length}</p>
              <p className="text-[10px] text-white/40">completadas</p>
            </Card>
            <Card className="flex-1 py-2 text-center">
              <p className="text-2xl font-bold">{dateTasks.length > 0 ? Math.round((dateTasksCompleted.length / dateTasks.length) * 100) : 0}%</p>
              <p className="text-[10px] text-white/40">progreso</p>
            </Card>
          </div>
        )}

        {/* Overdue warning */}
        {overdueTasks.length > 0 && isToday && (
          <Card className="bg-red-500/10 border-red-500/30 py-2">
            <div className="flex items-center gap-2">
              <AlertCircle className="w-4 h-4 text-red-400" />
              <span className="text-sm text-red-400">{overdueTasks.length} tarea{overdueTasks.length > 1 ? 's' : ''} vencida{overdueTasks.length > 1 ? 's' : ''}</span>
            </div>
          </Card>
        )}

        {/* Tasks */}
        {dateTasksPending.length > 0 && (
          <div className="space-y-2">
            <p className="text-xs text-white/40">Pendientes ({dateTasksPending.length})</p>
            {dateTasksPending.map(task => <DraggableTask key={task.id} task={task} />)}
          </div>
        )}

        {localSettings.showCompleted && dateTasksCompleted.length > 0 && (
          <div className="space-y-2">
            <p className="text-xs text-white/40">‚úì Completadas ({dateTasksCompleted.length})</p>
            {dateTasksCompleted.map(task => <DraggableTask key={task.id} task={task} />)}
          </div>
        )}

        {dateTasks.length === 0 && (
          <EmptyState
            icon={Calendar}
            title={`Sin tareas para ${isToday ? 'hoy' : 'este d√≠a'}`}
            description="Arrastra tareas aqu√≠ o crea una nueva"
            action="Nueva tarea"
            onAction={() => { setNewTask(p => ({ ...p, dueDate: viewDate })); setShowAdd(true); }}
          />
        )}

        <button
          onClick={() => { setNewTask(p => ({ ...p, dueDate: viewDate })); setShowAdd(true); }}
          className="w-full py-3 border-2 border-dashed border-white/20 rounded-xl text-white/40 hover:border-violet-500 hover:text-violet-400 flex items-center justify-center gap-2"
        >
          <Plus className="w-4 h-4" />
          A√±adir tarea
        </button>
      </div>
    );

  };


  // ============================================================================
  // VIEW: INBOX (GTD - Captura y procesa)
  // ============================================================================
  const InboxView = () => {
    const [quickInput, setQuickInput] = useState('');


    const quickAdd = () => {
      if (!quickInput.trim()) return;
      const task = {
        id: generateId(),
        title: quickInput,
        description: '',
        project_id: '',
        priority: 'medium',
        eisenhower: 'q2',
        status: 'backlog',
        timeEstimate: 30,
        dueDate: '',
        scheduledDate: '',
        isDeepWork: false,
        completed: false,
        createdAt: new Date().toISOString()
      };
      setData(prev => ({ ...prev, workTasks: [...(prev.workTasks || []), task] }));
      setQuickInput('');
      showToast('Capturado en Inbox');
    };

    return (
      <div className="space-y-4">
        {/* Explanation */}
        <Card className="bg-amber-500/10 border-amber-500/20">
          <div className="flex gap-3">
            <div className="text-2xl">üì•</div>
            <div>
              <p className="font-medium text-amber-400">¬øQu√© es el Inbox?</p>
              <p className="text-xs text-white/60 mt-1">
                <strong>Captura r√°pida</strong>: Anota todo lo que te venga a la mente sin pensar d√≥nde va.
                <br /><strong>Procesa despu√©s</strong>: Asigna proyecto, fecha y prioridad a cada tarea.
                <br /><strong>Regla 2 min</strong>: Si tarda menos de 2 min, hazlo ya.
              </p>
            </div>
          </div>
        </Card>

        {/* Quick capture */}
        <Card>
          <div className="flex gap-2">
            <input
              type="text"
              value={quickInput}
              onChange={(e) => setQuickInput(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && quickAdd()}
              placeholder="Captura r√°pida... (Enter)"
              className="flex-1 bg-transparent outline-none"
            />
            <button onClick={quickAdd} disabled={!quickInput.trim()} className="px-4 py-2 bg-violet-500 rounded-lg disabled:opacity-50">
              <Plus className="w-4 h-4" />
            </button>
          </div>
        </Card>

        {/* Inbox items */}
        {inboxTasks.length > 0 ? (
          <div className="space-y-2">
            <p className="text-xs text-white/40">{inboxTasks.length} sin procesar</p>
            {inboxTasks.map(task => (
              <Card key={task.id} className="border-amber-500/20">
                <div className="flex items-center gap-3">
                  <div className="w-5 h-5 rounded-full border-2 border-amber-400/50" />
                  <div className="flex-1">
                    <p>{task.title}</p>
                    <p className="text-[10px] text-white/30">{new Date(task.createdAt).toLocaleDateString()}</p>
                  </div>
                  <button
                    onClick={() => processInboxItem(task)}
                    className="px-3 py-1.5 bg-violet-500 rounded-lg text-xs"
                  >
                    Procesar
                  </button>
                </div>
              </Card>
            ))}
          </div>
        ) : (
          <EmptyState icon={Target} title="Inbox vac√≠o" description="¬°Genial! Todo est√° procesado" />
        )}
      </div>
    );

  };


  // ============================================================================
  // VIEW: MATRIX (Eisenhower) - Long press + drag in one gesture
  // ============================================================================
  const MatrixView = () => {
    const [dragTask, setDragTask] = useState(null);
    const [dragPosition, setDragPosition] = useState({ x: 0, y: 0 });
    const [currentDropZone, setCurrentDropZone] = useState(null);
    const pressTimer = useRef(null);
    const startPos = useRef({ x: 0, y: 0 });


    const quadrants = [
      { id: 'q1', ...quadrantInfo.q1, tasks: q1Tasks },
      { id: 'q2', ...quadrantInfo.q2, tasks: q2Tasks },
      { id: 'q3', ...quadrantInfo.q3, tasks: q3Tasks },
      { id: 'q4', ...quadrantInfo.q4, tasks: q4Tasks }
    ];

    const activateDrag = (task, x, y) => {
      setDragTask(task);
      setDragPosition({ x, y });
      if (navigator.vibrate) navigator.vibrate(50);
    };

    const handlePointerDown = (e, task) => {
      // Don't prevent default - let scroll work
      const x = e.clientX || e.touches?.[0]?.clientX;
      const y = e.clientY || e.touches?.[0]?.clientY;
      startPos.current = { x, y };

      pressTimer.current = setTimeout(() => {
        activateDrag(task, x, y);
      }, 400);
    };

    const handlePointerMove = (e) => {
      const x = e.clientX || e.touches?.[0]?.clientX;
      const y = e.clientY || e.touches?.[0]?.clientY;

      if (!dragTask && pressTimer.current) {
        const dx = Math.abs(x - startPos.current.x);
        const dy = Math.abs(y - startPos.current.y);
        if (dx > 8 || dy > 8) {
          clearTimeout(pressTimer.current);
          pressTimer.current = null;
        }
      }

      if (dragTask) {
        e.preventDefault?.(); // Only prevent when dragging
        setDragPosition({ x, y });
        const elements = document.elementsFromPoint(x, y);
        const dropZone = elements.find(el => el.dataset.quadrant);
        setCurrentDropZone(dropZone?.dataset.quadrant || null);
      }
    };

    const handlePointerUp = (e) => {
      const x = e.clientX || e.changedTouches?.[0]?.clientX;
      const y = e.clientY || e.changedTouches?.[0]?.clientY;

      if (pressTimer.current) {
        clearTimeout(pressTimer.current);
        pressTimer.current = null;
      }

      if (dragTask) {
        if (currentDropZone && currentDropZone !== dragTask.eisenhower) {
          updateTask(dragTask.id, { eisenhower: currentDropZone });
          if (navigator.vibrate) navigator.vibrate([30, 50, 30]);
          showToast(`‚Üí ${quadrantInfo[currentDropZone].label}`);
        }
        setDragTask(null);
        setCurrentDropZone(null);
      } else {
        const dx = Math.abs(x - startPos.current.x);
        const dy = Math.abs(y - startPos.current.y);
        if (dx < 10 && dy < 10) {
          const elements = document.elementsFromPoint(x, y);
          const taskEl = elements.find(el => el.dataset.taskId);
          if (taskEl) {
            const task = workTasks.find(t => t.id === taskEl.dataset.taskId);
            if (task) setShowTaskDetail(task);
          }
        }
      }
    };

    useEffect(() => {
      if (dragTask) {
        const onMove = (e) => handlePointerMove(e);
        const onEnd = (e) => handlePointerUp(e);

        window.addEventListener('mousemove', onMove);
        window.addEventListener('mouseup', onEnd);
        window.addEventListener('touchmove', onMove, { passive: false });
        window.addEventListener('touchend', onEnd);

        return () => {
          window.removeEventListener('mousemove', onMove);
          window.removeEventListener('mouseup', onEnd);
          window.removeEventListener('touchmove', onMove);
          window.removeEventListener('touchend', onEnd);
        };
      }
    }, [dragTask, currentDropZone]);

    return (
      <div className="space-y-3">
        {/* Matrix 2x2 grid */}
        <div className="grid grid-cols-2 gap-2">
          {quadrants.map(q => {
            const isDropping = currentDropZone === q.id;
            const colorClass = q.color === 'red' ? 'text-red-400 border-red-500/40' :
              q.color === 'blue' ? 'text-blue-400 border-blue-500/40' :
                q.color === 'amber' ? 'text-amber-400 border-amber-500/40' :
                  'text-white/40 border-white/20';

            return (
              <div
                key={q.id}
                data-quadrant={q.id}
                className={`rounded-2xl p-3 min-h-[200px] transition-all duration-200 border-2 ${q.bg} ${isDropping ? 'ring-2 ring-violet-400 scale-[1.02] bg-violet-500/20 border-violet-400' : colorClass
                  }`}
              >
                <div className="flex items-center justify-between mb-2">
                  <div>
                    <p className={`text-xs font-bold ${colorClass.split(' ')[0]}`}>{q.label}</p>
                    <p className="text-[9px] text-white/40">{q.desc}</p>
                  </div>
                  <span className="w-6 h-6 rounded-full bg-black/30 flex items-center justify-center text-[10px]">
                    {q.tasks.length}
                  </span>
                </div>

                <div className="space-y-1.5 max-h-40 overflow-y-auto" data-quadrant={q.id}>
                  {q.tasks.map(task => {
                    const isDragging = dragTask?.id === task.id;

                    return (
                      <div
                        key={task.id}
                        data-task-id={task.id}
                        onMouseDown={(e) => handlePointerDown(e, task)}
                        onTouchStart={(e) => handlePointerDown(e, task)}
                        className={`p-2 bg-black/40 rounded-lg text-[11px] flex items-center gap-2 select-none transition-all
                        ${isDragging ? 'opacity-30 scale-95' : 'hover:bg-black/60'}
                        cursor-pointer`}
                      >
                        <button
                          onClick={(e) => { e.stopPropagation(); toggleTask(task.id); }}
                          className={`w-4 h-4 rounded border-2 flex-shrink-0 flex items-center justify-center ${task.completed ? 'bg-emerald-500 border-emerald-500' :
                            priorityStyles[task.priority]?.border || 'border-white/30'
                            }`}
                        >
                          {task.completed && <Check className="w-2.5 h-2.5" />}
                        </button>
                        <span className={`truncate flex-1 ${task.completed ? 'line-through opacity-50' : ''}`}>
                          {task.title}
                        </span>
                        {task.isDeepWork && <Brain className="w-3 h-3 text-violet-400 flex-shrink-0" />}
                      </div>
                    );
                  })}
                  {q.tasks.length === 0 && (
                    <div className={`flex flex-col items-center justify-center h-28 rounded-xl border-2 border-dashed transition-all ${isDropping ? 'border-violet-400 bg-violet-500/10' : 'border-white/10'
                      }`}>
                      <span className="text-2xl mb-1 opacity-50">{q.label.split(' ')[0]}</span>
                      <p className="text-[10px] text-white/30">Suelta aqu√≠</p>
                    </div>
                  )}
                </div>
              </div>
            );
          })}
        </div>

        {/* Legend */}
        <div className="grid grid-cols-2 gap-x-4 gap-y-1 text-[10px] px-2">
          <div className="flex items-center gap-2">
            <div className="w-2.5 h-2.5 rounded bg-red-500/50" />
            <span className="text-white/50">Urgente + Importante</span>
          </div>
          <div className="flex items-center gap-2">
            <div className="w-2.5 h-2.5 rounded bg-blue-500/50" />
            <span className="text-white/50">Importante (planificar)</span>
          </div>
          <div className="flex items-center gap-2">
            <div className="w-2.5 h-2.5 rounded bg-amber-500/50" />
            <span className="text-white/50">Urgente (delegar)</span>
          </div>
          <div className="flex items-center gap-2">
            <div className="w-2.5 h-2.5 rounded bg-zinc-600" />
            <span className="text-white/50">Eliminar</span>
          </div>
        </div>

        {/* Floating drag preview */}
        {dragTask && (
          <div
            className="fixed pointer-events-none z-50 p-2 bg-violet-600 rounded-lg shadow-2xl shadow-violet-500/50 max-w-[140px]"
            style={{
              left: dragPosition.x - 70,
              top: dragPosition.y - 20,
              transform: 'rotate(3deg) scale(1.05)'
            }}
          >
            <p className="text-xs font-medium truncate">{dragTask.title}</p>
          </div>
        )}

        <p className="text-[10px] text-white/30 text-center">
          Toca = editar ¬∑ Mant√©n y arrastra = mover
        </p>
      </div>
    );

  };


  // ============================================================================
  // ============================================================================
  // ============================================================================
  // ============================================================================
  // ============================================================================
  // ============================================================================
  // ============================================================================
  // VIEW: KANBAN - Simple native drag
  // ============================================================================
  const KanbanView = () => {
    const scrollRef = useRef(null);
    const [draggedId, setDraggedId] = useState(null);
    const [overCol, setOverCol] = useState(null);


    const columns = [
      { id: 'backlog', ...statusInfo.backlog, tasks: filterProject === 'all' ? backlogTasks : backlogTasks.filter(t => t.project_id === filterProject) },
      { id: 'todo', ...statusInfo.todo, tasks: filterProject === 'all' ? todoTasks : todoTasks.filter(t => t.project_id === filterProject) },
      { id: 'doing', ...statusInfo.doing, tasks: filterProject === 'all' ? doingTasks : doingTasks.filter(t => t.project_id === filterProject) },
      { id: 'done', ...statusInfo.done, tasks: (filterProject === 'all' ? doneTasks : doneTasks.filter(t => t.project_id === filterProject)).slice(0, 20) }
    ];

    const getColumnStyle = () => {
      switch (kanbanColumns) {
        case 1: return { width: '100%', minWidth: '280px' };
        case 2: return { width: 'calc(50% - 6px)', minWidth: '160px' };
        case 3: return { width: 'calc(33.333% - 6px)', minWidth: '120px' };
        default: return { width: 'calc(50% - 6px)', minWidth: '160px' };
      }
    };

    const compact = kanbanColumns === 3;

    const handleDrop = (colId) => {
      const task = workTasks.find(t => t.id === draggedId);
      if (task && colId !== task.status) {
        const updates = { status: colId };
        if (colId === 'done') {
          updates.completed = true;
          updates.completedAt = new Date().toISOString();
        } else if (task.completed) {
          updates.completed = false;
          updates.completedAt = null;
        }
        updateTask(task.id, updates);
        showToast('‚Üí ' + (statusInfo[colId]?.label || colId));

        // Scroll to target column after re-render
        setTimeout(() => {
          const targetCol = document.querySelector(`[data-colid="${colId}"]`);
          if (targetCol) {
            targetCol.scrollIntoView({ behavior: 'instant', inline: 'center', block: 'nearest' });
          }
        }, 50);
      }
      setDraggedId(null);
      setOverCol(null);
    };

    return (
      <div
        className="space-y-3"
        onDragOver={(e) => { e.preventDefault(); e.stopPropagation(); }}
        onDragEnter={(e) => { e.preventDefault(); e.stopPropagation(); }}
        onDrop={(e) => { e.preventDefault(); e.stopPropagation(); }}
        onDragLeave={(e) => { e.stopPropagation(); }}
      >
        {/* Header */}
        <div className="flex items-center gap-2">
          <div className="flex-1 flex gap-2 overflow-x-auto" style={{ scrollbarWidth: 'none' }}>
            <button
              onClick={() => setFilterProject('all')}
              className={`px-3 py-1.5 rounded-lg text-xs whitespace-nowrap flex-shrink-0 ${filterProject === 'all' ? 'bg-violet-500' : 'bg-white/10'}`}
            >
              Todos
            </button>
            {workProjects.map(p => (
              <button
                key={p.id}
                onClick={() => setFilterProject(p.id)}
                className={`px-3 py-1.5 rounded-lg text-xs whitespace-nowrap flex-shrink-0 flex items-center gap-1.5 ${filterProject === p.id ? 'bg-violet-500' : 'bg-white/10'}`}
              >
                <div className="w-2 h-2 rounded-full" style={{ backgroundColor: p.color }} />
                {p.name}
              </button>
            ))}
          </div>
          <button
            onClick={() => setKanbanColumns(v => v >= 3 ? 1 : v + 1)}
            className="flex-shrink-0 w-9 h-9 rounded-lg bg-white/10 flex items-center justify-center gap-0.5"
          >
            {[...Array(kanbanColumns)].map((_, i) => (
              <div key={i} className="w-1.5 h-4 bg-violet-400 rounded-sm" />
            ))}
          </button>
        </div>

        {/* Columns */}
        <div
          ref={scrollRef}
          className={`flex ${compact ? 'gap-2' : 'gap-3'} overflow-x-auto -mx-4 px-4 pb-4`}
          style={{ scrollbarWidth: 'none', WebkitOverflowScrolling: 'touch' }}
        >
          {columns.map(col => {
            const isOver = overCol === col.id;

            return (
              <div
                key={col.id}
                data-colid={col.id}
                className="flex-shrink-0"
                style={getColumnStyle()}
                onDragOver={(e) => { e.preventDefault(); e.stopPropagation(); e.dataTransfer.dropEffect = 'move'; setOverCol(col.id); }}
                onDragEnter={(e) => { e.preventDefault(); e.stopPropagation(); }}
                onDragLeave={(e) => { e.stopPropagation(); setOverCol(null); }}
                onDrop={(e) => { e.preventDefault(); e.stopPropagation(); e.dataTransfer.dropEffect = 'move'; handleDrop(col.id); }}
              >
                <div className="flex items-center justify-between mb-2">
                  <span className={`font-semibold truncate ${compact ? 'text-xs' : 'text-sm'}`}>{col.label}</span>
                  <span className={`text-white/40 bg-white/10 rounded-full flex items-center justify-center ${compact ? 'w-5 h-5 text-[9px]' : 'w-6 h-6 text-[10px]'}`}>
                    {col.tasks.length}
                  </span>
                </div>

                <div className={`rounded-2xl min-h-[350px] transition-all ${compact ? 'p-1.5' : 'p-2.5'} ${isOver ? 'bg-violet-500/30 ring-2 ring-violet-400' : 'bg-white/5'
                  }`}>
                  <div className={compact ? 'space-y-1.5' : 'space-y-2.5'}>
                    {col.tasks.map(task => {
                      const project = getProject(task.project_id);
                      const isDragging = draggedId === task.id;

                      return (
                        <div
                          key={task.id}
                          draggable
                          onDragStart={(e) => {
                            e.stopPropagation();
                            e.dataTransfer.effectAllowed = 'move';
                            e.dataTransfer.setData('text/plain', task.id);
                            setDraggedId(task.id);
                          }}
                          onDragEnd={(e) => { e.stopPropagation(); e.preventDefault(); setDraggedId(null); setOverCol(null); }}
                          onClick={() => setShowTaskDetail(task)}
                          className={`bg-zinc-800 rounded-xl border-l-4 select-none cursor-grab active:cursor-grabbing
                          ${compact ? 'p-2' : 'p-3'}
                          ${isDragging ? 'opacity-40' : ''}
                          ${task.completed ? 'opacity-50' : ''}`}
                          style={{ borderColor: project?.color || '#666' }}
                        >
                          <p className={`font-medium leading-snug ${compact ? 'text-xs line-clamp-2' : 'text-sm'} ${task.completed ? 'line-through' : ''}`}>
                            {task.title}
                          </p>
                          {!compact && task.description && (
                            <p className="text-[10px] text-white/40 mt-1 line-clamp-1">{task.description}</p>
                          )}
                          <div className={`flex items-center gap-1 flex-wrap ${compact ? 'mt-1' : 'mt-2'}`}>
                            {!compact && project && (
                              <span className="text-[9px] px-1.5 py-0.5 rounded-full"
                                style={{ backgroundColor: project.color + '25', color: project.color }}>
                                {project.name}
                              </span>
                            )}
                            {task.priority === 'high' && <span className="text-[8px]">üî¥</span>}
                            {task.priority === 'medium' && <span className="text-[8px]">üü°</span>}
                            {task.isDeepWork && <Brain className="w-2.5 h-2.5 text-violet-400" />}
                          </div>
                        </div>
                      );
                    })}
                    {col.tasks.length === 0 && (
                      <div className={`flex flex-col items-center justify-center h-32 rounded-xl border-2 border-dashed ${isOver ? 'border-violet-400 bg-violet-500/10' : 'border-white/10'
                        }`}>
                        <LayoutGrid className="w-5 h-5 mb-1 text-white/20" />
                        <p className="text-[10px] text-white/30">Soltar aqu√≠</p>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            );
          })}
        </div>

        <p className="text-[10px] text-white/30 text-center">
          Arrastra tareas entre columnas ¬∑ Toca para editar
        </p>
      </div>
    );

  };


  // VIEW: PROJECTS (Expandable with tasks, droppable)
  // ============================================================================
  const ProjectsView = () => {
    const toggleExpand = (id) => setExpandedProjects(p => ({ ...p, [id]: !p[id] }));
    const orphanTasks = workTasks.filter(t => !t.project_id && !t.completed);


    return (
      <div className="space-y-3">
        {/* Explanation */}
        <Card className="bg-emerald-500/10 border-emerald-500/20 py-2">
          <div className="flex gap-3">
            <div className="text-xl">üìÅ</div>
            <div>
              <p className="text-sm font-medium text-emerald-400">Proyectos</p>
              <p className="text-[10px] text-white/50">Agrupa tareas relacionadas. Arrastra tareas a un proyecto para asignarlas.</p>
            </div>
          </div>
        </Card>

        {/* Add project */}
        <button
          onClick={() => setShowProjectModal(true)}
          className="w-full py-3 border-2 border-dashed border-white/20 rounded-xl text-white/40 hover:border-violet-500 hover:text-violet-400 flex items-center justify-center gap-2"
        >
          <Plus className="w-4 h-4" />
          Nuevo proyecto
        </button>

        {/* Projects list */}
        {workProjects.filter(p => p.status === 'active').map(project => {
          const tasks = workTasks.filter(t => t.project_id === project.id);
          const pending = tasks.filter(t => !t.completed);
          const done = tasks.filter(t => t.completed);
          const progress = tasks.length > 0 ? Math.round((done.length / tasks.length) * 100) : 0;
          const expanded = expandedProjects[project.id];
          const isDropTarget = dragOverTarget === `project-${project.id}`;

          return (
            <Card
              key={project.id}
              onDragOver={(e) => handleDragOver(e, `project-${project.id}`)}
              onDragLeave={handleDragLeave}
              onDrop={(e) => handleDropOnProject(e, project.id)}
              className={`transition-all ${isDropTarget ? 'ring-2 ring-violet-500 bg-violet-500/10' : ''}`}
            >
              <button onClick={() => toggleExpand(project.id)} className="w-full text-left">
                <div className="flex items-start gap-3">
                  <div className="w-4 h-4 rounded-full mt-0.5" style={{ backgroundColor: project.color }} />
                  <div className="flex-1">
                    <div className="flex items-center justify-between">
                      <p className="font-bold">{project.name}</p>
                      <div className="flex items-center gap-2">
                        <span className="text-xs text-white/40">{progress}%</span>
                        <ChevronDown className={`w-4 h-4 text-white/30 transition-transform ${expanded ? 'rotate-180' : ''}`} />
                      </div>
                    </div>
                    {project.objective && <p className="text-xs text-violet-400 mt-0.5">üéØ {project.objective}</p>}
                    <div className="mt-2 h-2 bg-white/10 rounded-full overflow-hidden">
                      <div className="h-full rounded-full" style={{ width: `${progress}%`, backgroundColor: project.color }} />
                    </div>
                    <div className="flex gap-4 mt-1.5 text-xs text-white/40">
                      <span>{pending.length} pendientes</span>
                      <span>{done.length} hechas</span>
                    </div>
                  </div>
                </div>
              </button>

              {expanded && (
                <div className="mt-4 pt-4 border-t border-white/10 space-y-2">
                  {pending.map(task => <DraggableTask key={task.id} task={task} showProject={false} compact />)}
                  {pending.length === 0 && <p className="text-xs text-white/30 text-center py-4">Sin tareas pendientes</p>}

                  {done.length > 0 && (
                    <p className="text-[10px] text-emerald-400/50 pt-2">‚úì {done.length} completadas</p>
                  )}

                  <button
                    onClick={(e) => { e.stopPropagation(); setNewTask(p => ({ ...p, project_id: project.id })); setShowAdd(true); }}
                    className="w-full py-2 border border-dashed border-white/20 rounded-lg text-xs text-white/40 hover:border-violet-500 flex items-center justify-center gap-1"
                  >
                    <Plus className="w-3 h-3" />A√±adir tarea
                  </button>
                </div>
              )}
            </Card>
          );
        })}

        {/* Orphan tasks - droppable to remove from project */}
        {orphanTasks.length > 0 && (
          <Card
            onDragOver={(e) => handleDragOver(e, 'project-none')}
            onDragLeave={handleDragLeave}
            onDrop={(e) => handleDropOnProject(e, '')}
            className={`border-white/10 ${dragOverTarget === 'project-none' ? 'ring-2 ring-violet-500' : ''}`}
          >
            <div className="flex items-center gap-2 mb-3">
              <div className="w-4 h-4 rounded-full bg-white/20" />
              <span className="text-sm text-white/50">Sin proyecto</span>
              <span className="text-xs text-white/30">({orphanTasks.length})</span>
            </div>
            <div className="space-y-2">
              {orphanTasks.slice(0, 5).map(task => <DraggableTask key={task.id} task={task} showProject={false} compact />)}
              {orphanTasks.length > 5 && <p className="text-xs text-white/30 text-center">+{orphanTasks.length - 5} m√°s</p>}
            </div>
          </Card>
        )}

        {workProjects.length === 0 && (
          <EmptyState icon={Briefcase} title="Sin proyectos" description="Crea proyectos para organizar tareas" action="Crear" onAction={() => setShowProjectModal(true)} />
        )}
      </div>
    );

  };


  // ============================================================================
  // VIEWS & TABS
  // ============================================================================
  const views = {
    agenda: <AgendaView />,
    inbox: <InboxView />,
    matrix: <MatrixView />,
    kanban: <KanbanView />,
    projects: <ProjectsView />
  };


  const tabs = [
    { id: 'agenda', label: 'Agenda', icon: Calendar, badge: null },
    { id: 'inbox', label: 'Inbox', icon: Target, badge: inboxTasks.length || null },
    { id: 'matrix', label: 'Matriz', icon: Grid, badge: null },
    { id: 'kanban', label: 'Kanban', icon: LayoutGrid, badge: null },
    { id: 'projects', label: 'Proyectos', icon: Briefcase, badge: null }
  ];


  // ============================================================================
  // MAIN RENDER
  // ============================================================================
  return (
    <div className="space-y-4 pb-24">
      {/* Header */}
      <AnimatedMount>
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-bold">Trabajo</h1>
            <p className="text-white/50 text-sm">{allPending.length} pendientes ¬∑ {completedToday} hoy</p>
          </div>
          <div className="flex items-center gap-2">
            <button onClick={() => setShowHelp(true)} className="p-2 hover:bg-white/10 rounded-full">
              <BookOpen className="w-5 h-5 text-white/50" />
            </button>
            <button onClick={() => setShowSettings(true)} className="p-2 hover:bg-white/10 rounded-full">
              <Settings className="w-5 h-5 text-white/50" />
            </button>
            <button onClick={() => setShowAdd(true)} className="bg-violet-500 rounded-full p-2.5">
              <Plus className="w-5 h-5" />
            </button>
          </div>
        </div>
      </AnimatedMount>


      {/* Tabs */}
      <AnimatedMount delay={50}>
        <div className="flex gap-0.5 p-1 bg-white/5 rounded-xl overflow-x-auto">
          {tabs.map(tab => {
            const Icon = tab.icon;
            return (
              <button
                key={tab.id}
                onClick={() => setView(tab.id)}
                className={`flex-1 flex items-center justify-center gap-1 py-2 px-2 rounded-lg text-[10px] font-medium whitespace-nowrap relative transition-all ${view === tab.id ? 'bg-violet-500' : 'text-white/50 hover:text-white'
                  }`}
              >
                <Icon className="w-3.5 h-3.5" />
                {tab.label}
                {tab.badge && (
                  <span className="absolute -top-1 -right-0 w-4 h-4 bg-amber-500 rounded-full text-[8px] flex items-center justify-center font-bold">
                    {tab.badge}
                  </span>
                )}
              </button>
            );
          })}
        </div>
      </AnimatedMount>

      {/* Current View */}
      <AnimatedMount delay={100}>
        {views[view]}
      </AnimatedMount>

      {/* ========== MODALS ========== */}

      {/* ADD TASK MODAL */}
      <Modal isOpen={showAdd} onClose={() => setShowAdd(false)} title="Nueva tarea">
        <div className="space-y-4">
          <input
            type="text" placeholder="¬øQu√© necesitas hacer?" value={newTask.title}
            onChange={(e) => setNewTask(p => ({ ...p, title: e.target.value }))}
            className="w-full bg-white/10 rounded-xl p-4 outline-none text-lg" autoFocus
          />

          <textarea
            placeholder="Notas (opcional)" value={newTask.description}
            onChange={(e) => setNewTask(p => ({ ...p, description: e.target.value }))}
            className="w-full bg-white/10 rounded-xl p-3 outline-none text-sm h-20 resize-none"
          />

          {/* Project */}
          <div>
            <p className="text-xs text-white/40 mb-2">Proyecto</p>
            <div className="flex gap-2 flex-wrap">
              <button onClick={() => setNewTask(p => ({ ...p, project_id: '' }))} className={`px-3 py-2 rounded-lg text-sm ${!newTask.project_id ? 'bg-white/20' : 'bg-white/5'}`}>
                Ninguno
              </button>
              {workProjects.map(p => (
                <button key={p.id} onClick={() => setNewTask(prev => ({ ...prev, project_id: p.id }))}
                  className={`px-3 py-2 rounded-lg text-sm flex items-center gap-2 ${newTask.project_id === p.id ? 'bg-white/20' : 'bg-white/5'}`}>
                  <div className="w-3 h-3 rounded-full" style={{ backgroundColor: p.color }} />{p.name}
                </button>
              ))}
            </div>
          </div>

          {/* Priority + Quadrant */}
          <div className="grid grid-cols-2 gap-3">
            <div>
              <p className="text-xs text-white/40 mb-2">Prioridad</p>
              <div className="flex gap-1">
                {Object.entries(priorityStyles).map(([k, v]) => (
                  <button key={k} onClick={() => setNewTask(p => ({ ...p, priority: k }))}
                    className={`flex-1 py-2 rounded-lg text-xs ${newTask.priority === k ? v.bg : 'bg-white/10'}`}>
                    {v.label}
                  </button>
                ))}
              </div>
            </div>
            <div>
              <p className="text-xs text-white/40 mb-2">Cuadrante</p>
              <div className="grid grid-cols-2 gap-1">
                {Object.entries(quadrantInfo).map(([k, v]) => (
                  <button key={k} onClick={() => setNewTask(p => ({ ...p, eisenhower: k }))}
                    className={`py-1.5 rounded-lg text-[9px] ${newTask.eisenhower === k ? 'bg-violet-500' : 'bg-white/10'}`}>
                    {v.label.split(' ')[0]}
                  </button>
                ))}
              </div>
            </div>
          </div>

          {/* Date + Time */}
          <div className="grid grid-cols-2 gap-3">
            <div>
              <p className="text-xs text-white/40 mb-2">Fecha</p>
              <input type="date" value={newTask.dueDate} onChange={(e) => setNewTask(p => ({ ...p, dueDate: e.target.value }))}
                className="w-full bg-white/10 rounded-xl p-3 text-sm outline-none" />
            </div>
            <div>
              <p className="text-xs text-white/40 mb-2">Duraci√≥n</p>
              <div className="flex gap-1">
                {[15, 30, 60, 120].map(t => (
                  <button key={t} onClick={() => setNewTask(p => ({ ...p, timeEstimate: t }))}
                    className={`flex-1 py-3 rounded-lg text-xs ${newTask.timeEstimate === t ? 'bg-violet-500' : 'bg-white/10'}`}>
                    {formatTime(t)}
                  </button>
                ))}
              </div>
            </div>
          </div>

          {/* Deep Work + Status */}
          <div className="flex gap-3">
            <button onClick={() => setNewTask(p => ({ ...p, isDeepWork: !p.isDeepWork }))}
              className={`flex-1 py-3 rounded-xl flex items-center justify-center gap-2 ${newTask.isDeepWork ? 'bg-violet-500' : 'bg-white/10'}`}>
              <Brain className="w-4 h-4" />Deep Work
            </button>
            <select value={newTask.status} onChange={(e) => setNewTask(p => ({ ...p, status: e.target.value }))}
              className="flex-1 bg-white/10 rounded-xl px-3 outline-none text-sm">
              <option value="backlog">üìã Backlog</option>
              <option value="todo">üìå Por hacer</option>
              <option value="doing">üîÑ En progreso</option>
            </select>
          </div>

          <button onClick={addTask} disabled={!newTask.title}
            className={`w-full py-4 rounded-xl font-bold text-lg ${newTask.title ? 'bg-violet-500' : 'bg-white/10 text-white/30'}`}>
            Crear tarea
          </button>
        </div>
      </Modal>

      {/* TASK DETAIL MODAL */}
      <Modal isOpen={!!showTaskDetail} onClose={() => setShowTaskDetail(null)} title="Detalle">
        {showTaskDetail && (
          <div className="space-y-4">
            <input type="text" value={showTaskDetail.title} onChange={(e) => setShowTaskDetail(p => ({ ...p, title: e.target.value }))}
              className="w-full bg-white/10 rounded-xl p-4 outline-none text-lg font-medium" />

            <textarea placeholder="Notas..." value={showTaskDetail.description || ''} onChange={(e) => setShowTaskDetail(p => ({ ...p, description: e.target.value }))}
              className="w-full bg-white/10 rounded-xl p-3 outline-none text-sm h-24 resize-none" />

            {/* Status badges */}
            <div className="flex flex-wrap gap-2">
              {showTaskDetail.completed && <span className="text-sm bg-emerald-500/20 text-emerald-400 px-3 py-1 rounded-full">‚úì Completada</span>}
              {showTaskDetail.isDeepWork && <span className="text-sm bg-violet-500/20 text-violet-400 px-3 py-1 rounded-full">üß† Deep Work</span>}
              {showTaskDetail.dueDate && showTaskDetail.dueDate < today && !showTaskDetail.completed && (
                <span className="text-sm bg-red-500/20 text-red-400 px-3 py-1 rounded-full">‚ö†Ô∏è Vencida</span>
              )}
            </div>

            {/* Project */}
            <div>
              <p className="text-xs text-white/40 mb-2">Proyecto</p>
              <div className="flex gap-2 flex-wrap">
                <button onClick={() => setShowTaskDetail(p => ({ ...p, project_id: '' }))}
                  className={`px-3 py-2 rounded-lg text-sm ${!showTaskDetail.project_id ? 'bg-white/20' : 'bg-white/5'}`}>
                  Sin proyecto
                </button>
                {workProjects.map(p => (
                  <button key={p.id} onClick={() => setShowTaskDetail(prev => ({ ...prev, project_id: p.id }))}
                    className={`px-3 py-2 rounded-lg text-sm flex items-center gap-2 ${showTaskDetail.project_id === p.id ? 'bg-white/20' : 'bg-white/5'}`}>
                    <div className="w-3 h-3 rounded-full" style={{ backgroundColor: p.color }} />{p.name}
                  </button>
                ))}
              </div>
            </div>

            {/* Priority */}
            <div>
              <p className="text-xs text-white/40 mb-2">Prioridad</p>
              <div className="flex gap-2">
                {Object.entries(priorityStyles).map(([k, v]) => (
                  <button key={k} onClick={() => setShowTaskDetail(p => ({ ...p, priority: k }))}
                    className={`flex-1 py-3 rounded-xl text-sm ${showTaskDetail.priority === k ? v.bg : 'bg-white/10'}`}>
                    {v.label}
                  </button>
                ))}
              </div>
            </div>

            {/* Eisenhower */}
            <div>
              <p className="text-xs text-white/40 mb-2">Cuadrante Eisenhower</p>
              <div className="grid grid-cols-2 gap-2">
                {Object.entries(quadrantInfo).map(([k, v]) => (
                  <button key={k} onClick={() => setShowTaskDetail(p => ({ ...p, eisenhower: k }))}
                    className={`py-2 rounded-xl text-xs ${showTaskDetail.eisenhower === k ? 'bg-violet-500' : 'bg-white/10'}`}>
                    {v.label}
                  </button>
                ))}
              </div>
            </div>

            {/* Status */}
            <div>
              <p className="text-xs text-white/40 mb-2">Estado Kanban</p>
              <div className="grid grid-cols-4 gap-1">
                {Object.entries(statusInfo).map(([k, v]) => (
                  <button key={k} onClick={() => setShowTaskDetail(p => ({
                    ...p, status: k, completed: k === 'done', completedAt: k === 'done' ? new Date().toISOString() : null
                  }))}
                    className={`py-2 rounded-xl text-[10px] ${(showTaskDetail.status === k || (k === 'done' && showTaskDetail.completed)) ? 'bg-violet-500' : 'bg-white/10'}`}>
                    {v.label}
                  </button>
                ))}
              </div>
            </div>

            {/* Date + Time */}
            <div className="grid grid-cols-2 gap-3">
              <div>
                <p className="text-xs text-white/40 mb-2">Fecha</p>
                <input type="date" value={showTaskDetail.dueDate || ''} onChange={(e) => setShowTaskDetail(p => ({ ...p, dueDate: e.target.value, scheduledDate: e.target.value }))}
                  className="w-full bg-white/10 rounded-xl p-3 text-sm outline-none" />
              </div>
              <div>
                <p className="text-xs text-white/40 mb-2">Duraci√≥n</p>
                <div className="flex gap-1">
                  {[15, 30, 60, 120].map(t => (
                    <button key={t} onClick={() => setShowTaskDetail(p => ({ ...p, timeEstimate: t }))}
                      className={`flex-1 py-3 rounded-lg text-[10px] ${showTaskDetail.timeEstimate === t ? 'bg-violet-500' : 'bg-white/10'}`}>
                      {formatTime(t)}
                    </button>
                  ))}
                </div>
              </div>
            </div>

            {/* Deep Work */}
            <button onClick={() => setShowTaskDetail(p => ({ ...p, isDeepWork: !p.isDeepWork }))}
              className={`w-full py-3 rounded-xl flex items-center justify-center gap-2 ${showTaskDetail.isDeepWork ? 'bg-violet-500' : 'bg-white/10'}`}>
              <Brain className="w-4 h-4" />Deep Work
            </button>

            {/* Meta */}
            <div className="text-xs text-white/30 pt-2 border-t border-white/10">
              <p>Creada: {new Date(showTaskDetail.createdAt).toLocaleString('es')}</p>
              {showTaskDetail.completedAt && <p>Completada: {new Date(showTaskDetail.completedAt).toLocaleString('es')}</p>}
            </div>

            {/* Actions */}
            <div className="flex gap-2">
              <button onClick={() => { updateTask(showTaskDetail.id, showTaskDetail); setShowTaskDetail(null); showToast('Guardado'); }}
                className="flex-1 py-4 bg-violet-500 rounded-xl font-bold">Guardar</button>
              <button onClick={() => { toggleTask(showTaskDetail.id); setShowTaskDetail(null); }}
                className={`py-4 px-5 rounded-xl ${showTaskDetail.completed ? 'bg-amber-500' : 'bg-emerald-500'}`}>
                {showTaskDetail.completed ? '‚Ü©Ô∏è' : '‚úì'}
              </button>
              <button onClick={() => { if (confirm('¬øEliminar?')) { deleteTask(showTaskDetail.id); setShowTaskDetail(null); } }}
                className="py-4 px-5 bg-red-500/20 text-red-400 rounded-xl"><Trash2 className="w-5 h-5" /></button>
            </div>
          </div>
        )}
      </Modal>

      {/* PROJECT MODAL */}
      <Modal isOpen={showProjectModal} onClose={() => setShowProjectModal(false)} title="Nuevo proyecto">
        <div className="space-y-4">
          <input type="text" placeholder="Nombre" value={newProject.name} onChange={(e) => setNewProject(p => ({ ...p, name: e.target.value }))}
            className="w-full bg-white/10 rounded-xl p-4 outline-none text-lg" autoFocus />

          <textarea placeholder="Descripci√≥n" value={newProject.description} onChange={(e) => setNewProject(p => ({ ...p, description: e.target.value }))}
            className="w-full bg-white/10 rounded-xl p-3 outline-none text-sm h-16 resize-none" />

          <input type="text" placeholder="üéØ Objetivo (opcional)" value={newProject.objective} onChange={(e) => setNewProject(p => ({ ...p, objective: e.target.value }))}
            className="w-full bg-white/10 rounded-xl p-3 outline-none text-sm" />

          <div className="flex gap-3">
            {['#8B5CF6', '#EC4899', '#F59E0B', '#10B981', '#3B82F6', '#EF4444', '#06B6D4'].map(c => (
              <button key={c} onClick={() => setNewProject(p => ({ ...p, color: c }))}
                className={`w-10 h-10 rounded-full ${newProject.color === c ? 'ring-2 ring-white ring-offset-2 ring-offset-zinc-900' : ''}`}
                style={{ backgroundColor: c }} />
            ))}
          </div>

          <input type="date" value={newProject.deadline} onChange={(e) => setNewProject(p => ({ ...p, deadline: e.target.value }))}
            className="w-full bg-white/10 rounded-xl p-3 text-sm outline-none" placeholder="Fecha l√≠mite" />

          <button onClick={addProject} disabled={!newProject.name}
            className={`w-full py-4 rounded-xl font-bold ${newProject.name ? 'bg-violet-500' : 'bg-white/10 text-white/30'}`}>
            Crear proyecto
          </button>
        </div>
      </Modal>

      {/* HELP MODAL */}
      <Modal isOpen={showHelp} onClose={() => setShowHelp(false)} title="Gu√≠a del sistema">
        <div className="space-y-4 text-sm">
          <div className="p-3 bg-white/5 rounded-xl">
            <p className="font-bold text-violet-400 mb-1">üìÖ Agenda</p>
            <p className="text-white/60">Navega d√≠a a d√≠a. Arrastra tareas a fechas en el calendario semanal.</p>
          </div>

          <div className="p-3 bg-white/5 rounded-xl">
            <p className="font-bold text-amber-400 mb-1">üì• Inbox (GTD)</p>
            <p className="text-white/60">Captura ideas r√°pido sin pensar. Despu√©s "procesa": asigna proyecto, fecha y cuadrante.</p>
          </div>

          <div className="p-3 bg-white/5 rounded-xl">
            <p className="font-bold text-red-400 mb-1">üìä Matriz (Eisenhower)</p>
            <p className="text-white/60">
              <strong>Q1 üî• Hacer</strong>: Urgente + Importante (crisis)<br />
              <strong>Q2 üìÖ Planificar</strong>: Importante (crecimiento)<br />
              <strong>Q3 üë§ Delegar</strong>: Urgente (interrupciones)<br />
              <strong>Q4 üóëÔ∏è Eliminar</strong>: Ninguno (distracciones)<br />
              <em>Objetivo: pasar 80% del tiempo en Q1+Q2</em>
            </p>
          </div>

          <div className="p-3 bg-white/5 rounded-xl">
            <p className="font-bold text-blue-400 mb-1">üìã Kanban</p>
            <p className="text-white/60">
              <strong>Backlog</strong>: Ideas sin fecha<br />
              <strong>Por hacer</strong>: Listo para empezar<br />
              <strong>En progreso</strong>: Trabajando ahora<br />
              <strong>Hecho</strong>: Completado
            </p>
          </div>

          <div className="p-3 bg-white/5 rounded-xl">
            <p className="font-bold text-emerald-400 mb-1">üìÅ Proyectos</p>
            <p className="text-white/60">Agrupa tareas relacionadas. Ve el progreso de cada proyecto.</p>
          </div>

          <div className="p-3 bg-violet-500/20 rounded-xl">
            <p className="font-bold mb-1">üñ±Ô∏è Drag & Drop</p>
            <p className="text-white/60">Arrastra tareas entre: fechas, cuadrantes, columnas kanban, y proyectos.</p>
          </div>
        </div>
      </Modal>

      {/* SETTINGS MODAL */}
      <Modal isOpen={showSettings} onClose={() => setShowSettings(false)} title="Configuraci√≥n"
        footer={<button onClick={saveSettings} className="w-full py-4 bg-violet-500 rounded-xl font-bold">Guardar</button>}>
        <div className="space-y-4">
          <div className="flex items-center justify-between py-3">
            <span>Mostrar completadas</span>
            <button onClick={() => setLocalSettings(p => ({ ...p, showCompleted: !p.showCompleted }))}
              className={`w-12 h-7 rounded-full ${localSettings.showCompleted ? 'bg-violet-500' : 'bg-white/20'}`}>
              <div className={`w-5 h-5 bg-white rounded-full transition-transform ${localSettings.showCompleted ? 'translate-x-6' : 'translate-x-1'}`} />
            </button>
          </div>
          <div>
            <p className="mb-2">Meta Deep Work diaria</p>
            <div className="flex gap-2">
              {[2, 3, 4, 5, 6].map(h => (
                <button key={h} onClick={() => setLocalSettings(p => ({ ...p, dailyDeepWorkGoal: h }))}
                  className={`flex-1 py-3 rounded-xl ${localSettings.dailyDeepWorkGoal === h ? 'bg-violet-500' : 'bg-white/10'}`}>
                  {h}h
                </button>
              ))}
            </div>
          </div>
        </div>
      </Modal>
    </div>
  );
};
const WorkoutScreen = ({ data, setData, showToast }) => {
  const today = getToday();


  // Main state
  const [view, setView] = useState('home'); // home, routines, routine-builder, exercise-library, workout, history
  const [workout, setWorkout] = useState(data.workouts.find(w => w.day_id === today && !w.is_completed));
  const [selectedRoutine, setSelectedRoutine] = useState(null);
  const [editingRoutine, setEditingRoutine] = useState(null);
  const [showSettings, setShowSettings] = useState(false);
  const [showHelp, setShowHelp] = useState(false);
  const [showScheduler, setShowScheduler] = useState(false);
  const [scheduleDate, setScheduleDate] = useState(today);
  const [scheduleMode, setScheduleMode] = useState("single");
  const [selectedDays, setSelectedDays] = useState([]);
  const [selectedRoutineForSchedule, setSelectedRoutineForSchedule] = useState(null);


  // Workout state
  const [activeEx, setActiveEx] = useState(0);
  const [restTimer, setRestTimer] = useState(null);
  const [restDuration, setRestDuration] = useState(data.user.workoutSettings?.defaultRest || 90);
  const [elapsedTime, setElapsedTime] = useState(0);


  // Settings state
  const [localSettings, setLocalSettings] = useState({
    defaultRest: data.user.workoutSettings?.defaultRest || 90,
    autoStartRest: data.user.workoutSettings?.autoStartRest ?? true,
    showWarmupSets: data.user.workoutSettings?.showWarmupSets ?? true
  });


  const saveSettings = () => {
    setData(prev => ({
      ...prev,
      user: {
        ...prev.user,
        workoutSettings: localSettings
      }
    }));
    setRestDuration(localSettings.defaultRest);
    setShowSettings(false);
    showToast('Configuraci√≥n guardada');
  };


  // Modals
  const [showExercisePicker, setShowExercisePicker] = useState(false);
  const [showExerciseDetail, setShowExerciseDetail] = useState(null);
  const [showPlateCalc, setShowPlateCalc] = useState(false);
  const [showWarmupCalc, setShowWarmupCalc] = useState(null);
  const [exerciseFilter, setExerciseFilter] = useState({ muscle: null, equipment: null, search: '' });


  // Sync workout
  useEffect(() => {
    const active = data.workouts.find(w => w.day_id === today && !w.is_completed);
    setWorkout(active);
    if (active && view === 'home') setView('workout');
  }, [data.workouts, today]);


  // Elapsed time
  useEffect(() => {
    if (!workout || workout.is_completed) return;
    const start = new Date(workout.started_at).getTime();
    const interval = setInterval(() => {
      setElapsedTime(Math.floor((Date.now() - start) / 1000));
    }, 1000);
    return () => clearInterval(interval);
  }, [workout]);


  // Rest timer countdown
  useEffect(() => {
    if (restTimer === null || restTimer <= 0) return;
    const interval = setInterval(() => {
      setRestTimer(t => {
        if (t <= 1) {
          showToast('¬°Descanso terminado! üí™');
          return null;
        }
        return t - 1;
      });
    }, 1000);
    return () => clearInterval(interval);
  }, [restTimer]);


  const formatTime = (seconds) => {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    if (h > 0) return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    return `${m}:${s.toString().padStart(2, '0')}`;
  };


  // Get user routines or defaults
  const routines = data.workoutRoutines?.length > 0 ? data.workoutRoutines : DEFAULT_ROUTINES;

  // Scheduled workouts
  const scheduledWorkouts = data.scheduledWorkouts || [];
  const todayDayOfWeek = new Date(today).getDay();
  const recurringWorkouts = data.recurringWorkouts || [];
  const todayScheduled = scheduledWorkouts.find(s => s.date === today);
  const todayRecurring = recurringWorkouts.find(r => r.dayOfWeek === todayDayOfWeek);
  const todayRoutine = todayScheduled ? routines.find(r => r.id === todayScheduled.routineId) : todayRecurring ? routines.find(r => r.id === todayRecurring.routineId) : null;
  const folders = [...new Set(routines.map(r => r.folder))];


  // PR functions - compatible with old and new data formats
  const getPR = (exerciseId) => {
    const records = data.personalRecords?.filter(p =>
      p.exerciseId === exerciseId || p.exercise === exerciseId
    ) || [];
    return records.sort((a, b) => (b.weight || 0) - (a.weight || 0))[0];
  };


  const checkAndSavePR = (exerciseId, weight, reps) => {
    if (!weight || !reps) return false;
    const currentPR = getPR(exerciseId);


    if (!currentPR || weight > currentPR.weight || (weight === currentPR.weight && reps > currentPR.reps)) {
      const exercise = getExerciseById(exerciseId);
      setData(prev => ({
        ...prev,
        personalRecords: [...(prev.personalRecords || []), {
          id: generateId(),
          exerciseId,
          exerciseName: exercise?.name || exerciseId,
          weight,
          reps,
          date: today,
          estimated1RM: Math.round(weight * (36 / (37 - Math.min(reps, 12))))
        }]
      }));
      showToast(`üèÜ Nuevo PR: ${exercise?.name} ${weight}kg x${reps}!`);
      return true;
    }
    return false;

  };


  // Get last workout data for exercise
  const getLastPerformance = (exerciseId) => {
    for (const w of data.workouts.filter(w => w.is_completed).sort((a, b) => b.day_id.localeCompare(a.day_id))) {
      const ex = w.exercises?.find(e => e.exerciseId === exerciseId);
      if (ex?.sets.some(s => s.completed)) {
        return { date: w.day_id, sets: ex.sets.filter(s => s.completed) };
      }
    }
    return null;
  };


  // Get exercise history
  const getExerciseHistory = (exerciseId) => {
    return data.workouts
      .filter(w => w.is_completed)
      .map(w => {
        const ex = w.exercises?.find(e => e.exerciseId === exerciseId);
        if (!ex) return null;
        const completedSets = ex.sets.filter(s => s.completed && s.weight && s.reps);
        if (!completedSets.length) return null;
        const bestSet = completedSets.sort((a, b) => b.weight - a.weight)[0];
        const volume = completedSets.reduce((sum, s) => sum + (s.weight * s.reps), 0);
        return { date: w.day_id, bestSet, volume, sets: completedSets.length };
      })
      .filter(Boolean)
      .sort((a, b) => b.date.localeCompare(a.date))
      .slice(0, 15);
  };


  // Start workout from routine
  const startWorkout = (routine) => {
    const newWorkout = {
      id: generateId(),
      day_id: today,
      routineId: routine.id,
      name: routine.name,
      started_at: new Date().toISOString(),
      is_completed: false,
      exercises: routine.exercises.map(e => {
        const lastPerf = getLastPerformance(e.exerciseId);
        const exerciseInfo = getExerciseById(e.exerciseId);


        return {
          id: generateId(),
          exerciseId: e.exerciseId,
          name: exerciseInfo?.name || e.exerciseId,
          targetSets: e.targetSets,
          targetReps: e.targetReps,
          restSeconds: e.restSeconds || 90,
          supersetWith: e.supersetWith || null,
          notes: e.notes || '',
          sets: Array.from({ length: e.targetSets }, (_, i) => ({
            id: generateId(),
            weight: lastPerf?.sets[i]?.weight || null,
            reps: null,
            rpe: null,
            setType: 'normal',
            completed: false
          }))
        };
      })
    };

    setData(prev => ({ ...prev, workouts: [...prev.workouts, newWorkout] }));
    setView('workout');
    showToast('Entreno iniciado üí™');

  };


  // Start empty workout
  const startEmptyWorkout = () => {
    const newWorkout = {
      id: generateId(),
      day_id: today,
      name: 'Entreno libre',
      started_at: new Date().toISOString(),
      is_completed: false,
      exercises: []
    };
    setData(prev => ({ ...prev, workouts: [...prev.workouts, newWorkout] }));
    setView('workout');
    showToast('Entreno iniciado üí™');
  };


  // Add exercise to workout
  const addExerciseToWorkout = (exerciseId) => {
    if (!workout) return;
    const exerciseInfo = getExerciseById(exerciseId);
    const lastPerf = getLastPerformance(exerciseId);


    setData(prev => ({
      ...prev,
      workouts: prev.workouts.map(w => w.id === workout.id ? {
        ...w,
        exercises: [...w.exercises, {
          id: generateId(),
          exerciseId,
          name: exerciseInfo?.name || exerciseId,
          targetSets: 3,
          targetReps: '8',
          restSeconds: 90,
          notes: '',
          sets: Array.from({ length: 3 }, (_, i) => ({
            id: generateId(),
            weight: lastPerf?.sets[i]?.weight || 20,
            reps: lastPerf?.sets[i]?.reps || 8,
            rpe: null,
            setType: 'normal',
            completed: false
          }))
        }]
      } : w)
    }));
    setShowExercisePicker(false);
    showToast('Ejercicio a√±adido');

  };


  // Toggle set
  const toggleSet = (exIndex, setIndex) => {
    if (!workout) return;
    const exercise = workout.exercises[exIndex];
    const set = exercise.sets[setIndex];


    if (!set.completed && set.weight && set.reps) {
      checkAndSavePR(exercise.exerciseId, set.weight, set.reps);
    }

    setData(prev => ({
      ...prev,
      workouts: prev.workouts.map(w => w.id === workout.id ? {
        ...w,
        exercises: w.exercises.map((e, ei) => ei === exIndex ? {
          ...e,
          sets: e.sets.map((s, si) => si === setIndex ? { ...s, completed: !s.completed } : s)
        } : e)
      } : w)
    }));

    if (!set.completed) {
      setRestTimer(exercise.restSeconds || 90);
      setRestDuration(exercise.restSeconds || 90);
    }

  };


  // Update set
  const updateSet = (exIndex, setIndex, field, value) => {
    if (!workout) return;
    setData(prev => ({
      ...prev,
      workouts: prev.workouts.map(w => w.id === workout.id ? {
        ...w,
        exercises: w.exercises.map((e, ei) => ei === exIndex ? {
          ...e,
          sets: e.sets.map((s, si) => si === setIndex ? { ...s, [field]: value } : s)
        } : e)
      } : w)
    }));
  };


  // Add set
  const addSet = (exIndex) => {
    if (!workout) return;
    const exercise = workout.exercises[exIndex];
    const lastSet = exercise.sets[exercise.sets.length - 1];


    setData(prev => ({
      ...prev,
      workouts: prev.workouts.map(w => w.id === workout.id ? {
        ...w,
        exercises: w.exercises.map((e, ei) => ei === exIndex ? {
          ...e,
          sets: [...e.sets, {
            id: generateId(),
            weight: lastSet?.weight || 20,
            reps: lastSet?.reps || 8,
            rpe: null,
            setType: 'normal',
            completed: false
          }]
        } : e)
      } : w)
    }));

  };


  // Remove set
  const removeSet = (exIndex) => {
    if (!workout) return;
    const exercise = workout.exercises[exIndex];
    if (exercise.sets.length <= 1) return;


    setData(prev => ({
      ...prev,
      workouts: prev.workouts.map(w => w.id === workout.id ? {
        ...w,
        exercises: w.exercises.map((e, ei) => ei === exIndex ? {
          ...e,
          sets: e.sets.slice(0, -1)
        } : e)
      } : w)
    }));

  };


  // Delete exercise
  const deleteExercise = (exIndex) => {
    if (!workout || workout.exercises.length <= 1) return;
    setData(prev => ({
      ...prev,
      workouts: prev.workouts.map(w => w.id === workout.id ? {
        ...w,
        exercises: w.exercises.filter((_, i) => i !== exIndex)
      } : w)
    }));
    if (activeEx >= exIndex && activeEx > 0) setActiveEx(activeEx - 1);
  };


  // Complete workout
  const completeWorkout = () => {
    if (!workout) return;
    const duration = elapsedTime;


    setData(prev => ({
      ...prev,
      workouts: prev.workouts.map(w => w.id === workout.id ? {
        ...w,
        is_completed: true,
        finished_at: new Date().toISOString(),
        duration_seconds: duration
      } : w)
    }));

    setView('home');
    showToast('¬°Entreno completado! üéâ');

  };


  // Cancel workout
  const cancelWorkout = () => {
    if (!workout) return;
    setData(prev => ({
      ...prev,
      workouts: prev.workouts.filter(w => w.id !== workout.id)
    }));
    setView('home');
    showToast('Entreno cancelado');
  };


  // Save routine
  const saveRoutine = (routine) => {
    setData(prev => ({
      ...prev,
      workoutRoutines: prev.workoutRoutines
        ? [...prev.workoutRoutines.filter(r => r.id !== routine.id), routine]
        : [routine]
    }));
    setEditingRoutine(null);
    setView('routines');
    showToast('Rutina guardada');
  };


  // Delete routine
  const deleteRoutine = (routineId) => {
    setData(prev => ({
      ...prev,
      workoutRoutines: (prev.workoutRoutines || []).filter(r => r.id !== routineId)
    }));
    showToast('Rutina eliminada');
  };

  // Schedule workout for a specific date
  const scheduleWorkout = (routineId, date) => {
    setData(prev => ({
      ...prev,
      scheduledWorkouts: [...(prev.scheduledWorkouts || []).filter(s => s.date !== date), { id: crypto.randomUUID(), routineId, date }]
    }));
    showToast('Entreno programado');
    setShowScheduler(false);
  };

  const removeScheduledWorkout = (date) => {
    setData(prev => ({ ...prev, scheduledWorkouts: (prev.scheduledWorkouts || []).filter(s => s.date !== date) }));
    showToast('Programaci√≥n eliminada');
  };

  const scheduleRecurring = (routineId, days) => {
    setData(prev => ({
      ...prev,
      recurringWorkouts: [...(prev.recurringWorkouts || []).filter(r => !days.includes(r.dayOfWeek)), ...days.map(d => ({ id: crypto.randomUUID(), routineId, dayOfWeek: d }))]
    }));
    showToast('Programaci√≥n recurrente guardada');
    setShowScheduler(false);
    setSelectedDays([]);
    setSelectedRoutineForSchedule(null);
    setScheduleMode('single');
  };

  const removeRecurring = (dayOfWeek) => {
    setData(prev => ({ ...prev, recurringWorkouts: (prev.recurringWorkouts || []).filter(r => r.dayOfWeek !== dayOfWeek) }));
  };


  // Calculate workout totals
  const getWorkoutTotals = () => {
    if (!workout) return { sets: 0, totalSets: 0, volume: 0 };


    let completedSets = 0, totalSets = 0, volume = 0;

    workout.exercises.forEach(ex => {
      ex.sets.forEach(set => {
        if (set.setType !== 'warmup') {
          totalSets++;
          if (set.completed) {
            completedSets++;
            if (set.weight && set.reps) volume += set.weight * set.reps;
          }
        }
      });
    });

    return { sets: completedSets, totalSets, volume };

  };


  // Filter exercises
  const getFilteredExercises = () => {
    let exercises = getAllExercises();


    if (exerciseFilter.muscle) {
      exercises = exercises.filter(e => e.muscle === exerciseFilter.muscle);
    }
    if (exerciseFilter.equipment) {
      exercises = exercises.filter(e => e.equipment === exerciseFilter.equipment);
    }
    if (exerciseFilter.search) {
      const search = exerciseFilter.search.toLowerCase();
      exercises = exercises.filter(e => e.name.toLowerCase().includes(search));
    }

    return exercises;

  };


  // =========================================================================
  // RENDER: HOME
  // =========================================================================



  // =========================================================================
  // SCHEDULER VIEW (with routine preview)
  // =========================================================================
  if (showScheduler) {
    const selectedRoutineData = selectedRoutineForSchedule ? routines.find(r => r.id === selectedRoutineForSchedule) : null;

    return (
      <div className="space-y-4 pb-24">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            {selectedRoutineData && (
              <button onClick={() => setSelectedRoutineForSchedule(null)} className="p-2 hover:bg-white/10 rounded-xl">
                <ChevronLeft className="w-5 h-5" />
              </button>
            )}
            <h1 className="text-2xl font-bold">{selectedRoutineData ? 'Programar' : 'Seleccionar Rutina'}</h1>
          </div>
          <button onClick={() => { setShowScheduler(false); setSelectedRoutineForSchedule(null); setSelectedDays([]); setScheduleMode('single'); }} className="p-2 hover:bg-white/10 rounded-xl">
            <X className="w-5 h-5" />
          </button>
        </div>

        {!selectedRoutineData ? (
          <>
            {/* Routine list */}
            <div className="space-y-2">
              {routines.map(routine => (
                <Card key={routine.id} className="hover:bg-white/5 cursor-pointer transition-all" onClick={() => setSelectedRoutineForSchedule(routine.id)}>
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="font-bold">{routine.name}</p>
                      <p className="text-sm text-white/50">{routine.folder} ¬∑ {routine.exercises?.length || 0} ejercicios</p>
                    </div>
                    <ChevronRight className="w-5 h-5 text-white/30" />
                  </div>
                </Card>
              ))}
            </div>

            {/* Current schedule */}
            {(data.recurringWorkouts || []).length > 0 && (
              <Card>
                <p className="text-sm font-medium mb-3">üìÜ Programaci√≥n actual</p>
                <div className="space-y-2">
                  {[{ id: 1, n: 'Lunes' }, { id: 2, n: 'Martes' }, { id: 3, n: 'Mi√©rcoles' }, { id: 4, n: 'Jueves' }, { id: 5, n: 'Viernes' }, { id: 6, n: 'S√°bado' }, { id: 0, n: 'Domingo' }].map(d => {
                    const rec = (data.recurringWorkouts || []).find(r => r.dayOfWeek === d.id);
                    if (!rec) return null;
                    const rtn = routines.find(r => r.id === rec.routineId);
                    return (
                      <div key={d.id} className="flex items-center justify-between py-2 border-b border-white/5 last:border-0">
                        <span><span className="text-white/50">{d.n}:</span> {rtn?.name}</span>
                        <button onClick={(e) => { e.stopPropagation(); removeRecurring(d.id); }} className="text-red-400 p-1 hover:bg-red-500/20 rounded"><X className="w-4 h-4" /></button>
                      </div>
                    );
                  })}
                </div>
              </Card>
            )}
          </>
        ) : (
          <>
            {/* Routine preview */}
            <Card className="bg-gradient-to-br from-violet-500/10 to-fuchsia-500/10 border-violet-500/30">
              <div className="flex items-center gap-3 mb-4">
                <div className="w-12 h-12 rounded-xl bg-violet-500/30 flex items-center justify-center">
                  <Dumbbell className="w-6 h-6 text-violet-400" />
                </div>
                <div>
                  <p className="font-bold text-lg">{selectedRoutineData.name}</p>
                  <p className="text-sm text-white/50">{selectedRoutineData.folder} ¬∑ {selectedRoutineData.exercises?.length || 0} ejercicios</p>
                </div>
              </div>

              {/* Exercise list */}
              <div className="space-y-2 max-h-48 overflow-y-auto">
                {(selectedRoutineData.exercises || []).map((ex, idx) => {
                  const exInfo = getExerciseById(ex.exerciseId);
                  return (
                    <div key={idx} className="flex items-center gap-2 py-2 border-b border-white/5 last:border-0">
                      <span className="text-lg">{exInfo?.muscleEmoji || 'üí™'}</span>
                      <div className="flex-1">
                        <p className="text-sm font-medium">{exInfo?.name || ex.exerciseId}</p>
                        <p className="text-xs text-white/40">{ex.targetSets} series √ó {ex.targetReps} reps</p>
                      </div>
                    </div>
                  );
                })}
              </div>
            </Card>

            {/* Schedule options */}
            <Card>
              <div className="flex gap-2 mb-4">
                <button onClick={() => setScheduleMode('single')} className={`flex-1 py-2 rounded-xl text-sm font-medium ${scheduleMode === 'single' ? 'bg-violet-500' : 'bg-white/10'}`}>
                  üìÖ Fecha √∫nica
                </button>
                <button onClick={() => setScheduleMode('recurring')} className={`flex-1 py-2 rounded-xl text-sm font-medium ${scheduleMode === 'recurring' ? 'bg-violet-500' : 'bg-white/10'}`}>
                  üîÑ Recurrente
                </button>
              </div>

              {scheduleMode === 'single' ? (
                <div className="space-y-4">
                  <div>
                    <label className="text-sm text-white/60 mb-2 block">Fecha</label>
                    <input type="date" value={scheduleDate} onChange={(e) => setScheduleDate(e.target.value)} min={today} className="w-full bg-white/10 rounded-xl p-3 outline-none" />
                  </div>
                  <button onClick={() => scheduleWorkout(selectedRoutineForSchedule, scheduleDate)} className="w-full py-3 bg-violet-500 rounded-xl font-bold flex items-center justify-center gap-2">
                    <Calendar className="w-5 h-5" /> Programar para {scheduleDate === today ? 'hoy' : new Date(scheduleDate + 'T12:00:00').toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' })}
                  </button>
                </div>
              ) : (
                <div className="space-y-4">
                  <div>
                    <label className="text-sm text-white/60 mb-2 block">D√≠as de la semana</label>
                    <div className="flex gap-2 justify-between">
                      {[{ id: 1, s: 'L', n: 'Lunes' }, { id: 2, s: 'M', n: 'Martes' }, { id: 3, s: 'X', n: 'Mi√©rcoles' }, { id: 4, s: 'J', n: 'Jueves' }, { id: 5, s: 'V', n: 'Viernes' }, { id: 6, s: 'S', n: 'S√°bado' }, { id: 0, s: 'D', n: 'Domingo' }].map(d => (
                        <button key={d.id} onClick={() => setSelectedDays(p => p.includes(d.id) ? p.filter(x => x !== d.id) : [...p, d.id])} className={`w-10 h-10 rounded-xl font-medium text-sm transition-all ${selectedDays.includes(d.id) ? 'bg-violet-500 scale-110' : 'bg-white/10'}`} title={d.n}>
                          {d.s}
                        </button>
                      ))}
                    </div>
                    {selectedDays.length > 0 && (
                      <p className="text-xs text-white/40 mt-2">
                        {selectedDays.sort((a, b) => a - b).map(id => [{ id: 0, n: 'Dom' }, { id: 1, n: 'Lun' }, { id: 2, n: 'Mar' }, { id: 3, n: 'Mi√©' }, { id: 4, n: 'Jue' }, { id: 5, n: 'Vie' }, { id: 6, n: 'S√°b' }].find(d => d.id === id)?.n).join(', ')}
                      </p>
                    )}
                  </div>
                  <button onClick={() => scheduleRecurring(selectedRoutineForSchedule, selectedDays)} disabled={selectedDays.length === 0} className="w-full py-3 bg-violet-500 rounded-xl font-bold disabled:opacity-30 flex items-center justify-center gap-2">
                    <RefreshCw className="w-5 h-5" /> Programar {selectedDays.length} d√≠a{selectedDays.length !== 1 ? 's' : ''} por semana
                  </button>
                </div>
              )}
            </Card>
          </>
        )}
      </div>
    );
  }

  if (view === 'home') {
    const recentWorkouts = data.workouts
      .filter(w => w.is_completed)
      .sort((a, b) => b.day_id.localeCompare(a.day_id))
      .slice(0, 5);


    const weekWorkouts = data.workouts.filter(w => {
      const weekDates = getWeekDates();
      return weekDates.includes(w.day_id) && w.is_completed;
    }).length;

    return (
      <div className="space-y-4 pb-24">
        <AnimatedMount>
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-2xl font-bold">Entreno</h1>
              <p className="text-white/50 text-sm">{formatDate(today)}</p>
            </div>
            <div className="flex gap-2">
              <button
                onClick={() => setShowHelp(true)}
                className="p-3 hover:bg-white/10 rounded-xl"
              >
                <BookOpen className="w-5 h-5 text-white/50" />
              </button>
              <button
                onClick={() => setShowSettings(true)}
                className="p-3 hover:bg-white/10 rounded-xl"
              >
                <Settings className="w-5 h-5 text-white/50" />
              </button>
              <button
                onClick={() => { console.log("Scheduler button clicked, current showScheduler:", showScheduler); setShowScheduler(true); }}
                className="p-3 hover:bg-white/10 rounded-xl"
              >
                <Clock className="w-5 h-5 text-white/50" />
              </button>
              <button
                onClick={() => setView('routines')}
                className="p-3 bg-white/10 rounded-xl hover:bg-white/20"
              >
                <Calendar className="w-5 h-5" />
              </button>
            </div>
          </div>
        </AnimatedMount>

        {/* Scheduled for today */}
        {todayRoutine && !workout && (
          <AnimatedMount delay={50}>
            <Card className="bg-gradient-to-r from-amber-500/20 to-orange-500/20 border-amber-500/30">
              <div className="flex items-center gap-3 mb-3">
                <div className="w-12 h-12 rounded-xl bg-amber-500/30 flex items-center justify-center">
                  <Calendar className="w-6 h-6 text-amber-400" />
                </div>
                <div className="flex-1">
                  <p className="text-xs text-amber-400 font-medium">PROGRAMADO HOY</p>
                  <p className="font-bold text-lg">{todayRoutine.name}</p>
                </div>
                <button onClick={() => todayScheduled ? removeScheduledWorkout(today) : removeRecurring(todayDayOfWeek)} className="p-2 hover:bg-white/10 rounded-lg">
                  <X className="w-4 h-4 text-white/50" />
                </button>
              </div>
              <button onClick={() => startWorkout(todayRoutine)} className="w-full py-3 bg-amber-500 rounded-xl font-bold text-black flex items-center justify-center gap-2">
                <Play className="w-5 h-5" /> Empezar
              </button>
            </Card>
          </AnimatedMount>
        )}

        {/* Quick start */}
        <AnimatedMount delay={50}>
          <Card className="bg-gradient-to-r from-violet-500/20 to-fuchsia-500/20 border-violet-500/30">
            <div className="flex items-center justify-between mb-4">
              <div>
                <p className="font-bold text-lg">Empezar entreno</p>
                <p className="text-sm text-white/50">{weekWorkouts} entrenos esta semana</p>
              </div>
              <button
                onClick={startEmptyWorkout}
                className="px-4 py-2 bg-violet-500 rounded-xl font-medium flex items-center gap-2"
              >
                <Plus className="w-4 h-4" /> Libre
              </button>
            </div>

            {/* Quick routine buttons */}
            <div className="grid grid-cols-3 gap-2">
              {routines.slice(0, 3).map(routine => (
                <button
                  key={routine.id}
                  onClick={() => startWorkout(routine)}
                  className="p-3 bg-white/10 rounded-xl text-center hover:bg-white/20 transition-all"
                >
                  <Dumbbell className="w-5 h-5 mx-auto mb-1 text-violet-400" />
                  <p className="text-xs font-medium truncate">{routine.name}</p>
                </button>
              ))}
            </div>
          </Card>
        </AnimatedMount>

        {/* Recent workouts */}
        {recentWorkouts.length > 0 && (
          <AnimatedMount delay={100}>
            <Section title="RECIENTES" icon={Clock} iconColor="text-blue-400" action={() => setView('history')} actionLabel="Ver todo">
              <div className="space-y-2">
                {recentWorkouts.map(w => {
                  const volume = w.exercises?.reduce((sum, ex) =>
                    sum + ex.sets.filter(s => s.completed).reduce((s, set) => s + (set.weight || 0) * (set.reps || 0), 0)
                    , 0) || 0;

                  return (
                    <Card key={w.id} className="py-3">
                      <div className="flex items-center justify-between">
                        <div>
                          <p className="font-medium">{w.name}</p>
                          <p className="text-xs text-white/40">{formatShortDate(w.day_id)}</p>
                        </div>
                        <div className="text-right text-sm">
                          <p>{w.exercises?.length || 0} ejercicios</p>
                          <p className="text-xs text-white/40">
                            {volume > 0 ? `${volume.toLocaleString()}kg` : ''}
                            {w.duration_seconds ? ` ¬∑ ${formatTime(w.duration_seconds)}` : ''}
                          </p>
                        </div>
                      </div>
                    </Card>
                  );
                })}
              </div>
            </Section>
          </AnimatedMount>
        )}

        {/* PRs */}
        {data.personalRecords?.length > 0 && (
          <AnimatedMount delay={150}>
            <Section title="PERSONAL RECORDS" icon={Trophy} iconColor="text-yellow-400">
              <Card>
                <div className="space-y-2">
                  {[...new Set(data.personalRecords.map(p => p.exerciseId || p.exercise))].filter(Boolean).slice(0, 5).map(exId => {
                    const pr = getPR(exId) || data.personalRecords.find(p => (p.exerciseId || p.exercise) === exId);
                    if (!pr) return null;
                    const exercise = getExerciseById(exId);
                    return (
                      <div key={exId} className="flex items-center justify-between p-2 bg-white/5 rounded-lg">
                        <div>
                          <p className="text-sm">{exercise?.name || pr.exerciseName || pr.exercise || exId}</p>
                          <p className="text-xs text-white/40">{pr.date ? formatShortDate(pr.date) : ''}</p>
                        </div>
                        <div className="text-right">
                          <p className="font-bold text-yellow-400">{pr.weight}kg x{pr.reps}</p>
                          {pr.estimated1RM && <p className="text-xs text-white/40">~{pr.estimated1RM}kg 1RM</p>}
                        </div>
                      </div>
                    );
                  }).filter(Boolean)}
                </div>
              </Card>
            </Section>
          </AnimatedMount>
        )}

        {/* Exercise library link */}
        <AnimatedMount delay={200}>
          <Card onClick={() => setView('exercise-library')}>
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-xl bg-emerald-500/20 flex items-center justify-center">
                  <BookOpen className="w-5 h-5 text-emerald-400" />
                </div>
                <div>
                  <p className="font-medium">Librer√≠a de ejercicios</p>
                  <p className="text-sm text-white/50">{getAllExercises().length}+ ejercicios</p>
                </div>
              </div>
              <ChevronRight className="w-5 h-5 text-white/30" />
            </div>
          </Card>
        </AnimatedMount>

        {/* Settings Modal */}
        <Modal
          isOpen={showSettings}
          onClose={() => setShowSettings(false)}
          title="Configuraci√≥n Entreno"
          footer={
            <button onClick={saveSettings} className="w-full py-4 bg-violet-500 rounded-xl font-medium">
              Guardar cambios
            </button>
          }
        >
          <div className="space-y-4">
            <div>
              <label className="text-sm text-white/60 mb-2 block">Descanso por defecto (segundos)</label>
              <div className="flex gap-2">
                {[60, 90, 120, 180].map(sec => (
                  <button
                    key={sec}
                    onClick={() => setLocalSettings(p => ({ ...p, defaultRest: sec }))}
                    className={`flex-1 py-3 rounded-xl font-medium ${localSettings.defaultRest === sec ? 'bg-violet-500' : 'bg-white/10'}`}
                  >
                    {sec}s
                  </button>
                ))}
              </div>
            </div>
            <div className="flex items-center justify-between py-3">
              <div>
                <p className="font-medium">Auto-iniciar descanso</p>
                <p className="text-sm text-white/50">Al completar una serie</p>
              </div>
              <button
                onClick={() => setLocalSettings(p => ({ ...p, autoStartRest: !p.autoStartRest }))}
                className={`w-12 h-7 rounded-full transition-colors ${localSettings.autoStartRest ? 'bg-violet-500' : 'bg-white/20'}`}
              >
                <div className={`w-5 h-5 bg-white rounded-full transition-transform ${localSettings.autoStartRest ? 'translate-x-6' : 'translate-x-1'}`} />
              </button>
            </div>
            <div className="flex items-center justify-between py-3">
              <div>
                <p className="font-medium">Mostrar series de calentamiento</p>
                <p className="text-sm text-white/50">Sugerir progresi√≥n</p>
              </div>
              <button
                onClick={() => setLocalSettings(p => ({ ...p, showWarmupSets: !p.showWarmupSets }))}
                className={`w-12 h-7 rounded-full transition-colors ${localSettings.showWarmupSets ? 'bg-violet-500' : 'bg-white/20'}`}
              >
                <div className={`w-5 h-5 bg-white rounded-full transition-transform ${localSettings.showWarmupSets ? 'translate-x-6' : 'translate-x-1'}`} />
              </button>
            </div>
          </div>
        </Modal>

        {/* Help Modal */}
        <Modal isOpen={showHelp} onClose={() => setShowHelp(false)} title="Gu√≠a de Entreno">
          <div className="space-y-4 text-sm">
            <div className="p-3 bg-violet-500/10 rounded-xl">
              <p className="font-bold text-violet-400 mb-1">üèãÔ∏è Entreno libre</p>
              <p className="text-white/60">Empieza un entreno vac√≠o y a√±ade ejercicios sobre la marcha.</p>
            </div>
            <div className="p-3 bg-white/5 rounded-xl">
              <p className="font-bold text-fuchsia-400 mb-1">üìã Rutinas</p>
              <p className="text-white/60">Crea plantillas de entrenos. Organ√≠zalas en carpetas (Push, Pull, Legs).</p>
            </div>
            <div className="p-3 bg-white/5 rounded-xl">
              <p className="font-bold text-emerald-400 mb-1">üìù Durante el entreno</p>
              <p className="text-white/60">
                ‚Ä¢ Toca el set para marcarlo completo<br />
                ‚Ä¢ Edita reps/peso tocando los n√∫meros<br />
                ‚Ä¢ Timer de descanso autom√°tico<br />
                ‚Ä¢ Desliza para eliminar sets
              </p>
            </div>
            <div className="p-3 bg-white/5 rounded-xl">
              <p className="font-bold text-blue-400 mb-1">üìä Progresi√≥n</p>
              <p className="text-white/60">
                ‚Ä¢ El historial muestra tus r√©cords<br />
                ‚Ä¢ Intenta superar tu √∫ltima sesi√≥n<br />
                ‚Ä¢ A√±ade peso o reps gradualmente
              </p>
            </div>
            <div className="p-3 bg-violet-500/20 rounded-xl">
              <p className="font-bold mb-1">üí° Tips</p>
              <p className="text-white/60">
                ‚Ä¢ Calienta con 2-3 series ligeras<br />
                ‚Ä¢ 3-5 series √ó 6-12 reps para hipertrofia<br />
                ‚Ä¢ Descansa 90-180s entre series pesadas<br />
                ‚Ä¢ Registra cada set para ver progreso
              </p>
            </div>
          </div>
        </Modal>
      </div>
    );

  }


  // =========================================================================
  // RENDER: ROUTINES
  // =========================================================================
  if (view === 'routines') {
    return (
      <div className="space-y-4 pb-24">
        <AnimatedMount>
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <button onClick={() => setView('home')} className="p-2 hover:bg-white/10 rounded-lg">
                <ChevronLeft className="w-5 h-5" />
              </button>
              <h1 className="text-2xl font-bold">Rutinas</h1>
            </div>
            <button
              onClick={() => {
                setEditingRoutine({ id: generateId(), name: '', folder: '', exercises: [] });
                setView('routine-builder');
              }}
              className="bg-violet-500 rounded-full p-3"
            >
              <Plus className="w-5 h-5" />
            </button>
          </div>
        </AnimatedMount>


        {folders.map((folder, fi) => (
          <AnimatedMount key={folder} delay={50 + fi * 25}>
            <Section title={folder.toUpperCase()} icon={Calendar} iconColor="text-violet-400">
              <div className="space-y-2">
                {routines.filter(r => r.folder === folder).map(routine => (
                  <Card key={routine.id}>
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3" onClick={() => startWorkout(routine)}>
                        <div className="w-10 h-10 rounded-xl bg-violet-500/20 flex items-center justify-center">
                          <Dumbbell className="w-5 h-5 text-violet-400" />
                        </div>
                        <div>
                          <p className="font-medium">{routine.name}</p>
                          <p className="text-sm text-white/50">{routine.exercises.length} ejercicios</p>
                        </div>
                      </div>
                      <div className="flex items-center gap-2">
                        <button
                          onClick={() => { setEditingRoutine(routine); setView('routine-builder'); }}
                          className="p-2 bg-white/10 rounded-lg hover:bg-white/20"
                        >
                          <Edit3 className="w-4 h-4" />
                        </button>
                        <button
                          onClick={() => startWorkout(routine)}
                          className="p-2 bg-violet-500 rounded-lg"
                        >
                          <Play className="w-4 h-4" />
                        </button>
                      </div>
                    </div>
                  </Card>
                ))}
              </div>
            </Section>
          </AnimatedMount>
        ))}
      </div>
    );

  }


  // =========================================================================
  // RENDER: ROUTINE BUILDER
  // =========================================================================
  if (view === 'routine-builder' && editingRoutine) {
    return (
      <div className="space-y-4 pb-24">
        <AnimatedMount>
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <button onClick={() => setView('routines')} className="p-2 hover:bg-white/10 rounded-lg">
                <ChevronLeft className="w-5 h-5" />
              </button>
              <h1 className="text-xl font-bold">{editingRoutine.name || 'Nueva rutina'}</h1>
            </div>
            <button
              onClick={() => saveRoutine(editingRoutine)}
              disabled={!editingRoutine.name || editingRoutine.exercises.length === 0}
              className="px-4 py-2 bg-violet-500 rounded-xl font-medium disabled:opacity-50"
            >
              Guardar
            </button>
          </div>
        </AnimatedMount>


        {/* Routine info */}
        <AnimatedMount delay={50}>
          <Card>
            <div className="space-y-3">
              <input
                type="text"
                placeholder="Nombre de la rutina"
                value={editingRoutine.name}
                onChange={(e) => setEditingRoutine(r => ({ ...r, name: e.target.value }))}
                className="w-full bg-white/10 rounded-xl p-3 outline-none"
              />
              <input
                type="text"
                placeholder="Carpeta (ej: Push Pull Legs)"
                value={editingRoutine.folder}
                onChange={(e) => setEditingRoutine(r => ({ ...r, folder: e.target.value }))}
                className="w-full bg-white/10 rounded-xl p-3 outline-none"
              />
            </div>
          </Card>
        </AnimatedMount>

        {/* Exercises */}
        <AnimatedMount delay={75}>
          <Section title="EJERCICIOS" icon={Dumbbell} iconColor="text-violet-400">
            <div className="space-y-2">
              {editingRoutine.exercises.map((ex, i) => {
                const exerciseInfo = getExerciseById(ex.exerciseId);
                return (
                  <Card key={i} className="py-3">
                    <div className="flex items-center justify-between mb-2">
                      <div className="flex items-center gap-2">
                        <span className="w-6 h-6 bg-violet-500/20 rounded-lg flex items-center justify-center text-sm font-bold">
                          {i + 1}
                        </span>
                        <span className="font-medium">{exerciseInfo?.name || ex.exerciseId}</span>
                      </div>
                      <button
                        onClick={() => setEditingRoutine(r => ({
                          ...r,
                          exercises: r.exercises.filter((_, idx) => idx !== i)
                        }))}
                        className="p-1.5 hover:bg-red-500/20 rounded-lg text-red-400"
                      >
                        <Trash2 className="w-4 h-4" />
                      </button>
                    </div>
                    <div className="grid grid-cols-3 gap-2 text-sm">
                      <div>
                        <label className="text-xs text-white/40">Sets</label>
                        <input
                          type="number"
                          value={ex.targetSets}
                          onChange={(e) => setEditingRoutine(r => ({
                            ...r,
                            exercises: r.exercises.map((x, idx) => idx === i ? { ...x, targetSets: parseInt(e.target.value) || 3 } : x)
                          }))}
                          className="w-full bg-white/10 rounded-lg p-2 outline-none text-center"
                        />
                      </div>
                      <div>
                        <label className="text-xs text-white/40">Reps</label>
                        <input
                          type="text"
                          value={ex.targetReps}
                          onChange={(e) => setEditingRoutine(r => ({
                            ...r,
                            exercises: r.exercises.map((x, idx) => idx === i ? { ...x, targetReps: e.target.value } : x)
                          }))}
                          className="w-full bg-white/10 rounded-lg p-2 outline-none text-center"
                        />
                      </div>
                      <div>
                        <label className="text-xs text-white/40">Descanso</label>
                        <select
                          value={ex.restSeconds}
                          onChange={(e) => setEditingRoutine(r => ({
                            ...r,
                            exercises: r.exercises.map((x, idx) => idx === i ? { ...x, restSeconds: parseInt(e.target.value) } : x)
                          }))}
                          className="w-full bg-white/10 rounded-lg p-2 outline-none"
                        >
                          {[30, 45, 60, 90, 120, 150, 180, 240, 300].map(s => (
                            <option key={s} value={s}>{s < 60 ? `${s}s` : `${s / 60}min`}</option>
                          ))}
                        </select>
                      </div>
                    </div>
                  </Card>
                );
              })}

              <button
                onClick={() => setShowExercisePicker(true)}
                className="w-full p-4 border border-dashed border-white/20 rounded-xl text-white/50 flex items-center justify-center gap-2 hover:bg-white/5"
              >
                <Plus className="w-5 h-5" /> A√±adir ejercicio
              </button>
            </div>
          </Section>
        </AnimatedMount>

        {/* Delete routine */}
        {editingRoutine.id && data.workoutRoutines?.find(r => r.id === editingRoutine.id) && (
          <AnimatedMount delay={100}>
            <button
              onClick={() => { deleteRoutine(editingRoutine.id); setView('routines'); }}
              className="w-full p-4 border border-red-500/30 rounded-xl text-red-400 flex items-center justify-center gap-2 hover:bg-red-500/10"
            >
              <Trash2 className="w-5 h-5" /> Eliminar rutina
            </button>
          </AnimatedMount>
        )}

        {/* Exercise picker modal */}
        <Modal isOpen={showExercisePicker} onClose={() => setShowExercisePicker(false)} title="A√±adir ejercicio">
          {/* Filters */}
          <div className="space-y-3 mb-4">
            <input
              type="text"
              placeholder="Buscar ejercicio..."
              value={exerciseFilter.search}
              onChange={(e) => setExerciseFilter(f => ({ ...f, search: e.target.value }))}
              className="w-full bg-white/10 rounded-xl p-3 outline-none"
            />
            <div className="flex gap-2 overflow-x-auto pb-2">
              <button
                onClick={() => setExerciseFilter(f => ({ ...f, muscle: null }))}
                className={`px-3 py-1.5 rounded-lg text-sm whitespace-nowrap ${!exerciseFilter.muscle ? 'bg-violet-500' : 'bg-white/10'}`}
              >
                Todos
              </button>
              {Object.entries(EXERCISE_DATABASE).map(([key, cat]) => (
                <button
                  key={key}
                  onClick={() => setExerciseFilter(f => ({ ...f, muscle: f.muscle === key ? null : key }))}
                  className={`px-3 py-1.5 rounded-lg text-sm whitespace-nowrap ${exerciseFilter.muscle === key ? 'bg-violet-500' : 'bg-white/10'}`}
                >
                  {cat.emoji} {cat.name}
                </button>
              ))}
            </div>
          </div>

          {/* Exercise list */}
          <div className="space-y-2 max-h-[50vh] overflow-y-auto">
            {getFilteredExercises().map(ex => (
              <button
                key={ex.id}
                onClick={() => {
                  setEditingRoutine(r => ({
                    ...r,
                    exercises: [...(r.exercises || []), {
                      exerciseId: ex.id,
                      targetSets: 3,
                      targetReps: '8-12',
                      restSeconds: 90
                    }]
                  }));
                  setShowExercisePicker(false);
                }}
                className="w-full flex items-center gap-3 p-3 bg-white/5 rounded-xl hover:bg-white/10 text-left"
              >
                <span className="text-xl">{ex.muscleEmoji}</span>
                <div className="flex-1">
                  <p className="font-medium">{ex.name}</p>
                  <p className="text-xs text-white/40">{ex.muscleName} ¬∑ {EQUIPMENT_TYPES[ex.equipment]?.name}</p>
                </div>
              </button>
            ))}
          </div>
        </Modal>
      </div>
    );

  }


  // =========================================================================
  // RENDER: EXERCISE LIBRARY
  // =========================================================================
  if (view === 'exercise-library') {
    return (
      <div className="space-y-4 pb-24">
        <AnimatedMount>
          <div className="flex items-center gap-3">
            <button onClick={() => setView('home')} className="p-2 hover:bg-white/10 rounded-lg">
              <ChevronLeft className="w-5 h-5" />
            </button>
            <h1 className="text-2xl font-bold">Ejercicios</h1>
          </div>
        </AnimatedMount>


        {/* Search */}
        <AnimatedMount delay={25}>
          <input
            type="text"
            placeholder="Buscar ejercicio..."
            value={exerciseFilter.search}
            onChange={(e) => setExerciseFilter(f => ({ ...f, search: e.target.value }))}
            className="w-full bg-white/10 rounded-xl p-4 outline-none"
          />
        </AnimatedMount>

        {/* Muscle filters */}
        <AnimatedMount delay={50}>
          <div className="flex gap-2 overflow-x-auto pb-2">
            <button
              onClick={() => setExerciseFilter(f => ({ ...f, muscle: null }))}
              className={`px-4 py-2 rounded-xl text-sm whitespace-nowrap ${!exerciseFilter.muscle ? 'bg-violet-500' : 'bg-white/10'}`}
            >
              Todos
            </button>
            {Object.entries(EXERCISE_DATABASE).map(([key, cat]) => (
              <button
                key={key}
                onClick={() => setExerciseFilter(f => ({ ...f, muscle: f.muscle === key ? null : key }))}
                className={`px-4 py-2 rounded-xl text-sm whitespace-nowrap flex items-center gap-2 ${exerciseFilter.muscle === key ? 'bg-violet-500' : 'bg-white/10'}`}
              >
                <span>{cat.emoji}</span>
                <span>{cat.name}</span>
              </button>
            ))}
          </div>
        </AnimatedMount>

        {/* Exercise list by muscle */}
        {(exerciseFilter.muscle ? [exerciseFilter.muscle] : Object.keys(EXERCISE_DATABASE)).map((muscleKey, mi) => {
          const muscle = EXERCISE_DATABASE[muscleKey];
          let exercises = muscle.exercises;

          if (exerciseFilter.search) {
            const search = exerciseFilter.search.toLowerCase();
            exercises = exercises.filter(e => e.name.toLowerCase().includes(search));
          }

          if (exercises.length === 0) return null;

          return (
            <AnimatedMount key={muscleKey} delay={75 + mi * 25}>
              <Section title={`${muscle.emoji} ${muscle.name.toUpperCase()}`}>
                <div className="space-y-2">
                  {exercises.map(ex => {
                    const pr = getPR(ex.id);
                    return (
                      <Card
                        key={ex.id}
                        className="py-3"
                        onClick={() => setShowExerciseDetail(ex)}
                      >
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center">
                              <span>{EQUIPMENT_TYPES[ex.equipment]?.icon}</span>
                            </div>
                            <div>
                              <p className="font-medium">{ex.name}</p>
                              <p className="text-xs text-white/40">{EQUIPMENT_TYPES[ex.equipment]?.name}</p>
                            </div>
                          </div>
                          {pr && (
                            <div className="text-right">
                              <p className="text-sm font-bold text-yellow-400">{pr.weight}kg</p>
                              <p className="text-xs text-white/40">PR</p>
                            </div>
                          )}
                        </div>
                      </Card>
                    );
                  })}
                </div>
              </Section>
            </AnimatedMount>
          );
        })}

        {/* Exercise detail modal */}
        <Modal isOpen={!!showExerciseDetail} onClose={() => setShowExerciseDetail(null)} title={showExerciseDetail?.name}>
          {showExerciseDetail && (
            <div className="space-y-4">
              {/* Equipment & muscle */}
              <div className="flex gap-2">
                <span className="px-3 py-1 bg-white/10 rounded-lg text-sm">
                  {EQUIPMENT_TYPES[showExerciseDetail.equipment]?.icon} {EQUIPMENT_TYPES[showExerciseDetail.equipment]?.name}
                </span>
              </div>

              {/* Instructions */}
              <div>
                <p className="text-sm text-white/60 mb-2">C√≥mo ejecutarlo</p>
                <p className="text-sm">{showExerciseDetail.instructions}</p>
              </div>

              {/* PR */}
              {getPR(showExerciseDetail.id) && (
                <Card className="bg-yellow-500/10 border-yellow-500/20">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-2">
                      <Trophy className="w-5 h-5 text-yellow-400" />
                      <span className="font-medium">Tu PR</span>
                    </div>
                    <div className="text-right">
                      <p className="font-bold text-yellow-400">{getPR(showExerciseDetail.id).weight}kg x {getPR(showExerciseDetail.id).reps}</p>
                      <p className="text-xs text-white/40">{formatShortDate(getPR(showExerciseDetail.id).date)}</p>
                    </div>
                  </div>
                </Card>
              )}

              {/* History */}
              {getExerciseHistory(showExerciseDetail.id).length > 0 && (
                <div>
                  <p className="text-sm text-white/60 mb-2">Historial</p>
                  <div className="space-y-2 max-h-40 overflow-y-auto">
                    {getExerciseHistory(showExerciseDetail.id).map((entry, i) => (
                      <div key={i} className="flex items-center justify-between p-2 bg-white/5 rounded-lg text-sm">
                        <span className="text-white/60">{formatShortDate(entry.date)}</span>
                        <span>{entry.bestSet.weight}kg x{entry.bestSet.reps} ¬∑ {entry.volume}kg vol</span>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}
        </Modal>
      </div>
    );

  }


  // =========================================================================
  // RENDER: HISTORY
  // =========================================================================
  if (view === 'history') {
    const allWorkouts = data.workouts
      .filter(w => w.is_completed)
      .sort((a, b) => b.day_id.localeCompare(a.day_id));


    return (
      <div className="space-y-4 pb-24">
        <AnimatedMount>
          <div className="flex items-center gap-3">
            <button onClick={() => setView('home')} className="p-2 hover:bg-white/10 rounded-lg">
              <ChevronLeft className="w-5 h-5" />
            </button>
            <div>
              <h1 className="text-2xl font-bold">Historial</h1>
              <p className="text-white/50 text-sm">{allWorkouts.length} entrenos completados</p>
            </div>
          </div>
        </AnimatedMount>

        {allWorkouts.length > 0 ? (
          <div className="space-y-2">
            {allWorkouts.map((w, i) => {
              const volume = w.exercises?.reduce((sum, ex) =>
                sum + ex.sets.filter(s => s.completed).reduce((s, set) => s + (set.weight || 0) * (set.reps || 0), 0)
                , 0) || 0;

              return (
                <AnimatedMount key={w.id} delay={i * 30}>
                  <Card className="py-3">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="font-medium">{w.name}</p>
                        <p className="text-xs text-white/40">{formatDate(w.day_id)}</p>
                      </div>
                      <div className="text-right text-sm">
                        <p>{w.exercises?.length || 0} ejercicios</p>
                        <p className="text-xs text-white/40">{volume > 0 ? `${volume.toLocaleString()}kg` : ''}</p>
                      </div>
                    </div>
                  </Card>
                </AnimatedMount>
              );
            })}
          </div>
        ) : (
          <EmptyState
            icon={Calendar}
            title="Sin historial"
            description="Completa tu primer entreno para verlo aqu√≠"
          />
        )}
      </div>
    );

  }


  // =========================================================================
  // RENDER: ACTIVE WORKOUT
  // =========================================================================
  if (view === 'workout' && workout) {
    const totals = getWorkoutTotals();
    const progress = totals.totalSets > 0 ? (totals.sets / totals.totalSets) * 100 : 0;


    return (
      <div className="space-y-4 pb-32">
        {/* Header */}
        <AnimatedMount>
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-xl font-bold">{workout.name}</h1>
              <p className="text-white/50 text-sm">{workout.exercises.length} ejercicios</p>
            </div>
            <div className="flex items-center gap-3">
              <div className="text-right">
                <div className="flex items-center gap-1.5 text-lg font-mono">
                  <Timer className="w-4 h-4 text-violet-400" />
                  <span>{formatTime(elapsedTime)}</span>
                </div>
              </div>
              <button
                onClick={cancelWorkout}
                className="p-2 bg-red-500/20 rounded-lg text-red-400 hover:bg-red-500/30"
              >
                <X className="w-5 h-5" />
              </button>
            </div>
          </div>
        </AnimatedMount>

        {/* Progress */}
        <AnimatedMount delay={25}>
          <Card className="py-3">
            <div className="flex items-center justify-between mb-2 text-sm">
              <span className="text-white/60">Progreso</span>
              <span className="font-medium">{totals.sets}/{totals.totalSets} sets ¬∑ {totals.volume.toLocaleString()}kg</span>
            </div>
            <ProgressBar value={totals.sets} max={totals.totalSets || 1} color="bg-gradient-to-r from-violet-500 to-fuchsia-500" />
          </Card>
        </AnimatedMount>

        {/* Rest timer */}
        {restTimer !== null && (
          <AnimatedMount>
            <Card className="bg-gradient-to-r from-blue-500/20 to-cyan-500/20 border-blue-500/30">
              <div className="flex items-center justify-between mb-2">
                <div className="flex items-center gap-2">
                  <Timer className="w-5 h-5 text-blue-400" />
                  <span className="font-medium">Descanso</span>
                </div>
                <span className="text-2xl font-mono font-bold">{formatTime(restTimer)}</span>
              </div>
              <ProgressBar value={restTimer} max={restDuration} color="bg-blue-500" />
              <div className="flex gap-2 mt-3">
                <button onClick={() => setRestTimer(t => t + 30)} className="flex-1 py-2 bg-white/10 rounded-lg text-sm">+30s</button>
                <button onClick={() => setRestTimer(null)} className="flex-1 py-2 bg-white/10 rounded-lg text-sm">Saltar</button>
              </div>
            </Card>
          </AnimatedMount>
        )}

        {/* Exercises */}
        {workout.exercises.map((ex, exIndex) => {
          const exCompleted = ex.sets.filter(s => s.completed && s.setType !== 'warmup').length;
          const exTotal = ex.sets.filter(s => s.setType !== 'warmup').length;
          const pr = getPR(ex.exerciseId);
          const lastPerf = getLastPerformance(ex.exerciseId);
          const isActive = activeEx === exIndex;
          const exVolume = ex.sets.filter(s => s.completed).reduce((sum, s) => sum + (s.weight || 0) * (s.reps || 0), 0);

          return (
            <AnimatedMount key={ex.id} delay={50 + exIndex * 20}>
              <Card
                onClick={() => setActiveEx(exIndex)}
                className={`transition-all ${isActive ? 'border-violet-500/50 bg-violet-500/5' : ''}`}
              >
                {/* Exercise header */}
                <div className="flex items-center justify-between mb-2">
                  <div className="flex items-center gap-3">
                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold
                    ${exCompleted === exTotal && exTotal > 0 ? 'bg-emerald-500' : 'bg-white/10'}
                  `}>
                      {exIndex + 1}
                    </div>
                    <div>
                      <p className="font-medium">{ex.name}</p>
                      <p className="text-xs text-white/40">
                        {exCompleted}/{exTotal} ¬∑ {ex.targetReps}
                        {exVolume > 0 && ` ¬∑ ${exVolume}kg`}
                      </p>
                    </div>
                  </div>
                  {exCompleted === exTotal && exTotal > 0 && <Check className="w-5 h-5 text-emerald-400" />}
                </div>

                {/* Info badges */}
                <div className="flex gap-2 mb-3 text-xs flex-wrap">
                  {pr && (
                    <span className="px-2 py-1 bg-yellow-500/20 text-yellow-400 rounded-lg">
                      üèÜ PR: {pr.weight}kg
                    </span>
                  )}
                  {lastPerf && (
                    <button
                      onClick={(e) => { e.stopPropagation(); setShowExerciseDetail(getExerciseById(ex.exerciseId)); }}
                      className="px-2 py-1 bg-white/10 rounded-lg hover:bg-white/20"
                    >
                      üìä √öltimo: {lastPerf.sets[0]?.weight}kg
                    </button>
                  )}
                  <button
                    onClick={(e) => { e.stopPropagation(); setShowPlateCalc(true); }}
                    className="px-2 py-1 bg-white/10 rounded-lg hover:bg-white/20"
                  >
                    üßÆ Discos
                  </button>
                </div>

                {/* Sets - when active */}
                {isActive && (
                  <div className="space-y-2">
                    {/* Header */}
                    <div className="grid grid-cols-12 gap-1 text-xs text-white/40 px-1">
                      <span className="col-span-1">SET</span>
                      <span className="col-span-3 text-center">KG</span>
                      <span className="col-span-3 text-center">REPS</span>
                      <span className="col-span-2 text-center">TIPO</span>
                      <span className="col-span-3"></span>
                    </div>

                    {/* Set rows */}
                    {ex.sets.map((set, setIndex) => {
                      const lastSet = lastPerf?.sets[setIndex];
                      const setTypeInfo = SET_TYPES[set.setType] || SET_TYPES.normal;

                      return (
                        <div
                          key={set.id}
                          className={`grid grid-cols-12 gap-1 items-center p-2 rounded-lg ${set.completed ? 'bg-emerald-500/20' : setTypeInfo.color
                            }`}
                        >
                          <span className={`col-span-1 text-center text-sm font-medium ${setTypeInfo.textColor || ''}`}>
                            {set.setType === 'warmup' ? 'W' : setIndex + 1 - ex.sets.slice(0, setIndex).filter(s => s.setType === 'warmup').length}
                          </span>
                          <input
                            type="number"
                            placeholder={lastSet?.weight?.toString() || '-'}
                            value={set.weight || ''}
                            onChange={(e) => updateSet(exIndex, setIndex, 'weight', parseFloat(e.target.value) || null)}
                            onClick={(e) => e.stopPropagation()}
                            className="col-span-3 bg-white/10 rounded-lg px-2 py-1.5 text-center outline-none text-sm w-full"
                          />
                          <input
                            type="number"
                            placeholder={ex.targetReps?.split('-')[0] || '-'}
                            value={set.reps || ''}
                            onChange={(e) => updateSet(exIndex, setIndex, 'reps', parseInt(e.target.value) || null)}
                            onClick={(e) => e.stopPropagation()}
                            className="col-span-3 bg-white/10 rounded-lg px-2 py-1.5 text-center outline-none text-sm w-full"
                          />
                          <select
                            value={set.setType}
                            onChange={(e) => updateSet(exIndex, setIndex, 'setType', e.target.value)}
                            onClick={(e) => e.stopPropagation()}
                            className="col-span-2 bg-white/10 rounded-lg px-1 py-1.5 text-center outline-none text-xs appearance-none"
                          >
                            {Object.entries(SET_TYPES).map(([key, type]) => (
                              <option key={key} value={key}>{type.name}</option>
                            ))}
                          </select>
                          <button
                            onClick={(e) => { e.stopPropagation(); toggleSet(exIndex, setIndex); }}
                            className={`col-span-3 h-9 rounded-lg flex items-center justify-center transition-all
                            ${set.completed ? 'bg-emerald-500' : 'bg-white/10 hover:bg-white/20'}
                          `}
                          >
                            <Check className="w-4 h-4" />
                          </button>
                        </div>
                      );
                    })}

                    {/* Actions */}
                    <div className="flex gap-2 pt-2">
                      <button onClick={(e) => { e.stopPropagation(); addSet(exIndex); }} className="flex-1 py-2 border border-dashed border-white/20 rounded-lg text-sm text-white/50">+ Set</button>
                      {ex.sets.length > 1 && (
                        <button onClick={(e) => { e.stopPropagation(); removeSet(exIndex); }} className="px-3 py-2 bg-white/5 rounded-lg text-sm text-white/50 hover:bg-red-500/20 hover:text-red-400">-</button>
                      )}
                      <button onClick={(e) => { e.stopPropagation(); deleteExercise(exIndex); }} className="px-3 py-2 bg-white/5 rounded-lg text-sm text-white/50 hover:bg-red-500/20 hover:text-red-400">üóëÔ∏è</button>
                    </div>
                  </div>
                )}
              </Card>
            </AnimatedMount>
          );
        })}

        {/* Add exercise */}
        <button
          onClick={() => setShowExercisePicker(true)}
          className="w-full p-4 border border-dashed border-white/20 rounded-xl text-white/50 flex items-center justify-center gap-2"
        >
          <Plus className="w-5 h-5" /> A√±adir ejercicio
        </button>

        {/* Complete */}
        {progress >= 30 && (
          <button
            onClick={completeWorkout}
            className="w-full bg-gradient-to-r from-emerald-500 to-green-500 py-4 rounded-xl font-medium flex items-center justify-center gap-2"
          >
            <Trophy className="w-5 h-5" /> Completar entreno
          </button>
        )}

        {/* Exercise picker */}
        <Modal isOpen={showExercisePicker} onClose={() => setShowExercisePicker(false)} title="A√±adir ejercicio">
          <input
            type="text"
            placeholder="Buscar..."
            value={exerciseFilter.search}
            onChange={(e) => setExerciseFilter(f => ({ ...f, search: e.target.value }))}
            className="w-full bg-white/10 rounded-xl p-3 outline-none mb-3"
          />
          <div className="flex gap-2 overflow-x-auto pb-2 mb-3">
            <button onClick={() => setExerciseFilter(f => ({ ...f, muscle: null }))} className={`px-3 py-1 rounded-lg text-sm ${!exerciseFilter.muscle ? 'bg-violet-500' : 'bg-white/10'}`}>Todos</button>
            {Object.entries(EXERCISE_DATABASE).map(([key, cat]) => (
              <button key={key} onClick={() => setExerciseFilter(f => ({ ...f, muscle: key }))} className={`px-3 py-1 rounded-lg text-sm whitespace-nowrap ${exerciseFilter.muscle === key ? 'bg-violet-500' : 'bg-white/10'}`}>{cat.emoji}</button>
            ))}
          </div>
          <div className="space-y-2 max-h-[50vh] overflow-y-auto">
            {getFilteredExercises().map(ex => (
              <button key={ex.id} onClick={() => addExerciseToWorkout(ex.id)} className="w-full flex items-center gap-3 p-3 bg-white/5 rounded-xl hover:bg-white/10 text-left">
                <span>{ex.muscleEmoji}</span>
                <div className="flex-1">
                  <p>{ex.name}</p>
                  <p className="text-xs text-white/40">{ex.muscleName}</p>
                </div>
                {getPR(ex.id) && <span className="text-xs text-yellow-400">{getPR(ex.id).weight}kg</span>}
              </button>
            ))}
          </div>
        </Modal>

        {/* Plate calculator */}

        <Modal isOpen={showPlateCalc} onClose={() => setShowPlateCalc(false)} title="Calculadora de discos">
          <PlateCalculator />
        </Modal>
      </div>
    );

  }


  // Fallback: show loading or redirect - this shouldn't normally happen
  // If we get here, view is 'workout' but workout is null, or view is 'routine-builder' but editingRoutine is null
  return (
    <div className="space-y-4 pb-24">
      <div className="flex flex-col items-center justify-center py-20">
        <Dumbbell className="w-12 h-12 text-white/20 mb-4" />
        <p className="text-white/40 mb-4">Cargando...</p>
        <button
          onClick={() => setView('home')}
          className="px-4 py-2 bg-violet-500 rounded-xl"
        >
          Volver al inicio
        </button>
      </div>
    </div>
  );
};
const BodyScreen = ({ data, setData, showToast }) => {
  const [showAdd, setShowAdd] = useState(false);
  const [showHelp, setShowHelp] = useState(false);
  const [newEntry, setNewEntry] = useState({ weight: '', bodyFat: '', notes: '' });

  const metrics = (data.bodyMetrics || []).sort((a, b) => b.date.localeCompare(a.date));
  const weights = metrics.map(m => m.weight).reverse();
  const latest = metrics[0];
  const oldest = metrics[metrics.length - 1];
  const change = latest && oldest ? (latest.weight - oldest.weight).toFixed(1) : 0;

  const saveEntry = () => {
    if (!newEntry.weight) return;
    setData(prev => ({
      ...prev,
      bodyMetrics: [...(prev.bodyMetrics || []), {
        id: generateId(),
        date: getToday(),
        weight: parseFloat(newEntry.weight),
        bodyFat: newEntry.bodyFat ? parseFloat(newEntry.bodyFat) : null,
        notes: newEntry.notes
      }]
    }));
    setShowAdd(false);
    setNewEntry({ weight: '', bodyFat: '', notes: '' });
    showToast('Peso registrado');
  };

  const deleteEntry = (id) => {
    setData(prev => ({ ...prev, bodyMetrics: prev.bodyMetrics.filter(m => m.id !== id) }));
    showToast('Registro eliminado');
  };

  return (
    <div className="space-y-4 pb-24">
      <AnimatedMount>
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-bold">Cuerpo</h1>
            <p className="text-white/50 text-sm">M√©tricas y progreso</p>
          </div>
          <div className="flex items-center gap-2">
            <button onClick={() => setShowHelp(true)} className="p-3 hover:bg-white/10 rounded-full">
              <BookOpen className="w-5 h-5 text-white/50" />
            </button>
            <button onClick={() => setShowAdd(true)} className="bg-violet-500 rounded-full p-3">
              <Plus className="w-5 h-5" />
            </button>
          </div>
        </div>
      </AnimatedMount>

      {latest && (
        <AnimatedMount delay={50}>
          <Card className="bg-gradient-to-r from-emerald-500/20 to-teal-500/20 border-emerald-500/30">
            <div className="flex items-center justify-between mb-4">
              <div>
                <p className="text-xs text-white/40">Peso actual</p>
                <p className="text-3xl font-bold">{latest.weight} kg</p>
              </div>
              <div className="text-right">
                <p className="text-xs text-white/40">Cambio total</p>
                <p className={`text-xl font-bold ${parseFloat(change) < 0 ? 'text-emerald-400' : parseFloat(change) > 0 ? 'text-red-400' : 'text-white/60'}`}>
                  {parseFloat(change) > 0 ? '+' : ''}{change} kg
                </p>
              </div>
            </div>
            {weights.length > 1 && <MiniChart data={weights} color="#10B981" height={60} />}
          </Card>
        </AnimatedMount>
      )}

      {metrics.length > 0 ? (
        <AnimatedMount delay={100}>
          <Card>
            <p className="font-medium mb-3">Historial</p>
            <div className="space-y-2">
              {metrics.slice(0, 10).map(m => (
                <SwipeableItem key={m.id} onDelete={() => deleteEntry(m.id)}>
                  <div className="flex items-center justify-between p-3 bg-white/5 rounded-xl">
                    <div>
                      <p className="text-sm font-medium">
                        {m.weight} kg
                        {m.bodyFat && <span className="text-white/40 ml-2">¬∑ {m.bodyFat}% grasa</span>}
                      </p>
                      <p className="text-xs text-white/40">{formatShortDate(m.date)}</p>
                    </div>
                  </div>
                </SwipeableItem>
              ))}
            </div>
          </Card>
        </AnimatedMount>
      ) : (
        <EmptyState icon={Scale} title="Sin registros" description="Empieza a trackear tu peso" action="A√±adir peso" onAction={() => setShowAdd(true)} />
      )}

      {data.personalRecords?.length > 0 && (
        <AnimatedMount delay={150}>
          <Card>
            <div className="flex items-center gap-2 mb-3">
              <Trophy className="w-4 h-4 text-yellow-400" />
              <span className="font-medium">Personal Records</span>
            </div>
            <div className="space-y-2">
              {[...new Set(data.personalRecords.map(p => p.exercise))].map(ex => {
                const pr = data.personalRecords.filter(p => p.exercise === ex).sort((a, b) => b.weight - a.weight)[0];
                return (
                  <div key={ex} className="flex items-center justify-between p-2 bg-white/5 rounded-lg">
                    <span className="text-sm">{ex}</span>
                    <span className="text-sm font-bold text-yellow-400">{pr.weight}kg x{pr.reps}</span>
                  </div>
                );
              })}
            </div>
          </Card>
        </AnimatedMount>
      )}

      <Modal isOpen={showAdd} onClose={() => setShowAdd(false)} title="Registrar peso">
        <input
          type="number"
          placeholder="Peso (kg)"
          value={newEntry.weight}
          onChange={(e) => setNewEntry(p => ({ ...p, weight: e.target.value }))}
          className="w-full bg-white/10 rounded-xl p-4 outline-none mb-3"
          step="0.1"
          autoFocus
        />
        <input
          type="number"
          placeholder="% Grasa corporal (opcional)"
          value={newEntry.bodyFat}
          onChange={(e) => setNewEntry(p => ({ ...p, bodyFat: e.target.value }))}
          className="w-full bg-white/10 rounded-xl p-4 outline-none mb-3"
          step="0.1"
        />
        <input
          type="text"
          placeholder="Notas (opcional)"
          value={newEntry.notes}
          onChange={(e) => setNewEntry(p => ({ ...p, notes: e.target.value }))}
          className="w-full bg-white/10 rounded-xl p-4 outline-none mb-4"
        />
        <button
          onClick={saveEntry}
          disabled={!newEntry.weight}
          className={`w-full py-4 rounded-xl font-medium ${newEntry.weight ? 'bg-violet-500' : 'bg-white/10 text-white/30'}`}
        >
          Guardar
        </button>
      </Modal>

      {/* Help Modal */}
      <Modal isOpen={showHelp} onClose={() => setShowHelp(false)} title="Gu√≠a de Cuerpo">
        <div className="space-y-4 text-sm">
          <div className="p-3 bg-emerald-500/10 rounded-xl">
            <p className="font-bold text-emerald-400 mb-1">‚öñÔ∏è Seguimiento de peso</p>
            <p className="text-white/60">P√©sate siempre en las mismas condiciones: ma√±ana, en ayunas, despu√©s de ir al ba√±o.</p>
          </div>
          <div className="p-3 bg-white/5 rounded-xl">
            <p className="font-bold text-blue-400 mb-1">üìà Tendencia vs d√≠a a d√≠a</p>
            <p className="text-white/60">El peso fluct√∫a 1-2kg al d√≠a por agua/comida. F√≠jate en la media semanal, no en cada d√≠a.</p>
          </div>
          <div className="p-3 bg-white/5 rounded-xl">
            <p className="font-bold text-amber-400 mb-1">üéØ Ritmo saludable</p>
            <p className="text-white/60">
              <strong>Perder</strong>: 0.5-1% peso/semana<br />
              <strong>Ganar</strong>: 0.25-0.5% peso/semana<br />
              M√°s r√°pido = p√©rdida muscular o grasa innecesaria
            </p>
          </div>
          <div className="p-3 bg-white/5 rounded-xl">
            <p className="font-bold text-violet-400 mb-1">üìä % Grasa corporal</p>
            <p className="text-white/60">M√°s √∫til que el peso. Hombres: 10-20% saludable. Mujeres: 18-28% saludable.</p>
          </div>
          <div className="p-3 bg-violet-500/20 rounded-xl">
            <p className="font-bold mb-1">üí° Tips</p>
            <p className="text-white/60">
              ‚Ä¢ Registra aunque no te guste el n√∫mero<br />
              ‚Ä¢ M√≠nimo 3 veces/semana para ver tendencia<br />
              ‚Ä¢ Usa notas para contexto (comida, sue√±o, estr√©s)
            </p>
          </div>
        </div>
      </Modal>
    </div>
  );
};

// ============================================================================
// CONTROL SCREEN - M√©tricas de seguimiento
// ============================================================================
const ControlScreen = ({ data, setData, showToast }) => {
  const today = getToday();
  const [subView, setSubView] = useState('metrics'); // 'metrics' | 'goals' | 'areas'
  const [showAddWeight, setShowAddWeight] = useState(false);
  const [newWeight, setNewWeight] = useState('');
  const [editingGoals, setEditingGoals] = useState(false);
  const [tempGoals, setTempGoals] = useState(data.user.goals || {});

  // Active areas
  const activeAreas = data.user.activeAreas || [];

  // Body metrics
  const bodyMetrics = data.bodyMetrics || [];
  const latestWeight = bodyMetrics.sort((a, b) => b.date.localeCompare(a.date))[0];
  const oldestWeight = bodyMetrics.sort((a, b) => a.date.localeCompare(b.date))[0];
  const weightChange = latestWeight && oldestWeight ? (latestWeight.weight - oldestWeight.weight).toFixed(1) : null;

  // Last 30 days weights for chart
  const last30Weights = bodyMetrics
    .filter(m => m.date >= getDateOffset(today, -30))
    .sort((a, b) => a.date.localeCompare(b.date));

  const saveWeight = () => {
    if (!newWeight) return;
    const entry = {
      id: generateId(),
      date: today,
      weight: parseFloat(newWeight)
    };
    setData(prev => ({
      ...prev,
      bodyMetrics: [...(prev.bodyMetrics || []), entry]
    }));
    setNewWeight('');
    setShowAddWeight(false);
    showToast('Peso registrado');
  };

  const saveGoals = () => {
    setData(prev => ({
      ...prev,
      user: { ...prev.user, goals: tempGoals }
    }));
    setEditingGoals(false);
    showToast('Metas actualizadas');
  };

  // Last 7 days stats
  const last7Days = Array.from({ length: 7 }, (_, i) => getDateOffset(today, -i));
  const sleepData = last7Days.map(d => data.days[d]?.sleep_hours || 0).filter(h => h > 0);
  const avgSleep = sleepData.length > 0 ? (sleepData.reduce((a, b) => a + b, 0) / sleepData.length).toFixed(1) : null;
  const energyData = last7Days.map(d => data.days[d]?.energy_level || 0).filter(e => e > 0);
  const avgEnergy = energyData.length > 0 ? (energyData.reduce((a, b) => a + b, 0) / energyData.length).toFixed(1) : null;
  const waterData = last7Days.map(d => data.days[d]?.water_glasses || 0);
  const avgWater = (waterData.reduce((a, b) => a + b, 0) / 7).toFixed(1);
  const stepsData = last7Days.map(d => data.days[d]?.steps || 0);
  const avgSteps = Math.round(stepsData.reduce((a, b) => a + b, 0) / 7);

  // Habits stats
  const habits = data.habits || [];
  const habitLogs = data.habitLogs || [];
  const completionRate = last7Days.reduce((sum, d) => {
    const dayLogs = habitLogs.filter(l => l.date === d && l.completed);
    return sum + (habits.length > 0 ? dayLogs.length / habits.length : 0);
  }, 0) / 7 * 100;

  // Workout stats
  const workouts = data.workouts || [];
  const completedWorkouts = workouts.filter(w => w.is_completed);
  const workoutsThisWeek = completedWorkouts.filter(w => last7Days.includes(w.day_id)).length;

  // Work stats
  const workTasks = data.workTasks || [];
  const completedTasks = workTasks.filter(t => t.completed);
  const tasksThisWeek = completedTasks.filter(t => t.completedAt && last7Days.some(d => t.completedAt.startsWith(d))).length;

  // Personal tasks stats
  const personalTasks = data.personalTasks || [];
  const completedPersonal = personalTasks.filter(t => t.completed).length;
  const pendingPersonal = personalTasks.filter(t => !t.completed).length;

  // Relationships stats
  const relationships = data.relationships || [];
  const frequencyDays = { daily: 1, weekly: 7, biweekly: 14, monthly: 30, quarterly: 90 };
  const relNeedsAttention = relationships.filter(r => {
    if (!r.interactions?.length) return true;
    const sorted = [...r.interactions].sort((a, b) => b.date.localeCompare(a.date));
    const days = Math.floor((new Date(today) - new Date(sorted[0].date)) / (1000 * 60 * 60 * 24));
    return days >= (frequencyDays[r.contactFrequency] || 7);
  }).length;

  // Finances stats
  const transactions = data.finances?.transactions || [];
  const thisMonth = today.substring(0, 7);
  const monthExpenses = transactions.filter(t => t.date?.startsWith(thisMonth) && t.type === 'expense').reduce((s, t) => s + t.amount, 0);
  const monthIncome = transactions.filter(t => t.date?.startsWith(thisMonth) && t.type === 'income').reduce((s, t) => s + t.amount, 0);
  const monthlyBudget = data.finances?.monthlyBudget || 0;

  // Consciousness stats
  const cons = data.consciousness || {};
  const consXP = cons.totalXP || 0;
  const consLevel = (cons.startingLevel || 0) + (cons.currentLevel || 0);

  return (
    <div className="space-y-4 pb-24">
      <AnimatedMount>
        <div className="flex items-center justify-between mb-2">
          <div>
            <h1 className="text-2xl font-bold">Control</h1>
            <p className="text-white/50 text-sm">M√©tricas y metas</p>
          </div>
        </div>

        {/* Tabs */}
        <div className="flex bg-white/10 rounded-xl p-1">
          <button onClick={() => setSubView('metrics')} className={`flex-1 py-2 rounded-lg text-sm font-medium transition-all ${subView === 'metrics' ? 'bg-violet-500' : ''}`}>
            üìä M√©tricas
          </button>
          <button onClick={() => setSubView('goals')} className={`flex-1 py-2 rounded-lg text-sm font-medium transition-all ${subView === 'goals' ? 'bg-violet-500' : ''}`}>
            üéØ Metas
          </button>
          <button onClick={() => setSubView('areas')} className={`flex-1 py-2 rounded-lg text-sm font-medium transition-all ${subView === 'areas' ? 'bg-violet-500' : ''}`}>
            üóÇÔ∏è √Åreas
          </button>
        </div>
      </AnimatedMount>

      {/* METRICS VIEW */}
      {subView === 'metrics' && (
        <>
          {/* Weight Section */}
          <AnimatedMount delay={50}>
            <Section title="PESO" icon={Scale} iconColor="text-teal-400">
              <Card className="bg-gradient-to-r from-teal-500/20 to-cyan-500/20 border-teal-500/30">
                <div className="flex items-center justify-between mb-4">
                  <div>
                    <p className="text-3xl font-bold">{latestWeight?.weight || '-'} kg</p>
                    <p className="text-sm text-white/50">
                      {latestWeight ? `√öltimo: ${formatShortDate(latestWeight.date)}` : 'Sin registros'}
                    </p>
                  </div>
                  {weightChange && (
                    <div className={`px-3 py-1 rounded-full text-sm font-medium ${parseFloat(weightChange) <= 0 ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400'}`}>
                      {parseFloat(weightChange) > 0 ? '+' : ''}{weightChange} kg
                    </div>
                  )}
                </div>

                {last30Weights.length > 1 && (
                  <div className="mb-4">
                    <MiniChart data={last30Weights.map(w => w.weight)} color="#14B8A6" height={60} showDots />
                  </div>
                )}

                <button onClick={() => setShowAddWeight(true)} className="w-full py-3 bg-teal-500/20 hover:bg-teal-500/30 rounded-xl font-medium text-teal-400 transition-colors">
                  + Registrar peso
                </button>
              </Card>
            </Section>
          </AnimatedMount>

          {/* Vitals Section */}
          <AnimatedMount delay={100}>
            <Section title="PROMEDIOS (7 D√çAS)" icon={Activity} iconColor="text-violet-400">
              <div className="grid grid-cols-2 gap-3">
                <Card className="text-center">
                  <Moon className="w-5 h-5 text-blue-400 mx-auto mb-2" />
                  <p className="text-2xl font-bold">{avgSleep || '-'}</p>
                  <p className="text-xs text-white/40">h sue√±o</p>
                </Card>
                <Card className="text-center">
                  <Zap className="w-5 h-5 text-yellow-400 mx-auto mb-2" />
                  <p className="text-2xl font-bold">{avgEnergy || '-'}</p>
                  <p className="text-xs text-white/40">energ√≠a /5</p>
                </Card>
                <Card className="text-center">
                  <Droplets className="w-5 h-5 text-cyan-400 mx-auto mb-2" />
                  <p className="text-2xl font-bold">{avgWater}</p>
                  <p className="text-xs text-white/40">vasos agua</p>
                </Card>
                <Card className="text-center">
                  <Footprints className="w-5 h-5 text-green-400 mx-auto mb-2" />
                  <p className="text-2xl font-bold">{avgSteps > 0 ? `${(avgSteps / 1000).toFixed(1)}k` : '-'}</p>
                  <p className="text-xs text-white/40 flex items-center justify-center gap-1">
                    pasos <Watch className="w-3 h-3" />
                  </p>
                </Card>
              </div>
            </Section>
          </AnimatedMount>

          {/* Areas Overview */}
          <AnimatedMount delay={150}>
            <Section title="RESUMEN POR √ÅREA" icon={LayoutGrid} iconColor="text-fuchsia-400">
              <div className="space-y-2">
                {activeAreas.includes('workout') && (
                  <Card className="py-3 flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 rounded-xl bg-violet-500/20 flex items-center justify-center">
                        <Dumbbell className="w-5 h-5 text-violet-400" />
                      </div>
                      <div>
                        <p className="font-medium">Entreno</p>
                        <p className="text-xs text-white/40">{workoutsThisWeek} esta semana</p>
                      </div>
                    </div>
                    <p className="text-lg font-bold text-violet-400">{completedWorkouts.length}</p>
                  </Card>
                )}

                {activeAreas.includes('habits') && (
                  <Card className="py-3 flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 rounded-xl bg-emerald-500/20 flex items-center justify-center">
                        <CheckSquare className="w-5 h-5 text-emerald-400" />
                      </div>
                      <div>
                        <p className="font-medium">H√°bitos</p>
                        <p className="text-xs text-white/40">{habits.length} activos</p>
                      </div>
                    </div>
                    <p className="text-lg font-bold text-emerald-400">{Math.round(completionRate)}%</p>
                  </Card>
                )}

                {activeAreas.includes('work') && (
                  <Card className="py-3 flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 rounded-xl bg-blue-500/20 flex items-center justify-center">
                        <Briefcase className="w-5 h-5 text-blue-400" />
                      </div>
                      <div>
                        <p className="font-medium">Trabajo</p>
                        <p className="text-xs text-white/40">{tasksThisWeek} tareas esta semana</p>
                      </div>
                    </div>
                    <p className="text-lg font-bold text-blue-400">{completedTasks.length}</p>
                  </Card>
                )}

                {activeAreas.includes('personal') && (
                  <Card className="py-3 flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 rounded-xl bg-cyan-500/20 flex items-center justify-center">
                        <Calendar className="w-5 h-5 text-cyan-400" />
                      </div>
                      <div>
                        <p className="font-medium">Personal</p>
                        <p className="text-xs text-white/40">{pendingPersonal} pendientes</p>
                      </div>
                    </div>
                    <p className="text-lg font-bold text-cyan-400">{completedPersonal}</p>
                  </Card>
                )}

                {activeAreas.includes('relationships') && (
                  <Card className="py-3 flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 rounded-xl bg-pink-500/20 flex items-center justify-center">
                        <Users className="w-5 h-5 text-pink-400" />
                      </div>
                      <div>
                        <p className="font-medium">Relaciones</p>
                        <p className="text-xs text-white/40">{relNeedsAttention} necesitan atenci√≥n</p>
                      </div>
                    </div>
                    <p className="text-lg font-bold text-pink-400">{relationships.length}</p>
                  </Card>
                )}

                {activeAreas.includes('finances') && (
                  <Card className="py-3 flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 rounded-xl bg-green-500/20 flex items-center justify-center">
                        <Wallet className="w-5 h-5 text-green-400" />
                      </div>
                      <div>
                        <p className="font-medium">Finanzas</p>
                        <p className="text-xs text-white/40">{monthlyBudget > 0 ? `${Math.round((monthExpenses / monthlyBudget) * 100)}% usado` : 'Sin presupuesto'}</p>
                      </div>
                    </div>
                    <p className="text-lg font-bold text-green-400">{monthIncome - monthExpenses > 0 ? '+' : ''}{monthIncome - monthExpenses}‚Ç¨</p>
                  </Card>
                )}

                {activeAreas.includes('consciousness') && (
                  <Card className="py-3 flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 rounded-xl bg-purple-500/20 flex items-center justify-center">
                        <Sparkles className="w-5 h-5 text-purple-400" />
                      </div>
                      <div>
                        <p className="font-medium">Consciencia</p>
                        <p className="text-xs text-white/40">Nivel {consLevel + 1}</p>
                      </div>
                    </div>
                    <p className="text-lg font-bold text-purple-400">{consXP} XP</p>
                  </Card>
                )}
              </div>
            </Section>
          </AnimatedMount>
        </>
      )}

      {/* GOALS VIEW */}
      {subView === 'goals' && (
        <AnimatedMount delay={50}>
          <Section title="METAS DIARIAS" icon={Target} iconColor="text-emerald-400">
            <Card>
              {editingGoals ? (
                <div className="space-y-4">
                  <div>
                    <label className="text-sm text-white/50 mb-1 block">Calor√≠as (kcal)</label>
                    <input type="number" value={tempGoals.calories || ''} onChange={e => setTempGoals(p => ({ ...p, calories: parseInt(e.target.value) || 0 }))} className="w-full bg-white/10 rounded-xl px-4 py-3" />
                  </div>
                  <div>
                    <label className="text-sm text-white/50 mb-1 block">Prote√≠na (g)</label>
                    <input type="number" value={tempGoals.protein || ''} onChange={e => setTempGoals(p => ({ ...p, protein: parseInt(e.target.value) || 0 }))} className="w-full bg-white/10 rounded-xl px-4 py-3" />
                  </div>
                  <div>
                    <label className="text-sm text-white/50 mb-1 block">Carbohidratos (g)</label>
                    <input type="number" value={tempGoals.carbs || ''} onChange={e => setTempGoals(p => ({ ...p, carbs: parseInt(e.target.value) || 0 }))} className="w-full bg-white/10 rounded-xl px-4 py-3" />
                  </div>
                  <div>
                    <label className="text-sm text-white/50 mb-1 block">Grasas (g)</label>
                    <input type="number" value={tempGoals.fats || ''} onChange={e => setTempGoals(p => ({ ...p, fats: parseInt(e.target.value) || 0 }))} className="w-full bg-white/10 rounded-xl px-4 py-3" />
                  </div>
                  <div>
                    <label className="text-sm text-white/50 mb-1 block">Horas de sue√±o</label>
                    <input type="number" step="0.5" value={tempGoals.sleep || ''} onChange={e => setTempGoals(p => ({ ...p, sleep: parseFloat(e.target.value) || 0 }))} className="w-full bg-white/10 rounded-xl px-4 py-3" />
                  </div>
                  <div>
                    <label className="text-sm text-white/50 mb-1 block">Vasos de agua</label>
                    <input type="number" value={tempGoals.water || ''} onChange={e => setTempGoals(p => ({ ...p, water: parseInt(e.target.value) || 0 }))} className="w-full bg-white/10 rounded-xl px-4 py-3" />
                  </div>
                  <div>
                    <label className="text-sm text-white/50 mb-1 block flex items-center gap-2">
                      Pasos diarios <Watch className="w-3 h-3 text-white/30" />
                    </label>
                    <input type="number" step="1000" value={tempGoals.steps || ''} onChange={e => setTempGoals(p => ({ ...p, steps: parseInt(e.target.value) || 0 }))} placeholder="10000" className="w-full bg-white/10 rounded-xl px-4 py-3" />
                  </div>
                  <div className="flex gap-2">
                    <button onClick={() => setEditingGoals(false)} className="flex-1 py-3 bg-white/10 rounded-xl">Cancelar</button>
                    <button onClick={saveGoals} className="flex-1 py-3 bg-emerald-500 rounded-xl font-medium">Guardar</button>
                  </div>
                </div>
              ) : (
                <div className="space-y-4">
                  {[
                    { label: 'Calor√≠as diarias', value: data.user.goals?.calories || 2200, unit: 'kcal', color: 'bg-orange-500' },
                    { label: 'Prote√≠na diaria', value: data.user.goals?.protein || 180, unit: 'g', color: 'bg-red-500' },
                    { label: 'Carbohidratos', value: data.user.goals?.carbs || 220, unit: 'g', color: 'bg-yellow-500' },
                    { label: 'Grasas', value: data.user.goals?.fats || 70, unit: 'g', color: 'bg-purple-500' },
                    { label: 'Horas de sue√±o', value: data.user.goals?.sleep || 8, unit: 'h', color: 'bg-blue-500' },
                    { label: 'Vasos de agua', value: data.user.goals?.water || 8, unit: '', color: 'bg-cyan-500' },
                    { label: 'Pasos diarios', value: (data.user.goals?.steps || 10000).toLocaleString(), unit: '', color: 'bg-green-500', icon: 'üëü' }
                  ].map((goal, i) => (
                    <div key={i}>
                      <div className="flex justify-between text-sm mb-1">
                        <span className="text-white/60">{goal.label} {goal.icon || ''}</span>
                        <span className="font-medium">{goal.value}{goal.unit}</span>
                      </div>
                      <ProgressBar value={100} max={100} color={goal.color} />
                    </div>
                  ))}
                  <button onClick={() => { setTempGoals(data.user.goals || {}); setEditingGoals(true); }} className="w-full py-3 bg-white/10 hover:bg-white/20 rounded-xl font-medium transition-colors">
                    ‚úèÔ∏è Editar metas
                  </button>
                </div>
              )}
            </Card>
          </Section>

          {/* Additional Goals */}
          <Section title="METAS DE H√ÅBITOS" icon={CheckSquare} iconColor="text-emerald-400">
            <Card>
              <div className="space-y-3">
                <div className="flex justify-between items-center">
                  <span className="text-white/60">Entrenos por semana</span>
                  <span className="font-bold">{workoutsThisWeek} / 4</span>
                </div>
                <ProgressBar value={workoutsThisWeek} max={4} color="bg-violet-500" />

                <div className="flex justify-between items-center mt-4">
                  <span className="text-white/60">Tasa de h√°bitos</span>
                  <span className="font-bold">{Math.round(completionRate)}% / 80%</span>
                </div>
                <ProgressBar value={completionRate} max={80} color="bg-emerald-500" />
              </div>
            </Card>
          </Section>
        </AnimatedMount>
      )}

      {/* AREAS VIEW */}
      {subView === 'areas' && (
        <AnimatedMount delay={50}>
          <Section title="√ÅREAS ACTIVAS" icon={LayoutGrid} iconColor="text-fuchsia-400">
            <p className="text-sm text-white/50 mb-3">Resumen del estado de cada √°rea</p>
            <div className="space-y-3">
              {[
                { id: 'nutrition', name: 'Nutrici√≥n', icon: 'üçΩÔ∏è', color: '#F59E0B', stat: `${Math.round(avgWater * 250)}ml agua avg`, status: parseFloat(avgWater) >= 6 ? 'good' : 'warning' },
                { id: 'workout', name: 'Entreno', icon: 'üí™', color: '#8B5CF6', stat: `${workoutsThisWeek} esta semana`, status: workoutsThisWeek >= 3 ? 'good' : workoutsThisWeek >= 1 ? 'warning' : 'bad' },
                { id: 'habits', name: 'H√°bitos', icon: '‚úÖ', color: '#10B981', stat: `${Math.round(completionRate)}% completado`, status: completionRate >= 70 ? 'good' : completionRate >= 40 ? 'warning' : 'bad' },
                { id: 'work', name: 'Trabajo', icon: 'üíº', color: '#3B82F6', stat: `${workTasks.filter(t => !t.completed).length} pendientes`, status: workTasks.filter(t => !t.completed && t.eisenhower === 'q1').length === 0 ? 'good' : 'warning' },
                { id: 'personal', name: 'Personal', icon: 'üìã', color: '#06B6D4', stat: `${pendingPersonal} tareas`, status: personalTasks.filter(t => !t.completed && t.dueDate && t.dueDate < today).length === 0 ? 'good' : 'warning' },
                { id: 'finances', name: 'Finanzas', icon: 'üí∞', color: '#22C55E', stat: monthlyBudget > 0 ? `${Math.round((monthExpenses / monthlyBudget) * 100)}% presupuesto` : 'Sin presupuesto', status: monthlyBudget === 0 || monthExpenses <= monthlyBudget ? 'good' : 'bad' },
                { id: 'relationships', name: 'Relaciones', icon: 'üë•', color: '#EC4899', stat: `${relNeedsAttention} pendientes`, status: relNeedsAttention <= 2 ? 'good' : relNeedsAttention <= 5 ? 'warning' : 'bad' },
                { id: 'consciousness', name: 'Consciencia', icon: 'üßò', color: '#A855F7', stat: `${consXP} XP total`, status: 'good' },
                { id: 'body', name: 'Cuerpo', icon: '‚öñÔ∏è', color: '#14B8A6', stat: latestWeight ? `${latestWeight.weight}kg` : 'Sin registro', status: 'neutral' }
              ].filter(area => activeAreas.includes(area.id)).map(area => (
                <Card key={area.id} className="py-3 flex items-center gap-3" style={{ borderLeftWidth: '3px', borderLeftColor: area.color }}>
                  <div className="w-10 h-10 rounded-xl flex items-center justify-center text-xl" style={{ backgroundColor: area.color + '20' }}>
                    {area.icon}
                  </div>
                  <div className="flex-1">
                    <p className="font-medium">{area.name}</p>
                    <p className="text-xs text-white/40">{area.stat}</p>
                  </div>
                  <div className={`w-3 h-3 rounded-full ${area.status === 'good' ? 'bg-emerald-500' : area.status === 'warning' ? 'bg-amber-500' : area.status === 'bad' ? 'bg-red-500' : 'bg-white/20'}`} />
                </Card>
              ))}
            </div>
          </Section>
        </AnimatedMount>
      )}

      {/* Add Weight Modal */}
      <Modal isOpen={showAddWeight} onClose={() => setShowAddWeight(false)} title="Registrar peso"
        footer={<button onClick={saveWeight} className="w-full py-4 bg-teal-500 rounded-xl font-medium">Guardar</button>}
      >
        <div className="text-center">
          <input type="number" step="0.1" value={newWeight} onChange={(e) => setNewWeight(e.target.value)} placeholder="70.0" className="w-full bg-white/10 rounded-xl p-4 text-3xl font-bold text-center outline-none" />
          <p className="text-white/40 mt-2">kg</p>
        </div>
      </Modal>
    </div>
  );
};

// ============================================================================
// FINANCES SCREEN
// ============================================================================
const FinancesScreen = ({ data, setData, showToast }) => {
  const [view, setView] = useState('home'); // home, add, history, stats
  const [showAdd, setShowAdd] = useState(false);
  const [showSettings, setShowSettings] = useState(false);
  const [showHelp, setShowHelp] = useState(false);
  const [transactionType, setTransactionType] = useState('expense'); // expense, income
  const [newTransaction, setNewTransaction] = useState({
    amount: '',
    category: '',
    description: '',
    date: getToday()
  });

  const [localSettings, setLocalSettings] = useState({
    monthlyBudget: data.finances?.monthlyBudget || 0,
    currency: data.finances?.currency || '‚Ç¨',
    weekStartsMonday: data.finances?.weekStartsMonday ?? true
  });

  const saveSettings = () => {
    setData(prev => ({
      ...prev,
      finances: {
        ...prev.finances,
        monthlyBudget: localSettings.monthlyBudget,
        currency: localSettings.currency,
        weekStartsMonday: localSettings.weekStartsMonday
      }
    }));
    setShowSettings(false);
    showToast('Configuraci√≥n guardada');
  };

  const today = getToday();
  const transactions = data.finances?.transactions || [];

  // Categories
  const expenseCategories = [
    { id: 'food', name: 'Comida', icon: 'üçΩÔ∏è', color: 'orange' },
    { id: 'transport', name: 'Transporte', icon: 'üöó', color: 'blue' },
    { id: 'shopping', name: 'Compras', icon: 'üõí', color: 'pink' },
    { id: 'entertainment', name: 'Ocio', icon: 'üé¨', color: 'purple' },
    { id: 'health', name: 'Salud', icon: 'üíä', color: 'emerald' },
    { id: 'home', name: 'Hogar', icon: 'üè†', color: 'yellow' },
    { id: 'subscriptions', name: 'Suscripciones', icon: 'üì±', color: 'indigo' },
    { id: 'other', name: 'Otros', icon: 'üì¶', color: 'gray' },
  ];

  const incomeCategories = [
    { id: 'salary', name: 'Salario', icon: 'üíº', color: 'emerald' },
    { id: 'freelance', name: 'Freelance', icon: 'üíª', color: 'blue' },
    { id: 'investment', name: 'Inversiones', icon: 'üìà', color: 'green' },
    { id: 'gift', name: 'Regalo', icon: 'üéÅ', color: 'pink' },
    { id: 'refund', name: 'Reembolso', icon: '‚Ü©Ô∏è', color: 'yellow' },
    { id: 'other', name: 'Otros', icon: 'üí∞', color: 'gray' },
  ];

  const categories = transactionType === 'expense' ? expenseCategories : incomeCategories;

  // Calculations
  const thisMonth = today.substring(0, 7);
  const monthTransactions = transactions.filter(t => t.date?.startsWith(thisMonth));
  const monthExpenses = monthTransactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
  const monthIncome = monthTransactions.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
  const monthBalance = monthIncome - monthExpenses;

  const todayTransactions = transactions.filter(t => t.date === today);
  const todayExpenses = todayTransactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);

  // Budget
  const monthlyBudget = data.finances?.monthlyBudget || 0;
  const budgetUsed = monthlyBudget > 0 ? Math.round((monthExpenses / monthlyBudget) * 100) : 0;

  // By category this month
  const expensesByCategory = expenseCategories.map(cat => ({
    ...cat,
    total: monthTransactions.filter(t => t.type === 'expense' && t.category === cat.id).reduce((s, t) => s + t.amount, 0)
  })).filter(c => c.total > 0).sort((a, b) => b.total - a.total);

  // Last 7 days spending
  const last7Days = Array.from({ length: 7 }, (_, i) => getDateOffset(today, -i));
  const dailySpending = last7Days.map(d =>
    transactions.filter(t => t.date === d && t.type === 'expense').reduce((s, t) => s + t.amount, 0)
  ).reverse();

  const saveTransaction = () => {
    if (!newTransaction.amount || !newTransaction.category) {
      showToast('Completa los campos');
      return;
    }

    const transaction = {
      id: generateId(),
      type: transactionType,
      amount: parseFloat(newTransaction.amount),
      category: newTransaction.category,
      description: newTransaction.description,
      date: newTransaction.date
    };

    setData(prev => ({
      ...prev,
      finances: {
        ...prev.finances,
        transactions: [...(prev.finances?.transactions || []), transaction]
      }
    }));

    setShowAdd(false);
    setNewTransaction({ amount: '', category: '', description: '', date: getToday() });
    showToast(transactionType === 'expense' ? 'Gasto registrado' : 'Ingreso registrado');
  };

  const deleteTransaction = (id) => {
    setData(prev => ({
      ...prev,
      finances: {
        ...prev.finances,
        transactions: prev.finances.transactions.filter(t => t.id !== id)
      }
    }));
    showToast('Eliminado');
  };

  const getCategoryInfo = (categoryId, type) => {
    const cats = type === 'expense' ? expenseCategories : incomeCategories;
    return cats.find(c => c.id === categoryId) || { icon: 'üí∞', name: categoryId, color: 'gray' };
  };

  return (
    <div className="space-y-4 pb-24">
      <AnimatedMount>
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-bold">Finanzas</h1>
            <p className="text-white/50 text-sm">{new Date().toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}</p>
          </div>
          <div className="flex items-center gap-2">
            <button onClick={() => setShowHelp(true)} className="p-3 hover:bg-white/10 rounded-full">
              <BookOpen className="w-5 h-5 text-white/50" />
            </button>
            <button onClick={() => setShowSettings(true)} className="p-3 hover:bg-white/10 rounded-full">
              <Settings className="w-5 h-5 text-white/50" />
            </button>
            <button onClick={() => setShowAdd(true)} className="bg-violet-500 rounded-full p-3">
              <Plus className="w-5 h-5" />
            </button>
          </div>
        </div>
      </AnimatedMount>

      {/* Monthly Overview */}
      <AnimatedMount delay={50}>
        <Card className={`bg-gradient-to-r ${monthBalance >= 0 ? 'from-emerald-500/20 to-green-500/20 border-emerald-500/30' : 'from-red-500/20 to-orange-500/20 border-red-500/30'}`}>
          <div className="flex items-center justify-between mb-4">
            <div>
              <p className="text-xs text-white/50">Balance del mes</p>
              <p className={`text-3xl font-bold ${monthBalance >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                {monthBalance >= 0 ? '+' : ''}{monthBalance.toLocaleString()}‚Ç¨
              </p>
            </div>
            <div className="text-right">
              <p className="text-sm text-emerald-400">+{monthIncome.toLocaleString()}‚Ç¨</p>
              <p className="text-sm text-red-400">-{monthExpenses.toLocaleString()}‚Ç¨</p>
            </div>
          </div>

          {monthlyBudget > 0 && (
            <div>
              <div className="flex justify-between text-xs text-white/50 mb-1">
                <span>Presupuesto</span>
                <span>{monthExpenses.toLocaleString()}‚Ç¨ / {monthlyBudget.toLocaleString()}‚Ç¨</span>
              </div>
              <ProgressBar
                value={budgetUsed}
                max={100}
                color={budgetUsed > 100 ? 'bg-red-500' : budgetUsed > 80 ? 'bg-yellow-500' : 'bg-emerald-500'}
              />
            </div>
          )}
        </Card>
      </AnimatedMount>

      {/* Quick Stats */}
      <AnimatedMount delay={75}>
        <div className="grid grid-cols-2 gap-3">
          <Card className="text-center">
            <p className="text-2xl font-bold text-red-400">-{todayExpenses.toLocaleString()}‚Ç¨</p>
            <p className="text-xs text-white/40">Hoy</p>
          </Card>
          <Card className="text-center">
            <p className="text-2xl font-bold">{transactions.length}</p>
            <p className="text-xs text-white/40">Transacciones</p>
          </Card>
        </div>
      </AnimatedMount>

      {/* Spending Chart */}
      {dailySpending.some(d => d > 0) && (
        <AnimatedMount delay={100}>
          <Card>
            <p className="font-medium mb-2">Gastos √∫ltimos 7 d√≠as</p>
            <MiniChart data={dailySpending} color="#EF4444" height={60} />
          </Card>
        </AnimatedMount>
      )}

      {/* By Category */}
      {expensesByCategory.length > 0 && (
        <AnimatedMount delay={125}>
          <Card>
            <p className="font-medium mb-3">Por categor√≠a</p>
            <div className="space-y-2">
              {expensesByCategory.slice(0, 5).map(cat => (
                <div key={cat.id} className="flex items-center gap-3">
                  <span className="text-lg">{cat.icon}</span>
                  <div className="flex-1">
                    <div className="flex justify-between text-sm mb-1">
                      <span>{cat.name}</span>
                      <span className="font-medium">{cat.total.toLocaleString()}‚Ç¨</span>
                    </div>
                    <ProgressBar
                      value={cat.total}
                      max={monthExpenses}
                      color={`bg-${cat.color}-500`}
                      height="h-1"
                    />
                  </div>
                </div>
              ))}
            </div>
          </Card>
        </AnimatedMount>
      )}

      {/* Recent Transactions */}
      <AnimatedMount delay={150}>
        <Section title="RECIENTES" icon={Clock} iconColor="text-blue-400">
          {transactions.length > 0 ? (
            <div className="space-y-2">
              {transactions
                .sort((a, b) => b.date.localeCompare(a.date))
                .slice(0, 10)
                .map(t => {
                  const cat = getCategoryInfo(t.category, t.type);
                  return (
                    <SwipeableItem key={t.id} onDelete={() => deleteTransaction(t.id)}>
                      <Card className="py-3">
                        <div className="flex items-center gap-3">
                          <span className="text-xl">{cat.icon}</span>
                          <div className="flex-1">
                            <p className="font-medium text-sm">{t.description || cat.name}</p>
                            <p className="text-xs text-white/40">{formatShortDate(t.date)}</p>
                          </div>
                          <p className={`font-bold ${t.type === 'income' ? 'text-emerald-400' : 'text-red-400'}`}>
                            {t.type === 'income' ? '+' : '-'}{t.amount.toLocaleString()}‚Ç¨
                          </p>
                        </div>
                      </Card>
                    </SwipeableItem>
                  );
                })}
            </div>
          ) : (
            <EmptyState icon={Wallet} title="Sin transacciones" description="Registra tu primer gasto o ingreso" />
          )}
        </Section>
      </AnimatedMount>

      {/* Add Transaction Modal */}
      <Modal isOpen={showAdd} onClose={() => setShowAdd(false)} title="Nueva transacci√≥n">
        {/* Type Toggle */}
        <div className="flex gap-2 mb-4">
          <button
            onClick={() => setTransactionType('expense')}
            className={`flex-1 py-2 rounded-xl font-medium ${transactionType === 'expense' ? 'bg-red-500' : 'bg-white/10'}`}
          >
            Gasto
          </button>
          <button
            onClick={() => setTransactionType('income')}
            className={`flex-1 py-2 rounded-xl font-medium ${transactionType === 'income' ? 'bg-emerald-500' : 'bg-white/10'}`}
          >
            Ingreso
          </button>
        </div>

        {/* Amount */}
        <div className="mb-4">
          <label className="text-sm text-white/60 mb-1 block">Cantidad (‚Ç¨)</label>
          <input
            type="number"
            value={newTransaction.amount}
            onChange={(e) => setNewTransaction(t => ({ ...t, amount: e.target.value }))}
            placeholder="0.00"
            className="w-full bg-white/10 rounded-xl p-4 text-2xl font-bold text-center outline-none"
          />
        </div>

        {/* Category */}
        <div className="mb-4">
          <label className="text-sm text-white/60 mb-2 block">Categor√≠a</label>
          <div className="grid grid-cols-4 gap-2">
            {categories.map(cat => (
              <button
                key={cat.id}
                onClick={() => setNewTransaction(t => ({ ...t, category: cat.id }))}
                className={`p-3 rounded-xl text-center ${newTransaction.category === cat.id ? 'bg-violet-500' : 'bg-white/10'}`}
              >
                <span className="text-xl block mb-1">{cat.icon}</span>
                <span className="text-xs">{cat.name}</span>
              </button>
            ))}
          </div>
        </div>

        {/* Description */}
        <div className="mb-4">
          <label className="text-sm text-white/60 mb-1 block">Descripci√≥n (opcional)</label>
          <input
            type="text"
            value={newTransaction.description}
            onChange={(e) => setNewTransaction(t => ({ ...t, description: e.target.value }))}
            placeholder="Ej: Caf√© con amigos"
            className="w-full bg-white/10 rounded-xl p-3 outline-none"
          />
        </div>

        {/* Date */}
        <div className="mb-6">
          <label className="text-sm text-white/60 mb-1 block">Fecha</label>
          <input
            type="date"
            value={newTransaction.date}
            onChange={(e) => setNewTransaction(t => ({ ...t, date: e.target.value }))}
            className="w-full bg-white/10 rounded-xl p-3 outline-none"
          />
        </div>

        <button
          onClick={saveTransaction}
          className={`w-full py-4 rounded-xl font-bold ${transactionType === 'expense' ? 'bg-red-500' : 'bg-emerald-500'}`}
        >
          Guardar {transactionType === 'expense' ? 'gasto' : 'ingreso'}
        </button>
      </Modal>

      {/* Settings Modal */}
      <Modal
        isOpen={showSettings}
        onClose={() => setShowSettings(false)}
        title="Configuraci√≥n Finanzas"
        footer={
          <button onClick={saveSettings} className="w-full py-4 bg-violet-500 rounded-xl font-medium">
            Guardar cambios
          </button>
        }
      >
        <div className="space-y-4">
          <div>
            <label className="text-sm text-white/60 mb-2 block">Presupuesto mensual</label>
            <div className="flex items-center gap-2">
              <input
                type="number"
                value={localSettings.monthlyBudget}
                onChange={(e) => setLocalSettings(p => ({ ...p, monthlyBudget: parseFloat(e.target.value) || 0 }))}
                className="flex-1 bg-white/10 rounded-xl p-4 outline-none text-xl font-bold text-center"
                placeholder="0"
              />
              <span className="text-xl">{localSettings.currency}</span>
            </div>
          </div>
          <div>
            <label className="text-sm text-white/60 mb-2 block">Moneda</label>
            <div className="flex gap-2">
              {['‚Ç¨', '$', '¬£', '¬•'].map(c => (
                <button
                  key={c}
                  onClick={() => setLocalSettings(p => ({ ...p, currency: c }))}
                  className={`flex-1 py-3 rounded-xl text-xl ${localSettings.currency === c ? 'bg-violet-500' : 'bg-white/10'}`}
                >
                  {c}
                </button>
              ))}
            </div>
          </div>
        </div>
      </Modal>

      {/* Help Modal */}
      <Modal isOpen={showHelp} onClose={() => setShowHelp(false)} title="Gu√≠a de Finanzas">
        <div className="space-y-4 text-sm">
          <div className="p-3 bg-emerald-500/10 rounded-xl">
            <p className="font-bold text-emerald-400 mb-1">üí∞ Control b√°sico</p>
            <p className="text-white/60">Registra cada gasto e ingreso. La consciencia es el primer paso al control financiero.</p>
          </div>
          <div className="p-3 bg-white/5 rounded-xl">
            <p className="font-bold text-amber-400 mb-1">üìä Presupuesto mensual</p>
            <p className="text-white/60">Define cu√°nto puedes gastar al mes. La barra de progreso te avisa si vas por encima.</p>
          </div>
          <div className="p-3 bg-white/5 rounded-xl">
            <p className="font-bold text-blue-400 mb-1">üìÅ Categor√≠as</p>
            <p className="text-white/60">Usa categor√≠as para ver d√≥nde va tu dinero. Identifica patrones de gasto.</p>
          </div>
          <div className="p-3 bg-white/5 rounded-xl">
            <p className="font-bold text-red-400 mb-1">üî¥ Gastos vs üü¢ Ingresos</p>
            <p className="text-white/60">Registra ambos para ver tu balance real. El objetivo: que los ingresos superen gastos.</p>
          </div>
          <div className="p-3 bg-violet-500/20 rounded-xl">
            <p className="font-bold mb-1">üí° Reglas √∫tiles</p>
            <p className="text-white/60">
              ‚Ä¢ <strong>50/30/20</strong>: 50% necesidades, 30% deseos, 20% ahorro<br />
              ‚Ä¢ Registra gastos al momento, no despu√©s<br />
              ‚Ä¢ Revisa semanalmente d√≥nde va tu dinero<br />
              ‚Ä¢ Los peque√±os gastos diarios suman mucho
            </p>
          </div>
        </div>
      </Modal>
    </div>
  );
};

// ============================================================================
// PERSONAL SCREEN - Simple life tasks management
// ============================================================================
const PersonalScreen = ({ data, setData, showToast }) => {
  const today = getToday();
  const [showAdd, setShowAdd] = useState(false);
  const [editingTask, setEditingTask] = useState(null);
  const [filter, setFilter] = useState('all');
  const [showCompleted, setShowCompleted] = useState(false);

  const [newTask, setNewTask] = useState({
    title: '',
    category: 'home',
    dueDate: '',
    important: false,
    notes: ''
  });

  const categories = [
    { id: 'home', name: 'Casa', icon: 'üè†', color: '#F59E0B' },
    { id: 'vehicle', name: 'Veh√≠culo', icon: 'üöó', color: '#3B82F6' },
    { id: 'health', name: 'Salud', icon: 'üè•', color: '#10B981' },
    { id: 'errands', name: 'Tr√°mites', icon: 'üìã', color: '#8B5CF6' },
    { id: 'shopping', name: 'Compras', icon: 'üõí', color: '#EC4899' },
    { id: 'selfcare', name: 'Cuidado', icon: 'üë§', color: '#06B6D4' },
    { id: 'calls', name: 'Gestiones', icon: 'üìû', color: '#EF4444' }
  ];

  const getCat = (id) => categories.find(c => c.id === id) || categories[0];

  // Data
  const tasks = data.personalTasks || [];
  const pendingTasks = tasks.filter(t => !t.completed);
  const completedTasks = tasks.filter(t => t.completed);

  // Filtered
  const filteredPending = filter === 'all' ? pendingTasks : pendingTasks.filter(t => t.category === filter);

  // Group by date
  const withDate = filteredPending.filter(t => t.dueDate).sort((a, b) => a.dueDate.localeCompare(b.dueDate));
  const withoutDate = filteredPending.filter(t => !t.dueDate);
  const overdue = withDate.filter(t => t.dueDate < today);
  const upcoming = withDate.filter(t => t.dueDate >= today);

  // Actions
  const addTask = () => {
    if (!newTask.title.trim()) return;
    const task = {
      id: crypto.randomUUID(),
      ...newTask,
      completed: false,
      completedAt: null,
      createdAt: new Date().toISOString()
    };
    setData(prev => ({
      ...prev,
      personalTasks: [...(prev.personalTasks || []), task]
    }));
    setNewTask({ title: '', category: 'home', dueDate: '', important: false, notes: '' });
    setShowAdd(false);
    showToast('‚úì Tarea a√±adida');
  };

  const toggleTask = (id) => {
    setData(prev => ({
      ...prev,
      personalTasks: prev.personalTasks.map(t =>
        t.id === id ? { ...t, completed: !t.completed, completedAt: !t.completed ? new Date().toISOString() : null } : t
      )
    }));
  };

  const deleteTask = (id) => {
    setData(prev => ({
      ...prev,
      personalTasks: prev.personalTasks.filter(t => t.id !== id)
    }));
    setEditingTask(null);
    showToast('Eliminada');
  };

  const updateTask = (task) => {
    setData(prev => ({
      ...prev,
      personalTasks: prev.personalTasks.map(t => t.id === task.id ? task : t)
    }));
    setEditingTask(null);
    showToast('Guardado');
  };

  // Task card component
  const TaskCard = ({ task }) => {
    const cat = getCat(task.category);
    const isOverdue = task.dueDate && task.dueDate < today && !task.completed;

    return (
      <div
        onClick={() => setEditingTask(task)}
        className={`p-3 bg-zinc-800/50 rounded-xl border-l-4 cursor-pointer hover:bg-zinc-800 transition-all ${task.completed ? 'opacity-50' : ''
          }`}
        style={{ borderColor: cat.color }}
      >
        <div className="flex items-start gap-3">
          <button
            onClick={(e) => { e.stopPropagation(); toggleTask(task.id); }}
            className={`w-6 h-6 rounded-full border-2 flex items-center justify-center flex-shrink-0 mt-0.5 transition-all ${task.completed ? 'bg-emerald-500 border-emerald-500' : 'border-white/30 hover:border-white/50'
              }`}
          >
            {task.completed && <Check className="w-4 h-4" />}
          </button>

          <div className="flex-1 min-w-0">
            <div className="flex items-center gap-2">
              {task.important && <span className="text-amber-400">‚≠ê</span>}
              <p className={`font-medium ${task.completed ? 'line-through text-white/40' : ''}`}>
                {task.title}
              </p>
            </div>

            <div className="flex items-center gap-2 mt-1 flex-wrap">
              <span className="text-xs px-2 py-0.5 rounded-full" style={{ backgroundColor: cat.color + '30', color: cat.color }}>
                {cat.icon} {cat.name}
              </span>
              {task.dueDate && (
                <span className={`text-xs ${isOverdue ? 'text-red-400' : 'text-white/40'}`}>
                  üìÖ {task.dueDate === today ? 'Hoy' : new Date(task.dueDate).toLocaleDateString('es', { day: 'numeric', month: 'short' })}
                </span>
              )}
              {isOverdue && <span className="text-xs text-red-400">‚ö†Ô∏è Vencida</span>}
            </div>

            {task.notes && (
              <p className="text-xs text-white/40 mt-1 line-clamp-1">{task.notes}</p>
            )}
          </div>
        </div>
      </div>
    );
  };

  return (
    <div className="space-y-4 pb-24">
      {/* Header */}
      <AnimatedMount>
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-bold">Personal</h1>
            <p className="text-white/50 text-sm">{pendingTasks.length} pendientes</p>
          </div>
          <button
            onClick={() => setShowAdd(true)}
            className="bg-violet-500 rounded-full p-3"
          >
            <Plus className="w-5 h-5" />
          </button>
        </div>
      </AnimatedMount>

      {/* Category filters */}
      <AnimatedMount delay={50}>
        <div className="flex gap-2 overflow-x-auto pb-2" style={{ scrollbarWidth: 'none' }}>
          <button
            onClick={() => setFilter('all')}
            className={`px-3 py-1.5 rounded-full text-sm whitespace-nowrap ${filter === 'all' ? 'bg-violet-500' : 'bg-white/10'
              }`}
          >
            Todos ({pendingTasks.length})
          </button>
          {categories.map(cat => {
            const count = pendingTasks.filter(t => t.category === cat.id).length;
            if (count === 0 && filter !== cat.id) return null;
            return (
              <button
                key={cat.id}
                onClick={() => setFilter(cat.id)}
                className={`px-3 py-1.5 rounded-full text-sm whitespace-nowrap flex items-center gap-1 ${filter === cat.id ? 'bg-violet-500' : 'bg-white/10'
                  }`}
              >
                {cat.icon} {count}
              </button>
            );
          })}
        </div>
      </AnimatedMount>

      {/* Overdue */}
      {overdue.length > 0 && (
        <AnimatedMount delay={75}>
          <div className="space-y-2">
            <p className="text-xs text-red-400 font-medium flex items-center gap-1">
              <AlertCircle className="w-3 h-3" /> VENCIDAS ({overdue.length})
            </p>
            {overdue.map(task => <TaskCard key={task.id} task={task} />)}
          </div>
        </AnimatedMount>
      )}

      {/* Upcoming */}
      {upcoming.length > 0 && (
        <AnimatedMount delay={100}>
          <div className="space-y-2">
            <p className="text-xs text-white/40 font-medium">üìÖ PR√ìXIMAS ({upcoming.length})</p>
            {upcoming.map(task => <TaskCard key={task.id} task={task} />)}
          </div>
        </AnimatedMount>
      )}

      {/* Without date */}
      {withoutDate.length > 0 && (
        <AnimatedMount delay={125}>
          <div className="space-y-2">
            <p className="text-xs text-white/40 font-medium">üìã SIN FECHA ({withoutDate.length})</p>
            {withoutDate.map(task => <TaskCard key={task.id} task={task} />)}
          </div>
        </AnimatedMount>
      )}

      {/* Empty state */}
      {filteredPending.length === 0 && (
        <AnimatedMount delay={100}>
          <div className="text-center py-12">
            <div className="text-4xl mb-3">‚ú®</div>
            <p className="text-white/60">Sin tareas pendientes</p>
            <p className="text-sm text-white/40">¬°Todo al d√≠a!</p>
          </div>
        </AnimatedMount>
      )}

      {/* Completed toggle */}
      {completedTasks.length > 0 && (
        <AnimatedMount delay={150}>
          <button
            onClick={() => setShowCompleted(!showCompleted)}
            className="w-full py-3 text-sm text-white/40 hover:text-white/60 flex items-center justify-center gap-2"
          >
            <Check className="w-4 h-4" />
            Completadas ({completedTasks.length})
            <ChevronDown className={`w-4 h-4 transition-transform ${showCompleted ? 'rotate-180' : ''}`} />
          </button>

          {showCompleted && (
            <div className="space-y-2">
              {completedTasks.slice(0, 10).map(task => <TaskCard key={task.id} task={task} />)}
            </div>
          )}
        </AnimatedMount>
      )}

      {/* ADD MODAL */}
      <Modal isOpen={showAdd} onClose={() => setShowAdd(false)} title="Nueva tarea personal">
        <div className="space-y-4">
          <input
            type="text"
            value={newTask.title}
            onChange={(e) => setNewTask(p => ({ ...p, title: e.target.value }))}
            placeholder="¬øQu√© necesitas hacer?"
            className="w-full bg-white/10 rounded-xl p-4 outline-none text-lg"
            autoFocus
          />

          {/* Category */}
          <div>
            <p className="text-xs text-white/40 mb-2">Categor√≠a</p>
            <div className="grid grid-cols-4 gap-2">
              {categories.map(cat => (
                <button
                  key={cat.id}
                  onClick={() => setNewTask(p => ({ ...p, category: cat.id }))}
                  className={`p-2 rounded-xl text-center transition-all ${newTask.category === cat.id ? 'ring-2 ring-violet-500' : ''
                    }`}
                  style={{ backgroundColor: cat.color + '20' }}
                >
                  <span className="text-xl">{cat.icon}</span>
                  <p className="text-[10px] mt-1" style={{ color: cat.color }}>{cat.name}</p>
                </button>
              ))}
            </div>
          </div>

          {/* Date & Important */}
          <div className="grid grid-cols-2 gap-3">
            <div>
              <p className="text-xs text-white/40 mb-2">Fecha (opcional)</p>
              <input
                type="date"
                value={newTask.dueDate}
                onChange={(e) => setNewTask(p => ({ ...p, dueDate: e.target.value }))}
                className="w-full bg-white/10 rounded-xl p-3 outline-none text-sm"
              />
            </div>
            <div>
              <p className="text-xs text-white/40 mb-2">Prioridad</p>
              <button
                onClick={() => setNewTask(p => ({ ...p, important: !p.important }))}
                className={`w-full p-3 rounded-xl flex items-center justify-center gap-2 ${newTask.important ? 'bg-amber-500' : 'bg-white/10'
                  }`}
              >
                ‚≠ê {newTask.important ? 'Importante' : 'Normal'}
              </button>
            </div>
          </div>

          {/* Notes */}
          <textarea
            value={newTask.notes}
            onChange={(e) => setNewTask(p => ({ ...p, notes: e.target.value }))}
            placeholder="Notas (opcional)"
            className="w-full bg-white/10 rounded-xl p-3 outline-none text-sm h-20 resize-none"
          />

          <button
            onClick={addTask}
            disabled={!newTask.title.trim()}
            className={`w-full py-4 rounded-xl font-bold text-lg ${newTask.title.trim() ? 'bg-violet-500' : 'bg-white/10 text-white/30'
              }`}
          >
            A√±adir tarea
          </button>
        </div>
      </Modal>

      {/* EDIT MODAL */}
      <Modal isOpen={!!editingTask} onClose={() => setEditingTask(null)} title="Editar tarea">
        {editingTask && (
          <div className="space-y-4">
            <input
              type="text"
              value={editingTask.title}
              onChange={(e) => setEditingTask(p => ({ ...p, title: e.target.value }))}
              className="w-full bg-white/10 rounded-xl p-4 outline-none text-lg"
            />

            {/* Category */}
            <div>
              <p className="text-xs text-white/40 mb-2">Categor√≠a</p>
              <div className="grid grid-cols-4 gap-2">
                {categories.map(cat => (
                  <button
                    key={cat.id}
                    onClick={() => setEditingTask(p => ({ ...p, category: cat.id }))}
                    className={`p-2 rounded-xl text-center transition-all ${editingTask.category === cat.id ? 'ring-2 ring-violet-500' : ''
                      }`}
                    style={{ backgroundColor: cat.color + '20' }}
                  >
                    <span className="text-xl">{cat.icon}</span>
                    <p className="text-[10px] mt-1" style={{ color: cat.color }}>{cat.name}</p>
                  </button>
                ))}
              </div>
            </div>

            {/* Date & Important */}
            <div className="grid grid-cols-2 gap-3">
              <div>
                <p className="text-xs text-white/40 mb-2">Fecha</p>
                <input
                  type="date"
                  value={editingTask.dueDate || ''}
                  onChange={(e) => setEditingTask(p => ({ ...p, dueDate: e.target.value }))}
                  className="w-full bg-white/10 rounded-xl p-3 outline-none text-sm"
                />
              </div>
              <div>
                <p className="text-xs text-white/40 mb-2">Prioridad</p>
                <button
                  onClick={() => setEditingTask(p => ({ ...p, important: !p.important }))}
                  className={`w-full p-3 rounded-xl flex items-center justify-center gap-2 ${editingTask.important ? 'bg-amber-500' : 'bg-white/10'
                    }`}
                >
                  ‚≠ê {editingTask.important ? 'Importante' : 'Normal'}
                </button>
              </div>
            </div>

            {/* Notes */}
            <textarea
              value={editingTask.notes || ''}
              onChange={(e) => setEditingTask(p => ({ ...p, notes: e.target.value }))}
              placeholder="Notas"
              className="w-full bg-white/10 rounded-xl p-3 outline-none text-sm h-20 resize-none"
            />

            {/* Meta */}
            <div className="text-xs text-white/30 pt-2 border-t border-white/10">
              <p>Creada: {new Date(editingTask.createdAt).toLocaleDateString('es')}</p>
              {editingTask.completedAt && <p>Completada: {new Date(editingTask.completedAt).toLocaleDateString('es')}</p>}
            </div>

            {/* Actions */}
            <div className="flex gap-2">
              <button
                onClick={() => updateTask(editingTask)}
                className="flex-1 py-4 bg-violet-500 rounded-xl font-bold"
              >
                Guardar
              </button>
              <button
                onClick={() => { toggleTask(editingTask.id); setEditingTask(null); }}
                className={`py-4 px-5 rounded-xl ${editingTask.completed ? 'bg-amber-500' : 'bg-emerald-500'}`}
              >
                {editingTask.completed ? '‚Ü©Ô∏è' : '‚úì'}
              </button>
              <button
                onClick={() => deleteTask(editingTask.id)}
                className="py-4 px-5 bg-red-500/20 text-red-400 rounded-xl"
              >
                <Trash2 className="w-5 h-5" />
              </button>
            </div>
          </div>
        )}
      </Modal>
    </div>
  );
};

// ============================================================================
// ============================================================================
// CALENDAR SCREEN - Google Calendar Style
// ============================================================================
const CalendarScreen = ({ data, setData, setScreen, showToast }) => {
  const today = getToday();
  const [view, setView] = useState('week'); // 'day', 'week', 'month', 'quarter'
  const [selectedDate, setSelectedDate] = useState(today);
  const [showEventDetail, setShowEventDetail] = useState(null);
  const [showAddModal, setShowAddModal] = useState(false);
  const [showPendingPanel, setShowPendingPanel] = useState(false);
  const [weekMode, setWeekMode] = useState(7); // 4 or 7 days

  const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
  const monthNamesShort = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
  const dayLabels = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];
  const dayLabelsFull = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'];
  const hours = [6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22];

  // Get visible dates based on weekMode
  const getVisibleDates = (baseDate, mode) => {
    if (mode === 7) {
      return getWeekDates(baseDate);
    } else {
      const dates = [];
      const base = new Date(baseDate + 'T12:00:00');
      for (let i = 0; i < 4; i++) {
        const d = new Date(base);
        d.setDate(base.getDate() + i);
        dates.push(d.toISOString().split('T')[0]);
      }
      return dates;
    }
  };

  // Helper: check if habit should show on day
  const shouldDoHabitOnDay = (habit, date) => {
    const dayOfWeek = new Date(date + 'T12:00:00').getDay();
    if (!habit.frequency || habit.frequency === 'daily') return true;
    if (habit.frequency === 'weekdays') return dayOfWeek >= 1 && dayOfWeek <= 5;
    if (habit.frequency === 'weekend') return dayOfWeek === 0 || dayOfWeek === 6;
    if (habit.frequency === 'custom') return (habit.customDays || [1, 2, 3, 4, 5, 6, 0]).includes(dayOfWeek);
    return true;
  };

  // ========== SCHEDULED EVENTS (with specific time) ==========
  const getScheduledEvents = (date) => {
    const events = [];

    // Work tasks WITH scheduled time
    (data.workTasks || []).filter(t =>
      (t.dueDate === date || t.scheduledDate === date) && t.scheduledTime
    ).forEach(task => {
      const project = (data.workProjects || []).find(p => p.id === task.project_id);
      events.push({
        id: `task-${task.id}`, type: 'task', sourceId: task.id, title: task.title,
        time: task.scheduledTime, duration: task.timeEstimate || 60,
        color: project?.color || '#8B5CF6', icon: 'üíº',
        completed: task.status === 'done', priority: task.priority,
        project: project?.name
      });
    });

    // Habits WITH specific time
    (data.habits || []).forEach(habit => {
      if (!shouldDoHabitOnDay(habit, date)) return;
      if (!habit.time) return; // Skip habits without time
      const log = (data.habitLogs || []).find(l => l.habit_id === habit.id && l.date === date);
      events.push({
        id: `habit-${habit.id}-${date}`, type: 'habit', sourceId: habit.id, title: habit.name,
        time: habit.time, duration: 15, color: '#10B981', icon: habit.icon || '‚úÖ',
        completed: log?.completed || false
      });
    });

    // Workouts WITH scheduled time
    const workout = (data.workouts || []).find(w => w.day_id === date);
    if (workout && workout.scheduledTime) {
      events.push({
        id: `workout-${workout.id}`, type: 'workout', sourceId: workout.id, title: workout.name,
        time: workout.scheduledTime, duration: 60, color: '#A855F7', icon: 'üí™',
        completed: workout.is_completed
      });
    }

    // Meals (always have implicit times)
    const mealSlots = [
      { key: 'desayuno', time: '08:00', label: 'Desayuno', icon: 'üç≥' },
      { key: 'almuerzo', time: '13:30', label: 'Almuerzo', icon: 'üçΩÔ∏è' },
      { key: 'cena', time: '20:30', label: 'Cena', icon: 'üåô' }
    ];
    const dayMeals = (data.meals || []).filter(m => m.day_id === date);
    mealSlots.forEach(slot => {
      const meals = dayMeals.filter(m => m.meal_type === slot.key);
      if (meals.length > 0) {
        const cals = meals.reduce((s, m) => s + (m.calories || 0), 0);
        events.push({
          id: `meal-${date}-${slot.key}`, type: 'meal', title: `${slot.label} (${cals} kcal)`,
          time: slot.time, duration: 30, color: '#F59E0B', icon: slot.icon, completed: true
        });
      }
    });

    return events.sort((a, b) => a.time.localeCompare(b.time));
  };

  // ========== PENDING TASKS (without specific time) ==========
  const getPendingTasks = (date) => {
    const pending = [];

    // Work tasks WITHOUT time
    (data.workTasks || []).filter(t =>
      (t.dueDate === date || t.scheduledDate === date) && !t.scheduledTime && t.status !== 'done'
    ).forEach(task => {
      const project = (data.workProjects || []).find(p => p.id === task.project_id);
      pending.push({
        id: task.id, type: 'work', title: task.title,
        icon: 'üíº', color: project?.color || '#8B5CF6',
        priority: task.priority, project: project?.name
      });
    });

    // Daily tasks (from Today screen)
    (data.tasks || []).filter(t => t.day_id === date && !t.completed).forEach(task => {
      pending.push({
        id: task.id, type: 'daily', title: task.title,
        icon: 'üìã', color: '#6366F1'
      });
    });

    // Personal tasks for this date
    (data.personalTasks || []).filter(t => t.dueDate === date && !t.completed).forEach(task => {
      const catIcons = { casa: 'üè†', vehiculo: 'üöó', salud: 'üè•', tramites: 'üìã', compras: 'üõí', cuidado: 'üë§', gestiones: 'üìû' };
      pending.push({
        id: task.id, type: 'personal', title: task.title,
        icon: catIcons[task.category] || 'üìå', color: '#14B8A6',
        important: task.important
      });
    });

    // Habits WITHOUT time (not completed)
    (data.habits || []).forEach(habit => {
      if (!shouldDoHabitOnDay(habit, date)) return;
      if (habit.time) return; // Skip habits with time
      const log = (data.habitLogs || []).find(l => l.habit_id === habit.id && l.date === date);
      if (!log?.completed) {
        pending.push({
          id: habit.id, type: 'habit', title: habit.name,
          icon: habit.icon || '‚úÖ', color: '#10B981'
        });
      }
    });

    // Workout WITHOUT time (not completed)
    const workout = (data.workouts || []).find(w => w.day_id === date);
    if (workout && !workout.scheduledTime && !workout.is_completed) {
      pending.push({
        id: workout.id, type: 'workout', title: workout.name,
        icon: 'üí™', color: '#A855F7'
      });
    }

    return pending;
  };

  const toggleEvent = (event) => {
    if (event.type === 'task') {
      setData(prev => ({ ...prev, workTasks: prev.workTasks.map(t => t.id === event.sourceId ? { ...t, status: t.status === 'done' ? 'todo' : 'done', completedDate: t.status !== 'done' ? today : null } : t) }));
    } else if (event.type === 'habit') {
      const dateFromId = event.id.split('-').pop();
      const existingLog = data.habitLogs?.find(l => l.habit_id === event.sourceId && l.date === dateFromId);
      if (existingLog) {
        setData(prev => ({ ...prev, habitLogs: prev.habitLogs.map(l => l.id === existingLog.id ? { ...l, completed: !l.completed } : l) }));
      } else {
        setData(prev => ({ ...prev, habitLogs: [...(prev.habitLogs || []), { id: crypto.randomUUID(), habit_id: event.sourceId, date: dateFromId, completed: true }] }));
      }
    } else if (event.type === 'workout') {
      setData(prev => ({ ...prev, workouts: prev.workouts.map(w => w.id === event.sourceId ? { ...w, is_completed: !w.is_completed } : w) }));
    }
    showToast(event.completed ? 'Desmarcado' : '‚úì Completado');
  };

  const getEventStyle = (event) => {
    const [h, m] = event.time.split(':').map(Number);
    const startMinutes = (h - 6) * 60 + m;
    const top = (startMinutes / (17 * 60)) * 100;
    const height = Math.max((event.duration / (17 * 60)) * 100, 3.5);
    return { top: `${top}%`, height: `${height}%` };
  };

  const goWeek = (dir) => {
    const d = new Date(selectedDate);
    d.setDate(d.getDate() + dir * weekMode);
    setSelectedDate(d.toISOString().split('T')[0]);
  };

  // ========== WEEK VIEW ==========
  const renderWeekView = () => {
    const visibleDates = getVisibleDates(selectedDate, weekMode);
    const currentHour = new Date().getHours();
    const currentMinute = new Date().getMinutes();
    const nowPosition = ((currentHour - 6) * 60 + currentMinute) / (17 * 60) * 100;
    const periodPending = visibleDates.reduce((sum, date) => sum + getPendingTasks(date).length, 0);

    const getDayLabel = (date) => {
      const d = new Date(date + 'T12:00:00');
      const dayIdx = d.getDay() === 0 ? 6 : d.getDay() - 1;
      return weekMode === 7 ? dayLabels[dayIdx] : dayLabelsFull[dayIdx];
    };

    return (
      <div className="space-y-2">
        {/* Week navigation with mode toggle */}
        <div className="flex items-center justify-between mb-2">
          <button onClick={() => goWeek(-1)} className="p-2 hover:bg-white/10 rounded-xl"><ChevronLeft className="w-5 h-5" /></button>
          <div className="flex items-center gap-3">
            <p className="text-sm text-white/60">
              {new Date(visibleDates[0] + 'T12:00:00').toLocaleDateString('es-ES', { month: 'short', day: 'numeric' })} - {new Date(visibleDates[visibleDates.length - 1] + 'T12:00:00').toLocaleDateString('es-ES', { month: 'short', day: 'numeric' })}
            </p>
            {/* 4/7 toggle */}
            <div className="flex bg-white/10 rounded-lg p-0.5">
              <button onClick={() => setWeekMode(4)} className={`px-2 py-1 rounded text-[10px] font-medium transition-all ${weekMode === 4 ? 'bg-violet-500' : 'text-white/50'}`}>4d</button>
              <button onClick={() => setWeekMode(7)} className={`px-2 py-1 rounded text-[10px] font-medium transition-all ${weekMode === 7 ? 'bg-violet-500' : 'text-white/50'}`}>7d</button>
            </div>
          </div>
          <button onClick={() => goWeek(1)} className="p-2 hover:bg-white/10 rounded-xl"><ChevronRight className="w-5 h-5" /></button>
        </div>

        {/* Day headers with pending badges */}
        <div className="flex">
          <div className="w-10 flex-shrink-0" />
          {visibleDates.map((date) => {
            const d = new Date(date + 'T12:00:00');
            const isToday = date === today;
            const pendingCount = getPendingTasks(date).length;
            return (
              <button key={date} onClick={() => { setSelectedDate(date); setView('day'); }}
                className={`flex-1 text-center py-2 relative ${isToday ? 'bg-violet-500/20 rounded-t-xl' : 'hover:bg-white/5'}`}>
                <p className={`text-[10px] ${isToday ? 'text-violet-400' : 'text-white/40'}`}>{getDayLabel(date)}</p>
                <p className={`${weekMode === 4 ? 'text-xl' : 'text-lg'} font-bold ${isToday ? 'text-violet-400' : ''}`}>{d.getDate()}</p>
                {pendingCount > 0 && (
                  <div className={`absolute -top-1 -right-1 ${weekMode === 4 ? 'w-6 h-6 text-xs' : 'w-5 h-5 text-[10px]'} bg-amber-500 rounded-full font-bold text-black flex items-center justify-center`}>
                    {pendingCount}
                  </div>
                )}
              </button>
            );
          })}
        </div>

        {/* Timeline grid */}
        <div className="relative bg-zinc-900/50 rounded-xl overflow-hidden" style={{ height: '420px' }}>
          <div className="absolute inset-0 overflow-y-auto" style={{ scrollbarWidth: 'thin' }}>
            <div className="relative" style={{ height: `${hours.length * 50}px` }}>
              {hours.map((hour, idx) => (
                <div key={hour} className="absolute w-full flex" style={{ top: `${idx * 50}px`, height: '50px' }}>
                  <div className="w-10 flex-shrink-0 text-[10px] text-white/30 text-right pr-2 -mt-2">{hour}:00</div>
                  <div className="flex-1 border-t border-white/5" />
                </div>
              ))}

              {visibleDates.includes(today) && nowPosition >= 0 && nowPosition <= 100 && (
                <div className="absolute left-10 right-0 flex items-center z-20" style={{ top: `${nowPosition}%` }}>
                  <div className="w-2 h-2 rounded-full bg-red-500" />
                  <div className="flex-1 h-0.5 bg-red-500" />
                </div>
              )}

              <div className="absolute left-10 right-0 top-0 bottom-0 flex">
                {visibleDates.map((date) => {
                  const events = getScheduledEvents(date);
                  const isToday = date === today;
                  return (
                    <div key={date} className={`flex-1 relative border-l border-white/5 ${isToday ? 'bg-violet-500/5' : ''}`}>
                      {events.map(event => (
                        <button key={event.id} onClick={() => setShowEventDetail(event)}
                          className={`absolute left-0.5 right-0.5 rounded-md px-1 py-0.5 text-left overflow-hidden transition-all hover:opacity-90 ${event.completed ? 'opacity-50' : ''}`}
                          style={{ ...getEventStyle(event), backgroundColor: event.color + '40', borderLeft: `3px solid ${event.color}` }}>
                          <p className={`${weekMode === 4 ? 'text-[10px]' : 'text-[9px]'} font-medium truncate ${event.completed ? 'line-through' : ''}`}>{event.icon} {event.title}</p>
                          <p className={`${weekMode === 4 ? 'text-[9px]' : 'text-[8px]'} text-white/50`}>{event.time}</p>
                        </button>
                      ))}
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        </div>

        {/* Pending summary */}
        {periodPending > 0 && (
          <button onClick={() => setShowPendingPanel(true)}
            className="w-full bg-amber-500/10 border border-amber-500/30 rounded-xl p-3 flex items-center justify-between hover:bg-amber-500/20 transition-colors">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 bg-amber-500 rounded-xl flex items-center justify-center text-black font-bold text-lg">
                {periodPending}
              </div>
              <div className="text-left">
                <p className="text-sm font-medium">Pendientes sin hora</p>
                <p className="text-xs text-white/50">Tareas flexibles ({weekMode === 7 ? 'semana' : '4 d√≠as'})</p>
              </div>
            </div>
            <ChevronRight className="w-5 h-5 text-amber-400" />
          </button>
        )}
      </div>
    );
  };

  // ========== DAY VIEW ==========
  const renderDayView = () => {
    const events = getScheduledEvents(selectedDate);
    const pending = getPendingTasks(selectedDate);
    const dateInfo = new Date(selectedDate + 'T12:00:00');
    const dayName = dateInfo.toLocaleDateString('es-ES', { weekday: 'long' });
    const isToday = selectedDate === today;
    const currentHour = new Date().getHours();
    const currentMinute = new Date().getMinutes();
    const nowPosition = ((currentHour - 6) * 60 + currentMinute) / (17 * 60) * 100;

    return (
      <div className="space-y-3">
        {/* Date header */}
        <div className="flex items-center justify-between">
          <button onClick={() => setSelectedDate(getDateOffset(selectedDate, -1))} className="p-2 hover:bg-white/10 rounded-xl"><ChevronLeft className="w-5 h-5" /></button>
          <button onClick={() => setSelectedDate(today)} className="text-center">
            <p className="text-3xl font-bold">{dateInfo.getDate()}</p>
            <p className="text-sm text-white/60 capitalize">{dayName}</p>
            {isToday && <span className="text-[10px] text-violet-400 font-medium">HOY</span>}
          </button>
          <button onClick={() => setSelectedDate(getDateOffset(selectedDate, 1))} className="p-2 hover:bg-white/10 rounded-xl"><ChevronRight className="w-5 h-5" /></button>
        </div>

        {/* Pending tasks panel (flexible/no time) */}
        {pending.length > 0 && (
          <div className="bg-amber-500/10 border border-amber-500/30 rounded-xl p-3">
            <div className="flex items-center justify-between mb-2">
              <div className="flex items-center gap-2">
                <div className="w-7 h-7 bg-amber-500 rounded-lg flex items-center justify-center text-black font-bold text-sm">
                  {pending.length}
                </div>
                <span className="text-sm font-medium text-amber-200">Pendiente (flexible)</span>
              </div>
            </div>
            <div className="space-y-1.5">
              {pending.slice(0, 4).map(task => (
                <div key={`${task.type}-${task.id}`} className="flex items-center gap-2 bg-black/20 rounded-lg px-2 py-1.5">
                  <span className="text-sm">{task.icon}</span>
                  <span className="text-sm flex-1 truncate">{task.title}</span>
                  {task.priority === 'high' && <span className="text-red-400 text-xs font-bold">!</span>}
                </div>
              ))}
              {pending.length > 4 && (
                <p className="text-xs text-amber-400/70 text-center">+{pending.length - 4} m√°s</p>
              )}
            </div>
          </div>
        )}

        {/* Timeline (scheduled events only) */}
        <div className="relative bg-zinc-900/50 rounded-xl overflow-hidden" style={{ height: pending.length > 0 ? '320px' : '400px' }}>
          <div className="absolute inset-0 overflow-y-auto" style={{ scrollbarWidth: 'thin' }}>
            <div className="relative" style={{ height: `${hours.length * 50}px` }}>
              {hours.map((hour, idx) => (
                <div key={hour} className="absolute w-full flex items-start" style={{ top: `${idx * 50}px`, height: '50px' }}>
                  <div className="w-12 flex-shrink-0 text-xs text-white/30 text-right pr-2 -mt-2">{hour}:00</div>
                  <div className="flex-1 border-t border-white/10" />
                </div>
              ))}

              {isToday && nowPosition >= 0 && nowPosition <= 100 && (
                <div className="absolute left-12 right-0 flex items-center z-20" style={{ top: `${nowPosition}%` }}>
                  <div className="w-3 h-3 rounded-full bg-red-500 -ml-1.5" />
                  <div className="flex-1 h-0.5 bg-red-500" />
                </div>
              )}

              <div className="absolute left-14 right-2 top-0 bottom-0">
                {events.length > 0 ? events.map(event => (
                  <button key={event.id} onClick={() => setShowEventDetail(event)}
                    className={`absolute left-0 right-0 rounded-lg px-3 py-2 text-left overflow-hidden transition-all hover:scale-[1.02] ${event.completed ? 'opacity-50' : ''}`}
                    style={{ ...getEventStyle(event), backgroundColor: event.color + '30', borderLeft: `4px solid ${event.color}`, minHeight: '40px' }}>
                    <div className="flex items-center gap-2">
                      <span className="text-lg">{event.icon}</span>
                      <div className="flex-1 min-w-0">
                        <p className={`text-sm font-medium truncate ${event.completed ? 'line-through' : ''}`}>{event.title}</p>
                        <p className="text-[10px] text-white/50">{event.time} ¬∑ {event.duration}min</p>
                      </div>
                      {event.completed && <Check className="w-4 h-4 text-emerald-400" />}
                    </div>
                  </button>
                )) : (
                  <div className="absolute inset-0 flex items-center justify-center">
                    <p className="text-white/30 text-sm">Sin eventos programados</p>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>

        <button onClick={() => setShowAddModal(true)} className="w-full py-3 bg-violet-500/20 rounded-xl text-violet-400 font-medium flex items-center justify-center gap-2">
          <Plus className="w-5 h-5" /> A√±adir evento
        </button>
      </div>
    );
  };

  // ========== PENDING PANEL (slide from right) ==========
  const renderPendingPanel = () => {
    if (!showPendingPanel) return null;

    const visibleDates = getVisibleDates(selectedDate, weekMode);
    const byDate = visibleDates.map(date => ({
      date,
      label: new Date(date + 'T12:00:00').toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' }),
      isToday: date === today,
      tasks: getPendingTasks(date)
    })).filter(d => d.tasks.length > 0);

    return (
      <div className="fixed inset-0 bg-black/80 z-50" onClick={() => setShowPendingPanel(false)}>
        <div className="absolute right-0 top-0 bottom-0 w-80 bg-zinc-900 overflow-y-auto" onClick={e => e.stopPropagation()}>
          <div className="sticky top-0 bg-zinc-900 p-4 border-b border-white/10 flex items-center justify-between">
            <h3 className="font-bold">üìã Pendientes sin hora</h3>
            <button onClick={() => setShowPendingPanel(false)} className="p-1"><X className="w-5 h-5" /></button>
          </div>

          <div className="p-4 space-y-4">
            {byDate.map(day => (
              <div key={day.date}>
                <div className={`flex items-center gap-2 mb-2 ${day.isToday ? 'text-violet-400' : 'text-white/60'}`}>
                  <span className="text-sm font-medium capitalize">{day.label}</span>
                  <span className="bg-amber-500 text-black text-xs font-bold px-1.5 py-0.5 rounded-full">{day.tasks.length}</span>
                </div>
                <div className="space-y-1.5">
                  {day.tasks.map(task => (
                    <div key={`${task.type}-${task.id}`}
                      className="flex items-center gap-2 bg-white/5 rounded-lg px-3 py-2"
                      style={{ borderLeft: `3px solid ${task.color}` }}>
                      <span>{task.icon}</span>
                      <div className="flex-1 min-w-0">
                        <p className="text-sm truncate">{task.title}</p>
                        {task.project && <p className="text-[10px] text-white/40">{task.project}</p>}
                      </div>
                      {task.priority === 'high' && <span className="text-red-400 text-xs font-bold">!</span>}
                    </div>
                  ))}
                </div>
              </div>
            ))}

            {byDate.length === 0 && (
              <div className="text-center py-8 text-white/40">
                <p>‚ú® Todo programado</p>
              </div>
            )}
          </div>
        </div>
      </div>
    );
  };

  // ========== MONTH VIEW ==========
  const renderMonthView = () => {
    const year = new Date(selectedDate).getFullYear();
    const month = new Date(selectedDate).getMonth();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const firstDay = new Date(year, month, 1).getDay();
    const firstDayMon = firstDay === 0 ? 6 : firstDay - 1;

    const goMonth = (dir) => {
      const d = new Date(selectedDate);
      d.setMonth(d.getMonth() + dir);
      setSelectedDate(d.toISOString().split('T')[0]);
    };

    // Calculate month stats
    let totalScheduled = 0, totalPending = 0, totalWorkouts = 0, completedWorkouts = 0;
    let totalHabits = 0, completedHabits = 0, totalTasksDone = 0;
    const upcomingDeadlines = [];

    for (let d = 1; d <= daysInMonth; d++) {
      const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
      totalScheduled += getScheduledEvents(dateStr).length;
      totalPending += getPendingTasks(dateStr).length;

      const workout = (data.workouts || []).find(w => w.day_id === dateStr);
      if (workout) {
        totalWorkouts++;
        if (workout.is_completed) completedWorkouts++;
      }

      // Habits for this day
      (data.habits || []).forEach(habit => {
        if (shouldDoHabitOnDay(habit, dateStr)) {
          totalHabits++;
          const log = (data.habitLogs || []).find(l => l.habit_id === habit.id && l.date === dateStr);
          if (log?.completed) completedHabits++;
        }
      });

      // Completed tasks
      (data.workTasks || []).forEach(task => {
        if (task.status === 'done' && task.completedDate === dateStr) totalTasksDone++;
        // Upcoming deadlines
        if (task.dueDate === dateStr && task.status !== 'done' && dateStr >= today) {
          const project = (data.workProjects || []).find(p => p.id === task.project_id);
          upcomingDeadlines.push({ ...task, project, dateStr });
        }
      });
    }

    // Get weeks in month for mini view
    const weeksInMonth = Math.ceil((firstDayMon + daysInMonth) / 7);

    return (
      <div className="space-y-4">
        {/* Month navigation */}
        <div className="flex items-center justify-between">
          <button onClick={() => goMonth(-1)} className="p-2 hover:bg-white/10 rounded-xl"><ChevronLeft className="w-5 h-5" /></button>
          <div className="text-center">
            <p className="text-2xl font-bold">{monthNames[month]}</p>
            <p className="text-sm text-white/50">{year}</p>
          </div>
          <button onClick={() => goMonth(1)} className="p-2 hover:bg-white/10 rounded-xl"><ChevronRight className="w-5 h-5" /></button>
        </div>

        {/* Week headers */}
        <div className="grid grid-cols-7 gap-1 text-center">
          {dayLabels.map(d => <div key={d} className="text-xs text-white/40 py-1 font-medium">{d}</div>)}
        </div>

        {/* Days grid with more info */}
        <div className="grid grid-cols-7 gap-1">
          {Array.from({ length: firstDayMon }, (_, i) => <div key={`e-${i}`} className="aspect-square" />)}
          {Array.from({ length: daysInMonth }, (_, i) => {
            const day = i + 1;
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const isToday = dateStr === today;
            const isPast = dateStr < today;
            const scheduled = getScheduledEvents(dateStr);
            const pending = getPendingTasks(dateStr);
            const workout = (data.workouts || []).find(w => w.day_id === dateStr);
            const hasDeadline = (data.workTasks || []).some(t => t.dueDate === dateStr && t.status !== 'done');

            return (
              <button key={day} onClick={() => { setSelectedDate(dateStr); setView('day'); }}
                className={`aspect-square rounded-lg flex flex-col items-center justify-center text-xs relative transition-all
                  ${isToday ? 'bg-violet-500 ring-2 ring-violet-400 ring-offset-1 ring-offset-zinc-900' : ''}
                  ${isPast && !isToday ? 'text-white/30 bg-white/5' : ''}
                  ${!isPast && !isToday ? 'bg-white/5 hover:bg-white/10' : ''}`}>
                <span className={`font-semibold ${isToday ? 'text-white' : ''}`}>{day}</span>
                <div className="flex gap-0.5 mt-0.5 flex-wrap justify-center max-w-full">
                  {scheduled.length > 0 && <div className="w-1 h-1 rounded-full bg-violet-400" />}
                  {pending.length > 0 && <div className="w-1 h-1 rounded-full bg-amber-400" />}
                  {workout && <div className={`w-1 h-1 rounded-full ${workout.is_completed ? 'bg-emerald-400' : 'bg-purple-400'}`} />}
                  {hasDeadline && <div className="w-1 h-1 rounded-full bg-red-400" />}
                </div>
              </button>
            );
          })}
        </div>

        {/* Legend */}
        <div className="flex flex-wrap justify-center gap-3 text-[10px] text-white/50">
          <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-violet-400" /><span>Prog.</span></div>
          <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-amber-400" /><span>Pend.</span></div>
          <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-purple-400" /><span>Entreno</span></div>
          <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-red-400" /><span>Deadline</span></div>
        </div>

        {/* Upcoming Deadlines this month */}
        {upcomingDeadlines.length > 0 && (
          <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-3">
            <p className="text-xs font-medium text-red-400 mb-2">üéØ Deadlines este mes ({upcomingDeadlines.length})</p>
            <div className="space-y-1.5 max-h-24 overflow-y-auto">
              {upcomingDeadlines.slice(0, 5).map(task => (
                <div key={task.id} className="flex items-center gap-2 text-xs">
                  <span className="text-white/40">{new Date(task.dueDate + 'T12:00:00').getDate()}</span>
                  <span className="truncate flex-1">{task.title}</span>
                  {task.project && <span className="text-white/30 text-[10px]">{task.project.icon}</span>}
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Month Stats Grid */}
        <div className="grid grid-cols-2 gap-2">
          <div className="bg-white/5 rounded-xl p-3">
            <div className="flex items-center justify-between mb-2">
              <span className="text-xs text-white/50">Entrenos</span>
              <span className="text-lg font-bold text-purple-400">{completedWorkouts}/{totalWorkouts}</span>
            </div>
            <div className="h-1.5 bg-white/10 rounded-full overflow-hidden">
              <div className="h-full bg-purple-400 rounded-full" style={{ width: `${totalWorkouts ? (completedWorkouts / totalWorkouts) * 100 : 0}%` }} />
            </div>
          </div>

          <div className="bg-white/5 rounded-xl p-3">
            <div className="flex items-center justify-between mb-2">
              <span className="text-xs text-white/50">H√°bitos</span>
              <span className="text-lg font-bold text-emerald-400">{completedHabits}/{totalHabits}</span>
            </div>
            <div className="h-1.5 bg-white/10 rounded-full overflow-hidden">
              <div className="h-full bg-emerald-400 rounded-full" style={{ width: `${totalHabits ? (completedHabits / totalHabits) * 100 : 0}%` }} />
            </div>
          </div>

          <div className="bg-white/5 rounded-xl p-3">
            <div className="flex items-center justify-between mb-2">
              <span className="text-xs text-white/50">Tareas completadas</span>
              <span className="text-lg font-bold text-violet-400">{totalTasksDone}</span>
            </div>
          </div>

          <div className="bg-white/5 rounded-xl p-3">
            <div className="flex items-center justify-between mb-2">
              <span className="text-xs text-white/50">Pendientes</span>
              <span className="text-lg font-bold text-amber-400">{totalPending}</span>
            </div>
          </div>
        </div>

        {/* Week navigator */}
        <div className="flex items-center justify-center gap-2 pt-2">
          {Array.from({ length: weeksInMonth }, (_, i) => {
            const weekStart = i * 7 - firstDayMon + 1;
            const weekEnd = Math.min(weekStart + 6, daysInMonth);
            const validStart = Math.max(1, weekStart);
            return (
              <button key={i} onClick={() => {
                const midDay = Math.floor((validStart + weekEnd) / 2);
                setSelectedDate(`${year}-${String(month + 1).padStart(2, '0')}-${String(midDay).padStart(2, '0')}`);
                setView('week');
              }}
                className="px-3 py-1.5 bg-white/5 hover:bg-white/10 rounded-lg text-xs">
                Sem {i + 1}
              </button>
            );
          })}
        </div>
      </div>
    );
  };

  // ========== QUARTER VIEW ==========
  const renderQuarterView = () => {
    const year = new Date(selectedDate).getFullYear();
    const currentQuarter = Math.floor(new Date(selectedDate).getMonth() / 3) + 1;
    const quarterStart = new Date(year, (currentQuarter - 1) * 3, 1);
    const quarterEnd = new Date(year, currentQuarter * 3, 0);

    // Get quarter days for stats
    const quarterDays = [];
    let d = new Date(quarterStart);
    while (d <= quarterEnd) {
      quarterDays.push(d.toISOString().split('T')[0]);
      d.setDate(d.getDate() + 1);
    }

    // Comprehensive stats
    const totalWorkouts = (data.workouts || []).filter(w => quarterDays.includes(w.day_id)).length;
    const quarterWorkouts = (data.workouts || []).filter(w => quarterDays.includes(w.day_id) && w.is_completed).length;
    const quarterTasksDone = (data.workTasks || []).filter(t => t.status === 'done' && quarterDays.includes(t.completedDate)).length;
    const activeProjects = (data.workProjects || []).filter(p => p.status === 'active');

    // Habits stats
    let totalHabits = 0, completedHabits = 0;
    quarterDays.forEach(dateStr => {
      (data.habits || []).forEach(habit => {
        if (shouldDoHabitOnDay(habit, dateStr)) {
          totalHabits++;
          const log = (data.habitLogs || []).find(l => l.habit_id === habit.id && l.date === dateStr);
          if (log?.completed) completedHabits++;
        }
      });
    });

    // Upcoming deadlines in quarter
    const upcomingDeadlines = (data.workTasks || [])
      .filter(t => t.dueDate && quarterDays.includes(t.dueDate) && t.dueDate >= today && t.status !== 'done')
      .sort((a, b) => a.dueDate.localeCompare(b.dueDate))
      .slice(0, 5);

    // Quarter progress
    const now = new Date();
    const quarterProgress = Math.max(0, Math.min(100, Math.round((now - quarterStart) / (quarterEnd - quarterStart) * 100)));

    const goQuarter = (dir) => {
      const newQ = currentQuarter + dir;
      if (newQ < 1) setSelectedDate(`${year - 1}-11-15`);
      else if (newQ > 4) setSelectedDate(`${year + 1}-02-15`);
      else setSelectedDate(`${year}-${String((newQ - 1) * 3 + 2).padStart(2, '0')}-15`);
    };

    // Mini calendar renderer
    const renderMiniMonth = (monthOffset) => {
      const monthNum = (currentQuarter - 1) * 3 + monthOffset;
      const monthYear = year;
      const daysInMonth = new Date(monthYear, monthNum + 1, 0).getDate();
      const firstDay = new Date(monthYear, monthNum, 1).getDay();
      const firstDayMon = firstDay === 0 ? 6 : firstDay - 1;
      const isCurrentMonth = monthNum === new Date().getMonth() && monthYear === new Date().getFullYear();

      return (
        <div key={monthOffset} className={`bg-white/5 rounded-xl p-2 ${isCurrentMonth ? 'ring-1 ring-violet-500' : ''}`}>
          <button onClick={() => { setSelectedDate(`${monthYear}-${String(monthNum + 1).padStart(2, '0')}-15`); setView('month'); }}
            className={`w-full text-center mb-1 font-medium text-sm hover:text-violet-400 ${isCurrentMonth ? 'text-violet-400' : ''}`}>
            {monthNamesShort[monthNum]}
          </button>
          <div className="grid grid-cols-7 gap-px">
            {['L', 'M', 'X', 'J', 'V', 'S', 'D'].map(l => (
              <div key={l} className="text-[7px] text-white/30 text-center">{l}</div>
            ))}
            {Array.from({ length: firstDayMon }, (_, i) => <div key={`e-${i}`} className="aspect-square" />)}
            {Array.from({ length: daysInMonth }, (_, i) => {
              const day = i + 1;
              const dateStr = `${monthYear}-${String(monthNum + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
              const isToday = dateStr === today;
              const hasEvent = getScheduledEvents(dateStr).length > 0 || getPendingTasks(dateStr).length > 0;
              const hasWorkout = (data.workouts || []).some(w => w.day_id === dateStr);
              const hasDeadline = (data.workTasks || []).some(t => t.dueDate === dateStr && t.status !== 'done');

              return (
                <button key={day} onClick={() => { setSelectedDate(dateStr); setView('day'); }}
                  className={`aspect-square flex items-center justify-center text-[8px] rounded-sm transition-all
                    ${isToday ? 'bg-violet-500 text-white font-bold' : ''}
                    ${hasDeadline && !isToday ? 'bg-red-500/30' : ''}
                    ${hasWorkout && !isToday && !hasDeadline ? 'bg-purple-500/20' : ''}
                    ${hasEvent && !isToday && !hasDeadline && !hasWorkout ? 'bg-white/10' : ''}
                    ${!isToday ? 'hover:bg-white/20' : ''}`}>
                  {day}
                </button>
              );
            })}
          </div>
        </div>
      );
    };

    return (
      <div className="space-y-4">
        {/* Quarter header */}
        <div className="flex items-center justify-between">
          <button onClick={() => goQuarter(-1)} className="p-2 hover:bg-white/10 rounded-xl"><ChevronLeft className="w-5 h-5" /></button>
          <div className="text-center">
            <p className="text-3xl font-bold">Q{currentQuarter}</p>
            <p className="text-sm text-white/50">{monthNamesShort[(currentQuarter - 1) * 3]} - {monthNamesShort[currentQuarter * 3 - 1]} {year}</p>
          </div>
          <button onClick={() => goQuarter(1)} className="p-2 hover:bg-white/10 rounded-xl"><ChevronRight className="w-5 h-5" /></button>
        </div>

        {/* Quarter selector */}
        <div className="flex justify-center gap-2">
          {[1, 2, 3, 4].map(q => (
            <button key={q} onClick={() => setSelectedDate(`${year}-${String((q - 1) * 3 + 2).padStart(2, '0')}-15`)}
              className={`w-11 h-11 rounded-xl font-bold text-lg transition-all ${q === currentQuarter ? 'bg-violet-500' : 'bg-white/10 hover:bg-white/20'}`}>
              Q{q}
            </button>
          ))}
        </div>

        {/* Progress bar */}
        <div>
          <div className="flex justify-between text-xs text-white/50 mb-1">
            <span>{monthNamesShort[(currentQuarter - 1) * 3]}</span>
            <span className="font-medium">{quarterProgress}%</span>
            <span>{monthNamesShort[currentQuarter * 3 - 1]}</span>
          </div>
          <div className="bg-white/10 rounded-full h-2.5 overflow-hidden">
            <div className="h-full bg-gradient-to-r from-violet-500 to-fuchsia-500 rounded-full transition-all" style={{ width: `${quarterProgress}%` }} />
          </div>
        </div>

        {/* Mini calendars */}
        <div className="grid grid-cols-3 gap-2">
          {[0, 1, 2].map(renderMiniMonth)}
        </div>

        {/* Upcoming Deadlines */}
        {upcomingDeadlines.length > 0 && (
          <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-3">
            <p className="text-xs font-medium text-red-400 mb-2 flex items-center gap-2">
              <AlertCircle className="w-3.5 h-3.5" /> Pr√≥ximos Deadlines
            </p>
            <div className="space-y-1.5">
              {upcomingDeadlines.map(task => {
                const project = (data.workProjects || []).find(p => p.id === task.project_id);
                const daysUntil = Math.ceil((new Date(task.dueDate) - new Date(today)) / (1000 * 60 * 60 * 24));
                return (
                  <div key={task.id} className="flex items-center gap-2 text-xs">
                    <span className={`font-medium ${daysUntil <= 3 ? 'text-red-400' : daysUntil <= 7 ? 'text-amber-400' : 'text-white/60'}`}>
                      {daysUntil === 0 ? 'HOY' : daysUntil === 1 ? 'Ma√±ana' : `${daysUntil}d`}
                    </span>
                    <span className="truncate flex-1">{task.title}</span>
                    {project && <span style={{ color: project.color }}>{project.icon}</span>}
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {/* Quarter Stats Grid */}
        <div className="grid grid-cols-2 gap-2">
          <div className="bg-white/5 rounded-xl p-3">
            <div className="flex items-center justify-between mb-2">
              <span className="text-xs text-white/50">üí™ Entrenos</span>
              <span className="text-lg font-bold text-purple-400">{quarterWorkouts}/{totalWorkouts}</span>
            </div>
            <div className="h-1.5 bg-white/10 rounded-full overflow-hidden">
              <div className="h-full bg-purple-400 rounded-full" style={{ width: `${totalWorkouts ? (quarterWorkouts / totalWorkouts) * 100 : 0}%` }} />
            </div>
          </div>

          <div className="bg-white/5 rounded-xl p-3">
            <div className="flex items-center justify-between mb-2">
              <span className="text-xs text-white/50">‚úÖ H√°bitos</span>
              <span className="text-lg font-bold text-emerald-400">{Math.round(totalHabits ? (completedHabits / totalHabits) * 100 : 0)}%</span>
            </div>
            <div className="h-1.5 bg-white/10 rounded-full overflow-hidden">
              <div className="h-full bg-emerald-400 rounded-full" style={{ width: `${totalHabits ? (completedHabits / totalHabits) * 100 : 0}%` }} />
            </div>
          </div>

          <div className="bg-white/5 rounded-xl p-3">
            <div className="flex items-center justify-between">
              <span className="text-xs text-white/50">üìã Tareas done</span>
              <span className="text-xl font-bold text-violet-400">{quarterTasksDone}</span>
            </div>
          </div>

          <div className="bg-white/5 rounded-xl p-3">
            <div className="flex items-center justify-between">
              <span className="text-xs text-white/50">üìÅ Proyectos</span>
              <span className="text-xl font-bold text-orange-400">{activeProjects.length}</span>
            </div>
          </div>
        </div>

        {/* Active Projects */}
        {activeProjects.length > 0 && (
          <div>
            <h4 className="text-xs font-semibold text-white/50 mb-2 uppercase tracking-wide">Proyectos Activos</h4>
            <div className="space-y-2">
              {activeProjects.slice(0, 4).map(project => {
                const projectTasks = (data.workTasks || []).filter(t => t.project_id === project.id);
                const done = projectTasks.filter(t => t.status === 'done').length;
                const progress = projectTasks.length > 0 ? Math.round((done / projectTasks.length) * 100) : 0;
                const nextDeadline = projectTasks.filter(t => t.dueDate && t.status !== 'done').sort((a, b) => a.dueDate.localeCompare(b.dueDate))[0];

                return (
                  <button key={project.id} onClick={() => setScreen('work')} className="w-full bg-white/5 rounded-xl p-3 text-left hover:bg-white/10 transition-all">
                    <div className="flex items-center justify-between mb-1.5">
                      <span className="font-medium text-sm">{project.icon} {project.name}</span>
                      <span className="text-sm font-bold" style={{ color: project.color || '#8B5CF6' }}>{progress}%</span>
                    </div>
                    <div className="h-1.5 bg-white/10 rounded-full overflow-hidden mb-1.5">
                      <div className="h-full rounded-full transition-all" style={{ width: `${progress}%`, backgroundColor: project.color || '#8B5CF6' }} />
                    </div>
                    <div className="flex items-center justify-between text-[10px] text-white/40">
                      <span>{done}/{projectTasks.length} tareas</span>
                      {nextDeadline && <span className="text-amber-400">üìÖ {new Date(nextDeadline.dueDate + 'T12:00:00').toLocaleDateString('es-ES', { day: 'numeric', month: 'short' })}</span>}
                    </div>
                  </button>
                );
              })}
            </div>
          </div>
        )}

        {/* Goals if any */}
        {data.goals?.length > 0 && (
          <div>
            <h4 className="text-xs font-semibold text-white/50 mb-2 uppercase tracking-wide">Objetivos Q{currentQuarter}</h4>
            <div className="space-y-1.5">
              {data.goals.slice(0, 4).map(goal => (
                <div key={goal.id} className="bg-white/5 rounded-xl p-2.5 flex items-center justify-between">
                  <span className="text-sm">{goal.icon || 'üéØ'} {goal.name || goal.title}</span>
                  <span className={`text-xs px-2 py-0.5 rounded-full font-medium ${(goal.progress || 0) >= 100 ? 'bg-emerald-500/20 text-emerald-400' :
                    (goal.progress || 0) >= 50 ? 'bg-amber-500/20 text-amber-400' : 'bg-white/10'
                    }`}>{goal.progress || 0}%</span>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    );
  };

  // ========== EVENT DETAIL ==========
  const renderEventDetail = () => {
    if (!showEventDetail) return null;
    const e = showEventDetail;
    return (
      <div className="fixed inset-0 bg-black/80 z-50 flex items-end" onClick={() => setShowEventDetail(null)}>
        <div className="bg-zinc-900 rounded-t-3xl w-full p-4" onClick={ev => ev.stopPropagation()}>
          <div className="flex items-center gap-3 mb-4">
            <div className="w-12 h-12 rounded-xl flex items-center justify-center text-2xl" style={{ backgroundColor: e.color + '30' }}>{e.icon}</div>
            <div className="flex-1"><h3 className="font-bold text-lg">{e.title}</h3><p className="text-sm text-white/50">{e.time} ¬∑ {e.duration}min</p></div>
            <button onClick={() => setShowEventDetail(null)} className="p-2"><X className="w-5 h-5" /></button>
          </div>
          <button onClick={() => { toggleEvent(e); setShowEventDetail({ ...e, completed: !e.completed }); }}
            className={`w-full py-3 rounded-xl font-medium mb-3 ${e.completed ? 'bg-emerald-500' : 'bg-white/10'}`}>
            {e.completed ? '‚úì Completado' : 'Marcar como completado'}
          </button>
          <button onClick={() => { setShowEventDetail(null); setScreen(e.type === 'task' ? 'work' : e.type === 'habit' ? 'habits' : e.type === 'workout' ? 'workout' : 'meals'); }}
            className="w-full py-2 text-sm text-white/50">Ir a {e.type === 'task' ? 'Trabajo' : e.type === 'habit' ? 'H√°bitos' : e.type === 'workout' ? 'Entreno' : 'Nutrici√≥n'} ‚Üí</button>
        </div>
      </div>
    );
  };

  // ========== ADD MODAL ==========
  const renderAddModal = () => {
    if (!showAddModal) return null;
    return (
      <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4" onClick={() => setShowAddModal(false)}>
        <div className="bg-zinc-900 rounded-2xl w-full max-w-sm" onClick={ev => ev.stopPropagation()}>
          <div className="p-4 border-b border-white/10 text-center font-bold">A√±adir evento</div>
          <div className="p-4 grid grid-cols-2 gap-3">
            {[
              { icon: 'üíº', label: 'Tarea trabajo', screen: 'work' },
              { icon: 'üí™', label: 'Entreno', screen: 'workout' },
              { icon: 'üçΩÔ∏è', label: 'Comida', screen: 'meals' },
              { icon: '‚úÖ', label: 'H√°bito', screen: 'habits' },
              { icon: 'üìå', label: 'Personal', screen: 'personal' },
              { icon: 'üìã', label: 'Tarea d√≠a', screen: 'today' }
            ].map(opt => (
              <button key={opt.screen} onClick={() => { setShowAddModal(false); setScreen(opt.screen); }}
                className="p-4 bg-white/5 rounded-xl text-center hover:bg-white/10">
                <span className="text-2xl">{opt.icon}</span>
                <p className="text-sm mt-1">{opt.label}</p>
              </button>
            ))}
          </div>
        </div>
      </div>
    );
  };

  return (
    <div className="pb-24">
      <AnimatedMount>
        <div className="flex items-center justify-between mb-4">
          <h1 className="text-2xl font-bold">Calendario</h1>
          <div className="flex bg-white/10 rounded-xl p-1">
            <button onClick={() => setView('day')} className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${view === 'day' ? 'bg-violet-500' : ''}`}>D√≠a</button>
            <button onClick={() => setView('week')} className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${view === 'week' ? 'bg-violet-500' : ''}`}>Sem</button>
            <button onClick={() => setView('month')} className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${view === 'month' ? 'bg-violet-500' : ''}`}>Mes</button>
            <button onClick={() => setView('quarter')} className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${view === 'quarter' ? 'bg-violet-500' : ''}`}>Q</button>
          </div>
        </div>
      </AnimatedMount>

      <AnimatedMount delay={50}>
        {view === 'day' && renderDayView()}
        {view === 'week' && renderWeekView()}
        {view === 'month' && renderMonthView()}
        {view === 'quarter' && renderQuarterView()}
      </AnimatedMount>

      {renderEventDetail()}
      {renderAddModal()}
      {renderPendingPanel()}
    </div>
  );
};

// ============================================================================
// GOALS SCREEN - Annual, Quarterly, Monthly Goals (inside Control)
// ============================================================================

const GoalsScreen = ({ data, setData, showToast }) => {
  const today = getToday();
  const [goalsYear, setGoalsYear] = useState(new Date().getFullYear());
  const [selectedQuarter, setSelectedQuarter] = useState(Math.floor(new Date().getMonth() / 3));
  const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth());
  const [showAddModal, setShowAddModal] = useState(null); // 'yearly' | 'quarterly' | 'monthly'
  const [newGoal, setNewGoal] = useState({ title: '', description: '', keyResults: [] });
  const [krInput, setKrInput] = useState('');

  const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
  const quarterNames = ['T1', 'T2', 'T3', 'T4'];
  const goals = data.goals || { yearly: [], quarterly: [], monthly: [] };

  const addGoal = () => {
    if (!newGoal.title.trim()) return;
    const type = showAddModal;
    setData(prev => ({
      ...prev,
      goals: {
        ...prev.goals,
        [type]: [...(prev.goals?.[type] || []), {
          id: crypto.randomUUID(),
          title: newGoal.title.trim(),
          description: newGoal.description.trim(),
          year: goalsYear,
          quarter: type !== 'yearly' ? selectedQuarter : null,
          month: type === 'monthly' ? selectedMonth : null,
          progress: 0,
          keyResults: newGoal.keyResults,
          completed: false,
          createdAt: new Date().toISOString()
        }]
      }
    }));
    setShowAddModal(null);
    setNewGoal({ title: '', description: '', keyResults: [] });
    setKrInput('');
    showToast('üéØ Meta creada');
  };

  const updateProgress = (type, goalId, progress) => {
    setData(prev => ({
      ...prev,
      goals: {
        ...prev.goals,
        [type]: prev.goals[type].map(g => g.id === goalId ? { ...g, progress, completed: progress >= 100 } : g)
      }
    }));
  };

  const deleteGoal = (type, goalId) => {
    setData(prev => ({
      ...prev,
      goals: { ...prev.goals, [type]: prev.goals[type].filter(g => g.id !== goalId) }
    }));
    showToast('Meta eliminada');
  };

  const toggleKeyResult = (type, goalId, krIndex) => {
    setData(prev => ({
      ...prev,
      goals: {
        ...prev.goals,
        [type]: prev.goals[type].map(g => {
          if (g.id !== goalId) return g;
          const newKRs = g.keyResults.map((kr, i) => i === krIndex ? { ...kr, done: !kr.done } : kr);
          const doneCount = newKRs.filter(kr => kr.done).length;
          const newProgress = newKRs.length > 0 ? Math.round((doneCount / newKRs.length) * 100) : g.progress;
          return { ...g, keyResults: newKRs, progress: newProgress, completed: newProgress >= 100 };
        })
      }
    }));
  };

  const yearlyGoals = (goals.yearly || []).filter(g => g.year === goalsYear);
  const quarterlyGoals = (goals.quarterly || []).filter(g => g.year === goalsYear && g.quarter === selectedQuarter);
  const monthlyGoals = (goals.monthly || []).filter(g => g.year === goalsYear && g.month === selectedMonth);

  const GoalCard = ({ goal, type, gradient }) => (
    <Card className={`bg-gradient-to-r ${gradient} border-0`}>
      <div className="flex items-start gap-3">
        <div className="flex-1">
          <p className={`font-medium ${goal.completed ? 'line-through opacity-60' : ''}`}>{goal.title}</p>
          {goal.description && <p className="text-xs text-white/50 mt-1">{goal.description}</p>}
        </div>
        <div className="text-right">
          <p className="text-lg font-bold">{goal.progress}%</p>
          <button onClick={() => deleteGoal(type, goal.id)} className="text-xs text-red-400 mt-1">Eliminar</button>
        </div>
      </div>

      {/* Progress bar */}
      <div className="mt-3 h-2 bg-black/30 rounded-full overflow-hidden">
        <div className={`h-full transition-all ${goal.completed ? 'bg-emerald-400' : 'bg-white'}`} style={{ width: `${goal.progress}%` }} />
      </div>

      {/* Quick progress buttons */}
      <div className="flex gap-1 mt-2">
        {[0, 25, 50, 75, 100].map(p => (
          <button key={p} onClick={() => updateProgress(type, goal.id, p)}
            className={`flex-1 py-1 text-[10px] rounded transition-all ${goal.progress >= p ? 'bg-white/30' : 'bg-white/10'}`}>{p}%</button>
        ))}
      </div>

      {/* Key Results */}
      {goal.keyResults?.length > 0 && (
        <div className="mt-3 pt-3 border-t border-white/10">
          <p className="text-[10px] text-white/40 mb-2">RESULTADOS CLAVE</p>
          <div className="space-y-1.5">
            {goal.keyResults.map((kr, i) => (
              <button key={i} onClick={() => toggleKeyResult(type, goal.id, i)}
                className="w-full flex items-center gap-2 text-left">
                <div className={`w-4 h-4 rounded border flex items-center justify-center flex-shrink-0 ${kr.done ? 'bg-emerald-500 border-emerald-500' : 'border-white/30'}`}>
                  {kr.done && <Check className="w-3 h-3" />}
                </div>
                <span className={`text-sm ${kr.done ? 'line-through opacity-60' : ''}`}>{kr.text}</span>
              </button>
            ))}
          </div>
        </div>
      )}
    </Card>
  );

  const EmptyState = ({ type, onClick }) => (
    <button onClick={onClick} className="w-full py-8 border-2 border-dashed border-white/20 rounded-xl text-center hover:border-white/40 transition-all">
      <Plus className="w-8 h-8 mx-auto text-white/30 mb-2" />
      <p className="text-white/40">A√±adir meta {type}</p>
    </button>
  );

  return (
    <div className="space-y-6">
      {/* Year selector */}
      <div className="flex items-center justify-center gap-4">
        <button onClick={() => setGoalsYear(y => y - 1)} className="p-2 hover:bg-white/10 rounded-xl"><ChevronLeft className="w-5 h-5" /></button>
        <p className="text-3xl font-bold">{goalsYear}</p>
        <button onClick={() => setGoalsYear(y => y + 1)} className="p-2 hover:bg-white/10 rounded-xl"><ChevronRight className="w-5 h-5" /></button>
      </div>

      {/* Summary */}
      <Card className="bg-gradient-to-r from-amber-500/20 via-violet-500/20 to-emerald-500/20">
        <div className="grid grid-cols-3 gap-4 text-center">
          <div>
            <p className="text-2xl font-bold text-amber-400">{yearlyGoals.filter(g => g.completed).length}/{yearlyGoals.length}</p>
            <p className="text-[10px] text-white/40">Anuales</p>
          </div>
          <div>
            <p className="text-2xl font-bold text-violet-400">{(goals.quarterly || []).filter(g => g.year === goalsYear && g.completed).length}/{(goals.quarterly || []).filter(g => g.year === goalsYear).length}</p>
            <p className="text-[10px] text-white/40">Trimestrales</p>
          </div>
          <div>
            <p className="text-2xl font-bold text-emerald-400">{(goals.monthly || []).filter(g => g.year === goalsYear && g.completed).length}/{(goals.monthly || []).filter(g => g.year === goalsYear).length}</p>
            <p className="text-[10px] text-white/40">Mensuales</p>
          </div>
        </div>
      </Card>

      {/* Yearly Goals */}
      <div>
        <div className="flex items-center justify-between mb-3">
          <h3 className="text-lg font-bold text-amber-400">üéØ Metas Anuales</h3>
          <button onClick={() => setShowAddModal('yearly')} className="text-sm text-violet-400">+ A√±adir</button>
        </div>
        {yearlyGoals.length > 0 ? (
          <div className="space-y-3">{yearlyGoals.map(g => <GoalCard key={g.id} goal={g} type="yearly" gradient="from-amber-500/20 to-orange-500/20" />)}</div>
        ) : (
          <EmptyState type="anual" onClick={() => setShowAddModal('yearly')} />
        )}
      </div>

      {/* Quarterly Goals */}
      <div>
        <div className="flex items-center justify-between mb-3">
          <div className="flex items-center gap-3">
            <h3 className="text-lg font-bold text-violet-400">üìä Metas Trimestrales</h3>
            <div className="flex bg-white/10 rounded-lg p-0.5">
              {quarterNames.map((q, i) => (
                <button key={q} onClick={() => setSelectedQuarter(i)}
                  className={`px-2.5 py-1 text-xs rounded ${selectedQuarter === i ? 'bg-violet-500' : ''}`}>{q}</button>
              ))}
            </div>
          </div>
          <button onClick={() => setShowAddModal('quarterly')} className="text-sm text-violet-400">+ A√±adir</button>
        </div>
        {quarterlyGoals.length > 0 ? (
          <div className="space-y-3">{quarterlyGoals.map(g => <GoalCard key={g.id} goal={g} type="quarterly" gradient="from-violet-500/20 to-purple-500/20" />)}</div>
        ) : (
          <EmptyState type="trimestral" onClick={() => setShowAddModal('quarterly')} />
        )}
      </div>

      {/* Monthly Goals */}
      <div>
        <div className="flex items-center justify-between mb-3">
          <div className="flex items-center gap-3">
            <h3 className="text-lg font-bold text-emerald-400">üìÖ Metas Mensuales</h3>
            <select value={selectedMonth} onChange={e => setSelectedMonth(parseInt(e.target.value))}
              className="bg-white/10 rounded-lg px-2 py-1 text-sm outline-none">
              {monthNames.map((m, i) => <option key={m} value={i} className="bg-zinc-800">{m}</option>)}
            </select>
          </div>
          <button onClick={() => setShowAddModal('monthly')} className="text-sm text-violet-400">+ A√±adir</button>
        </div>
        {monthlyGoals.length > 0 ? (
          <div className="space-y-3">{monthlyGoals.map(g => <GoalCard key={g.id} goal={g} type="monthly" gradient="from-emerald-500/20 to-teal-500/20" />)}</div>
        ) : (
          <EmptyState type="mensual" onClick={() => setShowAddModal('monthly')} />
        )}
      </div>

      {/* Add Modal */}
      {showAddModal && (
        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4" onClick={() => { setShowAddModal(null); setNewGoal({ title: '', description: '', keyResults: [] }); setKrInput(''); }}>
          <div className="bg-zinc-900 rounded-2xl w-full max-w-md max-h-[85vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
            <div className="p-4 border-b border-white/10">
              <h3 className="text-lg font-bold">Nueva Meta {showAddModal === 'yearly' ? 'Anual' : showAddModal === 'quarterly' ? 'Trimestral' : 'Mensual'}</h3>
            </div>
            <div className="p-4 space-y-4">
              <div>
                <label className="text-xs text-white/40 block mb-1">T√≠tulo *</label>
                <input type="text" value={newGoal.title} onChange={e => setNewGoal(p => ({ ...p, title: e.target.value }))}
                  placeholder="Ej: Lanzar nuevo producto" className="w-full bg-white/10 rounded-xl px-4 py-3 outline-none" autoFocus />
              </div>
              <div>
                <label className="text-xs text-white/40 block mb-1">Descripci√≥n</label>
                <textarea value={newGoal.description} onChange={e => setNewGoal(p => ({ ...p, description: e.target.value }))}
                  placeholder="Detalles opcionales..." className="w-full bg-white/10 rounded-xl px-4 py-3 outline-none resize-none h-20" />
              </div>
              <div>
                <label className="text-xs text-white/40 block mb-1">Resultados Clave (OKRs)</label>
                <div className="flex gap-2">
                  <input type="text" value={krInput} onChange={e => setKrInput(e.target.value)}
                    placeholder="A√±adir KR..." className="flex-1 bg-white/10 rounded-xl px-3 py-2 text-sm outline-none"
                    onKeyDown={e => { if (e.key === 'Enter' && krInput.trim()) { setNewGoal(p => ({ ...p, keyResults: [...p.keyResults, { text: krInput.trim(), done: false }] })); setKrInput(''); } }} />
                  <button onClick={() => { if (krInput.trim()) { setNewGoal(p => ({ ...p, keyResults: [...p.keyResults, { text: krInput.trim(), done: false }] })); setKrInput(''); } }}
                    className="px-4 bg-violet-500 rounded-xl">+</button>
                </div>
                {newGoal.keyResults.length > 0 && (
                  <div className="mt-2 space-y-1">
                    {newGoal.keyResults.map((kr, i) => (
                      <div key={i} className="flex items-center gap-2 bg-white/5 rounded-lg px-3 py-2">
                        <span className="flex-1 text-sm">{kr.text}</span>
                        <button onClick={() => setNewGoal(p => ({ ...p, keyResults: p.keyResults.filter((_, idx) => idx !== i) }))} className="text-red-400"><X className="w-4 h-4" /></button>
                      </div>
                    ))}
                  </div>
                )}
              </div>
              <div className="flex gap-2 pt-2">
                <button onClick={() => { setShowAddModal(null); setNewGoal({ title: '', description: '', keyResults: [] }); setKrInput(''); }} className="flex-1 py-3 bg-white/10 rounded-xl">Cancelar</button>
                <button onClick={addGoal} disabled={!newGoal.title.trim()} className="flex-1 py-3 bg-violet-500 rounded-xl disabled:opacity-50">Crear Meta</button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// ============================================================================
// SPIRIT SCREEN - Vision Board, Manifestation & Mindfulness
// ============================================================================
const SpiritScreen = ({ data, setData, showToast }) => {
  const today = getToday();
  const [activeTab, setActiveTab] = useState('vision'); // vision | manifest | gratitude | affirmations | breathe | journal
  const [showAddVision, setShowAddVision] = useState(false);
  const [showAddAffirmation, setShowAddAffirmation] = useState(false);
  const [showBreathingSession, setShowBreathingSession] = useState(false);
  const [breathingPhase, setBreathingPhase] = useState('idle'); // idle | inhale | hold | exhale | holdOut
  const [breathCount, setBreathCount] = useState(0);
  const [selectedTechnique, setSelectedTechnique] = useState('478'); // 478 | box | wim

  // Initialize spirit data
  const spirit = data.spirit || {
    visionBoard: [],
    manifestations: [],
    gratitude: {},
    affirmations: [],
    journal: {},
    breathingSessions: [],
    scripting: {}
  };

  // Vision Board
  const [newVision, setNewVision] = useState({ title: '', category: 'life', description: '', imageUrl: '', targetDate: '' });
  const visionCategories = [
    { id: 'health', label: 'Salud', icon: 'üí™', color: 'from-emerald-500/30 to-teal-500/30' },
    { id: 'wealth', label: 'Abundancia', icon: 'üí∞', color: 'from-amber-500/30 to-yellow-500/30' },
    { id: 'love', label: 'Amor', icon: '‚ù§Ô∏è', color: 'from-rose-500/30 to-pink-500/30' },
    { id: 'career', label: 'Carrera', icon: 'üöÄ', color: 'from-violet-500/30 to-purple-500/30' },
    { id: 'travel', label: 'Viajes', icon: '‚úàÔ∏è', color: 'from-blue-500/30 to-cyan-500/30' },
    { id: 'growth', label: 'Crecimiento', icon: 'üå±', color: 'from-green-500/30 to-emerald-500/30' },
    { id: 'life', label: 'Vida', icon: '‚ú®', color: 'from-indigo-500/30 to-violet-500/30' }
  ];

  const addVision = () => {
    if (!newVision.title.trim()) return;
    setData(prev => ({
      ...prev,
      spirit: {
        ...prev.spirit,
        visionBoard: [...(prev.spirit?.visionBoard || []), { id: crypto.randomUUID(), ...newVision, achieved: false, createdAt: new Date().toISOString() }]
      }
    }));
    setNewVision({ title: '', category: 'life', description: '', imageUrl: '', targetDate: '' });
    setShowAddVision(false);
    showToast('‚ú® Visi√≥n a√±adida');
  };

  const toggleVisionAchieved = (id) => {
    setData(prev => ({
      ...prev,
      spirit: { ...prev.spirit, visionBoard: prev.spirit.visionBoard.map(v => v.id === id ? { ...v, achieved: !v.achieved, achievedAt: !v.achieved ? new Date().toISOString() : null } : v) }
    }));
    showToast('üéâ ¬°Manifestado!');
  };

  // Manifestation
  const [manifestInput, setManifestInput] = useState('');
  const [activeMethod, setActiveMethod] = useState('369');
  const manifestMethods = [
    { id: '369', name: 'M√©todo 369', desc: 'Escribe 3x ma√±ana, 6x mediod√≠a, 9x noche', icon: 'üî¢' },
    { id: 'scripting', name: 'Scripting', desc: 'Escribe tu d√≠a ideal como si ya pas√≥', icon: 'üìù' },
    { id: 'twocup', name: 'Dos Vasos', desc: 'T√©cnica cu√°ntica dimensional', icon: 'ü•§' }
  ];
  const todayManifest = spirit.manifestations?.find(m => m.date === today) || { morning: 0, noon: 0, night: 0, text: '' };

  const addManifestCount = (period) => {
    const target = period === 'morning' ? 3 : period === 'noon' ? 6 : 9;
    const existing = spirit.manifestations?.find(m => m.date === today);
    if (existing && existing[period] >= target) return;

    setData(prev => {
      const manifestations = prev.spirit?.manifestations || [];
      const idx = manifestations.findIndex(m => m.date === today);
      if (idx >= 0) {
        return { ...prev, spirit: { ...prev.spirit, manifestations: manifestations.map((m, i) => i === idx ? { ...m, [period]: m[period] + 1, text: manifestInput || m.text } : m) } };
      } else {
        return { ...prev, spirit: { ...prev.spirit, manifestations: [...manifestations, { id: crypto.randomUUID(), date: today, text: manifestInput, morning: period === 'morning' ? 1 : 0, noon: period === 'noon' ? 1 : 0, night: period === 'night' ? 1 : 0 }] } };
      }
    });
    showToast('‚ú® +1');
  };

  const saveScripting = (text) => {
    setData(prev => ({ ...prev, spirit: { ...prev.spirit, scripting: { ...prev.spirit?.scripting, [today]: text } } }));
  };

  // Gratitude
  const [gratitudeInputs, setGratitudeInputs] = useState(['', '', '']);
  const todayGratitude = spirit.gratitude?.[today] || [];

  const saveGratitude = () => {
    const items = gratitudeInputs.filter(g => g.trim());
    if (items.length === 0) return;
    setData(prev => ({ ...prev, spirit: { ...prev.spirit, gratitude: { ...prev.spirit?.gratitude, [today]: items } } }));
    setGratitudeInputs(['', '', '']);
    showToast('üôè Gratitud guardada');
  };

  const getGratitudeStreak = () => {
    let streak = 0, checkDate = today;
    while (spirit.gratitude?.[checkDate]?.length > 0) { streak++; checkDate = getDateOffset(checkDate, -1); }
    return streak;
  };

  // Affirmations
  const [newAffirmation, setNewAffirmation] = useState('');
  const [currentAffirmationIdx, setCurrentAffirmationIdx] = useState(0);
  const defaultAffirmations = ["Soy digno de amor y abundancia", "El universo conspira a mi favor", "Atraigo oportunidades infinitas", "Soy imparable y poderoso", "Todo lo que necesito est√° en m√≠"];
  const allAffirmations = [...(spirit.affirmations || []).map(a => a.text), ...defaultAffirmations];

  const addAffirmation = () => {
    if (!newAffirmation.trim()) return;
    setData(prev => ({ ...prev, spirit: { ...prev.spirit, affirmations: [...(prev.spirit?.affirmations || []), { id: crypto.randomUUID(), text: newAffirmation.trim() }] } }));
    setNewAffirmation('');
    setShowAddAffirmation(false);
    showToast('üí´ Afirmaci√≥n a√±adida');
  };

  // Breathing
  const breathingTechniques = {
    '478': { name: '4-7-8 Relajaci√≥n', inhale: 4, hold: 7, exhale: 8, holdOut: 0, rounds: 4, color: 'from-blue-500 to-cyan-500' },
    'box': { name: 'Respiraci√≥n Cuadrada', inhale: 4, hold: 4, exhale: 4, holdOut: 4, rounds: 4, color: 'from-violet-500 to-purple-500' },
    'wim': { name: 'Wim Hof', inhale: 2, hold: 0, exhale: 2, holdOut: 15, rounds: 30, color: 'from-cyan-500 to-teal-500' }
  };
  const [breathTimer, setBreathTimer] = useState(0);
  const [breathRound, setBreathRound] = useState(0);

  useEffect(() => {
    if (breathingPhase === 'idle') return;
    const technique = breathingTechniques[selectedTechnique];
    let targetTime = breathingPhase === 'inhale' ? technique.inhale : breathingPhase === 'hold' ? technique.hold : breathingPhase === 'exhale' ? technique.exhale : technique.holdOut;
    let nextPhase = breathingPhase === 'inhale' ? (technique.hold > 0 ? 'hold' : 'exhale') : breathingPhase === 'hold' ? 'exhale' : breathingPhase === 'exhale' ? (technique.holdOut > 0 ? 'holdOut' : 'inhale') : 'inhale';

    if (breathTimer >= targetTime) {
      if (nextPhase === 'inhale' && breathingPhase !== 'inhale') {
        if (breathRound >= technique.rounds - 1) {
          setBreathingPhase('idle'); setBreathRound(0); setBreathTimer(0); setShowBreathingSession(false);
          setData(prev => ({ ...prev, spirit: { ...prev.spirit, breathingSessions: [...(prev.spirit?.breathingSessions || []), { date: today, technique: selectedTechnique }] } }));
          showToast('üßò Sesi√≥n completada');
          return;
        }
        setBreathRound(r => r + 1);
      }
      setBreathingPhase(nextPhase); setBreathTimer(0);
      return;
    }
    const interval = setInterval(() => setBreathTimer(t => t + 0.1), 100);
    return () => clearInterval(interval);
  }, [breathingPhase, breathTimer, breathRound, selectedTechnique]);

  const startBreathing = () => { setShowBreathingSession(true); setBreathingPhase('inhale'); setBreathTimer(0); setBreathRound(0); };
  const stopBreathing = () => { setShowBreathingSession(false); setBreathingPhase('idle'); setBreathTimer(0); setBreathRound(0); };

  // Journal
  const [journalEntry, setJournalEntry] = useState('');
  const [journalMood, setJournalMood] = useState(null);
  const todayJournal = spirit.journal?.[today];
  const moods = [{ id: 'amazing', emoji: 'ü§©' }, { id: 'happy', emoji: 'üòä' }, { id: 'calm', emoji: 'üòå' }, { id: 'meh', emoji: 'üòê' }, { id: 'anxious', emoji: 'üò∞' }, { id: 'sad', emoji: 'üò¢' }];
  const journalPrompts = ["¬øQu√© te hizo sentir vivo hoy?", "¬øQu√© aprendiste de ti mismo?", "¬øQu√© se√±al del universo recibiste?"];
  const [currentPrompt] = useState(journalPrompts[Math.floor(Math.random() * journalPrompts.length)]);

  const saveJournal = () => {
    if (!journalEntry.trim() || !journalMood) return;
    setData(prev => ({ ...prev, spirit: { ...prev.spirit, journal: { ...prev.spirit?.journal, [today]: { text: journalEntry, mood: journalMood } } } }));
    showToast('üìî Guardado');
  };

  const tabs = [
    { id: 'vision', label: 'Vision Board', icon: 'üéØ' },
    { id: 'manifest', label: 'Manifestar', icon: '‚ú®' },
    { id: 'gratitude', label: 'Gratitud', icon: 'üôè' },
    { id: 'affirmations', label: 'Afirmaciones', icon: 'üí´' },
    { id: 'breathe', label: 'Respirar', icon: 'üßò' },
    { id: 'journal', label: 'Diario', icon: 'üìî' }
  ];

  return (
    <div className="pb-24">
      <AnimatedMount>
        <div className="text-center mb-6">
          <h1 className="text-3xl font-bold bg-gradient-to-r from-violet-400 via-pink-400 to-amber-400 bg-clip-text text-transparent">Esp√≠ritu</h1>
          <p className="text-white/50 text-sm mt-1">Conecta con tu ser interior</p>
        </div>
        <div className="flex gap-2 overflow-x-auto pb-3 mb-4" style={{ scrollbarWidth: 'none' }}>
          {tabs.map(tab => (
            <button key={tab.id} onClick={() => setActiveTab(tab.id)}
              className={`px-4 py-2 rounded-xl whitespace-nowrap text-sm transition-all flex items-center gap-2 ${activeTab === tab.id ? 'bg-gradient-to-r from-violet-500 to-purple-500' : 'bg-white/10'}`}>
              <span>{tab.icon}</span><span>{tab.label}</span>
            </button>
          ))}
        </div>
      </AnimatedMount>

      <AnimatedMount delay={50}>
        {/* VISION BOARD */}
        {activeTab === 'vision' && (
          <div className="space-y-4">
            <p className="text-center text-white/60 text-sm mb-4">Visualiza tu vida ideal. Lo que ves es lo que atraes.</p>
            {(spirit.visionBoard || []).length > 0 ? (
              <div className="grid grid-cols-2 gap-3">
                {spirit.visionBoard.map(vision => {
                  const cat = visionCategories.find(c => c.id === vision.category) || visionCategories[6];
                  return (
                    <div key={vision.id} className={`rounded-2xl bg-gradient-to-br ${cat.color} p-4 min-h-[120px] flex flex-col ${vision.achieved ? 'ring-2 ring-emerald-400' : ''}`}>
                      <div className="flex justify-between"><span className="text-xl">{cat.icon}</span>{vision.achieved && <span>‚úÖ</span>}</div>
                      <p className={`flex-1 flex items-center justify-center text-center font-bold ${vision.achieved ? 'line-through opacity-60' : ''}`}>{vision.title}</p>
                      <div className="flex justify-between items-center mt-2">
                        <button onClick={() => toggleVisionAchieved(vision.id)} className={`text-[10px] px-2 py-1 rounded-full ${vision.achieved ? 'bg-emerald-500/30' : 'bg-white/20'}`}>{vision.achieved ? 'Manifestado' : 'Manifestar'}</button>
                        <button onClick={() => setData(prev => ({ ...prev, spirit: { ...prev.spirit, visionBoard: prev.spirit.visionBoard.filter(v => v.id !== vision.id) } }))} className="text-white/40 text-xs">‚úï</button>
                      </div>
                    </div>
                  );
                })}
              </div>
            ) : (
              <Card className="text-center py-12 border-dashed border-2 border-white/20"><p className="text-4xl mb-3">üéØ</p><p className="text-white/40">A√±ade tus sue√±os y metas</p></Card>
            )}
            <button onClick={() => setShowAddVision(true)} className="w-full py-4 bg-gradient-to-r from-violet-500/20 to-purple-500/20 rounded-2xl text-violet-300 font-medium border border-violet-500/30">+ A√±adir a Vision Board</button>
            {showAddVision && (
              <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4" onClick={() => setShowAddVision(false)}>
                <Card className="w-full max-w-md" onClick={e => e.stopPropagation()}>
                  <h3 className="text-xl font-bold mb-4 text-center">‚ú® Nueva Visi√≥n</h3>
                  <input type="text" value={newVision.title} onChange={e => setNewVision(p => ({ ...p, title: e.target.value }))} placeholder="¬øQu√© deseas manifestar?" className="w-full bg-white/10 rounded-xl px-4 py-3 outline-none mb-4" autoFocus />
                  <div className="grid grid-cols-4 gap-2 mb-4">
                    {visionCategories.map(cat => (
                      <button key={cat.id} onClick={() => setNewVision(p => ({ ...p, category: cat.id }))} className={`p-2 rounded-xl text-center ${newVision.category === cat.id ? 'bg-white/20 ring-2 ring-white/40' : 'bg-white/5'}`}>
                        <span className="text-xl">{cat.icon}</span><p className="text-[8px] mt-1">{cat.label}</p>
                      </button>
                    ))}
                  </div>
                  <div className="flex gap-2">
                    <button onClick={() => setShowAddVision(false)} className="flex-1 py-3 bg-white/10 rounded-xl">Cancelar</button>
                    <button onClick={addVision} className="flex-1 py-3 bg-violet-500 rounded-xl">Crear</button>
                  </div>
                </Card>
              </div>
            )}
          </div>
        )}

        {/* MANIFESTATION */}
        {activeTab === 'manifest' && (
          <div className="space-y-4">
            <div className="flex gap-2 overflow-x-auto pb-2" style={{ scrollbarWidth: 'none' }}>
              {manifestMethods.map(m => (
                <button key={m.id} onClick={() => setActiveMethod(m.id)} className={`px-4 py-2 rounded-xl whitespace-nowrap text-sm ${activeMethod === m.id ? 'bg-violet-500' : 'bg-white/10'}`}>{m.icon} {m.name}</button>
              ))}
            </div>
            {activeMethod === '369' && (
              <>
                <Card className="bg-gradient-to-br from-violet-500/20 to-purple-500/20">
                  <h3 className="font-bold mb-2">üî¢ M√©todo 369 de Tesla</h3>
                  <p className="text-sm text-white/60 mb-4">Escribe tu manifestaci√≥n 3x ma√±ana, 6x mediod√≠a, 9x noche durante 33-45 d√≠as.</p>
                  <textarea value={manifestInput || todayManifest.text} onChange={e => setManifestInput(e.target.value)} placeholder="Estoy tan feliz y agradecido de que..." className="w-full bg-black/30 rounded-xl px-4 py-3 outline-none resize-none h-20" />
                </Card>
                <div className="grid grid-cols-3 gap-3">
                  {[{ period: 'morning', label: 'Ma√±ana', target: 3, icon: 'üåÖ' }, { period: 'noon', label: 'Mediod√≠a', target: 6, icon: '‚òÄÔ∏è' }, { period: 'night', label: 'Noche', target: 9, icon: 'üåô' }].map(slot => {
                    const current = todayManifest[slot.period] || 0;
                    const complete = current >= slot.target;
                    return (
                      <Card key={slot.period} className={`text-center ${complete ? 'bg-emerald-500/20' : ''}`}>
                        <p className="text-2xl">{slot.icon}</p><p className="text-xs text-white/40">{slot.label}</p>
                        <p className="text-2xl font-bold my-2">{current}/{slot.target}</p>
                        <button onClick={() => addManifestCount(slot.period)} disabled={complete || !manifestInput.trim()} className={`w-full py-2 rounded-lg text-sm ${complete ? 'bg-emerald-500/30' : 'bg-white/10'} disabled:opacity-50`}>{complete ? '‚úì' : '+1'}</button>
                      </Card>
                    );
                  })}
                </div>
              </>
            )}
            {activeMethod === 'scripting' && (
              <Card className="bg-gradient-to-br from-blue-500/20 to-cyan-500/20">
                <h3 className="font-bold mb-2">üìù Scripting</h3>
                <p className="text-sm text-white/60 mb-4">Escribe tu d√≠a ideal como si ya hubiera pasado.</p>
                <textarea value={spirit.scripting?.[today] || ''} onChange={e => saveScripting(e.target.value)} placeholder="Hoy fue un d√≠a incre√≠ble..." className="w-full bg-black/30 rounded-xl px-4 py-3 outline-none resize-none h-48" />
              </Card>
            )}
            {activeMethod === 'twocup' && (
              <Card className="bg-gradient-to-br from-cyan-500/20 to-teal-500/20">
                <h3 className="font-bold mb-2">ü•§ T√©cnica de los Dos Vasos</h3>
                <div className="space-y-3">
                  {['Llena un vaso con agua, etiqu√©talo "SITUACI√ìN ACTUAL"', 'Etiqueta vaso vac√≠o "SITUACI√ìN DESEADA"', 'Vierte el agua visualizando el cambio', 'Bebe el agua sintiendo gratitud', 'Conf√≠a y suelta'].map((step, i) => (
                    <div key={i} className="flex gap-3"><div className="w-6 h-6 rounded-full bg-white/10 flex items-center justify-center flex-shrink-0 text-xs font-bold">{i + 1}</div><p className="text-sm">{step}</p></div>
                  ))}
                </div>
              </Card>
            )}
          </div>
        )}

        {/* GRATITUDE */}
        {activeTab === 'gratitude' && (
          <div className="space-y-4">
            <Card className="bg-gradient-to-br from-amber-500/20 to-orange-500/20">
              <div className="flex justify-between mb-4">
                <div><h3 className="font-bold">üôè Gratitud Diaria</h3><p className="text-sm text-white/60">3 cosas por agradecer</p></div>
                <div className="text-right"><p className="text-2xl font-bold text-amber-400">{getGratitudeStreak()}</p><p className="text-[10px] text-white/40">d√≠as</p></div>
              </div>
              {todayGratitude.length > 0 ? (
                <div className="space-y-2">
                  {todayGratitude.map((item, i) => <div key={i} className="flex items-center gap-3 bg-black/20 rounded-xl px-4 py-3"><span className="text-amber-400">‚úì</span><span>{item}</span></div>)}
                  <p className="text-center text-emerald-400 text-sm mt-4">‚ú® ¬°Completado!</p>
                </div>
              ) : (
                <div className="space-y-3">
                  {[0, 1, 2].map(i => <input key={i} type="text" value={gratitudeInputs[i]} onChange={e => setGratitudeInputs(p => p.map((v, idx) => idx === i ? e.target.value : v))} placeholder={`${i + 1}. Estoy agradecido por...`} className="w-full bg-black/20 rounded-xl px-4 py-3 outline-none" />)}
                  <button onClick={saveGratitude} disabled={!gratitudeInputs.some(g => g.trim())} className="w-full py-3 bg-amber-500/30 rounded-xl disabled:opacity-50">Guardar</button>
                </div>
              )}
            </Card>
          </div>
        )}

        {/* AFFIRMATIONS */}
        {activeTab === 'affirmations' && (
          <div className="space-y-4">
            <Card className="bg-gradient-to-br from-purple-500/30 to-pink-500/30 py-8 text-center">
              <p className="text-4xl mb-4">üí´</p>
              <p className="text-xl font-medium italic px-4">"{allAffirmations[currentAffirmationIdx]}"</p>
              <div className="flex justify-center gap-4 mt-6">
                <button onClick={() => setCurrentAffirmationIdx(i => i > 0 ? i - 1 : allAffirmations.length - 1)} className="p-2 bg-white/10 rounded-full"><ChevronLeft className="w-5 h-5" /></button>
                <button onClick={() => setCurrentAffirmationIdx(i => (i + 1) % allAffirmations.length)} className="p-2 bg-white/10 rounded-full"><ChevronRight className="w-5 h-5" /></button>
              </div>
              <p className="text-xs text-white/40 mt-4">Repite 3 veces con convicci√≥n</p>
            </Card>
            <div className="flex justify-between items-center"><h4 className="text-sm text-white/40">MIS AFIRMACIONES</h4><button onClick={() => setShowAddAffirmation(true)} className="text-violet-400 text-sm">+ A√±adir</button></div>
            <div className="space-y-2">
              {(spirit.affirmations || []).map(aff => (
                <Card key={aff.id} className="bg-white/5 flex items-center justify-between">
                  <p className="text-sm">"{aff.text}"</p>
                  <button onClick={() => setData(prev => ({ ...prev, spirit: { ...prev.spirit, affirmations: prev.spirit.affirmations.filter(a => a.id !== aff.id) } }))} className="text-white/30"><X className="w-4 h-4" /></button>
                </Card>
              ))}
            </div>
            {showAddAffirmation && (
              <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4" onClick={() => setShowAddAffirmation(false)}>
                <Card className="w-full max-w-md" onClick={e => e.stopPropagation()}>
                  <h3 className="text-lg font-bold mb-4">Nueva Afirmaci√≥n</h3>
                  <input type="text" value={newAffirmation} onChange={e => setNewAffirmation(e.target.value)} placeholder="Yo soy..." className="w-full bg-white/10 rounded-xl px-4 py-3 outline-none mb-4" autoFocus />
                  <div className="flex gap-2"><button onClick={() => setShowAddAffirmation(false)} className="flex-1 py-3 bg-white/10 rounded-xl">Cancelar</button><button onClick={addAffirmation} className="flex-1 py-3 bg-violet-500 rounded-xl">Guardar</button></div>
                </Card>
              </div>
            )}
          </div>
        )}

        {/* BREATHING */}
        {activeTab === 'breathe' && (
          <div className="space-y-4">
            <Card className="bg-gradient-to-br from-cyan-500/20 to-blue-500/20 text-center py-6">
              <p className="text-4xl mb-2">üßò</p>
              <h3 className="text-xl font-bold">Respiraci√≥n Consciente</h3>
              <p className="text-sm text-white/60 mt-2">Calma tu mente, eleva tu vibraci√≥n</p>
            </Card>
            <div className="grid grid-cols-1 gap-3">
              {Object.entries(breathingTechniques).map(([id, tech]) => (
                <button key={id} onClick={() => { setSelectedTechnique(id); startBreathing(); }} className={`p-4 rounded-2xl bg-gradient-to-r ${tech.color} text-left`}>
                  <p className="font-bold">{tech.name}</p>
                  <p className="text-xs text-white/60 mt-1">{tech.inhale}s inhala ¬∑ {tech.hold > 0 ? `${tech.hold}s ret√©n ¬∑ ` : ''}{tech.exhale}s exhala ¬∑ {tech.rounds} rondas</p>
                </button>
              ))}
            </div>
            {showBreathingSession && (
              <div className="fixed inset-0 bg-black z-50 flex items-center justify-center">
                <div className="text-center">
                  <div className={`w-64 h-64 rounded-full mx-auto flex items-center justify-center transition-all duration-1000 bg-gradient-to-br ${breathingTechniques[selectedTechnique].color}`}
                    style={{ transform: `scale(${breathingPhase === 'inhale' ? 1.3 : breathingPhase === 'exhale' ? 0.7 : 1})` }}>
                    <div><p className="text-3xl font-bold">{breathingPhase === 'inhale' ? 'INHALA' : breathingPhase === 'hold' ? 'RET√âN' : breathingPhase === 'exhale' ? 'EXHALA' : 'RET√âN'}</p>
                      <p className="text-5xl font-bold mt-2">{Math.ceil(breathingTechniques[selectedTechnique][breathingPhase === 'holdOut' ? 'holdOut' : breathingPhase] - breathTimer)}</p></div>
                  </div>
                  <p className="text-white/60 mt-8">Ronda {breathRound + 1} / {breathingTechniques[selectedTechnique].rounds}</p>
                  <button onClick={stopBreathing} className="mt-6 px-8 py-3 bg-white/10 rounded-full">Terminar</button>
                </div>
              </div>
            )}
          </div>
        )}

        {/* JOURNAL */}
        {activeTab === 'journal' && (
          <div className="space-y-4">
            <Card className="bg-gradient-to-br from-rose-500/20 to-pink-500/20">
              <h3 className="font-bold mb-4">üìî Diario del Alma</h3>
              {!todayJournal ? (
                <>
                  <p className="text-xs text-white/40 mb-2">¬øC√≥mo te sientes?</p>
                  <div className="flex justify-between mb-4">
                    {moods.map(mood => <button key={mood.id} onClick={() => setJournalMood(mood.id)} className={`text-2xl p-2 rounded-xl ${journalMood === mood.id ? 'bg-white/20 scale-125' : 'opacity-50'}`}>{mood.emoji}</button>)}
                  </div>
                  <div className="bg-black/20 rounded-xl p-3 mb-4 text-center"><p className="text-xs text-white/40">Reflexi√≥n</p><p className="text-white/80 italic text-sm">{currentPrompt}</p></div>
                  <textarea value={journalEntry} onChange={e => setJournalEntry(e.target.value)} placeholder="Escribe libremente..." className="w-full bg-black/20 rounded-xl px-4 py-3 outline-none resize-none h-32" />
                  <button onClick={saveJournal} disabled={!journalEntry.trim() || !journalMood} className="w-full mt-4 py-3 bg-rose-500/30 rounded-xl disabled:opacity-50">Guardar</button>
                </>
              ) : (
                <div>
                  <div className="flex items-center gap-3 mb-4"><span className="text-3xl">{moods.find(m => m.id === todayJournal.mood)?.emoji}</span><p className="text-xs text-white/40">Hoy</p></div>
                  <p className="text-white/80">{todayJournal.text}</p>
                  <p className="text-emerald-400 text-center mt-4">‚ú® Ya reflexionaste hoy</p>
                </div>
              )}
            </Card>
          </div>
        )}
      </AnimatedMount>
    </div>
  );
};

const WeeklyScreen = ({ data }) => {
  const today = getToday();
  const [weekOffset, setWeekOffset] = useState(0);

  const getOffsetWeek = (offset) => {
    const d = new Date();
    d.setDate(d.getDate() + (offset * 7));
    return getWeekDates(d.toISOString().split('T')[0]);
  };

  const week = getOffsetWeek(weekOffset);
  const weekDayNames = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];

  const weekStats = week.map(date => {
    const dayData = data.days[date];
    const dayMeals = data.meals.filter(m => m.day_id === date);
    const dayTasks = data.tasks.filter(t => t.day_id === date);
    const dayWorkout = data.workouts.find(w => w.day_id === date);
    const dayHabitLogs = data.habitLogs?.filter(l => l.date === date) || [];

    return {
      date,
      score: calculateDayScore(dayData, dayHabitLogs, dayMeals, dayTasks, dayWorkout, data.user.goals),
      workout: dayWorkout,
      habits: dayHabitLogs.filter(l => l.completed).length,
      tasks: dayTasks.filter(t => t.completed).length,
      calories: dayMeals.reduce((s, m) => s + (m.calories || 0), 0)
    };
  });

  const weekWorkouts = weekStats.filter(d => d.workout?.is_completed).length;
  const weekHabitsTotal = data.habits.length * 7;
  const weekHabitsCompleted = weekStats.reduce((s, d) => s + d.habits, 0);
  const weekTasksCompleted = weekStats.reduce((s, d) => s + d.tasks, 0);
  const avgScore = Math.round(weekStats.reduce((s, d) => s + d.score, 0) / 7);

  return (
    <div className="space-y-4 pb-24">
      <AnimatedMount>
        <div className="flex items-center justify-between">
          <button onClick={() => setWeekOffset(o => o - 1)} className="p-2 hover:bg-white/10 rounded-lg">
            <ChevronLeft className="w-5 h-5" />
          </button>
          <div className="text-center">
            <h1 className="text-xl font-bold">Semana</h1>
            <p className="text-white/50 text-sm">{formatShortDate(week[0])} - {formatShortDate(week[6])}</p>
          </div>
          <button
            onClick={() => weekOffset < 0 && setWeekOffset(o => o + 1)}
            className={`p-2 rounded-lg ${weekOffset < 0 ? 'hover:bg-white/10' : 'opacity-30'}`}
            disabled={weekOffset >= 0}
          >
            <ChevronRight className="w-5 h-5" />
          </button>
        </div>
      </AnimatedMount>

      <AnimatedMount delay={50}>
        <div className="flex gap-1">
          {weekStats.map((day, i) => {
            const isToday = day.date === today;
            const isPastDay = day.date < today;

            return (
              <div
                key={day.date}
                className={`flex-1 py-3 rounded-xl text-center transition-all ${isToday ? 'bg-violet-500' : 'bg-white/5'}`}
              >
                <p className="text-xs text-white/60 mb-1">{weekDayNames[i]}</p>
                <p className="text-lg font-bold">{new Date(day.date).getDate()}</p>
                {isPastDay || isToday ? (
                  <div className={`w-2 h-2 rounded-full mx-auto mt-1 ${day.score >= 70 ? 'bg-emerald-500' :
                    day.score >= 40 ? 'bg-yellow-500' :
                      day.score > 0 ? 'bg-red-500' : 'bg-white/20'
                    }`} />
                ) : (
                  <div className="w-2 h-2 rounded-full mx-auto mt-1 bg-white/10" />
                )}
              </div>
            );
          })}
        </div>
      </AnimatedMount>

      <AnimatedMount delay={75}>
        <Card className="bg-gradient-to-r from-violet-500/20 to-fuchsia-500/20 border-violet-500/30">
          <div className="flex items-center justify-center gap-4">
            <DayScore score={avgScore} size="lg" />
            <div>
              <p className="text-2xl font-bold">Promedio</p>
              <p className="text-sm text-white/50">
                {avgScore >= 70 ? '¬°Gran semana!' : avgScore >= 50 ? 'Buena semana' : 'Puedes mejorar'}
              </p>
            </div>
          </div>
        </Card>
      </AnimatedMount>

      <AnimatedMount delay={100}>
        <Card>
          <div className="flex items-center gap-2 mb-3">
            <Dumbbell className="w-4 h-4 text-violet-400" />
            <span className="font-medium">Entrenos</span>
          </div>
          <div className="space-y-2">
            {weekStats.map((day, i) => (
              <div
                key={day.date}
                className={`flex items-center justify-between p-2 rounded-lg ${day.workout?.is_completed ? 'bg-emerald-500/20' : 'bg-white/5'}`}
              >
                <div className="flex items-center gap-3">
                  <span className="text-sm text-white/40 w-6">{weekDayNames[i]}</span>
                  <span className={day.workout ? '' : 'text-white/40'}>
                    {day.workout?.name || 'Descanso'}
                  </span>
                </div>
                {day.workout?.is_completed && <Check className="w-4 h-4 text-emerald-400" />}
              </div>
            ))}
          </div>
        </Card>
      </AnimatedMount>

      <AnimatedMount delay={150}>
        <div className="grid grid-cols-2 gap-3">
          <Card className="text-center">
            <Dumbbell className="w-6 h-6 text-violet-400 mx-auto mb-2" />
            <p className="text-3xl font-bold">{weekWorkouts}</p>
            <p className="text-xs text-white/40">Entrenos</p>
          </Card>
          <Card className="text-center">
            <CheckSquare className="w-6 h-6 text-emerald-400 mx-auto mb-2" />
            <p className="text-3xl font-bold">{weekHabitsTotal > 0 ? Math.round((weekHabitsCompleted / weekHabitsTotal) * 100) : 0}%</p>
            <p className="text-xs text-white/40">H√°bitos</p>
          </Card>
          <Card className="text-center">
            <Target className="w-6 h-6 text-blue-400 mx-auto mb-2" />
            <p className="text-3xl font-bold">{weekTasksCompleted}</p>
            <p className="text-xs text-white/40">Tareas</p>
          </Card>
          <Card className="text-center">
            <Flame className="w-6 h-6 text-orange-400 mx-auto mb-2" />
            <p className="text-3xl font-bold">{Math.round(weekStats.reduce((s, d) => s + d.calories, 0) / 7)}</p>
            <p className="text-xs text-white/40">kcal/d√≠a</p>
          </Card>
        </div>
      </AnimatedMount>
    </div>
  );
};

// ============================================================================
// STATS SCREEN
// ============================================================================
// ============================================================================
// STATS SCREEN
// ============================================================================
// TODO: DESARROLLO FUTURO - STATS EN PROFUNDIDAD
// ============================================================================
// La pantalla de Stats debe tener 2 niveles:
//
// 1. VISTA GENERAL (actual) - Dashboard resumen de todo:
//    - Score del d√≠a
//    - Resumen de cada categor√≠a
//    - Gr√°ficos generales
//
// 2. STATS POR CATEGOR√çA (por desarrollar) - Submenu con:
//    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
//    ‚îÇ  üìä STATS DETALLADAS                                            ‚îÇ
//    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
//    ‚îÇ  üèãÔ∏è ENTRENO                                                     ‚îÇ
//    ‚îÇ     - Volumen semanal/mensual (kg totales)                     ‚îÇ
//    ‚îÇ     - Frecuencia de entreno                                    ‚îÇ
//    ‚îÇ     - PRs por ejercicio con gr√°ficos de progresi√≥n            ‚îÇ
//    ‚îÇ     - M√∫sculos m√°s/menos trabajados                           ‚îÇ
//    ‚îÇ     - Tiempo promedio de sesi√≥n                               ‚îÇ
//    ‚îÇ     - 1RM estimados y su evoluci√≥n                            ‚îÇ
//    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
//    ‚îÇ  üçΩÔ∏è NUTRICI√ìN                                                   ‚îÇ
//    ‚îÇ     - Calor√≠as promedio diarias/semanales                     ‚îÇ
//    ‚îÇ     - Distribuci√≥n de macros                                  ‚îÇ
//    ‚îÇ     - Adherencia a objetivos                                  ‚îÇ
//    ‚îÇ     - Comidas m√°s frecuentes                                  ‚îÇ
//    ‚îÇ     - Gr√°ficos de tendencia                                   ‚îÇ
//    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
//    ‚îÇ  ‚úÖ H√ÅBITOS                                                     ‚îÇ
//    ‚îÇ     - Tasa de completado por h√°bito                           ‚îÇ
//    ‚îÇ     - Streaks actuales y m√°ximos                              ‚îÇ
//    ‚îÇ     - Calendario de consistencia (github-style)               ‚îÇ
//    ‚îÇ     - Mejores/peores d√≠as de la semana                        ‚îÇ
//    ‚îÇ     - Correlaci√≥n h√°bitos vs score del d√≠a                    ‚îÇ
//    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
//    ‚îÇ  ‚öñÔ∏è CUERPO                                                      ‚îÇ
//    ‚îÇ     - Gr√°fico de peso a largo plazo                           ‚îÇ
//    ‚îÇ     - Tendencia (media m√≥vil 7 d√≠as)                          ‚îÇ
//    ‚îÇ     - Grasa corporal si disponible                            ‚îÇ
//    ‚îÇ     - Medidas corporales                                      ‚îÇ
//    ‚îÇ     - Correlaci√≥n peso vs entreno/nutrici√≥n                   ‚îÇ
//    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
//    ‚îÇ  üò¥ BIENESTAR                                                   ‚îÇ
//    ‚îÇ     - Horas de sue√±o promedio                                 ‚îÇ
//    ‚îÇ     - Nivel de energ√≠a medio                                  ‚îÇ
//    ‚îÇ     - Correlaci√≥n sue√±o vs rendimiento                        ‚îÇ
//    ‚îÇ     - Mood tracking del diario                                ‚îÇ
//    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
//    ‚îÇ  üìã PRODUCTIVIDAD                                               ‚îÇ
//    ‚îÇ     - Tareas completadas por d√≠a/semana                       ‚îÇ
//    ‚îÇ     - Por proyecto                                            ‚îÇ
//    ‚îÇ     - Tiempo hasta completar                                  ‚îÇ
//    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
//
// IMPLEMENTACI√ìN:
// - A√±adir estado [statsView, setStatsView] = useState('general')
// - Crear tabs o cards clickables para cada categor√≠a
// - Cada categor√≠a tiene su propia sub-pantalla con gr√°ficos detallados
// - Usar MiniChart expandido o librer√≠a de gr√°ficos m√°s completa
// ============================================================================

const StatsScreen = ({ data, setScreen }) => {
  const [view, setView] = useState('general'); // general, entreno, nutricion, habitos, cuerpo, bienestar
  const today = getToday();

  // Active areas from user settings
  const activeAreas = data.user.activeAreas || ['nutrition', 'workout', 'habits', 'work', 'personal', 'body', 'finances', 'consciousness', 'relationships'];

  // ===================== DATA CALCULATIONS =====================
  // General
  const dayData = data.days[today];
  const todayMeals = data.meals.filter(m => m.day_id === today);
  const todayWorkout = data.workouts.find(w => w.day_id === today);
  const todayTasks = data.tasks.filter(t => t.day_id === today);
  const todayHabitLogs = data.habitLogs?.filter(l => l.date === today) || [];
  const dayScore = calculateDayScore(dayData, todayHabitLogs, todayMeals, todayTasks, todayWorkout, data.user.goals);

  // Last 7 days
  const last7Days = Array.from({ length: 7 }, (_, i) => getDateOffset(today, -i));
  const last30Days = Array.from({ length: 30 }, (_, i) => getDateOffset(today, -i));

  // Workout stats
  const completedWorkouts = data.workouts.filter(w => w.is_completed);
  const workoutsThisWeek = completedWorkouts.filter(w => last7Days.includes(w.day_id)).length;
  const workoutsThisMonth = completedWorkouts.filter(w => last30Days.includes(w.day_id)).length;
  const totalVolume = completedWorkouts.reduce((sum, w) => {
    return sum + (w.exercises?.reduce((exSum, ex) => {
      return exSum + ex.sets.filter(s => s.completed).reduce((setSum, s) => setSum + ((s.weight || 0) * (s.reps || 0)), 0);
    }, 0) || 0);
  }, 0);
  const weeklyVolume = completedWorkouts.filter(w => last7Days.includes(w.day_id)).reduce((sum, w) => {
    return sum + (w.exercises?.reduce((exSum, ex) => {
      return exSum + ex.sets.filter(s => s.completed).reduce((setSum, s) => setSum + ((s.weight || 0) * (s.reps || 0)), 0);
    }, 0) || 0);
  }, 0);

  // Nutrition stats
  const avgCalories = last7Days.reduce((sum, d) => {
    const dayMeals = data.meals.filter(m => m.day_id === d);
    return sum + dayMeals.reduce((s, m) => s + (m.calories || 0), 0);
  }, 0) / 7;
  const avgProtein = last7Days.reduce((sum, d) => {
    const dayMeals = data.meals.filter(m => m.day_id === d);
    return sum + dayMeals.reduce((s, m) => s + (m.protein || 0), 0);
  }, 0) / 7;
  const proteinAdherence = data.user.goals?.protein ? Math.round((avgProtein / data.user.goals.protein) * 100) : 0;

  // Habits stats
  const habitsCompleted = todayHabitLogs.filter(l => l.completed).length;
  const bestStreak = Math.max(...data.habits.map(h => getHabitStreak(h.id, data.habitLogs || [], today)), 0);
  const habitCompletionRate = last7Days.reduce((sum, d) => {
    const dayLogs = data.habitLogs?.filter(l => l.date === d) || [];
    const completed = dayLogs.filter(l => l.completed).length;
    return sum + (data.habits.length > 0 ? completed / data.habits.length : 0);
  }, 0) / 7 * 100;

  // Body stats
  const weights = (data.bodyMetrics || []).sort((a, b) => a.date.localeCompare(b.date)).map(m => m.weight);
  const latestWeight = (data.bodyMetrics || []).sort((a, b) => b.date.localeCompare(a.date))[0];
  const oldestWeight = (data.bodyMetrics || []).sort((a, b) => a.date.localeCompare(b.date))[0];
  const weightChange = latestWeight && oldestWeight ? (latestWeight.weight - oldestWeight.weight).toFixed(1) : null;

  // Sleep/Energy stats
  const avgSleep = last7Days.reduce((sum, d) => sum + (data.days[d]?.sleep_hours || 0), 0) / 7;
  const avgEnergy = last7Days.reduce((sum, d) => sum + (data.days[d]?.energy_level || 0), 0) / 7;
  const sleepData = last7Days.map(d => data.days[d]?.sleep_hours || 0).reverse();

  // Score history
  const scoreHistory = last7Days.map(d => {
    const dd = data.days[d];
    const dm = data.meals.filter(m => m.day_id === d);
    const dw = data.workouts.find(w => w.day_id === d);
    const dt = data.tasks.filter(t => t.day_id === d);
    const dh = data.habitLogs?.filter(l => l.date === d) || [];
    return calculateDayScore(dd, dh, dm, dt, dw, data.user.goals);
  }).reverse();

  // ===================== NEW AREAS STATS =====================
  // Relationships stats
  const relationships = data.relationships || [];
  const frequencyDays = { daily: 1, weekly: 7, biweekly: 14, monthly: 30, quarterly: 90 };
  const relNeedsAttention = relationships.filter(r => {
    if (!r.interactions?.length) return true;
    const sorted = [...r.interactions].sort((a, b) => b.date.localeCompare(a.date));
    const days = Math.floor((new Date(today) - new Date(sorted[0].date)) / (1000 * 60 * 60 * 24));
    return days >= (frequencyDays[r.contactFrequency] || 7);
  }).length;
  const totalInteractions = relationships.reduce((sum, r) => sum + (r.interactions?.length || 0), 0);

  // Personal tasks stats
  const personalTasks = data.personalTasks || [];
  const completedPersonal = personalTasks.filter(t => t.completed).length;
  const pendingPersonal = personalTasks.filter(t => !t.completed).length;
  const overduePersonal = personalTasks.filter(t => !t.completed && t.dueDate && t.dueDate < today).length;

  // Finances stats
  const transactions = data.finances?.transactions || [];
  const thisMonth = today.substring(0, 7);
  const monthExpenses = transactions.filter(t => t.date?.startsWith(thisMonth) && t.type === 'expense').reduce((s, t) => s + t.amount, 0);
  const monthIncome = transactions.filter(t => t.date?.startsWith(thisMonth) && t.type === 'income').reduce((s, t) => s + t.amount, 0);
  const monthlyBudget = data.finances?.monthlyBudget || 0;

  // Consciousness stats
  const cons = data.consciousness || {};
  const consXP = cons.totalXP || 0;
  const consLevel = (cons.startingLevel || 0) + (cons.currentLevel || 0);
  const consPractices = cons.practices?.length || 0;
  const consGratitudeCount = Object.keys(cons.gratitude || {}).length;

  // ===================== CATEGORY CARDS =====================
  const allCategories = [
    { id: 'entreno', areaId: 'workout', name: 'Entreno', icon: Dumbbell, color: 'violet', value: workoutsThisWeek, label: 'esta semana' },
    { id: 'nutricion', areaId: 'nutrition', name: 'Nutrici√≥n', icon: Utensils, color: 'orange', value: `${Math.round(avgCalories)}`, label: 'kcal/d√≠a avg' },
    { id: 'habitos', areaId: 'habits', name: 'H√°bitos', icon: CheckSquare, color: 'emerald', value: `${Math.round(habitCompletionRate)}%`, label: 'completado' },
    { id: 'cuerpo', areaId: 'body', name: 'Cuerpo', icon: Scale, color: 'teal', value: latestWeight?.weight || '-', label: 'kg actual' },
    { id: 'bienestar', areaId: null, name: 'Bienestar', icon: Moon, color: 'blue', value: avgSleep.toFixed(1), label: 'h sue√±o avg' },
    { id: 'relaciones', areaId: 'relationships', name: 'Relaciones', icon: Heart, color: 'pink', value: relationships.length, label: `${relNeedsAttention} pendientes` },
    { id: 'personal', areaId: 'personal', name: 'Personal', icon: Calendar, color: 'cyan', value: completedPersonal, label: `${pendingPersonal} pendientes` },
    { id: 'finanzas', areaId: 'finances', name: 'Finanzas', icon: Wallet, color: 'green', value: `${monthlyBudget > 0 ? Math.round((monthExpenses / monthlyBudget) * 100) : 0}%`, label: 'presupuesto' },
    { id: 'consciencia', areaId: 'consciousness', name: 'Consciencia', icon: Sparkles, color: 'purple', value: consXP, label: 'XP total' },
  ];

  // Filter categories by active areas (bienestar is always visible as it's general)
  const categories = allCategories.filter(cat => !cat.areaId || activeAreas.includes(cat.areaId));

  // ===================== RENDER: GENERAL VIEW =====================
  if (view === 'general') {
    return (
      <div className="space-y-4 pb-24">
        <AnimatedMount>
          <h1 className="text-2xl font-bold">Estad√≠sticas</h1>
          <p className="text-white/50 text-sm">Vista general</p>
        </AnimatedMount>

        {/* Today's Score */}
        <AnimatedMount delay={50}>
          <Card className="bg-gradient-to-r from-violet-500/20 to-fuchsia-500/20 border-violet-500/30">
            <div className="flex items-center gap-4">
              <DayScore score={dayScore} size="lg" />
              <div className="flex-1">
                <p className="font-medium">Score de hoy</p>
                <p className="text-sm text-white/50">
                  {dayScore >= 80 ? '¬°Excelente d√≠a!' : dayScore >= 60 ? 'Buen d√≠a' : dayScore >= 40 ? 'D√≠a normal' : 'Puedes mejorar'}
                </p>
              </div>
            </div>
            {scoreHistory.some(s => s > 0) && (
              <div className="mt-3 pt-3 border-t border-white/10">
                <p className="text-xs text-white/40 mb-2">√öltimos 7 d√≠as</p>
                <MiniChart data={scoreHistory} color="#8B5CF6" height={40} />
              </div>
            )}
          </Card>
        </AnimatedMount>

        {/* Category Cards */}
        <AnimatedMount delay={75}>
          <p className="text-sm text-white/60 mb-2">Categor√≠as</p>
          <div className="grid grid-cols-2 gap-3">
            {categories.map((cat, i) => (
              <Card
                key={cat.id}
                onClick={() => setView(cat.id)}
                className={`hover:bg-white/10 cursor-pointer`}
              >
                <div className="flex items-center gap-3">
                  <div className={`w-10 h-10 rounded-xl bg-${cat.color}-500/20 flex items-center justify-center`}>
                    <cat.icon className={`w-5 h-5 text-${cat.color}-400`} />
                  </div>
                  <div className="flex-1">
                    <p className="text-lg font-bold">{cat.value}</p>
                    <p className="text-xs text-white/40">{cat.label}</p>
                  </div>
                  <ChevronRight className="w-4 h-4 text-white/20" />
                </div>
              </Card>
            ))}
          </div>
        </AnimatedMount>

        {/* Quick Stats */}
        <AnimatedMount delay={100}>
          <Card>
            <p className="font-medium mb-3">Resumen general</p>
            <div className="space-y-2 text-sm">
              <div className="flex justify-between">
                <span className="text-white/60">D√≠as trackeados</span>
                <span className="font-medium">{Object.keys(data.days).length}</span>
              </div>
              {activeAreas.includes('workout') && (
                <div className="flex justify-between">
                  <span className="text-white/60">Entrenos completados</span>
                  <span className="font-medium">{completedWorkouts.length}</span>
                </div>
              )}
              {activeAreas.includes('habits') && (
                <div className="flex justify-between">
                  <span className="text-white/60">Mejor racha h√°bitos</span>
                  <span className="font-medium">{bestStreak} d√≠as üî•</span>
                </div>
              )}
              {activeAreas.includes('workout') && (
                <div className="flex justify-between">
                  <span className="text-white/60">Volumen total levantado</span>
                  <span className="font-medium">{totalVolume.toLocaleString()} kg</span>
                </div>
              )}
              {activeAreas.includes('relationships') && (
                <div className="flex justify-between">
                  <span className="text-white/60">Interacciones registradas</span>
                  <span className="font-medium">{totalInteractions}</span>
                </div>
              )}
              {activeAreas.includes('personal') && (
                <div className="flex justify-between">
                  <span className="text-white/60">Tareas completadas</span>
                  <span className="font-medium">{completedPersonal}</span>
                </div>
              )}
              {activeAreas.includes('consciousness') && (
                <div className="flex justify-between">
                  <span className="text-white/60">Pr√°cticas consciencia</span>
                  <span className="font-medium">{consPractices}</span>
                </div>
              )}
              {activeAreas.includes('consciousness') && (
                <div className="flex justify-between">
                  <span className="text-white/60">D√≠as de gratitud</span>
                  <span className="font-medium">{consGratitudeCount} üôè</span>
                </div>
              )}
            </div>
          </Card>
        </AnimatedMount>
      </div>
    );
  }

  // ===================== RENDER: ENTRENO STATS =====================
  if (view === 'entreno') {
    const prs = data.personalRecords || [];
    const uniqueExercises = [...new Set(prs.map(p => p.exerciseId || p.exercise))].filter(Boolean);

    return (
      <div className="space-y-4 pb-24">
        <AnimatedMount>
          <div className="flex items-center gap-3">
            <button onClick={() => setView('general')} className="p-2 hover:bg-white/10 rounded-lg">
              <ChevronLeft className="w-5 h-5" />
            </button>
            <div>
              <h1 className="text-2xl font-bold">Entreno</h1>
              <p className="text-white/50 text-sm">Estad√≠sticas detalladas</p>
            </div>
          </div>
        </AnimatedMount>

        {/* Main Stats */}
        <AnimatedMount delay={50}>
          <div className="grid grid-cols-2 gap-3">
            <Card className="bg-gradient-to-br from-violet-500/20 to-purple-500/20 border-violet-500/30">
              <p className="text-xs text-white/50">Esta semana</p>
              <p className="text-3xl font-bold">{workoutsThisWeek}</p>
              <p className="text-sm text-white/60">entrenos</p>
            </Card>
            <Card className="bg-gradient-to-br from-violet-500/20 to-purple-500/20 border-violet-500/30">
              <p className="text-xs text-white/50">Este mes</p>
              <p className="text-3xl font-bold">{workoutsThisMonth}</p>
              <p className="text-sm text-white/60">entrenos</p>
            </Card>
          </div>
        </AnimatedMount>

        {/* Volume */}
        <AnimatedMount delay={75}>
          <Card>
            <div className="flex items-center gap-2 mb-3">
              <TrendingUp className="w-4 h-4 text-violet-400" />
              <span className="font-medium">Volumen</span>
            </div>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <p className="text-2xl font-bold">{weeklyVolume.toLocaleString()}</p>
                <p className="text-xs text-white/40">kg esta semana</p>
              </div>
              <div>
                <p className="text-2xl font-bold">{totalVolume.toLocaleString()}</p>
                <p className="text-xs text-white/40">kg total</p>
              </div>
            </div>
          </Card>
        </AnimatedMount>

        {/* PRs */}
        {uniqueExercises.length > 0 && (
          <AnimatedMount delay={100}>
            <Card>
              <div className="flex items-center gap-2 mb-3">
                <Trophy className="w-4 h-4 text-yellow-400" />
                <span className="font-medium">Personal Records</span>
              </div>
              <div className="space-y-2">
                {uniqueExercises.slice(0, 8).map(exId => {
                  const pr = prs.filter(p => (p.exerciseId || p.exercise) === exId).sort((a, b) => (b.weight || 0) - (a.weight || 0))[0];
                  const exercise = getExerciseById(exId);
                  return (
                    <div key={exId} className="flex items-center justify-between p-2 bg-white/5 rounded-lg">
                      <div>
                        <p className="text-sm">{exercise?.name || pr?.exerciseName || pr?.exercise || exId}</p>
                        {pr?.date && <p className="text-xs text-white/40">{formatShortDate(pr.date)}</p>}
                      </div>
                      <div className="text-right">
                        <p className="font-bold text-yellow-400">{pr?.weight}kg x{pr?.reps}</p>
                        {pr?.estimated1RM && <p className="text-xs text-white/40">~{pr.estimated1RM}kg 1RM</p>}
                      </div>
                    </div>
                  );
                })}
              </div>
            </Card>
          </AnimatedMount>
        )}

        {completedWorkouts.length === 0 && (
          <EmptyState icon={Dumbbell} title="Sin datos" description="Completa entrenos para ver estad√≠sticas" />
        )}
      </div>
    );
  }

  // ===================== RENDER: NUTRICION STATS =====================
  if (view === 'nutricion') {
    const calorieHistory = last7Days.map(d => data.meals.filter(m => m.day_id === d).reduce((s, m) => s + (m.calories || 0), 0)).reverse();
    const proteinHistory = last7Days.map(d => data.meals.filter(m => m.day_id === d).reduce((s, m) => s + (m.protein || 0), 0)).reverse();

    return (
      <div className="space-y-4 pb-24">
        <AnimatedMount>
          <div className="flex items-center gap-3">
            <button onClick={() => setView('general')} className="p-2 hover:bg-white/10 rounded-lg">
              <ChevronLeft className="w-5 h-5" />
            </button>
            <div>
              <h1 className="text-2xl font-bold">Nutrici√≥n</h1>
              <p className="text-white/50 text-sm">Estad√≠sticas detalladas</p>
            </div>
          </div>
        </AnimatedMount>

        {/* Averages */}
        <AnimatedMount delay={50}>
          <div className="grid grid-cols-2 gap-3">
            <Card className="bg-gradient-to-br from-orange-500/20 to-red-500/20 border-orange-500/30">
              <Flame className="w-5 h-5 text-orange-400 mb-2" />
              <p className="text-2xl font-bold">{Math.round(avgCalories)}</p>
              <p className="text-xs text-white/40">kcal/d√≠a promedio</p>
            </Card>
            <Card className="bg-gradient-to-br from-emerald-500/20 to-green-500/20 border-emerald-500/30">
              <Zap className="w-5 h-5 text-emerald-400 mb-2" />
              <p className="text-2xl font-bold">{Math.round(avgProtein)}g</p>
              <p className="text-xs text-white/40">prote√≠na/d√≠a promedio</p>
            </Card>
          </div>
        </AnimatedMount>

        {/* Adherence */}
        <AnimatedMount delay={75}>
          <Card>
            <div className="flex items-center justify-between mb-2">
              <span className="font-medium">Adherencia prote√≠na</span>
              <span className={`font-bold ${proteinAdherence >= 80 ? 'text-emerald-400' : proteinAdherence >= 50 ? 'text-yellow-400' : 'text-red-400'}`}>
                {proteinAdherence}%
              </span>
            </div>
            <ProgressBar value={proteinAdherence} max={100} color={proteinAdherence >= 80 ? 'bg-emerald-500' : proteinAdherence >= 50 ? 'bg-yellow-500' : 'bg-red-500'} />
            <p className="text-xs text-white/40 mt-2">Objetivo: {data.user.goals?.protein || 0}g/d√≠a</p>
          </Card>
        </AnimatedMount>

        {/* Charts */}
        {calorieHistory.some(c => c > 0) && (
          <AnimatedMount delay={100}>
            <Card>
              <p className="font-medium mb-2">Calor√≠as √∫ltimos 7 d√≠as</p>
              <MiniChart data={calorieHistory} color="#F97316" height={60} />
            </Card>
          </AnimatedMount>
        )}

        {data.meals.length === 0 && (
          <EmptyState icon={Utensils} title="Sin datos" description="Registra comidas para ver estad√≠sticas" />
        )}
      </div>
    );
  }

  // ===================== RENDER: HABITOS STATS =====================
  if (view === 'habitos') {
    return (
      <div className="space-y-4 pb-24">
        <AnimatedMount>
          <div className="flex items-center gap-3">
            <button onClick={() => setView('general')} className="p-2 hover:bg-white/10 rounded-lg">
              <ChevronLeft className="w-5 h-5" />
            </button>
            <div>
              <h1 className="text-2xl font-bold">H√°bitos</h1>
              <p className="text-white/50 text-sm">Estad√≠sticas detalladas</p>
            </div>
          </div>
        </AnimatedMount>

        {/* Main Stats */}
        <AnimatedMount delay={50}>
          <div className="grid grid-cols-2 gap-3">
            <Card className="bg-gradient-to-br from-emerald-500/20 to-green-500/20 border-emerald-500/30 text-center">
              <p className="text-3xl font-bold">{Math.round(habitCompletionRate)}%</p>
              <p className="text-xs text-white/40">completado 7 d√≠as</p>
            </Card>
            <Card className="bg-gradient-to-br from-orange-500/20 to-yellow-500/20 border-orange-500/30 text-center">
              <p className="text-3xl font-bold">{bestStreak}</p>
              <p className="text-xs text-white/40">mejor racha üî•</p>
            </Card>
          </div>
        </AnimatedMount>

        {/* Per Habit Stats */}
        {data.habits.length > 0 && (
          <AnimatedMount delay={75}>
            <Card>
              <p className="font-medium mb-3">Por h√°bito</p>
              <div className="space-y-3">
                {data.habits.map(habit => {
                  const streak = getHabitStreak(habit.id, data.habitLogs || [], today);
                  const completedDays = last30Days.filter(d =>
                    data.habitLogs?.find(l => l.habit_id === habit.id && l.date === d && l.completed)
                  ).length;
                  const rate = Math.round((completedDays / 30) * 100);

                  return (
                    <div key={habit.id} className="p-3 bg-white/5 rounded-xl">
                      <div className="flex items-center justify-between mb-2">
                        <div className="flex items-center gap-2">
                          <span>{habit.icon}</span>
                          <span className="text-sm font-medium">{habit.name}</span>
                        </div>
                        {streak > 0 && <span className="text-xs text-orange-400">{streak} üî•</span>}
                      </div>
                      <div className="flex items-center gap-3">
                        <ProgressBar value={rate} max={100} color="bg-emerald-500" height="h-1.5" />
                        <span className="text-xs text-white/60 w-12 text-right">{rate}%</span>
                      </div>
                    </div>
                  );
                })}
              </div>
            </Card>
          </AnimatedMount>
        )}

        {data.habits.length === 0 && (
          <EmptyState icon={CheckSquare} title="Sin h√°bitos" description="Crea h√°bitos para ver estad√≠sticas" />
        )}
      </div>
    );
  }

  // ===================== RENDER: CUERPO STATS =====================
  if (view === 'cuerpo') {
    return (
      <div className="space-y-4 pb-24">
        <AnimatedMount>
          <div className="flex items-center gap-3">
            <button onClick={() => setView('general')} className="p-2 hover:bg-white/10 rounded-lg">
              <ChevronLeft className="w-5 h-5" />
            </button>
            <div>
              <h1 className="text-2xl font-bold">Cuerpo</h1>
              <p className="text-white/50 text-sm">Estad√≠sticas detalladas</p>
            </div>
          </div>
        </AnimatedMount>

        {latestWeight ? (
          <>
            {/* Current */}
            <AnimatedMount delay={50}>
              <Card className="bg-gradient-to-br from-teal-500/20 to-emerald-500/20 border-teal-500/30">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-xs text-white/50">Peso actual</p>
                    <p className="text-4xl font-bold">{latestWeight.weight} kg</p>
                    <p className="text-xs text-white/40">{formatShortDate(latestWeight.date)}</p>
                  </div>
                  {weightChange && (
                    <div className="text-right">
                      <p className="text-xs text-white/50">Cambio total</p>
                      <p className={`text-2xl font-bold ${parseFloat(weightChange) < 0 ? 'text-emerald-400' : parseFloat(weightChange) > 0 ? 'text-red-400' : 'text-white/60'}`}>
                        {parseFloat(weightChange) > 0 ? '+' : ''}{weightChange} kg
                      </p>
                    </div>
                  )}
                </div>
              </Card>
            </AnimatedMount>

            {/* Chart */}
            {weights.length > 1 && (
              <AnimatedMount delay={75}>
                <Card>
                  <p className="font-medium mb-3">Evoluci√≥n</p>
                  <MiniChart data={weights.slice(-30)} color="#14B8A6" height={100} />
                  <div className="flex justify-between text-xs text-white/40 mt-2">
                    <span>Min: {Math.min(...weights).toFixed(1)} kg</span>
                    <span>Max: {Math.max(...weights).toFixed(1)} kg</span>
                  </div>
                </Card>
              </AnimatedMount>
            )}
          </>
        ) : (
          <EmptyState icon={Scale} title="Sin datos" description="Registra tu peso para ver estad√≠sticas" action="Ir a Cuerpo" onAction={() => setScreen('body')} />
        )}
      </div>
    );
  }

  // ===================== RENDER: BIENESTAR STATS =====================
  if (view === 'bienestar') {
    const moodData = last7Days.map(d => data.journals?.find(j => j.date === d)?.mood || 0).reverse();
    const avgMood = moodData.filter(m => m > 0).reduce((s, m) => s + m, 0) / (moodData.filter(m => m > 0).length || 1);
    const moodEmojis = ['', 'üò´', 'üòî', 'üòê', 'üôÇ', 'üòÑ'];

    return (
      <div className="space-y-4 pb-24">
        <AnimatedMount>
          <div className="flex items-center gap-3">
            <button onClick={() => setView('general')} className="p-2 hover:bg-white/10 rounded-lg">
              <ChevronLeft className="w-5 h-5" />
            </button>
            <div>
              <h1 className="text-2xl font-bold">Bienestar</h1>
              <p className="text-white/50 text-sm">Estad√≠sticas detalladas</p>
            </div>
          </div>
        </AnimatedMount>

        {/* Sleep & Energy */}
        <AnimatedMount delay={50}>
          <div className="grid grid-cols-2 gap-3">
            <Card className="bg-gradient-to-br from-blue-500/20 to-indigo-500/20 border-blue-500/30">
              <Moon className="w-5 h-5 text-blue-400 mb-2" />
              <p className="text-2xl font-bold">{avgSleep.toFixed(1)}h</p>
              <p className="text-xs text-white/40">sue√±o promedio</p>
            </Card>
            <Card className="bg-gradient-to-br from-yellow-500/20 to-orange-500/20 border-yellow-500/30">
              <Zap className="w-5 h-5 text-yellow-400 mb-2" />
              <p className="text-2xl font-bold">{avgEnergy.toFixed(1)}/5</p>
              <p className="text-xs text-white/40">energ√≠a promedio</p>
            </Card>
          </div>
        </AnimatedMount>

        {/* Sleep Chart */}
        {sleepData.some(s => s > 0) && (
          <AnimatedMount delay={75}>
            <Card>
              <p className="font-medium mb-2">Sue√±o √∫ltimos 7 d√≠as</p>
              <MiniChart data={sleepData} color="#3B82F6" height={60} />
              <p className="text-xs text-white/40 mt-2">Objetivo: {data.user.goals?.sleep || 8}h</p>
            </Card>
          </AnimatedMount>
        )}

        {/* Mood */}
        {moodData.some(m => m > 0) && (
          <AnimatedMount delay={100}>
            <Card>
              <p className="font-medium mb-3">Estado de √°nimo</p>
              <div className="flex items-center justify-center gap-2 text-3xl mb-2">
                {moodEmojis[Math.round(avgMood)] || 'üòê'}
              </div>
              <p className="text-center text-sm text-white/60">Promedio: {avgMood.toFixed(1)}/5</p>
            </Card>
          </AnimatedMount>
        )}
      </div>
    );
  }

  // Fallback
  return null;
};

// ============================================================================
// RELATIONSHIPS SCREEN - Gesti√≥n de Relaciones Personales
// ============================================================================
const RelationshipsScreen = ({ data, setData, showToast }) => {
  const today = getToday();
  const [view, setView] = useState('dashboard'); // dashboard, list, add, detail
  const [selectedCategory, setSelectedCategory] = useState('all');
  const [selectedRelation, setSelectedRelation] = useState(null);
  const [showAddModal, setShowAddModal] = useState(false);
  const [showInteractionModal, setShowInteractionModal] = useState(false);

  // Form state
  const [newRelation, setNewRelation] = useState({
    name: '',
    category: 'friends',
    photo: '',
    loveLanguage: '',
    contactFrequency: 'weekly',
    birthday: '',
    anniversary: '',
    notes: '',
    interests: '',
    pendingTopics: ''
  });

  const [newInteraction, setNewInteraction] = useState({
    type: 'call',
    notes: '',
    quality: 3
  });

  // Categories
  const categories = [
    { id: 'partner', name: 'Pareja', icon: 'üíë', color: '#EC4899', description: 'Relaci√≥n rom√°ntica' },
    { id: 'family', name: 'Familia', icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', color: '#F59E0B', description: 'Padres, hermanos, hijos' },
    { id: 'friends', name: 'Amigos', icon: 'üë•', color: '#3B82F6', description: 'C√≠rculo cercano' },
    { id: 'professional', name: 'Profesional', icon: 'ü§ù', color: '#8B5CF6', description: 'Colegas, mentores' },
    { id: 'community', name: 'Comunidad', icon: 'üå±', color: '#10B981', description: 'Conocidos, grupos' }
  ];

  // Love languages
  const loveLanguages = [
    { id: 'words', name: 'Palabras de afirmaci√≥n', icon: 'üí¨', description: 'Cumplidos, reconocimiento verbal' },
    { id: 'time', name: 'Tiempo de calidad', icon: '‚è∞', description: 'Atenci√≥n plena, presencia' },
    { id: 'gifts', name: 'Regalos', icon: 'üéÅ', description: 'Detalles significativos' },
    { id: 'service', name: 'Actos de servicio', icon: 'üõ†Ô∏è', description: 'Ayudar, hacer cosas' },
    { id: 'touch', name: 'Contacto f√≠sico', icon: 'ü§ó', description: 'Abrazos, cercan√≠a' }
  ];

  // Contact frequencies
  const frequencies = [
    { id: 'daily', name: 'Diario', days: 1 },
    { id: 'weekly', name: 'Semanal', days: 7 },
    { id: 'biweekly', name: 'Quincenal', days: 14 },
    { id: 'monthly', name: 'Mensual', days: 30 },
    { id: 'quarterly', name: 'Trimestral', days: 90 }
  ];

  // Interaction types
  const interactionTypes = [
    { id: 'call', name: 'Llamada', icon: 'üìû' },
    { id: 'video', name: 'Videollamada', icon: 'üìπ' },
    { id: 'message', name: 'Mensaje', icon: 'üí¨' },
    { id: 'inperson', name: 'En persona', icon: 'ü§ù' },
    { id: 'activity', name: 'Actividad', icon: 'üéØ' },
    { id: 'gift', name: 'Regalo', icon: 'üéÅ' }
  ];

  // Initialize data
  const relationships = data.relationships || [];

  // Helpers
  const getCat = (id) => categories.find(c => c.id === id) || categories[2];
  const getLang = (id) => loveLanguages.find(l => l.id === id);
  const getFreq = (id) => frequencies.find(f => f.id === id) || frequencies[1];

  // Calculate days since last contact
  const daysSinceContact = (relation) => {
    if (!relation.interactions?.length) return null;
    const lastInteraction = relation.interactions.sort((a, b) => b.date.localeCompare(a.date))[0];
    const diff = Math.floor((new Date(today) - new Date(lastInteraction.date)) / (1000 * 60 * 60 * 24));
    return diff;
  };

  // Check if needs attention
  const needsAttention = (relation) => {
    const days = daysSinceContact(relation);
    if (days === null) return true;
    const freq = getFreq(relation.contactFrequency);
    return days >= freq.days;
  };

  // Get health score (1-5)
  const getHealthScore = (relation) => {
    const days = daysSinceContact(relation);
    if (days === null) return 1;
    const freq = getFreq(relation.contactFrequency);
    const ratio = days / freq.days;
    if (ratio <= 0.5) return 5;
    if (ratio <= 1) return 4;
    if (ratio <= 1.5) return 3;
    if (ratio <= 2) return 2;
    return 1;
  };

  // Upcoming birthdays
  const getUpcomingBirthdays = () => {
    const todayDate = new Date(today);
    return relationships
      .filter(r => r.birthday)
      .map(r => {
        const bday = new Date(r.birthday);
        bday.setFullYear(todayDate.getFullYear());
        if (bday < todayDate) bday.setFullYear(todayDate.getFullYear() + 1);
        const daysUntil = Math.floor((bday - todayDate) / (1000 * 60 * 60 * 24));
        return { ...r, daysUntil, nextBirthday: bday.toISOString().split('T')[0] };
      })
      .filter(r => r.daysUntil <= 30)
      .sort((a, b) => a.daysUntil - b.daysUntil);
  };

  // Filter relations
  const filteredRelations = selectedCategory === 'all'
    ? relationships
    : relationships.filter(r => r.category === selectedCategory);

  // Relations needing attention
  const attentionNeeded = relationships.filter(needsAttention);

  // Stats
  const stats = {
    total: relationships.length,
    partner: relationships.filter(r => r.category === 'partner').length,
    family: relationships.filter(r => r.category === 'family').length,
    friends: relationships.filter(r => r.category === 'friends').length,
    professional: relationships.filter(r => r.category === 'professional').length,
    needAttention: attentionNeeded.length
  };

  // Actions
  const addRelation = () => {
    if (!newRelation.name.trim()) return;
    const relation = {
      id: crypto.randomUUID(),
      ...newRelation,
      interactions: [],
      healthRating: 3,
      createdAt: new Date().toISOString()
    };
    setData(prev => ({
      ...prev,
      relationships: [...(prev.relationships || []), relation]
    }));
    setNewRelation({
      name: '', category: 'friends', photo: '', loveLanguage: '',
      contactFrequency: 'weekly', birthday: '', anniversary: '',
      notes: '', interests: '', pendingTopics: ''
    });
    setShowAddModal(false);
    showToast('üë§ Relaci√≥n a√±adida');
  };

  const updateRelation = (id, updates) => {
    setData(prev => ({
      ...prev,
      relationships: prev.relationships.map(r => r.id === id ? { ...r, ...updates } : r)
    }));
  };

  const deleteRelation = (id) => {
    setData(prev => ({
      ...prev,
      relationships: prev.relationships.filter(r => r.id !== id)
    }));
    setSelectedRelation(null);
    setView('list');
    showToast('Relaci√≥n eliminada');
  };

  const addInteraction = (relationId) => {
    const interaction = {
      id: crypto.randomUUID(),
      date: today,
      ...newInteraction,
      timestamp: new Date().toISOString()
    };
    setData(prev => ({
      ...prev,
      relationships: prev.relationships.map(r =>
        r.id === relationId
          ? { ...r, interactions: [...(r.interactions || []), interaction] }
          : r
      )
    }));
    setNewInteraction({ type: 'call', notes: '', quality: 3 });
    setShowInteractionModal(false);
    showToast('‚úì Interacci√≥n registrada');
  };

  return (
    <div className="pb-24">
      {/* Header */}
      <AnimatedMount>
        <div className="flex items-center justify-between mb-6">
          <div>
            <h1 className="text-2xl font-bold">Relaciones</h1>
            <p className="text-white/50 text-sm">Cultiva tus conexiones</p>
          </div>
          <button
            onClick={() => setShowAddModal(true)}
            className="p-3 bg-pink-500 rounded-xl"
          >
            <Plus className="w-5 h-5" />
          </button>
        </div>
      </AnimatedMount>

      {/* View Toggle */}
      <AnimatedMount delay={25}>
        <div className="flex bg-white/10 rounded-xl p-1 mb-4">
          <button
            onClick={() => setView('dashboard')}
            className={`flex-1 py-2 rounded-lg text-sm font-medium transition-all ${view === 'dashboard' ? 'bg-pink-500' : ''}`}
          >
            Dashboard
          </button>
          <button
            onClick={() => setView('list')}
            className={`flex-1 py-2 rounded-lg text-sm font-medium transition-all ${view === 'list' ? 'bg-pink-500' : ''}`}
          >
            Personas
          </button>
        </div>
      </AnimatedMount>

      {/* DASHBOARD VIEW */}
      {view === 'dashboard' && (
        <div className="space-y-4">
          {/* Quick Stats */}
          <AnimatedMount delay={50}>
            <div className="grid grid-cols-3 gap-3">
              <Card className="text-center py-3">
                <p className="text-2xl font-bold">{stats.total}</p>
                <p className="text-xs text-white/40">relaciones</p>
              </Card>
              <Card className="text-center py-3">
                <p className="text-2xl font-bold text-amber-400">{stats.needAttention}</p>
                <p className="text-xs text-white/40">necesitan atenci√≥n</p>
              </Card>
              <Card className="text-center py-3">
                <p className="text-2xl font-bold text-pink-400">{getUpcomingBirthdays().length}</p>
                <p className="text-xs text-white/40">cumples pr√≥ximos</p>
              </Card>
            </div>
          </AnimatedMount>

          {/* Needs Attention */}
          {attentionNeeded.length > 0 && (
            <AnimatedMount delay={75}>
              <Card>
                <p className="font-medium mb-3 flex items-center gap-2">
                  <span className="text-amber-400">‚ö†Ô∏è</span> Necesitan atenci√≥n
                </p>
                <div className="space-y-2">
                  {attentionNeeded.slice(0, 5).map(relation => {
                    const cat = getCat(relation.category);
                    const days = daysSinceContact(relation);
                    return (
                      <div
                        key={relation.id}
                        onClick={() => { setSelectedRelation(relation); setView('detail'); }}
                        className="flex items-center justify-between p-2 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10"
                      >
                        <div className="flex items-center gap-3">
                          <div className="w-10 h-10 rounded-full flex items-center justify-center text-lg" style={{ backgroundColor: cat.color + '30' }}>
                            {relation.photo ? 'üë§' : cat.icon}
                          </div>
                          <div>
                            <p className="font-medium text-sm">{relation.name}</p>
                            <p className="text-xs text-white/40">
                              {days === null ? 'Sin contacto registrado' : `Hace ${days} d√≠as`}
                            </p>
                          </div>
                        </div>
                        <ChevronRight className="w-4 h-4 text-white/30" />
                      </div>
                    );
                  })}
                </div>
              </Card>
            </AnimatedMount>
          )}

          {/* Upcoming Birthdays */}
          {getUpcomingBirthdays().length > 0 && (
            <AnimatedMount delay={100}>
              <Card>
                <p className="font-medium mb-3 flex items-center gap-2">
                  <span>üéÇ</span> Cumplea√±os pr√≥ximos
                </p>
                <div className="space-y-2">
                  {getUpcomingBirthdays().map(relation => (
                    <div
                      key={relation.id}
                      className="flex items-center justify-between p-2 bg-white/5 rounded-lg"
                    >
                      <div className="flex items-center gap-3">
                        <div className="w-8 h-8 rounded-full bg-pink-500/20 flex items-center justify-center">
                          üéÇ
                        </div>
                        <div>
                          <p className="font-medium text-sm">{relation.name}</p>
                          <p className="text-xs text-white/40">
                            {new Date(relation.nextBirthday).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' })}
                          </p>
                        </div>
                      </div>
                      <span className={`text-xs px-2 py-1 rounded-full ${relation.daysUntil === 0 ? 'bg-pink-500 text-white' :
                        relation.daysUntil <= 7 ? 'bg-amber-500/20 text-amber-400' :
                          'bg-white/10 text-white/60'
                        }`}>
                        {relation.daysUntil === 0 ? '¬°Hoy!' :
                          relation.daysUntil === 1 ? 'Ma√±ana' :
                            `En ${relation.daysUntil} d√≠as`}
                      </span>
                    </div>
                  ))}
                </div>
              </Card>
            </AnimatedMount>
          )}

          {/* Categories Overview */}
          <AnimatedMount delay={125}>
            <Card>
              <p className="font-medium mb-3">Por categor√≠a</p>
              <div className="space-y-2">
                {categories.map(cat => {
                  const count = relationships.filter(r => r.category === cat.id).length;
                  const needsAtt = relationships.filter(r => r.category === cat.id && needsAttention(r)).length;
                  return (
                    <div
                      key={cat.id}
                      onClick={() => { setSelectedCategory(cat.id); setView('list'); }}
                      className="flex items-center justify-between p-3 bg-white/5 rounded-xl cursor-pointer hover:bg-white/10"
                    >
                      <div className="flex items-center gap-3">
                        <div className="w-10 h-10 rounded-xl flex items-center justify-center text-xl" style={{ backgroundColor: cat.color + '20' }}>
                          {cat.icon}
                        </div>
                        <div>
                          <p className="font-medium">{cat.name}</p>
                          <p className="text-xs text-white/40">{cat.description}</p>
                        </div>
                      </div>
                      <div className="text-right">
                        <p className="font-bold">{count}</p>
                        {needsAtt > 0 && (
                          <p className="text-xs text-amber-400">{needsAtt} pendiente{needsAtt > 1 ? 's' : ''}</p>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>
            </Card>
          </AnimatedMount>

          {/* Empty State */}
          {relationships.length === 0 && (
            <AnimatedMount delay={75}>
              <Card className="text-center py-12">
                <div className="text-5xl mb-4">üë•</div>
                <p className="text-white/60 mb-2">Sin relaciones registradas</p>
                <p className="text-xs text-white/40 mb-4">A√±ade a las personas importantes en tu vida</p>
                <button
                  onClick={() => setShowAddModal(true)}
                  className="px-6 py-2 bg-pink-500 rounded-xl font-medium"
                >
                  A√±adir primera relaci√≥n
                </button>
              </Card>
            </AnimatedMount>
          )}
        </div>
      )}

      {/* LIST VIEW */}
      {view === 'list' && (
        <div className="space-y-4">
          {/* Category Filter */}
          <AnimatedMount delay={50}>
            <div className="flex gap-2 overflow-x-auto pb-2" style={{ scrollbarWidth: 'none' }}>
              <button
                onClick={() => setSelectedCategory('all')}
                className={`px-4 py-2 rounded-xl text-sm whitespace-nowrap transition-all ${selectedCategory === 'all' ? 'bg-pink-500' : 'bg-white/10'
                  }`}
              >
                Todos ({relationships.length})
              </button>
              {categories.map(cat => {
                const count = relationships.filter(r => r.category === cat.id).length;
                return (
                  <button
                    key={cat.id}
                    onClick={() => setSelectedCategory(cat.id)}
                    className={`px-4 py-2 rounded-xl text-sm whitespace-nowrap transition-all flex items-center gap-2 ${selectedCategory === cat.id ? 'bg-pink-500' : 'bg-white/10'
                      }`}
                  >
                    <span>{cat.icon}</span>
                    <span>{count}</span>
                  </button>
                );
              })}
            </div>
          </AnimatedMount>

          {/* Relations List */}
          <div className="space-y-2">
            {filteredRelations.length > 0 ? (
              filteredRelations
                .sort((a, b) => {
                  // Sort by needs attention first, then alphabetically
                  const aNeeds = needsAttention(a);
                  const bNeeds = needsAttention(b);
                  if (aNeeds && !bNeeds) return -1;
                  if (!aNeeds && bNeeds) return 1;
                  return a.name.localeCompare(b.name);
                })
                .map((relation, idx) => {
                  const cat = getCat(relation.category);
                  const days = daysSinceContact(relation);
                  const health = getHealthScore(relation);
                  const needs = needsAttention(relation);

                  return (
                    <AnimatedMount key={relation.id} delay={75 + idx * 25}>
                      <Card
                        className={`cursor-pointer hover:bg-white/10 transition-all ${needs ? 'border-amber-500/30' : ''}`}
                        onClick={() => { setSelectedRelation(relation); setView('detail'); }}
                      >
                        <div className="flex items-center gap-3">
                          <div
                            className="w-12 h-12 rounded-full flex items-center justify-center text-xl shrink-0"
                            style={{ backgroundColor: cat.color + '30' }}
                          >
                            {cat.icon}
                          </div>
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2">
                              <p className="font-medium truncate">{relation.name}</p>
                              {needs && <span className="text-amber-400 text-xs">‚ö†Ô∏è</span>}
                            </div>
                            <p className="text-xs text-white/40">
                              {days === null ? 'Sin contacto' : `√öltimo contacto hace ${days} d√≠as`}
                            </p>
                          </div>
                          <div className="flex items-center gap-1 shrink-0">
                            {[1, 2, 3, 4, 5].map(i => (
                              <div
                                key={i}
                                className={`w-1.5 h-4 rounded-full ${i <= health ? 'bg-pink-500' : 'bg-white/10'}`}
                              />
                            ))}
                          </div>
                        </div>
                      </Card>
                    </AnimatedMount>
                  );
                })
            ) : (
              <AnimatedMount delay={75}>
                <Card className="text-center py-8">
                  <p className="text-white/40">No hay relaciones en esta categor√≠a</p>
                </Card>
              </AnimatedMount>
            )}
          </div>
        </div>
      )}

      {/* DETAIL VIEW */}
      {view === 'detail' && selectedRelation && (() => {
        const relation = selectedRelation;
        const cat = getCat(relation.category);
        const lang = getLang(relation.loveLanguage);
        const freq = getFreq(relation.contactFrequency);
        const days = daysSinceContact(relation);
        const health = getHealthScore(relation);
        const interactions = (relation.interactions || []).sort((a, b) => b.date.localeCompare(a.date));

        return (
          <div className="space-y-4">
            <AnimatedMount>
              <button
                onClick={() => { setView('list'); setSelectedRelation(null); }}
                className="flex items-center gap-2 text-white/60 hover:text-white mb-2"
              >
                <ChevronLeft className="w-4 h-4" /> Volver
              </button>
            </AnimatedMount>

            {/* Header Card */}
            <AnimatedMount delay={25}>
              <Card className="text-center" style={{ background: `linear-gradient(135deg, ${cat.color}20, ${cat.color}05)` }}>
                <div
                  className="w-20 h-20 rounded-full mx-auto mb-3 flex items-center justify-center text-3xl"
                  style={{ backgroundColor: cat.color + '30' }}
                >
                  {cat.icon}
                </div>
                <h2 className="text-xl font-bold mb-1">{relation.name}</h2>
                <p className="text-sm text-white/50">{cat.name}</p>

                {/* Health indicator */}
                <div className="flex items-center justify-center gap-1 mt-3">
                  {[1, 2, 3, 4, 5].map(i => (
                    <div
                      key={i}
                      className={`w-3 h-6 rounded-full ${i <= health ? 'bg-pink-500' : 'bg-white/10'}`}
                    />
                  ))}
                </div>
                <p className="text-xs text-white/40 mt-1">
                  {days === null ? 'Sin contacto registrado' :
                    days === 0 ? 'Contacto hoy' :
                      `Hace ${days} d√≠as`}
                </p>
              </Card>
            </AnimatedMount>

            {/* Quick Actions */}
            <AnimatedMount delay={50}>
              <div className="flex gap-2">
                <button
                  onClick={() => setShowInteractionModal(true)}
                  className="flex-1 py-3 bg-pink-500 rounded-xl font-medium flex items-center justify-center gap-2"
                >
                  <Plus className="w-4 h-4" /> Registrar contacto
                </button>
              </div>
            </AnimatedMount>

            {/* Info Cards */}
            <AnimatedMount delay={75}>
              <div className="grid grid-cols-2 gap-3">
                {lang && (
                  <Card className="py-3">
                    <p className="text-xs text-white/40 mb-1">Lenguaje de amor</p>
                    <p className="text-lg">{lang.icon}</p>
                    <p className="text-xs font-medium">{lang.name}</p>
                  </Card>
                )}
                <Card className="py-3">
                  <p className="text-xs text-white/40 mb-1">Frecuencia ideal</p>
                  <p className="text-sm font-medium">{freq.name}</p>
                </Card>
                {relation.birthday && (
                  <Card className="py-3">
                    <p className="text-xs text-white/40 mb-1">Cumplea√±os</p>
                    <p className="text-sm font-medium">
                      {new Date(relation.birthday).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' })}
                    </p>
                  </Card>
                )}
                {relation.anniversary && (
                  <Card className="py-3">
                    <p className="text-xs text-white/40 mb-1">Aniversario</p>
                    <p className="text-sm font-medium">
                      {new Date(relation.anniversary).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' })}
                    </p>
                  </Card>
                )}
              </div>
            </AnimatedMount>

            {/* Notes & Interests */}
            {(relation.notes || relation.interests || relation.pendingTopics) && (
              <AnimatedMount delay={100}>
                <Card>
                  {relation.interests && (
                    <div className="mb-3">
                      <p className="text-xs text-white/40 mb-1">Intereses</p>
                      <p className="text-sm">{relation.interests}</p>
                    </div>
                  )}
                  {relation.pendingTopics && (
                    <div className="mb-3">
                      <p className="text-xs text-white/40 mb-1">Temas pendientes</p>
                      <p className="text-sm">{relation.pendingTopics}</p>
                    </div>
                  )}
                  {relation.notes && (
                    <div>
                      <p className="text-xs text-white/40 mb-1">Notas</p>
                      <p className="text-sm">{relation.notes}</p>
                    </div>
                  )}
                </Card>
              </AnimatedMount>
            )}

            {/* Interaction History */}
            <AnimatedMount delay={125}>
              <Card>
                <p className="font-medium mb-3">Historial de contacto</p>
                {interactions.length > 0 ? (
                  <div className="space-y-2 max-h-60 overflow-y-auto">
                    {interactions.map(int => {
                      const type = interactionTypes.find(t => t.id === int.type);
                      return (
                        <div key={int.id} className="flex items-start gap-3 p-2 bg-white/5 rounded-lg">
                          <div className="w-8 h-8 rounded-lg bg-pink-500/20 flex items-center justify-center shrink-0">
                            {type?.icon || 'üìù'}
                          </div>
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center justify-between">
                              <p className="text-sm font-medium">{type?.name || 'Contacto'}</p>
                              <p className="text-xs text-white/40">{formatShortDate(int.date)}</p>
                            </div>
                            {int.notes && <p className="text-xs text-white/60 mt-1">{int.notes}</p>}
                            <div className="flex gap-0.5 mt-1">
                              {[1, 2, 3, 4, 5].map(i => (
                                <Star key={i} className={`w-3 h-3 ${i <= int.quality ? 'text-amber-400 fill-amber-400' : 'text-white/20'}`} />
                              ))}
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                ) : (
                  <p className="text-center text-white/40 py-4">Sin interacciones registradas</p>
                )}
              </Card>
            </AnimatedMount>

            {/* Delete button */}
            <AnimatedMount delay={150}>
              <button
                onClick={() => {
                  if (confirm('¬øEliminar esta relaci√≥n?')) deleteRelation(relation.id);
                }}
                className="w-full py-2 text-red-400 text-sm"
              >
                Eliminar relaci√≥n
              </button>
            </AnimatedMount>
          </div>
        );
      })()}

      {/* ADD MODAL */}
      <Modal isOpen={showAddModal} onClose={() => setShowAddModal(false)} title="Nueva Relaci√≥n">
        <div className="space-y-4">
          <div>
            <label className="text-sm text-white/50 mb-1 block">Nombre *</label>
            <input
              type="text"
              value={newRelation.name}
              onChange={(e) => setNewRelation(prev => ({ ...prev, name: e.target.value }))}
              placeholder="Nombre de la persona"
              className="w-full bg-white/5 rounded-xl px-4 py-3"
            />
          </div>

          <div>
            <label className="text-sm text-white/50 mb-2 block">Categor√≠a</label>
            <div className="grid grid-cols-3 gap-2">
              {categories.map(cat => (
                <button
                  key={cat.id}
                  onClick={() => setNewRelation(prev => ({ ...prev, category: cat.id }))}
                  className={`p-3 rounded-xl text-center transition-all ${newRelation.category === cat.id ? 'bg-pink-500' : 'bg-white/5'
                    }`}
                >
                  <div className="text-xl mb-1">{cat.icon}</div>
                  <p className="text-xs">{cat.name}</p>
                </button>
              ))}
            </div>
          </div>

          <div>
            <label className="text-sm text-white/50 mb-2 block">Lenguaje de amor</label>
            <div className="grid grid-cols-5 gap-2">
              {loveLanguages.map(lang => (
                <button
                  key={lang.id}
                  onClick={() => setNewRelation(prev => ({ ...prev, loveLanguage: lang.id }))}
                  className={`p-2 rounded-xl text-center transition-all ${newRelation.loveLanguage === lang.id ? 'bg-pink-500' : 'bg-white/5'
                    }`}
                  title={lang.name}
                >
                  <div className="text-lg">{lang.icon}</div>
                </button>
              ))}
            </div>
          </div>

          <div>
            <label className="text-sm text-white/50 mb-2 block">Frecuencia de contacto deseada</label>
            <div className="flex gap-2 flex-wrap">
              {frequencies.map(freq => (
                <button
                  key={freq.id}
                  onClick={() => setNewRelation(prev => ({ ...prev, contactFrequency: freq.id }))}
                  className={`px-3 py-2 rounded-lg text-sm transition-all ${newRelation.contactFrequency === freq.id ? 'bg-pink-500' : 'bg-white/5'
                    }`}
                >
                  {freq.name}
                </button>
              ))}
            </div>
          </div>

          <div className="grid grid-cols-2 gap-3">
            <div>
              <label className="text-sm text-white/50 mb-1 block">Cumplea√±os</label>
              <input
                type="date"
                value={newRelation.birthday}
                onChange={(e) => setNewRelation(prev => ({ ...prev, birthday: e.target.value }))}
                className="w-full bg-white/5 rounded-xl px-4 py-3"
              />
            </div>
            <div>
              <label className="text-sm text-white/50 mb-1 block">Aniversario</label>
              <input
                type="date"
                value={newRelation.anniversary}
                onChange={(e) => setNewRelation(prev => ({ ...prev, anniversary: e.target.value }))}
                className="w-full bg-white/5 rounded-xl px-4 py-3"
              />
            </div>
          </div>

          <div>
            <label className="text-sm text-white/50 mb-1 block">Intereses</label>
            <input
              type="text"
              value={newRelation.interests}
              onChange={(e) => setNewRelation(prev => ({ ...prev, interests: e.target.value }))}
              placeholder="Hobbies, temas favoritos..."
              className="w-full bg-white/5 rounded-xl px-4 py-3"
            />
          </div>

          <div>
            <label className="text-sm text-white/50 mb-1 block">Notas</label>
            <textarea
              value={newRelation.notes}
              onChange={(e) => setNewRelation(prev => ({ ...prev, notes: e.target.value }))}
              placeholder="Informaci√≥n importante..."
              rows={2}
              className="w-full bg-white/5 rounded-xl px-4 py-3 resize-none"
            />
          </div>

          <button
            onClick={addRelation}
            disabled={!newRelation.name.trim()}
            className="w-full py-3 bg-pink-500 rounded-xl font-medium disabled:opacity-30"
          >
            A√±adir Relaci√≥n
          </button>
        </div>
      </Modal>

      {/* INTERACTION MODAL */}
      <Modal isOpen={showInteractionModal} onClose={() => setShowInteractionModal(false)} title="Registrar Contacto">
        <div className="space-y-4">
          <div>
            <label className="text-sm text-white/50 mb-2 block">Tipo de contacto</label>
            <div className="grid grid-cols-3 gap-2">
              {interactionTypes.map(type => (
                <button
                  key={type.id}
                  onClick={() => setNewInteraction(prev => ({ ...prev, type: type.id }))}
                  className={`p-3 rounded-xl text-center transition-all ${newInteraction.type === type.id ? 'bg-pink-500' : 'bg-white/5'
                    }`}
                >
                  <div className="text-xl mb-1">{type.icon}</div>
                  <p className="text-xs">{type.name}</p>
                </button>
              ))}
            </div>
          </div>

          <div>
            <label className="text-sm text-white/50 mb-2 block">¬øC√≥mo fue?</label>
            <div className="flex justify-center gap-2">
              {[1, 2, 3, 4, 5].map(i => (
                <button
                  key={i}
                  onClick={() => setNewInteraction(prev => ({ ...prev, quality: i }))}
                  className="p-2"
                >
                  <Star className={`w-8 h-8 transition-all ${i <= newInteraction.quality ? 'text-amber-400 fill-amber-400' : 'text-white/20'
                    }`} />
                </button>
              ))}
            </div>
          </div>

          <div>
            <label className="text-sm text-white/50 mb-1 block">Notas (opcional)</label>
            <textarea
              value={newInteraction.notes}
              onChange={(e) => setNewInteraction(prev => ({ ...prev, notes: e.target.value }))}
              placeholder="¬øDe qu√© hablaron? ¬øAlgo importante?"
              rows={3}
              className="w-full bg-white/5 rounded-xl px-4 py-3 resize-none"
            />
          </div>

          <button
            onClick={() => addInteraction(selectedRelation?.id)}
            className="w-full py-3 bg-pink-500 rounded-xl font-medium"
          >
            Guardar
          </button>
        </div>
      </Modal>
    </div>
  );
};

// ============================================================================
// CONSCIOUSNESS SCREEN - Desarrollo Personal / Elevaci√≥n de Conciencia
// ============================================================================
const ConsciousnessScreen = ({ data, setData, showToast }) => {
  const today = getToday();
  const [view, setView] = useState('home'); // 'home', 'paths', 'journey', 'tools', 'insights'
  const [selectedPath, setSelectedPath] = useState(null);
  const [showPathDetail, setShowPathDetail] = useState(false);
  const [showPracticeModal, setShowPracticeModal] = useState(false);
  const [showOnboarding, setShowOnboarding] = useState(false);
  const [onboardingStep, setOnboardingStep] = useState(0);
  const [showCalibration, setShowCalibration] = useState(false);
  const [calibrationMode, setCalibrationMode] = useState('intro'); // 'intro', 'prompt', 'result'
  const [aiResponse, setAiResponse] = useState('');
  const [parsedLevel, setParsedLevel] = useState(null);
  const [parseError, setParseError] = useState(false);
  const [promptCopied, setPromptCopied] = useState(false);
  const [showPauseConfirm, setShowPauseConfirm] = useState(false);
  const [activeToolTab, setActiveToolTab] = useState('gratitude');
  const [journeyTab, setJourneyTab] = useState('ense√±anza'); // ense√±anza, pr√°ctica, mapa
  const [showFullTeaching, setShowFullTeaching] = useState(false);
  const [showLevelValidation, setShowLevelValidation] = useState(false);
  const [validationChecks, setValidationChecks] = useState({});
  const [showInsightModal, setShowInsightModal] = useState(false);
  const [newInsightText, setNewInsightText] = useState('');

  // Tools states
  const [toolTab, setToolTab] = useState('gratitude');
  const [breathingActive, setBreathingActive] = useState(false);
  const [breathPhase, setBreathPhase] = useState('idle');
  const [breathTimer, setBreathTimer] = useState(0);
  const [breathRound, setBreathRound] = useState(0);
  const [selectedBreathTechnique, setSelectedBreathTechnique] = useState('478');
  const [journalText, setJournalText] = useState('');
  const [journalMood, setJournalMood] = useState(null);
  const [newAffirmation, setNewAffirmation] = useState('');

  // Initialize consciousness data
  const consciousness = data.consciousness || {
    activePath: null,
    pathPaused: false,
    startingLevel: 0,
    completedPaths: [],
    level: 1,
    totalXP: 0,
    currentXP: 0,
    currentLevel: 0,
    practices: [],
    insights: [],
    gratitude: {},
    affirmations: [],
    breathingSessions: [],
    journal: {}
  };

  // Gratitude state
  const [gratitudeInputs, setGratitudeInputs] = useState(['', '', '']);
  const todayGratitude = consciousness.gratitude?.[today] || [];

  // All paths with full descriptions and AI calibration prompts
  const allPaths = [
    {
      id: 'hawkins',
      name: 'Escala de Conciencia',
      author: 'David Hawkins',
      icon: '‚ö°',
      color: '#8B5CF6',
      description: 'Calibra y eleva tu nivel de conciencia desde la verg√ºenza hasta la iluminaci√≥n',
      duration: '3-12 meses',
      difficulty: 'Profundo',
      hasCalibration: true,

      // Onboarding screens
      onboarding: [
        {
          title: 'El Mapa de la Consciencia',
          icon: 'üó∫Ô∏è',
          content: `En los a√±os 70, el Dr. David Hawkins comenz√≥ una investigaci√≥n que cambiar√≠a nuestra comprensi√≥n de la consciencia humana.

Usando kinesiolog√≠a aplicada, calibr√≥ miles de estados, emociones, pensamientos y obras humanas en una escala logar√≠tmica del 1 al 1000.

El resultado: un mapa preciso de los niveles de consciencia, desde los estados m√°s densos de supervivencia hasta la iluminaci√≥n.

Este no es un sistema de juicio. Es un GPS del alma.`
        },
        {
          title: 'La L√≠nea del 200',
          icon: '‚ö°',
          content: `El descubrimiento m√°s importante de Hawkins: existe un punto de inflexi√≥n cr√≠tico en el nivel 200, que corresponde al CORAJE.

Por debajo de 200: Estados de supervivencia, contracci√≥n, "tomar" de la vida. La persona se percibe como v√≠ctima de las circunstancias.

Por encima de 200: Estados de crecimiento, expansi√≥n, "dar" a la vida. La persona se reconoce como creadora de su realidad.

El 85% de la humanidad calibra por debajo de 200. Cruzar esta l√≠nea es el trabajo m√°s importante que puedes hacer.`
        },
        {
          title: 'C√≥mo Funciona el Ascenso',
          icon: 'üåÄ',
          content: `La consciencia no se eleva por esfuerzo mental o fuerza de voluntad. Se eleva por SOLTAR.

Cada nivel tiene un "atractor" - una forma de ver el mundo que te mantiene ah√≠. No luchas contra el nivel; lo comprendes, lo aceptas, y naturalmente lo trasciendes.

No puedes saltarte niveles. Pero puedes acelerar el proceso siendo radicalmente honesto contigo mismo sobre d√≥nde est√°s realmente.

El trabajo no es "llegar arriba". Es despertar a la verdad de lo que ya eres.`
        },
        {
          title: 'Tu Compromiso',
          icon: 'üî•',
          content: `Este camino requiere una sola cosa: honestidad radical contigo mismo.

No se trata de aparentar estar en un nivel alto. Se trata de reconocer con humildad d√≥nde est√°s y hacer el trabajo interior desde ah√≠.

Cada nivel que trasciendas genuinamente elevar√° no solo tu vida, sino el campo de consciencia colectivo. Un individuo en 500 contrarresta 750,000 personas por debajo de 200.

¬øEst√°s listo para ver la verdad de d√≥nde est√°s y comprometerte con tu evoluci√≥n?`
        }
      ],

      calibrationPrompt: `Eres un experto en la Escala de Conciencia de David Hawkins. Tu tarea es analizar a esta persona bas√°ndote en TODO lo que conoces de ella a trav√©s de nuestras conversaciones.

ESCALA DE NIVELES (del 0 al 16):
0: Verg√ºenza (20) - Humillaci√≥n, deseo de ser invisible, auto-destrucci√≥n
1: Culpa (30) - Auto-castigo, remordimiento destructivo, indignidad
2: Apat√≠a (50) - Desesperanza, victimismo total, "nada importa"
3: Pena (75) - Tristeza cr√≥nica, p√©rdida, melancol√≠a constante
4: Miedo (100) - Ansiedad, preocupaci√≥n cr√≥nica, ver amenazas por todos lados
5: Deseo (125) - Adicci√≥n, anhelo constante, esclavitud a los deseos
6: Ira (150) - Resentimiento, frustraci√≥n, culpar a otros, hostilidad
7: Orgullo (175) - Arrogancia, desprecio, necesidad de tener raz√≥n
8: Coraje (200) - PUNTO DE INFLEXI√ìN - Empoderamiento, determinaci√≥n, "puedo hacerlo"
9: Neutralidad (250) - Flexibilidad, no-apego, confianza, "est√° bien como sea"
10: Voluntad (310) - Optimismo genuino, disciplina, crecimiento intencional
11: Aceptaci√≥n (350) - Responsabilidad total, perd√≥n, armon√≠a, transformaci√≥n
12: Raz√≥n (400) - Racionalidad clara, comprensi√≥n profunda, conocimiento
13: Amor (500) - Incondicional, compasi√≥n verdadera, el coraz√≥n se abre
14: Alegr√≠a (540) - Serenidad, gratitud constante, amor por la existencia
15: Paz (600) - Silencio interior, gracia, iluminaci√≥n parcial
16: Iluminaci√≥n (700+) - Consciencia pura, unidad absoluta, lo inefable

ANALIZA EN PROFUNDIDAD:
- ¬øCu√°l es su estado emocional BASE? (no los picos, sino donde vuelve)
- ¬øC√≥mo reacciona ante adversidad? ¬øCulpa externos o asume responsabilidad?
- ¬øHay resentimiento, quejas frecuentes, o victimismo en su comunicaci√≥n?
- ¬øMuestra gratitud genuina o es m√°s bien transaccional?
- ¬øTiene capacidad de perdonar o guarda rencores?
- ¬øSe percibe a s√≠ mismo como creador o como v√≠ctima de circunstancias?
- ¬øHay paz interior o ansiedad/agitaci√≥n de fondo?

IMPORTANTE: S√© honesto y preciso. Es mejor calibrar bajo y acertar que calibrar alto y enga√±ar. La mayor√≠a de personas est√°n entre nivel 4 (Miedo) y nivel 9 (Neutralidad).

RESPONDE EXACTAMENTE con este formato:
===CALIBRATION_RESULT===
LEVEL: [n√∫mero del 0 al 16]
NAME: [nombre del nivel]
CONFIDENCE: [alta/media/baja]
===END_CALIBRATION===

Despu√©s explica tu an√°lisis detallando qu√© patrones observaste que te llevaron a esa calibraci√≥n.`,

      levels: [
        {
          index: 0,
          calibration: 20,
          name: 'Verg√ºenza',

          teaching: `La verg√ºenza es el estado m√°s cercano a la muerte ps√≠quica. Calibra en 20, apenas por encima de la muerte f√≠sica (0).

En verg√ºenza, el deseo primario es desaparecer. La persona se experimenta como fundamentalmente defectuosa, no solo en lo que hace, sino en lo que ES. "No es que hice algo malo, es que YO soy malo."

La verg√ºenza es tan dolorosa que el psique desarrolla defensas masivas: represi√≥n, proyecci√≥n, negaci√≥n. Muchas personas ni siquiera saben que operan desde verg√ºenza porque est√° enterrada bajo capas de compensaci√≥n.

La verg√ºenza colectiva se manifiesta en culturas de honor/deshonor, donde "perder la cara" puede llevar literalmente al suicidio. Es el campo de las enfermedades autoinmunes, donde el cuerpo se ataca a s√≠ mismo.

IMPORTANTE: Si est√°s aqu√≠, no est√°s "mal". La verg√ºenza es un estado, no una verdad sobre ti. El primer paso es simplemente reconocerla sin huir de ella.`,

          signs: [
            'Deseo frecuente de esconderte o desaparecer',
            'Evitas fotos, espejos, o ser el centro de atenci√≥n',
            'Sientes que hay algo fundamentalmente mal contigo',
            'Te castigas internamente con un cr√≠tico brutal',
            'Dificultad para recibir cumplidos o amor',
            'Sensaci√≥n de ser "descubierto" como fraude',
            'Compensas con perfeccionismo o logros externos'
          ],

          trap: `La trampa de la verg√ºenza es la INVISIBILIDAD. Te escondes para protegerte, pero esconderte confirma la creencia de que eres indigno de ser visto. Es un loop que se auto-refuerza.

Otra trampa es la COMPENSACI√ìN: intentar "demostrar" tu valor a trav√©s de logros, apariencia, o ser "bueno". Pero ning√∫n logro externo cura la herida interna.`,

          exit: `La salida no es convencerte de que "eres bueno" (eso es otra forma de huir). La salida es PRESENCIA con la verg√ºenza.

Cuando puedes sentir la verg√ºenza completamente, sin huir, sin racionalizar, sin compensar - algo se suelta. La verg√ºenza necesita oscuridad para sobrevivir. La luz de tu atenci√≥n la transforma.

El shift es de "SOY defectuoso" a "SIENTO verg√ºenza". T√∫ no eres la verg√ºenza. La verg√ºenza es algo que pasa a trav√©s de ti.`,

          weeklyPractice: {
            title: 'El Inventario de Verg√ºenza',
            duration: '45-60 minutos en un lugar privado',
            instructions: `Esta semana har√°s un inventario de verg√ºenza. Necesitas papel, pluma, y privacidad total.

1. Escribe la lista de cosas de las que sientes verg√ºenza. Todo. Lo que nadie sabe. Lo que no admites ni a ti mismo. No censures nada.

2. Para cada item, escribe: "Siento verg√ºenza de _____ porque significa que yo soy _____"

3. Ahora, lee cada uno en voz alta. Siente lo que sientes. No huyas. Respira.

4. Despu√©s de cada uno, di: "Esto es algo que pas√≥/hice. No es lo que soy."

5. Quema o destruye el papel. No como negaci√≥n, sino como ritual de liberaci√≥n.

Este ejercicio puede traer emociones intensas. Eso significa que est√° funcionando. Si es demasiado, hazlo en partes durante la semana.`
          },

          journalQuestion: '¬øQu√© parte de m√≠ he estado escondiendo del mundo? ¬øQu√© pasar√≠a si esa parte fuera vista?',

          resource: {
            type: 'libro',
            title: 'Healing the Shame that Binds You',
            author: 'John Bradshaw',
            note: 'El trabajo definitivo sobre verg√ºenza t√≥xica y c√≥mo sanarla'
          },

          minimumDays: 14,
          affirmation: 'Soy digno de ser visto exactamente como soy'
        },

        {
          index: 1,
          calibration: 30,
          name: 'Culpa',

          teaching: `La culpa calibra en 30, ligeramente por encima de la verg√ºenza. La diferencia clave: en verg√ºenza, "yo soy malo"; en culpa, "hice algo malo".

Es un avance porque la culpa implica que podr√≠as haber hecho algo diferente. Hay agencia. Pero la culpa se vuelve patol√≥gica cuando se convierte en auto-castigo perpetuo.

La culpa sana dice: "Hice algo mal, aprender√© y reparar√©". La culpa t√≥xica dice: "Hice algo mal, debo sufrir indefinidamente para pagar".

La culpa es el arma favorita del ego para mantenerte peque√±o. "No mereces ser feliz porque mira lo que hiciste." Es una forma de control disfrazada de moralidad.

Muchas religiones y culturas instalan culpa como mecanismo de control. "Naciste en pecado." "No eres suficiente." Esta culpa introyectada no tiene que ver con lo que t√∫ hiciste - fue instalada desde afuera.`,

          signs: [
            'Repites mentalmente errores del pasado una y otra vez',
            'Sientes que necesitas "pagar" por algo antes de ser feliz',
            'Te cuesta perdonarte incluso por errores peque√±os',
            'Saboteas tu √©xito o felicidad inconscientemente',
            'Cargas con responsabilidad de cosas que no son tu culpa',
            'Dices "perd√≥n" excesivamente, incluso cuando no hiciste nada',
            'Sensaci√≥n de estar en deuda con la vida'
          ],

          trap: `La trampa de la culpa es creer que el SUFRIMIENTO es redenci√≥n. "Si sufro lo suficiente, habr√© pagado." Pero ninguna cantidad de sufrimiento cambia el pasado. El sufrimiento no te absuelve, solo te destruye.

Otra trampa es la PSEUDO-REDENCI√ìN a trav√©s de buenas obras compulsivas. Haces cosas buenas no desde el amor, sino para "compensar". Pero internamente sigues sinti√©ndote en deuda.`,

          exit: `La salida de la culpa es el PERD√ìN genuino hacia ti mismo. No es decir "est√° bien lo que hice" - quiz√°s no estaba bien. Es decir "soy humano, comet√≠ un error, y elijo soltar el castigo".

El perd√≥n no es para el otro o para el acto. Es para ti. Mientras no perdones, tomas veneno esperando que el pasado muera.

El shift es de "debo sufrir" a "elijo aprender y soltar". Del auto-castigo a la auto-compasi√≥n.`,

          weeklyPractice: {
            title: 'Carta de Perd√≥n a Ti Mismo',
            duration: '30-45 minutos',
            instructions: `Esta semana escribir√°s una carta de perd√≥n a ti mismo.

1. Elige UN evento espec√≠fico por el que te sientes culpable. El m√°s pesado.

2. Escribe lo que pas√≥ sin justificaciones ni minimizaci√≥n. Reconoce el impacto.

3. Escribe: "Yo era una persona que [no sab√≠a/estaba herida/no ten√≠a herramientas para] ___. Hice lo que pude con lo que ten√≠a en ese momento."

4. Escribe: "Elijo perdonarme. No porque estuvo bien, sino porque el castigo perpetuo no sirve a nadie. Elijo aprender y ser mejor."

5. Lee la carta en voz alta, preferiblemente frente a un espejo, mir√°ndote a los ojos.

6. Si hay alguna reparaci√≥n posible y apropiada, considera hacerla. Si no la hay, acepta eso tambi√©n.`
          },

          journalQuestion: '¬øQu√© creo que me pasar√≠a si realmente me perdonara completamente? ¬øQu√© temo perder?',

          resource: {
            type: 'libro',
            title: 'Radical Forgiveness',
            author: 'Colin Tipping',
            note: 'Un proceso pr√°ctico para soltar resentimiento y culpa'
          },

          minimumDays: 14,
          affirmation: 'Me perdono completamente y me libero del pasado'
        },

        {
          index: 2,
          calibration: 50,
          name: 'Apat√≠a',

          teaching: `La apat√≠a calibra en 50. Es el estado de "¬øpara qu√©?" La desesperanza se ha instalado tan profundamente que ya ni siquiera hay energ√≠a para la verg√ºenza o la culpa.

En apat√≠a, la persona ha renunciado. No hay lucha, no hay intento. Solo existencia vac√≠a. Es el territorio de la depresi√≥n cl√≠nica, la indigencia cr√≥nica, y el abandono total.

La apat√≠a es peligrosa porque se siente como paz. "Ya no sufro porque ya no me importa." Pero no es paz - es muerte en vida. La paz verdadera (nivel 600) est√° llena de vida; la apat√≠a est√° vac√≠a.

Socialmente, la apat√≠a es dif√≠cil de ayudar porque la persona no tiene energ√≠a para recibir ayuda. "D√©jame en paz" es su mantra. Cualquier intento de ayudar se siente como una imposici√≥n.

Si est√°s leyendo esto y trabajando en ti mismo, probablemente no est√©s en apat√≠a profunda. Pero puedes tener √ÅREAS de tu vida en apat√≠a - relaciones, salud, finanzas donde "ya te rendiste".`,

          signs: [
            '"¬øPara qu√© intentarlo?" es un pensamiento frecuente',
            'Has dejado de cuidar aspectos b√°sicos (higiene, salud, orden)',
            'Las cosas que antes te gustaban ya no te generan nada',
            'Sensaci√≥n de estar desconectado de la vida y otros',
            'Respuesta emocional plana - ni alegr√≠a ni tristeza',
            'Dificultad para tomar cualquier iniciativa',
            'Sensaci√≥n de que nada va a cambiar de todos modos'
          ],

          trap: `La trampa de la apat√≠a es confundirla con ACEPTACI√ìN o DESAPEGO espiritual. "He soltado el apego" suena elevado, pero la apat√≠a no es soltar - es rendirse. El desapego verdadero est√° lleno de vida y paz; la apat√≠a est√° vac√≠a.

Otra trampa es la INERCIA. La apat√≠a tiene un momentum enorme. Cada d√≠a sin acci√≥n hace m√°s dif√≠cil el siguiente. Es como un agujero negro emocional.`,

          exit: `La salida de la apat√≠a no es un gran cambio. Es una MICRO-ACCI√ìN. Cualquier cosa. Levantarte. Ducharte. Dar un paso afuera.

La apat√≠a te dice que nada importa. No le creas. No necesitas creer que importa - solo necesitas actuar COMO SI importara. La fe puede venir despu√©s.

El shift es de "nada importa" a "voy a hacer UNA cosa". No todo. No la soluci√≥n completa. Una cosa diminuta. La energ√≠a genera energ√≠a.`,

          weeklyPractice: {
            title: 'Una Cosa Cada D√≠a',
            duration: 'Variable',
            instructions: `Esta semana, el √∫nico objetivo es hacer UNA cosa cada d√≠a que no hayas estado haciendo.

Puede ser min√∫sculo:
- Abrir las cortinas
- Dar una vuelta a la manzana
- Tirar una bolsa de basura
- Enviar un mensaje a alguien
- Cocinar una comida real

Las reglas:
1. Solo UNA cosa al d√≠a. No intentes compensar.
2. No tiene que ser importante. Tiene que ser HECHA.
3. Cada noche, escribe lo que hiciste. Solo eso.

El objetivo no es productividad. Es romper la inercia. Demostrarle a tu sistema que la acci√≥n es posible.`
          },

          journalQuestion: '¬øEn qu√© √°rea de mi vida me he rendido? ¬øQu√© ser√≠a lo m√°s peque√±o que podr√≠a hacer ah√≠?',

          resource: {
            type: 'libro',
            title: 'The Upward Spiral',
            author: 'Alex Korb',
            note: 'Neurociencia de la depresi√≥n y peque√±os cambios que revierten la espiral'
          },

          minimumDays: 14,
          affirmation: 'Cada peque√±a acci√≥n importa y me mueve hacia la vida'
        },

        {
          index: 3,
          calibration: 75,
          name: 'Pena',

          teaching: `La pena calibra en 75. Es el territorio del duelo, la p√©rdida, y la tristeza profunda.

A diferencia de la apat√≠a, en la pena todav√≠a hay energ√≠a - pero es energ√≠a de p√©rdida. La persona est√° conectada a algo que ya no est√°: una relaci√≥n, un sue√±o, una versi√≥n de s√≠ misma, un ser querido.

La pena es natural y necesaria. Cuando perdemos algo significativo, necesitamos tiempo para procesar. El problema es cuando la pena se convierte en residencia permanente.

La pena cr√≥nica dice: "El pasado era mejor. Lo mejor ya pas√≥. Solo queda el descenso." Es una forma de vivir mirando por el espejo retrovisor.

Hay culturas y familias donde la pena es casi un valor. "Sufrir significa que te importa." Esto crea una identidad construida alrededor del sufrimiento.`,

          signs: [
            'Nostalgia frecuente - "antes era mejor"',
            'Dificultad para soltar objetos, recuerdos, relaciones pasadas',
            'Tristeza de fondo constante, aunque funcional',
            'Te identificas con tus heridas o p√©rdidas',
            'Resistencia a momentos de alegr√≠a (como si traicionaras la p√©rdida)',
            'Melancol√≠a cr√≥nica que parece parte de tu personalidad',
            'Sensaci√≥n de que tus mejores d√≠as ya pasaron'
          ],

          trap: `La trampa de la pena es la IDENTIDAD. "Soy alguien que perdi√≥ ___". La p√©rdida se convierte en quien eres. Y si sueltas la pena, sientes que traicionas lo que perdiste.

Otra trampa es creer que la PROFUNDIDAD de la pena demuestra la profundidad del amor. "Si dejo de sufrir, significa que no me importaba." Falso. El amor verdadero quiere que est√©s bien.`,

          exit: `La salida de la pena es completar el duelo. No olvidar - integrar. Lo perdido se convierte en parte de ti en vez de algo que te falta.

El shift es de "lo perd√≠" a "lo viv√≠ y me form√≥". De "ya no est√°" a "siempre es parte de m√≠".

Esto requiere rituales de cierre, expresi√≥n completa del dolor, y eventualmente, dar permiso a la alegr√≠a.`,

          weeklyPractice: {
            title: 'Ritual de Honrar y Soltar',
            duration: '1-2 horas',
            instructions: `Esta semana har√°s un ritual de completar un duelo pendiente.

1. Elige una p√©rdida que todav√≠a cargues. Una relaci√≥n, un sue√±o, una versi√≥n de ti, un ser querido.

2. Dedica tiempo a HONRAR completamente lo que fue. Escribe, mira fotos, recuerda. Deja que venga la tristeza.

3. Escribe una carta a lo que perdiste. Agradece todo lo que te dio. Expresa todo lo que no dijiste.

4. Escribe qu√© parte de eso vive ahora en ti. ¬øC√≥mo te form√≥? ¬øQu√© te ense√±√≥?

5. Haz un peque√±o ritual de cierre. Puede ser quemar la carta, plantar algo, ir a un lugar significativo. Marca el fin del duelo activo.

6. Date permiso expl√≠cito de experimentar alegr√≠a sin traicionar lo perdido. Dilo en voz alta: "Tengo permiso de ser feliz."

El duelo puede requerir m√°s de una semana. Est√° bien. Pero el ritual marca una intenci√≥n de completar.`
          },

          journalQuestion: '¬øQu√© duelo no he completado? ¬øQu√© me impide soltarlo?',

          resource: {
            type: 'libro',
            title: 'It\'s OK That You\'re Not OK',
            author: 'Megan Devine',
            note: 'Una perspectiva radical sobre el duelo y c√≥mo navegarlo'
          },

          minimumDays: 14,
          affirmation: 'Honro mi pasado mientras me abro al presente'
        },

        {
          index: 4,
          calibration: 100,
          name: 'Miedo',

          teaching: `El miedo calibra en 100. Es el primer nivel con suficiente energ√≠a para la acci√≥n sostenida - pero la energ√≠a est√° al servicio de evitar amenazas.

El mundo del miedo est√° lleno de peligros. Cada situaci√≥n es evaluada por su potencial de da√±o. La pregunta constante es "¬øqu√© podr√≠a salir mal?"

El miedo tiene valor evolutivo: nos mantuvo vivos como especie. El problema es cuando el sistema de amenazas se activa constantemente sin amenazas reales. Ansiedad cr√≥nica, preocupaci√≥n, paranoia.

El miedo distorsiona la percepci√≥n. Ves amenazas donde no las hay. Interpretas neutralidad como hostilidad. El sesgo de negatividad domina.

Much√≠simas personas viven aqu√≠ permanentemente. El 24/7 de noticias, redes sociales alarmistas, y cultura del miedo mantiene a poblaciones enteras en este estado.`,

          signs: [
            'Preocupaci√≥n cr√≥nica por el futuro',
            'Dificultad para relajarte o "soltar el control"',
            'Anticipas lo peor en situaciones ambiguas',
            'Evitas riesgos incluso cuando el costo de evitar es mayor',
            'Ansiedad f√≠sica: tensi√≥n, insomnio, problemas digestivos',
            'Necesitas mucha informaci√≥n/garant√≠as antes de actuar',
            'El "¬øy si...?" negativo domina tu pensamiento'
          ],

          trap: `La trampa del miedo es creer que es PROTECCI√ìN. "Si bajo la guardia, algo malo pasar√°." El miedo promete seguridad a cambio de vigilancia constante. Pero la vigilancia constante es su propia forma de sufrimiento.

Otra trampa es el CONTROL. Intentas controlar todo para eliminar incertidumbre. Pero la vida es inherentemente incierta, as√≠ que el control es una batalla perdida.`,

          exit: `La salida del miedo no es eliminar el miedo - es cambiar tu relaci√≥n con √©l. Sentir miedo y actuar de todos modos. Eso es coraje.

El shift es de "el miedo significa peligro" a "el miedo significa que algo me importa". El miedo y la emoci√≥n tienen la misma firma fisiol√≥gica. La interpretaci√≥n cambia todo.

Tambi√©n ayuda distinguir: ¬øes esto un peligro REAL o un peligro IMAGINADO? El 99% de lo que tememos nunca sucede.`,

          weeklyPractice: {
            title: 'Exposici√≥n Gradual Consciente',
            duration: 'Variable',
            instructions: `Esta semana practicar√°s hacer cosas que te dan miedo, conscientemente.

1. Haz una lista de cosas que evitas por miedo (no terror, sino incomodidad significativa).

2. Ord√©nalas de menor a mayor intensidad.

3. Elige la m√°s peque√±a. Esta semana, hazla.

4. ANTES: Nota el miedo en tu cuerpo. No lo evites. Respira con √©l.

5. DURANTE: Act√∫a CON el miedo presente, no esperando a que desaparezca.

6. DESPU√âS: Nota qu√© pas√≥ realmente vs. lo que tem√≠as. Escr√≠belo.

El objetivo no es "no sentir miedo". Es demostrarle a tu sistema nervioso que puedes sentir miedo Y actuar. Que el miedo no es jefe, es consejero.`
          },

          journalQuestion: '¬øQu√© decisi√≥n he estado evitando por miedo? ¬øQu√© es lo peor que podr√≠a pasar realmente?',

          resource: {
            type: 'libro',
            title: 'Feel the Fear and Do It Anyway',
            author: 'Susan Jeffers',
            note: 'Un cl√°sico sobre transformar la relaci√≥n con el miedo'
          },

          minimumDays: 14,
          affirmation: 'Siento el miedo y act√∫o de todos modos'
        },

        {
          index: 5,
          calibration: 125,
          name: 'Deseo',

          teaching: `El deseo calibra en 125. Aqu√≠ hay m√°s energ√≠a que en el miedo - es energ√≠a de QUERER. El problema es que el querer nunca termina.

El deseo dice: "Cuando tenga ___, ser√© feliz." Pero cuando obtienes ___, surge un nuevo deseo. Es una cinta de correr hed√≥nica donde siempre est√°s persiguiendo y nunca llegando.

Este es el nivel del consumismo, la adicci√≥n, y la acumulaci√≥n. M√°s dinero, m√°s estatus, m√°s placer, m√°s seguidores. El vac√≠o interno se intenta llenar con cosas externas.

El deseo en s√≠ no es malo - es energ√≠a vital. El problema es la ESCLAVITUD al deseo. Cuando el deseo te controla en vez de t√∫ usar el deseo como combustible.

La publicidad y el capitalismo est√°n dise√±ados para mantenerte aqu√≠. Crearte deseos que no ten√≠as, para venderte soluciones que no necesitas.`,

          signs: [
            'Sensaci√≥n frecuente de que "falta algo"',
            'Dificultad para disfrutar lo que tienes porque piensas en lo que quieres',
            'Compras, comes, o consumes para llenar un vac√≠o',
            'La satisfacci√≥n de lograr algo dura muy poco',
            'Comparaci√≥n constante con otros que tienen m√°s',
            'Adicciones (sustancias, comida, sexo, trabajo, redes sociales)',
            'Sensaci√≥n de que la felicidad est√° "despu√©s de" conseguir algo'
          ],

          trap: `La trampa del deseo es creer que el OBJETO del deseo es el problema. "Si deseara las cosas correctas, estar√≠a bien." Pero cambiar de deseo no cambia la din√°mica. Sigues siendo esclavo, solo de un amo diferente.

Otra trampa es la REPRESI√ìN del deseo. Esto no funciona - el deseo reprimido vuelve con m√°s fuerza, o se transforma en neurosis.`,

          exit: `La salida del deseo no es eliminar deseos sino PRESENCIARLOS sin actuar autom√°ticamente.

Cuando surge un deseo, puedes: 1) Actuar compulsivamente, 2) Reprimir, o 3) Observar con curiosidad. La tercera opci√≥n es la salida.

El shift es de "necesito esto para estar bien" a "quiero esto Y ya estoy bien sin ello". Desear desde la abundancia en vez de la carencia.

Gratitud es el ant√≠doto al deseo. No gratitud forzada, sino genuino reconocimiento de lo que ya tienes.`,

          weeklyPractice: {
            title: 'Ayuno de Deseos',
            duration: 'Toda la semana',
            instructions: `Esta semana practicar√°s observar deseos sin actuar en ellos.

1. Elige UNA categor√≠a de deseo para "ayunar": compras no esenciales, redes sociales, comida no planificada, entretenimiento, etc.

2. Cuando surja el deseo, NO act√∫es. En vez:
   - Para. Respira.
   - Nota d√≥nde est√° el deseo en tu cuerpo.
   - Pregunta: "¬øQu√© estoy realmente buscando?" (usualmente es un estado emocional, no el objeto)
   - Qu√©date con la sensaci√≥n de querer sin satisfacerla.

3. Escribe cada vez que notes un deseo fuerte. ¬øQu√© lo dispar√≥? ¬øQu√© buscabas realmente?

4. Al final de la semana, nota: ¬øSobreviviste sin satisfacer esos deseos? ¬øQu√© aprendiste?

El objetivo no es nunca desear. Es romper el automatismo deseo ‚Üí acci√≥n.`
          },

          journalQuestion: '¬øQu√© creo que me dar√≠a aquello que deseo? ¬øPuedo encontrar eso sin el objeto?',

          resource: {
            type: 'libro',
            title: 'The Untethered Soul',
            author: 'Michael Singer',
            note: 'C√≥mo dejar de ser controlado por deseos y miedos internos'
          },

          minimumDays: 14,
          affirmation: 'Tengo todo lo que necesito en este momento'
        },

        {
          index: 6,
          calibration: 150,
          name: 'Ira',

          teaching: `La ira calibra en 150. Es un paso significativo hacia arriba porque la ira tiene MUCHA energ√≠a y est√° orientada hacia el CAMBIO.

La ira dice: "Esto est√° mal y debe cambiar." A diferencia de los niveles inferiores que son pasivos, la ira es activa. Puede destruir, pero tambi√©n puede construir.

Muchos movimientos sociales importantes nacieron de la ira. La ira ante la injusticia ha cambiado el mundo. El problema no es la ira, es quedarse ATRAPADO en ella.

La ira cr√≥nica es corrosiva. Te mantiene en modo de combate permanente. Ve enemigos por todos lados. Culpa a otros por todo. La fisiolog√≠a del estr√©s constante destruye el cuerpo.

La ira tambi√©n es preferida a los estados inferiores. Es m√°s f√°cil estar enojado que triste, asustado, o avergonzado. Muchas personas usan la ira como defensa contra emociones m√°s vulnerables.`,

          signs: [
            'Frustraci√≥n frecuente con personas, sistemas, situaciones',
            'Tendencia a culpar a otros o a circunstancias externas',
            'Resentimiento guardado hacia personas o el pasado',
            'Reactividad - explotas ante peque√±as provocaciones',
            'Sensaci√≥n de que el mundo es injusto contigo',
            'Dificultad para perdonar',
            'Tensi√≥n f√≠sica cr√≥nica, mand√≠bula apretada, pu√±os cerrados'
          ],

          trap: `La trampa de la ira es creer que es JUSTA y por lo tanto buena. "Tengo raz√≥n para estar enojado." Puede ser cierto, pero tener raz√≥n no te hace libre. Mientras est√©s enojado, el otro tiene poder sobre ti.

Otra trampa es la ADICCI√ìN a la energ√≠a de la ira. Se siente poderoso, vivo. Los estados superiores parecen "aburridos" en comparaci√≥n.`,

          exit: `La salida de la ira es CANALIZAR la energ√≠a sin quedarte atrapado en ella.

La ira contiene informaci√≥n valiosa: algo te importa, un l√≠mite fue cruzado, hay una injusticia. Recibe el mensaje sin quedarte enganchado al mensajero.

El shift es de "ellos me hicieron esto" a "esto pas√≥ y yo elijo mi respuesta". De v√≠ctima reactiva a agente responsable.

Tambi√©n ayuda mirar DEBAJO de la ira. ¬øQu√© hay ah√≠? Usualmente miedo, tristeza, o verg√ºenza. La ira es m√°s f√°cil de sentir.`,

          weeklyPractice: {
            title: 'Alquimia de la Ira',
            duration: 'Cuando surja ira + reflexi√≥n semanal',
            instructions: `Esta semana transformar√°s la energ√≠a de la ira conscientemente.

Cuando notes ira:
1. PARA antes de reaccionar. Di internamente: "Esto es ira."
2. Perm√≠tete sentirla f√≠sicamente. ¬øD√≥nde est√°? ¬øC√≥mo se siente?
3. Pregunta: "¬øQu√© me importa aqu√≠? ¬øQu√© l√≠mite siento cruzado?"
4. Pregunta: "¬øQu√© hay debajo de la ira? ¬øMiedo? ¬øTristeza? ¬øVerg√ºenza?"
5. Elige conscientemente: ¬øNecesito actuar? ¬øQu√© acci√≥n servir√≠a?

Si la ira es intensa:
- Mueve el cuerpo: camina r√°pido, haz ejercicio, grita en un lugar seguro
- Escribe sin censura todo lo que quieres decir
- Despu√©s de que baje la intensidad, revisa si hay acci√≥n necesaria

Al final de la semana: ¬øQu√© descubriste debajo de tu ira?`
          },

          journalQuestion: '¬øContra qui√©n o qu√© sigo guardando resentimiento? ¬øQu√© me costar√≠a soltarlo?',

          resource: {
            type: 'libro',
            title: 'Nonviolent Communication',
            author: 'Marshall Rosenberg',
            note: 'C√≥mo expresar ira de forma que conecte en vez de destruir'
          },

          minimumDays: 14,
          affirmation: 'Transformo mi ira en acci√≥n consciente'
        },

        {
          index: 7,
          calibration: 175,
          name: 'Orgullo',

          teaching: `El orgullo calibra en 175, justo debajo de la l√≠nea cr√≠tica del 200. Es el m√°s alto de los niveles "inferiores" y el m√°s enga√±oso.

El orgullo SIENTE bien. A diferencia de la verg√ºenza, culpa, o miedo, el orgullo da placer. "Soy mejor, soy especial, tengo raz√≥n." El ego est√° inflado y se siente fuerte.

El problema es que el orgullo es FR√ÅGIL. Depende de comparaci√≥n y de tener raz√≥n. Cualquier evidencia contraria es una amenaza. Por eso el orgulloso no puede aprender - aprender requiere admitir que no sabes.

El orgullo tambi√©n SEPARA. "Yo vs. ellos", "nosotros vs. ellos", "los que saben vs. los ignorantes". Esta separaci√≥n impide conexi√≥n genuina y bloquea niveles superiores.

Muchas personas espirituales caen en el orgullo espiritual. "Yo medito, yo soy consciente, yo estoy m√°s evolucionado." Es el mismo orgullo con disfraz espiritual.`,

          signs: [
            'Necesidad de tener raz√≥n en discusiones',
            'Dificultad para pedir ayuda o admitir errores',
            'Desprecio o condescendencia hacia otros',
            'Te defines por logros, estatus, o afiliaciones',
            'Comparaci√≥n frecuente (favorable a ti)',
            'Reactividad ante cr√≠ticas o cuestionamientos',
            'Sensaci√≥n de ser "especial" o "diferente" (superiormente)'
          ],

          trap: `La trampa del orgullo es que SE SIENTE BIEN. ¬øPor qu√© soltar algo que da placer y sensaci√≥n de valor?

Otra trampa es el ORGULLO INVERTIDO: "Soy tan humilde", "no tengo ego". Es orgullo disfrazado.

La trampa final es confundir DIGNIDAD con orgullo. Puedes tener dignidad y autorespeto sin necesidad de ser superior.`,

          exit: `La salida del orgullo es la HUMILDAD genuina. No humillaci√≥n, no falsa modestia - humildad real.

Humildad es reconocer que no tienes todas las respuestas. Que puedes aprender de cualquiera. Que tu perspectiva es limitada. Que puedes estar equivocado.

El shift es de "yo s√©" a "qu√© puedo aprender aqu√≠". De necesitar ser especial a estar bien siendo ordinario.

La paradoja es que soltar el orgullo te hace m√°s fuerte, no m√°s d√©bil. Ya no dependes de comparaciones externas.`,

          weeklyPractice: {
            title: 'Pr√°ctica de Humildad',
            duration: 'Toda la semana',
            instructions: `Esta semana practicar√°s humildad activamente.

1. PIDE AYUDA en algo que normalmente har√≠as solo o no har√≠as por no pedir.

2. ADMITE UN ERROR p√∫blicamente sin justificaciones. "Me equivoqu√©" y punto.

3. APRENDE DE ALGUIEN que normalmente descartar√≠as (m√°s joven, diferente, "inferior").

4. Cuando quieras tener raz√≥n en una conversaci√≥n, PREGUNTA en vez de afirmar. "¬øC√≥mo lo ves t√∫?"

5. Nota cada vez que te compares favorablemente con alguien. Solo nota. Sin juicio.

6. Al final de cada d√≠a: ¬øD√≥nde necesit√© ser especial hoy? ¬øQu√© habr√≠a pasado si hubiera soltado eso?

Reflexi√≥n semanal: ¬øQu√© descubr√≠ sobre mi necesidad de ser superior? ¬øQu√© temo que pase si soy "ordinario"?`
          },

          journalQuestion: '¬øEn qu√© √°reas necesito sentirme superior? ¬øQu√© inseguridad estoy compensando?',

          resource: {
            type: 'libro',
            title: 'Ego is the Enemy',
            author: 'Ryan Holiday',
            note: 'C√≥mo el ego sabotea el √©xito y la realizaci√≥n'
          },

          minimumDays: 14,
          affirmation: 'No necesito ser especial para tener valor'
        },

        {
          index: 8,
          calibration: 200,
          name: 'Coraje',

          teaching: `El coraje calibra en 200. Es el PUNTO DE INFLEXI√ìN cr√≠tico en toda la escala. Por primera vez, la energ√≠a es constructiva en vez de destructiva.

En coraje, la persona dice: "Puedo hacerlo." No "soy mejor" (orgullo), no "tengo miedo pero evito" - sino "tengo miedo Y act√∫o de todos modos."

Este es el nivel del empoderamiento genuino. La persona se reconoce como AGENTE en su vida. Deja de verse como v√≠ctima de circunstancias.

El coraje abre mundos. La persona con coraje intenta cosas, falla, aprende, intenta de nuevo. La vida se convierte en exploraci√≥n en vez de supervivencia.

Cruzar del 199 al 200 es el trabajo m√°s importante. Una vez aqu√≠, el momentum es hacia arriba. Antes de 200, el momentum es hacia abajo.`,

          signs: [
            'Disposici√≥n a enfrentar problemas en vez de evitarlos',
            'Capacidad de admitir errores y aprender de ellos',
            'Determinaci√≥n ante obst√°culos',
            'Sensaci√≥n de "puedo manejarlo" aunque sea dif√≠cil',
            'Tomar iniciativa en vez de esperar',
            'Asumir responsabilidad por tu vida',
            'Optimismo realista basado en agencia, no negaci√≥n'
          ],

          trap: `La trampa del coraje es el SOBRE-ESFUERZO. Creer que todo depende de ti y forzar constantemente. El coraje es necesario pero no suficiente.

Otra trampa es quedarse en "modo guerrero" permanente. El coraje es para cuando se necesita, no como forma de vida constante.`,

          exit: `La salida hacia arriba es soltar el esfuerzo excesivo y permitir. No todo requiere batalla. A veces las cosas fluyen.

El shift es de "puedo hacerlo" a "est√° bien como sea". De esfuerzo a confianza. De hacer a permitir.

Esto no significa pasividad - significa no forzar cuando no es necesario.`,

          weeklyPractice: {
            title: 'Actuar ante el Miedo',
            duration: 'Toda la semana',
            instructions: `Esta semana consolidar√°s el coraje como tu nueva base operativa.

1. Identifica 3 cosas que has estado evitando por miedo o incomodidad.

2. Haz AL MENOS UNA esta semana. No la m√°s peque√±a - una que importe.

3. Antes de actuar:
   - Reconoce el miedo. Est√° bien.
   - Conecta con POR QU√â importa esto.
   - Recuerda: el coraje no es ausencia de miedo, es acci√≥n con miedo.

4. Despu√©s de actuar:
   - Celebra que lo hiciste, independiente del resultado.
   - Nota c√≥mo te sientes.
   - ¬øQu√© fue m√°s f√°cil de lo que tem√≠as?

5. Diario: Cada noche, escribe una cosa que hiciste con coraje hoy (aunque sea peque√±a).

El objetivo es INSTALAR el patr√≥n: miedo ‚Üí acci√≥n ‚Üí supervivencia ‚Üí confianza.`
          },

          journalQuestion: '¬øQu√© har√≠a si no tuviera miedo? ¬øQu√© me detiene realmente?',

          resource: {
            type: 'libro',
            title: 'Power vs. Force',
            author: 'David Hawkins',
            note: 'El libro original donde Hawkins presenta toda la escala'
          },

          minimumDays: 14,
          affirmation: 'Tengo el poder de crear mi vida'
        },

        {
          index: 9,
          calibration: 250,
          name: 'Neutralidad',

          teaching: `La neutralidad calibra en 250. Aqu√≠ hay un soltar significativo. La persona ya no necesita que las cosas sean de cierta manera.

En neutralidad, "est√° bien" es el mantra genuino. Si pasa X, est√° bien. Si pasa Y, tambi√©n est√° bien. Hay flexibilidad real ante la vida.

Este nivel tiene una confianza b√°sica en que las cosas van a funcionar. No optimismo forzado, sino una soltura genuina que permite que la vida fluya.

La neutralidad es no-resistencia. En vez de luchar contra lo que es, la persona trabaja CON lo que es. Esto ahorra energ√≠a enorme que estaba siendo usada en resistir.

Muchas personas confunden neutralidad con indiferencia. No es lo mismo. La neutralidad est√° presente y comprometida, solo no est√° apegada al resultado.`,

          signs: [
            'Capacidad de "soltar" cuando las cosas no salen como quer√≠as',
            'No tomarse las cosas personalmente',
            'Flexibilidad ante cambios de planes',
            'Sensaci√≥n de "todo va a estar bien" (sin negaci√≥n)',
            'Menos necesidad de controlar resultados',
            'Paz b√°sica de fondo incluso en dificultades',
            'Facilidad para ver m√∫ltiples perspectivas'
          ],

          trap: `La trampa de la neutralidad es la COMPLACENCIA. "Todo est√° bien" puede convertirse en excusa para no actuar cuando la acci√≥n es necesaria.

Otra trampa es confundirla con REPRESI√ìN emocional. La neutralidad genuina siente las emociones y las suelta. La represi√≥n no las siente.`,

          exit: `La salida hacia arriba es agregar INTENCI√ìN a la neutralidad. No solo aceptar lo que es, sino activamente querer participar en crear algo mejor.

El shift es de "est√° bien como sea" a "elijo comprometerme con esto".`,

          weeklyPractice: {
            title: 'Pr√°ctica del Soltar',
            duration: 'Toda la semana',
            instructions: `Esta semana practicar√°s soltar activamente.

Cada vez que algo no salga como quer√≠as:
1. Nota la resistencia (tensi√≥n, queja mental, frustraci√≥n)
2. Respira profundo
3. Di: "Es lo que es. ¬øC√≥mo trabajo CON esto?"
4. Suelta la versi√≥n de c√≥mo "deber√≠a" ser

Ejercicio diario:
- Identifica algo que est√©s intentando controlar
- Pregunta: ¬øRealmente puedo controlarlo?
- Si no, practica soltarlo conscientemente
- Si s√≠, act√∫a y suelta el resultado

Nota: Soltar no es renunciar. Es soltar el APEGO al resultado mientras sigues participando.

Reflexi√≥n semanal: ¬øD√≥nde segu√≠ resistiendo? ¬øD√≥nde pude soltar?`
          },

          journalQuestion: '¬øA qu√© resultado estoy m√°s apegado ahora mismo? ¬øQu√© pasar√≠a si lo soltara?',

          resource: {
            type: 'libro',
            title: 'Letting Go',
            author: 'David Hawkins',
            note: 'El m√©todo de soltar emociones que Hawkins practic√≥ y ense√±√≥'
          },

          minimumDays: 14,
          affirmation: 'Conf√≠o en el flujo de la vida'
        },

        {
          index: 10,
          calibration: 310,
          name: 'Voluntad',

          teaching: `La voluntad calibra en 310. Aqu√≠ hay una participaci√≥n activa y positiva con la vida. La persona no solo acepta lo que es - quiere contribuir.

En voluntad, la persona dice "s√≠" a la vida. Hay optimismo genuino, no basado en negaci√≥n sino en una orientaci√≥n hacia el crecimiento.

Este es el nivel de la disciplina elegida, no impuesta. La persona se compromete con cosas dif√≠ciles porque quiere crecer, no por obligaci√≥n o miedo.

La voluntad tambi√©n significa alinearse con algo mayor. "¬øQu√© quiere la vida a trav√©s de m√≠?" reemplaza "¬øqu√© quiero yo de la vida?"

Hay servicio genuino aqu√≠, pero todav√≠a con algo de ego. "Yo" ayudo, "yo" contribuyo. Es bueno, pero hay m√°s soltando por hacer.`,

          signs: [
            'Entusiasmo genuino por crecer y aprender',
            'Disciplina auto-impuesta con facilidad',
            'Deseo de contribuir y ser √∫til',
            'Optimismo realista - ves posibilidades',
            'Capacidad de comprometerte a largo plazo',
            'Sensaci√≥n de participar en algo mayor',
            'Energ√≠a disponible para proyectos significativos'
          ],

          trap: `La trampa de la voluntad es el EGO ESPIRITUAL. "Yo estoy creciendo, yo me estoy desarrollando, mira mi disciplina." El crecimiento se convierte en nuevo objeto de orgullo.

Otra trampa es el AGOTAMIENTO por sobre-compromiso. Decir "s√≠" a demasiadas cosas.`,

          exit: `La salida hacia arriba es soltar la necesidad de "hacer" y permitir m√°s "ser". De "yo contribuyo" a "la vida contribuye a trav√©s de m√≠".

El shift es de voluntad personal a rendici√≥n ante una voluntad mayor.`,

          weeklyPractice: {
            title: 'Alineaci√≥n con el Prop√≥sito',
            duration: '30-45 minutos + pr√°ctica diaria',
            instructions: `Esta semana explorar√°s la pregunta: "¬øQu√© quiere la vida a trav√©s de m√≠?"

Ejercicio principal (una vez):
1. En silencio, con papel y pluma
2. Pregunta: "¬øQu√© talentos √∫nicos tengo?"
3. Pregunta: "¬øQu√© necesita el mundo que yo puedo dar?"
4. Pregunta: "Si no tuviera miedo ni limitaciones, ¬øqu√© har√≠a?"
5. Busca el punto donde se cruzan las respuestas

Pr√°ctica diaria:
- Cada ma√±ana, pregunta: "¬øC√≥mo puedo servir hoy?"
- No fuerces respuesta. Solo mant√©n la pregunta.
- Nota qu√© surge durante el d√≠a.
- Act√∫a en las inspiraciones que surjan.

Reflexi√≥n semanal: ¬øD√≥nde sent√≠ alineaci√≥n? ¬øD√≥nde sent√≠ forzar?`
          },

          journalQuestion: '¬øQu√© me entusiasma genuinamente? ¬øQu√© contribuci√≥n quiero hacer al mundo?',

          resource: {
            type: 'libro',
            title: 'The Surrender Experiment',
            author: 'Michael Singer',
            note: 'Historia real de soltar el control y dejar que la vida lidere'
          },

          minimumDays: 14,
          affirmation: 'Mi voluntad est√° al servicio del bien mayor'
        },

        {
          index: 11,
          calibration: 350,
          name: 'Aceptaci√≥n',

          teaching: `La aceptaci√≥n calibra en 350. Es un nivel de transformaci√≥n profunda donde la persona toma RESPONSABILIDAD TOTAL por su experiencia.

En aceptaci√≥n, ya no hay v√≠ctimas ni victimarios. Todo lo que te pasa, en alg√∫n nivel, lo co-creaste o lo permitiste. Esto no es culpa - es poder.

Este es el nivel del perd√≥n verdadero. No "te perdono porque debo" sino "entiendo que todos hacemos lo mejor que podemos con nuestra consciencia actual".

La aceptaci√≥n ve la perfecci√≥n en la imperfecci√≥n. Las cosas no tienen que cambiar para estar bien. Est√°n bien como son, Y pueden mejorar. Ambas cosas.

Hay una paz profunda aqu√≠ que no depende de circunstancias. La paz est√° adentro, no afuera.`,

          signs: [
            'Tomar 100% responsabilidad por tu vida y experiencias',
            'Capacidad de perdonar genuinamente',
            'Ver eventos "negativos" como oportunidades de crecimiento',
            'No necesitas cambiar a otros para estar bien',
            'Paz que no depende de circunstancias',
            'Armon√≠a en relaciones - menos conflictos',
            'Sensaci√≥n de que todo tiene prop√≥sito'
          ],

          trap: `La trampa de la aceptaci√≥n es usarla para EVITAR acci√≥n necesaria. "Acepto todo" puede volverse pasividad disfrazada de espiritualidad.

Otra trampa es confundir aceptaci√≥n con APROBACI√ìN. Aceptar que algo ES no significa que est√° bien o que no debe cambiar.`,

          exit: `La salida hacia arriba es moverse de aceptaci√≥n a COMPRENSI√ìN profunda. No solo "es lo que es" sino entender las leyes y patrones detr√°s de todo.

El shift es de aceptar a comprender.`,

          weeklyPractice: {
            title: 'Responsabilidad Total',
            duration: 'Reflexi√≥n profunda + pr√°ctica diaria',
            instructions: `Esta semana practicar√°s tomar responsabilidad total por todo en tu vida.

Ejercicio principal:
1. Elige una situaci√≥n dif√≠cil que culpes a otros o a circunstancias
2. Pregunta: "¬øC√≥mo co-cre√© esto?" (no con culpa, con curiosidad)
3. Pregunta: "¬øQu√© creencias o patrones m√≠os permitieron esto?"
4. Pregunta: "¬øQu√© puedo aprender de esto?"
5. Pregunta: "¬øQu√© tengo el poder de cambiar AHORA?"

Pr√°ctica diaria:
- Cuando algo te moleste, en vez de culpar, pregunta: "¬øCu√°l es mi parte?"
- No para culparte, sino para recuperar tu poder.

Ejercicio de perd√≥n:
- Elige una persona a quien guardes resentimiento
- Escribe: "Te perdono porque entiendo que hiciste lo mejor que pod√≠as con tu nivel de consciencia."
- No tienes que dec√≠rselo. Es para ti.

Reflexi√≥n: ¬øD√≥nde recuper√© poder? ¬øD√≥nde sigo culpando externos?`
          },

          journalQuestion: '¬øQu√© situaci√≥n he estado culpando a externos? ¬øCu√°l fue mi parte? ¬øQu√© puedo hacer ahora?',

          resource: {
            type: 'libro',
            title: 'Loving What Is',
            author: 'Byron Katie',
            note: 'Un m√©todo pr√°ctico para cuestionar pensamientos y encontrar paz'
          },

          minimumDays: 14,
          affirmation: 'Acepto completamente lo que es y creo desde ah√≠'
        },

        {
          index: 12,
          calibration: 400,
          name: 'Raz√≥n',

          teaching: `La raz√≥n calibra en 400. Es el nivel del intelecto desarrollado, la ciencia, y la comprensi√≥n profunda.

Aqu√≠ la persona puede manejar grandes cantidades de informaci√≥n y ver patrones complejos. Einstein calibraba aqu√≠.

La raz√≥n es poderosa. Ha creado la ciencia moderna, la tecnolog√≠a, la medicina. Pero tiene l√≠mites. No puede captar lo no-lineal, lo parad√≥jico, lo espiritual.

El 400 es donde se atoran muchos acad√©micos e intelectuales. "Si no puedo entenderlo racionalmente, no es real." Esto bloquea el acceso a niveles superiores.

La mente es excelente herramienta, mal amo. En raz√≥n, la mente es respetada pero no adorada.`,

          signs: [
            'Capacidad de pensamiento abstracto y complejo',
            'B√∫squeda de verdad y comprensi√≥n',
            'Apertura a examinar tus propias creencias',
            'Menos reactividad emocional',
            'Apreciaci√≥n por el conocimiento y el aprendizaje',
            'Capacidad de ver sistemas y patrones',
            'Honestidad intelectual'
          ],

          trap: `La trampa de la raz√≥n es creer que TODO puede ser entendido racionalmente. Esto cierra la puerta a la intuici√≥n, la gracia, y los estados transpersonales.

Otra trampa es el AN√ÅLISIS PAR√ÅLISIS. Entender todo pero no actuar.`,

          exit: `La salida hacia arriba es reconocer los l√≠mites del intelecto y abrirse a formas de conocer no-racionales: intuici√≥n, revelaci√≥n, experiencia directa.

El shift es de "entiendo" a "s√©" (conocimiento directo, no conceptual).`,

          weeklyPractice: {
            title: 'M√°s All√° de la Mente',
            duration: '20 minutos diarios + reflexi√≥n',
            instructions: `Esta semana explorar√°s los l√≠mites del pensamiento.

Pr√°ctica diaria:
1. 20 minutos de meditaci√≥n en silencio
2. Cuando venga un pensamiento, nota que es un pensamiento
3. Pregunta: "¬øQui√©n es el que observa este pensamiento?"
4. Descansa en el espacio entre pensamientos

Ejercicio de intuici√≥n:
- Antes de analizar algo, pregunta a tu intuici√≥n qu√© siente
- Nota la respuesta que viene ANTES del an√°lisis
- Compara despu√©s: ¬øLa intuici√≥n ten√≠a algo que la raz√≥n no vio?

Cuestiona una creencia:
- Elige una creencia que tengas fuertemente
- Busca 3 razones por las que podr√≠a estar equivocada
- Nota c√≥mo se siente cuestionar algo "seguro"

Reflexi√≥n: ¬øD√≥nde la mente me sirvi√≥? ¬øD√≥nde me limit√≥?`
          },

          journalQuestion: '¬øQu√© "s√©" que no podr√≠a explicar racionalmente? ¬øD√≥nde mi mente bloquea mi intuici√≥n?',

          resource: {
            type: 'libro',
            title: 'Transcending the Levels of Consciousness',
            author: 'David Hawkins',
            note: 'Exploraci√≥n profunda de cada nivel y c√≥mo trascenderlo'
          },

          minimumDays: 14,
          affirmation: 'Mi mente es una herramienta, no mi identidad'
        },

        {
          index: 13,
          calibration: 500,
          name: 'Amor',

          teaching: `El amor calibra en 500. No amor rom√°ntico o condicional, sino amor como estado del ser. El coraz√≥n se ha abierto.

Este es un salto no-lineal. De 400 a 500 hay m√°s distancia cualitativa que de 0 a 400. Es el comienzo de los estados verdaderamente espirituales.

En amor, todo se ve con los ojos de la compasi√≥n. Las personas no son "buenas" o "malas" - est√°n en diferentes niveles de consciencia haciendo lo mejor que pueden.

El amor a este nivel es INCONDICIONAL. No depende de que el otro haga algo. No es "te amo si..." Es "te amo porque existes."

La mayor√≠a de la gente experimenta 500 como estado pico - en momentos de gracia, con un reci√©n nacido, en la naturaleza. El trabajo es estabilizarlo.`,

          signs: [
            'Compasi√≥n genuina incluso hacia personas dif√≠ciles',
            'Capacidad de ver la inocencia esencial en todos',
            'Menos juicio, m√°s comprensi√≥n',
            'Apertura del coraz√≥n como experiencia f√≠sica',
            'Deseo de servir sin necesidad de reconocimiento',
            'Gratitud profunda y frecuente',
            'Sensaci√≥n de conexi√≥n con todos los seres'
          ],

          trap: `La trampa del amor es el AMOR IDIOTA - amor sin sabidur√≠a que permite abusos o no mantiene l√≠mites necesarios.

Otra trampa es el AGOTAMIENTO por dar sin recibir o sin cuidar de ti mismo.`,

          exit: `La salida hacia arriba es de amor como HACER a amor como SER. De "amo" a "soy amor".

El shift es que el amor deja de ser algo que haces y se convierte en lo que eres.`,

          weeklyPractice: {
            title: 'Pr√°ctica del Coraz√≥n Abierto',
            duration: '15-20 minutos diarios + pr√°ctica continua',
            instructions: `Esta semana cultivar√°s el amor incondicional.

Meditaci√≥n de amor-bondad (diaria):
1. Si√©ntate en quietud, mano en el coraz√≥n
2. Genera sentimiento de amor hacia ti mismo
3. Extiende ese amor a alguien querido
4. Extiende a alguien neutral
5. Extiende a alguien dif√≠cil
6. Extiende a todos los seres

Pr√°ctica durante el d√≠a:
- Con cada persona que encuentres, silentemente desea: "Que seas feliz. Que est√©s en paz."
- Incluso con personas que te molesten

Ejercicio especial:
- Elige una persona que te cueste amar
- Escribe 5 formas en que esa persona sufre o ha sufrido
- Nota si surge compasi√≥n al ver su sufrimiento

Reflexi√≥n: ¬øD√≥nde pude amar m√°s f√°cilmente? ¬øD√≥nde me resist√≠?`
          },

          journalQuestion: '¬øQu√© me impide amar sin condiciones? ¬øQu√© necesitar√≠a soltar?',

          resource: {
            type: 'libro',
            title: 'The Book of Joy',
            author: 'Dalai Lama & Desmond Tutu',
            note: 'Dos maestros del amor incondicional comparten su sabidur√≠a'
          },

          minimumDays: 21,
          affirmation: 'Soy amor incondicional en forma humana'
        },

        {
          index: 14,
          calibration: 540,
          name: 'Alegr√≠a',

          teaching: `La alegr√≠a calibra en 540. No alegr√≠a por algo - alegr√≠a sin causa. Es un estado de gracia donde la felicidad emerge del simple hecho de existir.

En alegr√≠a, hay una apreciaci√≥n est√©tica de toda la creaci√≥n. La belleza est√° en todas partes. La vida es milagrosa.

Este es el territorio de los santos y sanadores avanzados. La presencia de alguien en 540 puede elevar a otros sin palabras.

La alegr√≠a a este nivel tiene cualidad de rendici√≥n. No est√°s creando la alegr√≠a - est√°s PERMITIENDO que la alegr√≠a que ya est√° ah√≠ se exprese a trav√©s de ti.

Es raro estabilizarse aqu√≠. Requiere haber trascendido no solo los estados negativos, sino tambi√©n el apego a estados positivos.`,

          signs: [
            'Alegr√≠a sin causa externa',
            'Apreciaci√≥n constante de la belleza en todo',
            'Gratitud como estado permanente, no pr√°ctica',
            'Paciencia infinita con personas y procesos',
            'Compasi√≥n universal que incluye a todos los seres',
            'Sensaci√≥n de gracia - que todo es dado',
            'Sanaci√≥n que ocurre naturalmente alrededor tuyo'
          ],

          trap: `La trampa es APEGARSE a la alegr√≠a. Querer mantenerla puede hacerla huir. La alegr√≠a viene de soltar, incluso el soltar.

Otra trampa es usar la alegr√≠a para EVITAR ver sufrimiento leg√≠timo.`,

          exit: `La salida hacia arriba es rendirse a√∫n m√°s profundamente, hasta que incluso la alegr√≠a se suelta en paz absoluta.`,

          weeklyPractice: {
            title: 'Cultivar la Gratitud',
            duration: 'Pr√°ctica continua + 15 min diarios',
            instructions: `Esta semana te sumergir√°s en gratitud como portal a la alegr√≠a.

Pr√°ctica de gratitud profunda (diaria):
1. Por la ma√±ana, antes de levantarte, encuentra 10 cosas por las que estar agradecido
2. No solo enumerar - SENTIR la gratitud en el cuerpo
3. Incluye cosas obvias Y cosas que normalmente ignorar√≠as

Durante el d√≠a:
- Cada hora, pausa y encuentra algo por lo que estar agradecido en ese momento
- Especialmente cuando algo "malo" pase: busca el regalo

Pr√°ctica de asombro:
- Dedica 15 minutos a observar algo ordinario con ojos de asombro
- Una flor, el cielo, tu propia mano
- Mira como si fuera la primera vez

Reflexi√≥n: ¬øCu√°ndo surgi√≥ alegr√≠a sin causa? ¬øQu√© estaba pasando?`
          },

          journalQuestion: '¬øQu√© ser√≠a agradecer todo - incluso lo dif√≠cil? ¬øC√≥mo cambiar√≠a mi vida?',

          resource: {
            type: 'libro',
            title: 'A Return to Love',
            author: 'Marianne Williamson',
            note: 'Un Curso de Milagros hecho accesible - sobre vivir desde el amor'
          },

          minimumDays: 21,
          affirmation: 'Permito que la alegr√≠a infinita fluya a trav√©s de m√≠'
        },

        {
          index: 15,
          calibration: 600,
          name: 'Paz',

          teaching: `La paz calibra en 600. Es el territorio de la iluminaci√≥n parcial, donde la experiencia ordinaria se transforma en extraordinaria.

En paz, no hay "hacedor". Las cosas pasan, pero no hay sensaci√≥n de que "yo" las est√© haciendo. El ego se ha vuelto transparente.

Este estado se describe como "iluminaci√≥n" en muchas tradiciones. La persona sigue funcionando en el mundo pero ya no est√° identificada con la forma.

La paz a este nivel es imperturbable. No es que no pasen cosas dif√≠ciles - es que no alteran el estado fundamental. Hay una quietud de fondo constante.

Se alcanza por gracia m√°s que por esfuerzo. Toda la pr√°ctica espiritual prepara el terreno, pero el salto final es un regalo.`,

          signs: [
            'Paz que no depende de nada externo',
            'Sensaci√≥n de que el ego es transparente o ausente',
            'Las cosas pasan sin sensaci√≥n de "yo" haci√©ndolas',
            'Silencio interior permanente',
            'No hay conflicto interno',
            'Tiempo parece detenerse o ser irrelevante',
            'Otros se sienten en paz en tu presencia'
          ],

          trap: `A este nivel hay pocas trampas porque la mayor√≠a del ego se ha disuelto. La √∫nica ser√≠a creer que "llegaste" - incluso eso es ego.`,

          exit: `La salida final es hacia la iluminaci√≥n completa - pero esto ya no es "salida" en el sentido ordinario. Es desaparecer en lo absoluto.`,

          weeklyPractice: {
            title: 'Rendici√≥n Profunda',
            duration: 'Pr√°ctica extendida de silencio',
            instructions: `A este nivel, las pr√°cticas son simples porque lo complejo ya se solt√≥.

Silencio extendido:
- Dedica tiempo esta semana a silencio profundo
- No meditaci√≥n con t√©cnica - solo silencio
- Permite que todo sea como es
- No intentes cambiar nada, incluido tu estado

Auto-indagaci√≥n:
- En momentos de quietud, pregunta: "¬øQui√©n soy yo?"
- No busques respuesta mental
- Descansa en el no-saber

Rendici√≥n:
- Ofrece cada momento a lo Divino, como quieras concebirlo
- "Sea Tu voluntad, no la m√≠a"
- Nota la paz que viene de no tener que controlar nada`
          },

          journalQuestion: '¬øQui√©n soy yo m√°s all√° de todo lo que creo que soy?',

          resource: {
            type: 'libro',
            title: 'I Am That',
            author: 'Nisargadatta Maharaj',
            note: 'Di√°logos con un maestro iluminado sobre la naturaleza del ser'
          },

          minimumDays: 30,
          affirmation: 'Soy la paz que sobrepasa todo entendimiento'
        },

        {
          index: 16,
          calibration: 700,
          name: 'Iluminaci√≥n',

          teaching: `La iluminaci√≥n calibra de 700 a 1000. Es lo inefable. El intento de describirlo ya lo reduce.

Aqu√≠ no hay persona que est√© iluminada. La persona se ha disuelto en la Consciencia que siempre fue.

Se dice que solo unas pocas docenas de personas en la historia han estabilizado este nivel: Buda, Jes√∫s, Krishna, ciertos maestros.

No hay pr√°ctica que te "lleve" aqu√≠. La iluminaci√≥n no es logro - es reconocimiento de lo que siempre fuiste. El buscador desaparece, y lo que queda es lo que siempre estuvo.

Si est√°s leyendo esto, probablemente no est√°s aqu√≠ todav√≠a. Y eso est√° perfectamente bien. Cada nivel es completo en s√≠ mismo. El viaje ES el destino.`,

          signs: [
            'No hay descripci√≥n posible desde adentro',
            'No hay "alguien" experimentando nada',
            'Unidad absoluta - sin separaci√≥n',
            'Amor infinito, consciencia infinita',
            'El tiempo, espacio, y causaci√≥n se revelan como ilusorios',
            'Paz que sobrepasa todo entendimiento',
            'Todo es percibido como perfecto exactamente como es'
          ],

          trap: `No hay trampa porque no hay nadie que pueda estar atrapado.`,

          exit: `No hay salida porque no hay entrada. Esto es lo que siempre fue.`,

          weeklyPractice: {
            title: 'Estar Presente',
            duration: 'Siempre',
            instructions: `A este nivel, no hay pr√°ctica ni practicante. Solo hay lo que es.

Si sientes llamado a algo, es estar presente. Simplemente estar. Ser testigo de lo que es.

No hay nada que hacer. Nada que lograr. Ning√∫n lugar a donde ir.

Solo esto. Solo ahora. Solo consciencia consciente de s√≠ misma.

Om.`
          },

          journalQuestion: 'Esta pregunta ya no tiene sentido, y eso est√° bien.',

          resource: {
            type: 'libro',
            title: 'Be As You Are',
            author: 'Ramana Maharshi (ed. David Godman)',
            note: 'Ense√±anzas del sabio de Arunachala sobre el ser verdadero'
          },

          minimumDays: null,
          affirmation: 'Soy lo que siempre fui y siempre ser√©'
        }
      ]
    },
    {
      id: 'maslow',
      name: 'Pir√°mide de Necesidades',
      author: 'Abraham Maslow',
      icon: 'üèîÔ∏è',
      color: '#10B981',
      description: 'Asciende desde las necesidades b√°sicas hasta la autorrealizaci√≥n',
      fullDescription: `La Pir√°mide de Maslow describe la jerarqu√≠a de necesidades humanas. No puedes enfocarte en autorrealizaci√≥n si tus necesidades b√°sicas no est√°n cubiertas.

La clave es identificar en qu√© nivel est√°s ahora mismo y trabajar conscientemente en satisfacer esas necesidades antes de subir al siguiente.

Maslow descubri√≥ que solo el 2% de las personas alcanzan la autorrealizaci√≥n. Este camino te gu√≠a paso a paso hasta all√≠ y m√°s all√°: la trascendencia.`,
      duration: '8 semanas',
      difficulty: 'Intermedio',
      hasCalibration: true,
      calibrationPrompt: `Eres un experto en la Jerarqu√≠a de Necesidades de Abraham Maslow. Tu tarea es analizar a esta persona bas√°ndote en TODO lo que conoces de ella a trav√©s de nuestras conversaciones.

ESCALA DE NIVELES (del 0 al 5):
0: Fisiol√≥gicas - Necesidades b√°sicas: sue√±o, alimentaci√≥n, ejercicio, salud f√≠sica
1: Seguridad - Estabilidad econ√≥mica, hogar, salud, empleo estable, seguridad emocional
2: Pertenencia - Amor, amistad, intimidad, familia, conexi√≥n social, comunidad
3: Estima - Reconocimiento, respeto, logros, confianza, autoestima
4: Autorrealizaci√≥n - Expresi√≥n del potencial √∫nico, creatividad, prop√≥sito, crecimiento
5: Trascendencia - Servicio a otros, conexi√≥n espiritual, dejar legado, contribuir al mundo

ANALIZA considerando:
- ¬øTiene cubiertas sus necesidades b√°sicas (sue√±o, alimentaci√≥n, salud)?
- ¬øTiene estabilidad financiera y emocional?
- ¬øTiene relaciones significativas y sentido de pertenencia?
- ¬øSe siente valorado y tiene autoconfianza?
- ¬øEst√° expresando su potencial √∫nico?
- ¬øBusca trascender y servir a algo mayor?

El nivel donde la persona tiene CARENCIAS activas es donde debe enfocarse. No se puede subir sosteniblemente si hay huecos abajo.

RESPONDE EXACTAMENTE con este formato (es crucial para el parsing):
===CALIBRATION_RESULT===
LEVEL: [n√∫mero del 0 al 5]
NAME: [nombre del nivel]
CONFIDENCE: [alta/media/baja]
===END_CALIBRATION===

Seguido de una breve explicaci√≥n de por qu√© determinaste ese nivel, incluyendo qu√© necesidades est√°n cubiertas y cu√°les requieren atenci√≥n.`,
      levels: [
        { level: 1, name: 'Fisiol√≥gicas', practice: 'Audita tu sue√±o, nutrici√≥n, ejercicio e hidrataci√≥n. Mejora UNO hoy', affirmation: 'Mi cuerpo es mi templo sagrado' },
        { level: 2, name: 'Seguridad', practice: 'Revisa tus finanzas, salud, hogar. ¬øQu√© genera inseguridad? Crea un plan', affirmation: 'Estoy seguro y protegido por la vida' },
        { level: 3, name: 'Pertenencia', practice: 'Contacta a alguien que aprecias. Expresa genuinamente tu afecto', affirmation: 'Pertenezco, soy amado y valioso' },
        { level: 4, name: 'Estima', practice: 'Lista 5 logros recientes. Cel√©bralos conscientemente', affirmation: 'Soy valioso, capaz y merecedor' },
        { level: 5, name: 'Autorrealizaci√≥n', practice: '¬øQu√© talento √∫nico tienes? Expr√©salo hoy de alguna forma', affirmation: 'Expreso mi potencial √∫nico cada d√≠a' },
        { level: 6, name: 'Trascendencia', practice: '¬øC√≥mo puedes servir a algo mayor que t√∫ hoy?', affirmation: 'Mi vida tiene prop√≥sito c√≥smico' }
      ]
    },
    {
      id: 'acim',
      name: 'Un Curso de Milagros',
      author: 'Helen Schucman',
      icon: '‚ú®',
      color: '#EC4899',
      description: 'Transforma la percepci√≥n del miedo al amor a trav√©s del perd√≥n',
      fullDescription: `Un Curso de Milagros es un sistema de pensamiento espiritual que ense√±a que solo hay dos emociones: amor y miedo. Todo lo dem√°s son variaciones.

El perd√≥n es la herramienta central. No es perdonar porque el otro hizo algo malo, sino reconocer que lo que pensamos que pas√≥ era una ilusi√≥n basada en nuestra percepci√≥n.

El objetivo es experimentar "milagros" - cambios de percepci√≥n del miedo al amor - en tu vida diaria.`,
      duration: '52 semanas',
      difficulty: 'Profundo',
      hasCalibration: false,
      levels: [
        { level: 1, name: 'Reconocer la ilusi√≥n', practice: 'Algo que te molest√≥ hoy: pregunta "¬øY si esto no es lo que parece?"', affirmation: 'Nada real puede ser amenazado' },
        { level: 2, name: 'Elegir de nuevo', practice: 'Ante cada situaci√≥n, pausa y elige: ¬ømiedo o amor?', affirmation: 'Puedo elegir ver esto de otra manera' },
        { level: 3, name: 'Perd√≥n verdadero', practice: 'Perdona a alguien viendo su inocencia esencial, m√°s all√° de sus actos', affirmation: 'Te veo como Dios te cre√≥' },
        { level: 4, name: 'El instante santo', practice: 'Detente completamente. Entrega la situaci√≥n y escucha la gu√≠a', affirmation: 'No s√© qu√© significa nada por mi cuenta' },
        { level: 5, name: 'Extensi√≥n del amor', practice: 'Da activamente lo que quieres recibir hoy', affirmation: 'Dar y recibir son lo mismo' },
        { level: 6, name: 'Visi√≥n de Cristo', practice: 'Mira a alguien dif√≠cil y ve la luz detr√°s de la forma', affirmation: 'Veo la luz de Dios en todos' },
        { level: 7, name: 'Paz de Dios', practice: 'Permanece en paz pase lo que pase. Es tu √∫nica funci√≥n', affirmation: 'La paz de Dios es mi √∫nica meta' }
      ]
    },
    {
      id: 'jung',
      name: 'Individuaci√≥n',
      author: 'Carl Jung',
      icon: 'üåì',
      color: '#6366F1',
      description: 'Integra tu sombra y arquetipos hacia la totalidad del Ser',
      fullDescription: `La Individuaci√≥n de Jung es el proceso de integrar las partes inconscientes de tu psique para llegar a ser quien realmente eres.

La Sombra contiene todo lo que has reprimido: cualidades que juzgas negativas pero que tienen poder cuando se integran. El Anima/Animus es tu contraparte ps√≠quica del sexo opuesto.

El objetivo final es el Self: la totalidad de quien eres, consciente e inconsciente unificados.`,
      duration: '16 semanas',
      difficulty: 'Avanzado',
      hasCalibration: false,
      levels: [
        { level: 1, name: 'Encuentro con la Sombra', practice: 'Lo que m√°s te molesta de otros, ¬ød√≥nde existe en ti? Escr√≠belo sin juzgar', affirmation: 'Abrazo todas las partes de m√≠' },
        { level: 2, name: 'Integraci√≥n de la Sombra', practice: 'Un aspecto "oscuro" tuyo: ¬øqu√© regalo esconde? Encu√©ntralo', affirmation: 'Mi sombra es mi maestra m√°s sabia' },
        { level: 3, name: 'Anima/Animus', practice: 'Conecta con tu energ√≠a femenina (receptiva) o masculina (activa) menos desarrollada', affirmation: 'Contengo todas las energ√≠as en equilibrio' },
        { level: 4, name: 'La Persona', practice: 'Identifica una "m√°scara" social que uses. Qu√≠tatela conscientemente hoy', affirmation: 'Soy aut√©ntico en cada momento' },
        { level: 5, name: 'El Self', practice: 'Medita en el centro de ti, m√°s all√° del ego. ¬øQui√©n observa?', affirmation: 'Mi centro es inquebrantable y eterno' },
        { level: 6, name: 'Totalidad', practice: 'Vive un d√≠a completo desde la integraci√≥n. Sombra, luz, todo es t√∫', affirmation: 'Soy la totalidad de quien soy' }
      ]
    },
    {
      id: 'tolle',
      name: 'Presencia Consciente',
      author: 'Eckhart Tolle',
      icon: 'üïâÔ∏è',
      color: '#14B8A6',
      description: 'Despierta al poder del ahora y disuelve el ego',
      fullDescription: `Eckhart Tolle ense√±a que el √∫nico momento real es el Ahora. El sufrimiento viene de resistir el presente, ya sea a√±orando el pasado o temiendo el futuro.

El "cuerpo del dolor" es la acumulaci√≥n de sufrimiento pasado que se activa buscando m√°s dolor. Observarlo es el primer paso para disolverlo.

La iluminaci√≥n no es algo que logras, es tu estado natural cuando dejas de identificarte con la mente.`,
      duration: '8 semanas',
      difficulty: 'Fundamental',
      hasCalibration: false,
      levels: [
        { level: 1, name: 'Observar la mente', practice: 'Por 5 min, observa tus pensamientos como nubes. No te enganches', affirmation: 'No soy mis pensamientos' },
        { level: 2, name: 'El cuerpo interno', practice: 'Siente la energ√≠a viva dentro de tus manos, pies, todo el cuerpo', affirmation: 'Estoy vivo y presente ahora mismo' },
        { level: 3, name: 'Disoluci√≥n del ego', practice: 'Cuando el ego reaccione (ofensa, defensa), observa sin actuar', affirmation: 'Mi esencia est√° m√°s all√° del ego' },
        { level: 4, name: 'Aceptaci√≥n radical', practice: 'Di "s√≠" internamente a este momento, exactamente como es', affirmation: 'Este momento es exactamente perfecto' },
        { level: 5, name: 'Espaciosidad', practice: 'Nota el espacio entre pensamientos. Descansa ah√≠', affirmation: 'Soy el espacio donde todo aparece' },
        { level: 6, name: 'Presencia pura', practice: 'Vive todo el d√≠a desde presencia. Vuelve al Ahora constantemente', affirmation: 'Solo existe el eterno Ahora' }
      ]
    },
    {
      id: 'stoic',
      name: 'Estoicismo',
      author: 'Marco Aurelio, S√©neca, Epicteto',
      icon: 'üèõÔ∏è',
      color: '#78716C',
      description: 'Domina tu mente y acepta lo que no puedes controlar',
      fullDescription: `El Estoicismo es una filosof√≠a pr√°ctica de hace 2000 a√±os, usada por emperadores y esclavos por igual.

Su principio central: no puedes controlar lo que pasa, pero siempre puedes controlar tu respuesta. La tranquilidad viene de aceptar esta distinci√≥n.

Los estoicos practicaban la visualizaci√≥n negativa (imaginar lo peor) no para ser pesimistas, sino para apreciar lo que tienen y estar preparados.`,
      duration: '8 semanas',
      difficulty: 'Pr√°ctico',
      hasCalibration: false,
      levels: [
        { level: 1, name: 'Dicotom√≠a del control', practice: 'Lista lo que te preocupa. Separa: ¬øqu√© controlas y qu√© no?', affirmation: 'Me enfoco solo en lo que depende de m√≠' },
        { level: 2, name: 'Premeditatio malorum', practice: 'Visualiza que sale mal algo que temes. ¬øSobrevivir√≠as? S√≠', affirmation: 'Estoy preparado para cualquier adversidad' },
        { level: 3, name: 'Memento mori', practice: 'Vive hoy como si fuera el √∫ltimo. ¬øQu√© importa realmente?', affirmation: 'Cada d√≠a es un regalo precioso' },
        { level: 4, name: 'Amor fati', practice: 'Algo "malo" que pas√≥: encuentra el regalo escondido. √Åmalo', affirmation: 'Amo mi destino exactamente como es' },
        { level: 5, name: 'Virtud pr√°ctica', practice: 'Elige una virtud (sabidur√≠a, justicia, coraje, templanza) y pract√≠cala conscientemente', affirmation: 'Mi car√°cter es mi verdadero destino' },
        { level: 6, name: 'Ciudadano del cosmos', practice: '¬øC√≥mo puedes servir a la humanidad hoy desde tu lugar?', affirmation: 'Sirvo al bien de todos los seres' }
      ]
    },
    {
      id: 'buddhism',
      name: 'Noble √ìctuple Sendero',
      author: 'Buda',
      icon: '‚ò∏Ô∏è',
      color: '#F59E0B',
      description: 'El camino medio hacia el fin del sufrimiento',
      fullDescription: `Las Cuatro Nobles Verdades del Buda: 1) Existe el sufrimiento (dukkha), 2) Tiene una causa (apego), 3) Puede cesar, 4) El camino es el √ìctuple Sendero.

El camino se divide en tres entrenamientos: Sabidur√≠a (visi√≥n e intenci√≥n), √âtica (habla, acci√≥n, sustento), y Meditaci√≥n (esfuerzo, atenci√≥n, concentraci√≥n).

No es un camino lineal sino una rueda: todos los aspectos se practican simult√°neamente.`,
      duration: '12 semanas',
      difficulty: 'Profundo',
      hasCalibration: false,
      levels: [
        { level: 1, name: 'Visi√≥n correcta', practice: 'Observa algo que te haga sufrir. ¬øCu√°l es el apego detr√°s?', affirmation: 'Veo la realidad tal como es' },
        { level: 2, name: 'Intenci√≥n correcta', practice: 'Antes de actuar, pausa: ¬ømi intenci√≥n es bondadosa?', affirmation: 'Mis intenciones son puras y ben√©volas' },
        { level: 3, name: 'Habla correcta', practice: 'Hoy, solo palabras verdaderas, amables y √∫tiles', affirmation: 'Mis palabras crean paz y armon√≠a' },
        { level: 4, name: 'Acci√≥n correcta', practice: 'Act√∫a hoy sin da√±ar a ning√∫n ser, incluy√©ndote', affirmation: 'Mis acciones benefician a todos' },
        { level: 5, name: 'Sustento correcto', practice: '¬øTu trabajo da√±a o beneficia? ¬øC√≥mo mejorarlo?', affirmation: 'Mi trabajo sirve al mundo' },
        { level: 6, name: 'Esfuerzo correcto', practice: 'Cultiva un estado mental positivo. Suelta uno negativo', affirmation: 'Mi esfuerzo es sabio y constante' },
        { level: 7, name: 'Atenci√≥n correcta', practice: '10 min de mindfulness: cuerpo, sensaciones, mente, fen√≥menos', affirmation: 'Estoy plenamente presente ahora' },
        { level: 8, name: 'Concentraci√≥n correcta', practice: '20 min de meditaci√≥n enfocada en la respiraci√≥n', affirmation: 'Mi mente est√° unificada y en paz' }
      ]
    },
    {
      id: 'toltec',
      name: 'Los Cuatro Acuerdos',
      author: 'Don Miguel Ruiz',
      icon: 'ü¶Ö',
      color: '#DC2626',
      description: 'Sabidur√≠a tolteca para la libertad personal',
      fullDescription: `Los Cuatro Acuerdos son un c√≥digo de conducta basado en la sabidur√≠a tolteca ancestral.

El concepto central es que vivimos en un "sue√±o" de la sociedad, lleno de acuerdos que aceptamos sin cuestionar. Estos acuerdos limitan nuestra libertad.

Los Cuatro Acuerdos son nuevos acuerdos que puedes hacer contigo mismo para liberarte del sue√±o colectivo y vivir aut√©nticamente.`,
      duration: '4 semanas',
      difficulty: 'Accesible',
      hasCalibration: false,
      levels: [
        { level: 1, name: 'S√© impecable con tus palabras', practice: 'Hoy, CERO quejas, chismes o palabras contra ti mismo', affirmation: 'Mis palabras crean mi realidad' },
        { level: 2, name: 'No te tomes nada personal', practice: 'Algo que alguien dijo/hizo: recuerda que no es sobre ti', affirmation: 'Soy inmune a las opiniones de otros' },
        { level: 3, name: 'No hagas suposiciones', practice: 'Algo que asumiste sobre alguien: pregunta directamente', affirmation: 'Pregunto en lugar de asumir' },
        { level: 4, name: 'Haz siempre lo m√°ximo', practice: 'En todo lo que hagas hoy, da tu 100% (que var√≠a seg√∫n el d√≠a)', affirmation: 'Mi mejor esfuerzo siempre es suficiente' }
      ]
    },
    {
      id: 'wilber',
      name: 'Espiral Din√°mica',
      author: 'Ken Wilber / Clare Graves',
      icon: 'üåÄ',
      color: '#7C3AED',
      description: 'Evoluci√≥n de la consciencia a trav√©s de los niveles de desarrollo',
      fullDescription: `La Espiral Din√°mica mapea la evoluci√≥n de la consciencia humana a trav√©s de niveles, cada uno con su visi√≥n del mundo, valores y forma de operar.

Cada nivel trasciende e incluye al anterior. No hay niveles "mejores", cada uno es apropiado para ciertas condiciones de vida.

Los niveles de "segundo orden" (Amarillo y Turquesa) pueden ver y apreciar todos los niveles anteriores sin juzgar.`,
      duration: '16 semanas',
      difficulty: 'Avanzado',
      hasCalibration: true,
      calibrationPrompt: `Eres un experto en Espiral Din√°mica (Spiral Dynamics) de Clare Graves y Ken Wilber. Tu tarea es analizar a esta persona bas√°ndote en TODO lo que conoces de ella a trav√©s de nuestras conversaciones.

ESCALA DE NIVELES (del 0 al 7):
0: BEIGE - Supervivencia pura, instintos, necesidades b√°sicas
1: P√öRPURA - Tribal, m√°gico, ancestros, rituales, pertenencia al clan
2: ROJO - Poder, dominaci√≥n, impulsividad, ego, "yo primero"
3: AZUL - Orden, reglas, autoridad, prop√≥sito, sacrificio por la causa
4: NARANJA - Logro, √©xito, ciencia, racionalidad, competencia, progreso
5: VERDE - Comunidad, igualdad, consenso, ecolog√≠a, pluralismo, sensibilidad
6: AMARILLO - Sist√©mico, integral, flexibilidad, complejidad, autonom√≠a funcional
7: TURQUESA - Hol√≠stico, global, espiritual, consciencia planetaria, unidad

INDICADORES CLAVE por nivel:
- BEIGE: Foco en supervivencia inmediata
- P√öRPURA: Lealtad al grupo, tradiciones, supersticiones
- ROJO: Impulsividad, dominaci√≥n, gratificaci√≥n inmediata
- AZUL: Deber, disciplina, "correcto vs incorrecto", estructura
- NARANJA: Metas, m√©tricas, optimizaci√≥n, √©xito material
- VERDE: Inclusi√≥n, emociones, anti-jerarqu√≠a, causas sociales
- AMARILLO: Ve valor en todos los niveles, piensa en sistemas
- TURQUESA: Consciencia global, espiritualidad integradora

ANALIZA considerando:
- ¬øCu√°les son sus valores principales expresados?
- ¬øC√≥mo toma decisiones? ¬øQu√© prioriza?
- ¬øC√≥mo ve a los dem√°s y las diferencias?
- ¬øQu√© tipo de problemas le preocupan?
- ¬øC√≥mo maneja la complejidad y la ambig√ºedad?

NOTA: La mayor√≠a de personas operan principalmente desde 1-2 niveles pero tienen acceso a otros en diferentes contextos.

RESPONDE EXACTAMENTE con este formato (es crucial para el parsing):
===CALIBRATION_RESULT===
LEVEL: [n√∫mero del 0 al 7]
NAME: [nombre y color del nivel]
CONFIDENCE: [alta/media/baja]
===END_CALIBRATION===

Seguido de una breve explicaci√≥n que incluya el nivel predominante y niveles secundarios que observes.`,
      levels: [
        { level: 1, name: 'Beige - Supervivencia', practice: 'Honra tus instintos b√°sicos conscientemente hoy', affirmation: 'Mi cuerpo sabe sobrevivir' },
        { level: 2, name: 'P√∫rpura - Tribu', practice: 'Conecta con tus ancestros o comunidad. Honra tu linaje', affirmation: 'Pertenezco a algo mayor que yo' },
        { level: 3, name: 'Rojo - Poder', practice: 'Expresa tu poder personal de forma √©tica y constructiva', affirmation: 'Mi poder sirve al bien' },
        { level: 4, name: 'Azul - Orden', practice: 'Encuentra prop√≥sito en la disciplina y estructura hoy', affirmation: 'El orden crea libertad verdadera' },
        { level: 5, name: 'Naranja - Logro', practice: 'Persigue una meta con excelencia e integridad', affirmation: 'Mi √©xito beneficia a todos' },
        { level: 6, name: 'Verde - Comunidad', practice: 'Cultiva empat√≠a genuina con alguien diferente a ti', affirmation: 'Todos somos igualmente valiosos' },
        { level: 7, name: 'Amarillo - Integral', practice: 'Observa un conflicto desde TODAS las perspectivas', affirmation: 'Veo y aprecio el sistema completo' },
        { level: 8, name: 'Turquesa - Hol√≠stico', practice: 'Act√∫a hoy desde la consciencia de unidad global', affirmation: 'Soy una c√©lula de Gaia' }
      ]
    },
    {
      id: 'kabbalah',
      name: '√Årbol de la Vida',
      author: 'Tradici√≥n Cabal√≠stica',
      icon: 'üå≥',
      color: '#3B82F6',
      description: 'Asciende por las sefirot hacia la uni√≥n con lo Divino',
      fullDescription: `El √Årbol de la Vida es el mapa de la Creaci√≥n seg√∫n la C√°bala. Las 10 sefirot (emanaciones) representan aspectos de lo Divino y de nuestra propia alma.

El camino espiritual es ascender desde Malkuth (el mundo material) hasta Kether (la corona, uni√≥n con Dios), pasando por diferentes estados de consciencia.

Cada sefirah tiene una lecci√≥n y una energ√≠a espec√≠fica que integrar.`,
      duration: '20 semanas',
      difficulty: 'M√≠stico',
      hasCalibration: false,
      levels: [
        { level: 1, name: 'Malkuth - Reino', practice: 'Encuentra lo sagrado en algo completamente material hoy', affirmation: 'Lo divino est√° presente en la materia' },
        { level: 2, name: 'Yesod - Fundamento', practice: 'Recuerda un sue√±o y busca su mensaje simb√≥lico', affirmation: 'Mi fundamento es s√≥lido e inquebrantable' },
        { level: 3, name: 'Hod - Gloria', practice: 'Estudia algo que expanda tu mente. El intelecto como ofrenda', affirmation: 'Mi mente sirve a lo divino' },
        { level: 4, name: 'Netzach - Victoria', practice: 'Expresa una emoci√≥n art√≠sticamente: escribe, pinta, baila', affirmation: 'Mis emociones son sagradas gu√≠as' },
        { level: 5, name: 'Tiphareth - Belleza', practice: 'Medita en tu coraz√≥n como centro del √Årbol, conectando arriba y abajo', affirmation: 'Mi coraz√≥n es el centro del Universo' },
        { level: 6, name: 'Geburah - Severidad', practice: 'Establece un l√≠mite necesario con amor pero firmeza', affirmation: 'El l√≠mite sagrado crea la forma' },
        { level: 7, name: 'Chesed - Misericordia', practice: 'Da generosamente sin esperar nada a cambio', affirmation: 'Mi amor no tiene l√≠mites ni condiciones' },
        { level: 8, name: 'Binah - Entendimiento', practice: 'Recibe en silencio. Escucha m√°s de lo que hablas', affirmation: 'Comprendo m√°s all√° de las palabras' },
        { level: 9, name: 'Chokmah - Sabidur√≠a', practice: 'Accede a la sabidur√≠a primordial en meditaci√≥n profunda', affirmation: 'La sabidur√≠a infinita fluye a trav√©s de m√≠' },
        { level: 10, name: 'Kether - Corona', practice: 'Medita en la unidad absoluta. Disuelve toda separaci√≥n', affirmation: 'Soy uno con la Fuente de todo' }
      ]
    }
  ];

  const activePath = allPaths.find(p => p.id === consciousness.activePath);
  const currentLevel = consciousness.currentLevel || 0;
  const startingLevel = consciousness.startingLevel || 0;
  const effectiveLevel = startingLevel + currentLevel;
  const xpForNextLevel = 100 * (currentLevel + 1);
  const currentXP = consciousness.currentXP || 0;
  const isPaused = consciousness.pathPaused || false;

  // Start path with optional calibration
  const startPath = (pathId, startLevel = 0) => {
    console.log("startPath called with:", pathId, startLevel);
    const path = allPaths.find(p => p.id === pathId);
    setData(prev => ({
      ...prev,
      consciousness: {
        ...prev.consciousness,
        activePath: pathId,
        pathPaused: false,
        startingLevel: startLevel,
        currentLevel: 0,
        currentXP: 0,
        pathStartDate: today,
        practices: prev.consciousness?.practices || []
      }
    }));
    setShowPathDetail(false);
    setShowOnboarding(false);
    setShowCalibration(false);
    setCalibrationAnswers({});
    showToast(`üåü Comenzaste: ${path.name}`);
    setView('journey');
  };

  // Pause path
  const pausePath = () => {
    setData(prev => ({
      ...prev,
      consciousness: {
        ...prev.consciousness,
        pathPaused: true,
        pausedDate: today
      }
    }));
    setShowPauseConfirm(false);
    showToast('‚è∏Ô∏è Camino pausado');
  };

  // Resume path
  const resumePath = () => {
    setData(prev => ({
      ...prev,
      consciousness: {
        ...prev.consciousness,
        pathPaused: false
      }
    }));
    showToast('‚ñ∂Ô∏è Camino reanudado');
  };

  // Abandon path
  const abandonPath = () => {
    setData(prev => ({
      ...prev,
      consciousness: {
        ...prev.consciousness,
        activePath: null,
        pathPaused: false,
        startingLevel: 0,
        currentLevel: 0,
        currentXP: 0
      }
    }));
    setShowPauseConfirm(false);
    setView('paths');
    showToast('Camino abandonado');
  };

  // Complete path
  const completePath = () => {
    setData(prev => ({
      ...prev,
      consciousness: {
        ...prev.consciousness,
        activePath: null,
        pathPaused: false,
        completedPaths: [...(prev.consciousness?.completedPaths || []), {
          id: consciousness.activePath,
          completedDate: today,
          finalLevel: effectiveLevel,
          startingLevel: startingLevel
        }],
        totalXP: (prev.consciousness?.totalXP || 0) + currentXP,
        level: (prev.consciousness?.level || 1) + 1
      }
    }));
    showToast('üéâ ¬°Camino completado!');
  };

  // Log practice
  const logPractice = (practice, notes = '') => {
    const xpGained = 25;
    const newXP = currentXP + xpGained;
    const levelUp = newXP >= xpForNextLevel;

    setData(prev => ({
      ...prev,
      consciousness: {
        ...prev.consciousness,
        currentXP: levelUp ? newXP - xpForNextLevel : newXP,
        currentLevel: levelUp ? currentLevel + 1 : currentLevel,
        practices: [...(prev.consciousness?.practices || []), {
          id: Date.now(),
          date: today,
          pathId: consciousness.activePath,
          levelName: activePath?.levels[effectiveLevel]?.name,
          practice,
          notes,
          xp: xpGained
        }]
      }
    }));

    setShowPracticeModal(false);
    showToast(levelUp ? '‚¨ÜÔ∏è ¬°Subiste de nivel!' : `+${xpGained} XP`);
  };

  // Add insight
  const addInsight = (text) => {
    setData(prev => ({
      ...prev,
      consciousness: {
        ...prev.consciousness,
        insights: [...(prev.consciousness?.insights || []), {
          id: Date.now(),
          date: today,
          text,
          pathId: consciousness.activePath
        }]
      }
    }));
    showToast('üí° Insight guardado');
  };

  // Save gratitude
  const saveGratitude = () => {
    const items = gratitudeInputs.filter(g => g.trim());
    if (items.length === 0) return;
    setData(prev => ({
      ...prev,
      consciousness: {
        ...prev.consciousness,
        gratitude: { ...prev.consciousness?.gratitude, [today]: items }
      }
    }));
    setGratitudeInputs(['', '', '']);
    showToast('üôè Gratitud guardada');
  };

  // Calculate streaks
  const practiceStreak = (() => {
    let streak = 0;
    let checkDate = today;
    while (true) {
      const hasPractice = consciousness.practices?.some(p => p.date === checkDate);
      if (!hasPractice && checkDate !== today) break;
      if (hasPractice) streak++;
      const d = new Date(checkDate);
      d.setDate(d.getDate() - 1);
      checkDate = d.toISOString().split('T')[0];
    }
    return streak;
  })();

  const gratitudeStreak = (() => {
    let streak = 0;
    let checkDate = today;
    while (consciousness.gratitude?.[checkDate]?.length > 0) {
      streak++;
      const d = new Date(checkDate);
      d.setDate(d.getDate() - 1);
      checkDate = d.toISOString().split('T')[0];
    }
    return streak;
  })();

  // ========== RENDER: HOME VIEW ==========
  const renderHomeView = () => {
    const todayPractice = consciousness.practices?.find(p => p.date === today);

    return (
      <div className="space-y-4 pb-24">
        {/* Header */}
        <AnimatedMount>
          <div className="text-center">
            <h1 className="text-2xl font-bold mb-1">üßò Conciencia</h1>
            <p className="text-white/50 text-sm">Tu viaje de transformaci√≥n interior</p>
          </div>
        </AnimatedMount>

        {/* Level Card */}
        <AnimatedMount delay={25}>
          <Card className="bg-gradient-to-br from-violet-500/20 to-fuchsia-500/20 border-violet-500/30">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-xs text-white/50">Nivel de Consciencia</p>
                <p className="text-4xl font-bold">{consciousness.level || 1}</p>
              </div>
              <div className="text-right">
                <p className="text-xs text-white/50">XP Total</p>
                <p className="text-2xl font-bold text-violet-400">{consciousness.totalXP || 0}</p>
              </div>
              <div className="w-14 h-14 rounded-full bg-gradient-to-br from-violet-500 to-fuchsia-500 flex items-center justify-center">
                <Sparkles className="w-7 h-7" />
              </div>
            </div>
            {(practiceStreak > 0 || gratitudeStreak > 0) && (
              <div className="mt-3 pt-3 border-t border-white/10 flex items-center gap-4">
                {practiceStreak > 0 && (
                  <div className="flex items-center gap-1.5">
                    <Flame className="w-4 h-4 text-orange-400" />
                    <span className="text-sm">{practiceStreak}d pr√°ctica</span>
                  </div>
                )}
                {gratitudeStreak > 0 && (
                  <div className="flex items-center gap-1.5">
                    <Heart className="w-4 h-4 text-pink-400" />
                    <span className="text-sm">{gratitudeStreak}d gratitud</span>
                  </div>
                )}
              </div>
            )}
          </Card>
        </AnimatedMount>

        {/* Active Path or Start */}
        <AnimatedMount delay={50}>
          {activePath && !isPaused ? (
            <Card className="border-2" style={{ borderColor: activePath.color + '50', background: activePath.color + '10' }}>
              <div className="flex items-center justify-between mb-3">
                <div className="flex items-center gap-3">
                  <div className="text-3xl">{activePath.icon}</div>
                  <div>
                    <p className="font-bold">{activePath.name}</p>
                    <p className="text-xs text-white/50">Nivel {effectiveLevel + 1}: {activePath.levels[effectiveLevel]?.name}</p>
                  </div>
                </div>
              </div>

              <div className="mb-3">
                <div className="flex justify-between text-xs mb-1">
                  <span>Progreso al siguiente nivel</span>
                  <span>{currentXP}/{xpForNextLevel} XP</span>
                </div>
                <ProgressBar value={currentXP} max={xpForNextLevel} color="bg-gradient-to-r from-violet-500 to-fuchsia-500" />
              </div>

              {todayPractice ? (
                <div className="flex items-center gap-2 p-3 bg-emerald-500/20 rounded-xl text-emerald-400">
                  <Check className="w-5 h-5" />
                  <span className="text-sm font-medium">Pr√°ctica completada hoy</span>
                </div>
              ) : (
                <button onClick={() => setShowPracticeModal(true)} className="w-full py-3 rounded-xl font-medium text-white" style={{ backgroundColor: activePath.color }}>
                  Hacer pr√°ctica del d√≠a
                </button>
              )}

              <button onClick={() => setView('journey')} className="w-full mt-2 py-2 text-sm text-white/60 hover:text-white">
                Ver camino completo ‚Üí
              </button>
            </Card>
          ) : isPaused ? (
            <Card className="border border-amber-500/30 bg-amber-500/10">
              <div className="flex items-center gap-3 mb-3">
                <Pause className="w-6 h-6 text-amber-400" />
                <div>
                  <p className="font-medium">Camino en pausa</p>
                  <p className="text-xs text-white/50">{activePath?.name}</p>
                </div>
              </div>
              <div className="flex gap-2">
                <button onClick={resumePath} className="flex-1 py-2 bg-violet-500 rounded-xl font-medium">
                  Reanudar
                </button>
                <button onClick={() => setView('paths')} className="px-4 py-2 bg-white/10 rounded-xl">
                  Cambiar
                </button>
              </div>
            </Card>
          ) : (
            <Card onClick={() => setView('paths')} className="border border-dashed border-violet-500/50 hover:bg-violet-500/10 cursor-pointer transition-all">
              <div className="text-center py-4">
                <div className="w-12 h-12 rounded-full bg-violet-500/20 flex items-center justify-center mx-auto mb-3">
                  <Plus className="w-6 h-6 text-violet-400" />
                </div>
                <p className="font-medium">Elegir un camino</p>
                <p className="text-xs text-white/50 mt-1">10 sistemas de transformaci√≥n disponibles</p>
              </div>
            </Card>
          )}
        </AnimatedMount>

        {/* Daily Gratitude */}
        <AnimatedMount delay={75}>
          <Card>
            <div className="flex items-center justify-between mb-3">
              <p className="font-medium flex items-center gap-2">
                <Heart className="w-4 h-4 text-pink-400" /> Gratitud del d√≠a
              </p>
              {todayGratitude.length > 0 && <Check className="w-5 h-5 text-emerald-400" />}
            </div>

            {todayGratitude.length > 0 ? (
              <div className="space-y-2">
                {todayGratitude.map((item, i) => (
                  <div key={i} className="flex items-center gap-2 text-sm text-white/70">
                    <span className="text-pink-400">‚ô•</span>
                    <span>{item}</span>
                  </div>
                ))}
              </div>
            ) : (
              <div className="space-y-2">
                {[0, 1, 2].map(i => (
                  <input key={i} type="text" placeholder={`Agradezco ${i + 1}...`}
                    value={gratitudeInputs[i]}
                    onChange={(e) => {
                      const newInputs = [...gratitudeInputs];
                      newInputs[i] = e.target.value;
                      setGratitudeInputs(newInputs);
                    }}
                    className="w-full bg-white/5 rounded-xl px-3 py-2 text-sm" />
                ))}
                <button onClick={saveGratitude} disabled={!gratitudeInputs.some(g => g.trim())}
                  className="w-full py-2 bg-pink-500 disabled:bg-white/10 rounded-xl text-sm font-medium mt-2">
                  Guardar gratitud
                </button>
              </div>
            )}
          </Card>
        </AnimatedMount>

        {/* Quick Actions */}
        <AnimatedMount delay={100}>
          <div className="grid grid-cols-2 gap-3">
            <Card onClick={() => setView('tools')} className="cursor-pointer hover:bg-white/10">
              <div className="text-center">
                <div className="text-2xl mb-1">üõ†Ô∏è</div>
                <p className="text-sm font-medium">Herramientas</p>
                <p className="text-[10px] text-white/40">Respiraci√≥n, afirmaciones</p>
              </div>
            </Card>
            <Card onClick={() => setView('insights')} className="cursor-pointer hover:bg-white/10">
              <div className="text-center">
                <div className="text-2xl mb-1">üí°</div>
                <p className="text-sm font-medium">Insights</p>
                <p className="text-[10px] text-white/40">{consciousness.insights?.length || 0} guardados</p>
              </div>
            </Card>
          </div>
        </AnimatedMount>

        {/* Completed Paths */}
        {consciousness.completedPaths?.length > 0 && (
          <AnimatedMount delay={125}>
            <Card>
              <p className="font-medium mb-3 flex items-center gap-2">
                <Award className="w-4 h-4 text-amber-400" /> Caminos Completados ({consciousness.completedPaths?.length})
              </p>
              <div className="flex flex-wrap gap-2">
                {consciousness.completedPaths?.map((cp, i) => {
                  const path = allPaths.find(p => p.id === cp.id);
                  return (
                    <div key={i} className="flex items-center gap-1.5 px-3 py-1.5 bg-white/5 rounded-lg">
                      <span>{path?.icon}</span>
                      <span className="text-sm">{path?.name}</span>
                      <Check className="w-4 h-4 text-emerald-400" />
                    </div>
                  );
                })}
              </div>
            </Card>
          </AnimatedMount>
        )}
      </div>
    );
  };

  // ========== RENDER: PATH SELECTION ==========
  const renderPathsView = () => (
    <div className="space-y-4 pb-24">
      <AnimatedMount>
        <div className="flex items-center gap-3 mb-4">
          <button onClick={() => setView('home')} className="p-2 hover:bg-white/10 rounded-lg">
            <ChevronLeft className="w-5 h-5" />
          </button>
          <div>
            <h1 className="text-xl font-bold">Caminos de Transformaci√≥n</h1>
            <p className="text-white/50 text-sm">Elige tu sistema de desarrollo</p>
          </div>
        </div>
      </AnimatedMount>

      {/* Current Progress */}
      <AnimatedMount delay={25}>
        <Card className="bg-gradient-to-br from-violet-500/20 to-fuchsia-500/20 border-violet-500/30">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-xs text-white/50">Nivel de Consciencia</p>
              <p className="text-4xl font-bold">{consciousness.level}</p>
            </div>
            <div className="text-right">
              <p className="text-xs text-white/50">XP Total</p>
              <p className="text-2xl font-bold text-violet-400">{consciousness.totalXP}</p>
            </div>
            <div className="w-16 h-16 rounded-full bg-gradient-to-br from-violet-500 to-fuchsia-500 flex items-center justify-center">
              <Sparkles className="w-8 h-8" />
            </div>
          </div>
          {practiceStreak > 0 && (
            <div className="mt-3 pt-3 border-t border-white/10 flex items-center gap-2">
              <Flame className="w-4 h-4 text-orange-400" />
              <span className="text-sm">{practiceStreak} d√≠as de pr√°ctica continua</span>
            </div>
          )}
        </Card>
      </AnimatedMount>

      {/* Active Path */}
      {activePath && (
        <AnimatedMount delay={50}>
          <Card className="border-2" style={{ borderColor: activePath.color + '50', background: activePath.color + '10' }}>
            <div className="flex items-center justify-between mb-3">
              <div className="flex items-center gap-3">
                <div className="text-3xl">{activePath.icon}</div>
                <div>
                  <p className="font-bold">{activePath.name}</p>
                  <p className="text-xs text-white/50">{activePath.author}</p>
                </div>
              </div>
              <button onClick={() => setView('journey')} className="px-3 py-1.5 rounded-lg text-sm font-medium" style={{ backgroundColor: activePath.color }}>
                Continuar ‚Üí
              </button>
            </div>
            <div className="mb-2">
              <div className="flex justify-between text-xs mb-1">
                <span>Nivel {currentLevel + 1}: {activePath.levels[currentLevel]?.name}</span>
                <span>{currentXP}/{xpForNextLevel} XP</span>
              </div>
              <ProgressBar value={currentXP} max={xpForNextLevel} color="bg-gradient-to-r from-violet-500 to-fuchsia-500" />
            </div>
            <p className="text-xs text-white/40">{currentLevel + 1} de {activePath.levels.length} niveles</p>
          </Card>
        </AnimatedMount>
      )}

      {/* Completed Paths */}
      {consciousness.completedPaths?.length > 0 && (
        <AnimatedMount delay={75}>
          <Card>
            <p className="font-medium mb-3 flex items-center gap-2">
              <Award className="w-4 h-4 text-amber-400" /> Caminos Completados
            </p>
            <div className="flex flex-wrap gap-2">
              {consciousness.completedPaths?.map(cp => {
                const path = allPaths.find(p => p.id === cp.id);
                return (
                  <div key={cp.id + cp.completedDate} className="flex items-center gap-2 px-3 py-1.5 bg-white/5 rounded-lg">
                    <span>{path?.icon}</span>
                    <span className="text-sm">{path?.name}</span>
                    <Check className="w-4 h-4 text-emerald-400" />
                  </div>
                );
              })}
            </div>
          </Card>
        </AnimatedMount>
      )}

      {/* Available Paths */}
      <AnimatedMount delay={100}>
        <p className="text-sm text-white/50 mb-2">Caminos Disponibles</p>
        <div className="space-y-2">
          {allPaths.filter(p => p.id !== consciousness.activePath).map((path, idx) => {
            const isCompleted = consciousness.completedPaths?.some(cp => cp.id === path.id);
            return (
              <button key={path.id} onClick={() => { setSelectedPath(path); setShowPathDetail(true); }}
                className="w-full bg-white/5 hover:bg-white/10 rounded-xl p-4 text-left transition-all"
                style={{ animationDelay: `${idx * 50}ms` }}>
                <div className="flex items-center gap-3">
                  <div className="w-12 h-12 rounded-xl flex items-center justify-center text-2xl" style={{ backgroundColor: path.color + '20' }}>
                    {path.icon}
                  </div>
                  <div className="flex-1">
                    <div className="flex items-center gap-2">
                      <p className="font-medium">{path.name}</p>
                      {isCompleted && <Check className="w-4 h-4 text-emerald-400" />}
                    </div>
                    <p className="text-xs text-white/40">{path.author}</p>
                    <p className="text-xs text-white/50 mt-1">{path.description}</p>
                  </div>
                  <ChevronRight className="w-5 h-5 text-white/30" />
                </div>
                <div className="flex gap-2 mt-2">
                  <span className="text-[10px] px-2 py-0.5 bg-white/10 rounded-full">{path.duration}</span>
                  <span className="text-[10px] px-2 py-0.5 bg-white/10 rounded-full">{path.difficulty}</span>
                  <span className="text-[10px] px-2 py-0.5 bg-white/10 rounded-full">{path.levels.length} niveles</span>
                </div>
              </button>
            );
          })}
        </div>
      </AnimatedMount>

      {/* Path Detail Modal */}
      <Modal isOpen={showPathDetail} onClose={() => setShowPathDetail(false)} title={selectedPath?.name || ''}>
        {selectedPath && (
          <div className="space-y-4">
            <div className="flex items-center gap-4">
              <div className="w-16 h-16 rounded-xl flex items-center justify-center text-4xl" style={{ backgroundColor: selectedPath.color + '20' }}>
                {selectedPath.icon}
              </div>
              <div>
                <p className="text-lg font-bold">{selectedPath.name}</p>
                <p className="text-sm text-white/50">{selectedPath.author}</p>
              </div>
            </div>

            <p className="text-sm text-white/70">{selectedPath.description}</p>

            <div className="flex gap-3">
              <div className="flex-1 bg-white/5 rounded-xl p-3 text-center">
                <p className="text-xl font-bold">{selectedPath.duration}</p>
                <p className="text-xs text-white/40">Duraci√≥n</p>
              </div>
              <div className="flex-1 bg-white/5 rounded-xl p-3 text-center">
                <p className="text-xl font-bold">{selectedPath.levels.length}</p>
                <p className="text-xs text-white/40">Niveles</p>
              </div>
              <div className="flex-1 bg-white/5 rounded-xl p-3 text-center">
                <p className="text-xl font-bold">{selectedPath.difficulty}</p>
                <p className="text-xs text-white/40">Dificultad</p>
              </div>
            </div>

            <div>
              <p className="text-sm font-medium mb-2">Niveles del camino:</p>
              <div className="space-y-1.5 max-h-48 overflow-y-auto">
                {selectedPath.levels.map((level, idx) => (
                  <div key={idx} className="flex items-center gap-2 p-2 bg-white/5 rounded-lg">
                    <div className="w-6 h-6 rounded-full bg-white/10 flex items-center justify-center text-xs font-bold">{idx + 1}</div>
                    <span className="text-sm">{level.name}</span>
                  </div>
                ))}
              </div>
            </div>

            <button onClick={() => startPath(selectedPath.id)} className="w-full py-3 rounded-xl font-medium text-white" style={{ backgroundColor: selectedPath.color }}>
              {consciousness.activePath ? 'Cambiar a este camino' : 'Comenzar este camino'}
            </button>
          </div>
        )}
      </Modal>
    </div>
  );

  // ========== RENDER: JOURNEY VIEW ==========
  const renderJourneyView = () => {
    console.log("renderJourneyView called, activePath:", activePath?.name, "consciousness.activePath:", consciousness.activePath);
    if (!activePath) return <div className="flex items-center justify-center py-20 text-white/50">Selecciona un camino primero</div>;
    const currentLevelData = activePath.levels[effectiveLevel];
    const todayPractice = consciousness.practices?.find(p => p.date === today);

    // Calculate time in level
    const practicesInLevel = (consciousness.practices || []).filter(p =>
      p.pathId === activePath.id && p.levelName === currentLevelData?.name
    );
    const daysWithPractice = new Set(practicesInLevel.map(p => p.date)).size;
    const minDays = currentLevelData?.minimumDays || 7;
    const canAdvance = daysWithPractice >= minDays;

    return (
      <div className="space-y-4 pb-24">
        {/* Header */}
        <AnimatedMount>
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <button onClick={() => setView('home')} className="p-2 hover:bg-white/10 rounded-lg">
                <ChevronLeft className="w-5 h-5" />
              </button>
              <div>
                <h1 className="text-xl font-bold flex items-center gap-2">{activePath.icon} {activePath.name}</h1>
                <p className="text-white/50 text-sm">{activePath.author}</p>
              </div>
            </div>
            <button onClick={() => setShowPauseConfirm(true)} className="p-2 hover:bg-white/10 rounded-lg">
              <MoreHorizontal className="w-5 h-5" />
            </button>
          </div>
        </AnimatedMount>

        {/* Current Level Header */}
        <AnimatedMount delay={25}>
          <Card className="border-2" style={{ borderColor: activePath.color + '40' }}>
            <div className="text-center">
              <p className="text-xs text-white/40">Nivel {effectiveLevel + 1} de {activePath.levels.length}</p>
              <p className="text-2xl font-bold mt-1" style={{ color: activePath.color }}>{currentLevelData?.name}</p>
              {currentLevelData?.calibration && (
                <p className="text-xs text-white/30 mt-1">Calibraci√≥n: {currentLevelData.calibration}</p>
              )}
            </div>

            {/* Time in level indicator */}
            <div className="flex items-center justify-center gap-4 mt-3 pt-3 border-t border-white/10">
              <div className="text-center">
                <p className="text-lg font-bold">{daysWithPractice}</p>
                <p className="text-[10px] text-white/40">d√≠as practicando</p>
              </div>
              <div className="w-px h-8 bg-white/10" />
              <div className="text-center">
                <p className="text-lg font-bold">{minDays}</p>
                <p className="text-[10px] text-white/40">m√≠nimo recomendado</p>
              </div>
              <div className="w-px h-8 bg-white/10" />
              <div className="text-center">
                {canAdvance ? (
                  <p className="text-lg">‚úì</p>
                ) : (
                  <p className="text-lg font-bold">{minDays - daysWithPractice}</p>
                )}
                <p className="text-[10px] text-white/40">{canAdvance ? 'listo' : 'd√≠as restantes'}</p>
              </div>
            </div>
          </Card>
        </AnimatedMount>

        {/* Tab Navigation */}
        <AnimatedMount delay={50}>
          <div className="flex bg-white/5 rounded-xl p-1 gap-1">
            {['ense√±anza', 'pr√°ctica', 'mapa'].map(tab => (
              <button
                key={tab}
                onClick={() => setJourneyTab(tab)}
                className={`flex-1 py-2.5 rounded-lg text-sm font-medium transition-all capitalize ${journeyTab === tab ? 'bg-violet-500 text-white' : 'text-white/50'
                  }`}
              >
                {tab}
              </button>
            ))}
          </div>
        </AnimatedMount>

        {/* TAB: Ense√±anza */}
        {journeyTab === 'ense√±anza' && (
          <div className="space-y-4">
            {/* Teaching */}
            {currentLevelData?.teaching && (
              <AnimatedMount delay={75}>
                <Card>
                  <div className="flex items-center gap-2 mb-3">
                    <BookOpen className="w-4 h-4 text-violet-400" />
                    <p className="font-medium">La Ense√±anza</p>
                  </div>
                  <div className={`text-sm text-white/70 leading-relaxed whitespace-pre-line ${!showFullTeaching && currentLevelData.teaching.length > 500 ? 'line-clamp-6' : ''}`}>
                    {currentLevelData.teaching}
                  </div>
                  {currentLevelData.teaching.length > 500 && (
                    <button
                      onClick={() => setShowFullTeaching(!showFullTeaching)}
                      className="text-xs text-violet-400 mt-3 hover:text-violet-300"
                    >
                      {showFullTeaching ? '‚Üê Ver menos' : 'Leer m√°s ‚Üí'}
                    </button>
                  )}
                </Card>
              </AnimatedMount>
            )}

            {/* Signs */}
            {currentLevelData?.signs && currentLevelData.signs.length > 0 && (
              <AnimatedMount delay={100}>
                <Card>
                  <div className="flex items-center gap-2 mb-3">
                    <AlertCircle className="w-4 h-4 text-amber-400" />
                    <p className="font-medium">Se√±ales de que est√°s aqu√≠</p>
                  </div>
                  <div className="space-y-2">
                    {currentLevelData.signs.map((sign, i) => (
                      <div key={i} className="flex items-start gap-2">
                        <span className="text-amber-400 mt-0.5 text-sm">‚Ä¢</span>
                        <p className="text-sm text-white/70">{sign}</p>
                      </div>
                    ))}
                  </div>
                </Card>
              </AnimatedMount>
            )}

            {/* Trap */}
            {currentLevelData?.trap && (
              <AnimatedMount delay={125}>
                <Card className="border border-red-500/20 bg-red-500/5">
                  <div className="flex items-center gap-2 mb-3">
                    <X className="w-4 h-4 text-red-400" />
                    <p className="font-medium text-red-400">La Trampa</p>
                  </div>
                  <p className="text-sm text-white/70 leading-relaxed whitespace-pre-line">{currentLevelData.trap}</p>
                </Card>
              </AnimatedMount>
            )}

            {/* Exit */}
            {currentLevelData?.exit && (
              <AnimatedMount delay={150}>
                <Card className="border border-emerald-500/20 bg-emerald-500/5">
                  <div className="flex items-center gap-2 mb-3">
                    <ArrowRight className="w-4 h-4 text-emerald-400" />
                    <p className="font-medium text-emerald-400">La Salida</p>
                  </div>
                  <p className="text-sm text-white/70 leading-relaxed whitespace-pre-line">{currentLevelData.exit}</p>
                </Card>
              </AnimatedMount>
            )}

            {/* Resource */}
            {currentLevelData?.resource && (
              <AnimatedMount delay={175}>
                <Card className="bg-gradient-to-br from-violet-500/10 to-fuchsia-500/10">
                  <div className="flex items-center gap-2 mb-2">
                    <BookOpen className="w-4 h-4 text-violet-400" />
                    <p className="font-medium">Recurso Recomendado</p>
                  </div>
                  <p className="text-white font-medium">{currentLevelData.resource.title}</p>
                  <p className="text-sm text-white/50">{currentLevelData.resource.author}</p>
                  {currentLevelData.resource.note && (
                    <p className="text-xs text-white/40 mt-2 italic">{currentLevelData.resource.note}</p>
                  )}
                </Card>
              </AnimatedMount>
            )}
          </div>
        )}

        {/* TAB: Pr√°ctica */}
        {journeyTab === 'pr√°ctica' && (
          <div className="space-y-4">
            {/* Weekly Practice */}
            {currentLevelData?.weeklyPractice && (
              <AnimatedMount delay={75}>
                <Card>
                  <div className="flex items-center gap-2 mb-1">
                    <Star className="w-4 h-4 text-amber-400" />
                    <p className="font-medium">Pr√°ctica Semanal</p>
                  </div>
                  <p className="text-lg font-medium mt-2" style={{ color: activePath.color }}>
                    {currentLevelData.weeklyPractice.title}
                  </p>
                  {currentLevelData.weeklyPractice.duration && (
                    <p className="text-xs text-white/40 mt-1 flex items-center gap-1">
                      <Clock className="w-3 h-3" /> {currentLevelData.weeklyPractice.duration}
                    </p>
                  )}
                  <div className="mt-4 p-4 bg-white/5 rounded-xl">
                    <p className="text-sm text-white/70 leading-relaxed whitespace-pre-line">
                      {currentLevelData.weeklyPractice.instructions}
                    </p>
                  </div>
                </Card>
              </AnimatedMount>
            )}

            {/* Journal Question */}
            {currentLevelData?.journalQuestion && (
              <AnimatedMount delay={100}>
                <Card className="bg-gradient-to-br from-white/5 to-white/10">
                  <div className="flex items-center gap-2 mb-3">
                    <Edit3 className="w-4 h-4 text-cyan-400" />
                    <p className="font-medium">Pregunta de Reflexi√≥n</p>
                  </div>
                  <p className="text-lg italic text-center text-white/80 py-2">
                    "{currentLevelData.journalQuestion}"
                  </p>
                </Card>
              </AnimatedMount>
            )}

            {/* Affirmation */}
            {currentLevelData?.affirmation && (
              <AnimatedMount delay={125}>
                <Card>
                  <div className="flex items-center gap-2 mb-3">
                    <Heart className="w-4 h-4 text-pink-400" />
                    <p className="font-medium">Afirmaci√≥n</p>
                  </div>
                  <p className="text-lg italic text-center text-white/80 py-2">
                    "{currentLevelData.affirmation}"
                  </p>
                </Card>
              </AnimatedMount>
            )}

            {/* Log Practice Button */}
            <AnimatedMount delay={150}>
              <Card>
                <div className="flex items-center justify-between mb-3">
                  <p className="font-medium">Registro de Pr√°ctica</p>
                  {todayPractice && (
                    <span className="text-xs px-2 py-1 bg-emerald-500/20 text-emerald-400 rounded-full">
                      ‚úì Hoy completado
                    </span>
                  )}
                </div>

                {todayPractice ? (
                  <div className="text-center py-4">
                    <p className="text-emerald-400 font-medium">¬°Pr√°ctica registrada!</p>
                    <p className="text-xs text-white/40 mt-1">+{todayPractice.xp} XP ganados hoy</p>
                    {todayPractice.notes && (
                      <p className="text-sm text-white/60 mt-3 italic">"{todayPractice.notes}"</p>
                    )}
                  </div>
                ) : (
                  <button
                    onClick={() => setShowPracticeModal(true)}
                    className="w-full py-3 rounded-xl font-medium text-white"
                    style={{ backgroundColor: activePath.color }}
                  >
                    Registrar Pr√°ctica Semanal
                  </button>
                )}
              </Card>
            </AnimatedMount>

            {/* Progress note */}
            {!canAdvance && (
              <AnimatedMount delay={175}>
                <div className="bg-white/5 rounded-xl p-4 text-center">
                  <p className="text-sm text-white/50">
                    Practica al menos {minDays} d√≠as antes de avanzar al siguiente nivel.
                  </p>
                  <p className="text-xs text-white/30 mt-1">
                    El crecimiento real requiere integraci√≥n, no prisa.
                  </p>
                </div>
              </AnimatedMount>
            )}
          </div>
        )}

        {/* TAB: Mapa */}
        {journeyTab === 'mapa' && (
          <AnimatedMount delay={75}>
            <Card>
              <p className="font-medium mb-4">Tu Viaje</p>
              <div className="space-y-2 max-h-96 overflow-y-auto">
                {activePath.levels.map((level, idx) => {
                  const isCompleted = idx < effectiveLevel;
                  const isCurrent = idx === effectiveLevel;
                  const isLocked = idx > effectiveLevel;
                  const isStart = idx === startingLevel && startingLevel > 0;

                  return (
                    <div
                      key={idx}
                      className={`flex items-center gap-3 p-3 rounded-xl transition-all ${isCurrent ? 'bg-violet-500/20 border border-violet-500/30' :
                        isCompleted ? 'bg-emerald-500/10' : 'bg-white/5'
                        }`}
                    >
                      <div className={`w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold shrink-0 ${isCompleted ? 'bg-emerald-500' :
                        isCurrent ? 'bg-violet-500' : 'bg-white/10'
                        }`}>
                        {isCompleted ? <Check className="w-5 h-5" /> : idx + 1}
                      </div>
                      <div className="flex-1 min-w-0">
                        <p className={`font-medium truncate ${isLocked ? 'text-white/30' : ''}`}>
                          {level.name}
                        </p>
                        {level.calibration && (
                          <p className="text-xs text-white/30">Calibraci√≥n: {level.calibration}</p>
                        )}
                      </div>
                      <div className="flex items-center gap-2 shrink-0">
                        {isStart && !isCurrent && (
                          <span className="text-xs px-2 py-0.5 bg-amber-500/20 text-amber-400 rounded-full">Inicio</span>
                        )}
                        {isCurrent && (
                          <span className="text-xs px-2 py-0.5 bg-violet-500 rounded-full">Actual</span>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>

              {/* Completion button */}
              {canAdvance && effectiveLevel < activePath.levels.length - 1 && (
                <div className="mt-4 pt-4 border-t border-white/10">
                  <p className="text-xs text-white/50 text-center mb-3">
                    Has practicado {daysWithPractice} d√≠as. ¬øSientes que has integrado este nivel?
                  </p>
                  <button
                    onClick={() => {
                      setValidationChecks({});
                      setShowLevelValidation(true);
                    }}
                    className="w-full py-3 bg-gradient-to-r from-violet-500 to-fuchsia-500 rounded-xl font-medium"
                  >
                    Validar integraci√≥n del nivel
                  </button>
                </div>
              )}

              {effectiveLevel >= activePath.levels.length - 1 && (
                <div className="mt-4 pt-4 border-t border-white/10 text-center">
                  <p className="text-amber-400 font-medium">üéâ ¬°√öltimo nivel!</p>
                  <p className="text-xs text-white/50 mt-1">Completa la pr√°ctica para finalizar el camino</p>
                  {canAdvance && (
                    <button
                      onClick={completePath}
                      className="mt-3 w-full py-3 bg-gradient-to-r from-amber-500 to-orange-500 rounded-xl font-bold"
                    >
                      Completar Camino
                    </button>
                  )}
                </div>
              )}
            </Card>
          </AnimatedMount>
        )}
      </div>
    );
  };

  // ========== RENDER: TOOLS VIEW ==========
  const breathingTechniques = {
    '478': { name: '4-7-8 Relajaci√≥n', inhale: 4, hold: 7, exhale: 8, holdOut: 0, rounds: 4, color: '#3B82F6' },
    'box': { name: 'Respiraci√≥n Cuadrada', inhale: 4, hold: 4, exhale: 4, holdOut: 4, rounds: 4, color: '#8B5CF6' },
    'wim': { name: 'Wim Hof', inhale: 2, hold: 0, exhale: 2, holdOut: 15, rounds: 30, color: '#06B6D4' }
  };

  const journalPrompts = [
    "¬øQu√© te hizo sentir vivo hoy?",
    "¬øQu√© aprendiste de ti mismo?",
    "¬øPor qu√© est√°s agradecido ahora?",
    "¬øQu√© resistencia sientes y qu√© te ense√±a?"
  ];

  const moods = [
    { id: 'amazing', emoji: 'ü§©', label: 'Incre√≠ble' },
    { id: 'happy', emoji: 'üòä', label: 'Feliz' },
    { id: 'calm', emoji: 'üòå', label: 'Tranquilo' },
    { id: 'meh', emoji: 'üòê', label: 'Normal' },
    { id: 'anxious', emoji: 'üò∞', label: 'Ansioso' },
    { id: 'sad', emoji: 'üò¢', label: 'Triste' }
  ];

  const defaultAffirmations = [
    "Soy digno de amor y abundancia",
    "El universo conspira a mi favor",
    "Conf√≠o en el proceso de la vida",
    "Soy exactamente quien necesito ser",
    "Mi paz interior es inquebrantable"
  ];

  const userAffirmations = consciousness.affirmations || [];
  const allAffirmations = [...userAffirmations.map(a => a.text), ...defaultAffirmations];

  const todayJournal = consciousness.journal?.[today];

  const saveJournal = () => {
    if (!journalText.trim()) return;
    setData(prev => ({
      ...prev,
      consciousness: {
        ...prev.consciousness,
        journal: {
          ...(prev.consciousness?.journal || {}),
          [today]: { text: journalText, mood: journalMood, timestamp: new Date().toISOString() }
        }
      }
    }));
    showToast('üìî Reflexi√≥n guardada');
    setJournalText('');
    setJournalMood(null);
  };

  const addNewAffirmation = () => {
    if (!newAffirmation.trim()) return;
    setData(prev => ({
      ...prev,
      consciousness: {
        ...prev.consciousness,
        affirmations: [...(prev.consciousness?.affirmations || []), { id: Date.now(), text: newAffirmation.trim() }]
      }
    }));
    setNewAffirmation('');
    showToast('üí´ Afirmaci√≥n a√±adida');
  };

  const renderToolsView = () => (
    <div className="space-y-4 pb-24">
      <AnimatedMount>
        <div className="flex items-center justify-between mb-2">
          <div className="flex items-center gap-3">
            <button onClick={() => setView('home')} className="p-2 hover:bg-white/10 rounded-lg">
              <ChevronLeft className="w-5 h-5" />
            </button>
            <h1 className="text-xl font-bold">Herramientas</h1>
          </div>
        </div>
        <p className="text-sm text-white/50 ml-12">Pr√°cticas para cultivar consciencia</p>
      </AnimatedMount>

      {/* Tool Tabs */}
      <AnimatedMount delay={25}>
        <div className="flex bg-white/5 rounded-xl p-1 gap-1">
          {[
            { id: 'gratitude', icon: 'üôè', label: 'Gratitud' },
            { id: 'affirmations', icon: 'üí´', label: 'Afirmaciones' },
            { id: 'breathing', icon: 'üßò', label: 'Respirar' },
            { id: 'journal', icon: 'üìî', label: 'Diario' }
          ].map(tab => (
            <button
              key={tab.id}
              onClick={() => setToolTab(tab.id)}
              className={`flex-1 py-2 rounded-lg text-xs font-medium transition-all flex items-center justify-center gap-1 ${toolTab === tab.id ? 'bg-violet-500' : ''
                }`}
            >
              <span>{tab.icon}</span>
              <span className="hidden sm:inline">{tab.label}</span>
            </button>
          ))}
        </div>
      </AnimatedMount>

      {/* GRATITUDE */}
      {toolTab === 'gratitude' && (
        <AnimatedMount delay={50}>
          <Card>
            <div className="flex items-center justify-between mb-4">
              <div>
                <p className="font-medium">Gratitud Diaria</p>
                <p className="text-xs text-white/50">3 cosas por las que agradecer hoy</p>
              </div>
              {todayGratitude.length > 0 && (
                <span className="text-xs px-2 py-1 bg-emerald-500/20 text-emerald-400 rounded-full">
                  ‚úì Completado
                </span>
              )}
            </div>

            {todayGratitude.length > 0 ? (
              <div className="space-y-2">
                {todayGratitude.map((item, i) => (
                  <div key={i} className="flex items-center gap-2 bg-white/5 rounded-xl p-3">
                    <span className="text-emerald-400">‚úì</span>
                    <span className="text-sm">{item}</span>
                  </div>
                ))}
                <p className="text-xs text-white/30 text-center mt-3">Vuelve ma√±ana para m√°s gratitud</p>
              </div>
            ) : (
              <div className="space-y-3">
                {gratitudeInputs.map((input, i) => (
                  <div key={i} className="flex items-center gap-2">
                    <span className="text-lg">{i + 1}.</span>
                    <input
                      type="text"
                      value={input}
                      onChange={(e) => {
                        const newInputs = [...gratitudeInputs];
                        newInputs[i] = e.target.value;
                        setGratitudeInputs(newInputs);
                      }}
                      placeholder={`Estoy agradecido por...`}
                      className="flex-1 bg-white/5 rounded-xl px-3 py-2 text-sm"
                    />
                  </div>
                ))}
                <button
                  onClick={saveGratitude}
                  disabled={!gratitudeInputs.some(g => g.trim())}
                  className="w-full py-3 bg-violet-500 rounded-xl font-medium disabled:opacity-30"
                >
                  Guardar Gratitud
                </button>
              </div>
            )}
          </Card>

          {/* Gratitude Stats */}
          <Card className="bg-gradient-to-br from-violet-500/10 to-fuchsia-500/10">
            <div className="flex items-center justify-around text-center">
              <div>
                <p className="text-2xl font-bold">{Object.keys(consciousness.gratitude || {}).length}</p>
                <p className="text-xs text-white/50">d√≠as totales</p>
              </div>
              <div className="w-px h-10 bg-white/10" />
              <div>
                <p className="text-2xl font-bold">{(() => {
                  let streak = 0;
                  let checkDate = today;
                  while ((consciousness.gratitude || {})[checkDate]?.length > 0) {
                    streak++;
                    const d = new Date(checkDate);
                    d.setDate(d.getDate() - 1);
                    checkDate = d.toISOString().split('T')[0];
                  }
                  return streak;
                })()}</p>
                <p className="text-xs text-white/50">racha actual</p>
              </div>
            </div>
          </Card>
        </AnimatedMount>
      )}

      {/* AFFIRMATIONS */}
      {toolTab === 'affirmations' && (
        <AnimatedMount delay={50}>
          <Card>
            <p className="font-medium mb-3">Tus Afirmaciones</p>
            <div className="space-y-2 max-h-60 overflow-y-auto">
              {allAffirmations.map((aff, i) => (
                <div key={i} className="flex items-center gap-2 bg-white/5 rounded-xl p-3">
                  <span className="text-violet-400">‚ú¶</span>
                  <span className="text-sm italic flex-1">{aff}</span>
                </div>
              ))}
            </div>
          </Card>

          <Card>
            <p className="font-medium mb-3">A√±adir Nueva</p>
            <div className="flex gap-2">
              <input
                type="text"
                value={newAffirmation}
                onChange={(e) => setNewAffirmation(e.target.value)}
                placeholder="Yo soy..."
                className="flex-1 bg-white/5 rounded-xl px-3 py-2 text-sm"
              />
              <button
                onClick={addNewAffirmation}
                disabled={!newAffirmation.trim()}
                className="px-4 py-2 bg-violet-500 rounded-xl font-medium disabled:opacity-30"
              >
                <Plus className="w-5 h-5" />
              </button>
            </div>
          </Card>

          {/* Random affirmation display */}
          <Card className="bg-gradient-to-br from-violet-500/20 to-fuchsia-500/20 border border-violet-500/30">
            <p className="text-xs text-white/50 mb-2 text-center">Afirmaci√≥n del momento</p>
            <p className="text-lg italic text-center py-4">
              "{allAffirmations[Math.floor(Date.now() / 60000) % allAffirmations.length]}"
            </p>
          </Card>
        </AnimatedMount>
      )}

      {/* BREATHING */}
      {toolTab === 'breathing' && (
        <AnimatedMount delay={50}>
          {!breathingActive ? (
            <>
              <Card>
                <p className="font-medium mb-4">T√©cnicas de Respiraci√≥n</p>
                <div className="space-y-3">
                  {Object.entries(breathingTechniques).map(([id, tech]) => (
                    <button
                      key={id}
                      onClick={() => setSelectedBreathTechnique(id)}
                      className={`w-full p-4 rounded-xl text-left transition-all ${selectedBreathTechnique === id ? 'bg-violet-500/20 border border-violet-500/50' : 'bg-white/5'
                        }`}
                    >
                      <div className="flex items-center justify-between">
                        <div>
                          <p className="font-medium">{tech.name}</p>
                          <p className="text-xs text-white/50">
                            {tech.inhale}s inhalar ‚Ä¢ {tech.hold > 0 ? `${tech.hold}s retener ‚Ä¢ ` : ''}{tech.exhale}s exhalar
                            {tech.holdOut > 0 ? ` ‚Ä¢ ${tech.holdOut}s pausa` : ''} √ó {tech.rounds}
                          </p>
                        </div>
                        {selectedBreathTechnique === id && <Check className="w-5 h-5 text-violet-400" />}
                      </div>
                    </button>
                  ))}
                </div>
              </Card>

              <button
                onClick={() => {
                  setBreathingActive(true);
                  setBreathPhase('inhale');
                  setBreathTimer(0);
                  setBreathRound(0);
                }}
                className="w-full py-4 bg-gradient-to-r from-violet-500 to-fuchsia-500 rounded-xl font-bold text-lg"
              >
                üßò Comenzar Sesi√≥n
              </button>

              {/* Breathing stats */}
              <Card className="bg-white/5">
                <div className="flex items-center justify-around text-center">
                  <div>
                    <p className="text-2xl font-bold">{(consciousness.breathingSessions || []).length}</p>
                    <p className="text-xs text-white/50">sesiones totales</p>
                  </div>
                  <div className="w-px h-10 bg-white/10" />
                  <div>
                    <p className="text-2xl font-bold">
                      {(consciousness.breathingSessions || []).filter(s => s.date === today).length}
                    </p>
                    <p className="text-xs text-white/50">hoy</p>
                  </div>
                </div>
              </Card>
            </>
          ) : (
            <Card className="py-8">
              <div className="text-center">
                <p className="text-xs text-white/50 mb-2">
                  {breathingTechniques[selectedBreathTechnique].name} ‚Ä¢ Ronda {breathRound + 1}/{breathingTechniques[selectedBreathTechnique].rounds}
                </p>

                {/* Animated circle */}
                <div className="relative w-48 h-48 mx-auto my-8">
                  <div
                    className={`absolute inset-0 rounded-full transition-all duration-1000 ${breathPhase === 'inhale' ? 'scale-100 opacity-80' :
                      breathPhase === 'hold' ? 'scale-100 opacity-60' :
                        breathPhase === 'exhale' ? 'scale-75 opacity-40' :
                          'scale-75 opacity-30'
                      }`}
                    style={{ backgroundColor: breathingTechniques[selectedBreathTechnique].color }}
                  />
                  <div className="absolute inset-0 flex items-center justify-center">
                    <div className="text-center">
                      <p className="text-3xl font-bold capitalize">
                        {breathPhase === 'inhale' ? 'Inhala' :
                          breathPhase === 'hold' ? 'Ret√©n' :
                            breathPhase === 'exhale' ? 'Exhala' :
                              breathPhase === 'holdOut' ? 'Pausa' : ''}
                      </p>
                      <p className="text-5xl font-bold mt-2">{Math.ceil(breathTimer)}</p>
                    </div>
                  </div>
                </div>

                <button
                  onClick={() => {
                    setBreathingActive(false);
                    setBreathPhase('idle');
                    setBreathTimer(0);
                    setBreathRound(0);
                  }}
                  className="px-6 py-2 bg-white/10 rounded-xl"
                >
                  Cancelar
                </button>
              </div>
            </Card>
          )}
        </AnimatedMount>
      )}

      {/* JOURNAL */}
      {toolTab === 'journal' && (
        <AnimatedMount delay={50}>
          <Card>
            <p className="font-medium mb-3">Reflexi√≥n del D√≠a</p>

            {todayJournal ? (
              <div className="space-y-3">
                <div className="flex items-center gap-2 mb-2">
                  <span className="text-2xl">{moods.find(m => m.id === todayJournal.mood)?.emoji || 'üìù'}</span>
                  <span className="text-sm text-white/50">{moods.find(m => m.id === todayJournal.mood)?.label || ''}</span>
                </div>
                <div className="bg-white/5 rounded-xl p-4">
                  <p className="text-sm leading-relaxed whitespace-pre-line">{todayJournal.text}</p>
                </div>
                <p className="text-xs text-white/30 text-center">Ya escribiste hoy. Vuelve ma√±ana.</p>
              </div>
            ) : (
              <div className="space-y-4">
                {/* Prompt */}
                <div className="bg-violet-500/10 border border-violet-500/30 rounded-xl p-3">
                  <p className="text-xs text-violet-400 mb-1">Pregunta del d√≠a</p>
                  <p className="text-sm italic">{journalPrompts[new Date().getDay() % journalPrompts.length]}</p>
                </div>

                {/* Mood selector */}
                <div>
                  <p className="text-xs text-white/50 mb-2">¬øC√≥mo te sientes?</p>
                  <div className="flex gap-2 justify-center">
                    {moods.map(mood => (
                      <button
                        key={mood.id}
                        onClick={() => setJournalMood(mood.id)}
                        className={`p-2 rounded-xl text-2xl transition-all ${journalMood === mood.id ? 'bg-violet-500 scale-110' : 'bg-white/5'
                          }`}
                      >
                        {mood.emoji}
                      </button>
                    ))}
                  </div>
                </div>

                {/* Text input */}
                <textarea
                  value={journalText}
                  onChange={(e) => setJournalText(e.target.value)}
                  placeholder="Escribe tu reflexi√≥n..."
                  rows={5}
                  className="w-full bg-white/5 rounded-xl p-3 text-sm resize-none"
                />

                <button
                  onClick={saveJournal}
                  disabled={!journalText.trim()}
                  className="w-full py-3 bg-violet-500 rounded-xl font-medium disabled:opacity-30"
                >
                  Guardar Reflexi√≥n
                </button>
              </div>
            )}
          </Card>

          {/* Journal history */}
          {Object.keys(consciousness.journal || {}).length > 0 && (
            <Card>
              <p className="font-medium mb-3">Entradas Anteriores</p>
              <div className="space-y-2 max-h-40 overflow-y-auto">
                {Object.entries(consciousness.journal || {})
                  .filter(([date]) => date !== today)
                  .sort(([a], [b]) => b.localeCompare(a))
                  .slice(0, 5)
                  .map(([date, entry]) => (
                    <div key={date} className="bg-white/5 rounded-xl p-3">
                      <div className="flex items-center justify-between mb-1">
                        <span className="text-xs text-white/40">{date}</span>
                        <span>{moods.find(m => m.id === entry.mood)?.emoji}</span>
                      </div>
                      <p className="text-xs text-white/60 line-clamp-2">{entry.text}</p>
                    </div>
                  ))}
              </div>
            </Card>
          )}
        </AnimatedMount>
      )}
    </div>
  );

  // ========== RENDER: INSIGHTS VIEW ==========
  const insightPrompts = [
    "¬øQu√© patr√≥n descubriste hoy sobre ti mismo?",
    "¬øQu√© creencia limitante identificaste?",
    "¬øQu√© momento de claridad tuviste?",
    "¬øQu√© conexi√≥n hiciste que antes no ve√≠as?",
    "¬øQu√© resistencia notaste y qu√© te ense√±a?"
  ];

  const renderInsightsView = () => (
    <div className="space-y-4 pb-24">
      <AnimatedMount>
        <div className="flex items-center justify-between mb-2">
          <div className="flex items-center gap-3">
            <button onClick={() => setView('home')} className="p-2 hover:bg-white/10 rounded-lg">
              <ChevronLeft className="w-5 h-5" />
            </button>
            <h1 className="text-xl font-bold">Insights</h1>
          </div>
          <button onClick={() => setShowInsightModal(true)} className="p-2 bg-violet-500 rounded-xl">
            <Plus className="w-5 h-5" />
          </button>
        </div>
        <p className="text-sm text-white/50 ml-12">Tus descubrimientos y revelaciones</p>
      </AnimatedMount>

      {/* Insight prompt card */}
      <AnimatedMount delay={25}>
        <Card className="bg-gradient-to-br from-amber-500/10 to-orange-500/10 border border-amber-500/20">
          <div className="flex items-start gap-3">
            <div className="w-10 h-10 rounded-xl bg-amber-500/20 flex items-center justify-center shrink-0">
              <Lightbulb className="w-5 h-5 text-amber-400" />
            </div>
            <div>
              <p className="text-sm font-medium mb-1">Pregunta del d√≠a</p>
              <p className="text-sm text-white/70 italic">
                "{insightPrompts[new Date().getDay() % insightPrompts.length]}"
              </p>
              <button
                onClick={() => setShowInsightModal(true)}
                className="text-xs text-amber-400 mt-2 hover:text-amber-300"
              >
                Responder ‚Üí
              </button>
            </div>
          </div>
        </Card>
      </AnimatedMount>

      {/* Stats */}
      {consciousness.insights.length > 0 && (
        <AnimatedMount delay={50}>
          <div className="flex gap-3">
            <Card className="flex-1 text-center py-3">
              <p className="text-2xl font-bold">{consciousness.insights.length}</p>
              <p className="text-xs text-white/40">insights totales</p>
            </Card>
            <Card className="flex-1 text-center py-3">
              <p className="text-2xl font-bold">
                {consciousness.insights.filter(i => i.date === today).length}
              </p>
              <p className="text-xs text-white/40">hoy</p>
            </Card>
            <Card className="flex-1 text-center py-3">
              <p className="text-2xl font-bold">
                {new Set(consciousness.insights.map(i => i.date)).size}
              </p>
              <p className="text-xs text-white/40">d√≠as</p>
            </Card>
          </div>
        </AnimatedMount>
      )}

      {consciousness.insights.length > 0 ? (
        <div className="space-y-3">
          {consciousness.insights.slice().reverse().map((insight, idx) => {
            const path = allPaths.find(p => p.id === insight.pathId);
            return (
              <AnimatedMount key={insight.id} delay={75 + idx * 25}>
                <Card>
                  <div className="flex items-start gap-3">
                    <div className="w-8 h-8 rounded-lg bg-amber-500/20 flex items-center justify-center flex-shrink-0">
                      <Lightbulb className="w-4 h-4 text-amber-400" />
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="text-sm leading-relaxed">{insight.text}</p>
                      <div className="flex items-center gap-2 mt-2 text-xs text-white/40">
                        <span>{formatShortDate(insight.date)}</span>
                        {path && <span>‚Ä¢ {path.icon} {path.name}</span>}
                        {insight.levelName && <span>‚Ä¢ {insight.levelName}</span>}
                      </div>
                    </div>
                    <button
                      onClick={() => {
                        setData(prev => ({
                          ...prev,
                          consciousness: {
                            ...prev.consciousness,
                            insights: prev.consciousness.insights.filter(i => i.id !== insight.id)
                          }
                        }));
                      }}
                      className="p-1 hover:bg-white/10 rounded-lg text-white/30 hover:text-white/60"
                    >
                      <X className="w-4 h-4" />
                    </button>
                  </div>
                </Card>
              </AnimatedMount>
            );
          })}
        </div>
      ) : (
        <AnimatedMount delay={75}>
          <Card className="text-center py-12 border border-dashed border-white/20">
            <Lightbulb className="w-12 h-12 mx-auto text-white/20 mb-3" />
            <p className="text-white/40 mb-1">Sin insights todav√≠a</p>
            <p className="text-xs text-white/30">Guarda tus reflexiones y descubrimientos</p>
            <button
              onClick={() => setShowInsightModal(true)}
              className="mt-4 px-4 py-2 bg-violet-500 rounded-xl text-sm font-medium"
            >
              A√±adir primer insight
            </button>
          </Card>
        </AnimatedMount>
      )}

      {/* Add Insight Modal */}
      <Modal isOpen={showInsightModal} onClose={() => { setShowInsightModal(false); setNewInsightText(''); }} title="Nuevo Insight">
        <div className="space-y-4">
          <div className="bg-amber-500/10 border border-amber-500/30 rounded-xl p-3">
            <p className="text-xs text-amber-400 mb-1">üí° Pregunta para reflexionar</p>
            <p className="text-sm text-white/70 italic">
              "{insightPrompts[new Date().getDay() % insightPrompts.length]}"
            </p>
          </div>

          <div>
            <label className="text-sm text-white/50 mb-2 block">Tu insight o descubrimiento</label>
            <textarea
              value={newInsightText}
              onChange={(e) => setNewInsightText(e.target.value)}
              placeholder="Hoy me di cuenta de que..."
              rows={4}
              className="w-full bg-white/5 rounded-xl p-3 text-sm resize-none"
              autoFocus
            />
          </div>

          {activePath && (
            <div className="bg-white/5 rounded-xl p-3">
              <p className="text-xs text-white/40">
                Se guardar√° relacionado a: {activePath.icon} {activePath.name} ‚Ä¢ {activePath.levels[effectiveLevel]?.name}
              </p>
            </div>
          )}

          <button
            onClick={() => {
              if (newInsightText.trim()) {
                addInsight(newInsightText.trim());
                setNewInsightText('');
                setShowInsightModal(false);
              }
            }}
            disabled={!newInsightText.trim()}
            className="w-full py-3 bg-violet-500 rounded-xl font-medium disabled:opacity-30"
          >
            Guardar Insight
          </button>
        </div>
      </Modal>
    </div>
  );

  // ========== MAIN RENDER ==========
  return (
    <div className="pb-24">
      {/* View Toggle - only show when not on home */}
      {view !== 'home' && (
        <div className="flex bg-white/10 rounded-xl p-1 mb-4">
          <button onClick={() => setView('home')} className={`flex-1 py-2 rounded-lg text-xs font-medium transition-all ${view === 'home' ? 'bg-violet-500' : ''}`}>
            Inicio
          </button>
          <button onClick={() => setView('paths')} className={`flex-1 py-2 rounded-lg text-xs font-medium transition-all ${view === 'paths' ? 'bg-violet-500' : ''}`}>
            Caminos
          </button>
          <button onClick={() => setView('journey')} disabled={!activePath} className={`flex-1 py-2 rounded-lg text-xs font-medium transition-all ${view === 'journey' ? 'bg-violet-500' : ''} ${!activePath ? 'opacity-30' : ''}`}>
            Viaje
          </button>
          <button onClick={() => setView('tools')} className={`flex-1 py-2 rounded-lg text-xs font-medium transition-all ${view === 'tools' ? 'bg-violet-500' : ''}`}>
            Herramientas
          </button>
          <button onClick={() => setView('insights')} className={`flex-1 py-2 rounded-lg text-xs font-medium transition-all ${view === 'insights' ? 'bg-violet-500' : ''}`}>
            Insights
          </button>
        </div>
      )}

      {view === 'home' && renderHomeView()}
      {view === 'paths' && renderPathsView()}
      {view === 'journey' && renderJourneyView()}
      {view === 'tools' && renderToolsView()}
      {view === 'insights' && renderInsightsView()}

      {/* Level Validation Modal */}
      {showLevelValidation && activePath && (() => {
        const currentLevelData = activePath.levels[effectiveLevel];
        const signs = currentLevelData?.signs || [];
        const checkedCount = Object.values(validationChecks).filter(Boolean).length;
        const requiredChecks = Math.ceil(signs.length * 0.7); // Need 70% to advance
        const canConfirmAdvance = checkedCount >= requiredChecks;

        // Generate inverted signs for validation (what you should NO LONGER feel strongly)
        const getValidationItems = () => {
          if (!signs.length) return [];

          // For lower levels, we check that you NO LONGER strongly identify with these signs
          // For higher levels, we check that you DO identify with positive signs
          const isLowerLevel = effectiveLevel < 8; // Below Courage (200)

          return signs.map((sign, idx) => ({
            id: idx,
            text: isLowerLevel
              ? `Ya no me identifico fuertemente con: "${sign}"`
              : `Siento que esto es verdad para m√≠: "${sign}"`,
            originalSign: sign
          }));
        };

        const validationItems = getValidationItems();

        return (
          <Modal
            isOpen={showLevelValidation}
            onClose={() => setShowLevelValidation(false)}
            title="Validaci√≥n de Integraci√≥n"
          >
            <div className="space-y-4">
              <div className="text-center mb-4">
                <div className="text-4xl mb-2">{activePath.icon}</div>
                <p className="font-bold text-lg" style={{ color: activePath.color }}>
                  {currentLevelData?.name}
                </p>
                <p className="text-xs text-white/50 mt-1">
                  ¬øHas trascendido este nivel?
                </p>
              </div>

              <div className="bg-white/5 rounded-xl p-4">
                <p className="text-xs text-white/50 mb-3">
                  S√© honesto contigo mismo. Marca solo las afirmaciones que genuinamente sientes que son verdad para ti ahora:
                </p>

                <div className="space-y-3 max-h-64 overflow-y-auto">
                  {validationItems.map((item) => (
                    <button
                      key={item.id}
                      onClick={() => setValidationChecks(prev => ({
                        ...prev,
                        [item.id]: !prev[item.id]
                      }))}
                      className={`w-full p-3 rounded-xl text-left transition-all flex items-start gap-3 ${validationChecks[item.id]
                        ? 'bg-emerald-500/20 border border-emerald-500/30'
                        : 'bg-white/5 border border-transparent'
                        }`}
                    >
                      <div className={`w-5 h-5 rounded-md flex items-center justify-center shrink-0 mt-0.5 ${validationChecks[item.id] ? 'bg-emerald-500' : 'bg-white/10'
                        }`}>
                        {validationChecks[item.id] && <Check className="w-3 h-3" />}
                      </div>
                      <span className="text-sm text-white/80">{item.text}</span>
                    </button>
                  ))}
                </div>
              </div>

              {/* Progress indicator */}
              <div className="bg-white/5 rounded-xl p-3">
                <div className="flex items-center justify-between text-xs mb-2">
                  <span className="text-white/50">Progreso de validaci√≥n</span>
                  <span className={checkedCount >= requiredChecks ? 'text-emerald-400' : 'text-white/50'}>
                    {checkedCount}/{signs.length} ({Math.round(checkedCount / signs.length * 100) || 0}%)
                  </span>
                </div>
                <div className="h-2 bg-white/10 rounded-full overflow-hidden">
                  <div
                    className={`h-full transition-all ${canConfirmAdvance ? 'bg-emerald-500' : 'bg-violet-500'}`}
                    style={{ width: `${(checkedCount / signs.length) * 100}%` }}
                  />
                </div>
                <p className="text-[10px] text-white/30 mt-2 text-center">
                  Necesitas validar al menos {requiredChecks} de {signs.length} puntos (70%) para avanzar
                </p>
              </div>

              {!canConfirmAdvance && checkedCount > 0 && (
                <div className="bg-amber-500/10 border border-amber-500/30 rounded-xl p-3">
                  <p className="text-xs text-amber-400">
                    üí° Si no puedes marcar suficientes puntos, quiz√°s necesitas m√°s tiempo en este nivel.
                    No hay prisa - la integraci√≥n real requiere tiempo.
                  </p>
                </div>
              )}

              {canConfirmAdvance && (
                <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-3">
                  <p className="text-xs text-emerald-400">
                    ‚úì Has validado suficientes puntos. Parece que est√°s listo para avanzar.
                  </p>
                </div>
              )}

              <div className="flex gap-3">
                <button
                  onClick={() => setShowLevelValidation(false)}
                  className="flex-1 py-3 bg-white/10 rounded-xl font-medium"
                >
                  Seguir practicando
                </button>
                <button
                  onClick={() => {
                    if (canConfirmAdvance) {
                      // Save validation to history
                      setData(prev => ({
                        ...prev,
                        consciousness: {
                          ...prev.consciousness,
                          currentLevel: (prev.consciousness?.currentLevel || 0) + 1,
                          currentXP: 0,
                          levelHistory: [
                            ...(prev.consciousness?.levelHistory || []),
                            {
                              pathId: activePath.id,
                              level: effectiveLevel,
                              levelName: currentLevelData?.name,
                              completedAt: new Date().toISOString(),
                              validationScore: Math.round(checkedCount / signs.length * 100)
                            }
                          ]
                        }
                      }));
                      setShowLevelValidation(false);
                      setValidationChecks({});
                      showToast(`üéâ ¬°Has trascendido ${currentLevelData?.name}!`);
                    }
                  }}
                  disabled={!canConfirmAdvance}
                  className={`flex-1 py-3 rounded-xl font-medium transition-all ${canConfirmAdvance
                    ? 'bg-gradient-to-r from-emerald-500 to-teal-500'
                    : 'bg-white/5 text-white/30'
                    }`}
                >
                  Avanzar al siguiente
                </button>
              </div>
            </div>
          </Modal>
        );
      })()}

      {/* Practice Modal */}
      {showPracticeModal && activePath && (
        <Modal isOpen={showPracticeModal} onClose={() => setShowPracticeModal(false)} title="Pr√°ctica del D√≠a">
          <div className="space-y-4">
            <div className="text-center">
              <div className="text-4xl mb-2">{activePath.icon}</div>
              <p className="font-bold">{activePath.levels[effectiveLevel]?.name}</p>
            </div>

            <div className="bg-white/5 rounded-xl p-4">
              <p className="text-sm leading-relaxed">{activePath.levels[effectiveLevel]?.practice}</p>
            </div>

            <div className="bg-violet-500/10 border border-violet-500/30 rounded-xl p-3">
              <p className="text-xs text-violet-400 mb-1">Afirmaci√≥n</p>
              <p className="text-sm italic">"{activePath.levels[effectiveLevel]?.affirmation}"</p>
            </div>

            <div>
              <label className="text-sm text-white/50 mb-2 block">Notas (opcional)</label>
              <textarea id="practice-notes" rows={3} placeholder="¬øC√≥mo fue tu pr√°ctica? ¬øQu√© descubriste?"
                className="w-full bg-white/5 rounded-xl p-3 text-sm resize-none" />
            </div>

            <button onClick={() => {
              const notes = document.getElementById('practice-notes')?.value || '';
              logPractice(activePath.levels[effectiveLevel]?.practice, notes);
            }} className="w-full py-3 rounded-xl font-medium" style={{ backgroundColor: activePath.color }}>
              Completar Pr√°ctica (+25 XP)
            </button>
          </div>
        </Modal>
      )}

      {/* Path Detail Modal */}
      <Modal isOpen={showPathDetail} onClose={() => {
        setShowPathDetail(false);
        setShowOnboarding(false);
        setShowCalibration(false);
        setCalibrationMode('prompt');
        setAiResponse('');
        setParsedLevel(null);
        setPromptCopied(false);
        setOnboardingStep(0);
      }} title={selectedPath?.name || ''}>
        {/* Initial path info */}
        {selectedPath && !showOnboarding && !showCalibration && (
          <div className="space-y-4">
            <div className="flex items-center gap-4">
              <div className="w-16 h-16 rounded-xl flex items-center justify-center text-4xl" style={{ backgroundColor: selectedPath.color + '20' }}>
                {selectedPath.icon}
              </div>
              <div>
                <p className="text-lg font-bold">{selectedPath.name}</p>
                <p className="text-sm text-white/50">{selectedPath.author}</p>
              </div>
            </div>

            <p className="text-sm text-white/70 leading-relaxed whitespace-pre-line">{selectedPath.fullDescription}</p>

            <div className="flex gap-3">
              <div className="flex-1 bg-white/5 rounded-xl p-3 text-center">
                <p className="text-lg font-bold">{selectedPath.duration}</p>
                <p className="text-xs text-white/40">Duraci√≥n</p>
              </div>
              <div className="flex-1 bg-white/5 rounded-xl p-3 text-center">
                <p className="text-lg font-bold">{selectedPath.levels.length}</p>
                <p className="text-xs text-white/40">Niveles</p>
              </div>
              <div className="flex-1 bg-white/5 rounded-xl p-3 text-center">
                <p className="text-lg font-bold">{selectedPath.difficulty}</p>
                <p className="text-xs text-white/40">Dificultad</p>
              </div>
            </div>

            <button onClick={() => {
              if (selectedPath.onboarding && selectedPath.onboarding.length > 0) {
                setShowOnboarding(true);
                setOnboardingStep(0);
              } else if (selectedPath.hasCalibration) {
                setShowCalibration(true);
              } else {
                startPath(selectedPath.id, 0);
              }
            }} className="w-full py-3 rounded-xl font-medium text-white" style={{ backgroundColor: selectedPath.color }}>
              Comenzar
            </button>
          </div>
        )}

        {/* Onboarding Screens - Immersive intro to the path */}
        {selectedPath && showOnboarding && !showCalibration && selectedPath.onboarding && (
          <div className="space-y-6">
            {/* Progress dots */}
            <div className="flex justify-center gap-2">
              {selectedPath.onboarding.map((_, idx) => (
                <div
                  key={idx}
                  className={`w-2 h-2 rounded-full transition-all ${idx === onboardingStep ? 'bg-violet-500 w-6' : idx < onboardingStep ? 'bg-violet-500' : 'bg-white/20'}`}
                />
              ))}
            </div>

            {/* Current screen */}
            <div className="text-center py-4">
              <div className="text-5xl mb-4">{selectedPath.onboarding[onboardingStep]?.icon}</div>
              <h3 className="text-xl font-bold mb-4">{selectedPath.onboarding[onboardingStep]?.title}</h3>
              <p className="text-sm text-white/70 leading-relaxed whitespace-pre-line">
                {selectedPath.onboarding[onboardingStep]?.content}
              </p>
            </div>

            {/* Navigation */}
            <div className="flex gap-3">
              {onboardingStep > 0 && (
                <button
                  onClick={() => setOnboardingStep(prev => prev - 1)}
                  className="flex-1 py-3 bg-white/10 rounded-xl font-medium"
                >
                  ‚Üê Anterior
                </button>
              )}

              {onboardingStep < selectedPath.onboarding.length - 1 ? (
                <button
                  onClick={() => setOnboardingStep(prev => prev + 1)}
                  className="flex-1 py-3 rounded-xl font-medium text-white"
                  style={{ backgroundColor: selectedPath.color }}
                >
                  Siguiente ‚Üí
                </button>
              ) : (
                <button
                  onClick={() => {
                    if (selectedPath.hasCalibration) {
                      setShowCalibration(true);
                    } else {
                      startPath(selectedPath.id, 0);
                    }
                  }}
                  className="flex-1 py-3 rounded-xl font-medium text-white"
                  style={{ backgroundColor: selectedPath.color }}
                >
                  {selectedPath.hasCalibration ? 'Continuar a calibraci√≥n' : 'Comenzar camino'}
                </button>
              )}
            </div>

            {/* Skip option */}
            <button
              onClick={() => startPath(selectedPath.id, 0)}
              className="w-full py-2 text-xs text-white/30 hover:text-white/50"
            >
              Saltar introducci√≥n y empezar desde el principio
            </button>
          </div>
        )}

        {/* AI Calibration intro - after onboarding */}
        {selectedPath && showCalibration && calibrationMode === 'intro' && (
          <div className="space-y-4 text-center">
            <div className="text-6xl mb-4">ü§ñ</div>
            <h3 className="text-xl font-bold">Calibraci√≥n con IA</h3>
            <p className="text-sm text-white/70">
              Vamos a usar tu IA favorita (Claude, ChatGPT, etc.) para determinar tu punto de partida bas√°ndose en todo lo que ya conoce de ti.
            </p>
            <div className="bg-violet-500/10 border border-violet-500/30 rounded-xl p-3 text-left">
              <p className="text-xs text-violet-400 font-medium mb-2">üí° ¬øPor qu√© as√≠?</p>
              <p className="text-xs text-white/60">
                Tu IA tiene contexto de tus conversaciones, proyectos, estados emocionales y forma de pensar. Esto permite una calibraci√≥n mucho m√°s precisa que un simple test.
              </p>
            </div>
            <button onClick={() => setCalibrationMode('prompt')}
              className="w-full py-3 rounded-xl font-medium" style={{ backgroundColor: selectedPath.color }}>
              Ver prompt de calibraci√≥n
            </button>
            <button onClick={() => startPath(selectedPath.id, 0)} className="w-full py-2 text-sm text-white/50">
              Empezar desde el principio
            </button>
          </div>
        )}

        {/* AI Calibration - Prompt Mode */}
        {selectedPath && showCalibration && calibrationMode === 'prompt' && selectedPath.calibrationPrompt && (
          <div className="space-y-4">
            <div className="text-center">
              <p className="text-sm text-white/50 mb-2">Paso 1 de 2</p>
              <h3 className="font-bold">Copia este prompt</h3>
            </div>

            <div className="bg-black/30 rounded-xl p-3 max-h-60 overflow-y-auto">
              <p className="text-xs text-white/70 whitespace-pre-wrap font-mono leading-relaxed">{selectedPath.calibrationPrompt}</p>
            </div>

            <button onClick={() => {
              navigator.clipboard.writeText(selectedPath.calibrationPrompt);
              setPromptCopied(true);
              setTimeout(() => setPromptCopied(false), 2000);
            }} className="w-full py-3 rounded-xl font-medium flex items-center justify-center gap-2"
              style={{ backgroundColor: promptCopied ? '#10B981' : selectedPath.color }}>
              {promptCopied ? (
                <><Check className="w-4 h-4" /> Copiado!</>
              ) : (
                <><Copy className="w-4 h-4" /> Copiar prompt</>
              )}
            </button>

            <div className="bg-white/5 rounded-xl p-3">
              <p className="text-xs text-white/50 mb-2">Instrucciones:</p>
              <ol className="text-xs text-white/70 space-y-1.5 list-decimal list-inside">
                <li>Copia el prompt de arriba</li>
                <li>P√©galo en tu IA (Claude, ChatGPT, Gemini...)</li>
                <li>La IA que mejor te conozca dar√° mejor resultado</li>
                <li>Copia la respuesta completa y p√©gala aqu√≠</li>
              </ol>
            </div>

            <button onClick={() => setCalibrationMode('result')}
              className="w-full py-3 bg-white/10 hover:bg-white/20 rounded-xl font-medium transition-all">
              Ya tengo la respuesta ‚Üí
            </button>
          </div>
        )}

        {/* AI Calibration - Result Mode */}
        {selectedPath && showCalibration && calibrationMode === 'result' && (
          <div className="space-y-4">
            <div className="text-center">
              <p className="text-sm text-white/50 mb-2">Paso 2 de 2</p>
              <h3 className="font-bold">Pega la respuesta de la IA</h3>
            </div>

            <textarea
              value={aiResponse}
              onChange={(e) => {
                setAiResponse(e.target.value);
                setParseError(false);
                // Try to parse the response
                const match = e.target.value.match(/===CALIBRATION_RESULT===[\s\S]*?LEVEL:\s*(\d+)[\s\S]*?NAME:\s*([^\n]+)[\s\S]*?===END_CALIBRATION===/);
                if (match) {
                  const level = parseInt(match[1]);
                  if (level >= 0 && level < selectedPath.levels.length) {
                    setParsedLevel({ level, name: match[2].trim() });
                  } else {
                    setParsedLevel(null);
                  }
                } else {
                  setParsedLevel(null);
                }
              }}
              placeholder="Pega aqu√≠ la respuesta completa de la IA..."
              className="w-full bg-white/5 rounded-xl p-3 text-sm resize-none h-40"
            />

            {parsedLevel !== null && (
              <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-4 text-center">
                <p className="text-xs text-emerald-400 mb-1">‚úì Nivel detectado</p>
                <p className="text-2xl font-bold" style={{ color: selectedPath.color }}>
                  {selectedPath.levels[parsedLevel.level]?.name || parsedLevel.name}
                </p>
                <p className="text-xs text-white/50 mt-1">
                  Nivel {parsedLevel.level + 1} de {selectedPath.levels.length}
                </p>
              </div>
            )}

            {aiResponse && !parsedLevel && (
              <div className="bg-amber-500/10 border border-amber-500/30 rounded-xl p-3">
                <p className="text-xs text-amber-400">
                  ‚ö†Ô∏è No pude detectar el formato de resultado. Aseg√∫rate de que la IA incluy√≥ el bloque ===CALIBRATION_RESULT===
                </p>
              </div>
            )}

            <div className="flex gap-2">
              <button onClick={() => setCalibrationMode('prompt')}
                className="flex-1 py-3 bg-white/10 rounded-xl font-medium">
                ‚Üê Volver
              </button>
              <button onClick={() => {
                if (parsedLevel !== null) {
                  startPath(selectedPath.id, parsedLevel.level);
                }
              }} disabled={parsedLevel === null}
                className="flex-1 py-3 rounded-xl font-medium disabled:opacity-30 disabled:cursor-not-allowed"
                style={{ backgroundColor: selectedPath.color }}>
                Comenzar
              </button>
            </div>

            <div className="text-center">
              <button onClick={() => startPath(selectedPath.id, 0)} className="text-sm text-white/40 hover:text-white/60">
                o empezar desde el principio
              </button>
            </div>
          </div>
        )}
      </Modal>

      {/* Pause Confirm Modal */}
      <Modal isOpen={showPauseConfirm} onClose={() => setShowPauseConfirm(false)} title="Gestionar camino">
        <div className="space-y-3">
          <button onClick={pausePath} className="w-full p-4 bg-amber-500/20 hover:bg-amber-500/30 rounded-xl text-left transition-all">
            <p className="font-medium flex items-center gap-2"><Pause className="w-4 h-4" /> Pausar camino</p>
            <p className="text-xs text-white/50 mt-1">Tu progreso se guardar√° y podr√°s continuar despu√©s</p>
          </button>
          <button onClick={abandonPath} className="w-full p-4 bg-red-500/20 hover:bg-red-500/30 rounded-xl text-left transition-all">
            <p className="font-medium flex items-center gap-2 text-red-400"><X className="w-4 h-4" /> Abandonar camino</p>
            <p className="text-xs text-white/50 mt-1">Perder√°s el progreso en este camino (XP total se mantiene)</p>
          </button>
        </div>
      </Modal>
    </div>
  );
};

// ============================================================================
// SETTINGS SCREEN
// ============================================================================
const SettingsScreen = ({ data, setData, showToast }) => {
  const [showReset, setShowReset] = useState(false);
  const [showEditGoals, setShowEditGoals] = useState(false);
  const [showEditAreas, setShowEditAreas] = useState(false);
  const [goals, setGoals] = useState(data.user.goals);

  // All available areas
  const allAreas = [
    { id: 'nutrition', label: 'Nutrici√≥n', icon: Utensils, color: 'text-orange-400', description: 'Comidas, calor√≠as, macros' },
    { id: 'workout', label: 'Entreno', icon: Dumbbell, color: 'text-violet-400', description: 'Ejercicios, rutinas, PRs' },
    { id: 'habits', label: 'H√°bitos', icon: CheckSquare, color: 'text-emerald-400', description: 'Seguimiento diario de h√°bitos' },
    { id: 'work', label: 'Trabajo', icon: Briefcase, color: 'text-blue-400', description: 'Tareas, proyectos, GTD' },
    { id: 'personal', label: 'Personal', icon: Calendar, color: 'text-cyan-400', description: 'Recados, citas, gestiones' },
    { id: 'finances', label: 'Finanzas', icon: Wallet, color: 'text-green-400', description: 'Gastos, ingresos, presupuesto' },
    { id: 'relationships', label: 'Relaciones', icon: Users, color: 'text-pink-400', description: 'CRM personal, contactos' },
    { id: 'consciousness', label: 'Consciencia', icon: Sparkles, color: 'text-purple-400', description: 'Desarrollo personal, meditaci√≥n' },
    { id: 'body', label: 'Cuerpo', icon: Scale, color: 'text-teal-400', description: 'Peso, medidas, bienestar' }
  ];

  const activeAreas = data.user.activeAreas || allAreas.map(a => a.id);

  const toggleArea = (areaId) => {
    const newAreas = activeAreas.includes(areaId)
      ? activeAreas.filter(a => a !== areaId)
      : [...activeAreas, areaId];

    // Ensure at least one area is active
    if (newAreas.length === 0) {
      showToast('Debe haber al menos un √°rea activa');
      return;
    }

    setData(prev => ({
      ...prev,
      user: { ...prev.user, activeAreas: newAreas }
    }));
  };

  const reset = () => {
    localStorage.removeItem('lifeOS_v58');
    window.location.reload();
  };

  const saveGoals = () => {
    setData(prev => ({
      ...prev,
      user: { ...prev.user, goals }
    }));
    setShowEditGoals(false);
    showToast('Objetivos actualizados');
  };

  return (
    <div className="space-y-4 pb-24">
      <AnimatedMount>
        <h1 className="text-2xl font-bold">Configuraci√≥n</h1>
      </AnimatedMount>

      <AnimatedMount delay={50}>
        <Card>
          <div className="flex items-center gap-4">
            <div className="w-16 h-16 rounded-full bg-gradient-to-br from-violet-500 to-fuchsia-500 flex items-center justify-center text-2xl font-bold">
              {data.user.name?.[0]?.toUpperCase() || '?'}
            </div>
            <div>
              <p className="text-xl font-bold">{data.user.name}</p>
              <p className="text-sm text-white/50">Life OS v5.0</p>
            </div>
          </div>
        </Card>
      </AnimatedMount>

      {data.user.mantra && (
        <AnimatedMount delay={75}>
          <Card className="bg-violet-500/10 border-violet-500/20">
            <p className="text-sm text-white/60 mb-1">Tu mantra</p>
            <p className="italic">"{data.user.mantra}"</p>
          </Card>
        </AnimatedMount>
      )}

      {/* Areas Configuration */}
      <AnimatedMount delay={85}>
        <Card onClick={() => setShowEditAreas(true)}>
          <div className="flex items-center justify-between">
            <div>
              <p className="font-medium">√Åreas de vida</p>
              <p className="text-xs text-white/40 mt-0.5">{activeAreas.length} de {allAreas.length} activas</p>
            </div>
            <ChevronRight className="w-5 h-5 text-white/30" />
          </div>
          <div className="flex gap-2 mt-3 flex-wrap">
            {allAreas.filter(a => activeAreas.includes(a.id)).map(area => {
              const Icon = area.icon;
              return (
                <div key={area.id} className={`flex items-center gap-1 px-2 py-1 bg-white/5 rounded-lg text-xs ${area.color}`}>
                  <Icon className="w-3 h-3" />
                  {area.label}
                </div>
              );
            })}
          </div>
        </Card>
      </AnimatedMount>

      <AnimatedMount delay={100}>
        <Card onClick={() => setShowEditGoals(true)}>
          <div className="flex items-center justify-between">
            <p className="font-medium">Objetivos diarios</p>
            <ChevronRight className="w-5 h-5 text-white/30" />
          </div>
          <div className="grid grid-cols-2 gap-3 mt-3 text-sm">
            <div className="flex justify-between">
              <span className="text-white/60">Calor√≠as</span>
              <span>{data.user.goals.calories} kcal</span>
            </div>
            <div className="flex justify-between">
              <span className="text-white/60">Prote√≠na</span>
              <span>{data.user.goals.protein}g</span>
            </div>
            <div className="flex justify-between">
              <span className="text-white/60">Agua</span>
              <span>{data.user.goals.water || 8} vasos</span>
            </div>
            <div className="flex justify-between">
              <span className="text-white/60">Carbs</span>
              <span>{data.user.goals.carbs}g</span>
            </div>
          </div>
        </Card>
      </AnimatedMount>

      <AnimatedMount delay={125}>
        <Card>
          <p className="font-medium mb-3">Datos almacenados</p>
          <div className="space-y-2 text-sm">
            <div className="flex justify-between">
              <span className="text-white/60">H√°bitos</span>
              <span>{data.habits.length}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-white/60">Registros de h√°bitos</span>
              <span>{data.habitLogs?.length || 0}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-white/60">Entrenos</span>
              <span>{data.workouts.length}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-white/60">Comidas</span>
              <span>{data.meals.length}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-white/60">Tareas trabajo</span>
              <span>{data.workTasks?.length || data.tasks.length}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-white/60">Tareas personales</span>
              <span>{data.personalTasks?.length || 0}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-white/60">Relaciones</span>
              <span>{data.relationships?.length || 0}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-white/60">Interacciones</span>
              <span>{(data.relationships || []).reduce((s, r) => s + (r.interactions?.length || 0), 0)}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-white/60">Registros peso</span>
              <span>{data.bodyMetrics?.length || 0}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-white/60">PRs</span>
              <span>{data.personalRecords?.length || 0}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-white/60">Transacciones</span>
              <span>{data.finances?.transactions?.length || 0}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-white/60">Pr√°cticas consciencia</span>
              <span>{data.consciousness?.practices?.length || 0}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-white/60">D√≠as gratitud</span>
              <span>{Object.keys(data.consciousness?.gratitude || {}).length}</span>
            </div>
          </div>
        </Card>
      </AnimatedMount>

      <AnimatedMount delay={150}>
        <Card className="border-red-500/30">
          <p className="font-medium mb-3 text-red-400">Zona peligrosa</p>
          <button
            onClick={() => setShowReset(true)}
            className="w-full py-3 bg-red-500/20 text-red-400 rounded-xl flex items-center justify-center gap-2 hover:bg-red-500/30"
          >
            <RefreshCw className="w-4 h-4" />
            Resetear todos los datos
          </button>
        </Card>
      </AnimatedMount>

      <Modal isOpen={showReset} onClose={() => setShowReset(false)} title="¬øEst√°s seguro?">
        <p className="text-white/60 mb-4">Se eliminar√°n permanentemente todos tus datos. Esta acci√≥n no se puede deshacer.</p>
        <div className="flex gap-3">
          <button onClick={() => setShowReset(false)} className="flex-1 py-3 bg-white/10 rounded-xl hover:bg-white/20">
            Cancelar
          </button>
          <button onClick={reset} className="flex-1 py-3 bg-red-500 rounded-xl hover:bg-red-600">
            Eliminar todo
          </button>
        </div>
      </Modal>

      <Modal isOpen={showEditGoals} onClose={() => setShowEditGoals(false)} title="Editar objetivos">
        <div className="space-y-4">
          <div>
            <label className="text-sm text-white/60 mb-2 block">Calor√≠as diarias</label>
            <div className="flex items-center gap-4">
              <input type="range" min="1200" max="4000" step="50" value={goals.calories} onChange={(e) => setGoals(g => ({ ...g, calories: parseInt(e.target.value) }))} className="flex-1 accent-violet-500" />
              <span className="text-xl font-bold w-20 text-right">{goals.calories}</span>
            </div>
          </div>
          <div>
            <label className="text-sm text-white/60 mb-2 block">Prote√≠na (g)</label>
            <div className="flex items-center gap-4">
              <input type="range" min="50" max="300" step="5" value={goals.protein} onChange={(e) => setGoals(g => ({ ...g, protein: parseInt(e.target.value) }))} className="flex-1 accent-violet-500" />
              <span className="text-xl font-bold w-20 text-right">{goals.protein}g</span>
            </div>
          </div>
          <div>
            <label className="text-sm text-white/60 mb-2 block">Carbohidratos (g)</label>
            <div className="flex items-center gap-4">
              <input type="range" min="50" max="400" step="10" value={goals.carbs} onChange={(e) => setGoals(g => ({ ...g, carbs: parseInt(e.target.value) }))} className="flex-1 accent-violet-500" />
              <span className="text-xl font-bold w-20 text-right">{goals.carbs}g</span>
            </div>
          </div>
          <div>
            <label className="text-sm text-white/60 mb-2 block">Grasas (g)</label>
            <div className="flex items-center gap-4">
              <input type="range" min="30" max="150" step="5" value={goals.fats} onChange={(e) => setGoals(g => ({ ...g, fats: parseInt(e.target.value) }))} className="flex-1 accent-violet-500" />
              <span className="text-xl font-bold w-20 text-right">{goals.fats}g</span>
            </div>
          </div>
          <div>
            <label className="text-sm text-white/60 mb-2 block">Vasos de agua</label>
            <div className="flex items-center gap-4">
              <input type="range" min="4" max="12" step="1" value={goals.water || 8} onChange={(e) => setGoals(g => ({ ...g, water: parseInt(e.target.value) }))} className="flex-1 accent-blue-500" />
              <span className="text-xl font-bold w-20 text-right">{goals.water || 8} üíß</span>
            </div>
          </div>
          <div>
            <label className="text-sm text-white/60 mb-2 block flex items-center gap-2">
              Pasos diarios <Watch className="w-3 h-3 text-white/40" /> <Smartphone className="w-3 h-3 text-white/40" />
            </label>
            <div className="flex items-center gap-4">
              <input type="range" min="5000" max="20000" step="1000" value={goals.steps || 10000} onChange={(e) => setGoals(g => ({ ...g, steps: parseInt(e.target.value) }))} className="flex-1 accent-green-500" />
              <span className="text-xl font-bold w-24 text-right">{((goals.steps || 10000) / 1000).toFixed(0)}k üëü</span>
            </div>
            <p className="text-xs text-white/30 mt-1 flex items-center gap-1">
              <Watch className="w-3 h-3" /> Se sincronizar√° autom√°ticamente con Apple Watch / Google Fit
            </p>
          </div>
        </div>
        <button onClick={saveGoals} className="w-full bg-violet-500 py-4 rounded-xl font-medium mt-4">
          Guardar cambios
        </button>
      </Modal>

      {/* Edit Areas Modal */}
      <Modal isOpen={showEditAreas} onClose={() => setShowEditAreas(false)} title="√Åreas de vida">
        <p className="text-sm text-white/50 mb-4">Activa las √°reas que quieres trabajar. Las √°reas desactivadas se ocultar√°n de toda la app.</p>
        <div className="space-y-2">
          {allAreas.map(area => {
            const Icon = area.icon;
            const isActive = activeAreas.includes(area.id);
            return (
              <button
                key={area.id}
                onClick={() => toggleArea(area.id)}
                className={`w-full flex items-center gap-3 p-3 rounded-xl transition-all ${isActive ? 'bg-white/10 border border-white/20' : 'bg-white/5 opacity-50'
                  }`}
              >
                <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${isActive ? 'bg-white/10' : 'bg-white/5'}`}>
                  <Icon className={`w-5 h-5 ${area.color}`} />
                </div>
                <div className="flex-1 text-left">
                  <p className="font-medium">{area.label}</p>
                  <p className="text-xs text-white/40">{area.description}</p>
                </div>
                <div className={`w-6 h-6 rounded-full flex items-center justify-center ${isActive ? 'bg-emerald-500' : 'bg-white/10'}`}>
                  {isActive && <Check className="w-4 h-4" />}
                </div>
              </button>
            );
          })}
        </div>
      </Modal>
    </div>
  );
};

// ============================================================================
// MAIN APP
// ============================================================================// Main App Component
export default function LifeOSApp() {
  const [data, setData] = useLocalStorage('lifeOS_v58', EMPTY_DATA);
  const [screen, setScreen] = useState('today');
  const [toast, setToast] = useState(null);

  // Listen for goToSettings event from global header
  useEffect(() => {
    const handleGoToSettings = () => setScreen('settings');
    window.addEventListener('goToSettings', handleGoToSettings);
    return () => window.removeEventListener('goToSettings', handleGoToSettings);
  }, []);

  // Listen for toggleDemoData event from profile menu
  useEffect(() => {
    const handleToggleDemoData = () => {
      const isDemoEnabled = data.user?.demoDataEnabled;
      if (isDemoEnabled) {
        // Deactivate demo - clear all data except user settings
        setData(prev => ({
          ...EMPTY_DATA,
          user: {
            ...prev.user,
            demoDataEnabled: false
          }
        }));
        setToast({ message: 'Datos demo desactivados', type: 'success' });
      } else {
        // Activate demo - load demo data
        const demoData = generateDemoData();
        setData(prev => ({
          ...demoData,
          user: {
            ...demoData.user,
            name: prev.user?.name || 'Demo',
            mantra: prev.user?.mantra || demoData.user.mantra,
            goals: prev.user?.goals || demoData.user.goals,
            demoDataEnabled: true
          }
        }));
        setToast({ message: 'Datos demo activados - ahora puedes ver todo en acci√≥n', type: 'success' });
      }
    };
    window.addEventListener('toggleDemoData', handleToggleDemoData);
    return () => window.removeEventListener('toggleDemoData', handleToggleDemoData);
  }, [data, setData]);

  // Migration: Add new features to activeAreas if not present
  useEffect(() => {
    // Add 'consciousness' to activeAreas if not present
    if (data.user?.activeAreas && !data.user.activeAreas.includes('consciousness')) {
      setData(prev => ({
        ...prev,
        user: {
          ...prev.user,
          activeAreas: [...prev.user.activeAreas, 'consciousness']
        }
      }));
    }

    // Add 'personal' to activeAreas if not present
    if (data.user?.activeAreas && !data.user.activeAreas.includes('personal')) {
      setData(prev => ({
        ...prev,
        user: {
          ...prev.user,
          activeAreas: [...prev.user.activeAreas, 'personal']
        },
        personalTasks: prev.personalTasks || []
      }));
    }

    // Add 'relationships' to activeAreas if not present
    if (data.user?.activeAreas && !data.user.activeAreas.includes('relationships')) {
      setData(prev => ({
        ...prev,
        user: {
          ...prev.user,
          activeAreas: [...prev.user.activeAreas, 'relationships']
        }
      }));
    }

    // Initialize empty arrays if not present (no demo data)
    if (!data.relationships) {
      setData(prev => ({ ...prev, relationships: [] }));
    }

    if (!data.personalCategories) {
      setData(prev => ({
        ...prev,
        personalCategories: [
          { id: 'home', name: 'Hogar', icon: 'üè†', color: '#10B981' },
          { id: 'admin', name: 'Admin', icon: 'üìã', color: '#6366F1' },
          { id: 'health', name: 'Salud', icon: '‚ù§Ô∏è', color: '#EF4444' },
          { id: 'social', name: 'Social', icon: 'üë•', color: '#F59E0B' },
          { id: 'travel', name: 'Viajes', icon: '‚úàÔ∏è', color: '#3B82F6' },
          { id: 'learning', name: 'Aprendizaje', icon: 'üìö', color: '#8B5CF6' },
          { id: 'projects', name: 'Proyectos', icon: 'üöÄ', color: '#EC4899' }
        ]
      }));
    }

    // Add subtasks to existing personalTasks if not present
    if (data.personalTasks && data.personalTasks.some(t => !t.subtasks)) {
      setData(prev => ({
        ...prev,
        personalTasks: prev.personalTasks.map(t => ({
          ...t,
          subtasks: t.subtasks || []
        }))
      }));
    }
  }, []);

  const showToast = (message, type = 'success') => {
    setToast({ message, type });
  };

  if (!data.user.onboardingComplete) {
    return <OnboardingWizard data={data} setData={setData} onComplete={() => setScreen('today')} />;
  }

  const screens = {
    today: <TodayScreen data={data} setData={setData} setScreen={setScreen} showToast={showToast} />,
    meals: <MealsScreen data={data} setData={setData} showToast={showToast} />,
    workout: <WorkoutScreen data={data} setData={setData} showToast={showToast} />,
    habits: <HabitsScreen data={data} setData={setData} showToast={showToast} />,
    work: <WorkScreen data={data} setData={setData} showToast={showToast} />,
    personal: <PersonalScreen data={data} setData={setData} showToast={showToast} />,
    body: <BodyScreen data={data} setData={setData} showToast={showToast} />,
    control: <ControlScreen data={data} setData={setData} showToast={showToast} />,
    finances: <FinancesScreen data={data} setData={setData} showToast={showToast} />,
    calendar: <CalendarScreen data={data} setData={setData} setScreen={setScreen} showToast={showToast} />,
    weekly: <WeeklyScreen data={data} />,
    stats: <StatsScreen data={data} setScreen={setScreen} />,
    settings: <SettingsScreen data={data} setData={setData} showToast={showToast} />,
    consciousness: <ConsciousnessScreen data={data} setData={setData} showToast={showToast} />,
    relationships: <RelationshipsScreen data={data} setData={setData} showToast={showToast} />,
  };

  // Calculate badge for habits
  const today = getToday();
  const todayHabitLogs = data.habitLogs?.filter(l => l.date === today) || [];
  const habitsRemaining = data.habits.length - todayHabitLogs.filter(l => l.completed).length;

  // Calculate badge for personal tasks
  const personalTasksDue = (data.personalTasks || []).filter(t => !t.completed && t.dueDate && t.dueDate <= today).length;

  // Hub menu state
  const [hubOpen, setHubOpen] = useState(false);

  // Active areas from user settings
  const activeAreas = data.user.activeAreas || ['nutrition', 'workout', 'habits', 'work', 'personal', 'body', 'finances', 'consciousness', 'relationships'];

  // Map screen ids to area ids
  const screenToArea = {
    'meals': 'nutrition',
    'workout': 'workout',
    'habits': 'habits',
    'work': 'work',
    'personal': 'personal',
    'body': 'body',
    'finances': 'finances',
    'consciousness': 'consciousness'
  };

  // Hub menu items - filtered by active areas
  const allHubItems = [
    { id: 'consciousness', areaId: 'consciousness', icon: Sparkles, label: 'Conciencia', color: 'text-violet-400', bg: 'bg-violet-900' },
    { id: 'relationships', areaId: 'relationships', icon: Heart, label: 'Relaciones', color: 'text-pink-400', bg: 'bg-pink-900' },
    { id: 'finances', areaId: 'finances', icon: Wallet, label: 'Finanzas', color: 'text-green-400', bg: 'bg-green-900' },
    { id: 'personal', areaId: 'personal', icon: Calendar, label: 'Personal', color: 'text-cyan-400', bg: 'bg-cyan-900', badge: personalTasksDue > 0 ? personalTasksDue : null },
    { id: 'workout', areaId: 'workout', icon: Dumbbell, label: 'Entreno', color: 'text-violet-400', bg: 'bg-violet-900' },
    { id: 'work', areaId: 'work', icon: Briefcase, label: 'Trabajo', color: 'text-blue-400', bg: 'bg-blue-900' },
    { id: 'habits', areaId: 'habits', icon: CheckSquare, label: 'H√°bitos', color: 'text-emerald-400', bg: 'bg-emerald-900', badge: habitsRemaining > 0 ? habitsRemaining : null },
    { id: 'meals', areaId: 'nutrition', icon: Utensils, label: 'Comidas', color: 'text-orange-400', bg: 'bg-orange-900' },
  ];

  const hubItems = allHubItems.filter(item => activeAreas.includes(item.areaId));

  const handleHubSelect = (id) => {
    setScreen(id);
    setHubOpen(false);
  };

  // Check if current screen is a hub screen
  const hubScreenIds = [...hubItems.map(h => h.id), 'settings'];
  const isHubScreen = hubScreenIds.includes(screen);

  return (
    <div className="min-h-screen bg-zinc-950 text-white">
      {/* Background gradient */}
      <div className="fixed inset-0 bg-gradient-to-br from-violet-950/50 via-zinc-950 to-fuchsia-950/30 pointer-events-none" />

      {/* Settings button - moved to global header, keeping this hidden */}

      {/* Toast */}
      {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}

      {/* Main content */}
      <div className="relative max-w-md mx-auto px-4 pt-6">
        {screens[screen]}
      </div>

      {/* Hub overlay */}
      {hubOpen && (
        <div
          className="fixed inset-0 backdrop-blur-sm z-40"
          onClick={() => setHubOpen(false)}
        />
      )}

      {/* Hub menu - Grid layout for 7 items */}
      {hubOpen && (
        <div
          className="fixed bottom-24 left-1/2 z-50 bg-zinc-900/95 backdrop-blur-xl rounded-3xl border border-white/10 p-4 shadow-2xl"
          style={{
            transform: 'translateX(-50%)',
            animation: 'hub-menu-appear 0.2s ease-out'
          }}
        >
          {/* Top row - 4 items */}
          <div className="flex gap-3 mb-3">
            {hubItems.slice(0, 4).map((item, i) => (
              <button
                key={item.id}
                onClick={() => handleHubSelect(item.id)}
                className="flex flex-col items-center gap-1.5 p-2 rounded-2xl hover:bg-white/10 transition-all group"
                style={{ animation: `hub-item-appear 0.2s ease-out ${i * 0.03}s both` }}
              >
                <div className={`w-14 h-14 rounded-2xl ${item.bg} border border-white/20 flex items-center justify-center group-hover:scale-105 group-hover:border-white/40 transition-all relative shadow-lg`}>
                  {item.badge && (
                    <span className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full text-[10px] flex items-center justify-center font-bold shadow">
                      {item.badge}
                    </span>
                  )}
                  <item.icon className={`w-6 h-6 ${item.color}`} />
                </div>
                <span className="text-[11px] text-white/70 font-medium">{item.label}</span>
              </button>
            ))}
          </div>

          {/* Bottom row - remaining items centered */}
          <div className="flex justify-center gap-3">
            {hubItems.slice(4).map((item, i) => (
              <button
                key={item.id}
                onClick={() => handleHubSelect(item.id)}
                className="flex flex-col items-center gap-1.5 p-2 rounded-2xl hover:bg-white/10 transition-all group"
                style={{ animation: `hub-item-appear 0.2s ease-out ${(i + 4) * 0.03}s both` }}
              >
                <div className={`w-14 h-14 rounded-2xl ${item.bg} border border-white/20 flex items-center justify-center group-hover:scale-105 group-hover:border-white/40 transition-all relative shadow-lg`}>
                  {item.badge && (
                    <span className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full text-[10px] flex items-center justify-center font-bold shadow">
                      {item.badge}
                    </span>
                  )}
                  <item.icon className={`w-6 h-6 ${item.color}`} />
                </div>
                <span className="text-[11px] text-white/70 font-medium">{item.label}</span>
              </button>
            ))}
          </div>
        </div>
      )}

      {/* Bottom navigation */}
      <div className="fixed bottom-0 left-0 right-0 bg-zinc-900/95 backdrop-blur-xl border-t border-white/10 z-50">
        <div className="max-w-md mx-auto flex justify-around py-2 px-4">
          <NavItem icon={Sun} label="Hoy" active={screen === 'today' || screen === 'weekly'} onClick={() => { setHubOpen(false); setScreen('today'); }} />
          <NavItem icon={Calendar} label="Calendario" active={screen === 'calendar'} onClick={() => { setHubOpen(false); setScreen('calendar'); }} />

          {/* Center √Åreas Button */}
          <button
            onClick={() => setHubOpen(!hubOpen)}
            className="flex flex-col items-center gap-0.5 px-3 py-1 relative"
          >
            <div
              className={`w-14 h-14 -mt-7 rounded-full flex items-center justify-center transition-all duration-300 shadow-xl ${hubOpen
                ? 'bg-gradient-to-br from-violet-500 to-fuchsia-600 rotate-45 scale-110'
                : isHubScreen
                  ? 'bg-gradient-to-br from-violet-500 to-fuchsia-600'
                  : 'bg-gradient-to-br from-zinc-800 to-zinc-700 border border-white/20'
                }`}
              style={{
                boxShadow: hubOpen
                  ? '0 0 30px rgba(139, 92, 246, 0.5), 0 0 60px rgba(139, 92, 246, 0.3)'
                  : '0 4px 15px rgba(0,0,0,0.3)'
              }}
            >
              <LayoutGrid className={`w-6 h-6 text-white transition-transform duration-300 ${hubOpen ? 'rotate-90' : ''}`} />
            </div>
            <span className={`text-xs mt-0.5 transition-colors ${hubOpen || isHubScreen ? 'text-violet-400' : 'text-white/50'}`}>
              √Åreas
            </span>
          </button>

          <NavItem icon={Activity} label="Control" active={screen === 'control'} onClick={() => { setHubOpen(false); setScreen('control'); }} />
          <NavItem icon={BarChart3} label="Stats" active={screen === 'stats'} onClick={() => { setHubOpen(false); setScreen('stats'); }} />
        </div>
      </div>

      {/* Animations */}
      <style>{`
        @keyframes slide-up {
          from { transform: translateY(100%); opacity: 0; }
          to { transform: translateY(0); opacity: 1; }
        }
        @keyframes slide-down {
          from { transform: translateY(-20px) translateX(-50%); opacity: 0; }
          to { transform: translateY(0) translateX(-50%); opacity: 1; }
        }
        @keyframes hub-menu-appear {
          from { 
            opacity: 0; 
            transform: translateX(-50%) translateY(20px) scale(0.9);
          }
          to { 
            opacity: 1; 
            transform: translateX(-50%) translateY(0) scale(1);
          }
        }
        @keyframes hub-item-appear {
          from { 
            opacity: 0; 
            transform: scale(0.8);
          }
          to { 
            opacity: 1; 
            transform: scale(1);
          }
        }
        .animate-slide-up { animation: slide-up 0.3s ease-out; }
        .animate-slide-down { animation: slide-down 0.3s ease-out; }
        
        /* Custom date input styling */
        input[type="date"] {
          color-scheme: dark;
          background: rgba(255,255,255,0.05);
          border: 1px solid rgba(255,255,255,0.1);
          border-radius: 0.5rem;
          padding: 0.5rem 0.75rem;
          color: white;
          font-size: 0.875rem;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
          filter: invert(1) opacity(0.5);
          cursor: pointer;
        }
        input[type="date"]::-webkit-calendar-picker-indicator:hover {
          filter: invert(1) opacity(0.8);
        }
        input[type="date"]:focus {
          outline: none;
          border-color: rgba(139, 92, 246, 0.5);
          box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
        }
        
        /* Custom select styling */
        select {
          color-scheme: dark;
          background: rgba(255,255,255,0.05);
          border: 1px solid rgba(255,255,255,0.1);
          border-radius: 0.5rem;
          padding: 0.5rem 0.75rem;
          color: white;
          font-size: 0.875rem;
          cursor: pointer;
          appearance: none;
          background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='rgba(255,255,255,0.4)'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
          background-repeat: no-repeat;
          background-position: right 0.5rem center;
          background-size: 1rem;
          padding-right: 2rem;
        }
        select:focus {
          outline: none;
          border-color: rgba(139, 92, 246, 0.5);
          box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
        }
        select option {
          background: #1a1a2e;
          color: white;
          padding: 0.5rem;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
          width: 4px;
          height: 4px;
        }
        ::-webkit-scrollbar-track {
          background: transparent;
        }
        ::-webkit-scrollbar-thumb {
          background: rgba(255,255,255,0.2);
          border-radius: 2px;
        }
        ::-webkit-scrollbar-thumb:hover {
          background: rgba(255,255,255,0.3);
        }
      `}</style>
    </div>
  );
}
